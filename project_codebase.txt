PROJECT EXPORT - 2025-12-17T17:20:48.806Z


================================================================================
FILE: package.json
================================================================================
{
  "name": "mrt2",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@heroicons/react": "^2.2.0",
    "date-fns": "^4.1.0",
    "firebase": "^12.6.0",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "clsx": "^2.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "3.4",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0"
  }
}


================================================================================
FILE: vite.config.ts
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

icons: [
          {
            // Note: The generator usually names them like this
            src: 'pwa-192x192.png', 
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable' // 'maskable' ensures it fills the circle on Android
          }
        ]

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


================================================================================
FILE: check_models.js
================================================================================
import fs from 'fs';
import path from 'path';

async function check() {
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    if (!fs.existsSync(envPath)) {
      console.error("‚ùå Error: Could not find .env file.");
      process.exit(1);
    }

    const envContent = fs.readFileSync(envPath, 'utf8');
    const match = envContent.match(/VITE_GEMINI_API_KEY=(.*)/);
    
    if (!match || !match[1]) {
      console.error("‚ùå Error: VITE_GEMINI_API_KEY not found in .env");
      process.exit(1);
    }

    // SANITIZATION: Remove spaces AND quotes (" or ') from the key
    const rawKey = match[1].trim();
    const apiKey = rawKey.replace(/^["']|["']$/g, ''); 

    console.log(`üîë Testing Key: ${apiKey.substring(0, 6)}... (Length: ${apiKey.length})`);

    // Query Google
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API Error ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    const contentModels = data.models.filter(m => 
      m.supportedGenerationMethods.includes("generateContent")
    );

    console.log("\n‚úÖ SUCCESS! HERE ARE YOUR AVAILABLE MODELS:");
    console.table(contentModels.map(m => ({
      name: m.name.replace('models/', ''), // Use THIS string in your code
      version: m.version,
      displayName: m.displayName
    })));

  } catch (error) {
    console.error("‚ùå Failed:", error.message);
  }
}

check();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}

================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Recovery Toolkit</title>
    <meta name="description" content="Your digital companion for recovery.">
    <meta name="theme-color" content="#2A9D8F">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: postcss.config.js
================================================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: src/App.css
================================================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE: src/App.tsx
================================================================================
import React from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import AppShell from './components/AppShell'; 
import Dashboard from './pages/Dashboard';
import Journal from './pages/Journal';
import Profile from './pages/Profile';
import Login from './pages/Login'; 

// --- PROTECTED ROUTE WRAPPER ---
// If the user is not logged in, redirect them to /login
function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    );
  }
  
  return user ? <>{children}</> : <Navigate to="/login" />;
}

// --- MAIN APPLICATION ---
export default function App() {
  return (
    <AuthProvider>
      <Router>
        <Routes>
          {/* Public Route: Login Page */}
          <Route path="/login" element={<Login />} />

          {/* Protected Routes: Wrapped in AppShell (Navigation) */}
          <Route path="/" element={<AppShell />}>
            
            {/* Redirect root '/' to Dashboard */}
            <Route index element={<Navigate to="/dashboard" replace />} />
            
            <Route path="dashboard" element={
              <PrivateRoute>
                <Dashboard />
              </PrivateRoute>
            } />
            
            <Route path="journal" element={
              <PrivateRoute>
                <Journal />
              </PrivateRoute>
            } />
            
            <Route path="profile" element={
              <PrivateRoute>
                <Profile />
              </PrivateRoute>
            } />
          </Route>
          
          {/* Catch-all: Redirect unknown URLs to dashboard */}
          <Route path="*" element={<Navigate to="/dashboard" />} />
        </Routes>
      </Router>
    </AuthProvider>
  );
}

================================================================================
FILE: src/components/AppShell.tsx
================================================================================
import { useState } from 'react';
import { Outlet, Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { 
  HomeIcon, 
  BookOpenIcon, 
  UserCircleIcon, 
  ArrowRightOnRectangleIcon,
  Bars3Icon,
  XMarkIcon 
} from '@heroicons/react/24/outline';

export default function AppShell() {
  const { user, logout } = useAuth();
  const location = useLocation();
  const navigate = useNavigate();
  
  // State for Mobile Menu
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error("Failed to log out", error);
    }
  };

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { name: 'Journal', href: '/journal', icon: BookOpenIcon },
    { name: 'Profile', href: '/profile', icon: UserCircleIcon },
  ];

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      
      {/* --- TOP NAVIGATION BAR (Unified Blue) --- */}
      <nav className="bg-blue-600 shadow-lg sticky top-0 z-50">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div className="flex h-16 justify-between items-center">
            
            {/* LEFT: Logo & Desktop Nav */}
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <span className="text-xl font-bold text-white tracking-wide">
                  My Recovery Toolkit
                </span>
              </div>
              
              {/* Desktop Links */}
              <div className="hidden sm:ml-8 sm:flex sm:space-x-4">
                {navigation.map((item) => {
                  const isActive = location.pathname.startsWith(item.href);
                  return (
                    <Link
                      key={item.name}
                      to={item.href}
                      className={`inline-flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                        isActive
                          ? 'bg-blue-700 text-white shadow-sm'
                          : 'text-blue-100 hover:bg-blue-500 hover:text-white'
                      }`}
                    >
                      <item.icon className={`mr-2 h-4 w-4 ${isActive ? 'text-white' : 'text-blue-200'}`} />
                      {item.name}
                    </Link>
                  );
                })}
              </div>
            </div>

            {/* RIGHT: User & Logout (Desktop) */}
            <div className="hidden sm:flex sm:items-center gap-4">
              <span className="text-sm text-blue-100 font-medium">
                {user?.email}
              </span>
              <button
                onClick={handleLogout}
                className="rounded-full bg-blue-700 p-2 text-blue-100 hover:bg-blue-800 hover:text-white transition focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-blue-600"
                title="Sign Out"
              >
                <ArrowRightOnRectangleIcon className="h-5 w-5" />
              </button>
            </div>

            {/* MOBILE: Hamburger Button */}
            <div className="flex items-center sm:hidden">
              <button
                onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                className="inline-flex items-center justify-center rounded-md p-2 text-blue-100 hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
              >
                <span className="sr-only">Open main menu</span>
                {isMobileMenuOpen ? (
                  <XMarkIcon className="block h-6 w-6" aria-hidden="true" />
                ) : (
                  <Bars3Icon className="block h-6 w-6" aria-hidden="true" />
                )}
              </button>
            </div>
          </div>
        </div>

        {/* --- MOBILE MENU (Blue Theme) --- */}
        {isMobileMenuOpen && (
          <div className="sm:hidden bg-blue-600 border-t border-blue-500 shadow-xl">
            <div className="space-y-1 px-2 pb-3 pt-2">
              {navigation.map((item) => {
                 const isActive = location.pathname.startsWith(item.href);
                 return (
                  <Link
                    key={item.name}
                    to={item.href}
                    onClick={() => setIsMobileMenuOpen(false)}
                    className={`block rounded-md px-3 py-2 text-base font-medium ${
                      isActive
                        ? 'bg-blue-800 text-white'
                        : 'text-blue-100 hover:bg-blue-500 hover:text-white'
                    }`}
                  >
                    <div className="flex items-center">
                      <item.icon className="mr-3 h-5 w-5" />
                      {item.name}
                    </div>
                  </Link>
                );
              })}
            </div>
            
            {/* Mobile User Section */}
            <div className="border-t border-blue-500 pb-4 pt-4">
              <div className="flex items-center px-5">
                <div className="flex-shrink-0">
                  <UserCircleIcon className="h-10 w-10 text-blue-200" />
                </div>
                <div className="ml-3">
                  <div className="text-base font-medium text-white">{user?.displayName || 'User'}</div>
                  <div className="text-sm font-medium text-blue-200">{user?.email}</div>
                </div>
              </div>
              <div className="mt-3 space-y-1 px-2">
                <button
                  onClick={handleLogout}
                  className="block w-full text-left rounded-md px-3 py-2 text-base font-medium text-blue-100 hover:bg-blue-500 hover:text-white"
                >
                  Sign out
                </button>
              </div>
            </div>
          </div>
        )}
      </nav>

      {/* --- MAIN CONTENT AREA --- */}
      <main className="flex-1 py-8">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <Outlet />
        </div>
      </main>
    </div>
  );
}

================================================================================
FILE: src/components/SobrietyCounter.tsx
================================================================================
import { useMemo } from 'react';
import { TrophyIcon } from '@heroicons/react/24/solid';

interface SobrietyCounterProps {
  sobrietyDate: Date;
}

// ensure 'export default' is present here
export default function SobrietyCounter({ sobrietyDate }: SobrietyCounterProps) {
  const time = useMemo(() => {
    const now = new Date();
    const start = new Date(sobrietyDate);
    
    // Calculate the difference
    const diffTime = Math.abs(now.getTime() - start.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = (totalDays % 365) % 30;

    return { years, months, days, totalDays };
  }, [sobrietyDate]);

  return (
    <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-xl p-6 text-white relative overflow-hidden">
      {/* Background Decoration */}
      <TrophyIcon className="absolute -right-4 -bottom-4 h-48 w-48 text-blue-500 opacity-20 transform rotate-12" />

      <div className="relative z-10">
        <h2 className="text-blue-100 text-sm font-semibold uppercase tracking-wider mb-4">
          Clean & Sober Time
        </h2>
        
        <div className="flex items-end space-x-6">
          {/* Years */}
          {time.years > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.years}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Years</span>
            </div>
          )}

          {/* Months */}
          {time.months > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.months}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Months</span>
            </div>
          )}

          {/* Days */}
          <div className="text-center">
            <span className="block text-4xl sm:text-5xl font-bold">{time.days}</span>
            <span className="text-xs sm:text-sm text-blue-200 uppercase">Days</span>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-blue-500/50 flex justify-between items-center text-sm text-blue-200">
          <span>Total Days: {time.totalDays}</span>
          <span>Started: {sobrietyDate.toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/contexts/AuthContext.tsx
================================================================================
import React, { createContext, useContext, useEffect, useState } from 'react';
import { 
  type User, 
  GoogleAuthProvider, 
  signInWithPopup, 
  signOut, 
  onAuthStateChanged 
} from 'firebase/auth';
import { auth } from '../lib/firebase';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  signInWithGoogle: () => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // FIX 1: Safety check. If auth is missing, stop loading and do nothing.
    if (!auth) {
      console.error("Firebase Auth not initialized");
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  const signInWithGoogle = async () => {
    // FIX 2: Safety check before login
    if (!auth) {
        throw new Error("Authentication service is not available");
    }

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    try {
      await signInWithPopup(auth, provider);
    } catch (error) {
      throw error;
    }
  };

  const logout = async () => {
    // FIX 3: Safety check before logout
    if (!auth) return;
    
    try {
      await signOut(auth);
    } catch (error) {
      console.error("Logout failed:", error);
      throw error;
    }
  };

  const value = {
    user,
    loading,
    signInWithGoogle,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

================================================================================
FILE: src/index.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    /* The "Unified Blue" Theme from your Master Doc */
    @apply bg-blue-50 text-slate-800 antialiased;
  }
  
  /* Reset headings to be bold and dark blue by default */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold text-blue-900;
  }
}

================================================================================
FILE: src/lib/db.ts
================================================================================
import { doc, getDoc, setDoc, updateDoc, Timestamp } from "firebase/firestore";
import { db } from "./firebase";
import { type User } from "firebase/auth";

export interface UserProfile {
  uid: string;
  email: string | null;
  displayName: string | null;
  sobrietyDate: Timestamp | null;
  createdAt: Timestamp;
}

// 1. Create or Get User Profile
export async function getOrCreateUserProfile(user: User): Promise<UserProfile> {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  } else {
    // Initialize new profile
    const newProfile: UserProfile = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      sobrietyDate: null, // Not set yet
      createdAt: Timestamp.now(),
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  }
}

// 2. Update Sobriety Date
export async function updateSobrietyDate(uid: string, date: Date) {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  await updateDoc(userRef, {
    sobrietyDate: Timestamp.fromDate(date)
  });
}

================================================================================
FILE: src/lib/firebase.ts
================================================================================
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

// 1. Construct config directly from individual environment variables
// These will be injected by Vite during the build
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
};

// 2. Initialize (Safe Check)
// We check if apiKey exists to ensure we aren't crashing on empty config
const app = firebaseConfig.apiKey ? initializeApp(firebaseConfig) : undefined;

if (!app) {
  console.error("Firebase failed to initialize. Missing API Key.");
}

export const auth = app ? getAuth(app) : undefined;
export const db = app ? getFirestore(app) : undefined;
export const googleProvider = new GoogleAuthProvider();

export default app;

================================================================================
FILE: src/lib/gemini.ts
================================================================================
import { GoogleGenerativeAI } from "@google/generative-ai";

// Initialize the API
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

if (!API_KEY) {
  console.error("Missing VITE_GEMINI_API_KEY in .env file");
}

const genAI = new GoogleGenerativeAI(API_KEY);

// UPDATED: Using the model explicitly found in your list
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

export interface AnalysisResult {
  analysis: string;
  sentiment: 'positive' | 'neutral' | 'negative' | 'mixed';
  actionableSteps: string[];
}

/**
 * Analyzes a list of journal text entries to find patterns and insights.
 */
export async function analyzeJournalEntries(entries: string[]): Promise<AnalysisResult> {
  if (entries.length === 0) {
    throw new Error("No entries to analyze");
  }

  // 1. Prepare the Data
  const combinedText = entries.join("\n---\n");

  // 2. Engineer the Prompt
  const prompt = `
    You are an empathetic, wise, and insightful recovery coach for someone in a 12-step program.
    Your task is to analyze the following journal entries from the user and provide a summary of their emotional state and potential blind spots.

    USER ENTRIES:
    ${combinedText}

    INSTRUCTIONS:
    1. Identify the core emotional themes (e.g., "Anxiety about work," "Gratitude for family").
    2. Look for "cognitive distortions" or patterns that might lead to relapse.
    3. Suggest 3 small, concrete, positive actions they can take.

    FORMAT:
    Return ONLY a raw JSON object (no markdown formatting, no backticks) with this structure:
    {
      "analysis": "A 2-3 sentence empathetic summary of their recent headspace.",
      "sentiment": "positive" | "neutral" | "negative" | "mixed",
      "actionableSteps": ["Step 1", "Step 2", "Step 3"]
    }
  `;

  try {
    console.log("Sending request to Gemini (Model: gemini-2.5-flash)...");
    
    // 3. Call the API
    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();

    // 4. Clean and Parse JSON
    const cleanJson = text.replace(/```json|```/g, '').trim();
    return JSON.parse(cleanJson) as AnalysisResult;

  } catch (error) {
    console.error("Gemini Analysis Failed:", error);
    throw new Error("Failed to generate insights. Please try again later.");
  }
}

================================================================================
FILE: src/lib/insights.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import type { AnalysisResult } from "./gemini";

const COLLECTION = 'insights';

/**
 * Saves a new AI Insight to Firestore.
 * @param uid - The User ID (e.g., "user_123")
 * @param result - The structured result from Gemini (analysis, sentiment, actions)
 */
export async function saveInsight(uid: string, result: AnalysisResult) {
  if (!db) throw new Error("Database not initialized");

  await addDoc(collection(db, COLLECTION), {
    uid,
    analysis: result.analysis,
    sentiment: result.sentiment,
    actionableSteps: result.actionableSteps,
    createdAt: Timestamp.now()
  });
}

/**
 * Fetches the history of AI Insights for a user, sorted by newest first.
 * Used by the Dashboard to show the "Latest Insight".
 */
export async function getInsightHistory(uid: string) {
  if (!db) throw new Error("Database not initialized");

  try {
    const q = query(
      collection(db, COLLECTION),
      where("uid", "==", uid),
      orderBy("createdAt", "desc")
    );

    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      // Safely convert Firestore Timestamp to JS Date
      createdAt: doc.data().createdAt?.toDate() || new Date() 
    }));

  } catch (e: any) {
    console.error("Error fetching insights:", e);
    // If we hit a Missing Index error (common with new collections),
    // warn the user to check the console.
    if (e.message && e.message.includes("index")) {
        console.warn("‚ö†Ô∏è MISSING INDEX: Open your browser console and click the Firebase link to create the index for 'insights'.");
    }
    return [];
  }
}

================================================================================
FILE: src/lib/journal.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp,
  deleteDoc,
  doc,
  updateDoc // <--- Added this
} from "firebase/firestore";
import { db } from "./firebase";
import type { WeatherData } from "./weather";

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  tags: string[];
  moodScore: number;
  weather?: WeatherData | null;
  createdAt: Date;
}

const COLLECTION = 'journals';

// 1. CREATE
export async function addJournalEntry(
  uid: string, 
  content: string, 
  moodScore: number, 
  tags: string[],
  weather: WeatherData | null
) {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, COLLECTION), {
    uid,
    content,
    tags,
    moodScore,
    weather: weather || null, 
    createdAt: Timestamp.now()
  });
}

// 2. READ
export async function getUserJournals(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt.toDate()
  })) as JournalEntry[];
}

// 3. UPDATE (New)
export async function updateJournalEntry(
  id: string,
  content: string, 
  moodScore: number, 
  tags: string[]
) {
  if (!db) throw new Error("Database not initialized");
  const docRef = doc(db, COLLECTION, id);
  await updateDoc(docRef, {
    content,
    moodScore,
    tags,
    // We do NOT update createdAt or weather, as those are historical facts
  });
}

// 4. DELETE
export async function deleteJournalEntry(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

================================================================================
FILE: src/lib/weather.ts
================================================================================
// Maps WMO Weather Codes to human readable text
function getWeatherCondition(code: number): string {
  if (code === 0) return 'Clear sky';
  if (code >= 1 && code <= 3) return 'Partly cloudy';
  if (code >= 45 && code <= 48) return 'Foggy';
  if (code >= 51 && code <= 55) return 'Drizzle';
  if (code >= 61 && code <= 65) return 'Rain';
  if (code >= 71 && code <= 77) return 'Snow';
  if (code >= 95 && code <= 99) return 'Thunderstorm';
  return 'Unknown';
}

export interface WeatherData {
  temp: number;
  condition: string;
  location: string; // We'll just store "Lat/Lon" or a generic name for now
}

export async function getCurrentWeather(): Promise<WeatherData | null> {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported");
    return null;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          
          // Using Open-Meteo (Free, No Key Required)
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius`
          );
          
          if (!response.ok) throw new Error("Weather API failed");
          
          const data = await response.json();
          const weather = data.current_weather;

          resolve({
            temp: weather.temperature,
            condition: getWeatherCondition(weather.weathercode),
            location: 'Local' // We could use a reverse geocoding API here later if needed
          });
        } catch (error) {
          console.error("Error fetching weather:", error);
          resolve(null);
        }
      },
      (error) => {
        console.warn("Location permission denied or failed", error);
        resolve(null);
      }
    );
  });
}

================================================================================
FILE: src/main.tsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css' // <--- THIS IS THE CRITICAL MISSING LINE

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

================================================================================
FILE: src/pages/Dashboard.tsx
================================================================================
import { useEffect, useState } from 'react'; // Removed unused 'React'
import { useAuth } from '../contexts/AuthContext';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../lib/firebase';
import { getUserJournals, type JournalEntry } from '../lib/journal';
import { getInsightHistory } from '../lib/insights'; 
import SobrietyCounter from '../components/SobrietyCounter';
import { Link } from 'react-router-dom';
import { 
  ArrowRightIcon, 
  ChartBarIcon, 
  SparklesIcon 
} from '@heroicons/react/24/outline';

export default function Dashboard() {
  const { user } = useAuth();
  
  // State
  const [sobrietyDate, setSobrietyDate] = useState<Date | null>(null);
  const [recentEntries, setRecentEntries] = useState<JournalEntry[]>([]);
  const [latestInsight, setLatestInsight] = useState<any | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadDashboardData() {
      if (!user || !db) return;

      try {
        // 1. Fetch User Profile for Sobriety Date
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().sobrietyDate) {
          setSobrietyDate(userDoc.data().sobrietyDate.toDate());
        }

        // 2. Fetch Recent Journals (Last 7 for stats)
        const journals = await getUserJournals(user.uid);
        setRecentEntries(journals.slice(0, 7)); 

        // 3. Fetch Latest Insight
        try {
            const insights = await getInsightHistory(user.uid);
            if (insights.length > 0) setLatestInsight(insights[0]);
        } catch (e) {
            console.warn("Insight history fetch failed", e);
        }

      } catch (error) {
        console.error("Error loading dashboard:", error);
      } finally {
        setLoading(false);
      }
    }

    loadDashboardData();
  }, [user]);

  if (loading) {
    return <div className="p-8 text-center text-gray-500">Loading Dashboard...</div>;
  }

  return (
    <div className="space-y-8 max-w-5xl mx-auto">
      
      {/* 1. WELCOME SECTION */}
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
           <h1 className="text-2xl font-bold text-gray-900">Welcome back, {user?.displayName}</h1>
           <p className="text-gray-500">Here is your recovery overview for today.</p>
        </div>
        <Link 
          to="/journal" 
          className="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm"
        >
          <span>Check In</span>
          <ArrowRightIcon className="h-4 w-4" />
        </Link>
      </div>

      {/* 2. HERO: SOBRIETY COUNTER */}
      {sobrietyDate ? (
        <SobrietyCounter sobrietyDate={sobrietyDate} />
      ) : (
        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4">
          <p className="text-yellow-700">
            <strong>Action Required:</strong> Please go to your <Link to="/profile" className="underline">Profile</Link> to set your Sobriety Date.
          </p>
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {/* 3. RECENT MOOD TREND */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <ChartBarIcon className="h-5 w-5 text-gray-500" />
            Mood History
          </h3>
          
          {recentEntries.length > 0 ? (
            <div className="flex items-end justify-between h-32 space-x-2">
              {[...recentEntries].reverse().map((entry) => (
                <div key={entry.id} className="flex flex-col items-center flex-1 group">
                   <div 
                     className={`w-full rounded-t-md transition-all duration-500 ${
                        entry.moodScore >= 7 ? 'bg-green-400' : 
                        entry.moodScore <= 3 ? 'bg-red-400' : 'bg-yellow-400'
                     }`}
                     style={{ height: `${entry.moodScore * 10}%` }}
                   />
                   <span className="text-xs text-gray-400 mt-2">
                     {entry.createdAt.getDate()}
                   </span>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-gray-400 text-sm">
              No journal entries yet. Check in to see your trends!
            </div>
          )}
        </div>

        {/* 4. LATEST INSIGHT CARD */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <SparklesIcon className="h-5 w-5 text-purple-500" />
            Latest Insight
          </h3>
          
          {latestInsight ? (
            <div className="space-y-3">
              <p className="text-gray-600 italic">"{latestInsight.analysis}"</p>
              
              <div className="pt-2">
                <p className="text-xs font-bold text-gray-400 uppercase mb-2">Suggested Action</p>
                <div className="flex items-center gap-2 text-sm text-gray-800 bg-purple-50 p-2 rounded">
                  <div className="w-2 h-2 bg-purple-500 rounded-full" />
                  {latestInsight.actionableSteps?.[0] || "Keep coming back!"}
                </div>
              </div>
              
              <div className="text-right">
                 <Link to="/journal" className="text-sm text-blue-600 hover:underline">View all insights &rarr;</Link>
              </div>
            </div>
          ) : (
            <div className="text-center py-8 text-gray-400 text-sm">
              Use the "Sparkle Button" in your Journal to generate your first AI Insight.
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Journal.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  addJournalEntry, 
  getUserJournals, 
  deleteJournalEntry, 
  updateJournalEntry, 
  type JournalEntry 
} from '../lib/journal';
import { getCurrentWeather, type WeatherData } from '../lib/weather';
import { analyzeJournalEntries, type AnalysisResult } from '../lib/gemini';
import { saveInsight } from '../lib/insights';
import { 
  SunIcon, 
  PencilSquareIcon, 
  TrashIcon, 
  XCircleIcon,
  SparklesIcon, // The "Magic" Icon
  XMarkIcon
} from '@heroicons/react/24/outline'; 

export default function Journal() {
  const { user } = useAuth();
  
  // Form State
  const [content, setContent] = useState('');
  const [mood, setMood] = useState(5);
  const [loading, setLoading] = useState(false);
  const [weather, setWeather] = useState<WeatherData | null>(null);
  
  // Edit Mode State
  const [editingId, setEditingId] = useState<string | null>(null);
  
  // List State
  const [entries, setEntries] = useState<JournalEntry[]>([]);
  
  // AI Insight State
  const [analyzing, setAnalyzing] = useState(false);
  const [insight, setInsight] = useState<AnalysisResult | null>(null);

  // Load Data
  useEffect(() => {
    if (user) loadEntries();
  }, [user]);

  useEffect(() => {
    async function fetchLocalWeather() {
      const data = await getCurrentWeather();
      if (data) setWeather(data);
    }
    fetchLocalWeather();
  }, []);

  async function loadEntries() {
    if (!user) return;
    const data = await getUserJournals(user.uid);
    setEntries(data);
  }

  // --- ACTIONS ---

  const handleEditClick = (entry: JournalEntry) => {
    setContent(entry.content);
    setMood(entry.moodScore);
    setEditingId(entry.id!);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleCancelEdit = () => {
    setContent('');
    setMood(5);
    setEditingId(null);
  };

  const handleDeleteClick = async (id: string) => {
    if (!window.confirm("Delete this entry?")) return;
    try {
      await deleteJournalEntry(id);
      await loadEntries();
      if (editingId === id) handleCancelEdit();
    } catch (error) {
      console.error("Delete failed", error);
    }
  };

  // --- THE AI SPARKLE BUTTON ACTION ---
  const handleAnalyze = async () => {
    if (!user || entries.length === 0) return;
    
    setAnalyzing(true);
    try {
      // 1. Gather text from last 5 entries
      const recentTexts = entries.slice(0, 5).map(e => e.content);
      
      // 2. Send to Gemini
      const result = await analyzeJournalEntries(recentTexts);
      setInsight(result); // Show Popup
      
      // 3. Save to Database
      await saveInsight(user.uid, result);
      
    } catch (error) {
      console.error("Analysis failed", error);
      alert("AI Analysis failed. Check console.");
    } finally {
      setAnalyzing(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !content.trim()) return;

    setLoading(true);
    try {
      const tags = content.match(/#[a-z0-9]+/gi) || [];
      
      if (editingId) {
        await updateJournalEntry(editingId, content, mood, tags as string[]);
      } else {
        await addJournalEntry(user.uid, content, mood, tags as string[], weather);
      }
      
      handleCancelEdit();
      await loadEntries();
    } catch (error) {
      console.error("Failed to save journal", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-3xl mx-auto space-y-8 relative">
      
      {/* --- AI INSIGHT MODAL --- */}
      {insight && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
          <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden">
            <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex justify-between items-start">
               <div>
                 <h3 className="text-white text-lg font-bold flex items-center gap-2">
                   <SparklesIcon className="h-5 w-5 text-yellow-300" />
                   Recovery Insights
                 </h3>
                 <p className="text-purple-100 text-sm mt-1">Based on your recent entries</p>
               </div>
               <button onClick={() => setInsight(null)} className="text-purple-200 hover:text-white">
                 <XMarkIcon className="h-6 w-6" />
               </button>
            </div>
            
            <div className="p-6 space-y-4">
              <div className="bg-purple-50 p-4 rounded-lg border border-purple-100">
                <p className="text-gray-800 italic">"{insight.analysis}"</p>
              </div>

              <div>
                <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">Suggested Actions</h4>
                <ul className="space-y-2">
                  {insight.actionableSteps.map((step, i) => (
                    <li key={i} className="flex items-start gap-3">
                      <span className="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-xs font-bold">
                        {i + 1}
                      </span>
                      <span className="text-gray-700 text-sm">{step}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
            
            <div className="bg-gray-50 p-4 flex justify-end">
              <button 
                onClick={() => setInsight(null)}
                className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm font-medium"
              >
                Got it
              </button>
            </div>
          </div>
        </div>
      )}

      {/* --- MAIN PAGE --- */}

      {/* 1. ENTRY FORM */}
      <div className={`bg-white shadow sm:rounded-lg p-6 border-t-4 ${editingId ? 'border-orange-500' : 'border-blue-600'}`}>
        <div className="flex justify-between items-center mb-4">
            <h2 className="text-xl font-bold text-gray-900">
              {editingId ? 'Editing Entry' : 'Daily Check-In'}
            </h2>
            
            {weather ? (
                <div className="flex items-center text-xs text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">
                    <SunIcon className="h-4 w-4 mr-1" />
                    <span>{weather.temp}¬∞C, {weather.condition}</span>
                </div>
            ) : (
                <span className="text-xs text-gray-400">Locating...</span>
            )}
        </div>

        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <textarea
              rows={4}
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border"
              placeholder="Write your thoughts here... Use #hashtags to tag topics."
              value={content}
              onChange={(e) => setContent(e.target.value)}
            />
          </div>

          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Mood Score: <span className="text-blue-600 font-bold">{mood}/10</span>
            </label>
            <input 
              type="range" 
              min="1" max="10" 
              value={mood}
              onChange={(e) => setMood(Number(e.target.value))}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
            />
          </div>

          <div className="flex justify-end gap-3">
            {editingId && (
              <button
                type="button"
                onClick={handleCancelEdit}
                className="inline-flex items-center text-gray-600 px-4 py-2 hover:text-gray-900"
              >
                <XCircleIcon className="h-5 w-5 mr-1" />
                Cancel
              </button>
            )}
            
            <button
              type="submit"
              disabled={loading}
              className={`text-white px-4 py-2 rounded-md transition disabled:opacity-50 ${
                editingId ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'
              }`}
            >
              {loading ? 'Saving...' : (editingId ? 'Update Entry' : 'Save Entry')}
            </button>
          </div>
        </form>
      </div>

      {/* 2. HISTORY LIST HEADER & ANALYZE BUTTON */}
      <div className="flex items-center justify-between border-b pb-4 mb-4">
        <h3 className="text-lg font-medium text-gray-900">Recent Entries</h3>
        
        {entries.length > 0 && (
          <button
            onClick={handleAnalyze}
            disabled={analyzing}
            className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-full shadow-md hover:shadow-lg transition-all disabled:opacity-50"
          >
            {analyzing ? (
               <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full" />
            ) : (
               <SparklesIcon className="h-4 w-4 text-yellow-300" />
            )}
            <span className="text-sm font-bold">
              {analyzing ? 'Analyzing...' : 'Get AI Insights'}
            </span>
          </button>
        )}
      </div>
      
      {/* 3. ENTRIES LIST */}
      <div className="space-y-4">
        {entries.map((entry) => (
          <div key={entry.id} className={`bg-white shadow rounded-lg p-6 relative group ${editingId === entry.id ? 'ring-2 ring-orange-400' : ''}`}>
            
            <div className="absolute top-4 right-4 flex space-x-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
              <button onClick={() => handleEditClick(entry)} className="text-gray-400 hover:text-blue-600 p-1">
                <PencilSquareIcon className="h-5 w-5" />
              </button>
              <button onClick={() => handleDeleteClick(entry.id!)} className="text-gray-400 hover:text-red-600 p-1">
                <TrashIcon className="h-5 w-5" />
              </button>
            </div>

            <div className="flex justify-between items-start mb-2 pr-16">
              <div className="flex flex-col">
                  <span className="text-sm font-bold text-gray-700">
                    {entry.createdAt.toLocaleDateString()}
                  </span>
                  <span className="text-xs text-gray-400">
                    {entry.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                  </span>
              </div>

              <div className="flex space-x-2">
                 {entry.weather && (
                    <span className="hidden sm:inline-flex items-center rounded-full bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700 border border-blue-100">
                        {entry.weather.temp}¬∞C {entry.weather.condition}
                    </span>
                 )}
                 <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
                    entry.moodScore >= 7 ? 'bg-green-100 text-green-800' :
                    entry.moodScore <= 3 ? 'bg-red-100 text-red-800' :
                    'bg-yellow-100 text-yellow-800'
                  }`}>
                    Mood: {entry.moodScore}
                  </span>
              </div>
            </div>
            
            <p className="text-gray-800 whitespace-pre-wrap mt-2">{entry.content}</p>
            
            {entry.tags && entry.tags.length > 0 && (
              <div className="mt-3 flex flex-wrap gap-2">
                {entry.tags.map(tag => (
                  <span key={tag} className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">
                    {tag}
                  </span>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Login.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function Login() {
  const { signInWithGoogle, user } = useAuth();
  const navigate = useNavigate();
  const [isLoggingIn, setIsLoggingIn] = useState(false);

  // If user is already logged in, kick them to dashboard
  useEffect(() => {
    if (user) navigate('/dashboard');
  }, [user, navigate]);

  const handleGoogleLogin = async () => {
    if (isLoggingIn) return; // Prevent double-clicks
    setIsLoggingIn(true);

    try {
      await signInWithGoogle();
      navigate('/dashboard');
    } catch (error: any) {
      console.error("Login Failed:", error);
      if (error.code === 'auth/popup-blocked') {
        alert("Please allow popups for this site to sign in.");
      } else if (error.code !== 'auth/cancelled-popup-request') {
        alert("Login failed. Please try again.");
      }
    } finally {
      setIsLoggingIn(false);
    }
  };

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8">
      <div className="w-full max-w-md space-y-8 bg-white p-8 shadow rounded-lg">
        <div className="text-center">
          <h1 className="mt-6 text-3xl font-bold tracking-tight text-gray-900">
            My Recovery Toolkit
          </h1>
          <p className="mt-2 text-sm text-gray-600">
            Your personal companion for the journey ahead.
          </p>
        </div>
        
        <div className="mt-8">
          <button
            onClick={handleGoogleLogin}
            disabled={isLoggingIn}
            className={`group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all ${
              isLoggingIn ? 'opacity-75 cursor-wait' : ''
            }`}
          >
            {isLoggingIn ? (
               <span className="flex items-center gap-2">
                 <svg className="animate-spin h-4 w-4 text-white" viewBox="0 0 24 24">
                   <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                   <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                 </svg>
                 Signing in...
               </span>
            ) : (
               'Sign in with Google'
            )}
          </button>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Profile.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getOrCreateUserProfile, updateSobrietyDate } from '../lib/db';
//import { Timestamp } from 'firebase/firestore';

export default function Profile() {
  const { user } = useAuth();
  const [dateStr, setDateStr] = useState('');
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState('');

  // Load existing date on mount
  useEffect(() => {
    async function loadData() {
      if (user) {
        try {
          const profile = await getOrCreateUserProfile(user);
          if (profile.sobrietyDate) {
            // Convert Timestamp to YYYY-MM-DD for input field
            const date = profile.sobrietyDate.toDate();
            setDateStr(date.toISOString().split('T')[0]);
          }
        } catch (error) {
          console.error("Error loading profile:", error);
        } finally {
          setLoading(false);
        }
      }
    }
    loadData();
  }, [user]);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !dateStr) return;
    
    setLoading(true);
    try {
      // Create date object (append T12:00:00 to avoid timezone shifts)
      const dateObj = new Date(dateStr + 'T12:00:00'); 
      await updateSobrietyDate(user.uid, dateObj);
      setMessage('Sobriety date updated successfully!');
    } catch (error) {
      console.error("Error saving:", error);
      setMessage('Failed to save date.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto py-8 px-4">
      <div className="bg-white shadow rounded-lg p-6">
        <h2 className="text-2xl font-bold text-deep-charcoal mb-6">User Profile</h2>
        
        <form onSubmit={handleSave} className="space-y-6">
          <div>
            <label className="block text-sm font-medium text-gray-700">
              Email Address
            </label>
            <input 
              type="text" 
              disabled 
              value={user?.email || ''} 
              className="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm p-2"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">
              Sobriety Date
            </label>
            <p className="text-xs text-gray-500 mb-2">Used to calculate your clean time counter.</p>
            <input 
              type="date" 
              required
              value={dateStr}
              onChange={(e) => setDateStr(e.target.value)}
              className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm p-2 border"
            />
          </div>

          <div className="flex items-center justify-between">
            <button
              type="submit"
              disabled={loading}
              className="inline-flex justify-center rounded-md border border-transparent bg-serene-teal py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 disabled:opacity-50"
            >
              {loading ? 'Saving...' : 'Save Profile'}
            </button>
            {message && (
              <span className={`text-sm ${message.includes('Failed') ? 'text-red-600' : 'text-green-600'}`}>
                {message}
              </span>
            )}
          </div>
        </form>
      </div>
    </div>
  );
}

================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Unified Blue Theme (from Master Tech Doc)
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8', // Primary Brand Color
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}


================================================================================
FILE: tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}


================================================================================
FILE: tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

