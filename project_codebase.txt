PROJECT EXPORT - 2025-12-26T16:08:11.947Z


================================================================================
FILE: package.json
================================================================================
{
  "name": "mrt2",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --ext ts,tsx --fix",
    "test": "vitest",
    "test:watch": "vitest --watch",
    "preview": "vite preview",
    "prepare": "husky"
  },
  "lint-staged": {
  "src/**/*.{ts,tsx}": [
    "eslint --fix",
    "vitest related --run"
  ]
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@headlessui/react": "^2.2.9",
    "@heroicons/react": "^2.2.0",
    "date-fns": "^4.1.0",
    "firebase": "^12.6.0",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-confetti": "^6.4.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@testing-library/user-event": "^14.6.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@typescript-eslint/eslint-plugin": "^8.50.0",
    "@typescript-eslint/parser": "^8.50.0",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "clsx": "^2.1.1",
    "eslint": "^9.39.2",
    "eslint-plugin-react": "^7.37.5",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.26",
    "globals": "^16.5.0",
    "husky": "^9.1.7",
    "jsdom": "^27.3.0",
    "lint-staged": "^16.2.7",
    "postcss": "^8.5.6",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "3.4",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0",
    "vitest": "^4.0.16"
  }
}


================================================================================
FILE: vite.config.ts
================================================================================
import { VitePWA } from 'vite-plugin-pwa';
import react from '@vitejs/plugin-react';
// We remove the standard 'defineConfig' from 'vite' and use the vitest-augmented version 
// to satisfy both the TypeScript compiler and ESLint rules.
import { defineConfig as defineVitestConfig } from 'vitest/config';

export default defineVitestConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'mask-icon.svg'],
      manifest: {
        name: 'My Recovery Toolkit',
        short_name: 'MRT',
        description: 'A Buddhist-inspired and 12-step recovery companion toolkit.',
        theme_color: '#2563eb',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable'
          }
        ]
      },
      // --- NEW SECTION: THE FIX FOR FIREBASE AUTH ---
      workbox: {
        // 1. CRITICAL: Ignore Firebase Auth URLs so the popup works
        navigateFallbackDenylist: [
            /^\/__\/auth/, 
            /^\/__\/firebase/
        ],
        
        // 2. Performance Caching (The extra lines you noticed)
        // These cache fonts and images so the app looks good offline
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
            {
                urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
                handler: 'CacheFirst',
                options: {
                    cacheName: 'google-fonts-cache',
                    expiration: {
                        maxEntries: 10,
                        maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
                    },
                    cacheableResponse: {
                        statuses: [0, 200]
                    }
                }
            },
            {
                urlPattern: /^https:\/\/firebasestorage\.googleapis\.com\/.*/i,
                handler: 'StaleWhileRevalidate',
                options: {
                    cacheName: 'firebase-storage-cache',
                    expiration: {
                        maxEntries: 50
                    }
                }
            }
        ]
      }
      // ----------------------------------------------
    })
  ],
  test: {
    // Enable global APIs like 'describe', 'it', and 'expect'
    globals: true,
    // Simulate a browser environment using jsdom for React component testing
    environment: 'jsdom',
    // Path to the setup file that extends DOM matchers
    setupFiles: './src/test/setup.ts',
    // Ensure CSS is processed so tests can verify styles or visibility
    css: true,
  },
});

================================================================================
FILE: .eslintrc.json
================================================================================
{
  "root": true,
  "env": {
    "browser": true,
    "es2020": true,
    "node": true
  },
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react-hooks/recommended",
    "plugin:react/recommended",
    "plugin:react/jsx-runtime"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module",
    "ecmaFeatures": {
      "jsx": true
    }
  },
  "plugins": ["react-refresh", "@typescript-eslint"],
  "rules": {
    "react-refresh/only-export-components": [
      "warn",
      { "allowConstantExport": true }
    ],
    "react/prop-types": "off", 
    "@typescript-eslint/no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }],
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/exhaustive-deps": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}

================================================================================
FILE: check_models.js
================================================================================
import fs from 'fs';
import path from 'path';

async function check() {
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    if (!fs.existsSync(envPath)) {
      console.error("‚ùå Error: Could not find .env file.");
      process.exit(1);
    }

    const envContent = fs.readFileSync(envPath, 'utf8');
    const match = envContent.match(/VITE_GEMINI_API_KEY=(.*)/);
    
    if (!match || !match[1]) {
      console.error("‚ùå Error: VITE_GEMINI_API_KEY not found in .env");
      process.exit(1);
    }

    // SANITIZATION: Remove spaces AND quotes (" or ') from the key
    const rawKey = match[1].trim();
    const apiKey = rawKey.replace(/^["']|["']$/g, ''); 

    console.log(`üîë Testing Key: ${apiKey.substring(0, 6)}... (Length: ${apiKey.length})`);

    // Query Google
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API Error ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    const contentModels = data.models.filter(m => 
      m.supportedGenerationMethods.includes("generateContent")
    );

    console.log("\n‚úÖ SUCCESS! HERE ARE YOUR AVAILABLE MODELS:");
    console.table(contentModels.map(m => ({
      name: m.name.replace('models/', ''), // Use THIS string in your code
      version: m.version,
      displayName: m.displayName
    })));

  } catch (error) {
    console.error("‚ùå Failed:", error.message);
  }
}

check();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}

================================================================================
FILE: firestore.indexes.json
================================================================================
{
  "indexes": [
    {
      "collectionGroup": "journals",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "uid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "insights",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "uid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}

================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Recovery Toolkit</title>
    <meta name="description" content="Your digital companion for recovery.">
    <meta name="theme-color" content="#2A9D8F">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: postcss.config.js
================================================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: src/App.css
================================================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE: src/App.tsx
================================================================================
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { EncryptionProvider } from './contexts/EncryptionContext'; // NEW
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import Journal from './pages/Journal';
import Tasks from './pages/Tasks';
import Profile from './pages/Profile';
import Workbooks from './pages/Workbooks'; 
import WorkbookDetail from './pages/WorkbookDetail'; 
import WorkbookSession from './pages/WorkbookSession'; 
import Vitality from './pages/Vitality';
import TemplateEditor from './components/journal/TemplateEditor'; 
import AppShell from './components/AppShell';
import InsightsLog from './pages/InsightsLog';
import VaultGate from './components/VaultGate'; // NEW

function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  if (loading) return <div>Loading...</div>;
  
  if (!user) {
    return <Navigate to="/login" />;
  }

  return <AppShell>{children}</AppShell>;
}

export default function App() {
  return (
    <AuthProvider>
      <EncryptionProvider>
        <Router>
          <Routes>
            <Route path="/login" element={<Login />} />
            
            <Route
              path="/dashboard"
              element={
                <PrivateRoute>
                  <Dashboard />
                </PrivateRoute>
              }
            />
            
            {/* PROTECTED JOURNAL ROUTES */}
            <Route
              path="/journal"
              element={
                <PrivateRoute>
                  <VaultGate>
                    <Journal />
                  </VaultGate>
                </PrivateRoute>
              }
            />
            
            <Route
              path="/tasks"
              element={
                <PrivateRoute>
                  <Tasks />
                </PrivateRoute>
              }
            />
            
            {/* --- WORKBOOK ROUTES (Protected) --- */}
            <Route
              path="/workbooks"
              element={
                <PrivateRoute>
                   <VaultGate>
                      <Workbooks />
                   </VaultGate>
                </PrivateRoute>
              }
            />
            <Route
              path="/workbooks/:workbookId"
              element={
                <PrivateRoute>
                  <VaultGate>
                    <WorkbookDetail />
                  </VaultGate>
                </PrivateRoute>
              }
            />
            <Route
              path="/workbooks/:workbookId/session/:sectionId"
              element={
                <PrivateRoute>
                   <VaultGate>
                     <WorkbookSession />
                   </VaultGate>
                </PrivateRoute>
              }
            />
            
            {/* --- VITALITY ROUTE --- */}
            <Route
              path="/vitality"
              element={
                <PrivateRoute>
                  <Vitality />
                </PrivateRoute>
              }
             />

            {/* --- INSIGHTS ROUTE (Protected) --- */}
            <Route
              path="/insights"
              element={
                <PrivateRoute>
                   <VaultGate>
                      <InsightsLog />
                   </VaultGate>
                </PrivateRoute>
              }
             />

            {/* --- TEMPLATES ROUTE --- */}
            <Route
              path="/templates"
              element={
                <PrivateRoute>
                  <TemplateEditor />
                </PrivateRoute>
              }
            />
            
            {/* ----------------------- */}
            <Route
              path="/profile"
              element={
                <PrivateRoute>
                   <Profile />
                </PrivateRoute>
              }
            />
            
            <Route path="/" element={<Navigate to="/dashboard" />} />
            <Route path="*" element={<Navigate to="/dashboard" />} />
          </Routes>
        </Router>
      </EncryptionProvider>
    </AuthProvider>
  );
}

================================================================================
FILE: src/components/AppShell.tsx
================================================================================
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  Bars3Icon, 
  XMarkIcon, 
  HomeIcon, 
  BookOpenIcon, 
  UserCircleIcon,
  ArrowLeftOnRectangleIcon,
  ClipboardDocumentListIcon,
  AcademicCapIcon,
  HeartIcon,
  ExclamationTriangleIcon,
  LightBulbIcon
} from '@heroicons/react/24/outline';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import SOSModal from './SOSModal';

export default function AppShell({ children }: { children: React.ReactNode }) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [isSOSOpen, setIsSOSOpen] = useState(false);
  const location = useLocation();
  const navigate = useNavigate();
  const { user, logout } = useAuth();

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { name: 'Journal', href: '/journal', icon: BookOpenIcon },
    { name: 'Vitality', href: '/vitality', icon: HeartIcon },
    { name: 'Tasks', href: '/tasks', icon: ClipboardDocumentListIcon },
    { name: 'Workbooks', href: '/workbooks', icon: AcademicCapIcon },
    { name: 'Insights', href: '/insights', icon: LightBulbIcon },
    { name: 'Profile', href: '/profile', icon: UserCircleIcon },
  ];

  const handleLogout = async () => {
    try {
      setSidebarOpen(false); 
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* --- GLOBAL SOS MODAL --- */}
      <SOSModal isOpen={isSOSOpen} onClose={() => setIsSOSOpen(false)} />

      {/* --- DESKTOP SOS BUTTON (Right-Justified Fixed) --- */}
      <div className="hidden lg:block fixed top-6 right-6 z-50">
         <button 
           onClick={() => setIsSOSOpen(true)}
           className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-2 transition-transform hover:scale-105 active:scale-95 animate-pulse"
           title="Emergency Support"
         >
            <ExclamationTriangleIcon className="h-5 w-5" />
            <span className="font-bold">SOS</span>
         </button>
      </div>

      <Transition.Root show={sidebarOpen} as={Fragment}>
        <Dialog as="div" className="relative z-50 lg:hidden" onClose={setSidebarOpen}>
          <div className="fixed inset-0 bg-gray-900/80" />
          <div className="fixed inset-0 flex">
            <Dialog.Panel className="relative mr-16 flex w-full max-w-xs flex-1 transform flex-col bg-blue-600 transition-all">
               
               <div className="flex h-16 shrink-0 items-center justify-end px-6">
                  <button onClick={() => setSidebarOpen(false)} className="-m-2.5 p-2.5 text-blue-200 hover:text-white">
                    <span className="sr-only">Close sidebar</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
               </div>

               <nav className="flex flex-1 flex-col px-6 pb-4">
                 <ul role="list" className="flex flex-1 flex-col gap-y-7">
                   <li>
                     <ul role="list" className="-mx-2 space-y-1">
                       {navigation.map((item) => (
                         <li key={item.name}>
                           <Link
                             to={item.href}
                             onClick={() => setSidebarOpen(false)}
                             className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                               location.pathname === item.href
                                 ? 'bg-blue-700 text-white'
                                 : 'text-blue-200 hover:text-white hover:bg-blue-700'
                             }`}
                           >
                              <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                             {item.name}
                           </Link>
                         </li>
                       ))}
                     </ul>
                   </li>
                   
                   <li className="mt-auto">
                     <div className="flex flex-col gap-2">
                        {user && (
                            <div className="flex items-center gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-white bg-blue-700/50">
                                {user.photoURL ? (
                                    <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                                ) : (
                                    <UserCircleIcon className="h-8 w-8 text-blue-200" />
                                )}
                                <span className="sr-only">Your profile</span>
                                <span aria-hidden="true">{user.displayName || user.email}</span>
                            </div>
                        )}
                        <button
                          onClick={handleLogout}
                          className="group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                        >
                          <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                           Log out
                        </button>
                     </div>
                   </li>
                 </ul>
               </nav>
            </Dialog.Panel>
          </div>
        </Dialog>
      </Transition.Root>

      {/* Desktop sidebar */}
      <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col">
        <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-blue-600 px-6 pb-4">
          <div className="flex h-16 shrink-0 items-center justify-center gap-2">
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
            <span className="text-white font-bold text-xl">My Recovery Toolkit</span>
          </div>
          <nav className="flex flex-1 flex-col">
            <ul role="list" className="flex flex-1 flex-col gap-y-7">
              <li>
                <ul role="list" className="-mx-2 space-y-1">
                  {navigation.map((item) => (
                    <li key={item.name}>
                      <Link
                        to={item.href}
                        className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                          location.pathname === item.href
                            ? 'bg-blue-700 text-white'
                            : 'text-blue-200 hover:text-white hover:bg-blue-700'
                        }`}
                      >
                        <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                        {item.name}
                      </Link>
                    </li>
                  ))}
                </ul>
              </li>

              <li className="mt-auto">
                 <div className="flex flex-col gap-2 border-t border-blue-500 pt-4">
                    {user && (
                        <div className="flex items-center gap-x-3 rounded-md px-2 py-2 text-sm font-semibold leading-6 text-white">
                            {user.photoURL ? (
                                <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                            ) : (
                                <UserCircleIcon className="h-8 w-8 text-blue-200" />
                            )}
                            <span className="sr-only">Your profile</span>
                            <span className="truncate" aria-hidden="true">{user.displayName || user.email}</span>
                        </div>
                    )}
                    <button
                      onClick={handleLogout}
                      className="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                    >
                      <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                      Log out
                    </button>
                 </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <div className="lg:pl-72">
        {/* MOBILE TOP BAR */}
        <div className="sticky top-0 z-40 flex h-16 shrink-0 items-center justify-center border-b border-blue-700 bg-blue-600 px-4 shadow-sm lg:hidden">
          
          {/* Hamburger (Absolute Left) */}
          <button 
            type="button" 
            className="-m-2.5 p-2.5 text-blue-200 hover:text-white absolute left-4 z-50" 
            onClick={() => setSidebarOpen(true)}
          >
            <span className="sr-only">Open sidebar</span>
            <Bars3Icon className="h-6 w-6" aria-hidden="true" />
          </button>

          {/* Centered Title with Flanking Logos */}
          <div className="flex items-center gap-2">
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
            <div className="text-lg font-bold leading-6 text-white whitespace-nowrap">My Recovery Toolkit</div>
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
          </div>

          {/* SOS Button (Absolute Right) */}
          <button 
            type="button"
            onClick={() => setIsSOSOpen(true)}
            className="absolute right-4 z-50 text-white bg-red-600 hover:bg-red-700 p-2 rounded-full shadow-sm animate-pulse"
            title="SOS"
          >
            <ExclamationTriangleIcon className="h-6 w-6" />
          </button>

        </div>

        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/CreateTaskModal.tsx
================================================================================
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  XMarkIcon, 
  PlusIcon,
  CalendarDaysIcon,
  ArrowPathIcon,
  FlagIcon
} from '@heroicons/react/24/outline';
import { addTask, type Frequency, type Priority } from '../lib/tasks';
import { useAuth } from '../contexts/AuthContext';

interface CreateTaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  onTaskAdded: () => void;
}

export default function CreateTaskModal({ isOpen, onClose, onTaskAdded }: CreateTaskModalProps) {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);

  // Form State
  const [title, setTitle] = useState('');
  const [priority, setPriority] = useState<Priority>('Medium');
  const [isRecurring, setIsRecurring] = useState(false);
  const [frequency, setFrequency] = useState<Frequency>('daily');
  const [dueDateStr, setDueDateStr] = useState(new Date().toISOString().split('T')[0]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !title.trim()) return;

    setLoading(true);
    try {
      // Convert input string to Date (noon to avoid TZ issues)
      const [y, m, d] = dueDateStr.split('-').map(Number);
      const dateObj = new Date(y, m - 1, d, 12, 0, 0);

      await addTask(
          user.uid, 
          title, 
          isRecurring ? frequency : 'once', 
          priority, 
          dateObj
      );
      
      // Reset & Close
      setTitle('');
      setIsRecurring(false);
      setPriority('Medium');
      setDueDateStr(new Date().toISOString().split('T')[0]);
      onTaskAdded();
      onClose();
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Transition.Root show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" />
        </Transition.Child>

        <div className="fixed inset-0 z-10 overflow-y-auto">
          <div className="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
              enterTo="opacity-100 translate-y-0 sm:scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 translate-y-0 sm:scale-100"
              leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
              <Dialog.Panel className="relative transform overflow-hidden rounded-xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                
                {/* Close Button */}
                <div className="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
                  <button
                    type="button"
                    className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                    onClick={onClose}
                  >
                    <span className="sr-only">Close</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <PlusIcon className="h-6 w-6 text-blue-600" aria-hidden="true" />
                  </div>
                  <div className="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                    <Dialog.Title as="h3" className="text-base font-semibold leading-6 text-gray-900">
                      Create New Quest
                    </Dialog.Title>
                    <div className="mt-2">
                      <p className="text-sm text-gray-500">
                        Add a new habit or task to your recovery ledger.
                      </p>
                    </div>

                    {/* FORM */}
                    <form onSubmit={handleSubmit} className="mt-6 space-y-5">
                        
                        {/* Title */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">Task Name</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                placeholder="e.g. Call Sponsor, Gym, Meditate"
                                autoFocus
                            />
                        </div>

                        {/* Date & Priority Row */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <CalendarDaysIcon className="h-3 w-3" /> Due Date
                                </label>
                                <input 
                                    type="date"
                                    value={dueDateStr}
                                    onChange={(e) => setDueDateStr(e.target.value)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                />
                            </div>
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <FlagIcon className="h-3 w-3" /> Priority
                                </label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value as Priority)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                >
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>

                        {/* Recurring Toggle */}
                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    id="recurring"
                                    checked={isRecurring}
                                    onChange={(e) => setIsRecurring(e.target.checked)}
                                    className="rounded text-blue-600 focus:ring-blue-500"
                                />
                                <label htmlFor="recurring" className="text-sm text-gray-700 font-medium flex items-center gap-2">
                                    <ArrowPathIcon className="h-4 w-4 text-gray-400" />
                                    Make this a Recurring Habit?
                                </label>
                            </div>
                            
                            {isRecurring && (
                                <div className="mt-3 pl-6 animate-fadeIn">
                                    <label className="block text-xs font-medium text-gray-500 mb-1">Frequency</label>
                                    <div className="flex gap-2">
                                        {(['daily', 'weekly', 'monthly'] as Frequency[]).map((freq) => (
                                            <button
                                                key={freq}
                                                type="button"
                                                onClick={() => setFrequency(freq)}
                                                className={`px-3 py-1.5 text-xs font-medium rounded-md capitalize border transition-colors ${
                                                    frequency === freq 
                                                    ? 'bg-blue-100 text-blue-700 border-blue-200' 
                                                    : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                                                }`}
                                            >
                                                {freq}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Submit Button */}
                        <div className="mt-5 sm:mt-6">
                            <button
                                type="submit"
                                disabled={!title.trim() || loading}
                                className="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-50"
                            >
                                {loading ? 'Creating...' : 'Create Task'}
                            </button>
                        </div>
                    </form>

                  </div>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition.Root>
  );
}

================================================================================
FILE: src/components/RecoveryHero.tsx
================================================================================
import { Link } from 'react-router-dom';
import { 
    FireIcon, 
    ClipboardDocumentCheckIcon,
    ChartBarIcon, 
    SparklesIcon,
    BoltIcon,
    AcademicCapIcon,
    BookOpenIcon,
    ShieldCheckIcon,
    HeartIcon
} from '@heroicons/react/24/outline';

interface RecoveryHeroProps {
    userName: string;
    daysClean: number;
    journalStats: {
        streak: number;
        consistency: number;
    };
    taskStats: {
        fire: number;
        rate: number;
    };
    workbookStats: {
        wisdom: number;
        completion: number;
    };
    vitalityStats: { 
        bioStreak: number;
        totalLogs: number;
    };
    // Removed onSOSClick prop as button is removed
}

export default function RecoveryHero({ 
    userName, 
    daysClean, 
    journalStats, 
    taskStats, 
    workbookStats,
    vitalityStats
}: RecoveryHeroProps) {
  return (
      <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
         {/* Background Decoration */}
         <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
         
         <div className="relative z-10">
             {/* Header Row: Greeting & Clean Time */}
             <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                 <div>
                     <h1 className="text-3xl font-bold">Welcome back, {userName}</h1>
                     <p className="text-blue-100 opacity-90">One day at a time. You are doing great.</p>
                 </div>

                 <div className="flex items-center gap-3">
                     
                     {/* CLEAN TIME BADGE */}
                     <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-xl px-4 py-2 flex items-center gap-3 shadow-lg">
                         <ShieldCheckIcon className="h-8 w-8 text-cyan-300" />
                         <div className="text-right">
                             <div className="text-2xl font-bold leading-none">{daysClean}</div>
                             <div className="text-[10px] uppercase tracking-wider text-blue-100 font-semibold">Days Clean</div>
                         </div>
                     </div>
                 </div>
             </div>

             {/* THE MATRIX GRID (Linked Tiles) */}
             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                 
                 {/* COLUMN 1: JOURNAL */}
                 <Link to="/journal" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <BookOpenIcon className="h-4 w-4" /> Journal
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <FireIcon className="h-5 w-5 text-orange-400" />
                                 <span className="text-sm font-medium">Streak</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.streak} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <ChartBarIcon className="h-5 w-5 text-purple-400" />
                                 <span className="text-sm font-medium">Consistency</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.consistency}/wk</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 2: TASKS */}
                 <Link to="/tasks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <ClipboardDocumentCheckIcon className="h-4 w-4" /> Habits
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <BoltIcon className="h-5 w-5 text-yellow-400" />
                                 <span className="text-sm font-medium">Fire</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.fire} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 rounded-full border-2 border-green-400 flex items-center justify-center">
                                     <div className="h-2 w-2 bg-green-400 rounded-full" />
                                 </div>
                                 <span className="text-sm font-medium">Completion</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.rate}%</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 3: WORKBOOKS */}
                 <Link to="/workbooks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <AcademicCapIcon className="h-4 w-4" /> Wisdom
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <SparklesIcon className="h-5 w-5 text-cyan-400" />
                                 <span className="text-sm font-medium">Score</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.wisdom} Ans</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 relative">
                                     <svg className="w-full h-full transform -rotate-90">
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" strokeOpacity="0.3" strokeWidth="3" />
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="#67e8f9" strokeWidth="3" strokeDasharray={`${workbookStats.completion * 0.5} 100`} />
                                     </svg>
                                 </div>
                                 <span className="text-sm font-medium">Mastery</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.completion}%</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 4: VITALITY */}
                 <Link to="/vitality" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <HeartIcon className="h-4 w-4" /> Vitality
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <FireIcon className="h-5 w-5 text-rose-400" />
                                 <span className="text-sm font-medium">Bio-Streak</span>
                             </div>
                             <span className="text-xl font-bold">{vitalityStats.bioStreak} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <BoltIcon className="h-5 w-5 text-green-400" />
                                 <span className="text-sm font-medium">Total Logs</span>
                             </div>
                             <span className="text-xl font-bold">{vitalityStats.totalLogs}</span>
                         </div>
                     </div>
                 </Link>

             </div>
         </div>
      </div>
  );
}

================================================================================
FILE: src/components/SOSModal.tsx
================================================================================
import { Fragment } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  PhoneIcon, 
  XMarkIcon, 
  ExclamationTriangleIcon,
  HeartIcon,
  PencilSquareIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

interface SOSModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function SOSModal({ isOpen, onClose }: SOSModalProps) {
  const navigate = useNavigate();

  const handleNavigation = (path: string) => {
    onClose();
    navigate(path);
  };

  return (
    <Transition.Root show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-red-900/40 backdrop-blur-sm transition-opacity" />
        </Transition.Child>

        <div className="fixed inset-0 z-10 overflow-y-auto">
          <div className="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
              enterTo="opacity-100 translate-y-0 sm:scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 translate-y-0 sm:scale-100"
              leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
              <Dialog.Panel className="relative transform overflow-hidden rounded-2xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6 border-t-8 border-red-500">
                
                {/* Close Button */}
                <div className="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
                  <button
                    type="button"
                    className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                    onClick={onClose}
                  >
                    <span className="sr-only">Close</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <div className="sm:flex sm:items-start mb-6">
                  <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <ExclamationTriangleIcon className="h-6 w-6 text-red-600" aria-hidden="true" />
                  </div>
                  <div className="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900">
                      Crisis Support
                    </Dialog.Title>
                    <div className="mt-2">
                      <p className="text-sm text-gray-500">
                        You are not alone. Choose the support you need right now.
                      </p>
                    </div>
                  </div>
                </div>

                {/* OPTIONS GRID */}
                <div className="grid gap-4">
                    
                    {/* OPTION 1: CALL HELP */}
                    <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                        <h4 className="font-bold text-red-900 flex items-center gap-2 mb-2">
                            <PhoneIcon className="h-5 w-5" />
                            Immediate Support
                        </h4>
                        <div className="flex gap-3">
                             <a 
                                href="tel:988" 
                                className="flex-1 bg-white border border-red-200 text-red-700 font-bold py-3 rounded-lg text-center shadow-sm hover:bg-red-600 hover:text-white transition-colors"
                             >
                                Call 988 (Lifeline)
                             </a>
                             <a 
                                href="tel:911" 
                                className="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg text-center shadow-sm hover:bg-red-700 transition-colors"
                             >
                                Call 911
                             </a>
                        </div>
                    </div>

                    {/* OPTION 2: BREATHE */}
                    <button 
                        onClick={() => handleNavigation('/vitality')}
                        className="group bg-blue-50 p-4 rounded-xl border border-blue-100 hover:border-blue-300 transition-all text-left"
                    >
                        <h4 className="font-bold text-blue-900 flex items-center gap-2 mb-1">
                            <HeartIcon className="h-5 w-5 group-hover:scale-110 transition-transform" />
                            Ride the Wave (Breathwork)
                        </h4>
                        <p className="text-sm text-blue-700">
                            De-escalate your nervous system with 4-7-8 breathing. This feeling will pass.
                        </p>
                    </button>

                    {/* OPTION 3: JOURNAL (Urge Log) */}
                    <button 
                        onClick={() => handleNavigation('/journal?template=urge_log')}
                        className="group bg-purple-50 p-4 rounded-xl border border-purple-100 hover:border-purple-300 transition-all text-left"
                    >
                        <h4 className="font-bold text-purple-900 flex items-center gap-2 mb-1">
                            <PencilSquareIcon className="h-5 w-5 group-hover:scale-110 transition-transform" />
                            Log the Urge
                        </h4>
                        <p className="text-sm text-purple-700">
                            Process this craving using the "Urge Log" template. Get it out of your head.
                        </p>
                    </button>

                </div>

                <div className="mt-6 sm:flex sm:flex-row-reverse">
                  <button
                    type="button"
                    className="inline-flex w-full justify-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-200 sm:ml-3 sm:w-auto"
                    onClick={onClose}
                  >
                    Cancel
                  </button>
                </div>

              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition.Root>
  );
}

================================================================================
FILE: src/components/SobrietyCounter.tsx
================================================================================
import { useMemo } from 'react';
import { TrophyIcon } from '@heroicons/react/24/solid';

interface SobrietyCounterProps {
  sobrietyDate: Date;
}

// ensure 'export default' is present here
export default function SobrietyCounter({ sobrietyDate }: SobrietyCounterProps) {
  const time = useMemo(() => {
    const now = new Date();
    const start = new Date(sobrietyDate);
    
    // Calculate the difference
    const diffTime = Math.abs(now.getTime() - start.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = (totalDays % 365) % 30;

    return { years, months, days, totalDays };
  }, [sobrietyDate]);

  return (
    <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-xl p-6 text-white relative overflow-hidden">
      {/* Background Decoration */}
      <TrophyIcon className="absolute -right-4 -bottom-4 h-48 w-48 text-blue-500 opacity-20 transform rotate-12" />

      <div className="relative z-10">
        <h2 className="text-blue-100 text-sm font-semibold uppercase tracking-wider mb-4">
          Clean & Sober Time
        </h2>
        
        <div className="flex items-end space-x-6">
          {/* Years */}
          {time.years > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.years}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Years</span>
            </div>
          )}

          {/* Months */}
          {time.months > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.months}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Months</span>
            </div>
          )}

          {/* Days */}
          <div className="text-center">
            <span className="block text-4xl sm:text-5xl font-bold">{time.days}</span>
            <span className="text-xs sm:text-sm text-blue-200 uppercase">Days</span>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-blue-500/50 flex justify-between items-center text-sm text-blue-200">
          <span>Total Days: {time.totalDays}</span>
          <span>Started: {sobrietyDate.toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/VaultGate.tsx
================================================================================
import React, { useState } from 'react';
import { useEncryption } from '../contexts/EncryptionContext';
import { LockClosedIcon, KeyIcon, ShieldCheckIcon } from '@heroicons/react/24/outline';

interface VaultGateProps {
  children: React.ReactNode;
}

export default function VaultGate({ children }: VaultGateProps) {
  const { isVaultSet, isVaultUnlocked, vaultLoading, unlockVault, setupVault } = useEncryption();
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');
  const [confirmPin, setConfirmPin] = useState('');

  // If loading, show spinner
  if (vaultLoading) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-4">
        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
        <p className="text-gray-500">Securing Vault...</p>
      </div>
    );
  }

  // If Unlocked, show content
  if (isVaultUnlocked) {
    return <>{children}</>;
  }

  // HANDLE SETUP FLOW
  if (!isVaultSet) {
    const handleSetup = async (e: React.FormEvent) => {
      e.preventDefault();
      if (pin.length < 4) {
        setError("PIN must be at least 4 digits.");
        return;
      }
      if (pin !== confirmPin) {
        setError("PINs do not match.");
        return;
      }
      await setupVault(pin);
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh] p-4 text-center">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border border-gray-100">
            <div className="bg-blue-100 p-3 rounded-full w-fit mx-auto mb-4">
                <ShieldCheckIcon className="h-8 w-8 text-blue-600" />
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Create Recovery Vault</h2>
            <p className="text-gray-500 mb-6 text-sm">
                Your journal entries will be encrypted. Create a secure PIN. 
                <span className="block mt-2 text-red-500 font-bold">‚ö†Ô∏è If you lose this PIN, your data is lost forever.</span>
            </p>

            <form onSubmit={handleSetup} className="space-y-4">
                <input
                    type="password"
                    inputMode="numeric"
                    placeholder="Create PIN"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    className="w-full text-center text-2xl tracking-widest p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                />
                <input
                    type="password"
                    inputMode="numeric"
                    placeholder="Confirm PIN"
                    value={confirmPin}
                    onChange={(e) => setConfirmPin(e.target.value)}
                    className="w-full text-center text-2xl tracking-widest p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                />
                {error && <p className="text-red-500 text-sm">{error}</p>}
                
                <button 
                    type="submit"
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-md"
                >
                    Secure My Journal
                </button>
            </form>
        </div>
      </div>
    );
  }

  // HANDLE UNLOCK FLOW
  const handleUnlock = async (e: React.FormEvent) => {
    e.preventDefault();
    const success = await unlockVault(pin);
    if (!success) {
        setError("Incorrect PIN.");
        setPin('');
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh] p-4 text-center">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border border-gray-100">
            <div className="bg-gray-100 p-3 rounded-full w-fit mx-auto mb-4">
                <LockClosedIcon className="h-8 w-8 text-gray-600" />
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Vault Locked</h2>
            <p className="text-gray-500 mb-6 text-sm">Enter your PIN to decrypt your journal.</p>

            <form onSubmit={handleUnlock} className="space-y-4">
                <input
                    type="password"
                    inputMode="numeric"
                    autoFocus
                    placeholder="Enter PIN"
                    value={pin}
                    onChange={(e) => { setPin(e.target.value); setError(''); }}
                    className="w-full text-center text-2xl tracking-widest p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500"
                />
                {error && <p className="text-red-500 text-sm">{error}</p>}
                
                <button 
                    type="submit"
                    className="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl transition-all shadow-md flex items-center justify-center gap-2"
                >
                    <KeyIcon className="h-5 w-5" />
                    Unlock
                </button>
            </form>
        </div>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalEditor.tsx
================================================================================
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useEncryption } from '../../contexts/EncryptionContext'; // NEW: Import Encryption
import { db } from '../../lib/firebase';
import { collection, addDoc, Timestamp, doc, updateDoc, query, where, orderBy, limit, getDocs } from 'firebase/firestore';
import { 
    PlusIcon, 
    Cog6ToothIcon,
    MapPinIcon,
    ArrowPathIcon,
    TagIcon,
    XMarkIcon
} from '@heroicons/react/24/outline';
import { getUserTemplates, type JournalTemplate } from '../../lib/db';
import { getCurrentWeather } from '../../lib/weather';
import { useNavigate } from 'react-router-dom';

// --- Types ---

interface JournalDocData {
    tags?: string[];
    [key: string]: unknown;
}

export interface JournalEntry {
  id: string;
  content: string;
  moodScore: number;
  sentiment?: string;
  createdAt: Timestamp; 
  tags?: string[];
  weather?: { temp: number; condition: string } | null;
  isEncrypted?: boolean; // NEW: Added encryption flag
}

interface ExtendedJournalTemplate extends JournalTemplate {
    content?: string;
}

interface JournalEditorProps {
  initialEntry: JournalEntry | null;
  initialTemplateId?: string | null;
  onSaveComplete: () => void;
}

const DEFAULT_TEMPLATES = [
  { id: 'morning_checkin', name: 'Morning Check-in', text: "Morning Check-in ‚òÄÔ∏è\n\nHow am I feeling today?\n\n\nWhat is my main focus for today?\n\n\nOne thing I am grateful for:\n", tags: ['Morning'] },
  { id: 'nightly_review', name: 'Nightly Review', text: "Nightly Review üåô\n\nWhat went well today?\n\n\nWhat challenged me?\n\n\nDid I stay sober today?\n", tags: ['Nightly'] },
  { id: 'urge_log', name: 'Urge Log (SOS)', text: "Urge Log üö®\n\nTrigger:\n\n\nIntensity (1-10):\n\n\nCoping Strategy Used:\n", tags: ['Urge', 'SOS'] },
  { id: 'meeting_reflection', name: 'Meeting Reflection', text: "Meeting Reflection ü™ë\n\nMeeting Topic:\n\n\nOne thing I heard that resonated:\n\n\nHow can I apply this?\n", tags: ['Meeting'] },
];

export default function JournalEditor({ initialEntry, initialTemplateId, onSaveComplete }: JournalEditorProps) {
  const { user } = useAuth();
  const { encrypt } = useEncryption(); // NEW: Destructure encrypt function
  const navigate = useNavigate();

  // State
  const [newEntry, setNewEntry] = useState('');
  const [mood, setMood] = useState(5);
  const [weather, setWeather] = useState<{ temp: number; condition: string } | null>(null);
  const [saving, setSaving] = useState(false);
  const [weatherLoading, setWeatherLoading] = useState(false);
  
  // Tag State
  const [tags, setTags] = useState<string[]>([]);
  const [tagInput, setTagInput] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  
  // Template State
  const [customTemplates, setCustomTemplates] = useState<JournalTemplate[]>([]);
  const [activeTemplate, setActiveTemplate] = useState<JournalTemplate | null>(null);
  const [formAnswers, setFormAnswers] = useState<string[]>([]);

  // --- Helper Functions ---

  const fetchLocalWeather = useCallback(async () => {
    setWeatherLoading(true);
    try {
      const data = await getCurrentWeather();
      if (data) {
        setWeather({
          temp: Math.round(data.temp),
          condition: data.condition
        });
      }
    } catch (e) {
      console.warn("Failed to auto-load weather", e);
    } finally {
      setWeatherLoading(false);
    }
  }, []);

  const loadCustomTemplates = useCallback(async () => {
    if (!user) return;
    try {
        const t = await getUserTemplates(user.uid);
        setCustomTemplates(t);
    } catch (e) {
        console.error("Failed to load templates", e);
    }
  }, [user]);

  const loadUserTags = useCallback(async () => {
    if (!user || !db) return;
    try {
        const q = query(
            collection(db, 'journals'),
            where('uid', '==', user.uid),
            orderBy('createdAt', 'desc'),
            limit(50)
        );
        const snapshot = await getDocs(q);
        const tagSet = new Set<string>();
        snapshot.docs.forEach(doc => {
            const data = doc.data() as JournalDocData; 
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach((t: string) => tagSet.add(t));
            }
        });
        setAvailableTags(Array.from(tagSet).sort());
    } catch (e) {
        console.warn("Failed to load user tags", e);
    }
  }, [user]);

  const handleTemplateSelect = useCallback((tId: string) => {
    const defTemplate = DEFAULT_TEMPLATES.find(t => t.id === tId);
    if (defTemplate) {
        setNewEntry(defTemplate.text);
        setTags(prev => [...new Set([...prev, ...defTemplate.tags])]);
        setActiveTemplate(null);
        return;
    }

    const custTemplate = customTemplates.find(t => t.id === tId) as ExtendedJournalTemplate | undefined;
    
    if (custTemplate) {
        // Free Text Mode
        if (custTemplate.content) {
            setNewEntry(custTemplate.content);
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
            setActiveTemplate(null); 
        } 
        // Form Mode
        else if (custTemplate.prompts) {
            setActiveTemplate(custTemplate);
            setFormAnswers(new Array(custTemplate.prompts.length).fill(''));
            setNewEntry('');
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
        }
    } else {
        setActiveTemplate(null);
        setNewEntry('');
        setTags([]);
    }
  }, [customTemplates]); 

  // --- Effects ---

  useEffect(() => {
    if (!user) return;
    loadCustomTemplates();
    loadUserTags();
    if (!initialEntry) fetchLocalWeather(); 
  }, [user, initialEntry, loadCustomTemplates, loadUserTags, fetchLocalWeather]);

  useEffect(() => {
    if (initialEntry) {
      setNewEntry(initialEntry.content);
      setMood(initialEntry.moodScore);
      setTags(initialEntry.tags || []);
      if (initialEntry.weather) {
        setWeather(initialEntry.weather);
      }
      setActiveTemplate(null);
    } else {
      setNewEntry('');
      setMood(5);
      setTags([]);
      setActiveTemplate(null);
      setFormAnswers([]);
      setWeather(null);
      fetchLocalWeather(); 

      if (initialTemplateId) {
          handleTemplateSelect(initialTemplateId);
      }
    }
  }, [initialEntry, initialTemplateId, handleTemplateSelect, fetchLocalWeather]);

  // Tag Handling
  const handleAddTag = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTag(tagInput);
    } else if (e.key === 'Backspace' && tagInput === '' && tags.length > 0) {
        setTags(prev => prev.slice(0, -1));
    }
  };

  const addTag = (tagName: string) => {
    const cleanTag = tagName.trim().replace(/^#/, '');
    if (cleanTag && !tags.includes(cleanTag)) {
        setTags([...tags, cleanTag]);
    }
    setTagInput('');
    setShowSuggestions(false);
  };

  const removeTag = (tagToRemove: string) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  const filteredSuggestions = availableTags.filter(t => 
    t.toLowerCase().includes(tagInput.toLowerCase()) && !tags.includes(t)
  );

  // --- SAVE HANDLER (With Encryption) ---
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db) return;

    const isFormValid = activeTemplate && formAnswers.some(a => a.trim() !== '');
    const isTextValid = !activeTemplate && newEntry.trim() !== '';

    if (!isFormValid && !isTextValid) return;

    setSaving(true);

    // 1. Prepare Content
    let plainContent = newEntry;
    if (activeTemplate) {
        plainContent = `**${activeTemplate.name}**\n\n`;
        activeTemplate.prompts.forEach((prompt, idx) => {
            plainContent += `**${prompt}**\n${formAnswers[idx] || '-(Skipped)-'}\n\n`;
        });
    }

    try {
      // 2. Encrypt Content
      let contentToSave = plainContent;
      let isEncrypted = false;

      try {
        contentToSave = await encrypt(plainContent);
        isEncrypted = true;
      } catch (err) {
        console.error("Encryption failed", err);
        alert("Security Error: Could not encrypt. Save aborted.");
        setSaving(false);
        return;
      }

      // 3. Save to Firestore
      if (initialEntry) {
        await updateDoc(doc(db, 'journals', initialEntry.id), { 
            content: contentToSave, 
            moodScore: mood,
            tags: tags,
            isEncrypted: isEncrypted
        });
      } else {
        await addDoc(collection(db, 'journals'), {
          uid: user.uid,
          content: contentToSave,
          moodScore: mood,
          sentiment: 'Pending', 
          weather, 
          tags: tags,
          createdAt: Timestamp.now(),
          isEncrypted: isEncrypted
        });
      }

      // Reset
      setNewEntry('');
      setFormAnswers([]);
      setActiveTemplate(null);
      setMood(5);
      setTags([]);
      onSaveComplete();
    } catch (error) {
      console.error("Error saving entry:", error);
      alert("Failed to save entry.");
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-visible relative">
        
        {/* HEADER */}
        <div className="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center gap-3">
             
             {/* LEFT: Weather Widget */}
             <div>
                 {weather ? (
                   <div className="flex items-center gap-2 text-xs text-gray-500 bg-white px-2 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                      <span>{weather.condition}</span>
                      <span className="font-bold">{weather.temp}¬∞C</span>
                      {!initialEntry && (
                          <button type="button" onClick={fetchLocalWeather} disabled={weatherLoading} className="ml-1 text-blue-400 hover:text-blue-600">
                              <ArrowPathIcon className={`h-3 w-3 ${weatherLoading ? 'animate-spin' : ''}`} />
                          </button>
                      )}
                   </div>
                ) : (
                    !initialEntry && (
                        <button 
                            type="button" 
                            onClick={fetchLocalWeather} 
                            disabled={weatherLoading}
                            className="flex items-center gap-1 text-xs text-gray-500 hover:text-blue-600 bg-white hover:bg-blue-50 px-2 py-1.5 rounded-lg border border-gray-200 transition-colors shadow-sm"
                        >
                            {weatherLoading ? (
                                <ArrowPathIcon className="h-3 w-3 animate-spin" />
                            ) : (
                                <MapPinIcon className="h-3 w-3" />
                            )}
                            <span>Add Weather</span>
                        </button>
                    )
                )}
             </div>

             {/* RIGHT: Template Controls */}
             <div className="flex items-center gap-2">
                 <div className="relative">
                     <select 
                        onChange={(e) => handleTemplateSelect(e.target.value)}
                        className="pl-3 pr-8 py-1.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white"
                        defaultValue=""
                        disabled={!!initialEntry} 
                    >
                        <option value="" disabled>Choose a Template...</option>
                        <option value="none">Free Write (Blank)</option>
                        <optgroup label="Standard">
                            {DEFAULT_TEMPLATES.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </optgroup>
                        {customTemplates.length > 0 && (
                            <optgroup label="My Templates">
                                {customTemplates.map(t => (
                                    <option key={t.id} value={t.id}>{t.name}</option>
                                ))}
                            </optgroup>
                        )}
                    </select>
                 </div>

                 <button 
                    onClick={() => navigate('/templates')}
                    className="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition"
                    title="Manage Templates"
                 >
                    <Cog6ToothIcon className="h-5 w-5" />
                 </button>
             </div>
        </div>
        
        <form onSubmit={handleSave} className="p-4 space-y-4">
          
          {/* EDITOR AREA */}
          {activeTemplate ? (
             <div className="space-y-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-blue-900">{activeTemplate.name}</h3>
                    <button 
                        type="button" 
                        onClick={() => setActiveTemplate(null)}
                        className="text-xs text-blue-500 hover:text-blue-700 underline"
                    >
                        Switch to Text Mode
                    </button>
                </div>
                
                {activeTemplate.prompts.map((prompt, idx) => (
                    <div key={idx}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{prompt}</label>
                        <textarea
                            rows={4} 
                            value={formAnswers[idx] || ''}
                            onChange={(e) => {
                                const newAns = [...formAnswers];
                                newAns[idx] = e.target.value;
                                setFormAnswers(newAns);
                            }}
                            className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                            placeholder="Type your answer..."
                        />
                    </div>
                ))}
             </div>
          ) : (
            <textarea
                value={newEntry}
                onChange={(e) => setNewEntry(e.target.value)}
                placeholder="How are you feeling today?"
                className="w-full h-[45vh] p-4 rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm resize-none text-gray-700 leading-relaxed font-mono"
            />
          )}

          {/* MOOD SLIDER */}
          <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
             <div className="flex items-center justify-between mb-2">
                <label className="text-sm font-medium text-gray-700">Mood Score</label>
                <span className={`text-sm font-bold px-2 py-0.5 rounded ${mood >= 7 ? 'text-green-700 bg-green-100' : mood <= 4 ? 'text-red-700 bg-red-100' : 'text-yellow-700 bg-yellow-100'}`}>
                    {mood}/10
                </span>
             </div>
             <input 
                 type="range" 
                 min="1" 
                 max="10" 
                 value={mood}
                 onChange={(e) => setMood(Number(e.target.value))}
                 className="w-full accent-blue-600 cursor-pointer"
             />
             <div className="flex justify-between text-xs text-gray-400 mt-1">
                 <span>Struggling</span>
                 <span>Neutral</span>
                 <span>Thriving</span>
             </div>
          </div>

          {/* FOOTER */}
          <div className="flex flex-col sm:flex-row items-center gap-4">
            
            {/* TAG INPUT */}
            <div className="relative group w-full sm:flex-1">
                <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500">
                    <TagIcon className="h-4 w-4 text-gray-400" />
                    
                    {tags.map(tag => (
                        <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                            {tag}
                            <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                                <XMarkIcon className="h-3 w-3" />
                            </button>
                        </span>
                    ))}

                    <input 
                        type="text"
                        value={tagInput}
                        onChange={(e) => {
                            setTagInput(e.target.value);
                            setShowSuggestions(true);
                        }}
                        onKeyDown={handleAddTag}
                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                        placeholder={tags.length === 0 ? "Add tags (e.g. Grateful)..." : ""}
                        className="flex-1 min-w-[120px] text-sm border-none focus:ring-0 p-0 text-gray-700 placeholder:text-gray-400"
                    />
                </div>

                {/* Autocomplete Suggestions */}
                {showSuggestions && tagInput && filteredSuggestions.length > 0 && (
                    <div className="absolute bottom-full left-0 mb-1 w-full max-w-sm bg-white rounded-lg shadow-lg border border-gray-200 max-h-40 overflow-y-auto z-50">
                        {filteredSuggestions.map(tag => (
                            <button
                                key={tag}
                                type="button"
                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors"
                                onClick={() => addTag(tag)}
                            >
                                {tag}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Save Button */}
            <button
              type="submit"
              disabled={saving}
              className="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition-all active:scale-95 disabled:opacity-50 whitespace-nowrap"
            >
              {saving ? (
                <span>Saving...</span>
              ) : (
                <>
                  <PlusIcon className="h-5 w-5" />
                  <span>{initialEntry ? 'Update Entry' : 'Save Entry'}</span>
                </>
              )}
            </button>
          </div>
        </form>
      </div>
  );
}

================================================================================
FILE: src/components/journal/JournalHistory.tsx
================================================================================
import { useState, useEffect, Fragment, useCallback } from 'react';
import { useSearchParams } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import { useEncryption } from '../../contexts/EncryptionContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs, deleteDoc, doc, Timestamp } from 'firebase/firestore';
import { 
    TrashIcon,
    PencilSquareIcon,
    ArrowPathIcon,
    SparklesIcon,
    FunnelIcon,
    MagnifyingGlassIcon,
    XMarkIcon,
    ShareIcon,
    ShieldExclamationIcon,
    TrophyIcon,
    WrenchScrewdriverIcon,
    LightBulbIcon,
    PlusCircleIcon,
    CheckCircleIcon,
    BookmarkIcon
} from '@heroicons/react/24/outline';
import { Dialog, Transition } from '@headlessui/react';
import { analyzeJournalEntries, type AnalysisResult } from '../../lib/gemini';
import { addTask } from '../../lib/tasks';
import { saveInsight } from '../../lib/insights';
import type { JournalEntry } from './JournalEditor';

interface JournalHistoryProps {
  onEdit: (entry: JournalEntry) => void;
}

export default function JournalHistory({ onEdit }: JournalHistoryProps) {
  const { user } = useAuth();
  const { decrypt } = useEncryption();
  const [searchParams, setSearchParams] = useSearchParams();

  // Data State
  const [entries, setEntries] = useState<JournalEntry[]>([]);
  const [filteredEntries, setFilteredEntries] = useState<JournalEntry[]>([]);
  const [loading, setLoading] = useState(true);

  // Filters State
  const [searchQuery, setSearchQuery] = useState(searchParams.get('search') || '');
  const [filterTag, setFilterTag] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);

  // AI State
  const [analyzing, setAnalyzing] = useState(false);
  const [insight, setInsight] = useState<AnalysisResult | null>(null);
  const [showInsightModal, setShowInsightModal] = useState(false);
  const [savingInsight, setSavingInsight] = useState(false);
  
  const [addedTools, setAddedTools] = useState<Set<string>>(new Set());

  // --- DATA LOADING & DECRYPTION ---
  const loadEntries = useCallback(async () => {
    if (!user || !db) return;

    try {
      const q = query(
        collection(db, 'journals'), 
        where('uid', '==', user.uid),
        orderBy('createdAt', 'desc')
      );

      const snapshot = await getDocs(q);
      
      // Decrypt on the fly
      const decryptedData = await Promise.all(snapshot.docs.map(async (doc) => {
          const data = doc.data();
          let content = data.content;

          // If encrypted, try to decrypt
          if (data.isEncrypted) {
             try {
                 content = await decrypt(data.content);
             } catch {
                 content = "[Locked Content]";
             }
          }

          return { 
              id: doc.id, 
              ...data, 
              content // Replace with decrypted content
          } as JournalEntry;
      }));

      setEntries(decryptedData);
      
      // Extract unique tags
      const tags = new Set<string>();
      decryptedData.forEach(e => e.tags?.forEach(t => tags.add(t)));
      setAvailableTags(Array.from(tags));

    } catch (error) {
      console.error("Error loading entries:", error);
    } finally {
      setLoading(false);
    }
  }, [user, decrypt]);

  // Initial Load
  useEffect(() => {
    loadEntries();
  }, [loadEntries]);

  // Listen for URL param changes
  useEffect(() => {
    const searchParam = searchParams.get('search');
    if (searchParam) {
        setSearchQuery(searchParam);
    }
  }, [searchParams]);

  // Client-Side Filtering
  useEffect(() => {
    let result = entries;

    if (searchQuery) {
        const lowerQ = searchQuery.toLowerCase();
        result = result.filter(e => e.content.toLowerCase().includes(lowerQ));
    }

    if (filterTag) {
        result = result.filter(e => e.tags?.includes(filterTag));
    }

    if (dateFrom) {
        const from = new Date(dateFrom);
        result = result.filter(e => {
            const date = e.createdAt instanceof Date ? e.createdAt : (e.createdAt as Timestamp).toDate();
            return date >= from;
        });
    }
    if (dateTo) {
        const to = new Date(dateTo);
        to.setHours(23, 59, 59, 999);
        result = result.filter(e => {
            const date = e.createdAt instanceof Date ? e.createdAt : (e.createdAt as Timestamp).toDate();
            return date <= to;
        });
    }

    setFilteredEntries(result);
  }, [entries, searchQuery, filterTag, dateFrom, dateTo]);

  const handleSearchChange = (val: string) => {
    setSearchQuery(val);
    if (val) {
        setSearchParams(prev => { prev.set('search', val); return prev; });
    } else {
        setSearchParams(prev => { prev.delete('search'); return prev; });
    }
  };

  const handleDelete = async (id: string) => {
    if (!db) return;
    if (!confirm('Are you sure you want to delete this entry?')) return;

    try {
      await deleteDoc(doc(db, 'journals', id));
      await loadEntries(); 
    } catch (error) {
      console.error(error);
    }
  };

  const handleShare = async (entry: JournalEntry) => {
    const dateObj = entry.createdAt instanceof Date ? entry.createdAt : (entry.createdAt as Timestamp).toDate();
    const dateStr = dateObj.toLocaleDateString();
    
    const signature = "\n\nShared from My Recovery Toolkit";
    const textToShare = `Journal Entry - ${dateStr}\n\n${entry.content}${signature}`;

    if (navigator.share) {
        try {
            await navigator.share({ title: `Journal Entry ${dateStr}`, text: textToShare });
        } catch (err) { console.error('Error sharing:', err); }
    } else {
        try {
            await navigator.clipboard.writeText(textToShare);
            alert('Journal entry copied to clipboard!'); 
        } catch (err) { console.error('Failed to copy:', err); }
    }
  };

  const handleAiAnalysis = async () => {
    if (filteredEntries.length === 0) return;
    setAnalyzing(true);
    setShowInsightModal(true);
    setAddedTools(new Set()); 
    setSavingInsight(false);
    
    const textsToAnalyze = filteredEntries.slice(0, 10).map(e => e.content);
    const result = await analyzeJournalEntries(textsToAnalyze);
    
    setInsight(result);
    setAnalyzing(false);
  };

  const handleSaveLog = async () => {
    if (!user || !insight) return;
    setSavingInsight(true);
    try {
        await saveInsight(user.uid, { type: 'journal', ...insight });
        alert("Insight saved to Wisdom Log!");
        setSavingInsight(false);
    } catch (error) {
        console.error("Failed to save log", error);
        setSavingInsight(false);
    }
  };

  const handleAddToTasks = async (toolSuggestion: string) => {
    if (!user) return;
    try {
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 7);
        await addTask(user.uid, toolSuggestion, 'once', 'Medium', dueDate);
        setAddedTools(prev => new Set(prev).add(toolSuggestion));
    } catch (error) {
        console.error("Failed to add task:", error);
    }
  };

  const clearFilters = () => {
      setSearchQuery('');
      setSearchParams(prev => { prev.delete('search'); return prev; });
      setFilterTag('');
      setDateFrom('');
      setDateTo('');
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Loading & Decrypting History...</div>;

  return (
    <div className="space-y-6">
      
      {/* HEADER & FILTERS */}
      <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-4">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
             <div className="relative flex-1 w-full sm:w-auto">
                <MagnifyingGlassIcon className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                <input 
                    type="text"
                    placeholder="Search keywords..."
                    value={searchQuery}
                    onChange={(e) => handleSearchChange(e.target.value)}
                    className="w-full pl-9 pr-3 py-2 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
             </div>
             <div className="flex items-center gap-2 w-full sm:w-auto">
                <button 
                    onClick={() => setShowFilters(!showFilters)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${showFilters ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'}`}
                 >
                    <FunnelIcon className="h-4 w-4" />
                    Filters
                 </button>
                 <button 
                    onClick={handleAiAnalysis}
                    disabled={analyzing || filteredEntries.length === 0}
                    className="flex-1 sm:flex-none flex items-center justify-center gap-2 text-purple-600 bg-purple-50 px-4 py-2 rounded-lg hover:bg-purple-100 transition-colors disabled:opacity-50"
                 >
                    {analyzing ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />}
                    <span className="font-medium text-sm">Analyze Selection</span>
                 </button>
             </div>
          </div>

          {showFilters && (
              <div className="pt-4 border-t border-gray-100 grid grid-cols-1 sm:grid-cols-3 gap-4 animate-fadeIn">
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">Filter by Tag</label>
                      <select value={filterTag} onChange={(e) => setFilterTag(e.target.value)} className="w-full text-sm border-gray-300 rounded-md">
                          <option value="">All Tags</option>
                          {availableTags.map(t => <option key={t} value={t}>{t}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">From Date</label>
                      <input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)} className="w-full text-sm border-gray-300 rounded-md" />
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">To Date</label>
                      <input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)} className="w-full text-sm border-gray-300 rounded-md" />
                  </div>
                  <div className="sm:col-span-3 flex justify-end">
                      <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                          <XMarkIcon className="h-3 w-3" /> Clear Filters
                      </button>
                  </div>
              </div>
          )}
      </div>

      <div className="flex justify-between items-center px-2">
          <p className="text-sm text-gray-500">
             Showing {filteredEntries.length} entries 
             {(searchQuery || filterTag || dateFrom) && <span className="text-gray-400"> (Filtered)</span>}
          </p>
      </div>

      {filteredEntries.length === 0 ? (
          <div className="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300">
            <p className="text-gray-500">No entries match your filters.</p>
          </div>
      ) : (
          filteredEntries.map(entry => (
            <div key={entry.id} className="bg-white rounded-xl shadow-sm border border-gray-200 hover:border-blue-300 transition-all group overflow-hidden">
              <div className="bg-blue-50/50 p-3 border-b border-gray-100 flex flex-nowrap justify-between items-center gap-2">
                
                {/* Meta Column */}
                <div className="flex flex-col items-start min-w-0">
                    <span className="text-sm font-bold text-gray-800 truncate">
                        {entry.createdAt instanceof Date 
                            ? entry.createdAt.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })
                            : (entry.createdAt as Timestamp).toDate().toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })
                        }
                    </span>
                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-1">
                        <span>
                            {entry.createdAt instanceof Date 
                                ? entry.createdAt.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' }) 
                                : (entry.createdAt as Timestamp).toDate().toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })
                            }
                        </span>
                        {entry.weather && (
                            <>
                                <span className="text-gray-300">‚Ä¢</span>
                                <span className="bg-white/80 px-1.5 py-0.5 rounded-md border border-gray-200 whitespace-nowrap">
                                    {entry.weather.condition}, {entry.weather.temp}¬∞C
                                </span>
                            </>
                        )}
                        {entry.isEncrypted && (
                             <span className="flex items-center gap-1 text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded border border-green-200">
                                 <ShieldExclamationIcon className="h-3 w-3" /> Encrypted
                             </span>
                        )}
                    </div>
                    {entry.tags && entry.tags.length > 0 && (
                        <div className="flex flex-wrap gap-1">
                             {entry.tags.slice(0, 3).map((tag, i) => (
                                  <span key={i} className="text-[10px] bg-white text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">{tag}</span>
                             ))}
                             {entry.tags.length > 3 && <span className="text-[10px] text-gray-400 pl-1">+{entry.tags.length - 3}</span>}
                        </div>
                    )}
                </div>

                {/* Action Column - Buttons are now ALWAYS visible */}
                <div className="flex items-center gap-2 flex-shrink-0 self-center">
                    <div className="flex items-center gap-1.5 bg-white/60 px-1.5 py-0.5 rounded-lg border border-blue-100/50 shadow-sm whitespace-nowrap">
                        <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wider hidden sm:inline">Mood</span>
                        <div className={`h-2 w-2 rounded-full ${entry.moodScore >= 7 ? 'bg-green-500' : entry.moodScore <= 4 ? 'bg-red-500' : 'bg-yellow-500'}`} />
                        <span className="text-xs font-bold text-gray-700">{entry.moodScore}</span>
                    </div>
                    {/* Removed 'opacity-0 group-hover:opacity-100' so icons are always visible */}
                    <div className="flex items-center gap-1 transition-opacity">
                       <button onClick={() => onEdit(entry)} className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-white rounded-full transition-colors" title="Edit"><PencilSquareIcon className="h-4 w-4" /></button>
                       <button onClick={() => handleShare(entry)} className="p-1.5 text-gray-400 hover:text-green-600 hover:bg-white rounded-full transition-colors" title="Share"><ShareIcon className="h-4 w-4" /></button>
                       <button onClick={() => handleDelete(entry.id)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-white rounded-full transition-colors" title="Delete"><TrashIcon className="h-4 w-4" /></button>
                    </div>
                </div>
              </div>

              {/* Body */}
              <div className="p-5">
                  <div className="prose prose-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
                    {entry.content}
                  </div>
                  {entry.sentiment && entry.sentiment !== 'Pending' && (
                    <div className="mt-4 flex justify-end">
                        <span className={`text-xs px-2 py-1 rounded-full border ${
                            entry.sentiment === 'Positive' ? 'bg-green-50 text-green-700 border-green-100' : 
                            entry.sentiment === 'Negative' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-gray-50 text-gray-600 border-gray-100'
                        }`}>
                            {entry.sentiment} Analysis
                        </span>
                    </div>
                  )}
              </div>
            </div>
          ))
      )}

      {/* INSIGHT MODAL */}
      <Transition appear show={showInsightModal} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowInsightModal(false)}>
          <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-200" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
          </Transition.Child>
          <div className="fixed inset-0 overflow-y-auto">
            <div className="flex min-h-full items-center justify-center p-4 text-center">
              <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-200" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
                <Dialog.Panel className="w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                  <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900 flex items-center gap-2 border-b border-gray-100 pb-4 mb-4">
                    <SparklesIcon className="h-6 w-6 text-purple-500" />
                    Recovery Compass Analysis
                  </Dialog.Title>
                  
                  {analyzing ? (
                    <div className="py-12 flex flex-col items-center justify-center">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mb-4"></div>
                        <p className="text-gray-500 font-medium">Consulting your AI Sponsor...</p>
                    </div>
                  ) : (
                    insight && (
                        <div className="space-y-6">
                            <div className="bg-purple-50 rounded-xl p-4 border border-purple-100 flex gap-4">
                                <div className="flex-shrink-0 p-2 bg-purple-100 rounded-lg h-fit">
                                    <LightBulbIcon className="h-6 w-6 text-purple-600" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-purple-900 text-sm uppercase tracking-wide mb-1">The Insight</h4>
                                    <p className="text-purple-800 text-sm leading-relaxed">{insight.summary}</p>
                                    <div className="flex gap-3 mt-3">
                                        <span className="text-xs font-semibold bg-white/50 px-2 py-1 rounded text-purple-700 border border-purple-200">
                                            Mood: {insight.mood}
                                        </span>
                                        <span className="text-xs font-semibold bg-white/50 px-2 py-1 rounded text-purple-700 border border-purple-200">
                                            Sentiment: {insight.sentiment}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-orange-50 rounded-xl p-4 border border-orange-100">
                                    <div className="flex items-center gap-2 mb-2 text-orange-800 font-bold text-sm uppercase tracking-wide">
                                        <ShieldExclamationIcon className="h-5 w-5" />
                                        Risk Detection
                                    </div>
                                    <p className="text-sm text-orange-900 leading-relaxed">
                                        {insight.risk_analysis}
                                    </p>
                                </div>
                                <div className="bg-green-50 rounded-xl p-4 border border-green-100">
                                    <div className="flex items-center gap-2 mb-2 text-green-800 font-bold text-sm uppercase tracking-wide">
                                        <TrophyIcon className="h-5 w-5" />
                                        Strengths & Wins
                                    </div>
                                    <p className="text-sm text-green-900 leading-relaxed">
                                        {insight.positive_reinforcement}
                                    </p>
                                </div>
                            </div>
                            <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                <div className="flex items-center gap-2 mb-3 text-blue-800 font-bold text-sm uppercase tracking-wide">
                                    <WrenchScrewdriverIcon className="h-5 w-5" />
                                    Suggested Toolkit (Quick Add)
                                </div>
                                <ul className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    {insight.tool_suggestions.map((tool, i) => {
                                        const isAdded = addedTools.has(tool);
                                        return (
                                            <li key={i} className={`bg-white p-3 rounded-lg text-sm text-blue-900 shadow-sm border ${isAdded ? 'border-green-200 bg-green-50' : 'border-blue-100'} flex items-start gap-2 justify-between group`}>
                                                <div className="flex items-start gap-2">
                                                    <span className="text-blue-400 font-bold mt-0.5">‚Ä¢</span>
                                                    <span className={isAdded ? 'text-green-700' : ''}>{tool}</span>
                                                </div>
                                                <button 
                                                    onClick={() => !isAdded && handleAddToTasks(tool)}
                                                    disabled={isAdded}
                                                    className={`flex-shrink-0 transition-all ${isAdded ? 'cursor-default' : 'hover:scale-110 cursor-pointer'}`}
                                                >
                                                    {isAdded ? (
                                                        <CheckCircleIcon className="h-5 w-5 text-green-500" />
                                                    ) : (
                                                        <PlusCircleIcon className="h-5 w-5 text-blue-300 group-hover:text-blue-600" />
                                                    )}
                                                </button>
                                            </li>
                                        );
                                    })}
                                </ul>
                            </div>
                        </div>
                    )
                  )}

                  <div className="mt-6 flex justify-between">
                    <button 
                        type="button" 
                        disabled={analyzing || !insight || savingInsight}
                        onClick={handleSaveLog}
                        className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors disabled:opacity-50"
                    >
                        <BookmarkIcon className="h-4 w-4" />
                        {savingInsight ? "Saving..." : "Save to Wisdom Log"}
                    </button>
                    <button type="button" className="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors" onClick={() => setShowInsightModal(false)}>
                      Close Analysis
                    </button>
                  </div>
                </Dialog.Panel>
              </Transition.Child>
            </div>
          </div>
        </Dialog>
      </Transition>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalInsights.tsx
================================================================================
import { useState, useEffect, useCallback, Fragment } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs, Timestamp } from 'firebase/firestore';
import type { JournalEntry } from './JournalEditor';
import {
  LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend
} from 'recharts';
import { startOfMonth, subMonths, isSameMonth, getDay } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import { Dialog, Transition } from '@headlessui/react';
import { 
  EyeSlashIcon, 
  TrashIcon, 
  Cog6ToothIcon, 
  XMarkIcon,
  PlusIcon
} from '@heroicons/react/24/outline';

// --- HELPERS ---
const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const COLORS = ['#4ade80', '#f87171', '#94a3b8']; // Green, Red, Gray

// Stop words for Word Cloud (Base set)
const BASE_STOP_WORDS = new Set([
  'the', 'and', 'a', 'to', 'of', 'in', 'i', 'is', 'that', 'it', 'for', 'my', 'was', 'on', 'with', 'as', 'at', 'be', 'have', 'this', 'me', 'so', 'but', 'not', 'are', 'am', 'will', 'just', 'all', 'today', 'day', 'had', 'very', 'im'
]);

// --- STRICT TYPES ---
interface MoodDataPoint {
  date: string;
  mood: number;
  [key: string]: string | number | undefined; 
}

interface DayComparisonData {
  name: string; // e.g., "Mon"
  currentAvg: number;
  prevAvg: number;
  [key: string]: string | number | undefined;
}

interface SentimentDataPoint {
  name: string;
  value: number;
  [key: string]: string | number | undefined;
}

interface WordCloudItem {
  text: string;
  count: number;
}

export default function JournalInsights() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);

  // Chart Data State
  const [moodData, setMoodData] = useState<MoodDataPoint[]>([]);
  const [dayData, setDayData] = useState<DayComparisonData[]>([]);
  const [sentimentData, setSentimentData] = useState<SentimentDataPoint[]>([]);
  const [wordCloud, setWordCloud] = useState<WordCloudItem[]>([]);

  // Word Cloud Settings State (Persistent)
  const [hiddenWords, setHiddenWords] = useState<Set<string>>(() => {
    const saved = localStorage.getItem('mrt_hidden_words');
    return saved ? new Set(JSON.parse(saved)) : new Set();
  });
  
  const [ignoredPhrases, setIgnoredPhrases] = useState<string[]>(() => {
    const saved = localStorage.getItem('mrt_ignored_phrases');
    return saved ? JSON.parse(saved) : [];
  });

  const [caseSensitive, setCaseSensitive] = useState<boolean>(false);
  const [showCloudSettings, setShowCloudSettings] = useState(false);
  const [newPhrase, setNewPhrase] = useState('');

  // --- SAVE SETTINGS ---
  useEffect(() => {
    localStorage.setItem('mrt_hidden_words', JSON.stringify(Array.from(hiddenWords)));
  }, [hiddenWords]);

  useEffect(() => {
    localStorage.setItem('mrt_ignored_phrases', JSON.stringify(ignoredPhrases));
  }, [ignoredPhrases]);

  // --- PROCESSORS ---

  const processMoodGraph = (entries: JournalEntry[]) => {
    const data = [...entries].reverse().slice(-30).map(e => ({
      date: e.createdAt?.toDate ? e.createdAt.toDate().toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' }) : '',
      mood: e.moodScore
    }));
    setMoodData(data);
  };

  const processDayComparison = (entries: JournalEntry[]) => {
    const currentSums = new Array(7).fill(0);
    const currentCounts = new Array(7).fill(0);
    const prevSums = new Array(7).fill(0);
    const prevCounts = new Array(7).fill(0);

    const now = new Date();
    const lastMonthDate = subMonths(now, 1);

    entries.forEach(e => {
      if (!e.createdAt?.toDate) return;
      const entryDate = e.createdAt.toDate();
      const dayIdx = getDay(entryDate);
      
      if (isSameMonth(entryDate, now)) {
        currentSums[dayIdx] += e.moodScore;
        currentCounts[dayIdx] += 1;
      } else if (isSameMonth(entryDate, lastMonthDate)) {
        prevSums[dayIdx] += e.moodScore;
        prevCounts[dayIdx] += 1;
      }
    });

    const data: DayComparisonData[] = DAYS.map((day, idx) => ({
      name: day,
      currentAvg: currentCounts[idx] ? parseFloat((currentSums[idx] / currentCounts[idx]).toFixed(1)) : 0,
      prevAvg: prevCounts[idx] ? parseFloat((prevSums[idx] / prevCounts[idx]).toFixed(1)) : 0
    }));

    setDayData(data);
  };

  const processSentiment = (entries: JournalEntry[]) => {
    let pos = 0, neg = 0, neu = 0;
    entries.forEach(e => {
      if (e.sentiment === 'Positive') pos++;
      else if (e.sentiment === 'Negative') neg++;
      else if (e.sentiment === 'Neutral') neu++;
      else {
        if (e.moodScore >= 7) pos++;
        else if (e.moodScore <= 4) neg++;
        else neu++;
      }
    });

    setSentimentData([
      { name: 'Positive', value: pos },
      { name: 'Negative', value: neg },
      { name: 'Neutral', value: neu }
    ].filter(d => d.value > 0));
  };

  const processWordCloud = useCallback((entries: JournalEntry[]) => {
    const wordCounts: Record<string, number> = {};

    entries.forEach(e => {
      let content = e.content;

      // 1. Remove Contextual Phrases FIRST
      // This allows filtering "I feel" so that "feel" isn't counted in that specific context,
      // but might be counted if used elsewhere.
      ignoredPhrases.forEach(phrase => {
        const regex = new RegExp(phrase, caseSensitive ? 'g' : 'gi');
        content = content.replace(regex, ''); 
      });

      // 2. Tokenize
      // Remove punctuation and split
      const cleanContent = content.replace(/[^\w\s]/g, '');
      const words = cleanContent.split(/\s+/);

      words.forEach(rawWord => {
        const w = caseSensitive ? rawWord : rawWord.toLowerCase();
        
        if (w.length > 2 && !BASE_STOP_WORDS.has(w.toLowerCase()) && !hiddenWords.has(w)) {
          wordCounts[w] = (wordCounts[w] || 0) + 1;
        }
      });
    });

    const sorted = Object.entries(wordCounts)
      .map(([text, count]) => ({ text, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 40); // Top 40 for better cloud density

    setWordCloud(sorted);
  }, [hiddenWords, ignoredPhrases, caseSensitive]);

  // --- DATA LOADING ---
  
  const loadData = useCallback(async () => {
    if (!user || !db) return;

    try {
      const now = new Date();
      const startOfLastMonth = startOfMonth(subMonths(now, 1));

      const q = query(
        collection(db, 'journals'),
        where('uid', '==', user.uid),
        where('createdAt', '>=', Timestamp.fromDate(startOfLastMonth)),
        orderBy('createdAt', 'desc')
      );

      const snapshot = await getDocs(q);
      const entries = snapshot.docs.map(doc => ({ ...doc.data() } as JournalEntry));

      processMoodGraph(entries);
      processDayComparison(entries);
      processSentiment(entries);
      processWordCloud(entries);

    } catch (error) {
      console.error("Error loading insights:", error);
    } finally {
      setLoading(false);
    }
  }, [user, processWordCloud]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // --- HANDLERS ---

  const handleWordClick = (word: string) => {
    // Navigate to history and filter by this word
    navigate(`/journal?tab=history&search=${encodeURIComponent(word)}`);
  };

  const handleWordRightClick = (e: React.MouseEvent, word: string) => {
    e.preventDefault();
    if (confirm(`Hide "${word}" from the cloud?`)) {
      setHiddenWords(prev => new Set(prev).add(word));
    }
  };

  const addIgnoredPhrase = () => {
    if (newPhrase.trim()) {
      setIgnoredPhrases(prev => [...prev, newPhrase.trim()]);
      setNewPhrase('');
    }
  };

  const removeIgnoredPhrase = (idx: number) => {
    setIgnoredPhrases(prev => prev.filter((_, i) => i !== idx));
  };

  const toggleHiddenWord = (word: string) => {
    setHiddenWords(prev => {
      const next = new Set(prev);
      if (next.has(word)) next.delete(word);
      else next.add(word);
      return next;
    });
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Crunching the numbers...</div>;

  if (moodData.length === 0) return <div className="text-center py-10 text-gray-400">No entries found for this period. Start journaling to see insights!</div>;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
      
      {/* 1. MOOD GRAPH */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2">
         <h3 className="font-bold text-gray-900 mb-4">Mood History (Last 30 Entries)</h3>
         <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
               <LineChart data={moodData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="date" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[1, 10]} hide />
                  <Tooltip 
                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="mood" 
                    stroke="#2563eb" 
                    strokeWidth={3}
                    dot={{ r: 4, fill: '#2563eb', strokeWidth: 0 }}
                    activeDot={{ r: 6 }} 
                  />
               </LineChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 2. TRIGGER DAYS */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
         <h3 className="font-bold text-gray-900 mb-4">Average Mood (This Month vs Last)</h3>
         <div className="h-56 w-full">
             <ResponsiveContainer width="100%" height="100%">
               <BarChart data={dayData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="name" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[0, 10]} hide />
                  <Tooltip cursor={{fill: 'transparent'}} />
                  <Legend wrapperStyle={{ fontSize: '12px' }} />
                  <Bar 
                    name="Last Month" 
                    dataKey="prevAvg" 
                    fill="#cbd5e1" // Slate-300
                    radius={[4, 4, 0, 0]} 
                  />
                  <Bar 
                    name="This Month" 
                    dataKey="currentAvg" 
                    fill="#3b82f6" // Blue-500
                    radius={[4, 4, 0, 0]} 
                  />
               </BarChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 3. SENTIMENT */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center">
         <h3 className="font-bold text-gray-900 mb-4 self-start">Emotional Weather</h3>
         <div className="h-56 w-full flex justify-center">
            <ResponsiveContainer width="100%" height="100%">
               <PieChart>
                  <Pie
                    data={sentimentData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={80}
                    paddingAngle={5}
                    dataKey="value"
                  >
                    {sentimentData.map((_, index) => (
                       <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
               </PieChart>
            </ResponsiveContainer>
         </div>
         <div className="flex gap-4 text-xs mt-2">
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#4ade80]"></div>Positive</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#f87171]"></div>Negative</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#94a3b8]"></div>Neutral</div>
         </div>
      </div>

      {/* 4. INTERACTIVE WORD CLOUD (UPDATED) */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2 relative">
         <div className="flex justify-between items-start mb-4">
             <h3 className="font-bold text-gray-900">Recurring Themes (Top Words)</h3>
             <button 
                onClick={() => setShowCloudSettings(true)}
                className="text-gray-400 hover:text-blue-600 p-1 rounded-full hover:bg-gray-50 transition-colors"
                title="Manage Cloud Settings"
             >
                 <Cog6ToothIcon className="h-5 w-5" />
             </button>
         </div>

         <div className="flex flex-wrap gap-x-4 gap-y-2 justify-center p-4 min-h-[150px] content-center">
            {wordCloud.length === 0 && <p className="text-gray-400 text-sm italic">No words found. Adjust your filters or journal more!</p>}
            
            {wordCloud.map((w) => {
               // Linear Normalization Logic for Sizing
               const max = wordCloud[0]?.count || 1;
               const min = wordCloud[wordCloud.length - 1]?.count || 0;
               // Scale between 0.85rem and 2.5rem
               const normalized = (w.count - min) / (max - min || 1); 
               const size = 0.85 + (normalized * 1.65);
               
               // Dynamic Opacity based on frequency
               const opacity = 0.6 + (normalized * 0.4);

               return (
                  <span 
                    key={w.text} 
                    style={{ fontSize: `${size}rem`, opacity }}
                    className="text-blue-600 font-medium cursor-pointer transition-all hover:scale-110 hover:text-blue-800 select-none"
                    title={`Click to filter history (${w.count} times)\nRight-click to hide`}
                    onClick={() => handleWordClick(w.text)}
                    onContextMenu={(e) => handleWordRightClick(e, w.text)}
                  >
                    {w.text}
                  </span>
               );
            })}
         </div>
         <p className="text-center text-xs text-gray-400 mt-2">Click word to view entries ‚Ä¢ Right-click to hide</p>
      </div>

      {/* --- WORD CLOUD SETTINGS MODAL --- */}
      <Transition appear show={showCloudSettings} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowCloudSettings(false)}>
          <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Dialog.Panel className="w-full max-w-lg transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all">
                <div className="flex justify-between items-center mb-6">
                    <Dialog.Title className="text-lg font-bold text-gray-900">Cloud Settings</Dialog.Title>
                    <button onClick={() => setShowCloudSettings(false)} className="text-gray-400 hover:text-gray-600">
                        <XMarkIcon className="h-6 w-6" />
                    </button>
                </div>

                <div className="space-y-6">
                    
                    {/* 1. Contextual Phrases */}
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <h4 className="text-sm font-bold text-gray-700 mb-2">Ignored Context Phrases</h4>
                        <p className="text-xs text-gray-500 mb-3">Words inside these phrases won't be counted. e.g. "I feel"</p>
                        
                        <div className="flex gap-2 mb-3">
                            <input 
                                type="text" 
                                value={newPhrase} 
                                onChange={(e) => setNewPhrase(e.target.value)}
                                placeholder='e.g., "I feel"'
                                className="flex-1 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                onKeyDown={(e) => e.key === 'Enter' && addIgnoredPhrase()}
                            />
                            <button onClick={addIgnoredPhrase} className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">
                                <PlusIcon className="h-5 w-5" />
                            </button>
                        </div>

                        <div className="flex flex-wrap gap-2">
                            {ignoredPhrases.map((phrase, idx) => (
                                <span key={idx} className="bg-white border border-gray-200 text-gray-700 px-2 py-1 rounded-md text-xs flex items-center gap-1">
                                    "{phrase}"
                                    <button onClick={() => removeIgnoredPhrase(idx)} className="text-red-400 hover:text-red-600 ml-1">
                                        <XMarkIcon className="h-3 w-3" />
                                    </button>
                                </span>
                            ))}
                            {ignoredPhrases.length === 0 && <span className="text-xs text-gray-400 italic">No phrases added.</span>}
                        </div>
                    </div>

                    {/* 2. Hidden Words List */}
                    <div>
                        <h4 className="text-sm font-bold text-gray-700 mb-2">Hidden Words</h4>
                        <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">
                            {Array.from(hiddenWords).map(word => (
                                <button 
                                    key={word}
                                    onClick={() => toggleHiddenWord(word)}
                                    className="bg-red-50 text-red-700 px-2 py-1 rounded-md text-xs flex items-center gap-1 border border-red-100 hover:bg-red-100 transition-colors"
                                    title="Click to restore"
                                >
                                    <EyeSlashIcon className="h-3 w-3" />
                                    {word}
                                </button>
                            ))}
                            {hiddenWords.size === 0 && <span className="text-xs text-gray-400 italic">No words hidden. Right-click words in the cloud to hide them.</span>}
                        </div>
                    </div>

                    {/* 3. Toggles */}
                    <div className="flex items-center justify-between border-t border-gray-100 pt-4">
                        <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer select-none">
                            <input 
                                type="checkbox" 
                                checked={caseSensitive} 
                                onChange={(e) => setCaseSensitive(e.target.checked)}
                                className="rounded text-blue-600 focus:ring-blue-500"
                            />
                            Case Sensitive Counting
                        </label>
                        
                        <button 
                            onClick={() => { setHiddenWords(new Set()); setIgnoredPhrases([]); }} 
                            className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1"
                        >
                            <TrashIcon className="h-3 w-3" /> Reset All
                        </button>
                    </div>

                </div>
            </Dialog.Panel>
          </div>
        </Dialog>
      </Transition>

    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalTabs.tsx
================================================================================
import { PencilSquareIcon, ClockIcon, ChartPieIcon } from '@heroicons/react/24/outline';

interface JournalTabsProps {
  activeTab: 'write' | 'history' | 'insights';
  onChange: (tab: 'write' | 'history' | 'insights') => void;
}

export default function JournalTabs({ activeTab, onChange }: JournalTabsProps) {
  return (
    <div className="flex p-1 space-x-1 bg-blue-100/50 rounded-xl mb-6 overflow-x-auto">
      <button
        onClick={() => onChange('write')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'write'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <PencilSquareIcon className="w-4 h-4" />
        New Entry
      </button>
      <button
        onClick={() => onChange('history')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'history'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ClockIcon className="w-4 h-4" />
        History
      </button>
      <button
        onClick={() => onChange('insights')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'insights'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ChartPieIcon className="w-4 h-4" />
        Insights
      </button>
    </div>
  );
}

================================================================================
FILE: src/components/journal/TemplateEditor.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, addDoc, updateDoc, deleteDoc, doc, query, getDocs, Timestamp } from 'firebase/firestore';
import { 
    ArrowLeftIcon, 
    PlusIcon, 
    TrashIcon, 
    PencilSquareIcon,
    XMarkIcon,
    ListBulletIcon,
    HashtagIcon, 
    CheckCircleIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

// Local Type Definition
interface JournalTemplate {
    id: string;
    uid: string;
    name: string;
    content?: string; 
    prompts?: string[]; // Legacy support
    defaultTags: string[];
    createdAt: any;
}

export default function TemplateEditor() {
    const { user } = useAuth();
    const navigate = useNavigate();
    const [templates, setTemplates] = useState<JournalTemplate[]>([]);
    const [loading, setLoading] = useState(true);

    // Editor State
    const [isEditing, setIsEditing] = useState(false);
    const [editId, setEditId] = useState<string | null>(null);
    const [name, setName] = useState('');
    const [content, setContent] = useState('');
    const [tags, setTags] = useState<string[]>([]);
    const [tagInput, setTagInput] = useState('');
    const [saving, setSaving] = useState(false);

    const textareaRef = useRef<HTMLTextAreaElement>(null);

    useEffect(() => {
        if (!user) return;
        loadTemplates();
        console.log("Template Editor V2 Loaded"); // Debug check
    }, [user]);

    const loadTemplates = async () => {
        if (!user || !db) return;
        setLoading(true);
        try {
            const q = query(collection(db, 'users', user.uid, 'templates'));
            const snapshot = await getDocs(q);
            const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() } as JournalTemplate));
            setTemplates(data);
        } catch (error) {
            console.error("Failed to load templates", error);
        } finally {
            setLoading(false);
        }
    };

    // --- Toolbar Helpers ---
    const insertText = (before: string, after: string = '') => {
        const textarea = textareaRef.current;
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const previousText = textarea.value;
        const selection = previousText.substring(start, end);
        
        const newText = previousText.substring(0, start) + 
                        before + selection + after + 
                        previousText.substring(end);
        
        setContent(newText);
        
        // Reset focus and cursor
        setTimeout(() => {
            textarea.focus();
            const newCursorPos = start + before.length + selection.length + after.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }, 0);
    };

    // --- Tag Helpers ---
    const handleAddTag = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const clean = tagInput.trim().replace(/^#/, '');
            if (clean && !tags.includes(clean)) {
                setTags([...tags, clean]);
                setTagInput('');
            }
        }
    };

    const removeTag = (t: string) => setTags(tags.filter(tag => tag !== t));

    // --- CRUD Operations ---
    const handleEdit = (t: JournalTemplate) => {
        setEditId(t.id);
        setName(t.name);
        // Convert legacy templates to text if needed
        const textContent = t.content || (t.prompts ? t.prompts.map(p => `**${p}**\n\n`).join('') : '');
        setContent(textContent);
        setTags(t.defaultTags || []);
        setIsEditing(true);
    };

    const handleDelete = async (id: string) => {
        if (!confirm("Delete this template?")) return;
        if (!user || !db) return;
        try {
            await deleteDoc(doc(db, 'users', user.uid, 'templates', id));
            setTemplates(templates.filter(t => t.id !== id));
        } catch (e) {
            console.error("Error deleting", e);
        }
    };

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!user || !db) return;
        if (!name.trim()) return alert("Please name your template");

        setSaving(true);
        const templateData = {
            uid: user.uid,
            name,
            content, // Saving as Free Text
            defaultTags: tags,
            updatedAt: Timestamp.now()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, 'users', user.uid, 'templates', editId), templateData);
                setTemplates(prev => prev.map(t => t.id === editId ? { ...t, ...templateData } : t));
            } else {
                const docRef = await addDoc(collection(db, 'users', user.uid, 'templates'), {
                    ...templateData,
                    createdAt: Timestamp.now()
                });
                // Fix: Manually add createdAt to state to match type definition
                setTemplates([...templates, { 
                    id: docRef.id, 
                    ...templateData, 
                    createdAt: Timestamp.now() 
                } as JournalTemplate]);
            }
            setIsEditing(false);
            resetForm();
        } catch (error) {
            console.error("Error saving template", error);
        } finally {
            setSaving(false);
        }
    };

    const resetForm = () => {
        setEditId(null);
        setName('');
        setContent('');
        setTags([]);
    };

    return (
        <div className="max-w-4xl mx-auto p-4 space-y-6">
            
            {/* Header / Nav */}
            <div className="flex items-center gap-4">
                <button onClick={() => navigate('/journal')} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <ArrowLeftIcon className="h-6 w-6 text-gray-600" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">
                    {isEditing ? (editId ? 'Edit Template' : 'New Free-Text Template') : 'My Templates'}
                </h1>
            </div>

            {isEditing ? (
                // --- EDITOR VIEW (Free Text / Markdown) ---
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <form onSubmit={handleSave} className="space-y-6">
                        
                        {/* Name Input */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                            <input 
                                type="text" 
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="e.g. Daily Gratitude List"
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* Content Editor */}
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-sm font-medium text-gray-700">Template Structure</label>
                                <span className="text-xs text-gray-400">Markdown Supported</span>
                            </div>
                            
                            {/* Toolbar */}
                            <div className="flex items-center gap-2 mb-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => insertText('### ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Heading">
                                    <HashtagIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('**', '**')} className="px-2 py-1 text-sm font-bold hover:bg-white hover:shadow-sm rounded text-gray-600" title="Bold">
                                    B
                                </button>
                                <div className="w-px h-4 bg-gray-300 mx-1"></div>
                                <button type="button" onClick={() => insertText('- [ ] ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Checkbox">
                                    <CheckCircleIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('1. ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Ordered List">
                                    <ListBulletIcon className="h-4 w-4" />
                                </button>
                            </div>

                            <textarea 
                                ref={textareaRef}
                                rows={12}
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="Design your template here using Markdown...&#10;- [ ] Checklist item&#10;**Bold text**"
                                className="w-full font-mono text-sm rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 leading-relaxed"
                            />
                        </div>

                        {/* Default Tags */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Auto-Tags</label>
                            <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white">
                                {tags.map(tag => (
                                    <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                                        {tag}
                                        <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                                            <XMarkIcon className="h-3 w-3" />
                                        </button>
                                    </span>
                                ))}
                                <input 
                                    type="text"
                                    value={tagInput}
                                    onChange={(e) => setTagInput(e.target.value)}
                                    onKeyDown={handleAddTag}
                                    placeholder={tags.length === 0 ? "Add tags..." : ""}
                                    className="flex-1 min-w-[100px] text-sm border-none focus:ring-0 p-0 text-gray-700"
                                />
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                            <button 
                                type="button"
                                onClick={() => { setIsEditing(false); resetForm(); }}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit"
                                disabled={saving}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm transition-colors disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Template'}
                            </button>
                        </div>

                    </form>
                </div>
            ) : (
                // --- LIST VIEW ---
                <div className="space-y-4">
                    <button 
                        onClick={() => { resetForm(); setIsEditing(true); }}
                        className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium"
                    >
                        <PlusIcon className="h-5 w-5" />
                        Create New Template
                    </button>

                    {loading ? (
                        <div className="text-center py-8 text-gray-400">Loading templates...</div>
                    ) : templates.length === 0 ? (
                        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-xl">
                            You haven't created any custom templates yet.
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {templates.map(t => (
                                <div key={t.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow group">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-gray-900">{t.name}</h3>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => handleEdit(t)} className="p-1.5 text-gray-400 hover:text-blue-600 rounded">
                                                <PencilSquareIcon className="h-4 w-4" />
                                            </button>
                                            <button onClick={() => handleDelete(t.id)} className="p-1.5 text-gray-400 hover:text-red-600 rounded">
                                                <TrashIcon className="h-4 w-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 line-clamp-2 mb-3 h-8">
                                        {t.content || (t.prompts ? "Structured Form Template" : "Empty Template")}
                                    </p>
                                    <div className="flex gap-2">
                                        {t.defaultTags?.slice(0, 3).map(tag => (
                                            <span key={tag} className="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

================================================================================
FILE: src/components/tasks/TaskFormModal.tsx
================================================================================
// src/components/tasks/TaskFormModal.tsx
import React, { useState, useEffect } from 'react';
import { 
  XMarkIcon, 
  CalendarIcon, 
  ArrowPathIcon 
} from '@heroicons/react/24/outline';
import type { RecurrenceConfig, RecurrenceType } from '../../lib/dateUtils';
import { Timestamp } from 'firebase/firestore';

// Define explicit union types locally to avoid 'any' casting
type CategoryType = 'Recovery' | 'Health' | 'Life' | 'Work';
type PriorityType = 'High' | 'Medium' | 'Low';

export interface TaskFormData {
  id?: string;
  title: string;
  category: CategoryType;
  priority: PriorityType;
  recurrence: RecurrenceConfig;
  dueDate: string; // YYYY-MM-DD format for input
}

// Interface for the raw task data coming in (looser than FormData)
interface IncomingTask {
    id: string;
    title: string;
    category: CategoryType;
    priority: PriorityType;
    dueDate: Timestamp | Date | null;
    recurrence?: RecurrenceConfig;
    frequency?: string; // Legacy support
}

interface TaskFormModalProps {
  isOpen: boolean;
  // FIX: Replaced 'any' with specific type
  initialTask: IncomingTask | null; 
  onClose: () => void;
  onSave: (data: TaskFormData) => Promise<void>;
}

export default function TaskFormModal({ isOpen, initialTask, onClose, onSave }: TaskFormModalProps) {
  const [title, setTitle] = useState('');
  const [category, setCategory] = useState<CategoryType>('Recovery');
  const [priority, setPriority] = useState<PriorityType>('Medium');
  const [dueDate, setDueDate] = useState('');
  const [loading, setLoading] = useState(false);

  // Recurrence State
  const [recurrenceType, setRecurrenceType] = useState<RecurrenceType>('once');
  const [relWeek, setRelWeek] = useState(1); // 1-5 (5=Last)
  const [relDay, setRelDay] = useState(5); // 0-6 (5=Fri)

  // Initialize form when opening
  useEffect(() => {
    if (isOpen) {
        if (initialTask) {
            setTitle(initialTask.title);
            setCategory(initialTask.category);
            setPriority(initialTask.priority);
            
            // Date Handling
            let dateStr = '';
            if (initialTask.dueDate) {
                 const d = initialTask.dueDate instanceof Date 
                    ? initialTask.dueDate 
                    : (initialTask.dueDate as Timestamp).toDate();
                 dateStr = d.toISOString().split('T')[0];
            }
            setDueDate(dateStr);

            // Recurrence Handling
            if (initialTask.recurrence) {
                setRecurrenceType(initialTask.recurrence.type);
                if (initialTask.recurrence.weekOfMonth) setRelWeek(initialTask.recurrence.weekOfMonth);
                if (initialTask.recurrence.dayOfWeek !== undefined) setRelDay(initialTask.recurrence.dayOfWeek);
            } else {
                // Fallback for old data
                setRecurrenceType(
                    (initialTask.frequency === 'once' || !initialTask.frequency) 
                    ? 'once' 
                    : initialTask.frequency as RecurrenceType
                );
            }

        } else {
            // Reset for new task
            setTitle('');
            setCategory('Recovery');
            setPriority('Medium');
            setDueDate(new Date().toISOString().split('T')[0]);
            setRecurrenceType('once');
            setRelWeek(1);
            setRelDay(5);
        }
    }
  }, [isOpen, initialTask]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) return;
    
    setLoading(true);
    try {
        const config: RecurrenceConfig = {
            type: recurrenceType
        };

        if (recurrenceType === 'monthly-relative') {
            config.weekOfMonth = relWeek;
            config.dayOfWeek = relDay;
        }

        await onSave({
            id: initialTask?.id,
            title,
            category,
            priority,
            dueDate,
            recurrence: config
        });
        onClose();
    } catch (error) {
        console.error("Failed to save task", error);
    } finally {
        setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-0 sm:p-4 animate-fadeIn">
        <div className="bg-white w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slideUp sm:animate-fadeIn overflow-y-auto max-h-[90vh]">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-900">
                    {initialTask ? 'Edit Quest' : 'New Quest'}
                </h2>
                <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full">
                    <XMarkIcon className="h-6 w-6 text-gray-400" />
                </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-5">
                
                {/* TITLE */}
                <div>
                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Quest Title</label>
                    <input
                        type="text"
                        placeholder="e.g., Call Sponsor, Gym, Meditate..."
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        className="w-full rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 p-3"
                        autoFocus={!initialTask}
                    />
                </div>

                {/* CATEGORY & PRIORITY */}
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Category</label>
                        <select 
                            value={category}
                            // FIX: Replaced 'any' with specific Union Type cast
                            onChange={(e) => setCategory(e.target.value as CategoryType)}
                            className="w-full rounded-xl border-gray-300 text-sm py-2.5"
                        >
                            <option value="Recovery">Recovery</option>
                            <option value="Health">Health</option>
                            <option value="Life">Life</option>
                            <option value="Work">Work</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Priority</label>
                        <select 
                            value={priority}
                            // FIX: Replaced 'any' with specific Union Type cast
                            onChange={(e) => setPriority(e.target.value as PriorityType)}
                            className="w-full rounded-xl border-gray-300 text-sm py-2.5"
                        >
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>

                {/* RECURRENCE SECTION */}
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                    <div className="flex items-center gap-2 text-gray-800 font-semibold text-sm">
                        <ArrowPathIcon className="h-4 w-4" />
                        Repetition Rules
                    </div>
                    
                    <select 
                        value={recurrenceType}
                        onChange={(e) => setRecurrenceType(e.target.value as RecurrenceType)}
                        className="w-full rounded-lg border-gray-300 text-sm"
                    >
                        <option value="once">One-time Quest</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-Weekly (Every 2 weeks)</option>
                        <option value="monthly">Monthly (Same date)</option>
                        <option value="monthly-relative">Monthly (Relative day)</option>
                    </select>

                    {/* Conditional: Monthly Relative Options */}
                    {recurrenceType === 'monthly-relative' && (
                        <div className="flex gap-2 animate-fadeIn">
                             <select 
                                value={relWeek} 
                                onChange={(e) => setRelWeek(Number(e.target.value))}
                                className="flex-1 rounded-lg border-gray-300 text-sm"
                             >
                                <option value={1}>1st</option>
                                <option value={2}>2nd</option>
                                <option value={3}>3rd</option>
                                <option value={4}>4th</option>
                                <option value={5}>Last</option>
                             </select>
                             <select 
                                value={relDay} 
                                onChange={(e) => setRelDay(Number(e.target.value))}
                                className="flex-1 rounded-lg border-gray-300 text-sm"
                             >
                                <option value={0}>Sunday</option>
                                <option value={1}>Monday</option>
                                <option value={2}>Tuesday</option>
                                <option value={3}>Wednesday</option>
                                <option value={4}>Thursday</option>
                                <option value={5}>Friday</option>
                                <option value={6}>Saturday</option>
                             </select>
                             <span className="self-center text-sm text-gray-500">of month</span>
                        </div>
                    )}
                </div>

                {/* DUE DATE */}
                <div>
                     <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Due Date</label>
                     <div className="relative">
                        <CalendarIcon className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                        <input 
                            type="date" 
                            value={dueDate}
                            onChange={(e) => setDueDate(e.target.value)}
                            className="w-full pl-10 rounded-xl border-gray-300 text-sm py-2.5" 
                        />
                     </div>
                </div>

                <button
                    type="submit"
                    disabled={!title.trim() || loading}
                    className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md mt-4 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {loading ? 'Saving...' : initialTask ? 'Update Quest' : 'Accept Quest'}
                </button>
            </form>
        </div>
    </div>
  );
}

================================================================================
FILE: src/contexts/AuthContext.tsx
================================================================================
import { createContext, useContext, useEffect, useState } from 'react';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  type User // FIX 1: Type-only import
} from 'firebase/auth';
import { auth } from '../lib/firebase';
import { getOrCreateUserProfile } from '../lib/db';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  loginWithGoogle: () => Promise<void>;
  signupWithEmail: (email: string, pass: string) => Promise<void>;
  loginWithEmail: (email: string, pass: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // FIX 2: Guard clause - if auth failed to initialize, stop here
    if (!auth) {
      console.error("Firebase Auth not initialized");
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      try {
        if (currentUser) {
          await getOrCreateUserProfile(currentUser);
          setUser(currentUser);
        } else {
          setUser(null);
        }
      } catch (error) {
        console.error("Error fetching user profile:", error);
        setUser(currentUser); 
      } finally {
        setLoading(false);
      }
    });

    return unsubscribe;
  }, []);

  const loginWithGoogle = async () => {
    if (!auth) throw new Error("Auth not initialized");
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, provider);
  };

  const signupWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    const result = await createUserWithEmailAndPassword(auth, email, pass);
    await getOrCreateUserProfile(result.user);
  };

  const loginWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    await signInWithEmailAndPassword(auth, email, pass);
  };

  const logout = async () => {
    if (!auth) return;
    await signOut(auth);
  };

  const value = {
    user,
    loading,
    loginWithGoogle,
    signupWithEmail,
    loginWithEmail,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

================================================================================
FILE: src/contexts/EncryptionContext.tsx
================================================================================
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { useAuth } from './AuthContext';
import { db } from '../lib/firebase';
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { generateSalt, deriveKeyFromPin, encryptData, decryptData } from '../lib/crypto';

interface EncryptionContextType {
  isVaultSet: boolean;       // Does the user have a PIN setup?
  isVaultUnlocked: boolean;  // Is the PIN currently entered?
  vaultLoading: boolean;
  unlockVault: (pin: string) => Promise<boolean>;
  setupVault: (pin: string) => Promise<void>;
  encrypt: (text: string) => Promise<string>;
  decrypt: (encryptedText: string) => Promise<string>;
  lockVault: () => void;
}

const EncryptionContext = createContext<EncryptionContextType | undefined>(undefined);

// FIX: validation error "Fast refresh only works when a file only exports components"
// This pattern is standard for Contexts, so we disable the warning for this line.
// eslint-disable-next-line react-refresh/only-export-components
export function useEncryption() {
  const context = useContext(EncryptionContext);
  if (context === undefined) {
    throw new Error('useEncryption must be used within an EncryptionProvider');
  }
  return context;
}

export function EncryptionProvider({ children }: { children: React.ReactNode }) {
  const { user } = useAuth();
  
  const [isVaultSet, setIsVaultSet] = useState(false);
  const [isVaultUnlocked, setIsVaultUnlocked] = useState(false);
  const [vaultLoading, setVaultLoading] = useState(true);
  const [cryptoKey, setCryptoKey] = useState<CryptoKey | null>(null);
  const [salt, setSalt] = useState<string | null>(null);

  // 1. Check if user has a vault set up (fetch salt)
  useEffect(() => {
    async function checkVaultStatus() {
      // Check if db is initialized
      if (!user || !db) {
        setVaultLoading(false);
        return;
      }
      
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists() && userDoc.data().encryptionSalt) {
          setIsVaultSet(true);
          setSalt(userDoc.data().encryptionSalt);
        } else {
          setIsVaultSet(false);
        }
      } catch (error) {
        console.error("Error checking vault status:", error);
      } finally {
        setVaultLoading(false);
      }
    }

    checkVaultStatus();
  }, [user]);

  // 2. Setup Vault (First time PIN creation)
  const setupVault = async (pin: string) => {
    // Check if db is initialized
    if (!user || !db) return;
    
    try {
      setVaultLoading(true);
      const newSalt = generateSalt();
      const key = await deriveKeyFromPin(pin, newSalt);
      
      // Save Salt to Firestore
      const userDocRef = doc(db, 'users', user.uid);
      await setDoc(userDocRef, { encryptionSalt: newSalt }, { merge: true });

      setSalt(newSalt);
      setCryptoKey(key); // Keep key in memory
      setIsVaultSet(true);
      setIsVaultUnlocked(true);
    } catch (error) {
      console.error("Vault setup failed:", error);
      throw error;
    } finally {
      setVaultLoading(false);
    }
  };

  // 3. Unlock Vault (Enter PIN)
  const unlockVault = async (pin: string): Promise<boolean> => {
    if (!salt) return false;
    try {
      const key = await deriveKeyFromPin(pin, salt);
      setCryptoKey(key);
      setIsVaultUnlocked(true);
      return true;
    } catch (error) {
      console.error("Unlock failed", error);
      return false;
    }
  };

  const lockVault = () => {
    setCryptoKey(null);
    setIsVaultUnlocked(false);
  };

  // 4. Helper Wrappers
  const encrypt = useCallback(async (text: string) => {
    if (!cryptoKey) throw new Error("Vault is locked");
    return await encryptData(text, cryptoKey);
  }, [cryptoKey]);

  const decrypt = useCallback(async (text: string) => {
    if (!cryptoKey) throw new Error("Vault is locked");
    return await decryptData(text, cryptoKey);
  }, [cryptoKey]);

  const value = {
    isVaultSet,
    isVaultUnlocked,
    vaultLoading,
    unlockVault,
    setupVault,
    encrypt,
    decrypt,
    lockVault
  };

  return (
    <EncryptionContext.Provider value={value}>
      {children}
    </EncryptionContext.Provider>
  );
}

================================================================================
FILE: src/data/workbooks.ts
================================================================================
// src/data/workbooks.ts

export interface Question {
  id: string;
  text: string;
  context?: string; // Optional context/quote from literature (The Insight)
  type?: 'input' | 'read_only'; // Defaults to 'input' if undefined
}

export interface WorkbookSection {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  type: 'linear' | 'steps' | 'general';
  sections: WorkbookSection[];
}

// Helper to generate generic questions for sections we don't fully populate in this snippet
//const generateQuestions = (count: number, prefix: string): Question[] => {
//  return Array.from({ length: count }).map((_, i) => ({
//    id: `${prefix}_q${i + 1}`,
//    text: `Question ${i + 1}: Reflection point regarding ${prefix.replace(/_/g, ' ')}.`,
//    type: 'input'
//  }));
//};

// --- 1. GENERAL RECOVERY WORKBOOK (25 Questions) ---
const generalQuestions: Question[] = [
  { id: 'gen_1', text: "What are the specific consequences of your addiction that led you to seek recovery?" },
  { id: 'gen_2', text: "Describe a time when you tried to control your using but failed." },
  { id: 'gen_3', text: "How has your addiction affected your relationships with family and friends?" },
  { id: 'gen_4', text: "What emotions trigger your desire to use?" },
  { id: 'gen_5', text: "List 5 things you are grateful for today." },
  { id: 'gen_6', text: "What does 'rock bottom' mean to you, and do you feel you hit it?" },
  { id: 'gen_7', text: "How does honesty play a role in your recovery?" },
  { id: 'gen_8', text: "What are your biggest fears about living sober?" },
  { id: 'gen_9', text: "Who are the people in your support network?" },
  { id: 'gen_10', text: "What hobbies or activities did you neglect during active addiction?" },
  { id: 'gen_11', text: "Describe your physical health during active addiction versus now." },
  { id: 'gen_12', text: "What lies did you tell yourself to justify your using?" },
  { id: 'gen_13', text: "How has your addiction impacted your career or education?" },
  { id: 'gen_14', text: "What specific boundaries do you need to set to protect your sobriety?" },
  { id: 'gen_15', text: "How do you handle stress without substances?" },
  { id: 'gen_16', text: "What does a 'spiritual awakening' mean to you?" },
  { id: 'gen_17', text: "List 3 short-term goals for your recovery." },
  { id: 'gen_18', text: "List 3 long-term goals for your life." },
  { id: 'gen_19', text: "How can you be of service to others?" },
  { id: 'gen_20', text: "What resentments are you holding onto, and how do they affect you?" },
  { id: 'gen_21', text: "Describe a situation where you successfully navigated a craving." },
  { id: 'gen_22', text: "What does 'taking it one day at a time' look like in practice?" },
  { id: 'gen_23', text: "How do you practice self-care?" },
  { id: 'gen_24', text: "What advice would you give to your past self?" },
  { id: 'gen_25', text: "Why is recovery worth it for you?" },
];

// --- 2. 12-STEP WORKBOOK (Unified Steps Approach) ---

// Helper to build the 16-slide structure for Steps 2-11 (Standardized Template)
const createStepStructure = (
  stepNum: number,
  introText: string,
  insight1: string,
  insight2: string,
  insight3: string
): Question[] => {
  const q: Question[] = [];
  
  // 1. Intro Slide
  q.push({
    id: `s${stepNum}_intro`,
    type: 'read_only',
    text: introText
  });

  // 2. Section 1 (5 Qs)
  for (let i = 1; i <= 5; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: How does the concept of this section apply to your life today?`,
      context: insight1
    });
  }

  // 3. Section 2 (5 Qs)
  for (let i = 6; i <= 10; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: What barriers do you face regarding this principle?`,
      context: insight2
    });
  }

  // 4. Section 3 (5 Qs)
  for (let i = 11; i <= 15; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: How can you put this into practice immediately?`,
      context: insight3
    });
  }

  return q;
};

// -- STEP 1 (Fully Populated from User Doc) --
const step1Questions: Question[] = [
  // Intro
  {
    id: 's1_intro',
    type: 'read_only',
    text: `Step 1: "We admitted we were powerless over our addiction‚Äîthat our lives had become unmanageable."\n\nIntroduction:\nStep 1 is the foundation of recovery. It is about surrendering the illusion of control. It asks us to honestly admit that our best thinking has failed us and that our compulsive behaviors have consequences we can no longer manage alone.`
  },
  // Section 1: The Nature of Powerlessness
  { id: 's1_q1', type: 'input', text: "Can you describe a specific time when you sincerely tried to stop or control your behavior but failed?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q2', type: 'input', text: "How does the obsession manifest in your mind before you even take the first action/drink/drug?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q3', type: 'input', text: "In what ways have you tried to bargain with your addiction (e.g., \"I'll only do it on weekends\")?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q4', type: 'input', text: "Do you feel a physical or mental shift when you engage in your addictive behavior that makes it hard to stop?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q5', type: 'input', text: "What does the word \"defeat\" mean to you in the context of your recovery?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  
  // Section 2: Unmanageability in Daily Life
  { id: 's1_q6', type: 'input', text: "How has your addiction affected your financial stability or career/school performance?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q7', type: 'input', text: "Have you missed important events or obligations due to using or recovering from using?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q8', type: 'input', text: "In what ways has your home life or living environment become chaotic?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q9', type: 'input', text: "How do you manage your emotions when things don't go your way? Is it manageable?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q10', type: 'input', text: "Do you feel like you are driving the car of your life, or are you a passenger in a runaway vehicle?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },

  // Section 3: The Emotional Toll
  { id: 's1_q11', type: 'input', text: "How has isolation played a role in your addiction?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q12', type: 'input', text: "What relationships have been damaged or lost because of your behavior?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q13', type: 'input', text: "Do you struggle with self-worth or self-esteem? How does using affect that?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q14', type: 'input', text: "What lies do you tell yourself to justify the pain you are in?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q15', type: 'input', text: "Are you ready to let go of the control you never really had?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
];

// -- STEPS 2-11 (Generated Structure - Ready for Text Content) --
const step2Questions = createStepStructure(2, "Step 2: Came to believe that a Power greater than ourselves could restore us to sanity.", "Sanity vs Insanity in addiction.", "Defining a Higher Power.", "The process of coming to believe.");
const step3Questions = createStepStructure(3, "Step 3: Made a decision to turn our will and our lives over to the care of God as we understood Him.", "The decision vs the action.", "Letting go of self-will.", "Moving from fear to faith.");
const step4Questions = createStepStructure(4, "Step 4: Made a searching and fearless moral inventory of ourselves.", "The purpose of inventory.", "Resentments and fears.", "Assets and liabilities.");
const step5Questions = createStepStructure(5, "Step 5: Admitted to God, to ourselves, and to another human being the exact nature of our wrongs.", "The value of confession.", "Overcoming shame.", "Building trust.");
const step6Questions = createStepStructure(6, "Step 6: Were entirely ready to have God remove all these defects of character.", "The difference between Step 6 and 7.", "Becoming ready.", "Letting go of old survival mechanisms.");
const step7Questions = createStepStructure(7, "Step 7: Humbly asked Him to remove our shortcomings.", "Defining humility.", "The practice of asking.", "Changing our behavior.");
const step8Questions = createStepStructure(8, "Step 8: Made a list of all persons we had harmed, and became willing to make amends to them all.", "Identifying harm done.", "Willingness vs action.", "Forgiveness of self and others.");
const step9Questions = createStepStructure(9, "Step 9: Made direct amends to such people wherever possible, except when to do so would injure them or others.", "Direct amends vs apologies.", "Living amends.", "Cleaning up the wreckage.");
const step10Questions = createStepStructure(10, "Step 10: Continued to take personal inventory and when we were wrong promptly admitted it.", "Daily inventory practice.", "Spot-check inventory.", "Keeping the side of the street clean.");
const step11Questions = createStepStructure(11, "Step 11: Sought through prayer and meditation to improve our conscious contact with God...", "Prayer (talking) vs Meditation (listening).", "Seeking knowledge of His will.", "The power to carry that out.");

// -- STEP 12 (Fully Populated from User Doc) --
const step12Questions: Question[] = [
  // Intro
  {
    id: 's12_intro',
    type: 'read_only',
    text: `Step 12: "Having had a spiritual awakening as the result of these steps, we tried to carry this message to addicts, and to practice these principles in all our affairs."\n\nIntroduction:\nStep 12 is the culmination of the program. It is about service, gratitude, and consistency. It asks us to take what we have been given‚Äîfreedom‚Äîand share it with others, while living a life of integrity in all areas, not just recovery meetings.`
  },
  // Section 1: The Spiritual Awakening
  { id: 's12_q1', type: 'input', text: "How would you describe your spiritual awakening?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q2', type: 'input', text: "How are you different now compared to when you started Step 1?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q3', type: 'input', text: "What does \"emotional sobriety\" mean to you now?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q4', type: 'input', text: "Do you feel a sense of purpose that was missing before?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q5', type: 'input', text: "How do you define your spirituality today?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },

  // Section 2: Carrying the Message
  { id: 's12_q6', type: 'input', text: "How can you be of service to others in recovery?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q7', type: 'input', text: "What is the difference between \"attraction\" and \"promotion\"?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q8', type: 'input', text: "How do you handle it when someone you are trying to help doesn't want help?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q9', type: 'input', text: "Why is working with others essential for your own sobriety?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q10', type: 'input', text: "What is the \"message\" you are trying to carry?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },

  // Section 3: Practicing Principles in All Affairs
  { id: 's12_q11', type: 'input', text: "How do you apply the steps in your workplace or school?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q12', type: 'input', text: "How do you practice these principles in your romantic relationships?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q13', type: 'input', text: "What does it mean to be a \"good citizen\" in the context of Step 12?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q14', type: 'input', text: "How do you handle success or failure using spiritual principles?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q15', type: 'input', text: "Are you ready to continue this way of life, one day at a time?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
];

const twelveStepSections: WorkbookSection[] = [
  { id: 'step_1', title: 'Step 1', description: 'Powerlessness & Unmanageability', questions: step1Questions },
  { id: 'step_2', title: 'Step 2', description: 'Came to believe', questions: step2Questions },
  { id: 'step_3', title: 'Step 3', description: 'Turning it over', questions: step3Questions },
  { id: 'step_4', title: 'Step 4', description: 'Moral inventory', questions: step4Questions },
  { id: 'step_5', title: 'Step 5', description: 'Admitting our wrongs', questions: step5Questions },
  { id: 'step_6', title: 'Step 6', description: 'Entirely ready', questions: step6Questions },
  { id: 'step_7', title: 'Step 7', description: 'Humbly asked Him', questions: step7Questions },
  { id: 'step_8', title: 'Step 8', description: 'List of harms', questions: step8Questions },
  { id: 'step_9', title: 'Step 9', description: 'Making amends', questions: step9Questions },
  { id: 'step_10', title: 'Step 10', description: 'Personal inventory', questions: step10Questions },
  { id: 'step_11', title: 'Step 11', description: 'Conscious contact', questions: step11Questions },
  { id: 'step_12', title: 'Step 12', description: 'Spiritual awakening', questions: step12Questions },
];

// --- 3. RECOVERY DHARMA WORKBOOK (The Four Noble Truths) ---

// 1. First Noble Truth
const dharmaTruth1: Question[] = [
  { 
    id: 'rd_t1_intro', 
    type: 'read_only', 
    text: `The First Noble Truth is not a pessimistic claim that "life is miserable." rather, it is a realistic assessment that dissatisfaction, stress, and pain are part of the human experience.\n\nIn the context of addiction, this truth is the acknowledgment of our struggle. It is the realization that our compulsive behaviors‚Äîwhether to substances, people, or processes‚Äîhave become a source of suffering rather than a solution to it.\n\nWe admit that despite our best efforts to control it, the cycle has become unmanageable and painful.` 
  },
  { 
    id: 'rd_t1_q1', 
    type: 'input',
    text: "In what specific ways has my main coping mechanism (my addiction) stopped working for me?", 
    context: "We acknowledge that the things we used to cope with our pain have turned on us. What once provided relief now creates more suffering." 
  },
  { 
    id: 'rd_t1_q2', 
    type: 'input',
    text: "Can I identify the difference between 'pain' (the inevitable events of life) and 'suffering' (my reaction and resistance to those events)?", 
    context: "Pain is inevitable; suffering is optional. We suffer when we cling to how we want things to be, rather than accepting how they are." 
  },
  { 
    id: 'rd_t1_q3', 
    type: 'input',
    text: "Where in my body do I feel the physical sensation of 'unsatisfactoriness' or restlessness when I am not using/acting out?", 
    context: "Mindfulness begins with the body. The First Truth asks us to turn toward the discomfort we have been running from, rather than away from it." 
  },
  { 
    id: 'rd_t1_q4', 
    type: 'input',
    text: "How has my refusal to accept the reality of my situation prolonged my cycle of addiction?", 
    context: "Denial is a form of protection, but eventually, it becomes a prison. Acceptance is the first step toward unlocking the door." 
  },
  { 
    id: 'rd_t1_q5', 
    type: 'input',
    text: "Looking back, can I see how my 'solution' eventually became the primary problem in my life?", 
    context: "We realize that we have been trying to fill a spiritual void with material things, substances, or validation, and it simply does not work." 
  }
];

// 2. Second Noble Truth
const dharmaTruth2: Question[] = [
  { 
    id: 'rd_t2_intro', 
    type: 'read_only', 
    text: `The Second Truth teaches us that the root cause of our suffering is craving (thirst) and clinging.\n\nIt isn't just the drugs, the alcohol, or the behavior that is the problem; it is the underlying drive to fix the way we feel instantly. It is the deep-seated belief that "this moment is not enough" and that we need something external to make us whole.\n\nWe suffer because we cling to pleasure and push away pain, creating a constant tug-of-war in our minds.` 
  },
  { 
    id: 'rd_t2_q1', 
    type: 'input',
    text: "What is the specific feeling or emotion I am usually trying to escape when the craving arises?", 
    context: "Craving often arises as a response to an underlying discomfort‚Äîloneliness, fear, boredom, or shame. We use addiction to numb these feelings." 
  },
  { 
    id: 'rd_t2_q2', 
    type: 'input',
    text: "Can I identify a time recently when I clung to a pleasant experience so tightly that I ruined it when it naturally ended?", 
    context: "Impermanence is a law of nature. Suffering arises when we demand that temporary pleasure lasts forever." 
  },
  { 
    id: 'rd_t2_q3', 
    type: 'input',
    text: "What \"stories\" does my mind tell me about what will happen if I don't give in to the craving?", 
    context: "The mind creates catastrophic narratives to justify acting on impulse. We learn to observe these thoughts without believing them." 
  },
  { 
    id: 'rd_t2_q4', 
    type: 'input',
    text: "How does my attachment to a specific identity (e.g., 'the victim,' 'the addict,' 'the tough one') keep me stuck in old patterns?", 
    context: "We often cling to our suffering because it is familiar. Letting go of who we think we are allows us to become who we can be." 
  },
  { 
    id: 'rd_t2_q5', 
    type: 'input',
    text: "In what ways do I demand that the world conform to my expectations, and how does that lead to anger or resentment?", 
    context: "Expectations are resentments waiting to happen. When we stop fighting reality, the craving to escape reality diminishes." 
  }
];

// 3. Third Noble Truth
const dharmaTruth3: Question[] = [
  { 
    id: 'rd_t3_intro', 
    type: 'read_only', 
    text: `The Third Truth is the good news: Recovery is possible.\n\nSuffering is not permanent, and because it has a cause (craving), it can end. This is the truth of Cessation. It doesn‚Äôt mean we will never feel pain again, but it means we don't have to be enslaved by our reactions to it.\n\nWe can find a freedom that isn't dependent on external circumstances. We can experience peace right now, even in the midst of difficulty, by letting go of the demand for things to be different.` 
  },
  { 
    id: 'rd_t3_q1', 
    type: 'input',
    text: "Can I recall a moment in my recovery (or life) where I felt a sense of peace without needing to change anything?", 
    context: "Freedom is available in any moment where we stop fighting. This is the glimpse of Nirvana‚Äîthe cooling of the flames of desire." 
  },
  { 
    id: 'rd_t3_q2', 
    type: 'input',
    text: "What would my life look like if I believed, truly, that I am already 'whole' and don't need to be 'fixed'?", 
    context: "Our true nature is wise and compassionate. Recovery is not about building a new you, but uncovering the you that was there all along." 
  },
  { 
    id: 'rd_t3_q3', 
    type: 'input',
    text: "If I let go of the need to control the outcome of my current situation, what specific burden would be lifted off my shoulders?", 
    context: "Surrender is not giving up; it is giving over. We let go of the illusion of control and find safety in the present moment." 
  },
  { 
    id: 'rd_t3_q4', 
    type: 'input',
    text: "How does the idea of 'impermanence' give me hope regarding my current struggles or cravings?", 
    context: "This too shall pass. Knowing that cravings are like weather‚Äîstorms that come and go‚Äîhelps us ride them out without drowning." 
  },
  { 
    id: 'rd_t3_q5', 
    type: 'input',
    text: "Who in my life (or in my Sangha/community) represents the possibility of freedom to me, and what qualities do they embody?", 
    context: "We take refuge in the Sangha. Seeing the recovery of others proves that the Third Noble Truth is a reality, not just a theory." 
  }
];

// 4. Fourth Noble Truth
const dharmaTruth4: Question[] = [
  { 
    id: 'rd_t4_intro', 
    type: 'read_only', 
    text: `The Fourth Truth is the Eightfold Path‚Äîthe practical "how-to" guide for recovery.\n\nIt is a set of practices that helps us live ethically, train our minds, and cultivate wisdom. It covers Wisdom (Right View, Intention), Ethics (Right Speech, Action, Livelihood), and Meditation (Right Effort, Mindfulness, Concentration).\n\nThis is not a linear set of steps but a wheel of practice where each part supports the others. It is the daily discipline of recovery.` 
  },
  { 
    id: 'rd_t4_q1', 
    type: 'input',
    text: "Right Intention: Am I approaching my recovery today with an intention of kindness toward myself, or am I being harsh and critical?", 
    context: "Renunciation is not about punishment; it is an act of love. We let go of harmful behaviors because we care about our own well-being." 
  },
  { 
    id: 'rd_t4_q2', 
    type: 'input',
    text: "Right Speech: How have I used my words (to others or myself) to cause harm recently, and how can I practice honesty without cruelty?", 
    context: "Truthfulness is the foundation of trust. We cannot recover while hiding behind lies, but our truth must be spoken with compassion." 
  },
  { 
    id: 'rd_t4_q3', 
    type: 'input',
    text: "Right Action: What is one small, ethical action I can take today that aligns with the person I want to become?", 
    context: "Recovery is lived in the small moments. Every time we choose not to harm, we are strengthening our path to freedom." 
  },
  { 
    id: 'rd_t4_q4', 
    type: 'input',
    text: "Right Mindfulness: specific situations trigger me to go on 'autopilot,' and how can I bring more awareness to those moments?", 
    context: "Mindfulness is the pause between the trigger and the reaction. In that pause lies our freedom to choose a different response." 
  },
  { 
    id: 'rd_t4_q5', 
    type: 'input',
    text: "Right Effort: Am I striving too hard (restlessness) or not hard enough (complacency)? How can I find the 'Middle Way' in my recovery today?", 
    context: "The Middle Way is the path of balance. We avoid the extremes of indulgence and severe asceticism. We practice with gentle persistence." 
  }
];

// -- The Eightfold Path --

const eightfoldPart1: Question[] = [
  // 1. Right View
  { 
    id: 'rd_path_right_view_intro', 
    type: 'read_only', 
    text: `1. Right View (Understanding)\n\nRight View is the beginning of the path. In recovery, it means understanding the law of Karma (Cause and Effect). It is the deep realization that our actions have consequences.\n\nIt is accepting that unskillful actions (addiction) lead to suffering, and skillful actions (recovery) lead to freedom. It is seeing things as they truly are‚Äîimpermanent and interconnected‚Äîrather than how our addiction wants us to see them.` 
  },
  {
    id: 'rd_path_q1',
    type: 'input',
    text: "Do I truly accept that I am the owner of my actions and their consequences, without blaming others or my circumstances?",
    context: "We stop looking for a scapegoat. When we realize that our choices shape our reality, we reclaim the power to change that reality."
  },
  {
    id: 'rd_path_q2',
    type: 'input',
    text: "Can I see the cycle of 'cause and effect' in my last relapse or emotional outburst? What specific belief led to that action?",
    context: "Ignorance is the root of suffering. When we see the link between our beliefs and our pain, we can begin to break the chain."
  },
  {
    id: 'rd_path_q3',
    type: 'input',
    text: "How does viewing my thoughts as 'impermanent weather' change the way I react to a strong craving?",
    context: "Right View teaches us that no feeling is final. We don't have to obey a command that will disappear in ten minutes."
  },
  // 2. Right Intention
  { 
    id: 'rd_path_right_intention_intro', 
    type: 'read_only', 
    text: `2. Right Intention (Wise Resolve)\n\nIf Right View is the map, Right Intention is the steering wheel. It involves three specific resolves: Renunciation (letting go of craving), Good Will (loving-kindness), and Harmlessness (compassion).\n\nIt is the commitment to move away from cruelty and toward kindness, for ourselves and others.` 
  },
  {
    id: 'rd_path_q4',
    type: 'input',
    text: "Am I viewing 'renunciation' (giving up my addiction) as a punishment, or as a liberating gift I am giving myself?",
    context: "Renunciation is not deprivation. It is the joyous letting go of a heavy burden we have been carrying for too long."
  },
  {
    id: 'rd_path_q5',
    type: 'input',
    text: "In what situation today can I replace a thought of judgment (ill will) with a thought of understanding (good will)?",
    context: "We cannot hate ourselves into recovery. Intention shifts our internal dialogue from a prosecutor to a gentle guide."
  },
  {
    id: 'rd_path_q6',
    type: 'input',
    text: "How can I practice 'harmlessness' toward my own body today, considering the damage I may have done in the past?",
    context: "Compassion starts at home. Treating our bodies with respect is a direct act of defiance against the self-destruction of addiction."
  }
];

const eightfoldPart2: Question[] = [
  // 3. Right Speech
  { 
    id: 'rd_path_right_speech_intro', 
    type: 'read_only', 
    text: `3. Right Speech\n\nWords have power. Right Speech means abstaining from lying, divisive speech (gossip/talking behind backs), harsh/abusive speech, and idle chatter (mindless talking to avoid feelings).\n\nIn recovery, this is synonymous with "getting honest." We stop hiding behind deceptions and learn to speak our truth with care.` 
  },
  {
    id: 'rd_path_q7',
    type: 'input',
    text: "Is there a specific lie or half-truth I am currently protecting? What fear creates the need for this lie?",
    context: "Secrets keep us sick. Rigorous honesty is the antidote to the isolation of addiction."
  },
  {
    id: 'rd_path_q8',
    type: 'input',
    text: "How do you speak to myself? Is my internal monologue harsh and abusive? How can I apply Right Speech internally?",
    context: "If we spoke to our friends the way we speak to ourselves, we would have no friends. Mindfulness catches the inner critic in the act."
  },
  {
    id: 'rd_path_q9',
    type: 'input',
    text: "Can I practice 'noble silence' today‚Äîlistening more than I speak‚Äîto avoid the trap of idle chatter or gossip?",
    context: "Silence allows us to hear the truth. Sometimes the most skillful thing to say is nothing at all."
  },
  // 4. Right Action
  { 
    id: 'rd_path_right_action_intro', 
    type: 'read_only', 
    text: `4. Right Action\n\nThis factor corresponds to the Five Precepts: refraining from killing/harming, stealing, sexual misconduct, lying, and intoxication. Right Action is about living in a way that does not cause regret.\n\nIt creates a foundation of safety and trust in our lives.` 
  },
  {
    id: 'rd_path_q10',
    type: 'input',
    text: "Looking at the precept of 'not taking what is not given' (stealing), are there subtle ways I take things (time, energy, credit) from others?",
    context: "Generosity is the practice of letting go. We counter the taker mentality of addiction by asking, 'What can I give?'"
  },
  {
    id: 'rd_path_q11',
    type: 'input',
    text: "Regarding sexual misconduct/harm: Am I using relationships or sex to numb out, seek validation, or manipulate, rather than to connect?",
    context: "Intimacy requires presence. We learn to connect with others authentically, rather than using them as objects to fix our loneliness."
  },
  {
    id: 'rd_path_q12',
    type: 'input',
    text: "What is one ethical boundary I need to set today to protect my sobriety (e.g., not going to a certain place, not seeing a certain person)?",
    context: "Right Action is proactive. We don't just resist temptation; we build a life where temptation has no foothold."
  },
  // 5. Right Livelihood
  { 
    id: 'rd_path_right_livelihood_intro', 
    type: 'read_only', 
    text: `5. Right Livelihood\n\nWe spend a vast amount of our lives working. Right Livelihood asks us to earn our living in a way that doesn't violate our ethical principles or cause harm to others.\n\nIn a broader sense, it asks if our daily "hustle" supports our recovery or hinders it.` 
  },
  {
    id: 'rd_path_q13',
    type: 'input',
    text: "Does my current job or way of making money require me to compromise my integrity or values?",
    context: "Peace of mind is more valuable than a paycheck. We cannot maintain spiritual balance if we spend 40 hours a week violating our conscience."
  },
  {
    id: 'rd_path_q14',
    type: 'input',
    text: "How can I bring the spirit of service into my daily work, regardless of what my job title is?",
    context: "Every task can be a practice. When we work with mindfulness and care, our labor becomes an offering rather than a burden."
  },
  {
    id: 'rd_path_q15',
    type: 'input',
    text: "Am I using work as a new addiction (workaholism) to avoid facing other areas of my life?",
    context: "Balance is key. Right Livelihood supports life; it does not consume it."
  }
];

const eightfoldPart3: Question[] = [
  // 6. Right Effort
  { 
    id: 'rd_path_right_effort_intro', 
    type: 'read_only', 
    text: `6. Right Effort\n\nRight Effort is not about "white-knuckling" it. It is the balanced energy we apply to the practice.\n\nIt consists of four great efforts: (1) Preventing unwholesome states (cravings) from arising, (2) Abandoning unwholesome states that have arisen, (3) Cultivating wholesome states (joy, gratitude), and (4) Maintaining those wholesome states.` 
  },
  {
    id: 'rd_path_q16',
    type: 'input',
    text: "Am I trying too hard (perfectionism) or not hard enough (complacency)? Where is the 'Middle Way' for me right now?",
    context: "We tune the strings of our instrument not too tight, not too loose. Consistency beats intensity."
  },
  {
    id: 'rd_path_q17',
    type: 'input',
    text: "When a negative state arises (anger/fear), do I feed it with more thought, or do I apply the effort to let it go?",
    context: "What we water grows. Right Effort is the choice to stop watering the weeds and start watering the flowers."
  },
  {
    id: 'rd_path_q18',
    type: 'input',
    text: "What is one positive quality (e.g., patience, generosity) I want to actively cultivate and strengthen this week?",
    context: "Recovery is not just removing the bad; it is actively building the good. We fill the void with light."
  },
  // 7. Right Mindfulness
  { 
    id: 'rd_path_right_mindfulness_intro', 
    type: 'read_only', 
    text: `7. Right Mindfulness\n\nMindfulness is the core of the practice. It is the ability to see clearly what is happening right now.\n\nIt is the "Four Foundations of Mindfulness": Awareness of the body, feelings (pleasant/unpleasant/neutral), mind states (emotions), and phenomena (reality). It prevents us from living on autopilot.` 
  },
  {
    id: 'rd_path_q19',
    type: 'input',
    text: "Can I detect the physical warning signs of a resentment or craving before it becomes a mental obsession?",
    context: "The body always knows first. Mindfulness allows us to catch the spark before it becomes a forest fire."
  },
  {
    id: 'rd_path_q20',
    type: 'input',
    text: "Am I able to observe an uncomfortable emotion (like anxiety) without judging it as 'bad' or trying to fix it immediately?",
    context: "This is the practice of 'being with.' We learn to surf the waves of emotion rather than drowning in them."
  },
  {
    id: 'rd_path_q21',
    type: 'input',
    text: "How often during the day do I actually 'arrive' in the present moment, rather than living in the past or future?",
    context: "Life only happens now. When we are present, we are safe, because in this exact second, we are okay."
  },
  // 8. Right Concentration
  { 
    id: 'rd_path_right_concentration_intro', 
    type: 'read_only', 
    text: `8. Right Concentration\n\nWhile Mindfulness is broad awareness, Concentration is focused awareness. It is the ability to rest the mind on a single object (like the breath or a mantra).\n\nThis steadiness brings a deep sense of calm and joy, giving us a sanctuary from the chaos of the addicted mind.` 
  },
  {
    id: 'rd_path_q22',
    type: 'input',
    text: "When I sit to meditate, can I treat my wandering mind with gentleness, simply returning to the breath without self-criticism?",
    context: "The 'return' is the practice. Every time we realize we drifted and come back, we are strengthening the muscle of concentration."
  },
  {
    id: 'rd_path_q23',
    type: 'input',
    text: "How does the ability to focus on one thing help me when I am overwhelmed by life's problems?",
    context: "A scattered mind is a stressed mind. Concentration gathers our energy so we can face difficulties with stability."
  },
  {
    id: 'rd_path_q24',
    type: 'input',
    text: "Do I use distractions (phone, TV, food) to prevent myself from ever being truly quiet? What specific fear makes me avoid the silence?",
    context: "In the silence, we meet ourselves. We learn that we don't need constant noise to be okay."
  }
];

const dharmaSections: WorkbookSection[] = [
  { id: 'rd_truth_1', title: 'First Noble Truth', description: 'There is suffering', questions: dharmaTruth1 },
  { id: 'rd_truth_2', title: 'Second Noble Truth', description: 'The cause of suffering', questions: dharmaTruth2 },
  { id: 'rd_truth_3', title: 'Third Noble Truth', description: 'The end of suffering', questions: dharmaTruth3 },
  { id: 'rd_truth_4', title: 'Fourth Noble Truth', description: 'The path', questions: dharmaTruth4 },
  { id: 'rd_path_1', title: 'Part I: Wisdom', description: 'Right View & Right Intention', questions: eightfoldPart1 },
  { id: 'rd_path_2', title: 'Part II: Ethics', description: 'Right Speech, Action, & Livelihood', questions: eightfoldPart2 },
  { id: 'rd_path_3', title: 'Part III: Discipline', description: 'Right Effort, Mindfulness, & Concentration', questions: eightfoldPart3 },
];

// --- MASTER REGISTRY ---
export const WORKBOOKS: Workbook[] = [
  {
    id: 'general_recovery',
    title: 'General Recovery Workbook',
    description: 'A comprehensive 25-question guide to explore the foundations of your recovery journey.',
    type: 'general',
    sections: [{ id: 'main', title: 'Core Questions', questions: generalQuestions }]
  },
  {
    id: '12_steps',
    title: '12-Step Workbook',
    description: 'A comprehensive 12-Step program. Each step includes an introduction and 3 guided sections.',
    type: 'steps',
    sections: twelveStepSections
  },
  {
    id: 'recovery_dharma',
    title: 'Recovery Dharma',
    description: 'Buddhist-inspired path to recovery focusing on the Four Noble Truths and Eightfold Path.',
    type: 'steps',
    sections: dharmaSections
  }
];

export function getWorkbook(id: string): Workbook | undefined {
  return WORKBOOKS.find(w => w.id === id);
}

================================================================================
FILE: src/index.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    /* The "Unified Blue" Theme from your Master Doc */
    @apply bg-blue-50 text-slate-800 antialiased;
  }
  
  /* Reset headings to be bold and dark blue by default */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold text-blue-900;
  }
}

================================================================================
FILE: src/lib/crypto.ts
================================================================================
// src/lib/crypto.ts

/**
 * Generates a random salt for PBKDF2.
 * Returns a base64 string.
 */
export function generateSalt(): string {
  const salt = window.crypto.getRandomValues(new Uint8Array(16));
  return btoa(String.fromCharCode(...salt));
}

/**
 * Derives an AES-GCM key from a user PIN and Salt.
 * Uses PBKDF2 with 100,000 iterations.
 */
export async function deriveKeyFromPin(pin: string, saltBase64: string): Promise<CryptoKey> {
  const enc = new TextEncoder();
  const salt = Uint8Array.from(atob(saltBase64), c => c.charCodeAt(0));

  const keyMaterial = await window.crypto.subtle.importKey(
    "raw",
    enc.encode(pin),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  return window.crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: 100000,
      hash: "SHA-256",
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

/**
 * Encrypts a string using the provided CryptoKey.
 * Returns a JSON string containing { iv, data } (both base64).
 */
export async function encryptData(text: string, key: CryptoKey): Promise<string> {
  const enc = new TextEncoder();
  const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV for GCM
  
  const ciphertext = await window.crypto.subtle.encrypt(
    { name: "AES-GCM", iv },
    key,
    enc.encode(text)
  );

  const ivBase64 = btoa(String.fromCharCode(...iv));
  const dataBase64 = btoa(String.fromCharCode(...new Uint8Array(ciphertext)));

  return JSON.stringify({ iv: ivBase64, data: dataBase64 });
}

/**
 * Decrypts a JSON string { iv, data } using the provided CryptoKey.
 * Returns the original plain text.
 */
export async function decryptData(encryptedJson: string, key: CryptoKey): Promise<string> {
  try {
    const { iv: ivBase64, data: dataBase64 } = JSON.parse(encryptedJson);
    
    const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));
    const data = Uint8Array.from(atob(dataBase64), c => c.charCodeAt(0));

    const decryptedBuffer = await window.crypto.subtle.decrypt(
      { name: "AES-GCM", iv },
      key,
      data
    );

    return new TextDecoder().decode(decryptedBuffer);
  } catch (error) {
    console.error("Decryption failed:", error);
    return "[Decryption Error: Invalid PIN or Corrupt Data]";
  }
}

================================================================================
FILE: src/lib/dateUtils.ts
================================================================================
// src/lib/dateUtils.ts

export type RecurrenceType = 'once' | 'daily' | 'weekly' | 'biweekly' | 'monthly' | 'monthly-relative';

export interface RecurrenceConfig {
  type: RecurrenceType;
  interval?: number; // e.g. every 2 days
  daysOfWeek?: number[]; // 0=Sun, 1=Mon, etc. (for weekly)
  dayOfMonth?: number; // 1-31 (for monthly)
  weekOfMonth?: number; // 1 (1st), 2 (2nd), ... 5 (Last) (for monthly-relative)
  dayOfWeek?: number; // 0-6 (for monthly-relative)
}

/**
 * Calculates the next due date based on a reference date (usually today or the completed date)
 * and the recurrence configuration.
 */
export function calculateNextDueDate(baseDate: Date, config: RecurrenceConfig): Date | null {
  if (config.type === 'once') return null;

  const nextDate = new Date(baseDate);
  nextDate.setHours(23, 59, 59, 999); // Normalize time

  switch (config.type) {
    case 'daily':
      nextDate.setDate(nextDate.getDate() + (config.interval || 1));
      break;

    case 'weekly':
      // Simple weekly: Add 7 days
      nextDate.setDate(nextDate.getDate() + 7);
      break;

    case 'biweekly':
      nextDate.setDate(nextDate.getDate() + 14);
      break;

    case 'monthly': { // FIX: Added block scope braces
      // Add 1 month, try to keep same day
      const currentDay = nextDate.getDate();
      nextDate.setMonth(nextDate.getMonth() + 1);
      
      // Handle edge case (e.g. Jan 31 -> Feb 28/29)
      if (nextDate.getDate() !== currentDay) {
          // If date changed, it means we overflowed (e.g. Feb 28 became Mar 2)
          // Set to 0 (last day of previous month)
          nextDate.setDate(0); 
      }
      break;
    }

    case 'monthly-relative':
      // e.g. "Last Thursday of the month"
      if (config.weekOfMonth !== undefined && config.dayOfWeek !== undefined) {
          nextDate.setMonth(nextDate.getMonth() + 1);
          nextDate.setDate(1); // Start at 1st of next month

          const targetDay = config.dayOfWeek; // 0-6
          const targetWeek = config.weekOfMonth; // 1-5 (5 = Last)

          if (targetWeek === 5) {
              // Logic for "Last X of month"
              nextDate.setMonth(nextDate.getMonth() + 1);
              nextDate.setDate(0); // Last day of target month
              
              const lastDayOfWeek = nextDate.getDay();
              const diff = lastDayOfWeek - targetDay;
              const subtractDays = diff >= 0 ? diff : diff + 7;
              nextDate.setDate(nextDate.getDate() - subtractDays);
          } else {
              // Logic for "Nth X of month"
              // FIX: Changed let to const
              const currentDow = nextDate.getDay();
              const daysToAdd = (targetDay - currentDow + 7) % 7;
              nextDate.setDate(nextDate.getDate() + daysToAdd);
              
              // Add weeks
              nextDate.setDate(nextDate.getDate() + (targetWeek - 1) * 7);
          }
      }
      break;
  }

  return nextDate;
}

/**
 * Returns a human-readable string for the recurrence rule.
 */
export function getRecurrenceLabel(config: RecurrenceConfig): string {
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const ordinals = ['','1st','2nd','3rd','4th','Last'];

    switch(config.type) {
        case 'once': return 'One-time';
        case 'daily': return 'Daily';
        case 'weekly': return 'Weekly';
        case 'biweekly': return 'Bi-Weekly';
        case 'monthly': return 'Monthly';
        case 'monthly-relative': 
            if(config.weekOfMonth && config.dayOfWeek !== undefined) {
                return `${ordinals[config.weekOfMonth]} ${days[config.dayOfWeek]} of Month`;
            }
            return 'Custom Monthly';
        default: return 'Recurring';
    }
}

================================================================================
FILE: src/lib/db.ts
================================================================================
import { 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  getDocs, 
  deleteDoc, 
  addDoc,
  query,
  where,
  orderBy,
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { type User } from "firebase/auth";

// --- INTERFACES ---

export interface UserProfile {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  sobrietyDate: Timestamp | null;
  createdAt: Timestamp;
  lastLogin?: Timestamp;
}

export interface JournalTemplate {
  id: string;
  name: string;
  prompts: string[]; 
  defaultTags: string[]; 
}

// [ADDED] Required for Journal features
export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  moodScore: number;
  tags: string[];
  createdAt: Timestamp;
  weather?: {
    temp_c: number;
    condition: string;
    icon: string;
  };
}

// [ADDED] Required for Task features (Approach 3)
export interface Task {
  id?: string;
  uid: string;
  text: string;
  completed: boolean;
  isRecurring: boolean;
  frequency: 'Daily' | 'Weekly' | 'Monthly' | null;
  currentStreak: number;
  priority: 'High' | 'Medium' | 'Low';
  createdAt: Timestamp;
  dueDate?: Timestamp; // The new field for "Smart Reset"
}

// --- PROFILE FUNCTIONS ---

// 1. Fetch a simple profile (Read-Only)
export async function getProfile(uid: string): Promise<UserProfile | null> {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  }
  return null;
}

// 2. Create or Get User Profile
export async function getOrCreateUserProfile(user: User): Promise<UserProfile> {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    // Optional: Update lastLogin here if you want to track activity
    await updateDoc(userRef, { lastLogin: Timestamp.now() });
    return userSnap.data() as UserProfile;
  } else {
    // Initialize new profile
    const newProfile: UserProfile = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL,
      sobrietyDate: null, 
      createdAt: Timestamp.now(),
      lastLogin: Timestamp.now()
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  }
}

// 3. Generic Profile Update
export async function updateProfileData(uid: string, data: Partial<UserProfile> | { sobrietyDate: Date | null }) {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", uid);
  // Spread data to safely handle the partial update
  await setDoc(userRef, { ...data }, { merge: true });
}

// 4. Update Sobriety Date (Legacy helper)
export async function updateSobrietyDate(uid: string, date: Date) {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  await updateDoc(userRef, {
    sobrietyDate: Timestamp.fromDate(date)
  });
}

// --- TEMPLATE FUNCTIONS (Preserved) ---

export async function getUserTemplates(uid: string): Promise<JournalTemplate[]> {
  if (!db) throw new Error("Database not initialized");

  const templatesRef = collection(db, 'users', uid, 'templates');
  const snapshot = await getDocs(templatesRef);

  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as JournalTemplate));
}

export async function saveUserTemplate(uid: string, template: JournalTemplate) {
  if (!db) throw new Error("Database not initialized");

  const docRef = template.id 
    ? doc(db, 'users', uid, 'templates', template.id)
    : doc(collection(db, 'users', uid, 'templates'));

  const dataToSave = {
    ...template,
    id: docRef.id 
  };

  await setDoc(docRef, dataToSave);
}

export async function deleteUserTemplate(uid: string, templateId: string) {
  if (!db) throw new Error("Database not initialized");

  const docRef = doc(db, 'users', uid, 'templates', templateId);
  await deleteDoc(docRef);
}

// --- [ADDED] JOURNAL FUNCTIONS ---

export const addJournalEntry = async (uid: string, entry: Omit<JournalEntry, 'uid' | 'createdAt'>) => {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, 'journals'), {
    uid,
    ...entry,
    createdAt: Timestamp.now(),
  });
};

export const getJournalHistory = async (uid: string) => {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, 'journals'),
    where('uid', '==', uid),
    orderBy('createdAt', 'desc')
  );
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as JournalEntry));
};

================================================================================
FILE: src/lib/firebase.ts
================================================================================
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

console.log("DEBUG: Current Auth Domain:", import.meta.env.VITE_FIREBASE_AUTH_DOMAIN); // <--- ADD THIS

// 1. Construct config directly from individual environment variables
// These will be injected by Vite during the build
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
};

// 2. Initialize (Safe Check)
// We check if apiKey exists to ensure we aren't crashing on empty config
const app = firebaseConfig.apiKey ? initializeApp(firebaseConfig) : undefined;

if (!app) {
  console.error("Firebase failed to initialize. Missing API Key.");
}

export const auth = app ? getAuth(app) : undefined;
export const db = app ? getFirestore(app) : undefined;
export const googleProvider = new GoogleAuthProvider();

export default app;

================================================================================
FILE: src/lib/gamification.ts
================================================================================
//import { Timestamp } from 'firebase/firestore';

export interface GamificationStats {
  streakDays: number;
  totalEntries: number;
  averageMood: number;
  journalStreak: number;
  consistencyRate: number; // entries per week
  totalWords: number;
}

export interface TaskStats {
    completionRate: number;
    habitFire: number; // Current streak of completed recurring tasks
}

export interface WorkbookStats {
    wisdomScore: number; // Total questions answered
    masterCompletion: number; // % of total questions
}

export interface VitalityStats {
    bioStreak: number;
    totalLogs: number;
}

// Helper to check if two dates are the same day
const isSameDay = (d1: Date, d2: Date) => {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
};

export const calculateJournalStats = (journals: any[]): GamificationStats => {
    if (!journals || journals.length === 0) {
        return { 
            streakDays: 0, 
            totalEntries: 0, 
            averageMood: 0, 
            journalStreak: 0, 
            consistencyRate: 0, 
            totalWords: 0
        };
    }

    // Sort descending (newest first)
    const sorted = [...journals].sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
    const today = new Date();
    
    // 1. Total Entries
    const totalEntries = journals.length;

    // 2. Average Mood
    const moodSum = journals.reduce((acc, curr) => acc + (curr.moodScore || 0), 0);
    const averageMood = totalEntries > 0 ? parseFloat((moodSum / totalEntries).toFixed(1)) : 0;

    // 3. Journal Streak
    let currentStreak = 0;
    // Check if posted today
    const lastPostDate = sorted[0].createdAt.toDate();
    const postedToday = isSameDay(lastPostDate, today);
    // If not posted today, check if posted yesterday to maintain streak
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const postedYesterday = isSameDay(lastPostDate, yesterday);

    if (postedToday || postedYesterday) {
        currentStreak = 1;
        // Iterate backwards to count consecutive days
        // We compress entries to unique days first
        const uniqueDays = new Set<string>();
        journals.forEach(j => {
            uniqueDays.add(j.createdAt.toDate().toDateString());
        });
        const sortedDates = Array.from(uniqueDays).map(d => new Date(d)).sort((a, b) => b.getTime() - a.getTime());
        
        for (let i = 0; i < sortedDates.length - 1; i++) {
            const current = sortedDates[i];
            const next = sortedDates[i+1];
            
            // Difference in days
            const diffTime = Math.abs(current.getTime() - next.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                currentStreak++;
            } else {
                break;
            }
        }
    }

    // 4. Consistency (Entries / Week)
    // Calc distinct weeks present
    const firstDate = sorted[sorted.length - 1].createdAt.toDate();
    const timeSpanDays = (today.getTime() - firstDate.getTime()) / (1000 * 3600 * 24);
    const weeksActive = Math.max(1, Math.ceil(timeSpanDays / 7));
    const consistencyRate = parseFloat((totalEntries / weeksActive).toFixed(1));

    // 5. Total Words
    const totalWords = journals.reduce((acc, curr) => {
        const words = curr.content ? curr.content.trim().split(/\s+/).length : 0;
        return acc + words;
    }, 0);

    return {
        streakDays: currentStreak,
        totalEntries,
        averageMood,
        journalStreak: currentStreak,
        consistencyRate,
        totalWords
    };
};

export const calculateTaskStats = (tasks: any[]): TaskStats => {
    if (!tasks || tasks.length === 0) {
        return { completionRate: 0, habitFire: 0 };
    }

    const completed = tasks.filter(t => t.completed).length;
    const completionRate = Math.round((completed / tasks.length) * 100);

    // Habit Fire: Longest current streak among active recurring tasks
    let maxStreak = 0;
    tasks.forEach(t => {
        if (t.currentStreak && t.currentStreak > maxStreak) {
            maxStreak = t.currentStreak;
        }
    });

    return { completionRate, habitFire: maxStreak };
};

export const calculateWorkbookStats = (answersSnapshotSize: number, totalQuestionsAvailable: number = 50): WorkbookStats => {
    // Note: totalQuestionsAvailable is defaulted to 50 for now, 
    // ideally passed from the Workbook definitions if available.
    return {
        wisdomScore: answersSnapshotSize,
        masterCompletion: Math.round((answersSnapshotSize / totalQuestionsAvailable) * 100)
    };
};

// [NEW] Calculate stats for Vitality Module
export const calculateVitalityStats = (journals: any[]): VitalityStats => {
    if (!journals) return { bioStreak: 0, totalLogs: 0 };

    // Filter for entries tagged 'Vitality'
    const vitalityLogs = journals.filter(j => j.tags && j.tags.includes('Vitality'));
    
    if (vitalityLogs.length === 0) return { bioStreak: 0, totalLogs: 0 };

    // 1. Total Logs
    const totalLogs = vitalityLogs.length;

    // 2. Bio Streak (Same logic as Journal Streak)
    const sorted = [...vitalityLogs].sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
    const today = new Date();
    
    let currentStreak = 0;
    const lastPostDate = sorted[0].createdAt.toDate();
    const postedToday = isSameDay(lastPostDate, today);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const postedYesterday = isSameDay(lastPostDate, yesterday);

    if (postedToday || postedYesterday) {
        currentStreak = 1;
        const uniqueDays = new Set<string>();
        vitalityLogs.forEach(j => {
            uniqueDays.add(j.createdAt.toDate().toDateString());
        });
        const sortedDates = Array.from(uniqueDays).map(d => new Date(d)).sort((a, b) => b.getTime() - a.getTime());
        
        for (let i = 0; i < sortedDates.length - 1; i++) {
            const current = sortedDates[i];
            const next = sortedDates[i+1];
            const diffTime = Math.abs(current.getTime() - next.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) currentStreak++;
            else break;
        }
    }

    return { bioStreak: currentStreak, totalLogs };
};

================================================================================
FILE: src/lib/gemini.ts
================================================================================
import { GoogleGenerativeAI } from "@google/generative-ai";

// Initialize Gemini
// UPDATED: Using 'gemini-1.5-flash' (standard) or your preferred 'gemini-2.5-flash' if available.
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY || '';
const genAI = new GoogleGenerativeAI(API_KEY);
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); 

// --- Types ---

export interface AnalysisResult {
  summary: string;
  mood: string;
  sentiment: 'Positive' | 'Neutral' | 'Negative' | 'Mixed';
  risk_analysis: string;
  positive_reinforcement: string;
  tool_suggestions: string[];
}

export interface WorkbookAnalysisResult {
  scope_context: string; 
  pillars: {
    understanding: string; 
    emotional_resonance: string; 
    blind_spots: string; 
  };
  suggested_actions: string[]; 
}

// --- Helpers ---

/**
 * Robust JSON parser that strips Markdown code blocks (```json ... ```)
 * to prevent JSON.parse() from crashing.
 */
function cleanAndParseJSON(text: string): unknown {
  try {
    // 1. Remove markdown code fences
    let cleanText = text.replace(/```json/g, '').replace(/```/g, '');
    
    // 2. Trim whitespace
    cleanText = cleanText.trim();
    
    return JSON.parse(cleanText);
  } catch (error) {
    console.error("JSON Parsing Failed:", error);
    console.log("Raw Text was:", text);
    throw new Error("Failed to parse AI response.");
  }
}

/**
 * Truncates text to a safe token limit (~12,000 characters) to prevent 429 errors.
 */
const truncatePayload = (text: string, limit: number = 12000): string => {
  if (text.length <= limit) return text;
  return text.substring(0, limit) + "...(truncated for analysis)";
};

/**
 * Wraps the API call with a retry mechanism for 429 (Rate Limit) errors.
 */
const generateWithRetry = async (prompt: string, retries = 2): Promise<string | null> => {
  for (let i = 0; i <= retries; i++) {
    try {
      const result = await model.generateContent(prompt);
      const response = result.response;
      return response.text();
    } catch (err: unknown) {
      const error = err as { message?: string; status?: number };
      
      const isRateLimit = error.message?.includes('429') || error.status === 429;
      const isServerOverload = error.message?.includes('503') || error.status === 503;
      
      if ((isRateLimit || isServerOverload) && i < retries) {
        const waitTime = 2000 * (i + 1);
        console.warn(`Gemini API Busy (Attempt ${i + 1}). Retrying in ${waitTime}ms...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
        continue;
      }
      
      console.error("Gemini Generation Error:", error);
      return null;
    }
  }
  return null;
};

// --- Journal Analysis ---

export const analyzeJournalEntries = async (entries: string[]): Promise<AnalysisResult | null> => {
  if (!API_KEY) {
    console.warn("Gemini API Key missing.");
    return null;
  }

  const rawText = entries.join('\n---\n');
  const safeText = truncatePayload(rawText);

  try {
    const prompt = `
      Act as a compassionate, wise, and highly experienced addiction recovery sponsor.
      Analyze the following journal entries from a user in recovery.
      
      Entries:
      ${safeText}
      
      Return a JSON object with the following fields:
      - summary: A 2-3 sentence compassionate summary of the user's current state.
      - mood: A 1-word descriptor of the overall mood (e.g., "Reflective", "Anxious", "Hopeful").
      - sentiment: One of "Positive", "Neutral", "Negative", "Mixed".
      - risk_analysis: Identify any potential relapse triggers or cognitive distortions.
      - positive_reinforcement: Highlight a strength or win demonstrated in the entries.
      - tool_suggestions: A list of 3 specific, actionable recovery tools (e.g., "Call a friend", "5-min meditation").
      
      Output ONLY raw JSON. Do not use Markdown formatting.
    `;

    const textResponse = await generateWithRetry(prompt);
    if (!textResponse) return null;

    return cleanAndParseJSON(textResponse) as AnalysisResult;

  } catch (error) {
    console.error("Gemini Processing Error:", error);
    return null;
  }
};

// --- Workbook Analysis ---

export const analyzeWorkbookContent = async (
  content: string, 
  scope: 'section' | 'workbook' | 'global',
  contextTitle: string
): Promise<WorkbookAnalysisResult | null> => {
  if (!API_KEY) return null;

  const safeContent = truncatePayload(content);

  try {
    let persona = "a supportive 12-step sponsor";
    if (scope === 'workbook') persona = "a comprehensive recovery program director";
    if (scope === 'global') persona = "a holistic spiritual guide reviewing the entire life journey";

    const prompt = `
      Act as ${persona}.
      Review the following workbook Q&A content from a user in recovery.
      Context: ${contextTitle} (${scope} level review).
      
      Content to Analyze:
      ${safeContent}

      Return a JSON object with:
      - scope_context: A short title for this analysis (e.g., "Review of Step 1").
      - pillars: {
          understanding: "Assessment of how well the user grasps the concepts.",
          emotional_resonance: "Observation of emotional honesty and barriers.",
          blind_spots: "Gentle pointing out of areas they might be avoiding."
      }
      - suggested_actions: A list of 3 specific, concrete tasks to integrate this learning.
      
      Output ONLY raw JSON. Do not use Markdown formatting.
    `;

    const textResponse = await generateWithRetry(prompt);
    if (!textResponse) return null;

    return cleanAndParseJSON(textResponse) as WorkbookAnalysisResult;

  } catch (error) {
    console.error("Workbook Analysis Error:", error);
    return null;
  }
};

// --- NEW: AI Coaching (Single Question Feedback) ---

export const getGeminiCoaching = async (question: string, answer: string): Promise<string> => {
    if (!API_KEY) return "AI Coach Unavailable (Missing Key)";
    
    // Truncate if answer is massive to save tokens
    const safeAnswer = truncatePayload(answer, 2000); 

    const prompt = `
        You are a wise, compassionate recovery coach (like a 12-step sponsor or therapist).
        A user is working on a workbook and just answered this question:
        "${question}"

        Their Answer:
        "${safeAnswer}"

        Provide a short (2-3 sentences), encouraging, and insightful response.
        - Validate their honesty.
        - Gently challenge them to go deeper if the answer seems surface-level.
        - Do NOT just repeat what they said. Offer a new perspective or a follow-up reflection.
    `;

    try {
        const response = await generateWithRetry(prompt);
        return response || "Coach is taking a moment to reflect. Try again.";
    } catch (error) {
        console.error("Coaching Error:", error);
        return "Coach is currently offline.";
    }
};

================================================================================
FILE: src/lib/importer.ts
================================================================================
import { collection, doc, writeBatch, Timestamp } from 'firebase/firestore';
import { db } from './firebase';

// 1. Define the target format (Your current app schema)
export interface NewJournalEntry {
  uid: string;
  content: string;
  moodScore: number;
  sentiment: string;
  weather: { temp: number; condition: string } | null;
  createdAt: Timestamp;
  tags: string[];
}

// 2. Define the exact Legacy format based on your uploaded JSON
interface LegacyEntry {
  id: string;
  text: string;
  mood: number;
  weather?: string;
  tags?: string[];
  timestamp: string;
}

// 3. Helper to parse weather string "Partly Cloudy, -6¬∞C" -> { condition, temp }
const parseLegacyWeather = (weatherStr?: string): { temp: number; condition: string } | null => {
  if (!weatherStr || typeof weatherStr !== 'string') return null;

  // Regex to capture "Condition" and "Temp" (e.g. "Partly Cloudy, -6¬∞C")
  // Matches: Group 1 (Condition), Group 2 (Number)
  const match = weatherStr.match(/^(.*),\s*(-?\d+)¬∞C$/);

  if (match) {
    return {
      condition: match[1].trim(),
      temp: parseInt(match[2], 10)
    };
  }

  // Fallback if format is different but not empty
  if (weatherStr.trim().length > 0) {
    return { condition: weatherStr, temp: 0 };
  }

  return null;
};

// 4. The Mapper Function
// Converts "LegacyEntry" -> "NewJournalEntry"
const mapLegacyEntry = (uid: string, entry: LegacyEntry): NewJournalEntry => {
  // Handle mood: Legacy app seems to use 0 for unset. New app uses 1-10.
  // We map 0 to 5 (Neutral), and clamp others between 1-10.
  let mood = entry.mood || 5;
  if (mood === 0) mood = 5;
  mood = Math.max(1, Math.min(10, mood));

  return {
    uid,
    content: entry.text || "", // Map 'text' to 'content'
    moodScore: mood,
    sentiment: 'Neutral', // Legacy data doesn't have sentiment, default to Neutral
    weather: parseLegacyWeather(entry.weather),
    createdAt: Timestamp.fromDate(new Date(entry.timestamp)), // Parse ISO string
    tags: Array.isArray(entry.tags) ? entry.tags : [] // Carry over tags
  };
};

// 5. Main Import Function
export async function importLegacyJournals(uid: string, file: File): Promise<{ success: number; errors: number }> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        // FIX: Guard clause to ensure db is initialized
        if (!db) {
            reject(new Error("Firestore database is not initialized"));
            return;
        }

        const text = e.target?.result as string;
        const json = JSON.parse(text);

        // Ensure it's an array
        const rawEntries = Array.isArray(json) ? json : [json];
        
        if (rawEntries.length === 0) {
          resolve({ success: 0, errors: 0 });
          return;
        }

        // Process in batches of 500 (Firestore limit)
        let batch = writeBatch(db);
        let operationCount = 0;
        let successCount = 0;
        let errorCount = 0;

        for (const raw of rawEntries) {
          try {
            // Validate essential fields before mapping
            if (!raw.timestamp) {
              console.warn("Skipping entry without timestamp:", raw.id);
              errorCount++;
              continue;
            }

            const mappedData = mapLegacyEntry(uid, raw as LegacyEntry);
            
            // Generate a new ID for the document (ignoring legacy ID to avoid collision/format issues)
            const newDocRef = doc(collection(db, 'journals'));
            batch.set(newDocRef, mappedData);
            
            operationCount++;
            successCount++;

            // If we hit 450 (safety buffer below 500), commit and restart batch
            if (operationCount >= 450) {
              await batch.commit();
              batch = writeBatch(db); // New batch
              operationCount = 0;
            }
          } catch (err) {
            console.warn("Skipping invalid entry:", raw.id, err);
            errorCount++;
          }
        }

        // Commit any remaining ops
        if (operationCount > 0) {
          await batch.commit();
        }

        resolve({ success: successCount, errors: errorCount });

      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = (error) => reject(error);
    reader.readAsText(file);
  });
}

================================================================================
FILE: src/lib/insights.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import type { AnalysisResult, WorkbookAnalysisResult } from "./gemini";

const COLLECTION = 'insights';

// --- DEFINITIONS ---

// Define a discriminated union for the two types of insights
export type InsightType = 'journal' | 'workbook';

// Combined type for what we save to Firestore
export type InsightPayload = 
  | ({ type: 'journal' } & AnalysisResult)
  | ({ type: 'workbook' } & WorkbookAnalysisResult);

// The hydrated object returned to the UI (includes ID and Dates)
export type SavedInsight = InsightPayload & {
  id: string;
  uid: string;
  createdAt: Date;
};

/**
 * Saves a new AI Insight to Firestore.
 * Supports both Journal Analysis and Workbook Analysis via discriminated union.
 * * @param uid - The User ID
 * @param payload - The structured result from Gemini + type ('journal' | 'workbook')
 */
export async function saveInsight(uid: string, payload: InsightPayload) {
  if (!db) throw new Error("Database not initialized");

  // We spread the payload directly. 
  // Firestore will store the 'type' field and all specific fields (mood vs pillars).
  await addDoc(collection(db, COLLECTION), {
    uid,
    createdAt: Timestamp.now(),
    ...payload
  });
}

/**
 * Fetches the history of AI Insights for a user, sorted by newest first.
 * Handles backward compatibility for old records (defaults to 'journal').
 */
export async function getInsightHistory(uid: string): Promise<SavedInsight[]> {
  if (!db) throw new Error("Database not initialized");

  try {
    const q = query(
      collection(db, COLLECTION),
      where("uid", "==", uid),
      orderBy("createdAt", "desc")
    );

    const snapshot = await getDocs(q);
    
    return snapshot.docs.map(doc => {
      const data = doc.data();
      
      // Backward Compatibility:
      // If 'type' is missing, it's a legacy Journal Insight.
      const type = data.type || 'journal';

      return {
        ...data, // <--- FIXED: Spread data FIRST so we can override fields below
        id: doc.id,
        uid: data.uid,
        type,
        // Ensure createdAt is a real JS Date object (overriding the Timestamp from ...data)
        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),
      } as SavedInsight;
    });

  } catch (e: unknown) {
    console.error("Error fetching insights:", e);
    
    // Check for Missing Index error
    const err = e as { message?: string };
    if (err.message && err.message.includes("index")) {
        console.warn("‚ö†Ô∏è MISSING INDEX: Open your browser console and click the Firebase link to create the index for 'insights'.");
    }
    return [];
  }
}

================================================================================
FILE: src/lib/journal.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp,
  deleteDoc,
  doc,
  updateDoc // <--- Added this
} from "firebase/firestore";
import { db } from "./firebase";
import type { WeatherData } from "./weather";

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  tags: string[];
  moodScore: number;
  weather?: WeatherData | null;
  createdAt: Date;
}

const COLLECTION = 'journals';

// 1. CREATE
export async function addJournalEntry(
  uid: string, 
  content: string, 
  moodScore: number, 
  tags: string[],
  weather: WeatherData | null
) {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, COLLECTION), {
    uid,
    content,
    tags,
    moodScore,
    weather: weather || null, 
    createdAt: Timestamp.now()
  });
}

// 2. READ
export async function getUserJournals(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt.toDate()
  })) as JournalEntry[];
}

// 3. UPDATE (New)
export async function updateJournalEntry(
  id: string,
  content: string, 
  moodScore: number, 
  tags: string[]
) {
  if (!db) throw new Error("Database not initialized");
  const docRef = doc(db, COLLECTION, id);
  await updateDoc(docRef, {
    content,
    moodScore,
    tags,
    // We do NOT update createdAt or weather, as those are historical facts
  });
}

// 4. DELETE
export async function deleteJournalEntry(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

================================================================================
FILE: src/lib/tasks.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  doc, 
  updateDoc,
  deleteDoc, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { startOfDay, isBefore, addDays, addWeeks, addMonths, isSameDay } from "date-fns";

export type Frequency = 'once' | 'daily' | 'weekly' | 'monthly';
export type Priority = 'High' | 'Medium' | 'Low';

export interface Task {
  id?: string;
  uid: string;
  title: string;
  isRecurring: boolean;
  frequency: Frequency;
  priority: Priority; // ADDED
  currentStreak: number;
  lastCompletedAt: Date | null;
  dueDate: Date;
  createdAt: Date;
}

const COLLECTION = 'tasks';

// 1. CREATE
export async function addTask(
  uid: string, 
  title: string, 
  frequency: Frequency, 
  priority: Priority, // ADDED
  startDate: Date // ADDED for Approach 3
) {
  if (!db) throw new Error("Database not initialized");
  
  const isRecurring = frequency !== 'once';
  // Ensure date is start of day to avoid time zone drift
  const due = startOfDay(startDate);

  await addDoc(collection(db, COLLECTION), {
    uid,
    title,
    isRecurring,
    frequency,
    priority,
    currentStreak: 0,
    lastCompletedAt: null,
    dueDate: Timestamp.fromDate(due),
    createdAt: Timestamp.now()
  });
}

// 2. READ & LAZY EVALUATE STREAKS
export async function getUserTasks(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid)
  );

  const snapshot = await getDocs(q);
  const tasks: Task[] = [];
  const today = startOfDay(new Date());

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    // Safely convert Timestamps to Dates
    const task = { 
      id: docSnap.id, 
      ...data,
      dueDate: data.dueDate?.toDate(),
      lastCompletedAt: data.lastCompletedAt?.toDate(),
      createdAt: data.createdAt?.toDate()
    } as Task;

    // --- LAZY EVALUATION LOGIC (Preserved from your code) ---
    // If it's recurring, overdue, and NOT completed today:
    if (task.isRecurring && isBefore(task.dueDate, today)) {
        
        const completedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
        
        if (!completedToday) {
            let newStreak = task.currentStreak;
            
            // Punishment Logic
            if (newStreak > 0) {
                newStreak = 0; // Break positive streak
            } else {
                newStreak -= 1; // Deepen negative streak
            }

            // Reset due date to Today so they can get back on track (Smart Reset)
            const taskRef = doc(db, COLLECTION, task.id!);
            await updateDoc(taskRef, {
                currentStreak: newStreak,
                dueDate: Timestamp.fromDate(today)
            });

            task.currentStreak = newStreak;
            task.dueDate = today;
        }
    }

    tasks.push(task);
  }

  return tasks;
}

// 3. TOGGLE COMPLETION
export async function toggleTask(task: Task, isCompleted: boolean) {
  if (!db) throw new Error("Database not initialized");
  const taskRef = doc(db, COLLECTION, task.id!);
  const today = startOfDay(new Date());

  if (isCompleted) {
    // MARKING DONE
    let newStreak = task.currentStreak;
    if (newStreak < 0) {
        newStreak = 1; // Bounce back from negative
    } else {
        newStreak += 1;
    }

    // Calculate next due date (Smart Reset Approach)
    // We calculate from TODAY, ensuring users don't get stuck in the past
    let nextDue = task.dueDate;
    if (task.frequency === 'daily') nextDue = addDays(today, 1);
    else if (task.frequency === 'weekly') nextDue = addWeeks(today, 1);
    else if (task.frequency === 'monthly') nextDue = addMonths(today, 1);
    
    // If 'once', we don't change the due date, it just gets marked done.

    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: Timestamp.fromDate(new Date()),
        // Only update due date if recurring
        ...(task.isRecurring && { dueDate: Timestamp.fromDate(nextDue) })
    });

  } else {
    // UNCHECKING (Undo)
    const newStreak = task.currentStreak > 0 ? task.currentStreak - 1 : task.currentStreak;
    
    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: null,
        // If unchecking, we usually want to reset the due date to "Today" or the original due date.
        // For simplicity in recovery, if you uncheck it, it becomes due today.
        dueDate: Timestamp.fromDate(today)
    });
  }
}

// 4. DELETE
export async function deleteTask(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

// 5. GET COMPLETED TODAY
export async function getCompletedTasksForToday(uid: string) {
    if (!db) throw new Error("Database not initialized");
    const today = startOfDay(new Date());
    const allTasks = await getUserTasks(uid);
    
    return allTasks.filter(t => 
        t.lastCompletedAt && isSameDay(t.lastCompletedAt, today)
    );
}

================================================================================
FILE: src/lib/weather.ts
================================================================================
// Maps WMO Weather Codes to human readable text
function getWeatherCondition(code: number): string {
  if (code === 0) return 'Clear sky';
  if (code >= 1 && code <= 3) return 'Partly cloudy';
  if (code >= 45 && code <= 48) return 'Foggy';
  if (code >= 51 && code <= 55) return 'Drizzle';
  if (code >= 61 && code <= 65) return 'Rain';
  if (code >= 71 && code <= 77) return 'Snow';
  if (code >= 95 && code <= 99) return 'Thunderstorm';
  return 'Unknown';
}

export interface WeatherData {
  temp: number;
  condition: string;
  location: string; // We'll just store "Lat/Lon" or a generic name for now
}

export async function getCurrentWeather(): Promise<WeatherData | null> {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported");
    return null;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          
          // Using Open-Meteo (Free, No Key Required)
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius`
          );
          
          if (!response.ok) throw new Error("Weather API failed");
          
          const data = await response.json();
          const weather = data.current_weather;

          resolve({
            temp: weather.temperature,
            condition: getWeatherCondition(weather.weathercode),
            location: 'Local' // We could use a reverse geocoding API here later if needed
          });
        } catch (error) {
          console.error("Error fetching weather:", error);
          resolve(null);
        }
      },
      (error) => {
        console.warn("Location permission denied or failed", error);
        resolve(null);
      }
    );
  });
}

================================================================================
FILE: src/lib/workbooks.ts
================================================================================
// src/lib/workbooks.ts

export interface Question {
  id: string;
  text: string;
  helperText?: string;
}

export interface Section {
  id: string;
  title: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  sections: Section[];
  estimatedTime?: string;
}

// DATA: You can expand this or move to Firestore later
const WORKBOOKS: Workbook[] = [
  {
    id: "step1",
    title: "Step 1: Honesty",
    description: "We admitted we were powerless over our addiction - that our lives had become unmanageable.",
    estimatedTime: "45 mins",
    sections: [
        {
            id: "s1_physical",
            title: "Physical Allergy",
            questions: [
                { id: "q1", text: "Describe the last time you tried to control your using. What happened?", helperText: "Focus on the physical sensation of craving." },
                { id: "q2", text: "Have you ever tried to stop and found you couldn't stay stopped?", helperText: "List specific dates or attempts." }
            ]
        },
        {
            id: "s1_unmanageability",
            title: "Unmanageability",
            questions: [
                { id: "q3", text: "How has your addiction affected your financial situation?", helperText: "Be specific about debts or lost opportunities." },
                { id: "q4", text: "How has your addiction affected your personal relationships?", helperText: "Think about trust, reliability, and presence." }
            ]
        }
    ]
  },
  {
      id: "cbt_foundations",
      title: "CBT: Thought Records",
      description: "Learn to catch, check, and change negative thought patterns.",
      estimatedTime: "20 mins",
      sections: [
          {
              id: "cbt_catch",
              title: "Catching the Thought",
              questions: [
                  { id: "q1", text: "What was the situation?", helperText: "Who, what, where, when." },
                  { id: "q2", text: "What was the automatic negative thought?", helperText: "I am worthless, This will never work, etc." }
              ]
          }
      ]
  }
];

export async function getWorkbookById(id: string): Promise<Workbook | undefined> {
  // Simulate network delay for realism
  await new Promise(resolve => setTimeout(resolve, 50));
  return WORKBOOKS.find(wb => wb.id === id);
}

export async function getAllWorkbooks(): Promise<Workbook[]> {
    await new Promise(resolve => setTimeout(resolve, 50));
    return WORKBOOKS;
}

================================================================================
FILE: src/main.tsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css' // <--- THIS IS THE CRITICAL MISSING LINE

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

================================================================================
FILE: src/pages/Dashboard.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, query, where, orderBy, getDocs, doc, getDoc } from 'firebase/firestore';
import { calculateJournalStats, calculateTaskStats, calculateWorkbookStats, calculateVitalityStats } from '../lib/gamification';
import RecoveryHero from '../components/RecoveryHero';

const TOTAL_WORKBOOK_QUESTIONS = 45;

export default function Dashboard() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);

  // Data State
  const [daysClean, setDaysClean] = useState<number>(0);
  const [journalStats, setJournalStats] = useState({ streak: 0, consistency: 0 });
  const [taskStats, setTaskStats] = useState({ rate: 0, fire: 0 });
  const [workbookStats, setWorkbookStats] = useState({ wisdom: 0, completion: 0 });
  const [vitalityStats, setVitalityStats] = useState({ bioStreak: 0, totalLogs: 0 });

  useEffect(() => {
    if (!user) return;

    const loadDashboardData = async () => {
        if (!db) return;

        try {
            // 0. Fetch User Profile for Sobriety Date
            const userDocRef = doc(db, 'users', user.uid);
            const userDocSnap = await getDoc(userDocRef);
             
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                if (userData.sobrietyDate) {
                    const start = userData.sobrietyDate.toDate ? userData.sobrietyDate.toDate() : new Date(userData.sobrietyDate);
                    
                    const now = new Date();
                    const diffTime = Math.abs(now.getTime() - start.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    setDaysClean(diffDays);
                }
            }

            // 1. Fetch Journals
            const journalQ = query(
                collection(db, 'journals'), 
                where('uid', '==', user.uid),
                orderBy('createdAt', 'desc')
            );
            const journalSnap = await getDocs(journalQ);
            const journals = journalSnap.docs.map(d => ({...d.data(), createdAt: d.data().createdAt}));

            const jStats = calculateJournalStats(journals);
            setJournalStats({ 
                streak: jStats.journalStreak, 
                consistency: jStats.consistencyRate
            });

            const vStats = calculateVitalityStats(journals);
            setVitalityStats(vStats);

            // 2. Fetch Tasks
            const taskQ = query(collection(db, 'tasks'), where('uid', '==', user.uid));
            const taskSnap = await getDocs(taskQ);
            const tasks = taskSnap.docs.map(d => d.data());
            const tStats = calculateTaskStats(tasks);
            setTaskStats({ rate: tStats.completionRate, fire: tStats.habitFire });

            // 3. Fetch Workbook Answers
            const wbQ = query(collection(db, 'users', user.uid, 'workbook_answers'));
            const wbSnap = await getDocs(wbQ);
            const wStats = calculateWorkbookStats(wbSnap.size, TOTAL_WORKBOOK_QUESTIONS);
            setWorkbookStats({ wisdom: wStats.wisdomScore, completion: wStats.masterCompletion });

        } catch (error) {
            console.error("Dashboard load error:", error);
        } finally {
            setLoading(false);
        }
    };

    loadDashboardData();
  }, [user]);

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your recovery hub...</div>;

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      
      {/* RECOVERY HERO */}
      <RecoveryHero 
         userName={user?.displayName?.split(' ')[0] || 'Friend'}
         daysClean={daysClean}
         journalStats={journalStats}
         taskStats={taskStats}
         workbookStats={workbookStats}
         vitalityStats={vitalityStats}
      />

    </div>
  );
}

================================================================================
FILE: src/pages/InsightsLog.tsx
================================================================================
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getInsightHistory, type SavedInsight } from '../lib/insights';
import { 
  LightBulbIcon, 
  SparklesIcon, 
  AcademicCapIcon, 
  BookOpenIcon, 
  ShieldExclamationIcon,
  CheckCircleIcon,
  TrophyIcon,
  CalendarDaysIcon
} from '@heroicons/react/24/outline';

export default function InsightsLog() {
  const { user } = useAuth();
  const [insights, setInsights] = useState<SavedInsight[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'journal' | 'workbook'>('all');

  const loadData = useCallback(async () => {
    if (!user) return;
    try {
      const data = await getInsightHistory(user.uid);
      setInsights(data);
    } catch (error) {
      console.error("Failed to load insights log", error);
    } finally {
      setLoading(false);
    }
  }, [user]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const filteredInsights = insights.filter(item => filter === 'all' || item.type === filter);

  if (loading) return <div className="p-8 text-center text-gray-500">Loading wisdom archive...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-8 pb-20">
      
      {/* HEADER */}
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <LightBulbIcon className="h-8 w-8 text-yellow-500" />
                Wisdom Log
            </h1>
            <p className="text-sm text-gray-500 mt-1">A timeline of your AI coaching sessions and breakthroughs.</p>
          </div>
          
          {/* FILTER TABS */}
          <div className="flex p-1 space-x-1 bg-gray-100 rounded-xl">
             {(['all', 'journal', 'workbook'] as const).map((tab) => (
                <button
                  key={tab}
                  onClick={() => setFilter(tab)}
                  className={`px-4 py-2 text-xs font-medium rounded-lg capitalize transition-all ${
                    filter === tab ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  {tab}
                </button>
             ))}
          </div>
      </div>

      {/* TIMELINE LIST */}
      <div className="space-y-6">
        {filteredInsights.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                <SparklesIcon className="h-12 w-12 text-gray-300 mx-auto mb-3" />
                <h3 className="text-lg font-medium text-gray-900">No Insights Saved Yet</h3>
                <p className="text-gray-500">Generate analysis from your Journal or Workbooks to populate this log.</p>
            </div>
        ) : (
            filteredInsights.map((insight) => (
                <div key={insight.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    
                    {/* META HEADER */}
                    <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            {insight.type === 'journal' ? (
                                <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <BookOpenIcon className="h-3 w-3" /> Journal
                                </span>
                            ) : (
                                <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    <AcademicCapIcon className="h-3 w-3" /> Workbook
                                </span>
                            )}
                            <span className="text-xs text-gray-400 flex items-center gap-1">
                                <CalendarDaysIcon className="h-3 w-3" />
                                {insight.createdAt.toLocaleDateString()} ‚Ä¢ {insight.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                    </div>

                    {/* CONTENT BODY */}
                    <div className="p-5">
                        
                        {/* --- RENDER JOURNAL INSIGHT --- */}
                        {insight.type === 'journal' && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-1">Daily Reflection</h3>
                                    <p className="text-gray-600 text-sm leading-relaxed">{insight.summary}</p>
                                </div>
                                <div className="flex gap-4 text-xs">
                                    <div className="bg-blue-50 px-3 py-1 rounded-lg border border-blue-100 text-blue-700">
                                        Mood: <span className="font-bold">{insight.mood}</span>
                                    </div>
                                    <div className="bg-blue-50 px-3 py-1 rounded-lg border border-blue-100 text-blue-700">
                                        Sentiment: <span className="font-bold">{insight.sentiment}</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                    <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                        <div className="text-orange-800 font-bold text-xs uppercase mb-1 flex items-center gap-1">
                                            <ShieldExclamationIcon className="h-3 w-3" /> Risk
                                        </div>
                                        <p className="text-xs text-orange-900">{insight.risk_analysis}</p>
                                    </div>
                                    <div className="bg-green-50 p-3 rounded-lg border border-green-100">
                                        <div className="text-green-800 font-bold text-xs uppercase mb-1 flex items-center gap-1">
                                            <TrophyIcon className="h-3 w-3" /> Win
                                        </div>
                                        <p className="text-xs text-green-900">{insight.positive_reinforcement}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- RENDER WORKBOOK INSIGHT --- */}
                        {insight.type === 'workbook' && (
                            <div className="space-y-4">
                                <div>
                                    <h3 className="text-lg font-bold text-purple-900 mb-1">{insight.scope_context}</h3>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <div className="text-blue-800 font-bold text-xs uppercase mb-1">Understanding</div>
                                        <p className="text-xs text-blue-900 leading-relaxed">{insight.pillars.understanding}</p>
                                    </div>
                                    <div className="bg-green-50 p-3 rounded-lg border border-green-100">
                                        <div className="text-green-800 font-bold text-xs uppercase mb-1">Growth</div>
                                        <p className="text-xs text-green-900 leading-relaxed">{insight.pillars.emotional_resonance}</p>
                                    </div>
                                    <div className="bg-orange-50 p-3 rounded-lg border border-orange-100">
                                        <div className="text-orange-800 font-bold text-xs uppercase mb-1">Blind Spots</div>
                                        <p className="text-xs text-orange-900 leading-relaxed">{insight.pillars.blind_spots}</p>
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <div className="text-gray-500 font-bold text-xs uppercase mb-2 flex items-center gap-1">
                                        <CheckCircleIcon className="h-3 w-3" /> Action Plan
                                    </div>
                                    <ul className="space-y-1">
                                        {insight.suggested_actions?.map((action: string, i: number) => (
                                            <li key={i} className="text-xs text-gray-700 flex items-start gap-2">
                                                <span className="text-purple-400">‚Ä¢</span> {action}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            ))
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Journal.tsx
================================================================================
import { useState } from 'react';
import { useSearchParams } from 'react-router-dom';
import JournalEditor from '../components/journal/JournalEditor';
import JournalHistory from '../components/journal/JournalHistory';
import JournalInsights from '../components/journal/JournalInsights';
import { 
  PencilSquareIcon, 
  ClockIcon, 
  ChartBarIcon 
} from '@heroicons/react/24/outline';
import type { JournalEntry } from '../components/journal/JournalEditor';

export default function Journal() {
  const [searchParams, setSearchParams] = useSearchParams();
  
  // DERIVED STATE: Single Source of Truth (The URL)
  const activeTab = searchParams.get('tab') || 'write';
  
  // EXTRACT TEMPLATE ID (for Deep Links like ?template=urge_log)
  const initialTemplateId = searchParams.get('template');
  
  const [editingEntry, setEditingEntry] = useState<JournalEntry | null>(null);

  // Update URL directly. React will re-render with the new derived activeTab.
  const handleTabChange = (tab: string) => {
    setSearchParams(prev => {
        prev.set('tab', tab);
        // Clean up template param if leaving write tab so it doesn't persist unwantedly
        if (tab !== 'write') prev.delete('template');
        return prev;
    });
  };

  const handleEdit = (entry: JournalEntry) => {
    setEditingEntry(entry);
    handleTabChange('write');
  };

  const handleEntrySaved = () => {
    setEditingEntry(null);
    // Remove template param from URL after save to prevent it from reappearing
    setSearchParams(prev => {
        prev.delete('template');
        prev.set('tab', 'history');
        return prev;
    });
  };

  return (
    <div className="max-w-7xl mx-auto space-y-6 pb-20">
      
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
           <h1 className="text-3xl font-bold text-gray-900">Journal</h1>
           <p className="text-gray-500 mt-1">Capture your thoughts, track your mood, and uncover patterns.</p>
        </div>

        {/* Tab Navigation */}
        <div className="flex p-1 space-x-1 bg-blue-50/50 rounded-xl border border-blue-100">
           <button
             onClick={() => handleTabChange('write')}
             className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-all ${
               activeTab === 'write' 
                 ? 'bg-white text-blue-700 shadow-sm border border-gray-100' 
                 : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'
             }`}
           >
             <PencilSquareIcon className="h-4 w-4" />
             Write
           </button>
           <button
             onClick={() => handleTabChange('history')}
             className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-all ${
               activeTab === 'history' 
                 ? 'bg-white text-blue-700 shadow-sm border border-gray-100' 
                 : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'
             }`}
           >
             <ClockIcon className="h-4 w-4" />
             History
           </button>
           <button
             onClick={() => handleTabChange('insights')}
             className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-all ${
               activeTab === 'insights' 
                 ? 'bg-white text-blue-700 shadow-sm border border-gray-100' 
                 : 'text-gray-500 hover:text-gray-700 hover:bg-white/50'
             }`}
           >
             <ChartBarIcon className="h-4 w-4" />
             Insights
           </button>
        </div>
      </div>

      <div className="mt-6">
        {activeTab === 'write' && (
            <div className="animate-fadeIn">
                <JournalEditor 
                    initialEntry={editingEntry}
                    initialTemplateId={initialTemplateId}
                    onSaveComplete={handleEntrySaved}
                />
            </div>
        )}
        
        {activeTab === 'history' && (
            <div className="animate-fadeIn">
                <JournalHistory onEdit={handleEdit} />
            </div>
        )}

        {activeTab === 'insights' && (
            <div className="animate-fadeIn">
                <JournalInsights />
            </div>
        )}
      </div>

    </div>
  );
}

================================================================================
FILE: src/pages/Login.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { ShieldCheckIcon, EnvelopeIcon, LockClosedIcon } from '@heroicons/react/24/outline';

export default function Login() {
  const { loginWithGoogle, loginWithEmail, signupWithEmail, user, loading } = useAuth();
  const navigate = useNavigate();
  
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPass, setConfirmPass] = useState('');
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // --- Auto-Redirect when User is Detected ---
  useEffect(() => {
    if (user && !loading) {
      navigate('/'); 
    }
  }, [user, loading, navigate]);

  // Handle Google Login
  const handleGoogleLogin = async () => {
    try {
      setError('');
      setIsSubmitting(true);
      await loginWithGoogle();
    } catch (error) {
      console.error(error);
      setError('Failed to sign in with Google.');
      setIsSubmitting(false);
    }
  };

  // Handle Email Submit
  const handleEmailSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsSubmitting(true);

    // Basic Validation
    if (!email || !password) {
        setError("Please fill in all fields.");
        setIsSubmitting(false);
        return;
    }
    
    if (!isLogin && password !== confirmPass) {
        setError("Passwords do not match.");
        setIsSubmitting(false);
        return;
    }

    if (password.length < 6) {
        setError("Password should be at least 6 characters.");
        setIsSubmitting(false);
        return;
    }

    try {
      if (isLogin) {
        await loginWithEmail(email, password);
      } else {
        await signupWithEmail(email, password);
      }
      navigate('/'); 
    } catch (err: unknown) { // <--- FIXED: Changed to 'unknown' to satisfy TS1196
      console.error(err);
      setIsSubmitting(false); 
      
      // Safe cast to access properties
      const error = err as { code?: string }; 
      
      // Firebase error mapping
      if (error.code === 'auth/email-already-in-use') {
        setError('That email is already in use.');
      } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
        setError('Invalid email or password.');
      } else {
        setError('Failed to authenticate. Please try again.');
      }
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
             <ShieldCheckIcon className="h-10 w-10 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">
            My Recovery Toolkit
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            {isLogin ? 'Sign in to your account' : 'Create a new account'}
          </p>
        </div>

        {/* Error Message */}
        {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm text-center">
                {error}
            </div>
        )}

        {/* Email Form */}
        <form className="mt-8 space-y-4" onSubmit={handleEmailSubmit}>
            <div className="space-y-4">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <EnvelopeIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="email"
                        required
                        placeholder="Email address"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <LockClosedIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="password"
                        required
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                {!isLogin && (
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <LockClosedIcon className="h-5 w-5 text-gray-400" />
                        </div>
                        <input
                            type="password"
                            required
                            placeholder="Confirm Password"
                            value={confirmPass}
                            onChange={(e) => setConfirmPass(e.target.value)}
                            className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                        />
                    </div>
                )}
            </div>

            <button
                type="submit"
                disabled={isSubmitting || loading}
                className="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
            >
                {isSubmitting ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}
            </button>
        </form>

        <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
        </div>

        {/* Google Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={isSubmitting || loading}
          className="w-full flex items-center justify-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
        >
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="h-5 w-5 mr-2" />
          Sign in with Google
        </button>

        {/* Toggle Mode */}
        <div className="text-center mt-4">
            <p className="text-sm text-gray-600">
                {isLogin ? "Don't have an account? " : "Already have an account? "}
                <button 
                    onClick={() => {
                        setIsLogin(!isLogin);
                        setError('');
                        setEmail('');
                        setPassword('');
                        setConfirmPass('');
                    }}
                    className="font-medium text-blue-600 hover:text-blue-500"
                >
                    {isLogin ? 'Sign up' : 'Sign in'}
                </button>
            </p>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Profile.tsx
================================================================================
import { useState, useRef, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getProfile, updateProfileData } from '../lib/db';
import { importLegacyJournals } from '../lib/importer';
import { 
  UserCircleIcon, 
  ArrowLeftOnRectangleIcon, 
  ArrowUpTrayIcon, 
  CheckCircleIcon,
  ExclamationCircleIcon 
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function Profile() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  
  // --- VERSIONING ---
  const appVersion = import.meta.env.VITE_APP_VERSION || 'Dev-Local';
  
  const [displayName, setDisplayName] = useState('');
  const [sobrietyDate, setSobrietyDate] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

  // Import State
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [importing, setImporting] = useState(false);
  const [importStatus, setImportStatus] = useState<string | null>(null);

  useEffect(() => {
    async function loadProfile() {
      if (user) {
        const data = await getProfile(user.uid);
        if (data) {
          setDisplayName(data.displayName || user.displayName || '');
          // Format date for input field (YYYY-MM-DD)
          if (data.sobrietyDate) {
            setSobrietyDate(data.sobrietyDate.toDate().toISOString().split('T')[0]);
          }
        }
        setLoading(false);
      }
    }
    loadProfile();
  }, [user]);

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    setSaving(true);
    setMessage(null);

    try {
      // Create date object correctly
      let dateObj: Date | null = null;
      if (sobrietyDate) {
         const [y, m, d] = sobrietyDate.split('-').map(Number);
         // Note: Month is 0-indexed in JS Date
         dateObj = new Date(y, m - 1, d);
      }
      
      // Update in Firestore
      await updateProfileData(user.uid, {
        displayName,
        sobrietyDate: dateObj
      });

      setMessage({ type: 'success', text: 'Profile updated successfully' });
    } catch (error) {
      console.error(error);
      setMessage({ type: 'error', text: 'Failed to update profile' });
    } finally {
      setSaving(false);
    }
  };

  // --- IMPORT HANDLER ---
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;

    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
      setImportStatus('Error: Please select a valid JSON file.');
      return;
    }

    setImporting(true);
    setImportStatus('Reading file and mapping data...');

    try {
      const result = await importLegacyJournals(user.uid, file);
      setImportStatus(`Success! Imported ${result.success} entries. (${result.errors} skipped)`);
      // Clear input
      if (fileInputRef.current) fileInputRef.current.value = '';
    } catch (error) {
      console.error("Import failed", error);
      setImportStatus('Error: Import failed. Check console for details.');
    } finally {
      setImporting(false);
    }
  };

  if (loading) return <div>Loading profile...</div>;

  return (
    <div className="max-w-2xl mx-auto space-y-8 pb-10">
      <div className="flex items-center gap-4 border-b border-gray-200 pb-6">
        <div className="h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
           {user?.photoURL ? (
             <img src={user.photoURL} alt="Profile" className="h-16 w-16 rounded-full" />
           ) : (
             <UserCircleIcon className="h-10 w-10" />
           )}
        </div>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">{user?.displayName || 'User Profile'}</h1>
          <p className="text-gray-500">{user?.email}</p>
        </div>
      </div>

      {/* --- PROFILE FORM --- */}
      <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
        <div>
          <label className="block text-sm font-medium text-gray-700">Display Name</label>
          <input
            type="text"
            value={displayName}
            onChange={(e) => setDisplayName(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">Sobriety Date</label>
          <input
            type="date"
            value={sobrietyDate}
            onChange={(e) => setSobrietyDate(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
          <p className="mt-1 text-xs text-gray-500">Used to calculate your recovery stats on the dashboard.</p>
        </div>

        {message && (
          <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
            {message.text}
          </div>
        )}

        <div className="flex justify-end gap-3">
           <button
             type="submit"
             disabled={saving}
             className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
           >
             {saving ? 'Saving...' : 'Save Changes'}
           </button>
        </div>
      </form>

      {/* --- IMPORT SECTION --- */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <ArrowUpTrayIcon className="h-5 w-5 text-gray-500" />
            Import Legacy Data
        </h3>
        <p className="text-sm text-gray-600 mb-4">
            If you have a JSON backup of your journals from the old app, you can import them here. 
            This will add them to your history.
        </p>

        <div className="flex flex-col gap-4">
            <input 
                type="file" 
                accept=".json"
                ref={fileInputRef}
                onChange={handleFileChange}
                className="hidden"
            />
            
            <button 
                type="button"
                onClick={() => fileInputRef.current?.click()}
                disabled={importing}
                className="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-gray-500 hover:border-blue-500 hover:text-blue-500 transition-colors flex flex-col items-center justify-center gap-2"
            >
                {importing ? (
                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                ) : (
                    <ArrowUpTrayIcon className="h-8 w-8" />
                )}
                <span className="font-medium">{importing ? 'Importing...' : 'Click to Select JSON File'}</span>
            </button>

            {importStatus && (
                <div className={`flex items-start gap-2 text-sm p-3 rounded-md ${importStatus.includes('Success') ? 'bg-green-50 text-green-800' : 'bg-yellow-50 text-yellow-800'}`}>
                    {importStatus.includes('Success') ? (
                        <CheckCircleIcon className="h-5 w-5 flex-shrink-0" />
                    ) : (
                        <ExclamationCircleIcon className="h-5 w-5 flex-shrink-0" />
                    )}
                    {importStatus}
                </div>
            )}
        </div>
      </div>

      <div className="border-t border-gray-200 pt-6">
        <button
          onClick={handleLogout}
          className="w-full flex justify-center items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors"
        >
          <ArrowLeftOnRectangleIcon className="h-5 w-5" />
          Log Out
        </button>
      </div>

      {/* --- VERSION INFO --- */}
      <div className="text-center text-xs text-gray-400 font-mono">
          App Version: v{appVersion}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Tasks.tsx
================================================================================
import { useState, useEffect, useCallback, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { 
  collection, 
  query, 
  where, 
  orderBy, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  serverTimestamp,
  Timestamp 
} from 'firebase/firestore';
import { 
  PlusIcon, 
  BookOpenIcon, 
  TrashIcon, 
  CalendarIcon,
  SparklesIcon, 
  TrophyIcon,
  EllipsisHorizontalIcon,
  PencilSquareIcon,
  ArrowPathIcon,
  FireIcon // Added this missing import
} from '@heroicons/react/24/outline';
import { CheckCircleIcon as CheckCircleSolidIcon } from '@heroicons/react/24/solid';
import { calculateNextDueDate, getRecurrenceLabel, type RecurrenceConfig } from '../lib/dateUtils';
import TaskFormModal, { type TaskFormData } from '../components/tasks/TaskFormModal';

// --- Types ---
//

type TaskCategory = 'Recovery' | 'Health' | 'Life' | 'Work';
type TaskPriority = 'High' | 'Medium' | 'Low';
type TabOption = 'today' | 'upcoming' | 'history';

export interface Task {
  id: string;
  uid: string;
  title: string;
  category: TaskCategory;
  priority: TaskPriority;
  status: 'pending' | 'completed';
  frequency?: string; // Legacy support
  recurrence?: RecurrenceConfig;
  dueDate: Timestamp | Date | null;
  createdAt: Timestamp;
  completedAt?: Timestamp | null;
  stats?: {
    xp: number;
    attribute: 'Wisdom' | 'Vitality' | 'Willpower';
  };
}

// --- Theme Constants ---

const CATEGORY_THEME: Record<TaskCategory, { bg: string; text: string; border: string; ring: string }> = {
    Recovery: { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', ring: 'ring-cyan-500' },
    Health:   { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', ring: 'ring-emerald-500' },
    Life:     { bg: 'bg-violet-50', text: 'text-violet-700', border: 'border-violet-200', ring: 'ring-violet-500' },
    Work:     { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', ring: 'ring-amber-500' },
};

// --- Components ---

const ProgressRing = ({ percentage }: { percentage: number }) => {
  const radius = 32;
  const stroke = 5;
  const normalizedRadius = radius - stroke * 2;
  const circumference = normalizedRadius * 2 * Math.PI;
  const strokeDashoffset = circumference - (percentage / 100) * circumference;

  return (
    <div className="relative flex items-center justify-center">
      <svg
        height={radius * 2}
        width={radius * 2}
        className="transform -rotate-90"
      >
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="#3b82f6" />
                <stop offset="100%" stopColor="#10b981" />
            </linearGradient>
        </defs>
        {/* Track */}
        <circle
          stroke="rgba(255,255,255,0.3)"
          strokeWidth={stroke}
          fill="transparent"
          r={normalizedRadius}
          cx={radius}
          cy={radius}
        />
        {/* Progress */}
        <circle
          stroke="url(#progressGradient)"
          strokeWidth={stroke}
          strokeDasharray={circumference + ' ' + circumference}
          style={{ strokeDashoffset, transition: "stroke-dashoffset 1s ease-out" }}
          strokeLinecap="round"
          fill="transparent"
          r={normalizedRadius}
          cx={radius}
          cy={radius}
        />
      </svg>
      <div className="absolute flex flex-col items-center">
        <span className="text-[10px] font-bold text-white drop-shadow-sm">
          {Math.round(percentage)}%
        </span>
      </div>
    </div>
  );
};

export default function Tasks() {
  const { user } = useAuth();
  const navigate = useNavigate();

  // State
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<TabOption>('today');
  const [expandedTaskId, setExpandedTaskId] = useState<string | null>(null);

  // Modal State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Task | null>(null);

  // 1. Data Loading
  useEffect(() => {
    if (!user || !db) return;

    const q = query(
      collection(db, 'tasks'),
      where('uid', '==', user.uid),
      orderBy('createdAt', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const taskData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      } as Task));
      setTasks(taskData);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // 2. Computed Lists & Stats
  const { filteredTasks, progress } = useMemo(() => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    
    // Helper to normalize date
    const getTaskDate = (t: Task) => {
        if (!t.dueDate) return null;
        return t.dueDate instanceof Date ? t.dueDate : (t.dueDate as Timestamp).toDate();
    };

    const todayTasks: Task[] = [];
    const upcomingTasks: Task[] = [];
    const historyTasks: Task[] = [];

    let completedToday = 0;
    let totalToday = 0;

    tasks.forEach(t => {
        const d = getTaskDate(t);
        const isCompleted = t.status === 'completed';

        // History Tab: Completed items older than today
        if (isCompleted && (!d || d < now)) {
            historyTasks.push(t);
            return;
        }

        // Upcoming: Future dates
        if (d && d > now && !isCompleted) {
            upcomingTasks.push(t);
            return;
        }

        // Today: Due today/past or completed today
        todayTasks.push(t);
        totalToday++;
        if (isCompleted) completedToday++;
    });

    // Sort Today: Pending first, then Priority
    todayTasks.sort((a, b) => {
        if (a.status === b.status) {
             const pMap = { High: 3, Medium: 2, Low: 1 };
             return pMap[b.priority] - pMap[a.priority];
        }
        return a.status === 'completed' ? 1 : -1;
    });

    return {
        filteredTasks: activeTab === 'today' ? todayTasks : activeTab === 'upcoming' ? upcomingTasks : historyTasks,
        progress: totalToday === 0 ? 0 : (completedToday / totalToday) * 100
    };
  }, [tasks, activeTab]);

  // 3. Actions
  const handleToggleComplete = useCallback(async (task: Task) => {
    if (!db || !user) return;
    
    // If we are unchecking a completed task, just revert it
    if (task.status === 'completed') {
         await updateDoc(doc(db, 'tasks', task.id), {
            status: 'pending',
            completedAt: null
        });
        return;
    }

    // Completing a task
    try {
        // 1. Mark current as complete
        await updateDoc(doc(db, 'tasks', task.id), {
            status: 'completed',
            completedAt: serverTimestamp()
        });

        // 2. Check for recurrence to spawn next task
        if (task.recurrence && task.recurrence.type !== 'once') {
            const currentDueDate = task.dueDate instanceof Date 
                ? task.dueDate 
                : (task.dueDate as Timestamp).toDate();
            
            const nextDate = calculateNextDueDate(currentDueDate, task.recurrence);
            
            if (nextDate) {
                // Create the next instance
                await addDoc(collection(db, 'tasks'), {
                    ...task, // Copy all props
                    id: undefined, // Let Firebase generate new ID
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    dueDate: nextDate,
                    completedAt: null
                });
            }
        }

        if (navigator.vibrate) navigator.vibrate(50);
    } catch (e) {
        console.error("Error completing task", e);
    }
  }, [user]);

  const handleDelete = useCallback(async (id: string) => {
    if (!db) return;
    if (confirm("Delete this quest?")) {
        try {
            await deleteDoc(doc(db, 'tasks', id));
        } catch (e) {
            console.error(e);
        }
    }
  }, []);

  const handleEdit = useCallback((task: Task) => {
      setEditingTask(task);
      setIsModalOpen(true);
      setExpandedTaskId(null); // Close drawer
  }, []);

  const handleJournalReflect = useCallback((task: Task) => {
    navigate('/journal', { 
        state: { 
            initialContent: `**Reflecting on Quest: ${task.title}**\n\nHow did completing this make me feel?\n` 
        } 
    }); 
  }, [navigate]);

  const handleSaveTask = useCallback(async (data: TaskFormData) => {
    if (!user || !db) return;

    let dueDateObj: Date | null = null;
    if (data.dueDate) {
        dueDateObj = new Date(data.dueDate);
        dueDateObj.setHours(23, 59, 59);
    }

    const payload = {
        uid: user.uid,
        title: data.title,
        category: data.category,
        priority: data.priority,
        dueDate: dueDateObj || serverTimestamp(),
        recurrence: data.recurrence,
        stats: {
             xp: data.priority === 'High' ? 50 : 20,
             attribute: data.category === 'Recovery' ? 'Wisdom' : data.category === 'Health' ? 'Vitality' : 'Willpower'
        }
    };

    try {
        if (data.id) {
            // Update existing
            await updateDoc(doc(db, 'tasks', data.id), payload);
        } else {
            // Create new
            await addDoc(collection(db, 'tasks'), {
                ...payload,
                status: 'pending',
                createdAt: serverTimestamp()
            });
        }
    } catch (error) {
        console.error("Error saving task", error);
    }
  }, [user]);

  // UI Helpers
  const getPriorityBadge = (p: string) => {
      switch(p) {
          case 'High': return (
            <span className="flex items-center gap-1 text-[10px] font-bold text-red-700 bg-red-50 border border-red-100 px-2 py-0.5 rounded-full">
                <FireIcon className="h-3 w-3" /> HIGH
            </span>
          );
          case 'Medium': return null; 
          default: return <span className="text-[10px] text-gray-400 font-medium">Low Priority</span>;
      }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your quests...</div>;

  return (
    <div className="pb-24 relative min-h-screen bg-gray-50/50">
        
        {/* --- HEADER: "Vibrant Momentum" --- */}
        <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 p-6 pb-12 shadow-md relative overflow-hidden">
             {/* Background Pattern */}
             <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
             
             <div className="relative z-10 flex items-center justify-between">
                <div className="text-white">
                    <h1 className="text-2xl font-bold flex items-center gap-2 drop-shadow-md">
                        Today's Quests
                        <SparklesIcon className="h-6 w-6 text-yellow-300 animate-pulse" />
                    </h1>
                    <p className="text-blue-100 text-sm font-medium mt-1">
                        {new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}
                    </p>
                </div>
                <ProgressRing percentage={progress} />
             </div>
        </div>

        {/* --- TABS --- */}
        <div className="px-4 -mt-6 relative z-20">
            <div className="bg-white p-1.5 rounded-xl shadow-lg border border-gray-100 flex">
                {['today', 'upcoming', 'history'].map((tab) => (
                    <button
                        key={tab}
                        onClick={() => setActiveTab(tab as TabOption)}
                        className={`flex-1 py-2.5 text-xs font-bold rounded-lg transition-all capitalize tracking-wide ${
                            activeTab === tab 
                            ? 'bg-gradient-to-br from-gray-900 to-gray-800 text-white shadow-md transform scale-105' 
                            : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'
                        }`}
                    >
                        {tab}
                    </button>
                ))}
            </div>
        </div>

        {/* --- LIST AREA --- */}
        <div className="p-4 space-y-4 mt-2">
            {filteredTasks.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-16 text-center animate-fadeIn">
                    <div className="bg-white p-4 rounded-full shadow-sm mb-4">
                        <TrophyIcon className="h-10 w-10 text-yellow-400" />
                    </div>
                    <p className="text-gray-900 font-medium">All caught up for {activeTab}!</p>
                    <p className="text-sm text-gray-500 mt-1">Take a moment to breathe and reflect.</p>
                </div>
            ) : (
                filteredTasks.map(task => {
                    // FIX: Safer Theme Lookup
                    const theme = CATEGORY_THEME[task.category] || CATEGORY_THEME.Recovery;
                    
                    return (
                        <div 
                            key={task.id} 
                            className={`relative bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md ${
                                task.status === 'completed' ? 'opacity-60 grayscale-[0.5]' : ''
                            }`}
                            onClick={() => setExpandedTaskId(expandedTaskId === task.id ? null : task.id)}
                        >
                            {/* Accent Bar */}
                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${theme.bg.replace('bg-', 'bg-gradient-to-b from-')}-400 to-${theme.bg.split('-')[1]}-600`} />
                            
                            <div className="p-4 pl-5 flex items-start gap-4">
                                {/* Checkbox */}
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleToggleComplete(task); }}
                                    className="mt-0.5 flex-shrink-0 group"
                                >
                                    {task.status === 'completed' ? (
                                        <CheckCircleSolidIcon className="h-7 w-7 text-green-500 drop-shadow-sm transition-transform group-hover:scale-110" />
                                    ) : (
                                        <div className={`h-7 w-7 rounded-full border-2 border-gray-300 group-hover:${theme.border.replace('border-', 'border-')} group-hover:bg-gray-50 transition-colors`} />
                                    )}
                                </button>

                                <div className="flex-1 min-w-0 pt-0.5">
                                    <div className="flex flex-wrap items-center gap-2 mb-1.5">
                                        {getPriorityBadge(task.priority)}
                                        <span className={`flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded-full border ${theme.bg} ${theme.text} ${theme.border}`}>
                                            {task.category || 'General'}
                                        </span>
                                        {task.recurrence && task.recurrence.type !== 'once' && (
                                            <span className="flex items-center gap-1 text-[10px] text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full border border-purple-100 font-medium">
                                                <ArrowPathIcon className="h-3 w-3" />
                                                {getRecurrenceLabel(task.recurrence)}
                                            </span>
                                        )}
                                    </div>

                                    <div className={`text-sm font-medium leading-relaxed transition-all duration-300 ${
                                        task.status === 'completed' ? 'text-gray-400 line-through decoration-gray-300' : 'text-gray-800'
                                    } ${
                                        expandedTaskId === task.id ? 'whitespace-pre-wrap' : 'line-clamp-2'
                                    }`}>
                                        {task.title}
                                    </div>

                                    <div className="flex items-center gap-3 text-xs font-medium text-gray-400 mt-2.5">
                                        {task.dueDate && (
                                            <span className="flex items-center gap-1 bg-gray-50 px-1.5 py-0.5 rounded text-gray-500">
                                                <CalendarIcon className="h-3.5 w-3.5" />
                                                {new Date(
                                                    task.dueDate instanceof Date 
                                                    ? task.dueDate 
                                                    : (task.dueDate as Timestamp).toDate()
                                                ).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                            </span>
                                        )}
                                        {task.stats && (
                                            <span className="text-blue-600 flex items-center gap-1">
                                                <TrophyIcon className="h-3 w-3" />
                                                +{task.stats.xp} XP
                                            </span>
                                        )}
                                    </div>
                                </div>

                                <div className="flex-shrink-0 mt-1">
                                    <EllipsisHorizontalIcon className={`h-6 w-6 text-gray-300 transition-transform ${expandedTaskId === task.id ? 'rotate-90 text-blue-600' : ''}`} />
                                </div>
                            </div>

                            {/* Action Drawer */}
                            {expandedTaskId === task.id && (
                                <div className="bg-gray-50/80 backdrop-blur-sm border-t border-gray-100 p-2 flex justify-end gap-2 animate-fadeIn">
                                    {task.status === 'completed' && (
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); handleJournalReflect(task); }}
                                            className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-blue-600 shadow-sm hover:bg-blue-50 active:scale-95 transition-all"
                                        >
                                            <BookOpenIcon className="h-4 w-4" />
                                            Reflect
                                        </button>
                                    )}
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleEdit(task); }}
                                        className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-700 shadow-sm hover:bg-gray-100 active:scale-95 transition-all"
                                    >
                                        <PencilSquareIcon className="h-4 w-4" />
                                        Edit
                                    </button>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleDelete(task.id); }}
                                        className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-red-600 shadow-sm hover:bg-red-50 active:scale-95 transition-all"
                                    >
                                        <TrashIcon className="h-4 w-4" />
                                        Delete
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                })
            )}
        </div>

        {/* --- FLOATING ADD BUTTON --- */}
        <button
            onClick={() => { setEditingTask(null); setIsModalOpen(true); }}
            className="fixed bottom-24 right-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-full shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:scale-105 transition-all active:scale-95 z-30"
        >
            <PlusIcon className="h-7 w-7" />
        </button>

        {/* --- MODAL --- */}
        <TaskFormModal 
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            initialTask={editingTask}
            onSave={handleSaveTask}
        />
    </div>
  );
}

================================================================================
FILE: src/pages/TemplateEditor.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTemplates,
  saveUserTemplate, 
  deleteUserTemplate, 
  type JournalTemplate 
} from '../lib/db';
import { 
  PlusIcon, 
  TrashIcon, 
  PencilSquareIcon,
  XMarkIcon,
  ArrowLeftIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function TemplateEditor() {
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [templates, setTemplates] = useState<JournalTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Editor State
  const [isEditing, setIsEditing] = useState(false);
  const [currentId, setCurrentId] = useState('');
  const [name, setName] = useState('');
  const [prompts, setPrompts] = useState<string[]>(['']);
  const [tags, setTags] = useState(''); // Comma separated string for input

  useEffect(() => {
    loadTemplates();
  }, [user]);

  async function loadTemplates() {
    if (!user) return;
    const data = await getUserTemplates(user.uid);
    setTemplates(data);
    setLoading(false);
  }

  const handleEdit = (t: JournalTemplate) => {
    setCurrentId(t.id);
    setName(t.name);
    setPrompts(t.prompts.length > 0 ? t.prompts : ['']);
    setTags(t.defaultTags.join(', '));
    setIsEditing(true);
  };

  const handleCreate = () => {
    setCurrentId('');
    setName('');
    setPrompts(['']);
    setTags('');
    setIsEditing(true);
  };

  const handleDelete = async (id: string) => {
    if (!user || !window.confirm("Are you sure you want to delete this template?")) return;
    await deleteUserTemplate(user.uid, id);
    await loadTemplates();
  };

  const handlePromptChange = (idx: number, val: string) => {
    const newPrompts = [...prompts];
    newPrompts[idx] = val;
    setPrompts(newPrompts);
  };

  const addPromptLine = () => {
    setPrompts([...prompts, '']);
  };

  const removePromptLine = (idx: number) => {
    const newPrompts = prompts.filter((_, i) => i !== idx);
    setPrompts(newPrompts);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    // Clean data
    const cleanPrompts = prompts.filter(p => p.trim() !== '');
    const cleanTags = tags.split(',').map(t => t.trim()).filter(t => t !== '').map(t => t.startsWith('#') ? t : `#${t}`);

    if (!name || cleanPrompts.length === 0) {
        alert("Please provide a name and at least one prompt.");
        return;
    }

    const templateData: JournalTemplate = {
        id: currentId, // empty string means new doc
        name,
        prompts: cleanPrompts,
        defaultTags: cleanTags
    };

    await saveUserTemplate(user.uid, templateData);
    setIsEditing(false);
    await loadTemplates();
  };

  if (loading) return <div className="p-8">Loading templates...</div>;

  // --- EDITOR VIEW ---
  if (isEditing) {
    return (
        <div className="max-w-2xl mx-auto space-y-6">
            <div className="flex items-center gap-4">
                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-900">
                    <ArrowLeftIcon className="h-5 w-5" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">{currentId ? 'Edit Template' : 'New Template'}</h1>
            </div>

            <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                    <input 
                        type="text" 
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Step 10 Inventory"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Prompts (Questions)</label>
                    <div className="space-y-3">
                        {prompts.map((p, idx) => (
                            <div key={idx} className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={p}
                                    onChange={(e) => handlePromptChange(idx, e.target.value)}
                                    className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder={`Question ${idx + 1}`}
                                />
                                <button 
                                    type="button" 
                                    onClick={() => removePromptLine(idx)}
                                    className="text-red-400 hover:text-red-600 p-2"
                                    title="Remove prompt"
                                >
                                    <XMarkIcon className="h-5 w-5" />
                                </button>
                            </div>
                        ))}
                    </div>
                    <button 
                        type="button"
                        onClick={addPromptLine}
                        className="mt-3 text-sm text-blue-600 font-medium hover:text-blue-700 flex items-center gap-1"
                    >
                        <PlusIcon className="h-4 w-4" />
                        Add Question
                    </button>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Default Tags</label>
                    <input 
                        type="text" 
                        value={tags}
                        onChange={(e) => setTags(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="#step10, #inventory (comma separated)"
                    />
                </div>

                <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button 
                        type="button" 
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                        Save Template
                    </button>
                </div>
            </form>
        </div>
    );
  }

  // --- LIST VIEW ---
  return (
    <div className="max-w-3xl mx-auto space-y-6">
       <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={() => navigate('/journal')} className="text-gray-500 hover:text-gray-900 lg:hidden">
               <ArrowLeftIcon className="h-5 w-5" />
            </button>
            <h1 className="text-2xl font-bold text-gray-900">Manage Templates</h1>
          </div>
          <button 
             onClick={handleCreate}
             className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
          >
             <PlusIcon className="h-5 w-5" />
             Create New
          </button>
       </div>

       <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          {templates.length === 0 ? (
             <div className="p-8 text-center text-gray-500">
                You haven't created any custom templates yet.
             </div>
          ) : (
             <ul className="divide-y divide-gray-100">
                {templates.map((t) => (
                   <li key={t.id} className="p-4 sm:p-6 flex items-center justify-between hover:bg-gray-50 transition">
                      <div>
                         <h3 className="font-semibold text-gray-900">{t.name}</h3>
                         <p className="text-sm text-gray-500 mt-1">{t.prompts.length} questions ‚Ä¢ {t.defaultTags.join(', ')}</p>
                      </div>
                      <div className="flex items-center gap-2">
                         <button 
                            onClick={() => handleEdit(t)}
                            className="p-2 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition"
                            title="Edit"
                         >
                            <PencilSquareIcon className="h-5 w-5" />
                         </button>
                         <button 
                            onClick={() => handleDelete(t.id)}
                            className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition"
                            title="Delete"
                         >
                            <TrashIcon className="h-5 w-5" />
                         </button>
                      </div>
                   </li>
                ))}
             </ul>
          )}
       </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Vitality.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, addDoc, Timestamp } from 'firebase/firestore';
import { 
    HeartIcon, 
    FireIcon, 
    BeakerIcon, // For Nutrition/Water
    BoltIcon,   // For Energy
    //ClockIcon,
    CheckCircleIcon,
    PlayIcon,
    PauseIcon,
    ArrowPathIcon
} from '@heroicons/react/24/outline';

export default function Vitality() {
    const { user } = useAuth();
    const [saving, setSaving] = useState(false);
    
    // --- MOVEMENT STATE ---
    const [moveActivity, setMoveActivity] = useState('');
    const [moveDuration, setMoveDuration] = useState('');
    const [moveIntensity, setMoveIntensity] = useState('Moderate');
    const [moveNote, setMoveNote] = useState('');

    // --- NUTRITION STATE ---
    const [mealType, setMealType] = useState('Lunch');
    const [hungerType, setHungerType] = useState('Physical'); // vs Emotional
    const [waterCount, setWaterCount] = useState(0); // Just a daily counter visual
    const [nutriNote, setNutriNote] = useState('');

    // --- BREATHWORK STATE ---
    const [breathActive, setBreathActive] = useState(false);
    const [breathPhase, setBreathPhase] = useState('Idle'); // Inhale, Hold, Exhale
    const [breathTime, setBreathTime] = useState(0); // Seconds elapsed
    const [breathNote, setBreathNote] = useState('');

    // --- ACTIONS ---

    const saveVitalityEntry = async (category: string, title: string, contentDetails: string, note: string, tags: string[]) => {
        if (!user || !db) return;
        setSaving(true);

        const fullContent = `**${title}**\n${contentDetails}\n\n**Somatic Check-in:**\n${note || "No specific notes recorded."}`;

        try {
            await addDoc(collection(db, 'journals'), {
                uid: user.uid,
                content: fullContent,
                moodScore: 5, // Default neutral, or we could add a slider
                tags: ['Vitality', category, ...tags],
                sentiment: 'Pending',
                createdAt: Timestamp.now()
            });
            alert(`${category} Log Saved to Journal!`);
            // Reset specific fields handled by callers
        } catch (e) {
            console.error(e);
            alert("Failed to save entry.");
        } finally {
            setSaving(false);
        }
    };

    const handleLogMovement = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!moveActivity) return;
        
        const details = `*Activity:* ${moveActivity}\n*Duration:* ${moveDuration} mins\n*Intensity:* ${moveIntensity}`;
        await saveVitalityEntry('Movement', 'Movement Log üèÉ', details, moveNote, [moveActivity]);
        
        setMoveActivity('');
        setMoveDuration('');
        setMoveNote('');
    };

    const handleLogNutrition = async (e: React.FormEvent) => {
        e.preventDefault();
        
        const details = `*Meal:* ${mealType}\n*Hunger Type:* ${hungerType}`;
        await saveVitalityEntry('Nutrition', 'Fuel Log üçé', details, nutriNote, [mealType]);
        
        setNutriNote('');
    };

    // --- BREATHWORK TIMER LOGIC ---
    useEffect(() => {
        let interval: any;
        if (breathActive) {
            interval = setInterval(() => {
                setBreathTime(prev => {
                    const next = prev + 1;
                    // Simple 4-7-8 Cycle (19s total) for visual phase
                    const cycle = next % 19; 
                    if (cycle < 4) setBreathPhase('Inhale (4s)');
                    else if (cycle < 11) setBreathPhase('Hold (7s)');
                    else setBreathPhase('Exhale (8s)');
                    return next;
                });
            }, 1000);
        } else {
            setBreathPhase('Idle');
        }
        return () => clearInterval(interval);
    }, [breathActive]);

    const toggleBreath = () => setBreathActive(!breathActive);
    
    const handleLogBreath = async () => {
        const mins = Math.floor(breathTime / 60);
        const secs = breathTime % 60;
        const details = `*Session Duration:* ${mins}m ${secs}s\n*Technique:* 4-7-8 Relaxing Breath`;
        
        await saveVitalityEntry('Mindfulness', 'Breathwork Session üå¨Ô∏è', details, breathNote, ['Meditation']);
        
        setBreathTime(0);
        setBreathNote('');
        setBreathActive(false);
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6 pb-20">
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <HeartIcon className="h-8 w-8 text-rose-500" />
                Vitality & Somatic Health
            </h1>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* 1. MOVEMENT CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center gap-2 mb-4 text-orange-600 font-bold uppercase tracking-wide text-sm">
                        <FireIcon className="h-5 w-5" /> Movement
                    </div>
                    <form onSubmit={handleLogMovement} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Activity</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. Gym, Walk" 
                                    value={moveActivity}
                                    onChange={(e) => setMoveActivity(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Duration (min)</label>
                                <input 
                                    type="number" 
                                    placeholder="30" 
                                    value={moveDuration}
                                    onChange={(e) => setMoveDuration(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                    required
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Intensity</label>
                            <select 
                                value={moveIntensity}
                                onChange={(e) => setMoveIntensity(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            >
                                <option>Low (Restorative)</option>
                                <option>Moderate (Steady)</option>
                                <option>High (Intense)</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Somatic Check-In</label>
                            <textarea 
                                rows={2}
                                placeholder="How did this feel in your body? Did it shift your mood?"
                                value={moveNote}
                                onChange={(e) => setMoveNote(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            />
                        </div>

                        <button 
                            type="submit" 
                            disabled={saving}
                            className="w-full py-2 bg-orange-50 text-orange-600 hover:bg-orange-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2"
                        >
                            <CheckCircleIcon className="h-5 w-5" />
                            Log Movement
                        </button>
                    </form>
                </div>

                {/* 2. NUTRITION CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center gap-2 mb-4 text-green-600 font-bold uppercase tracking-wide text-sm">
                        <BeakerIcon className="h-5 w-5" /> Fuel & Hydration
                    </div>
                    
                    {/* Water Widget */}
                    <div className="flex items-center justify-between bg-blue-50 p-3 rounded-lg mb-4 border border-blue-100">
                        <span className="text-sm font-medium text-blue-800">Hydration</span>
                        <div className="flex items-center gap-2">
                             <button onClick={() => setWaterCount(Math.max(0, waterCount - 1))} className="p-1 hover:bg-blue-100 rounded">-</button>
                             <span className="text-xl font-bold text-blue-600">{waterCount}</span>
                             <button onClick={() => setWaterCount(waterCount + 1)} className="p-1 hover:bg-blue-100 rounded">+</button>
                             <span className="text-xs text-blue-400">glasses</span>
                        </div>
                    </div>

                    <form onSubmit={handleLogNutrition} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Meal</label>
                                <select 
                                    value={mealType}
                                    onChange={(e) => setMealType(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                >
                                    <option>Breakfast</option>
                                    <option>Lunch</option>
                                    <option>Dinner</option>
                                    <option>Snack</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Hunger Source</label>
                                <select 
                                    value={hungerType}
                                    onChange={(e) => setHungerType(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                >
                                    <option>Physical (Need Fuel)</option>
                                    <option>Emotional (Comfort)</option>
                                    <option>Boredom</option>
                                    <option>Clock (Habit)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Mindful Eating Note</label>
                            <textarea 
                                rows={2}
                                placeholder="Did you eat mindfully? How satisfied are you?"
                                value={nutriNote}
                                onChange={(e) => setNutriNote(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            />
                        </div>

                        <button 
                            type="submit" 
                            disabled={saving}
                            className="w-full py-2 bg-green-50 text-green-600 hover:bg-green-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2"
                        >
                            <CheckCircleIcon className="h-5 w-5" />
                            Log Fuel
                        </button>
                    </form>
                </div>

                {/* 3. BREATHWORK CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
                    <div className="flex items-center gap-2 mb-4 text-sky-600 font-bold uppercase tracking-wide text-sm">
                        <BoltIcon className="h-5 w-5" /> Breath & Regulation
                    </div>
                    
                    <div className="flex flex-col md:flex-row items-center gap-8">
                        {/* Visualizer */}
                        <div className="relative flex items-center justify-center w-40 h-40">
                             <div className={`absolute inset-0 bg-sky-100 rounded-full transition-all duration-[4000ms] ease-in-out ${breathPhase.includes('Inhale') ? 'scale-100 opacity-100' : breathPhase.includes('Hold') ? 'scale-100 opacity-80' : 'scale-50 opacity-50'}`}></div>
                             <div className="relative z-10 text-center">
                                 <div className="text-2xl font-bold text-sky-800">
                                     {Math.floor(breathTime / 60)}:{(breathTime % 60).toString().padStart(2, '0')}
                                 </div>
                                 <div className="text-xs font-medium text-sky-600 uppercase tracking-wider mt-1">{breathPhase}</div>
                             </div>
                        </div>

                        {/* Controls & Note */}
                        <div className="flex-1 w-full space-y-4">
                            <div className="flex gap-4">
                                <button 
                                    onClick={toggleBreath}
                                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors ${breathActive ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-sky-600 text-white hover:bg-sky-700'}`}
                                >
                                    {breathActive ? <><PauseIcon className="h-5 w-5" /> Pause</> : <><PlayIcon className="h-5 w-5" /> Start Breathing</>}
                                </button>
                                <button 
                                    onClick={() => { setBreathActive(false); setBreathTime(0); setBreathPhase('Idle'); }}
                                    className="px-4 rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50"
                                >
                                    <ArrowPathIcon className="h-5 w-5" />
                                </button>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Post-Session Reflection</label>
                                <textarea 
                                    rows={2}
                                    placeholder="What is the quality of your mind right now?"
                                    value={breathNote}
                                    onChange={(e) => setBreathNote(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                />
                            </div>

                            <button 
                                onClick={handleLogBreath}
                                disabled={breathTime < 5 || saving}
                                className="w-full py-2 bg-sky-50 text-sky-600 hover:bg-sky-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2 disabled:opacity-50"
                            >
                                <CheckCircleIcon className="h-5 w-5" />
                                Log Session to Journal
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
}

// ---

================================================================================
FILE: src/pages/WorkbookDetail.tsx
================================================================================
import { useState, useEffect, Fragment, useCallback } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { getWorkbook, type WorkbookSection } from '../data/workbooks';
import { analyzeWorkbookContent, type WorkbookAnalysisResult } from '../lib/gemini';
import { addTask } from '../lib/tasks';
import { saveInsight } from '../lib/insights'; // NEW
import { 
    ArrowLeftIcon, 
    PlayCircleIcon, 
    CheckCircleIcon, 
    SparklesIcon,
    ArrowPathIcon,
    PlusCircleIcon,
    LightBulbIcon,
    ShieldExclamationIcon,
    AcademicCapIcon,
    BookmarkIcon // NEW
} from '@heroicons/react/24/outline';
import { Dialog, Transition, RadioGroup } from '@headlessui/react';

// Define a proper interface for workbook answer data to avoid 'any'
interface WorkbookAnswer {
  workbookId: string;
  sectionId: string;
  questionId: string;
  answer: string;
  uid: string;
}

export default function WorkbookDetail() {
  const { workbookId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const workbook = getWorkbook(workbookId || '');

  // Data State
  const [completedCounts, setCompletedCounts] = useState<Record<string, number>>({});
  const [loading, setLoading] = useState(true);

  // Analysis State
  const [showWizard, setShowWizard] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisScope, setAnalysisScope] = useState<'section' | 'workbook' | 'global'>('section');
  const [selectedSectionId, setSelectedSectionId] = useState<string>(workbook?.sections[0]?.id || '');
  const [insight, setInsight] = useState<WorkbookAnalysisResult | null>(null);
  const [addedActions, setAddedActions] = useState<Set<string>>(new Set());
  const [savingInsight, setSavingInsight] = useState(false); // NEW

  // loadProgress wrapped in useCallback to stabilize the dependency for useEffect
  const loadProgress = useCallback(async () => {
    if (!user || !workbook || !db) return;
    
    try {
        const q = query(
            collection(db, 'users', user.uid, 'workbook_answers'),
            where('workbookId', '==', workbook.id)
        );
        
        const snapshot = await getDocs(q);
        const counts: Record<string, number> = {};

        snapshot.docs.forEach(docSnap => {
            const data = docSnap.data();
            if (data.sectionId) {
                counts[data.sectionId] = (counts[data.sectionId] || 0) + 1;
            }
        });

        setCompletedCounts(counts);
    } catch (error) {
        console.error("Error loading progress:", error);
    } finally {
        setLoading(false);
    }
  }, [user, workbook]);

  useEffect(() => {
    loadProgress();
  }, [loadProgress]);

  // --- AI ANALYSIS LOGIC ---

  const handleAnalyze = async () => {
    if (!user || !workbook || !db) return;

    setAnalyzing(true);
    setInsight(null);
    setAddedActions(new Set());
    setSavingInsight(false); // Reset saving

    try {
        let docsToAnalyze: WorkbookAnswer[] = [];
        let contextTitle = "";

        if (analysisScope === 'section') {
            const q = query(
                collection(db, 'users', user.uid, 'workbook_answers'),
                where('workbookId', '==', workbook.id),
                where('sectionId', '==', selectedSectionId)
            );
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            const sec = workbook.sections.find(s => s.id === selectedSectionId);
            contextTitle = sec ? sec.title : "Section Review";

        } else if (analysisScope === 'workbook') {
            const q = query(
                collection(db, 'users', user.uid, 'workbook_answers'),
                where('workbookId', '==', workbook.id)
            );
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            contextTitle = workbook.title;
        } else {
            const q = collection(db, 'users', user.uid, 'workbook_answers');
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            contextTitle = "Global Recovery Review";
        }

        if (docsToAnalyze.length === 0) {
            alert("No entries found for this selection. Try completing some questions first.");
            setAnalyzing(false);
            return;
        }

        const textContent = docsToAnalyze.map(d => `Question: ${d.questionId}\nAnswer: ${d.answer}`).join('\n\n');
        const result = await analyzeWorkbookContent(textContent, analysisScope, contextTitle);
        
        if (result) {
            setInsight(result);
            setShowWizard(false);
            setShowResult(true);
        } else {
            alert("Analysis failed. Please try again.");
        }

    } catch (error) {
        console.error(error);
        alert("An error occurred during analysis.");
    } finally {
        setAnalyzing(false);
    }
  };

  // NEW: Save Insight Log
  const handleSaveLog = async () => {
    if (!user || !insight) return;
    setSavingInsight(true);
    try {
        await saveInsight(user.uid, { type: 'workbook', ...insight });
        alert("Insight saved to Wisdom Log!");
        setSavingInsight(false); 
    } catch (error) {
        console.error("Failed to save log", error);
        setSavingInsight(false);
    }
  };

  const handleAddToHabits = async (action: string) => {
    if (!user) return;
    try {
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 3);
        await addTask(user.uid, action, 'once', 'High', dueDate);
        setAddedActions(prev => new Set(prev).add(action));
    } catch (e) {
        console.error(e);
    }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading workbook...</div>;
  if (!workbook) return <div className="p-8 text-center text-gray-500">Workbook not found.</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-8 pb-20">
      
      {/* HEADER */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
         <div className="flex flex-col md:flex-row justify-between items-start gap-4">
             <div>
                 <Link to="/workbooks" className="flex items-center gap-1 text-sm text-gray-500 hover:text-blue-600 mb-2">
                    <ArrowLeftIcon className="h-4 w-4" /> Back to Library
                 </Link>
                 <h1 className="text-3xl font-bold text-gray-900">{workbook.title}</h1>
                 <p className="text-gray-600 mt-2 max-w-2xl">{workbook.description}</p>
             </div>

             <button 
                onClick={() => setShowWizard(true)}
                className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-3 rounded-xl shadow-md hover:shadow-lg transition-all hover:scale-105"
             >
                <SparklesIcon className="h-5 w-5" />
                <span className="font-semibold">Consult Compass</span>
             </button>
         </div>
      </div>

      {/* SECTIONS LIST */}
      <div className="grid gap-4">
          {workbook.sections.map((section: WorkbookSection) => {
              const answeredCount = completedCounts[section.id] || 0;
              const totalQuestions = section.questions.filter(q => q.type !== 'read_only').length;
              const isComplete = totalQuestions > 0 && answeredCount >= totalQuestions;
              const progressPercent = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

              return (
                  <div key={section.id} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:border-blue-300 transition-all group">
                      <div className="flex items-center justify-between">
                          <div className="flex-1">
                             <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                                  {section.title}
                                  {isComplete && <CheckCircleIcon className="h-5 w-5 text-green-500" />}
                             </h3>
                              <p className="text-sm text-gray-500">{section.description}</p>
                              
                             <div className="mt-3 w-full max-w-xs bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                  <div className="bg-blue-600 h-full transition-all" style={{ width: `${progressPercent}%` }} />
                              </div>
                              <p className="text-xs text-gray-400 mt-1">{answeredCount} / {totalQuestions} completed</p>
                          </div>

                          <button 
                             onClick={() => navigate(`/workbooks/${workbook.id}/session/${section.id}`)}
                             className={`p-3 rounded-full transition-all ${isComplete ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}
                          >
                              {isComplete ? <ArrowPathIcon className="h-6 w-6" /> : <PlayCircleIcon className="h-6 w-6" />}
                          </button>
                      </div>
                  </div>
              );
          })}
      </div>

      {/* --- WIZARD MODAL (Scope Selection) --- */}
      <Transition appear show={showWizard} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowWizard(false)}>
          <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Dialog.Panel className="w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all">
               <Dialog.Title className="text-lg font-bold text-gray-900 flex items-center gap-2 mb-4">
                  <SparklesIcon className="h-6 w-6 text-purple-600" />
                  Ask the Recovery Compass
              </Dialog.Title>

              <div className="space-y-4">
                   <RadioGroup value={analysisScope} onChange={setAnalysisScope} className="space-y-3">
                      <RadioGroup.Option value="section" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Specific Section</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>

                      {analysisScope === 'section' && (
                          <div className="ml-4 pl-4 border-l-2 border-gray-100">
                              <select value={selectedSectionId} onChange={(e) => setSelectedSectionId(e.target.value)} className="w-full text-sm border-gray-300 rounded-lg">
                                   {workbook.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                              </select>
                          </div>
                      )}

                      <RadioGroup.Option value="workbook" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Full Workbook</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>

                      <RadioGroup.Option value="global" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Global Review</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>
                  </RadioGroup>

                  <div className="mt-6 flex justify-end gap-3">
                      <button onClick={() => setShowWizard(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">Cancel</button>
                      <button onClick={handleAnalyze} disabled={analyzing} className="px-6 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2">
                          {analyzing ? <ArrowPathIcon className="h-4 w-4 animate-spin" /> : <SparklesIcon className="h-4 w-4" />}
                          Analyze Now
                      </button>
                  </div>
              </div>
          </Dialog.Panel>
          </div>
        </Dialog>
      </Transition>

      {/* --- RESULT MODAL --- */}
      <Transition appear show={showResult} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowResult(false)}>
          <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
          <div className="fixed inset-0 overflow-y-auto">
            
             <div className="flex min-h-full items-center justify-center p-4">
              <Dialog.Panel className="w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all">
                  {insight && (
                      <div className="space-y-6">
                          <div className="flex justify-between items-start border-b border-gray-100 pb-4">
                              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                  <SparklesIcon className="h-6 w-6 text-purple-600" />
                                  {insight.scope_context}
                              </h2>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                               <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                  <div className="flex items-center gap-2 mb-2 text-blue-800 font-bold text-xs uppercase tracking-wide">
                                       <AcademicCapIcon className="h-4 w-4" /> Understanding
                                  </div>
                                  <p className="text-sm text-blue-900 leading-relaxed">{insight.pillars.understanding}</p>
                              </div>
                              <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                  <div className="flex items-center gap-2 mb-2 text-orange-800 font-bold text-xs uppercase tracking-wide">
                                       <ShieldExclamationIcon className="h-4 w-4" /> Blind Spots
                                  </div>
                                   <p className="text-sm text-orange-900 leading-relaxed">{insight.pillars.blind_spots}</p>
                              </div>
                              <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                  <div className="flex items-center gap-2 mb-2 text-green-800 font-bold text-xs uppercase tracking-wide">
                                      <LightBulbIcon className="h-4 w-4" /> Growth
                                  </div>
                                   <p className="text-sm text-green-900 leading-relaxed">{insight.pillars.emotional_resonance}</p>
                              </div>
                          </div>

                          <div className="bg-purple-50 p-5 rounded-xl border border-purple-100">
                              <h3 className="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                  <CheckCircleIcon className="h-5 w-5" /> Suggested Action Steps
                              </h3>
                              <ul className="space-y-2">
                                  {insight.suggested_actions.map((action, idx) => {
                                       const isAdded = addedActions.has(action);
                                       return (
                                          <li key={idx} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-purple-100">
                                              <span className="text-sm text-gray-700 font-medium">{action}</span>
                                              <button 
                                                  onClick={() => !isAdded && handleAddToHabits(action)}
                                                  disabled={isAdded}
                                                  className={`p-1.5 rounded-full transition-all ${isAdded ? 'text-green-500 bg-green-50' : 'text-purple-400 hover:text-purple-600 hover:bg-purple-50'}`}
                                              >
                                                  {isAdded ? <CheckCircleIcon className="h-6 w-6" /> : <PlusCircleIcon className="h-6 w-6" />}
                                              </button>
                                           </li>
                                      );
                                  })}
                              </ul>
                          </div>

                          <div className="mt-6 flex justify-between pt-4 border-t border-gray-100">
                                {/* LEFT: SAVE LOG */}
                                <button 
                                    type="button" 
                                    disabled={savingInsight}
                                    onClick={handleSaveLog}
                                    className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors disabled:opacity-50"
                                >
                                    <BookmarkIcon className="h-4 w-4" />
                                    {savingInsight ? "Saving..." : "Save to Wisdom Log"}
                                </button>

                                {/* RIGHT: CLOSE */}
                                <button type="button" className="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors" onClick={() => setShowResult(false)}>
                                    Close
                                </button>
                          </div>
                      </div>
                  )}
              </Dialog.Panel>
            </div>
          </div>
        </Dialog>
      </Transition>

    </div>
  );
}

================================================================================
FILE: src/pages/WorkbookSession.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useEncryption } from '../contexts/EncryptionContext'; 
import { db } from '../lib/firebase';
import { doc, getDoc, setDoc, updateDoc, arrayUnion, Timestamp } from 'firebase/firestore';
import { 
  ChevronLeftIcon, 
  CheckCircleIcon, 
  ArrowRightIcon,
  SparklesIcon
} from '@heroicons/react/24/outline';
import { getWorkbookById, type Workbook, type Section } from '../lib/workbooks';
import { getGeminiCoaching } from '../lib/gemini';

// Type definition for stored answers
type AnswerValue = string | { text: string; isEncrypted: boolean; updatedAt?: Timestamp };

export default function WorkbookSession() {
  const { workbookId, sectionId } = useParams();
  const { user } = useAuth();
  const { encrypt, decrypt } = useEncryption(); 
  const navigate = useNavigate();

  // Content State
  const [workbook, setWorkbook] = useState<Workbook | null>(null);
  const [section, setSection] = useState<Section | null>(null);
  const [loading, setLoading] = useState(true);

  // User Progress State
  const [answers, setAnswers] = useState<Record<string, string>>({});
  
  // UI State
  const [activeQuestionIndex, setActiveQuestionIndex] = useState(0);
  const [saving, setSaving] = useState(false);
  const [aiCoachLoading, setAiCoachLoading] = useState(false);
  const [aiFeedback, setAiFeedback] = useState<string | null>(null);

  // 1. Load Workbook Content & User Progress
  useEffect(() => {
    async function loadData() {
      // FIX: Added !db check to satisfy TypeScript
      if (!user || !workbookId || !sectionId || !db) return;

      try {
        // A. Load Static Workbook JSON
        const wb = await getWorkbookById(workbookId);
        if (!wb) {
          navigate('/workbooks');
          return;
        }
        setWorkbook(wb);

        const sec = wb.sections.find(s => s.id === sectionId);
        if (!sec) {
           navigate(`/workbooks/${workbookId}`);
           return;
        }
        setSection(sec);

        // B. Load User Progress from Firestore
        const progressRef = doc(db, 'users', user.uid, 'workbook_progress', workbookId);
        const snap = await getDoc(progressRef);

        if (snap.exists()) {
          const data = snap.data();
          
          // DECRYPTION LOGIC
          const rawAnswers = data.answers || {};
          const decryptedAnswers: Record<string, string> = {};

          for (const [qId, val] of Object.entries(rawAnswers)) {
             const answerVal = val as AnswerValue;
             
             if (typeof answerVal === 'object' && answerVal !== null && 'isEncrypted' in answerVal && answerVal.isEncrypted) {
                 try {
                     decryptedAnswers[qId] = await decrypt(answerVal.text);
                 } catch (e) {
                     console.error(`Failed to decrypt answer for ${qId}`, e);
                     decryptedAnswers[qId] = "üîí [Error Decrypting Data]";
                 }
             } else if (typeof answerVal === 'object' && answerVal !== null && 'text' in answerVal) {
                 decryptedAnswers[qId] = answerVal.text;
             } else if (typeof answerVal === 'string') {
                 decryptedAnswers[qId] = answerVal;
             }
          }
          setAnswers(decryptedAnswers);
        }

      } catch (error) {
        console.error("Error loading session:", error);
      } finally {
        setLoading(false);
      }
    }
    loadData();
  }, [user, workbookId, sectionId, navigate, decrypt]);

  // 2. Handle Answer Input
  const handleAnswerChange = (text: string) => {
    if (!section) return;
    const qId = section.questions[activeQuestionIndex].id;
    setAnswers(prev => ({
      ...prev,
      [qId]: text
    }));
  };

  // 3. Save Answer (with Encryption)
  const saveAnswer = async (qId: string, text: string) => {
    // FIX: Added !db check
    if (!user || !workbookId || !db) return;
    
    try {
        const progressRef = doc(db, 'users', user.uid, 'workbook_progress', workbookId);
        
        // ENCRYPTION LOGIC
        let payloadValue: AnswerValue;
        try {
            const encryptedText = await encrypt(text);
            payloadValue = {
                text: encryptedText,
                isEncrypted: true,
                updatedAt: Timestamp.now()
            };
        } catch (e) {
            console.error("Encryption failed", e);
            alert("Security Error: Could not encrypt answer. Save aborted.");
            return;
        }

        await setDoc(progressRef, {
            answers: {
                [qId]: payloadValue 
            },
            lastActive: Timestamp.now(),
            lastSectionId: sectionId
        }, { merge: true });

    } catch (e) {
        console.error("Failed to save answer:", e);
    }
  };

  // 4. Navigation & Completion
  const handleNext = async () => {
    // FIX: Added !db check
    if (!section || !workbookId || !user || !db) return;
    
    const currentQ = section.questions[activeQuestionIndex];
    const currentAns = answers[currentQ.id];
    
    setSaving(true);
    if (currentAns) {
        await saveAnswer(currentQ.id, currentAns);
    }

    if (activeQuestionIndex < section.questions.length - 1) {
        setActiveQuestionIndex(prev => prev + 1);
        setAiFeedback(null); 
    } else {
        await updateDoc(doc(db, 'users', user.uid, 'workbook_progress', workbookId), {
            completedSections: arrayUnion(sectionId)
        });
        navigate(`/workbooks/${workbookId}`);
    }
    setSaving(false);
  };

  const handlePrevious = () => {
    if (activeQuestionIndex > 0) {
        setActiveQuestionIndex(prev => prev - 1);
        setAiFeedback(null);
    }
  };

  const handleGetCoaching = async () => {
      if (!section) return;
      const q = section.questions[activeQuestionIndex];
      const ans = answers[q.id];
      if (!ans || ans.length < 10) return alert("Please write a bit more before asking for coaching.");

      setAiCoachLoading(true);
      try {
          const feedback = await getGeminiCoaching(q.text, ans);
          setAiFeedback(feedback);
      } catch (error) {
          console.error(error);
          alert("Coach is currently unavailable.");
      } finally {
          setAiCoachLoading(false);
      }
  };


  if (loading || !section) return <div className="p-8 text-center text-gray-500">Loading Session...</div>;

  const currentQuestion = section.questions[activeQuestionIndex];
  const progressPercent = ((activeQuestionIndex) / section.questions.length) * 100;

  return (
    <div className="max-w-3xl mx-auto px-4 pb-20">
        
        {/* NAV HEADER */}
        <div className="flex items-center gap-4 py-6">
            <button onClick={() => navigate(`/workbooks/${workbookId}`)} className="p-2 hover:bg-gray-100 rounded-full text-gray-500">
                <ChevronLeftIcon className="h-6 w-6" />
            </button>
            <div className="flex-1">
                <h1 className="text-sm font-bold text-gray-500 uppercase tracking-wider">{workbook?.title}</h1>
                <h2 className="text-xl font-bold text-gray-900">{section.title}</h2>
            </div>
        </div>

        {/* PROGRESS BAR */}
        <div className="w-full bg-gray-100 h-2 rounded-full mb-8">
            <div 
                className="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-out" 
                style={{ width: `${progressPercent}%` }}
            />
        </div>

        {/* QUESTION CARD */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[60vh] flex flex-col">
            
            <div className="p-6 md:p-8 bg-gray-50 border-b border-gray-100">
                <span className="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold mb-4">
                    Question {activeQuestionIndex + 1} of {section.questions.length}
                </span>
                <h3 className="text-xl md:text-2xl font-bold text-gray-900 leading-relaxed">
                    {currentQuestion.text}
                </h3>
                {currentQuestion.helperText && (
                    <p className="mt-2 text-gray-500 text-sm">
                        {currentQuestion.helperText}
                    </p>
                )}
            </div>

            <div className="flex-1 p-6 md:p-8 flex flex-col">
                <textarea
                    className="flex-1 w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-lg text-gray-700 leading-relaxed bg-white"
                    placeholder="Type your answer here..."
                    value={answers[currentQuestion.id] || ''}
                    onChange={(e) => handleAnswerChange(e.target.value)}
                />
                
                {/* AI COACHING AREA */}
                {aiFeedback && (
                    <div className="mt-6 bg-purple-50 p-4 rounded-xl border border-purple-100 animate-fadeIn">
                        <div className="flex items-center gap-2 mb-2 text-purple-800 font-bold">
                            <SparklesIcon className="h-5 w-5" />
                            <span>Coach's Insight</span>
                        </div>
                        {/* FIX: Replaced ReactMarkdown with simpler whitespace formatting to avoid dependency */}
                        <div className="prose prose-sm text-purple-900 max-w-none whitespace-pre-wrap leading-relaxed">
                            {aiFeedback}
                        </div>
                    </div>
                )}
            </div>

            <div className="p-4 border-t border-gray-100 bg-gray-50 flex items-center justify-between">
                <button
                    onClick={handlePrevious}
                    disabled={activeQuestionIndex === 0}
                    className="px-6 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-200 disabled:opacity-30 disabled:hover:bg-transparent transition-colors"
                >
                    Back
                </button>

                <div className="flex gap-2">
                    <button
                        onClick={handleGetCoaching}
                        disabled={aiCoachLoading || !answers[currentQuestion.id]}
                        className="hidden sm:flex items-center gap-2 px-4 py-3 rounded-xl text-purple-700 bg-purple-100 hover:bg-purple-200 font-medium transition-colors disabled:opacity-50"
                        title="Get AI feedback on your answer"
                    >
                        {aiCoachLoading ? <SparklesIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />}
                        <span>AI Coach</span>
                    </button>

                    <button
                        onClick={handleNext}
                        disabled={saving}
                        className="flex items-center gap-2 px-8 py-3 rounded-xl bg-gray-900 text-white font-bold hover:bg-black transition-all shadow-lg hover:shadow-xl active:scale-95"
                    >
                        {saving ? (
                            <span>Saving...</span>
                        ) : activeQuestionIndex === section.questions.length - 1 ? (
                            <>
                                <span>Complete</span>
                                <CheckCircleIcon className="h-5 w-5" />
                            </>
                        ) : (
                            <>
                                <span>Next</span>
                                <ArrowRightIcon className="h-5 w-5" />
                            </>
                        )}
                    </button>
                </div>
            </div>

        </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Workbooks.tsx
================================================================================
import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import { WORKBOOKS } from '../data/workbooks';
import { 
    BookOpenIcon, 
    StarIcon, 
    HeartIcon, 
    AcademicCapIcon,
    SparklesIcon,
    FireIcon,
    ChevronRightIcon
} from '@heroicons/react/24/outline';

export default function Workbooks() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
      activeCount: 0,
      wisdomScore: 0,
      mastery: 0
  });

  useEffect(() => {
    async function loadStats() {
        if (!user || !db) return;
        
        try {
            // Fetch all answers to calculate stats
            const colRef = collection(db, 'users', user.uid, 'workbook_answers');
            const snapshot = await getDocs(colRef);
            
            // 1. Wisdom Score (Total Answers)
            const wisdomScore = snapshot.size;

            // 2. Active Workbooks (Count unique workbook IDs from doc IDs "workbookId_sectionId")
            const uniqueWorkbooks = new Set<string>();
            snapshot.docs.forEach(doc => {
                const [wbId] = doc.id.split('_');
                if (wbId) uniqueWorkbooks.add(wbId);
            });
            const activeCount = uniqueWorkbooks.size;

            // 3. Mastery (Approximate % based on a fixed total for now, or dynamic)
            // Assuming ~45 questions total across current workbooks as a baseline for 100% mastery visually
            // In a real app, you'd calculate total available questions dynamically.
            const TOTAL_ESTIMATED_QUESTIONS = 45; 
            const mastery = Math.min(100, Math.round((wisdomScore / TOTAL_ESTIMATED_QUESTIONS) * 100));

            setStats({ activeCount, wisdomScore, mastery });
        } catch (error) {
            console.error("Failed to load workbook stats", error);
        } finally {
            setLoading(false);
        }
    }
    loadStats();
  }, [user]);

  const getTheme = (type: string) => {
    switch (type) {
      case 'general': return { color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-l-yellow-500', icon: StarIcon };
      case 'steps': return { color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-l-blue-600', icon: BookOpenIcon };
      default: return { color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-l-purple-500', icon: HeartIcon };
    }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your library...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-8 pb-20">
      
      {/* --- HEADER (Matches Tasks Style) --- */}
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <AcademicCapIcon className="h-8 w-8 text-blue-600" />
                Recovery Library
            </h1>
            <p className="text-sm text-gray-500 mt-1">Structured guides to process your journey.</p>
          </div>
      </div>

      {/* --- MINI STATS GRID --- */}
      <div className="grid grid-cols-3 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Active</span>
              <span className="text-2xl font-bold text-gray-900">{stats.activeCount}</span>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Wisdom Score</span>
              <div className="flex items-center gap-1 text-2xl font-bold text-cyan-600">
                  <SparklesIcon className="h-6 w-6" />
                  {stats.wisdomScore}
              </div>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Mastery</span>
              <div className="flex items-center gap-1 text-2xl font-bold text-indigo-600">
                  <FireIcon className="h-6 w-6" />
                  {stats.mastery}%
              </div>
          </div>
      </div>

      {/* --- WORKBOOK LIST (Quest Card Style) --- */}
      <div className="space-y-4">
        {WORKBOOKS.map((workbook) => {
            const theme = getTheme(workbook.type);
            
            return (
                <Link 
                    key={workbook.id} 
                    to={`/workbooks/${workbook.id}`}
                    className={`block relative group bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all hover:shadow-md ${theme.border} border-l-[6px]`}
                >
                    <div className="flex items-start gap-4">
                        
                        {/* Icon Badge */}
                        <div className={`flex-shrink-0 h-10 w-10 rounded-lg flex items-center justify-center ${theme.bg} ${theme.color}`}>
                            <theme.icon className="h-6 w-6" />
                        </div>

                        {/* Content */}
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-1">
                                <h3 className="text-lg font-bold text-gray-900 group-hover:text-blue-700 transition-colors">
                                    {workbook.title}
                                </h3>
                                <ChevronRightIcon className="h-5 w-5 text-gray-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
                            </div>
                            
                            <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                                {workbook.description}
                            </p>

                            {/* Metadata Chips */}
                            <div className="flex items-center gap-3">
                                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${theme.bg} ${theme.color} border-transparent`}>
                                    {workbook.sections.length} Sections
                                </span>
                                {workbook.type === 'steps' && (
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                        12-Step Compatible
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </Link>
            );
        })}
      </div>
    </div>
  );
}

================================================================================
FILE: src/test/setup.ts
================================================================================
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// Runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
});

================================================================================
FILE: src/vite-env.d.ts
================================================================================
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_FIREBASE_API_KEY: string;
  readonly VITE_FIREBASE_AUTH_DOMAIN: string;
  readonly VITE_FIREBASE_PROJECT_ID: string;
  readonly VITE_FIREBASE_STORAGE_BUCKET: string;
  readonly VITE_FIREBASE_MESSAGING_SENDER_ID: string;
  readonly VITE_FIREBASE_APP_ID: string;
  readonly VITE_APP_VERSION: string; // NEW
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}

================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Unified Blue Theme (from Master Tech Doc)
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8', // Primary Brand Color
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}


================================================================================
FILE: tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ],
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"],
    // ... existing options
  }
}


================================================================================
FILE: tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

