PROJECT EXPORT - 2025-12-31T14:44:04.509Z
ENVIRONMENT: PRODUCTION_READY_V4.8 (Architectural Edition)
NOTE: Includes Source Code, CI/CD Workflows, and Documentation.

### DIRECTORY STRUCTURE ###
‚îú‚îÄ‚îÄ .eslintrc.json
‚îú‚îÄ‚îÄ .github
‚îÇ   ‚îî‚îÄ‚îÄ workflows
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ .husky
‚îÇ   ‚îú‚îÄ‚îÄ _
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .gitignore
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ applypatch-msg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commit-msg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ h
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ husky.sh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-applypatch
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-checkout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-commit
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-merge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ post-rewrite
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-applypatch
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-auto-gc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-commit
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-merge-commit
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-push
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre-rebase
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prepare-commit-msg
‚îÇ   ‚îî‚îÄ‚îÄ pre-commit
‚îú‚îÄ‚îÄ AI_Maintenance.md
‚îú‚îÄ‚îÄ AI_WORKFLOW.md
‚îú‚îÄ‚îÄ Logo.png
‚îú‚îÄ‚îÄ Logo.png:Zone.Identifier
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ check_models.js
‚îú‚îÄ‚îÄ eslint.config.js
‚îú‚îÄ‚îÄ firebase.json
‚îú‚îÄ‚îÄ firestore.indexes.json
‚îú‚îÄ‚îÄ firestore.rules
‚îú‚îÄ‚îÄ generate_icons.py
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îú‚îÄ‚îÄ Marketing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 1000004496.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ David_The_Fresh_Start.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Gemini_Generated_Image_esxn5fesxn5fesxn.png:Zone.Identifier
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Lisa_The_Service_Pro.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Ned_The_Pink_Cloud.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Walt_The_Zen_Master.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ slice_personas.py
‚îÇ   ‚îú‚îÄ‚îÄ apple-touch-icon-180x180.png
‚îÇ   ‚îú‚îÄ‚îÄ maskable-icon-512x512.png
‚îÇ   ‚îú‚îÄ‚îÄ personas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ david.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lisa.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ned.jpg
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ walt.jpg
‚îÇ   ‚îú‚îÄ‚îÄ pwa-192x192.png
‚îÇ   ‚îî‚îÄ‚îÄ pwa-512x512.png
‚îú‚îÄ‚îÄ pwa-assets
‚îú‚îÄ‚îÄ scripts
‚îÇ   ‚îú‚îÄ‚îÄ generate-build-info.js
‚îÇ   ‚îú‚îÄ‚îÄ increment-version.cjs
‚îÇ   ‚îî‚îÄ‚îÄ seed-personas.js
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ App.css
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îú‚îÄ‚îÄ __tests__
‚îÇ   ‚îú‚îÄ‚îÄ components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminGrant.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AppShell.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateTaskModal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ErrorBoundary.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RecoveryHero.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SOSModal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SobrietyCounter.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VaultGate.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VersionBadge.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VibrantHeader.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AnalyticsCharts.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeduplicationTool.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ErrorLogViewer.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SchemaMigration.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserDirectory.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ journal
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JournalAnalysisWizard.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JournalEditor.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JournalHistory.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JournalInsights.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JournalTabs.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TemplateEditor.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DataManagement.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TaskFormModal.tsx
‚îÇ   ‚îú‚îÄ‚îÄ contexts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EncryptionContext.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LayoutContext.tsx
‚îÇ   ‚îú‚îÄ‚îÄ data
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workbooks.ts
‚îÇ   ‚îú‚îÄ‚îÄ hooks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useDeepPatternAnalysis.ts
‚îÇ   ‚îú‚îÄ‚îÄ index.css
‚îÇ   ‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crypto.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dateUtils.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exporter.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ firebase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gamification.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gemini.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ googleDrive.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grouping.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ importer.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ insights.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ journal.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theme.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ versioning.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ weather.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workbooks.ts
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx
‚îÇ   ‚îú‚îÄ‚îÄ pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminDashboard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InsightsLog.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Journal.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Profile.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tasks.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TemplateEditor.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserGuide.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Vitality.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Welcome.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WorkbookDetail.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WorkbookSession.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Workbooks.tsx
‚îÇ   ‚îú‚îÄ‚îÄ test
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ setup.ts
‚îÇ   ‚îî‚îÄ‚îÄ vite-env.d.ts
‚îú‚îÄ‚îÄ tailwind.config.js
‚îú‚îÄ‚îÄ tsconfig.app.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ tsconfig.node.json
‚îî‚îÄ‚îÄ vite.config.ts


### SOURCE FILES ###

--- START_FILE: .github/workflows/deploy.yml ---
name: Deploy to Firebase (Multi-Environment)

on:
  push:
    branches:
      - main
      - 'release/*'
      - 'feature/*'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    # --- LINTER FIX: Initialize empty vars so VS Code doesn't complain ---
    env:
      FIREBASE_PROJECT_ID: ""
      SERVICE_ACCOUNT_JSON: ""
      VITE_FIREBASE_API_KEY: ""
      VITE_FIREBASE_AUTH_DOMAIN: ""
      VITE_FIREBASE_PROJECT_ID: ""
      VITE_FIREBASE_STORAGE_BUCKET: ""
      VITE_FIREBASE_MESSAGING_SENDER_ID: ""
      VITE_FIREBASE_APP_ID: ""
      VITE_FIREBASE_MEASUREMENT_ID: ""
      VITE_APP_VERSION: ""

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # --- VERSIONING STEP (Updated filename to .cjs) ---
      - name: Increment Version
        id: versioning
        run: node scripts/increment-version.cjs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          # GH_PAT: ${{ secrets.GH_PAT }} 

      # --- 1. SET ENVIRONMENT VARIABLES ---
      
      # DEV Environment
      - name: Set Env Vars (DEV)
        if: startsWith(github.ref, 'refs/heads/feature/')
        run: |
          echo "FIREBASE_PROJECT_ID=mrt2-app-dev" >> $GITHUB_ENV
          
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID_DEV }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_DEV }}" >> $GITHUB_ENV
          
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV_BASE64 }}" | base64 -d > ./service-account.json

      # UAT Environment
      - name: Set Env Vars (UAT)
        if: startsWith(github.ref, 'refs/heads/release/')
        run: |
          echo "FIREBASE_PROJECT_ID=mrt2-app-uat" >> $GITHUB_ENV
          
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID_UAT }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_UAT }}" >> $GITHUB_ENV

          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_UAT_BASE64 }}" | base64 -d > ./service-account.json

      # PROD Environment
      - name: Set Env Vars (PROD)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "FIREBASE_PROJECT_ID=mrt2-app-prod" >> $GITHUB_ENV
          
          echo "VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID_PROD }}" >> $GITHUB_ENV
          echo "VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID_PROD }}" >> $GITHUB_ENV

          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD_BASE64 }}" | base64 -d > ./service-account.json

      # --- LOAD SERVICE ACCOUNT CONTENT ---
      - name: Load Service Account JSON
        run: |
          echo "SERVICE_ACCOUNT_JSON<<EOF" >> $GITHUB_ENV
          cat ./service-account.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # --- 2. BUILD APPLICATION ---

      - name: Build Application
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ env.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ env.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ env.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ env.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ env.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ env.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ env.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
          VITE_APP_VERSION: ${{ env.VITE_APP_VERSION }}

      # --- 3. DEPLOY TO FIREBASE HOSTING ---

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: "${{ env.SERVICE_ACCOUNT_JSON }}"
          projectId: "${{ env.FIREBASE_PROJECT_ID }}"
          channelId: live
--- END_FILE: .github/workflows/deploy.yml ---

--- START_FILE: AI_Maintenance.md ---

# üõ†Ô∏è The Maintenance Protocol (v1.0)

**Project:** My Recovery Toolkit (MRT)
**Objective:** Automate the "Shadow Processes" of documentation, data mapping, and debt reduction to prevent system rot.

---

## Protocol A: The Schema Sync (Data Dictionary)

**Frequency:** Weekly, or after modifying `types.ts`.
**Goal:** Keep a human-readable map of the database structure so we don't forget field names or types.

**Prompt:**
```text
I am uploading `src/types/index.ts` (or relevant type definitions) and `src/lib/gemini.ts`.

Task: Generate a "Data Dictionary" table for our Master Documentation.
1. List every Firestore Collection (e.g., `users`, `journals`, `workbooks`).
2. For each collection, list the Fields, their Data Types, and Description.
3. Highlight any "Virtual Fields" (fields that exist in the App Type but not in the DB, e.g., derived state).
4. Note any fields that are "Legacy/Optional" (marked with `?`).

```

---

## Protocol B: The Debt Ledger (Technical Debt Sweep)

**Frequency:** Bi-Weekly.
**Goal:** Surface hidden TODOs, hacks, and loose typing before they cause bugs.

**Prompt:**

```text
I am providing a full codebase dump.

Task: Perform a "Technical Debt Audit".
1. Scan for comments containing `TODO`, `FIXME`, or `HACK`.
2. Scan for usage of `any` type or `@ts-ignore`.
3. Scan for "Magic Numbers" or hardcoded strings that should be constants.

Output a prioritized "Debt Ledger" table:
- Severity (High/Med/Low)
- File Path
- Issue Description
- Suggested Fix Strategy

```

---

## Protocol C: The Release Scribe (Changelog)

**Frequency:** Before pushing to Production.
**Goal:** Translate technical git commits into a user-friendly update list.

**Prompt:**

```text
I am providing the list of Git Commits since the last release (or a summary of features built).

Task: Write the "What's New" release notes for the end users.
1. Tone: Encouraging, professional, recovery-focused.
2. Grouping: Group updates by "New Features," "Improvements," and "Fixes."
3. Translation: Translate technical terms (e.g., "Refactored Recharts debounce") into user benefits (e.g., "Smoother charts that load faster").


--- END_FILE: AI_Maintenance.md ---

--- START_FILE: AI_WORKFLOW.md ---

# üöÄ The Recursive Build Protocol (v1.2)

**Project:** My Recovery Toolkit (MRT)
**Objective:** Maintain high-velocity, error-free feature delivery by enforcing strict context ingestion, architectural planning, and anti-regression coding standards.

---

## üîÅ The Core Loop

The workflow follows a 4-phase cycle. **Do not skip phases.**

1. **Ingestion:** Loading the AI with the current state of reality.
2. **Definition:** Stating the intent and asking for strategy.
3. **Execution:** Authorizing the code generation with strict constraints.
4. **Crystallization:** Updating the Master Guide and Decision Records.

---

## Phase 1: Ingestion (Start of Session)

**Trigger:** Start of a new chat or after a massive code change.
**Goal:** Ensure the AI creates code based on the *actual* file structure, not its training memory.

**Action:** Upload `Master Build Guide v3.3.docx` and a full text dump of the codebase.

**Prompt:**

```text
I am providing the updated Master Build Guide (v3.3) and a complete source code dump.

The Goal:
1. Internalize Architecture: Ingest the current file structure, contexts (Auth, Layout, Encryption), and libraries.
2. Code Verification: Review the source code against the Master Guide to ensure the implementation matches the documentation.
3. Readiness Check: Confirm strict typing and safety guards are present.

Please confirm you have processed both the guide and the code, and provide a high-level summary of the "Source-to-Doc" integrity before we begin the next feature build.

```

---

## Phase 2: Definition (The Strategy)

**Trigger:** You want to build a new feature or refactor an existing one.
**Goal:** Force the AI to think about *Architecture*, *Data Shapes*, and *Risks* before writing code.

**Prompt Template (Feature Kickoff):**

```text
Subject: Feature Kickoff Request - [Feature Name]
Context: [Brief description of what you want to achieve]

Your Instructions:
1. Architectural Analysis (Context First):
   - Review the Master Build Guide and current file structure.
   - Identify which existing components, hooks, or contexts will be impacted.
   - Safety Check: Identify risks (e.g., PWA offline syncing, Auth state, Legacy Data compatibility).

2. Data & Query Analysis:
   - Will this require a new Firebase Query? If using complex filters (where + orderBy), explicitly state if a Composite Index is needed.
   - Are we changing a data model? (e.g., `mood` vs `moodScore`). How will we handle old data that lacks this field?

3. Modernization Scan:
   - Check related code for "Tech Debt" (e.g., loose typing, unused imports).
   - Are there newer React or Firebase patterns we should utilize?

4. Strategy Proposal (The Rule of 3):
   - Option A (Conservative): Quickest implementation, minimal impact.
   - Option B (Refactored/Modern - RECOMMENDED): Best balance of clean code and maintenance.
   - Option C (Robust/Scalable): High-performance/Over-engineered approach.

5. The Recommendation:
   - Select the best option.
   - Explain why it fits our "Production Readiness" standard.

6. STOP AND WAIT:
   - DO NOT generate code yet.
   - Present the analysis and wait for my formal approval.

```

---

## Phase 3: Execution (The Build)

**Trigger:** The AI has presented a plan, and you have chosen an option.
**Goal:** Generate copy-paste safe code that passes Linting/TypeScript checks on the first try.

**Prompt Template (The Approval Validator v2.2):**

```text
I formally approve the recommended approach. Please proceed with implementing the approved changes.

Instructions for Code Generation:

1. Alignment & Strategy:
   - Briefly restate the core objective to confirm alignment.

2. Full File Output (CRITICAL):
   - No Snippets: Provide the entire content of every modified file from top to bottom.
   - No Placeholders: Do NOT use "// ... rest of code" or "// ... imports".
   - Context: I need the complete, copy-pasteable file state.

3. Strict TypeScript & Linting Compliance (Zero-Tolerance):
   - Type-Only Imports: You MUST use `import type { ... }` for interfaces/types (Fixes verbatimModuleSyntax).
   - Discriminating Unions: If handling Union types (e.g., `Journal | Workbook`), check the `type` property BEFORE accessing unique fields.
   - Intermediate Casting: If spreading raw DB data into a strict type, cast to `unknown` first (e.g., `as unknown as JournalEntry`) to avoid "insufficient overlap" errors.
   - Icon Verification: Double-check that every Icon component used in JSX is actually imported.
   - React Refresh: If exporting a Provider and Hook in the same file, append `// eslint-disable-next-line react-refresh/only-export-components`.

4. Anti-Regression & Fail-Safe Protocol:
   - Fail-Safe Lists: When mapping over external data (e.g., `snapshot.docs.map`), wrap the logic in a `try/catch` block or return a fallback object so one bad entry does not crash the whole list.
   - Legacy Data Support: Always provide fallbacks for missing fields (e.g., `entry.moodScore || 0`) to support older data.
   - Guard Clauses: Always include `if (!user)` or `if (!db)` guards before Firebase calls.

5. Quality Assurance & Layout:
   - Layout Stability: If using Flexbox with Graphs/Charts (Recharts), apply `min-w-0` to the container to prevent layout collapse.
   - Syntax: Verify that all closing brackets `})` and XML tags are matched.
   - Unused Code: Rigorously remove unused variables and imports.

6. Deliverable:
   - Include the file path/name at the top of each code block.
   - Provide a relevant GitHub commit message at the end.

Please generate the complete updated files now.

```

---

## Phase 4: Crystallization (Documentation)

**Trigger:** The code is implemented and tested.
**Goal:** Update the "Source of Truth" and capture "Why" decisions.

**Prompt:**

```text
The feature is now implemented and verified.

1. Master Build Guide Update:
   - Provide the exact text to insert/replace in the current Master Build Guide.
   - Update the "Change Log" table.

2. Architectural Decision Record (ADR):
   - IF this feature involved a significant architectural choice (e.g., choosing a specific library, data structure, or pattern):
   - Generate a short markdown entry titled "ADR-[00X]-[Decision Name]".
   - Context: What was the problem?
   - Decision: What Option did we choose?
   - Consequences: What are the trade-offs?

3. Status:
   - Mark the item as "Done" in the Roadmap table if applicable.

```

```

```
--- END_FILE: AI_WORKFLOW.md ---

--- START_FILE: README.md ---
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

--- END_FILE: README.md ---

--- START_FILE: firestore.rules ---
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Checks if the authenticated user's ID matches the requested ID
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Checks if the document being accessed belongs to the user (for existing docs)
    function isResourceOwner() {
      return request.auth != null && resource.data.uid == request.auth.uid;
    }

    // Checks if the document being created is tagged with the user's ID
    function isCreatingOwnedResource() {
      return request.auth != null && request.resource.data.uid == request.auth.uid;
    }

    // Checks if the user has the 'admin' role in their profile
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- COLLECTION RULES ---

    // 1. User Profiles (Root Document Only)
    // Admins can read/write PROFILES (Metadata, Roles), but NOT subcollections
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // 1b. User Subcollections (The Vault)
    // Covers: /users/{uid}/workbook_answers, /users/{uid}/templates, etc.
    // STRICTLY OWNER ONLY - Admins cannot peek here
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // 2. Journals (Root Collection)
    match /journals/{entryId} {
      allow create: if isCreatingOwnedResource();
      allow read, update, delete: if isResourceOwner();
    }

    // 3. Tasks (Root Collection)
    match /tasks/{taskId} {
      allow create: if isCreatingOwnedResource();
      allow read, update, delete: if isResourceOwner();
    }

    // 4. Insights / Wisdom Log (Root Collection)
    match /insights/{insightId} {
      allow create: if isCreatingOwnedResource();
      allow read, update, delete: if isResourceOwner();
    }

    // 5. AI Analytics Logs
    match /ai_logs/{logId} {
      allow create: if request.auth != null;
      allow read: if isAdmin();
    }

    // 6. Client Error Logs (NEW)
    match /client_errors/{errorId} {
      // Any user (even unauthenticated if logic permits, but let's stick to auth) can report a crash
      allow create: if request.auth != null; 
      allow read, delete: if isAdmin();
    }
  }
}
--- END_FILE: firestore.rules ---

--- START_FILE: package.json ---
{
  "name": "mrt2",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "lint:fix": "eslint . --ext ts,tsx --fix",
    "test": "vitest",
    "test:watch": "vitest --watch",
    "preview": "vite preview",
    "prepare": "husky"
  },
  "lint-staged": {
    "src/**/*.{ts,tsx}": [
      "eslint --fix",
      "vitest related --run"
    ]
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@headlessui/react": "^2.2.9",
    "@heroicons/react": "^2.2.0",
    "@tanstack/react-query": "^5.66.0",
    "date-fns": "^4.1.0",
    "firebase": "^12.6.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-confetti": "^6.4.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "react-virtuoso": "^4.12.5",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@testing-library/user-event": "^14.6.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@typescript-eslint/eslint-plugin": "^8.50.0",
    "@typescript-eslint/parser": "^8.50.0",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "clsx": "^2.1.1",
    "eslint": "^9.39.2",
    "eslint-plugin-react": "^7.37.5",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.26",
    "globals": "^16.5.0",
    "husky": "^9.1.7",
    "jsdom": "^27.3.0",
    "lint-staged": "^16.2.7",
    "postcss": "^8.5.6",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "3.4",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0",
    "vitest": "^4.0.16"
  }
}
--- END_FILE: package.json ---

--- START_FILE: vite.config.ts ---
import { VitePWA } from 'vite-plugin-pwa';
import react from '@vitejs/plugin-react';
// We use the vitest-augmented version to satisfy both the TypeScript compiler and ESLint rules.
import { defineConfig as defineVitestConfig } from 'vitest/config';

export default defineVitestConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      // UPDATED: Matches the specific filenames generated by the python script
      // Removed 'mask-icon.svg' as we didn't generate an SVG
      includeAssets: ['favicon.ico', 'apple-touch-icon-180x180.png', 'maskable-icon-512x512.png'],
      manifest: {
        name: 'My Recovery Toolkit',
        short_name: 'MRT',
        description: 'A Buddhist-inspired and 12-step recovery companion toolkit.',
        theme_color: '#2563eb',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'any' // Explicitly set to 'any'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any' // Standard large icon
          },
          {
            // UPDATED: Added the specific maskable icon we generated
            src: 'maskable-icon-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'maskable' // Crucial for Android Adaptive Icons
          }
        ]
      },
      // --- PRESERVED: FIREBASE AUTH & CACHING FIXES ---
      workbox: {
        // 1. CRITICAL: Ignore Firebase Auth URLs so the popup works
        navigateFallbackDenylist: [
            /^\/__\/auth/, 
            /^\/__\/firebase/
        ],
        
        // 2. Performance Caching
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
            {
                urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
                handler: 'CacheFirst',
                options: {
                    cacheName: 'google-fonts-cache',
                    expiration: {
                        maxEntries: 10,
                        maxAgeSeconds: 60 * 60 * 24 * 365 // 1 year
                    },
                    cacheableResponse: {
                        statuses: [0, 200]
                    }
                }
            },
            {
                urlPattern: /^https:\/\/firebasestorage\.googleapis\.com\/.*/i,
                handler: 'StaleWhileRevalidate',
                options: {
                    cacheName: 'firebase-storage-cache',
                    expiration: {
                        maxEntries: 50
                    }
                }
            }
        ]
      }
      // ----------------------------------------------
    })
  ],
  // --- ADDED: SERVER CONFIG FOR DEV TUNNELS (PORT 5175) ---
  server: {
    host: true, // Binds to 0.0.0.0 so the tunnel can see it
    port: 5175, // Forces port 5175 to match your current instance
    strictPort: true, // Prevents it from jumping to 5176 if 5175 bumps
    watch: {
        usePolling: true, // Helps if you are in a Docker container or remote VM
    }
  },
  // --- PRESERVED: VITEST CONFIGURATION ---
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
    css: true,
  },
  // --- NEW ADDITION: CHUNK SIZE OPTIMIZATION ---
  build: {
    chunkSizeWarningLimit: 1000, 
    rollupOptions: {
      output: {
        manualChunks(id) {
          if (id.includes('node_modules')) {
            if (id.includes('firebase')) {
              return 'firebase';
            }
            if (id.includes('recharts')) {
              return 'recharts';
            }
            if (id.includes('@google/generative-ai')) {
              return 'gemini';
            }
            return 'vendor';
          }
        }
      }
    }
  }
});
--- END_FILE: vite.config.ts ---

--- START_FILE: .eslintrc.json ---
{
  "root": true,
  "env": {
    "browser": true,
    "es2020": true,
    "node": true
  },
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react-hooks/recommended",
    "plugin:react/recommended",
    "plugin:react/jsx-runtime"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module",
    "ecmaFeatures": {
      "jsx": true
    }
  },
  "plugins": ["react-refresh", "@typescript-eslint"],
  "rules": {
    "react-refresh/only-export-components": [
      "warn",
      { "allowConstantExport": true }
    ],
    "react/prop-types": "off", 
    "@typescript-eslint/no-unused-vars": ["warn", { "argsIgnorePattern": "^_" }],
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/exhaustive-deps": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}
--- END_FILE: .eslintrc.json ---

--- START_FILE: check_models.js ---
import fs from 'fs';
import path from 'path';

async function check() {
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    if (!fs.existsSync(envPath)) {
      console.error("‚ùå Error: Could not find .env file.");
      process.exit(1);
    }

    const envContent = fs.readFileSync(envPath, 'utf8');
    const match = envContent.match(/VITE_GEMINI_API_KEY=(.*)/);
    
    if (!match || !match[1]) {
      console.error("‚ùå Error: VITE_GEMINI_API_KEY not found in .env");
      process.exit(1);
    }

    // SANITIZATION: Remove spaces AND quotes (" or ') from the key
    const rawKey = match[1].trim();
    const apiKey = rawKey.replace(/^["']|["']$/g, ''); 

    console.log(`üîë Testing Key: ${apiKey.substring(0, 6)}... (Length: ${apiKey.length})`);

    // Query Google
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API Error ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    const contentModels = data.models.filter(m => 
      m.supportedGenerationMethods.includes("generateContent")
    );

    console.log("\n‚úÖ SUCCESS! HERE ARE YOUR AVAILABLE MODELS:");
    console.table(contentModels.map(m => ({
      name: m.name.replace('models/', ''), // Use THIS string in your code
      version: m.version,
      displayName: m.displayName
    })));

  } catch (error) {
    console.error("‚ùå Failed:", error.message);
  }
}

check();
--- END_FILE: check_models.js ---

--- START_FILE: eslint.config.js ---
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])

--- END_FILE: eslint.config.js ---

--- START_FILE: firebase.json ---
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
--- END_FILE: firebase.json ---

--- START_FILE: firestore.indexes.json ---
{
  "indexes": [
    {
      "collectionGroup": "journals",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "uid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "insights",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "uid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
--- END_FILE: firestore.indexes.json ---

--- START_FILE: index.html ---
<!doctype html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Recovery Toolkit</title>
    <meta name="description" content="Your digital companion for recovery.">
    <meta name="theme-color" content="#2A9D8F">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
--- END_FILE: index.html ---

--- START_FILE: postcss.config.js ---
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
--- END_FILE: postcss.config.js ---

--- START_FILE: scripts/generate-build-info.js ---
// scripts/generate-build-info.js
import fs from 'fs';
import path from 'path';
import crypto from 'crypto';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

// Fix for __dirname in ESM
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const SRC_DIR = path.join(__dirname, '../src');
const OUTPUT_FILE = path.join(SRC_DIR, 'build-info.json');

// Helper: Get Git Info
function getGitInfo() {
    try {
        const branch = execSync('git rev-parse --abbrev-ref HEAD').toString().trim();
        const hash = execSync('git rev-parse --short HEAD').toString().trim();
        return { branch, hash };
    } catch (e) {
        return { branch: 'unknown', hash: 'local' };
    }
}

// Helper: Calculate Hash of a File
function hashFile(filePath) {
    const content = fs.readFileSync(filePath);
    return crypto.createHash('md5').update(content).digest('hex').substring(0, 8);
}

// Helper: Recursive Walk to Hash a Directory (for Core Components)
function hashDirectory(dir) {
    let hashes = '';
    const files = fs.readdirSync(dir);
    
    for (const file of files) {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);
        
        if (stat.isDirectory()) {
            hashes += hashDirectory(filePath);
        } else {
            hashes += hashFile(filePath);
        }
    }
    
    return crypto.createHash('md5').update(hashes).digest('hex').substring(0, 8);
}

function generate() {
    console.log('üèóÔ∏è  Generating Build Manifest...');

    // 1. Environment Info
    const git = getGitInfo();
    const timestamp = new Date().toISOString();
    // Rudimentary environment detection based on branch or args
    const isProd = git.branch === 'main' || git.branch === 'master';
    const env = isProd ? 'PRODUCTION' : (git.branch === 'develop' ? 'UAT' : 'DEV');

    // 2. Core Hash (Components + Libs)
    // If any shared component changes, effectively ALL pages change version
    const componentsHash = hashDirectory(path.join(SRC_DIR, 'components'));
    const libHash = hashDirectory(path.join(SRC_DIR, 'lib'));
    const coreHash = crypto.createHash('md5').update(componentsHash + libHash).digest('hex').substring(0, 8);

    // 3. Page Hashes
    const pagesDir = path.join(SRC_DIR, 'pages');
    const pageFiles = fs.readdirSync(pagesDir).filter(f => f.endsWith('.tsx') || f.endsWith('.ts'));
    
    const pages = {};
    pageFiles.forEach(file => {
        const pageName = file.replace(/\.tsx?$/, '');
        const fileHash = hashFile(path.join(pagesDir, file));
        // Page Version = CoreHash + FileHash (So if Core changes, Page version bumps)
        const combinedHash = crypto.createHash('md5').update(coreHash + fileHash).digest('hex').substring(0, 8);
        
        pages[pageName] = {
            hash: combinedHash,
            lastModified: timestamp
        };
    });

    // 4. Construct Manifest
    const buildInfo = {
        meta: {
            env,
            branch: git.branch,
            globalHash: git.hash,
            coreHash,
            buildTime: timestamp
        },
        pages
    };

    // 5. Write to File
    fs.writeFileSync(OUTPUT_FILE, JSON.stringify(buildInfo, null, 2));
    console.log(`‚úÖ Build Manifest generated at ${OUTPUT_FILE}`);
    console.log(`   Global Hash: ${git.hash} [${env}]`);
}

generate();
--- END_FILE: scripts/generate-build-info.js ---

--- START_FILE: scripts/seed-personas.js ---
/**
 * GITHUB COMMENT:
 * [seed-personas.js]
 * NEW: Automation script to populate demo accounts with persona-specific data.
 * INTEGRATION: Uses AES-GCM encryption for Journals and Workbooks to match production security.
 * PERSONAS: David (Day 1), Ned (90 Days), Lisa (7 Years), Walt (35+ Years).
 */

import { initializeApp } from 'firebase/app';
import { getFirestore, doc, setDoc, collection, addDoc, Timestamp } from 'firebase/firestore';
import { getAuth, signInWithEmailAndPassword } from 'firebase/auth';
import { encrypt, generateSalt, generateKey } from '../src/lib/crypto.ts';

const firebaseConfig = { /* Your production/uat config here */ };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const PERSONAS = [
  {
    name: "David",
    email: "demo-david@mrt.app",
    pin: "1111",
    stage: "Day 1 (Acute Crisis)",
    journalFocus: "Unencrypted, raw entries reflecting high distress.",
    tasks: [{ title: "Call Sponsor", status: "pending", priority: "High" }],
  },
  {
    name: "Ned",
    email: "demo-ned@mrt.app",
    pin: "2222",
    stage: "90 Days (Pink Cloud)",
    journalFocus: "High energy, template-driven entries with 'Grateful' tags.",
    tasks: [{ title: "Morning Meditation", status: "completed", currentStreak: 90 }],
  },
  {
    name: "Lisa",
    email: "demo-lisa@mrt.app",
    pin: "3333",
    stage: "7 Years (Service/Sponsor)",
    journalFocus: "Reflections on sponsoring others and maintenance.",
    workbooks: { workbookId: "12_steps", sectionId: "step_12", status: "completed" },
  },
  {
    name: "Walt",
    email: "demo-walt@mrt.app",
    pin: "4444",
    stage: "35+ Years (Zen Master)",
    journalFocus: "Deeply spiritual and somatic logs.",
    vitality: { tags: ["Vitality", "Breathwork"], frequency: "Daily" }
  }
];

async function seedPersona(persona) {
  console.log(`üöÄ Seeding ${persona.name}...`);
  const userCredential = await signInWithEmailAndPassword(auth, persona.email, "demo-password-123");
  const uid = userCredential.user.uid;

  // 1. Initialize User Profile with Encryption Salt [cite: 16, 229]
  const salt = generateSalt();
  await setDoc(doc(db, "users", uid), {
    uid,
    email: persona.email,
    displayName: persona.name,
    encryptionSalt: salt,
    role: "demo_persona",
    createdAt: Timestamp.now()
  });

  // 2. Generate Key for Encryption [cite: 219]
  await generateKey(persona.pin, salt);

  // 3. Persona-Specific Data Seeding [cite: 18, 19, 32]
  if (persona.name === "David") {
    // Seed unencrypted journals to reflect Day 1 chaos [cite: 18]
    await addDoc(collection(db, "journals"), {
      uid,
      content: "I hit a wall today. Everything feels heavy. I'm scared.",
      isEncrypted: false,
      createdAt: Timestamp.now()
    });
  } else {
    // Seed encrypted journals for others [cite: 230]
    const encryptedContent = await encrypt(`Recovery reflection for ${persona.name}. Step ${persona.stage}.`);
    await addDoc(collection(db, "journals"), {
      uid,
      content: encryptedContent,
      isEncrypted: true,
      createdAt: Timestamp.now()
    });
  }
}

// Run Seeding
(async () => {
  for (const p of PERSONAS) await seedPersona(p);
  console.log("‚úÖ All demo personas seeded successfully.");
})();
--- END_FILE: scripts/seed-personas.js ---

--- START_FILE: src/App.css ---
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

--- END_FILE: src/App.css ---

--- START_FILE: src/App.tsx ---
/**
 * src/App.tsx
 * GITHUB COMMENT:
 * [App.tsx]
 * UPDATED: Implemented TanStack Query Provider and Route Lazy Loading.
 * PERFORMANCE: Reduced initial bundle size by splitting Admin, Insights, and Vitality pages.
 */
import React, { Suspense, lazy } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { EncryptionProvider } from './contexts/EncryptionContext';
import { LayoutProvider } from './contexts/LayoutContext';
import Login from './pages/Login';
import Welcome from './pages/Welcome'; 
import Dashboard from './pages/Dashboard';
import Journal from './pages/Journal';
import Tasks from './pages/Tasks';
import Profile from './pages/Profile';
import Workbooks from './pages/Workbooks'; 
import WorkbookDetail from './pages/WorkbookDetail'; 
import WorkbookSession from './pages/WorkbookSession'; 
import TemplateEditor from './components/journal/TemplateEditor'; 
import AppShell from './components/AppShell';
import UserGuide from './pages/UserGuide'; 
import VaultGate from './components/VaultGate';
import ErrorBoundary from './components/ErrorBoundary';

// --- LAZY LOADED ROUTES ---
// These are heavy or less frequently accessed pages
const Vitality = lazy(() => import('./pages/Vitality'));
const InsightsLog = lazy(() => import('./pages/InsightsLog'));
const AdminDashboard = lazy(() => import('./pages/AdminDashboard'));

// --- QUERY CLIENT ---
const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60 * 5, // Data fresh for 5 minutes
            retry: 1,
            refetchOnWindowFocus: false
        }
    }
});

// Loading Fallback Component
const RouteLoading = () => (
    <div className="flex h-screen items-center justify-center bg-slate-50 text-slate-400 animate-pulse">
        Loading...
    </div>
);

function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;
  
  if (!user) {
    return <Navigate to="/login" />;
  }

  return <AppShell>{children}</AppShell>;
}

export default function App() {
  return (
    <ErrorBoundary>
      <QueryClientProvider client={queryClient}>
        <AuthProvider>
            <EncryptionProvider>
            <LayoutProvider>
                <Router>
                <Suspense fallback={<RouteLoading />}>
                    <Routes>
                        {/* PUBLIC ROUTES */}
                        <Route path="/" element={<Welcome />} />
                        <Route path="/login" element={<Login />} />
                        
                        {/* PROTECTED ROUTES */}
                        <Route
                        path="/dashboard"
                        element={
                            <PrivateRoute>
                            <Dashboard />
                            </PrivateRoute>
                        }
                        />
                        
                        <Route
                        path="/journal"
                        element={
                            <PrivateRoute>
                            <VaultGate>
                                <Journal />
                            </VaultGate>
                            </PrivateRoute>
                        }
                        />
                        
                        <Route
                        path="/tasks"
                        element={
                            <PrivateRoute>
                            <Tasks />
                            </PrivateRoute>
                        }
                        />
                        
                        <Route
                        path="/workbooks"
                        element={
                            <PrivateRoute>
                                <VaultGate>
                                <Workbooks />
                                </VaultGate>
                            </PrivateRoute>
                        }
                        />
                        <Route
                        path="/workbooks/:workbookId"
                        element={
                            <PrivateRoute>
                            <VaultGate>
                                <WorkbookDetail />
                            </VaultGate>
                            </PrivateRoute>
                        }
                        />
                        <Route
                        path="/workbooks/:workbookId/session/:sectionId"
                        element={
                            <PrivateRoute>
                            <VaultGate>
                                <WorkbookSession />
                            </VaultGate>
                            </PrivateRoute>
                        }
                        />
                        
                        <Route
                        path="/vitality"
                        element={
                            <PrivateRoute>
                            <Vitality />
                            </PrivateRoute>
                        }
                        />

                        <Route
                        path="/insights"
                        element={
                            <PrivateRoute>
                                <VaultGate>
                                <InsightsLog />
                                </VaultGate>
                            </PrivateRoute>
                        }
                        />

                        <Route
                        path="/templates"
                        element={
                            <PrivateRoute>
                            <TemplateEditor />
                            </PrivateRoute>
                        }
                        />
                        
                        <Route
                        path="/profile"
                        element={
                            <PrivateRoute>
                                <Profile />
                            </PrivateRoute>
                        }
                        />

                        {/* USER GUIDE ROUTE */}
                        <Route
                        path="/guide"
                        element={
                            <PrivateRoute>
                                <UserGuide />
                            </PrivateRoute>
                        }
                        />

                        <Route
                        path="/admin"
                        element={
                            <PrivateRoute>
                                <AdminDashboard />
                            </PrivateRoute>
                        }
                        />
                        
                        {/* FALLBACK */}
                        <Route path="*" element={<Navigate to="/" />} />
                    </Routes>
                </Suspense>
                </Router>
            </LayoutProvider>
            </EncryptionProvider>
        </AuthProvider>
      </QueryClientProvider>
    </ErrorBoundary>
  );
}
--- END_FILE: src/App.tsx ---

--- START_FILE: src/components/AdminGrant.tsx ---
/**
 * GITHUB COMMENT:
 * [AdminGrant.tsx]
 * TEMPORARY UTILITY: One-time script to grant 'admin' role to the current logged-in user.
 * INSTRUCTIONS: Add to App.tsx, click the button, then DELETE this file and its reference.
 */
import { useState } from 'react';
import { db } from '../lib/firebase';
import { useAuth } from '../contexts/AuthContext';
import { doc, updateDoc, type Firestore } from 'firebase/firestore';
import { ShieldCheckIcon, ArrowPathIcon } from '@heroicons/react/24/outline';

export default function AdminGrant() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState<string | null>(null);

  const grantAdmin = async () => {
    if (!user || !db) {
      setStatus("Error: No user logged in or DB not found.");
      return;
    }

    const database: Firestore = db;
    setLoading(true);
    setStatus("Processing grant...");

    try {
      const userRef = doc(database, 'users', user.uid);
      await updateDoc(userRef, {
        role: 'admin'
      });
      setStatus(`SUCCESS: ${user.email} is now an Admin. Refresh the app.`);
    } catch (error) {
      console.error(error);
      setStatus("Error: Check console. You may need to update Firestore rules first.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed bottom-20 left-4 z-[9999] animate-bounce">
      <button
        onClick={grantAdmin}
        disabled={loading}
        className="bg-red-600 text-white p-4 rounded-full shadow-2xl flex items-center gap-2 hover:bg-red-700 transition-all active:scale-95"
      >
        {loading ? (
          <ArrowPathIcon className="h-6 w-6 animate-spin" />
        ) : (
          <ShieldCheckIcon className="h-6 w-6" />
        )}
        <span className="font-bold text-xs uppercase">Grant Admin Access</span>
      </button>
      {status && (
        <div className="absolute bottom-full mb-2 left-0 bg-black text-white text-[10px] p-2 rounded w-48 shadow-lg">
          {status}
        </div>
      )}
    </div>
  );
}
--- END_FILE: src/components/AdminGrant.tsx ---

--- START_FILE: src/components/AppShell.tsx ---
/**
 * GITHUB COMMENT:
 * [AppShell.tsx]
 * UPDATED: Added conditional 'Admin' menu item for users with the admin role.
 */
import { Fragment, type ReactNode, useEffect, useCallback } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  XMarkIcon, 
  HomeIcon, 
  BookOpenIcon, 
  UserCircleIcon, 
  ArrowLeftOnRectangleIcon, 
  ClipboardDocumentListIcon, 
  AcademicCapIcon, 
  HeartIcon, 
  LightBulbIcon,
  CommandLineIcon
} from '@heroicons/react/24/outline';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLayout } from '../contexts/LayoutContext';
import { useEncryption } from '../contexts/EncryptionContext';
import { db } from '../lib/firebase';
import { doc, getDoc, setDoc, serverTimestamp, type Firestore, type Timestamp } from 'firebase/firestore';
import { fetchAllUserData } from '../lib/db';
import { prepareDataForExport, generateJSON } from '../lib/exporter';
import { findBackupFile, uploadBackupToDrive } from '../lib/googleDrive';
import SOSModal from './SOSModal';

export default function AppShell({ children }: { children: ReactNode }) {
  const { sidebarOpen, setSidebarOpen, isSOSOpen, setIsSOSOpen } = useLayout();
  const location = useLocation();
  const navigate = useNavigate();
  const { user, logout, driveAccessToken, isAdmin } = useAuth();
  const { isVaultUnlocked } = useEncryption();

  const handleLogout = async () => {
    try {
      setSidebarOpen(false); 
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  const performAutoBackup = useCallback(async () => {
    if (!user || !db || !driveAccessToken || !isVaultUnlocked) return;
    const database: Firestore = db;

    try {
      const userRef = doc(database, 'users', user.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) return;

      const userData = userSnap.data();
      const lastExport = userData.lastExportAt as Timestamp | undefined;
      const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

      if (lastExport && lastExport.toMillis() > sevenDaysAgo) return;

      const rawData = await fetchAllUserData(user.uid);
      const cleanData = await prepareDataForExport(rawData, () => {});
      const blob = generateJSON(cleanData);
      const textData = await blob.text();

      const existingFileId = await findBackupFile(driveAccessToken);
      const success = await uploadBackupToDrive(driveAccessToken, textData, existingFileId || undefined);

      if (success) {
        await setDoc(userRef, { lastExportAt: serverTimestamp() }, { merge: true });
        console.log("Background Auto-Backup Successful");
      }
    } catch (e) {
      console.error("Auto-backup failed silently:", e);
    }
  }, [user, driveAccessToken, isVaultUnlocked]);

  useEffect(() => {
    if (isVaultUnlocked && driveAccessToken) {
      const timer = setTimeout(() => {
        performAutoBackup();
      }, 10000);
      return () => clearTimeout(timer);
    }
  }, [isVaultUnlocked, driveAccessToken, performAutoBackup]);

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { name: 'Journal', href: '/journal', icon: BookOpenIcon },
    { name: 'Vitality', href: '/vitality', icon: HeartIcon },
    { name: 'Tasks', href: '/tasks', icon: ClipboardDocumentListIcon },
    { name: 'Workbooks', href: '/workbooks', icon: AcademicCapIcon },
    { name: 'Insights', href: '/insights', icon: LightBulbIcon },
    { name: 'Profile', href: '/profile', icon: UserCircleIcon },
  ];

  // ADDED: Conditional Admin Link
  if (isAdmin) {
    navigation.push({ name: 'Admin', href: '/admin', icon: CommandLineIcon });
  }

  return (
    <div className="min-h-screen">
      <SOSModal isOpen={isSOSOpen} onClose={() => setIsSOSOpen(false)} />

      <Transition.Root show={sidebarOpen} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={setSidebarOpen}>
          <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm" />
          <div className="fixed inset-0 flex">
            <Transition.Child
              as={Fragment}
              enter="transition ease-in-out duration-300 transform"
              enterFrom="-translate-x-full"
              enterTo="translate-x-0"
              leave="transition ease-in-out duration-300 transform"
              leaveFrom="translate-x-0"
              leaveTo="-translate-x-full"
            >
              <Dialog.Panel className="relative mr-16 flex w-full max-w-xs flex-1 flex-col bg-gradient-to-b from-blue-700 to-blue-900 transition-all shadow-2xl">
                <div className="flex h-16 shrink-0 items-center justify-between px-6 pt-6">
                   <div className="flex items-center gap-3 text-white font-bold text-lg tracking-tight">
                      <div className="bg-white/10 p-1.5 rounded-lg">
                        <img src="/favicon-32x32.png" alt="" className="h-6 w-6" />
                      </div>
                      Recovery Toolkit
                   </div>
                   <button onClick={() => setSidebarOpen(false)} className="-m-2.5 p-2.5 text-blue-200 hover:text-white transition-colors">
                    <span className="sr-only">Close sidebar</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <nav className="flex flex-1 flex-col px-6 pb-4 mt-8">
                  <ul role="list" className="flex flex-1 flex-col gap-y-7">
                    <li>
                      <ul role="list" className="-mx-2 space-y-1">
                        {navigation.map((item) => (
                          <li key={item.name}>
                            <Link
                              to={item.href}
                              onClick={() => setSidebarOpen(false)}
                              className={`group flex gap-x-3 rounded-xl p-3 text-sm font-semibold leading-6 transition-all ${
                                location.pathname === item.href
                                  ? 'bg-blue-600/50 text-white shadow-inner border border-blue-500/30'
                                  : 'text-blue-100 hover:text-white hover:bg-blue-800'
                              }`}
                            >
                              <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                              {item.name}
                            </Link>
                          </li>
                        ))}
                      </ul>
                    </li>
                    
                    <li className="mt-auto">
                      <div className="flex flex-col gap-2 pt-6 border-t border-blue-500/30">
                         {user && (
                             <div className="flex items-center gap-x-3 rounded-xl p-3 text-sm font-semibold leading-6 text-white bg-blue-800/50 border border-blue-700/50">
                                 {user.photoURL ? (
                                     <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700 border-2 border-white/20" />
                                 ) : (
                                     <UserCircleIcon className="h-8 w-8 text-blue-200" />
                                 )}
                                 <div className="flex flex-col truncate">
                                    <span className="sr-only">Your profile</span>
                                    <span aria-hidden="true">{user.displayName || 'User'}</span>
                                    <span className="text-xs text-blue-300 font-normal truncate opacity-80">{user.email}</span>
                                 </div>
                             </div>
                         )}
                         <button
                           onClick={handleLogout}
                           className="group -mx-2 flex gap-x-3 rounded-xl p-3 text-sm font-semibold leading-6 text-blue-200 hover:bg-red-500/20 hover:text-red-200 w-full transition-colors"
                         >
                           <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                            Log out
                         </button>
                      </div>
                    </li>
                  </ul>
                </nav>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </Dialog>
      </Transition.Root>

      <main className="min-h-screen">
          {children}
      </main>
    </div>
  );
}
--- END_FILE: src/components/AppShell.tsx ---

--- START_FILE: src/components/CreateTaskModal.tsx ---
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  XMarkIcon, 
  PlusIcon,
  CalendarDaysIcon,
  ArrowPathIcon,
  FlagIcon
} from '@heroicons/react/24/outline';
import { addTask, type Frequency, type Priority } from '../lib/tasks';
import { useAuth } from '../contexts/AuthContext';

interface CreateTaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  onTaskAdded: () => void;
}

export default function CreateTaskModal({ isOpen, onClose, onTaskAdded }: CreateTaskModalProps) {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);

  // Form State
  const [title, setTitle] = useState('');
  const [priority, setPriority] = useState<Priority>('Medium');
  const [isRecurring, setIsRecurring] = useState(false);
  const [frequency, setFrequency] = useState<Frequency>('daily');
  const [dueDateStr, setDueDateStr] = useState(new Date().toISOString().split('T')[0]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !title.trim()) return;

    setLoading(true);
    try {
      // Convert input string to Date (noon to avoid TZ issues)
      const [y, m, d] = dueDateStr.split('-').map(Number);
      const dateObj = new Date(y, m - 1, d, 12, 0, 0);

      await addTask(
          user.uid, 
          title, 
          isRecurring ? frequency : 'once', 
          priority, 
          dateObj
      );
      
      // Reset & Close
      setTitle('');
      setIsRecurring(false);
      setPriority('Medium');
      setDueDateStr(new Date().toISOString().split('T')[0]);
      onTaskAdded();
      onClose();
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Transition.Root show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" />
        </Transition.Child>

        <div className="fixed inset-0 z-10 overflow-y-auto">
          <div className="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
              enterTo="opacity-100 translate-y-0 sm:scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 translate-y-0 sm:scale-100"
              leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
              <Dialog.Panel className="relative transform overflow-hidden rounded-xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                
                {/* Close Button */}
                <div className="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
                  <button
                    type="button"
                    className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                    onClick={onClose}
                  >
                    <span className="sr-only">Close</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <PlusIcon className="h-6 w-6 text-blue-600" aria-hidden="true" />
                  </div>
                  <div className="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                    <Dialog.Title as="h3" className="text-base font-semibold leading-6 text-gray-900">
                      Create New Quest
                    </Dialog.Title>
                    <div className="mt-2">
                      <p className="text-sm text-gray-500">
                        Add a new habit or task to your recovery ledger.
                      </p>
                    </div>

                    {/* FORM */}
                    <form onSubmit={handleSubmit} className="mt-6 space-y-5">
                        
                        {/* Title */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">Task Name</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                placeholder="e.g. Call Sponsor, Gym, Meditate"
                                autoFocus
                            />
                        </div>

                        {/* Date & Priority Row */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <CalendarDaysIcon className="h-3 w-3" /> Due Date
                                </label>
                                <input 
                                    type="date"
                                    value={dueDateStr}
                                    onChange={(e) => setDueDateStr(e.target.value)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                />
                            </div>
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <FlagIcon className="h-3 w-3" /> Priority
                                </label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value as Priority)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                >
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>

                        {/* Recurring Toggle */}
                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    id="recurring"
                                    checked={isRecurring}
                                    onChange={(e) => setIsRecurring(e.target.checked)}
                                    className="rounded text-blue-600 focus:ring-blue-500"
                                />
                                <label htmlFor="recurring" className="text-sm text-gray-700 font-medium flex items-center gap-2">
                                    <ArrowPathIcon className="h-4 w-4 text-gray-400" />
                                    Make this a Recurring Habit?
                                </label>
                            </div>
                            
                            {isRecurring && (
                                <div className="mt-3 pl-6 animate-fadeIn">
                                    <label className="block text-xs font-medium text-gray-500 mb-1">Frequency</label>
                                    <div className="flex gap-2">
                                        {(['daily', 'weekly', 'monthly'] as Frequency[]).map((freq) => (
                                            <button
                                                key={freq}
                                                type="button"
                                                onClick={() => setFrequency(freq)}
                                                className={`px-3 py-1.5 text-xs font-medium rounded-md capitalize border transition-colors ${
                                                    frequency === freq 
                                                    ? 'bg-blue-100 text-blue-700 border-blue-200' 
                                                    : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                                                }`}
                                            >
                                                {freq}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Submit Button */}
                        <div className="mt-5 sm:mt-6">
                            <button
                                type="submit"
                                disabled={!title.trim() || loading}
                                className="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-50"
                            >
                                {loading ? 'Creating...' : 'Create Task'}
                            </button>
                        </div>
                    </form>

                  </div>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition.Root>
  );
}
--- END_FILE: src/components/CreateTaskModal.tsx ---

--- START_FILE: src/components/ErrorBoundary.tsx ---
/**
 * src/components/ErrorBoundary.tsx
 * GITHUB COMMENT:
 * [ErrorBoundary.tsx]
 * UPDATED: Integrated Firestore logging for client-side crashes.
 * FEATURE: Telemetry for Admin Dashboard 'System Health' view.
 */
import { Component, type ErrorInfo, type ReactNode } from "react";
import { ExclamationTriangleIcon, ArrowPathIcon } from "@heroicons/react/24/outline";
import { db } from "../lib/firebase";
import { collection, addDoc, Timestamp } from "firebase/firestore";

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false,
    error: null
  };

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error("Uncaught error:", error, errorInfo);
    
    // Attempt to log to Firestore (Telemetry)
    if (db) {
        try {
            addDoc(collection(db, 'client_errors'), {
                message: error.message,
                stack: error.stack || 'No stack trace',
                componentStack: errorInfo.componentStack,
                url: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: Timestamp.now()
            });
        } catch (e) {
            console.error("Failed to log error telemetry", e);
        }
    }
  }

  public render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
          <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center border border-gray-100">
            <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <ExclamationTriangleIcon className="h-8 w-8 text-red-500" />
            </div>
            
            <h1 className="text-xl font-bold text-gray-900 mb-2">Something went wrong</h1>
            <p className="text-gray-500 text-sm mb-6">
              We encountered an unexpected issue. Don't worry, your data is safe.
            </p>

            <button
              onClick={() => window.location.reload()}
              className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors"
            >
              <ArrowPathIcon className="h-5 w-5" />
              Reload Application
            </button>
            
            <details className="mt-6 text-left">
              <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-600">Technical Details</summary>
              <pre className="mt-2 text-[10px] text-red-800 bg-red-50 p-2 rounded overflow-auto max-h-32">
                {this.state.error?.message}
              </pre>
            </details>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
--- END_FILE: src/components/ErrorBoundary.tsx ---

--- START_FILE: src/components/RecoveryHero.tsx ---
import { Link } from 'react-router-dom';
import { 
    FireIcon, 
    ClipboardDocumentCheckIcon,
    ChartBarIcon, 
    SparklesIcon,
    BoltIcon,
    AcademicCapIcon,
    BookOpenIcon,
    ShieldCheckIcon,
    HeartIcon
} from '@heroicons/react/24/outline';

interface RecoveryHeroProps {
    userName: string;
    daysClean: number;
    journalStats: {
        streak: number;
        consistency: number;
    };
    taskStats: {
        fire: number;
        rate: number;
    };
    workbookStats: {
        wisdom: number;
        completion: number;
    };
    vitalityStats: { 
        bioStreak: number;
        totalLogs: number;
    };
    // Removed onSOSClick prop as button is removed
}

export default function RecoveryHero({ 
    userName, 
    daysClean, 
    journalStats, 
    taskStats, 
    workbookStats,
    vitalityStats
}: RecoveryHeroProps) {
  return (
      <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
         {/* Background Decoration */}
         <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
         
         <div className="relative z-10">
             {/* Header Row: Greeting & Clean Time */}
             <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                 <div>
                     <h1 className="text-3xl font-bold">Welcome back, {userName}</h1>
                     <p className="text-blue-100 opacity-90">One day at a time. You are doing great.</p>
                 </div>

                 <div className="flex items-center gap-3">
                     
                     {/* CLEAN TIME BADGE */}
                     <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-xl px-4 py-2 flex items-center gap-3 shadow-lg">
                         <ShieldCheckIcon className="h-8 w-8 text-cyan-300" />
                         <div className="text-right">
                             <div className="text-2xl font-bold leading-none">{daysClean}</div>
                             <div className="text-[10px] uppercase tracking-wider text-blue-100 font-semibold">Days Clean</div>
                         </div>
                     </div>
                 </div>
             </div>

             {/* THE MATRIX GRID (Linked Tiles) */}
             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                 
                 {/* COLUMN 1: JOURNAL */}
                 <Link to="/journal" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <BookOpenIcon className="h-4 w-4" /> Journal
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <FireIcon className="h-5 w-5 text-orange-400" />
                                 <span className="text-sm font-medium">Streak</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.streak} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <ChartBarIcon className="h-5 w-5 text-purple-400" />
                                 <span className="text-sm font-medium">Consistency</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.consistency}/wk</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 2: TASKS */}
                 <Link to="/tasks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <ClipboardDocumentCheckIcon className="h-4 w-4" /> Habits
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <BoltIcon className="h-5 w-5 text-yellow-400" />
                                 <span className="text-sm font-medium">Fire</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.fire} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 rounded-full border-2 border-green-400 flex items-center justify-center">
                                     <div className="h-2 w-2 bg-green-400 rounded-full" />
                                 </div>
                                 <span className="text-sm font-medium">Completion</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.rate}%</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 3: WORKBOOKS */}
                 <Link to="/workbooks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <AcademicCapIcon className="h-4 w-4" /> Wisdom
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <SparklesIcon className="h-5 w-5 text-cyan-400" />
                                 <span className="text-sm font-medium">Score</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.wisdom} Ans</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 relative">
                                     <svg className="w-full h-full transform -rotate-90">
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" strokeOpacity="0.3" strokeWidth="3" />
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="#67e8f9" strokeWidth="3" strokeDasharray={`${workbookStats.completion * 0.5} 100`} />
                                     </svg>
                                 </div>
                                 <span className="text-sm font-medium">Mastery</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.completion}%</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 4: VITALITY */}
                 <Link to="/vitality" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <HeartIcon className="h-4 w-4" /> Vitality
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <FireIcon className="h-5 w-5 text-rose-400" />
                                 <span className="text-sm font-medium">Bio-Streak</span>
                             </div>
                             <span className="text-xl font-bold">{vitalityStats.bioStreak} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <BoltIcon className="h-5 w-5 text-green-400" />
                                 <span className="text-sm font-medium">Total Logs</span>
                             </div>
                             <span className="text-xl font-bold">{vitalityStats.totalLogs}</span>
                         </div>
                     </div>
                 </Link>

             </div>
         </div>
      </div>
  );
}
--- END_FILE: src/components/RecoveryHero.tsx ---

--- START_FILE: src/components/SOSModal.tsx ---
import { Fragment } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  PhoneIcon, 
  XMarkIcon, 
  ExclamationTriangleIcon,
  HeartIcon,
  PencilSquareIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

interface SOSModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function SOSModal({ isOpen, onClose }: SOSModalProps) {
  const navigate = useNavigate();

  const handleNavigation = (path: string) => {
    onClose();
    navigate(path);
  };

  return (
    <Transition.Root show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-red-900/40 backdrop-blur-sm transition-opacity" />
        </Transition.Child>

        <div className="fixed inset-0 z-10 overflow-y-auto">
          <div className="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
              enterTo="opacity-100 translate-y-0 sm:scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 translate-y-0 sm:scale-100"
              leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
              <Dialog.Panel className="relative transform overflow-hidden rounded-2xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6 border-t-8 border-red-500">
                
                {/* Close Button */}
                <div className="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
                  <button
                    type="button"
                    className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                    onClick={onClose}
                  >
                    <span className="sr-only">Close</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <div className="sm:flex sm:items-start mb-6">
                  <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <ExclamationTriangleIcon className="h-6 w-6 text-red-600" aria-hidden="true" />
                  </div>
                  <div className="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900">
                      Crisis Support
                    </Dialog.Title>
                    <div className="mt-2">
                      <p className="text-sm text-gray-500">
                        You are not alone. Choose the support you need right now.
                      </p>
                    </div>
                  </div>
                </div>

                {/* OPTIONS GRID */}
                <div className="grid gap-4">
                    
                    {/* OPTION 1: CALL HELP */}
                    <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                        <h4 className="font-bold text-red-900 flex items-center gap-2 mb-2">
                            <PhoneIcon className="h-5 w-5" />
                            Immediate Support
                        </h4>
                        <div className="flex gap-3">
                             <a 
                                href="tel:988" 
                                className="flex-1 bg-white border border-red-200 text-red-700 font-bold py-3 rounded-lg text-center shadow-sm hover:bg-red-600 hover:text-white transition-colors"
                             >
                                Call 988 (Lifeline)
                             </a>
                             <a 
                                href="tel:911" 
                                className="flex-1 bg-red-600 text-white font-bold py-3 rounded-lg text-center shadow-sm hover:bg-red-700 transition-colors"
                             >
                                Call 911
                             </a>
                        </div>
                    </div>

                    {/* OPTION 2: BREATHE */}
                    <button 
                        onClick={() => handleNavigation('/vitality')}
                        className="group bg-blue-50 p-4 rounded-xl border border-blue-100 hover:border-blue-300 transition-all text-left"
                    >
                        <h4 className="font-bold text-blue-900 flex items-center gap-2 mb-1">
                            <HeartIcon className="h-5 w-5 group-hover:scale-110 transition-transform" />
                            Ride the Wave (Breathwork)
                        </h4>
                        <p className="text-sm text-blue-700">
                            De-escalate your nervous system with 4-7-8 breathing. This feeling will pass.
                        </p>
                    </button>

                    {/* OPTION 3: JOURNAL (Urge Log) */}
                    <button 
                        onClick={() => handleNavigation('/journal?template=urge_log')}
                        className="group bg-purple-50 p-4 rounded-xl border border-purple-100 hover:border-purple-300 transition-all text-left"
                    >
                        <h4 className="font-bold text-purple-900 flex items-center gap-2 mb-1">
                            <PencilSquareIcon className="h-5 w-5 group-hover:scale-110 transition-transform" />
                            Log the Urge
                        </h4>
                        <p className="text-sm text-purple-700">
                            Process this craving using the "Urge Log" template. Get it out of your head.
                        </p>
                    </button>

                </div>

                <div className="mt-6 sm:flex sm:flex-row-reverse">
                  <button
                    type="button"
                    className="inline-flex w-full justify-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-200 sm:ml-3 sm:w-auto"
                    onClick={onClose}
                  >
                    Cancel
                  </button>
                </div>

              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition.Root>
  );
}
--- END_FILE: src/components/SOSModal.tsx ---

--- START_FILE: src/components/SobrietyCounter.tsx ---
import { useMemo } from 'react';
import { TrophyIcon } from '@heroicons/react/24/solid';

interface SobrietyCounterProps {
  sobrietyDate: Date;
}

// ensure 'export default' is present here
export default function SobrietyCounter({ sobrietyDate }: SobrietyCounterProps) {
  const time = useMemo(() => {
    const now = new Date();
    const start = new Date(sobrietyDate);
    
    // Calculate the difference
    const diffTime = Math.abs(now.getTime() - start.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = (totalDays % 365) % 30;

    return { years, months, days, totalDays };
  }, [sobrietyDate]);

  return (
    <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-xl p-6 text-white relative overflow-hidden">
      {/* Background Decoration */}
      <TrophyIcon className="absolute -right-4 -bottom-4 h-48 w-48 text-blue-500 opacity-20 transform rotate-12" />

      <div className="relative z-10">
        <h2 className="text-blue-100 text-sm font-semibold uppercase tracking-wider mb-4">
          Clean & Sober Time
        </h2>
        
        <div className="flex items-end space-x-6">
          {/* Years */}
          {time.years > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.years}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Years</span>
            </div>
          )}

          {/* Months */}
          {time.months > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.months}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Months</span>
            </div>
          )}

          {/* Days */}
          <div className="text-center">
            <span className="block text-4xl sm:text-5xl font-bold">{time.days}</span>
            <span className="text-xs sm:text-sm text-blue-200 uppercase">Days</span>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-blue-500/50 flex justify-between items-center text-sm text-blue-200">
          <span>Total Days: {time.totalDays}</span>
          <span>Started: {sobrietyDate.toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
}
--- END_FILE: src/components/SobrietyCounter.tsx ---

--- START_FILE: src/components/VaultGate.tsx ---
/**
 * GITHUB COMMENT:
 * [VaultGate.tsx]
 * CLEANUP: Removed unused 'err' variable and redundant eslint-disable directives.
 * MAINTAINED: Recovery Wizard UI and Emergency Reset flow logic.
 */
import React, { useState } from 'react';
import { useEncryption } from '../contexts/EncryptionContext';
import { 
  LockClosedIcon, 
  KeyIcon, 
  ShieldCheckIcon, 
  ExclamationCircleIcon,
  ExclamationTriangleIcon,
  TrashIcon,
  ArrowUpTrayIcon,
  XMarkIcon
} from '@heroicons/react/24/outline';

interface VaultGateProps {
  children: React.ReactNode;
}

export default function VaultGate({ children }: VaultGateProps) {
  const { isVaultSet, isVaultUnlocked, vaultLoading, unlockVault, setupVault, resetVault } = useEncryption();
  
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');
  const [confirmPin, setConfirmPin] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showRecoveryWizard, setShowRecoveryWizard] = useState(false);

  if (vaultLoading) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-4">
        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
        <p className="text-gray-500 font-medium">Securing Vault...</p>
      </div>
    );
  }

  if (isVaultUnlocked) {
    return <>{children}</>;
  }

  const handleHardReset = async () => {
    const confirmed = window.confirm(
      "CRITICAL: PERMANENT DATA LOSS WARNING\n\n" +
      "This will wipe your current security key. Your existing journals will be UNREADABLE.\n\n" +
      "Do not proceed unless you have a backup file to import later.\n\n" +
      "Reset now?"
    );
    
    if (!confirmed) return;

    setIsSubmitting(true);
    try {
      await resetVault();
      setShowRecoveryWizard(false);
      setPin('');
      setError('');
      window.location.reload();
    } catch (e) {
      console.error("Reset failed", e);
      setError("Reset failed. Please check connection.");
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!isVaultSet) {
    const handleSetup = async (e: React.FormEvent) => {
      e.preventDefault();
      if (pin.length < 4) {
        setError("PIN must be at least 4 digits.");
        return;
      }
      if (pin !== confirmPin) {
        setError("PINs do not match.");
        return;
      }
      setIsSubmitting(true);
      try {
        await setupVault(pin);
      } catch {
        setError("Setup failed.");
      } finally {
        setIsSubmitting(false);
      }
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh] p-4 text-center animate-fadeIn">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border border-gray-100">
            <div className="bg-blue-100 p-3 rounded-full w-fit mx-auto mb-4">
                <ShieldCheckIcon className="h-8 w-8 text-blue-600" />
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Create Recovery Vault</h2>
            <div className="bg-blue-50 p-4 rounded-xl text-left mb-6 border border-blue-100">
                <p className="text-xs text-blue-800 leading-relaxed">
                  <strong>Zero-Knowledge Policy:</strong> Your PIN is never stored on our servers. This ensures your privacy, but it means <strong>lost PINs cannot be recovered</strong> without a manual backup file.
                </p>
            </div>

            <form onSubmit={handleSetup} className="space-y-4">
                <input
                    type="password"
                    inputMode="numeric"
                    placeholder="New Security PIN"
                    value={pin}
                    onChange={(e) => { setPin(e.target.value); setError(''); }}
                    className="w-full text-center text-2xl tracking-widest p-4 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none"
                    disabled={isSubmitting}
                    autoComplete="new-password"
                />
                <input
                    type="password"
                    inputMode="numeric"
                    placeholder="Confirm PIN"
                    value={confirmPin}
                    onChange={(e) => { setConfirmPin(e.target.value); setError(''); }}
                    className="w-full text-center text-2xl tracking-widest p-4 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none"
                    disabled={isSubmitting}
                    autoComplete="new-password"
                />
                {error && <p className="text-red-500 text-sm font-bold animate-pulse">{error}</p>}
                
                <button 
                    type="submit"
                    disabled={isSubmitting}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition-all shadow-md disabled:opacity-50 active:scale-95"
                >
                    {isSubmitting ? 'Generating Vault...' : 'Secure My Journal'}
                </button>
            </form>
        </div>
      </div>
    );
  }

  const handleUnlock = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!pin || isSubmitting) return;

    setIsSubmitting(true);
    setError('');

    const success = await unlockVault(pin);
    
    if (!success) {
      setError("Improper PIN. Access Denied.");
      setPin('');
      setIsSubmitting(false);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-[60vh] p-4 text-center animate-fadeIn">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border border-gray-100 relative overflow-hidden">
            
            {error && (
                <div className="absolute top-0 left-0 w-full bg-red-500 text-white p-3 text-sm font-bold flex items-center justify-center gap-2 animate-slideDown">
                    <ExclamationCircleIcon className="h-5 w-5" />
                    {error}
                </div>
            )}

            <div className="bg-gray-100 p-3 rounded-full w-fit mx-auto mb-4 mt-4">
                <LockClosedIcon className="h-8 w-8 text-gray-600" />
            </div>
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Vault Locked</h2>
            <p className="text-gray-500 mb-6 text-sm">Please enter your PIN to decrypt your data.</p>

            <form onSubmit={handleUnlock} className="space-y-4">
                <input
                    type="password"
                    inputMode="numeric"
                    autoFocus
                    placeholder="Enter PIN"
                    value={pin}
                    onChange={(e) => { setPin(e.target.value); setError(''); }}
                    className={`w-full text-center text-3xl tracking-widest p-4 border rounded-2xl focus:ring-2 outline-none transition-all ${error ? 'border-red-300 ring-red-200 bg-red-50' : 'border-gray-300 focus:ring-blue-500'}`}
                    disabled={isSubmitting}
                />
                
                <button 
                    type="submit"
                    disabled={isSubmitting}
                    className="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl transition-all shadow-md flex items-center justify-center gap-2 disabled:opacity-50 active:scale-95"
                >
                    {isSubmitting ? <span>Verifying...</span> : <><KeyIcon className="h-5 w-5" /> Unlock Vault</>}
                </button>
            </form>

            <div className="mt-8 pt-6 border-t border-gray-100">
                <button 
                  onClick={() => setShowRecoveryWizard(true)}
                  className="text-xs font-bold text-gray-400 hover:text-red-500 transition-colors uppercase tracking-widest"
                >
                  Forgot PIN or Locked Out?
                </button>
            </div>
        </div>

        {showRecoveryWizard && (
          <div className="fixed inset-0 z-[60] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 text-left animate-slideUp relative">
              <button 
                onClick={() => setShowRecoveryWizard(false)}
                className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
              >
                <XMarkIcon className="h-6 w-6" />
              </button>

              <div className="flex items-center gap-3 text-red-600 mb-4">
                <ExclamationTriangleIcon className="h-8 w-8" />
                <h3 className="text-xl font-bold">Vault Recovery</h3>
              </div>

              <p className="text-gray-600 text-sm leading-relaxed mb-6">
                Privacy is our priority. Since we do not store your PIN, we cannot "reset" it for you. You must wipe the current lock to set a new one.
              </p>
              
              <div className="bg-amber-50 p-5 rounded-2xl border border-amber-200 mb-8">
                <h4 className="text-sm font-bold text-amber-900 mb-3 flex items-center gap-2">
                  <ArrowUpTrayIcon className="h-4 w-4" /> Recovery Steps:
                </h4>
                <ol className="text-xs text-amber-800 space-y-3 list-decimal pl-4 font-medium">
                  <li>Locate your most recent <strong>JSON Backup</strong> file.</li>
                  <li>Click <strong>Reset & Wipe</strong> below.</li>
                  <li>Create a new PIN immediately.</li>
                  <li>Restore entries via <strong>Profile &rarr; Import</strong>.</li>
                </ol>
              </div>

              <div className="flex flex-col gap-3">
                <button 
                  onClick={handleHardReset}
                  className="w-full py-4 bg-red-600 text-white font-bold rounded-2xl hover:bg-red-700 flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95"
                >
                  <TrashIcon className="h-5 w-5" /> Reset & Wipe Vault
                </button>
                <button 
                  onClick={() => setShowRecoveryWizard(false)}
                  className="w-full py-4 bg-gray-100 text-gray-600 font-bold rounded-2xl hover:bg-gray-200 transition-colors"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}
    </div>
  );
}
--- END_FILE: src/components/VaultGate.tsx ---

--- START_FILE: src/components/VersionBadge.tsx ---
import { useState } from 'react';
import { useBuildInfo, usePageVersion, getEnvColor } from '../lib/versioning';
import { 
    CpuChipIcon, 
    CodeBracketIcon, 
    ClockIcon,
    ServerIcon
} from '@heroicons/react/24/outline';

interface VersionBadgeProps {
    pageName?: string; // Optional: Pass the current page name to get granular versioning
    className?: string;
}

export default function VersionBadge({ pageName, className = '' }: VersionBadgeProps) {
    const meta = useBuildInfo();
    const pageHash = usePageVersion(pageName || '');
    const [isExpanded, setIsExpanded] = useState(false);

    const envColor = getEnvColor(meta.env);
    const shortTime = new Date(meta.buildTime).toLocaleDateString();

    if (!isExpanded) {
        return (
            <button 
                onClick={() => setIsExpanded(true)}
                className={`flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm text-[10px] font-mono font-bold text-white hover:opacity-90 transition-all ${envColor} ${className}`}
                title="Click for Build Details"
            >
                <ServerIcon className="h-3 w-3" />
                <span>{meta.env}</span>
                <span className="opacity-75">v.{meta.globalHash}</span>
            </button>
        );
    }

    return (
        <div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4"
            onClick={() => setIsExpanded(false)}
        >
            <div 
                className="bg-white rounded-2xl shadow-2xl border border-gray-200 p-5 max-w-sm w-full animate-fadeIn"
                onClick={e => e.stopPropagation()}
            >
                <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-3">
                    <h3 className="text-sm font-bold text-gray-900 uppercase tracking-wide flex items-center gap-2">
                        <CpuChipIcon className="h-5 w-5 text-gray-500" />
                        System Status
                    </h3>
                    <div className={`px-2 py-0.5 rounded text-[10px] font-bold text-white ${envColor}`}>
                        {meta.env}
                    </div>
                </div>

                <div className="space-y-3 text-xs text-gray-600 font-mono">
                    <div className="flex justify-between">
                        <span className="flex items-center gap-2"><CodeBracketIcon className="h-4 w-4 text-gray-400" /> Global Build</span>
                        <span className="font-bold text-gray-900">{meta.globalHash}</span>
                    </div>
                    
                    <div className="flex justify-between">
                        <span className="flex items-center gap-2"><ServerIcon className="h-4 w-4 text-gray-400" /> Core Lib Hash</span>
                        <span className="text-gray-900">{meta.coreHash}</span>
                    </div>

                    <div className="flex justify-between">
                        <span className="flex items-center gap-2"><ClockIcon className="h-4 w-4 text-gray-400" /> Built On</span>
                        <span className="text-gray-900">{shortTime}</span>
                    </div>

                    {pageName && (
                        <div className="mt-4 pt-3 border-t border-gray-100 bg-gray-50 p-2 rounded-lg">
                            <div className="text-[10px] uppercase font-bold text-gray-400 mb-1">Current Page Version</div>
                            <div className="flex justify-between">
                                <span>{pageName}</span>
                                <span className="font-bold text-indigo-600">{pageHash}</span>
                            </div>
                        </div>
                    )}
                </div>

                <button 
                    onClick={() => setIsExpanded(false)}
                    className="w-full mt-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-lg text-xs transition-colors"
                >
                    Close
                </button>
            </div>
        </div>
    );
}
--- END_FILE: src/components/VersionBadge.tsx ---

--- START_FILE: src/components/VibrantHeader.tsx ---
import { useLayout } from '../contexts/LayoutContext';
import { Bars3Icon, ExclamationTriangleIcon } from '@heroicons/react/24/outline';
import type { ElementType } from 'react';

interface VibrantHeaderProps {
  title: string;
  subtitle: string;
  icon?: ElementType;
  fromColor: string; // e.g. "from-blue-600"
  viaColor: string;  // e.g. "via-indigo-600"
  toColor: string;   // e.g. "to-purple-600"
  percentage?: number;
  percentageColor?: string;
}

const ProgressRing = ({ percentage, colorHex }: { percentage: number; colorHex?: string }) => {
  const radius = 24; // Slightly smaller for the compact header
  const stroke = 4;
  const normalizedRadius = radius - stroke * 2;
  const circumference = normalizedRadius * 2 * Math.PI;
  const strokeDashoffset = circumference - (percentage / 100) * circumference;

  return (
    <div className="relative flex items-center justify-center">
      <svg
        height={radius * 2}
        width={radius * 2}
        className="transform -rotate-90"
      >
        <circle
          stroke="rgba(255,255,255,0.2)"
          strokeWidth={stroke}
          fill="transparent"
          r={normalizedRadius}
          cx={radius}
          cy={radius}
        />
        <circle
          stroke={colorHex || "currentColor"}
          strokeWidth={stroke}
          strokeDasharray={circumference + ' ' + circumference}
          style={{ strokeDashoffset, transition: "stroke-dashoffset 1s ease-out" }}
          strokeLinecap="round"
          fill="transparent"
          r={normalizedRadius}
          cx={radius}
          cy={radius}
          className={!colorHex ? "text-white" : ""} 
        />
      </svg>
      <div className="absolute flex flex-col items-center">
        <span className="text-[10px] font-bold text-white drop-shadow-sm">
          {Math.round(percentage)}%
        </span>
      </div>
    </div>
  );
};

export default function VibrantHeader({
  title,
  subtitle,
  icon: Icon,
  fromColor,
  viaColor,
  toColor,
  percentage,
  percentageColor
}: VibrantHeaderProps) {
  const { toggleSidebar, toggleSOS } = useLayout();

  return (
    <div className={`bg-gradient-to-r ${fromColor} ${viaColor} ${toColor} px-4 pt-4 pb-16 shadow-lg relative overflow-hidden`}>
      {/* Background Pattern */}
      <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
      
      {/* 3-Column Grid Layout: Menu | Title | Actions */}
      <div className="relative z-20 grid grid-cols-[auto_1fr_auto] items-center gap-4">
        
        {/* Left: Hamburger */}
        <button 
          onClick={toggleSidebar}
          className="p-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white transition-all backdrop-blur-sm border border-white/10 active:scale-95"
          aria-label="Open Menu"
        >
          <Bars3Icon className="h-6 w-6" />
        </button>

        {/* Center: Title & Subtitle */}
        <div className="flex flex-col items-center text-center">
          <h1 className="text-xl sm:text-2xl font-bold text-white flex items-center justify-center gap-2 drop-shadow-md">
            {Icon && <Icon className="h-6 w-6 text-white/90 animate-pulse" />}
            {title}
          </h1>
          <p className="text-white/80 text-xs sm:text-sm font-medium mt-0.5 tracking-wide">
            {subtitle}
          </p>
        </div>

        {/* Right: SOS & Stats */}
        <div className="flex items-center gap-3">
          {/* Progress Ring (Optional) */}
          {percentage !== undefined && (
             <div className="hidden sm:block bg-white/10 backdrop-blur-md rounded-full p-1 shadow-inner border border-white/5">
                <ProgressRing percentage={percentage} colorHex={percentageColor} />
             </div>
          )}

          {/* SOS Button */}
          <button 
            onClick={toggleSOS}
            className="p-2.5 rounded-full bg-red-500/80 hover:bg-red-500 text-white border border-red-400/50 transition-all backdrop-blur-md shadow-lg animate-pulse hover:animate-none active:scale-95"
            aria-label="Emergency SOS"
          >
            <ExclamationTriangleIcon className="h-6 w-6" />
          </button>
        </div>

      </div>
    </div>
  );
}
--- END_FILE: src/components/VibrantHeader.tsx ---

--- START_FILE: src/components/admin/AnalyticsCharts.tsx ---
/**
 * src/components/admin/AnalyticsCharts.tsx
 * GITHUB COMMENT:
 * [AnalyticsCharts.tsx]
 * REFACTOR: Extracted chart logic from AdminDashboard.
 * PURPOSE: Visualizes AI token usage and model distribution.
 */
import { 
    BarChart, 
    Bar, 
    XAxis, 
    YAxis, 
    Tooltip, 
    ResponsiveContainer, 
    PieChart, 
    Pie, 
    Cell, 
    Legend
} from 'recharts';
import { Timestamp } from 'firebase/firestore';

export interface AIUsageLog {
    id: string;
    model: string;
    timestamp: Timestamp;
    usage: {
        totalTokens: number;
        promptTokens: number;
        candidatesTokens: number;
    };
}

interface AnalyticsChartsProps {
    logs: AIUsageLog[];
}

const COLORS = ['#8884d8', '#82ca9d', '#ffc658', '#ff8042'];

export default function AnalyticsCharts({ logs }: AnalyticsChartsProps) {
    
    // 1. Process Model Distribution (Pie)
    const modelData = logs.reduce((acc, log) => {
        const existing = acc.find(i => i.name === log.model);
        if (existing) {
            existing.value += 1;
        } else {
            acc.push({ name: log.model, value: 1 });
        }
        return acc;
    }, [] as { name: string; value: number }[]);

    // 2. Process Token Usage (Bar) - Recent 20 logs
    const tokenData = logs.slice(0, 20).reverse().map(log => ({
        // Safe check for timestamp in case of raw data issues
        name: log.timestamp?.toDate 
            ? new Date(log.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            : 'N/A',
        tokens: log.usage.totalTokens,
        model: log.model
    }));

    const totalTokens = logs.reduce((sum, log) => sum + log.usage.totalTokens, 0);

    if (logs.length === 0) {
        return (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-center text-gray-500">
                No AI usage logs found yet. Use the app to generate some data.
            </div>
        );
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* CARD 1: Model Distribution */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 h-80">
                <h4 className="text-sm font-bold text-gray-500 uppercase mb-4">Request Distribution</h4>
                <ResponsiveContainer width="100%" height="90%">
                    <PieChart>
                        <Pie 
                            data={modelData} 
                            cx="50%" 
                            cy="50%" 
                            innerRadius={60} 
                            outerRadius={80} 
                            paddingAngle={5} 
                            dataKey="value"
                        >
                            {modelData.map((_, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                        </Pie>
                        <Tooltip />
                        <Legend verticalAlign="bottom" height={36} iconType="circle" />
                    </PieChart>
                </ResponsiveContainer>
            </div>

            {/* CARD 2: Token Usage Stream */}
            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 h-80 flex flex-col">
                <div className="flex justify-between items-center mb-4">
                    <h4 className="text-sm font-bold text-gray-500 uppercase">Recent Token Usage</h4>
                    <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-md font-bold">Total: {totalTokens.toLocaleString()}</span>
                </div>
                <div className="flex-1 min-h-0">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={tokenData}>
                            <XAxis dataKey="name" fontSize={10} tickLine={false} axisLine={false} />
                            <YAxis hide />
                            <Tooltip 
                                contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}} 
                                cursor={{fill: '#f3f4f6'}} 
                            />
                            <Bar dataKey="tokens" fill="#8884d8" radius={[4, 4, 0, 0]} />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
}
--- END_FILE: src/components/admin/AnalyticsCharts.tsx ---

--- START_FILE: src/components/admin/DeduplicationTool.tsx ---
/**
 * src/components/admin/DeduplicationTool.tsx
 * GITHUB COMMENT:
 * [DeduplicationTool.tsx]
 * REFACTOR: Extracted journal maintenance logic.
 * PURPOSE: Scans and removes duplicate journal entries caused by multiple imports.
 */
import { useState } from 'react';
import { db } from '../../lib/firebase';
import { 
    collection, 
    query, 
    where, 
    getDocs, 
    writeBatch, 
    doc,
    type Firestore 
} from 'firebase/firestore';
import { 
    DocumentDuplicateIcon, 
    ArrowPathIcon,
    CheckCircleIcon
} from '@heroicons/react/24/outline';

interface DeduplicationToolProps {
    uid: string;
}

export default function DeduplicationTool({ uid }: DeduplicationToolProps) {
    const [loading, setLoading] = useState(false);
    const [status, setStatus] = useState<string | null>(null);

    const runDeduplication = async () => {
        if (!db) return;
        if (!confirm("This will permanently delete duplicate journal entries. Continue?")) return;
    
        setLoading(true);
        setStatus("Scanning for duplicates...");
        const database: Firestore = db;
    
        try {
          const q = query(collection(database, 'journals'), where('uid', '==', uid));
          const snapshot = await getDocs(q);
          
          const seen = new Map<string, string>(); // key: content+timestamp, value: docId
          const duplicates: string[] = [];
    
          snapshot.docs.forEach(d => {
            const data = d.data();
            const content = data.content as string;
            // Handle Timestamp vs Date objects defensively
            const time = data.createdAt?.toMillis?.() || (data.createdAt instanceof Date ? data.createdAt.getTime() : 0);
            const key = `${content.trim()}_${time}`;
    
            if (seen.has(key)) {
              duplicates.push(d.id);
            } else {
              seen.set(key, d.id);
            }
          });
    
          if (duplicates.length === 0) {
            setStatus("No duplicates found.");
            setLoading(false);
            return;
          }
    
          setStatus(`Found ${duplicates.length} duplicates. Deleting in batches...`);
    
          // Firestore Batch limit is 500
          let batch = writeBatch(database);
          let count = 0;
    
          for (const id of duplicates) {
            batch.delete(doc(database, 'journals', id));
            count++;
            if (count >= 400) {
              await batch.commit();
              batch = writeBatch(database);
              count = 0;
            }
          }
          
          if (count > 0) await batch.commit();
    
          setStatus(`Success! Removed ${duplicates.length} duplicate entries.`);
        } catch (e) {
          console.error(e);
          setStatus("Error running deduplication.");
        } finally {
          setLoading(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div className="flex items-center gap-3 mb-4">
                <div className="p-2 bg-red-50 rounded-lg text-red-600">
                    <DocumentDuplicateIcon className="h-6 w-6" />
                </div>
                <h3 className="font-bold text-gray-900">Journal Deduplicator</h3>
            </div>
            
            <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                Scans your journals for entries with identical content and timestamps created by multiple imports. Keeps the original and removes clones.
            </p>
            
            {status && (
                <div className="mb-4 bg-blue-50 border border-blue-200 p-3 rounded-xl flex items-center gap-3 text-blue-800 text-sm font-medium animate-fadeIn">
                    {loading ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <CheckCircleIcon className="h-5 w-5" />}
                    {status}
                </div>
            )}

            <button 
                onClick={runDeduplication} 
                disabled={loading}
                className="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 disabled:opacity-50 transition-all active:scale-95"
            >
                Run Clean Up
            </button>
        </div>
    );
}
--- END_FILE: src/components/admin/DeduplicationTool.tsx ---

--- START_FILE: src/components/admin/ErrorLogViewer.tsx ---
/**
 * src/components/admin/ErrorLogViewer.tsx
 * GITHUB COMMENT:
 * [ErrorLogViewer.tsx]
 * FIX: Removed unused 'useEffect' and renamed unused 'index' parameter to '_index'.
 */
import { useState } from 'react';
import { db } from '../../lib/firebase';
import { 
    collection, 
    getDocs, 
    deleteDoc, 
    doc, 
    orderBy, 
    query, 
    limit, 
    type Firestore,
    Timestamp 
} from 'firebase/firestore';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { analyzeSystemHealth, type SystemHealthAnalysis } from '../../lib/gemini';
import { Virtuoso } from 'react-virtuoso';
import { 
    ExclamationTriangleIcon, 
    TrashIcon, 
    ComputerDesktopIcon,
    SparklesIcon,
    ArrowPathIcon,
    CheckBadgeIcon,
   // WrenchScrewdriverIcon
} from '@heroicons/react/24/outline';

interface ErrorLog {
    id: string;
    message: string;
    stack: string;
    url: string;
    timestamp: Timestamp;
    userAgent: string;
}

interface AggregatedError {
    count: number;
    sampleStack: string;
    browsers: Set<string>;
}

export default function ErrorLogViewer() {
    const queryClient = useQueryClient();
    
    // Analysis State
    const [analyzing, setAnalyzing] = useState(false);
    const [analysis, setAnalysis] = useState<SystemHealthAnalysis | null>(null);

    const { data: errors = [], isLoading } = useQuery({
        queryKey: ['client_errors'],
        queryFn: async () => {
            if (!db) return [];
            const database: Firestore = db;
            const q = query(
                collection(database, 'client_errors'),
                orderBy('timestamp', 'desc'),
                limit(100)
            );
            const snap = await getDocs(q);
            return snap.docs.map(d => ({ id: d.id, ...d.data() } as ErrorLog));
        }
    });

    const handleDelete = async (id: string) => {
        if (!db) return;
        if (!confirm("Delete this log?")) return;
        try {
            await deleteDoc(doc(db, 'client_errors', id));
            queryClient.invalidateQueries({ queryKey: ['client_errors'] });
        } catch (e) {
            console.error("Failed to delete", e);
        }
    };

    const handleAnalyze = async () => {
        if (errors.length === 0) return;
        setAnalyzing(true);
        setAnalysis(null);

        try {
            const aggregated = errors.reduce<Record<string, AggregatedError>>((acc, curr) => {
                const key = curr.message;
                if (!acc[key]) {
                    acc[key] = { count: 0, sampleStack: curr.stack, browsers: new Set() };
                }
                acc[key].count++;
                acc[key].browsers.add(curr.userAgent.split(')')[0]); 
                return acc;
            }, {});

            const logSummary = Object.entries(aggregated).map(([msg, details]) => `
                ERROR: ${msg}
                COUNT: ${details.count}
                BROWSERS: ${Array.from(details.browsers).join(', ')}
                STACK_SNIPPET: ${details.sampleStack.substring(0, 300)}...
            `).join('\n---\n');

            const result = await analyzeSystemHealth(logSummary);
            setAnalysis(result);

        } catch (e) {
            console.error("Analysis failed", e);
            alert("Failed to generate AI analysis.");
        } finally {
            setAnalyzing(false);
        }
    };

    if (isLoading) return <div className="p-8 text-center text-gray-400">Scanning telemetry...</div>;

    if (errors.length === 0) {
        return (
            <div className="bg-green-50 p-8 rounded-2xl border border-green-200 text-center">
                <div className="mx-auto w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <ComputerDesktopIcon className="h-6 w-6 text-green-600" />
                </div>
                <h3 className="text-green-900 font-bold">System Healthy</h3>
                <p className="text-green-700 text-sm">No client-side crashes reported.</p>
            </div>
        );
    }

    return (
        <div className="space-y-6 h-[600px] flex flex-col">
            <div className="flex justify-between items-center shrink-0">
                <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <ExclamationTriangleIcon className="h-6 w-6 text-red-500" />
                    Recent Crashes ({errors.length})
                </h3>
                <button 
                    onClick={handleAnalyze} 
                    disabled={analyzing}
                    className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95 disabled:opacity-50 text-sm font-bold"
                >
                    {analyzing ? <ArrowPathIcon className="h-4 w-4 animate-spin" /> : <SparklesIcon className="h-4 w-4" />}
                    Analyze Health
                </button>
            </div>

            {analysis && (
                 <div className="bg-white border border-indigo-100 rounded-2xl shadow-lg overflow-hidden animate-slideUp shrink-0 mb-4">
                    <div className="px-6 py-4 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                        <h4 className="font-bold text-indigo-900 flex items-center gap-2">
                            <SparklesIcon className="h-5 w-5" /> AI Diagnosis
                        </h4>
                        <span className="text-xs font-bold uppercase bg-white px-2 py-1 rounded text-indigo-600 border border-indigo-200">{analysis.status}</span>
                    </div>
                    
                    <div className="p-4 space-y-4">
                        <p className="text-sm text-gray-700">{analysis.summary}</p>
                        
                        {/* Render Top Issues */}
                        <div className="space-y-2">
                            {analysis.top_issues.map((issue, idx) => (
                                <div key={idx} className="bg-gray-50 p-3 rounded-lg border border-gray-100 text-xs">
                                    <strong className="text-gray-900 block mb-1">{issue.error_signature}</strong>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                        <p className="text-gray-600"><span className="font-bold">Root Cause:</span> {issue.suspected_root_cause}</p>
                                        <p className="text-blue-700 bg-blue-50 p-1 rounded"><span className="font-bold">Fix:</span> {issue.suggested_fix}</p>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {analysis.environment_patterns && (
                            <div className="flex items-center gap-2 text-xs text-gray-500 bg-gray-100 p-2 rounded-lg justify-center">
                                <CheckBadgeIcon className="h-4 w-4" />
                                <strong>Pattern:</strong> {analysis.environment_patterns}
                            </div>
                        )}
                    </div>
                 </div>
            )}
            
            {/* RAW LOGS VIRTUALIZED */}
            <div className="flex-1 border border-gray-200 rounded-xl overflow-hidden bg-gray-50">
                <Virtuoso 
                    data={errors}
                    itemContent={(_index, err) => (
                        <div className="bg-white p-5 border-b border-gray-100 hover:bg-gray-50 transition-colors">
                            <div className="flex justify-between items-start mb-3">
                                <div>
                                    <span className="text-xs font-bold bg-red-100 text-red-800 px-2 py-1 rounded">
                                        {err.timestamp?.toDate().toLocaleString()}
                                    </span>
                                    <h4 className="font-bold text-gray-900 mt-2 text-sm">{err.message}</h4>
                                </div>
                                <button 
                                    onClick={() => handleDelete(err.id)}
                                    className="text-gray-400 hover:text-red-600 p-1"
                                >
                                    <TrashIcon className="h-5 w-5" />
                                </button>
                            </div>
                            
                            <div className="bg-gray-100 p-3 rounded-lg text-xs font-mono text-gray-600 overflow-x-auto mb-3">
                                {err.stack ? err.stack.split('\n')[0] : 'No stack trace'}
                            </div>

                            <div className="flex items-center gap-4 text-xs text-gray-400">
                                <span className="truncate max-w-[200px]">{err.url}</span>
                                <span className="truncate max-w-[200px]">{err.userAgent}</span>
                            </div>
                        </div>
                    )}
                />
            </div>
        </div>
    );
}
--- END_FILE: src/components/admin/ErrorLogViewer.tsx ---

--- START_FILE: src/components/admin/SchemaMigration.tsx ---
/**
 * src/components/admin/SchemaMigration.tsx
 * GITHUB COMMENT:
 * [SchemaMigration.tsx]
 * NEW: Database migration tool.
 * PURPOSE: Standardizes legacy 'insights' documents by mapping 'actionableSteps' to 'suggested_actions'.
 */
import { useState } from 'react';
import { db } from '../../lib/firebase';
import { 
    collection, 
    query, 
    where, 
    getDocs, 
    writeBatch,
    type Firestore 
} from 'firebase/firestore';
import { 
    CircleStackIcon, 
    ArrowPathIcon,
    CheckCircleIcon
} from '@heroicons/react/24/outline';

interface SchemaMigrationProps {
    uid: string;
}

export default function SchemaMigration({ uid }: SchemaMigrationProps) {
    const [loading, setLoading] = useState(false);
    const [status, setStatus] = useState<string | null>(null);

    const runMigration = async () => {
        if (!db) return;
        setLoading(true);
        setStatus("Scanning insights collection...");
        
        try {
            const database: Firestore = db;
            const q = query(collection(database, 'insights'), where('uid', '==', uid));
            const snapshot = await getDocs(q);
            
            let updatedCount = 0;
            const batch = writeBatch(database);
            let operationCounter = 0;

            snapshot.docs.forEach(docSnap => {
                const data = docSnap.data();
                
                // CHECK 1: Migration for "actionableSteps" -> "suggested_actions"
                if (data.actionableSteps && !data.suggested_actions) {
                    batch.update(docSnap.ref, { 
                        suggested_actions: data.actionableSteps,
                        migratedAt: new Date()
                    });
                    updatedCount++;
                    operationCounter++;
                }

                // Future schema migrations can be added here
            });

            if (updatedCount === 0) {
                setStatus("Schema is up to date. No migration needed.");
                setLoading(false);
                return;
            }

            if (operationCounter > 0) {
                await batch.commit();
            }

            setStatus(`Successfully migrated ${updatedCount} legacy records to v4.5 schema.`);

        } catch (e) {
            console.error("Migration failed", e);
            setStatus("Migration failed. Check console.");
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div className="flex items-center gap-3 mb-4">
                <div className="p-2 bg-purple-50 rounded-lg text-purple-600">
                    <CircleStackIcon className="h-6 w-6" />
                </div>
                <h3 className="font-bold text-gray-900">Schema Migration</h3>
            </div>
            
            <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                Updates legacy Insight records to match the current database schema (v4.5). Run this if you see missing "Add to Quest" buttons on older logs.
            </p>
            
            {status && (
                <div className="mb-4 bg-blue-50 border border-blue-200 p-3 rounded-xl flex items-center gap-3 text-blue-800 text-sm font-medium animate-fadeIn">
                    {loading ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <CheckCircleIcon className="h-5 w-5" />}
                    {status}
                </div>
            )}

            <button 
                onClick={runMigration} 
                disabled={loading}
                className="w-full py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 disabled:opacity-50 transition-all active:scale-95"
            >
                Repair Database Schema
            </button>
        </div>
    );
}
--- END_FILE: src/components/admin/SchemaMigration.tsx ---

--- START_FILE: src/components/admin/UserDirectory.tsx ---
/**
 * src/components/admin/UserDirectory.tsx
 * GITHUB COMMENT:
 * [UserDirectory.tsx]
 * FIX: Resolved implicit 'any' type errors for strict mode compliance.
 */
import { useState } from 'react';
import { db } from '../../lib/firebase';
import { 
    collection, 
    getDocs, 
    updateDoc, 
    doc, 
    type Firestore,
    Timestamp 
} from 'firebase/firestore';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { TableVirtuoso } from 'react-virtuoso';
import { 
    UserCircleIcon, 
    ClockIcon, 
    MagnifyingGlassIcon 
} from '@heroicons/react/24/outline';

interface UserMeta {
    uid: string;
    email: string;
    displayName: string;
    role?: 'user' | 'admin';
    lastLogin?: Timestamp;
    createdAt?: Timestamp;
}

export default function UserDirectory() {
    const [searchTerm, setSearchTerm] = useState('');
    const queryClient = useQueryClient();

    const { data: users = [], isLoading } = useQuery({
        queryKey: ['admin_users'],
        queryFn: async () => {
            if (!db) return [];
            const database: Firestore = db;
            const snap = await getDocs(collection(database, 'users'));
            const data = snap.docs.map(d => ({ uid: d.id, ...d.data() } as UserMeta));
            // Sort Descending by Last Login
            return data.sort((a, b) => {
                const timeA = a.lastLogin?.toMillis() || 0;
                const timeB = b.lastLogin?.toMillis() || 0;
                return timeB - timeA;
            });
        }
    });

    const toggleRole = async (uid: string, currentRole?: string) => {
        if (!db) return;
        if (!confirm(`Are you sure you want to change this user's role?`)) return;

        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        try {
            await updateDoc(doc(db, 'users', uid), { role: newRole });
            queryClient.invalidateQueries({ queryKey: ['admin_users'] });
        } catch (e) {
            console.error("Failed to update role", e);
            alert("Error updating role.");
        }
    };

    const filteredUsers = users.filter((u: UserMeta) => 
        u.email?.toLowerCase().includes(searchTerm.toLowerCase()) || 
        u.displayName?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (isLoading) return <div className="p-8 text-center text-gray-400">Loading directory...</div>;

    return (
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-[600px] flex flex-col">
            <div className="p-4 border-b border-gray-100 flex justify-between items-center gap-4 shrink-0">
                <h3 className="font-bold text-gray-900 flex items-center gap-2">
                    <UserCircleIcon className="h-5 w-5 text-indigo-600" />
                    User Directory ({users.length})
                </h3>
                <div className="relative">
                    <MagnifyingGlassIcon className="h-4 w-4 text-gray-400 absolute left-3 top-2.5" />
                    <input 
                        type="text" 
                        placeholder="Search users..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="pl-9 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-64"
                    />
                </div>
            </div>

            <div className="flex-1">
                <TableVirtuoso
                    data={filteredUsers}
                    fixedHeaderContent={() => (
                        <tr className="bg-gray-50 text-gray-500 font-medium text-sm text-left">
                            <th className="px-6 py-3">User</th>
                            <th className="px-6 py-3">Role</th>
                            <th className="px-6 py-3">Last Active</th>
                            <th className="px-6 py-3 text-right">Actions</th>
                        </tr>
                    )}
                    itemContent={(_index, user) => (
                        <>
                            <td className="px-6 py-4">
                                <div className="font-bold text-gray-900">{user.displayName || 'Unknown'}</div>
                                <div className="text-xs text-gray-500">{user.email}</div>
                                <div className="text-[10px] text-gray-400 font-mono mt-0.5 select-all">{user.uid}</div>
                            </td>
                            <td className="px-6 py-4">
                                <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${
                                    user.role === 'admin' 
                                        ? 'bg-purple-100 text-purple-700 border-purple-200' 
                                        : 'bg-gray-100 text-gray-600 border-gray-200'
                                }`}>
                                    {user.role === 'admin' ? 'Admin' : 'User'}
                                </span>
                            </td>
                            <td className="px-6 py-4 text-gray-600">
                                <div className="flex items-center gap-1.5">
                                    <ClockIcon className="h-4 w-4 text-gray-400" />
                                    {user.lastLogin 
                                        ? new Date(user.lastLogin.toDate()).toLocaleDateString() 
                                        : 'Never'}
                                </div>
                            </td>
                            <td className="px-6 py-4 text-right">
                                <button 
                                    onClick={() => toggleRole(user.uid, user.role)}
                                    className="text-xs font-bold text-indigo-600 hover:text-indigo-800 hover:underline"
                                >
                                    {user.role === 'admin' ? 'Demote' : 'Promote'}
                                </button>
                            </td>
                        </>
                    )}
                />
            </div>
        </div>
    );
}
--- END_FILE: src/components/admin/UserDirectory.tsx ---

--- START_FILE: src/components/journal/JournalAnalysisWizard.tsx ---
/**
 * src/components/journal/JournalAnalysisWizard.tsx
 * GITHUB COMMENT:
 * [JournalAnalysisWizard.tsx]
 * FIX: Restored missing data mapping in saveInsight().
 * ENSURES: 'strengths' and 'risks' are saved to Firestore so they appear in the history log.
 */
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
    SparklesIcon, 
    XMarkIcon, 
    CalendarDaysIcon, 
    ChartBarIcon, 
    GlobeAmericasIcon, 
    CheckCircleIcon, 
    ExclamationTriangleIcon,
    ArrowPathIcon,
    BoltIcon,
    ShieldCheckIcon,
    PlusCircleIcon,
    TrophyIcon
} from '@heroicons/react/24/outline';
import { db } from '../../lib/firebase';
import { collection, addDoc, Timestamp, type Firestore } from 'firebase/firestore';
import { useAuth } from '../../contexts/AuthContext';
import { generateComparativeAnalysis, type ComparativeAnalysisResult } from '../../lib/gemini';
import type { JournalEntry } from './JournalEditor';
import { subDays, isAfter, isBefore, addDays } from 'date-fns';
import { useDeepPatternAnalysis } from '../../hooks/useDeepPatternAnalysis';
import { addTask } from '../../lib/tasks';

interface WizardProps {
    isOpen: boolean;
    onClose: () => void;
    entries: JournalEntry[]; 
}

type AnalysisScope = 'weekly' | 'monthly' | 'all-time';

export default function JournalAnalysisWizard({ isOpen, onClose, entries }: WizardProps) {
    const { user } = useAuth();
    const [step, setStep] = useState<'select' | 'analyzing' | 'results'>('select');
    const [scope, setScope] = useState<AnalysisScope>('weekly');
    
    const [standardResult, setStandardResult] = useState<ComparativeAnalysisResult | null>(null);
    
    const { 
        analyze: runDeepAnalysis, 
        progress: deepProgress, 
        result: deepResult,
        error: deepError 
    } = useDeepPatternAnalysis();

    const [saving, setSaving] = useState(false);
    const [addedActions, setAddedActions] = useState<Set<string>>(new Set());

    const runStandardAnalysis = async () => {
        setStep('analyzing');
        setAddedActions(new Set());
        
        try {
            const now = new Date();
            let currentSet: JournalEntry[] = [];
            let previousSet: JournalEntry[] = [];

            if (scope === 'weekly') {
                const oneWeekAgo = subDays(now, 7);
                const twoWeeksAgo = subDays(now, 14);
                const getDate = (e: JournalEntry) => e.createdAt instanceof Date ? e.createdAt : new Date(e.createdAt as unknown as string);

                currentSet = entries.filter(e => isAfter(getDate(e), oneWeekAgo));
                previousSet = entries.filter(e => isAfter(getDate(e), twoWeeksAgo) && isBefore(getDate(e), oneWeekAgo));
            } else if (scope === 'monthly') {
                const oneMonthAgo = subDays(now, 30);
                const twoMonthsAgo = subDays(now, 60);
                const getDate = (e: JournalEntry) => e.createdAt instanceof Date ? e.createdAt : new Date(e.createdAt as unknown as string);

                currentSet = entries.filter(e => isAfter(getDate(e), oneMonthAgo));
                previousSet = entries.filter(e => isAfter(getDate(e), twoMonthsAgo) && isBefore(getDate(e), oneMonthAgo));
            }

            const formatSet = (set: JournalEntry[]) => set.map(e => {
                const d = e.createdAt instanceof Date ? e.createdAt : new Date(e.createdAt as unknown as string);
                return `[${d.toLocaleDateString()}] Mood: ${e.moodScore || 'N/A'}\n${e.content}`;
            }).join('\n---\n');
            
            const currentTxt = formatSet(currentSet);
            const prevTxt = formatSet(previousSet);

            if (!currentTxt) {
                alert("Not enough journal data for this period to perform an analysis.");
                setStep('select');
                return;
            }

            const analysis = await generateComparativeAnalysis(currentTxt, prevTxt, scope);
            setStandardResult(analysis);
            setStep('results');

        } catch (error) {
            console.error(error);
            alert("Analysis failed. Please try again.");
            setStep('select');
        }
    };

    const handleStartAnalysis = () => {
        if (scope === 'all-time') {
            setStep('analyzing');
            setAddedActions(new Set());
            runDeepAnalysis().then(() => {
                setStep('results');
            });
        } else {
            runStandardAnalysis();
        }
    };

    const handleAddToTasks = async (action: string) => {
        if (!user) return;
        try {
            const dueDate = addDays(new Date(), 7);
            await addTask(user.uid, action, 'once', 'Medium', dueDate);
            setAddedActions(prev => new Set(prev).add(action));
        } catch (e) {
            console.error("Failed to add task", e);
        }
    };

    const saveInsight = async () => {
        if (!user || !db) return;
        setSaving(true);
        const database: Firestore = db;

        try {
            if (scope === 'all-time' && deepResult) {
                // Save Deep Result (Unchanged)
                await addDoc(collection(database, 'insights'), {
                    uid: user.uid,
                    type: 'journal',
                    summary: deepResult.pattern_summary,
                    pillars: {
                        understanding: deepResult.core_triggers.join(', '),
                        growth: deepResult.emotional_velocity,
                        blind_spots: deepResult.hidden_correlations.join(', ')
                    },
                    suggested_actions: deepResult.long_term_advice.slice(0, 3), 
                    createdAt: Timestamp.now(),
                    scope_context: 'Deep Pattern Recognition',
                    risks: [`Risk Level: ${deepResult.relapse_risk_level}`]
                });
            } else if (standardResult) {
                // Save Standard Result
                await addDoc(collection(database, 'insights'), {
                    uid: user.uid,
                    type: 'journal',
                    summary: standardResult.comparison_summary,
                    pillars: {
                        understanding: standardResult.key_themes.join(', '),
                        growth: standardResult.wins.join(', '),
                        blind_spots: standardResult.blind_spots.join(', ')
                    },
                    // --- MISSING LINES RESTORED BELOW ---
                    strengths: standardResult.wins,
                    risks: standardResult.blind_spots,
                    // ------------------------------------
                    suggested_actions: standardResult.actionable_advice.slice(0, 3), 
                    createdAt: Timestamp.now(),
                    scope_context: `${scope.charAt(0).toUpperCase() + scope.slice(1)} Comparative Review`
                });
            }
            onClose();
        } catch (e) {
            console.error(e);
        } finally {
            setSaving(false);
        }
    };

    return (
        <Transition.Root show={isOpen} as={Fragment}>
            <Dialog as="div" className="relative z-50" onClose={onClose}>
                <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" />
                <div className="fixed inset-0 flex items-center justify-center p-4">
                    <Dialog.Panel className="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 max-h-[90vh] flex flex-col">
                        
                        <div className="bg-gradient-to-r from-fuchsia-600 to-purple-600 px-6 py-4 flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-2 text-white">
                                <SparklesIcon className="h-6 w-6" />
                                <h3 className="font-bold text-lg">
                                    {scope === 'all-time' ? 'Deep Pattern Engine' : 'Analysis Wizard'}
                                </h3>
                            </div>
                            <button onClick={onClose} className="text-white/80 hover:text-white"><XMarkIcon className="h-6 w-6" /></button>
                        </div>

                        <div className="p-6 overflow-y-auto">
                            {step === 'select' && (
                                <div className="space-y-4">
                                    <p className="text-gray-600 text-sm text-center mb-6">Select a timeframe to analyze. The AI will compare your current progress against previous patterns.</p>
                                    
                                    <button onClick={() => setScope('weekly')} className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${scope === 'weekly' ? 'border-fuchsia-500 bg-fuchsia-50' : 'border-gray-100 hover:border-fuchsia-200'}`}>
                                        <div className="bg-white p-3 rounded-full shadow-sm text-fuchsia-600"><CalendarDaysIcon className="h-6 w-6" /></div>
                                        <div className="text-left"><div className="font-bold text-gray-900">Weekly Check-in</div><div className="text-xs text-gray-500">Last 7 days vs Previous 7 days</div></div>
                                    </button>

                                    <button onClick={() => setScope('monthly')} className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${scope === 'monthly' ? 'border-purple-500 bg-purple-50' : 'border-gray-100 hover:border-purple-200'}`}>
                                        <div className="bg-white p-3 rounded-full shadow-sm text-purple-600"><ChartBarIcon className="h-6 w-6" /></div>
                                        <div className="text-left"><div className="font-bold text-gray-900">Monthly Review</div><div className="text-xs text-gray-500">Last 30 days vs Previous 30 days</div></div>
                                    </button>

                                    <button onClick={() => setScope('all-time')} className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 transition-all ${scope === 'all-time' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100 hover:border-indigo-200'}`}>
                                        <div className="bg-white p-3 rounded-full shadow-sm text-indigo-600"><GlobeAmericasIcon className="h-6 w-6" /></div>
                                        <div className="text-left"><div className="font-bold text-gray-900">Deep Dive (90 Days)</div><div className="text-xs text-gray-500">Identify relapse triggers & patterns</div></div>
                                    </button>

                                    <button onClick={handleStartAnalysis} className="w-full mt-4 py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white font-bold rounded-xl shadow-md hover:shadow-lg active:scale-95 transition-all">
                                        Begin Analysis
                                    </button>
                                </div>
                            )}

                            {step === 'analyzing' && (
                                <div className="py-12 flex flex-col items-center justify-center text-center space-y-4">
                                    <div className="relative">
                                        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-fuchsia-600"></div>
                                        {scope === 'all-time' && (
                                            <div className="absolute inset-0 flex items-center justify-center text-xs font-bold text-fuchsia-600">
                                                {deepProgress}%
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <h4 className="text-lg font-bold text-gray-900">
                                            {scope === 'all-time' ? 'Processing Vault...' : 'Consulting the Compass...'}
                                        </h4>
                                        <p className="text-sm text-gray-500 mt-2 max-w-xs mx-auto">
                                            {scope === 'all-time' 
                                                ? "Decrypting your history and finding hidden patterns." 
                                                : "Comparing periods and identifying trajectory."}
                                        </p>
                                    </div>
                                </div>
                            )}

                            {step === 'results' && (deepError) && (
                                <div className="text-center py-8">
                                    <ExclamationTriangleIcon className="h-12 w-12 text-red-500 mx-auto mb-4" />
                                    <h3 className="text-lg font-bold text-gray-900">Analysis Failed</h3>
                                    <p className="text-gray-500 mb-4">{deepError}</p>
                                    <button onClick={() => setStep('select')} className="text-indigo-600 font-bold hover:underline">Try Again</button>
                                </div>
                            )}

                            {step === 'results' && !deepError && (
                                <div className="space-y-6 animate-fadeIn">
                                    
                                    {/* --- DEEP PATTERN RESULTS --- */}
                                    {scope === 'all-time' && deepResult && (
                                        <>
                                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
                                                <h5 className="text-xs font-bold text-indigo-800 uppercase mb-2">Psychological Landscape</h5>
                                                <p className="text-sm text-indigo-900 leading-relaxed">{deepResult.pattern_summary}</p>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                    <h5 className="text-xs font-bold text-orange-800 uppercase flex items-center gap-1 mb-2">
                                                        <BoltIcon className="h-4 w-4" /> Core Triggers
                                                    </h5>
                                                    <ul className="text-xs text-orange-900 space-y-1">
                                                        {deepResult.core_triggers.map((t, i) => <li key={i}>‚Ä¢ {t}</li>)}
                                                    </ul>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                                    <h5 className="text-xs font-bold text-blue-800 uppercase flex items-center gap-1 mb-2">
                                                        <ArrowPathIcon className="h-4 w-4" /> Velocity
                                                    </h5>
                                                    <p className="text-xs text-blue-900">{deepResult.emotional_velocity}</p>
                                                </div>
                                            </div>

                                            <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                                <h5 className="text-xs font-bold text-yellow-800 uppercase flex items-center gap-1 mb-2">
                                                    <ShieldCheckIcon className="h-4 w-4" /> Hidden Correlations
                                                </h5>
                                                <ul className="text-xs text-yellow-900 space-y-1">
                                                    {deepResult.hidden_correlations.map((c, i) => <li key={i}>‚Ä¢ {c}</li>)}
                                                </ul>
                                            </div>

                                            <div className="bg-gray-900 text-white p-4 rounded-xl">
                                                <h5 className="text-xs font-bold text-gray-400 uppercase mb-2">Long-Term Strategy (Choose to Add)</h5>
                                                <div className="space-y-2">
                                                    {/* CRITICAL: Enforced .slice(0, 3) to ensure rule of 3 in UI */}
                                                    {deepResult.long_term_advice.slice(0, 3).map((action, i) => (
                                                        <div key={i} className="flex items-center justify-between gap-2 text-sm bg-gray-800/50 p-2 rounded-lg group hover:bg-gray-800 transition-colors">
                                                            <div className="flex items-start gap-2">
                                                                <span className="font-bold text-gray-500">‚Üí</span>
                                                                <span>{action}</span>
                                                            </div>
                                                            <button
                                                                onClick={() => !addedActions.has(action) && handleAddToTasks(action)}
                                                                disabled={addedActions.has(action)}
                                                                className={`p-1.5 rounded-full transition-all ${addedActions.has(action) ? 'text-green-400 bg-green-900/50' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`}
                                                                title={addedActions.has(action) ? "Added to Quests" : "Add to Quests"}
                                                            >
                                                                {addedActions.has(action) ? <CheckCircleIcon className="h-5 w-5" /> : <PlusCircleIcon className="h-5 w-5" />}
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </>
                                    )}

                                    {/* --- STANDARD RESULTS --- */}
                                    {scope !== 'all-time' && standardResult && (
                                        <>
                                            <div className="flex items-center justify-between">
                                                <div className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border ${
                                                    standardResult.trajectory === 'Improving' ? 'bg-green-100 text-green-700 border-green-200' : 
                                                    standardResult.trajectory === 'Declining' ? 'bg-red-100 text-red-700 border-red-200' :
                                                    'bg-blue-100 text-blue-700 border-blue-200'
                                                }`}>
                                                    Trajectory: {standardResult.trajectory}
                                                </div>
                                                <span className="text-xs text-gray-400 font-mono">AI Generated</span>
                                            </div>

                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm text-gray-700 leading-relaxed">
                                                {standardResult.comparison_summary}
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <h5 className="text-xs font-bold text-green-700 uppercase flex items-center gap-1">
                                                        <TrophyIcon className="h-4 w-4" /> Strengths & Wins
                                                    </h5>
                                                    <ul className="text-xs text-gray-600 space-y-1">{standardResult.wins.map((w,i) => <li key={i}>‚Ä¢ {w}</li>)}</ul>
                                                </div>
                                                <div className="space-y-2">
                                                    <h5 className="text-xs font-bold text-orange-700 uppercase flex items-center gap-1">
                                                        <ExclamationTriangleIcon className="h-4 w-4" /> Risk Analysis
                                                    </h5>
                                                    <ul className="text-xs text-gray-600 space-y-1">{standardResult.blind_spots.map((w,i) => <li key={i}>‚Ä¢ {w}</li>)}</ul>
                                                </div>
                                            </div>

                                            <div className="bg-fuchsia-50 p-4 rounded-xl border border-fuchsia-100">
                                                <h5 className="text-xs font-bold text-fuchsia-800 uppercase mb-2">Suggested Actions (Choose to Add)</h5>
                                                <div className="space-y-2">
                                                    {standardResult.actionable_advice.slice(0, 3).map((action, i) => (
                                                        <div key={i} className="flex items-center justify-between gap-2 text-xs text-fuchsia-900 bg-white/50 p-2 rounded-lg group hover:bg-white/80 transition-colors">
                                                            <div className="flex items-start gap-2">
                                                                <span className="font-bold text-fuchsia-400">{i+1}.</span> 
                                                                <span>{action}</span>
                                                            </div>
                                                            <button
                                                                onClick={() => !addedActions.has(action) && handleAddToTasks(action)}
                                                                disabled={addedActions.has(action)}
                                                                className={`p-1 rounded-full transition-all ${addedActions.has(action) ? 'text-green-600 bg-green-100' : 'text-fuchsia-400 hover:text-fuchsia-600 hover:bg-fuchsia-100'}`}
                                                                title={addedActions.has(action) ? "Added to Quests" : "Add to Quests"}
                                                            >
                                                                {addedActions.has(action) ? <CheckCircleIcon className="h-5 w-5" /> : <PlusCircleIcon className="h-5 w-5" />}
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </>
                                    )}

                                    <button onClick={saveInsight} disabled={saving} className="w-full py-3 bg-gray-900 text-white font-bold rounded-xl shadow-md hover:bg-black transition-all disabled:opacity-50">
                                        {saving ? 'Saving...' : 'Save to Insights Log'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </Dialog.Panel>
                </div>
            </Dialog>
        </Transition.Root>
    );
}
--- END_FILE: src/components/journal/JournalAnalysisWizard.tsx ---

--- START_FILE: src/components/journal/JournalEditor.tsx ---
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useEncryption } from '../../contexts/EncryptionContext'; // NEW: Import Encryption
import { db } from '../../lib/firebase';
import { collection, addDoc, Timestamp, doc, updateDoc, query, where, orderBy, limit, getDocs } from 'firebase/firestore';
import { 
    PlusIcon, 
    Cog6ToothIcon,
    MapPinIcon,
    ArrowPathIcon,
    TagIcon,
    XMarkIcon
} from '@heroicons/react/24/outline';
import { getUserTemplates, type JournalTemplate } from '../../lib/db';
import { getCurrentWeather } from '../../lib/weather';
import { useNavigate } from 'react-router-dom';

// --- Types ---

interface JournalDocData {
    tags?: string[];
    [key: string]: unknown;
}

export interface JournalEntry {
  id: string;
  content: string;
  moodScore: number;
  sentiment?: string;
  createdAt: Timestamp; 
  tags?: string[];
  weather?: { temp: number; condition: string } | null;
  isEncrypted?: boolean; // NEW: Added encryption flag
}

interface ExtendedJournalTemplate extends JournalTemplate {
    content?: string;
}

interface JournalEditorProps {
  initialEntry: JournalEntry | null;
  initialTemplateId?: string | null;
  onSaveComplete: () => void;
}

const DEFAULT_TEMPLATES = [
  { id: 'morning_checkin', name: 'Morning Check-in', text: "Morning Check-in ‚òÄÔ∏è\n\nHow am I feeling today?\n\n\nWhat is my main focus for today?\n\n\nOne thing I am grateful for:\n", tags: ['Morning'] },
  { id: 'nightly_review', name: 'Nightly Review', text: "Nightly Review üåô\n\nWhat went well today?\n\n\nWhat challenged me?\n\n\nDid I stay sober today?\n", tags: ['Nightly'] },
  { id: 'urge_log', name: 'Urge Log (SOS)', text: "Urge Log üö®\n\nTrigger:\n\n\nIntensity (1-10):\n\n\nCoping Strategy Used:\n", tags: ['Urge', 'SOS'] },
  { id: 'meeting_reflection', name: 'Meeting Reflection', text: "Meeting Reflection ü™ë\n\nMeeting Topic:\n\n\nOne thing I heard that resonated:\n\n\nHow can I apply this?\n", tags: ['Meeting'] },
];

export default function JournalEditor({ initialEntry, initialTemplateId, onSaveComplete }: JournalEditorProps) {
  const { user } = useAuth();
  const { encrypt } = useEncryption(); // NEW: Destructure encrypt function
  const navigate = useNavigate();

  // State
  const [newEntry, setNewEntry] = useState('');
  const [mood, setMood] = useState(5);
  const [weather, setWeather] = useState<{ temp: number; condition: string } | null>(null);
  const [saving, setSaving] = useState(false);
  const [weatherLoading, setWeatherLoading] = useState(false);
  
  // Tag State
  const [tags, setTags] = useState<string[]>([]);
  const [tagInput, setTagInput] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  
  // Template State
  const [customTemplates, setCustomTemplates] = useState<JournalTemplate[]>([]);
  const [activeTemplate, setActiveTemplate] = useState<JournalTemplate | null>(null);
  const [formAnswers, setFormAnswers] = useState<string[]>([]);

  // --- Helper Functions ---

  const fetchLocalWeather = useCallback(async () => {
    setWeatherLoading(true);
    try {
      const data = await getCurrentWeather();
      if (data) {
        setWeather({
          temp: Math.round(data.temp),
          condition: data.condition
        });
      }
    } catch (e) {
      console.warn("Failed to auto-load weather", e);
    } finally {
      setWeatherLoading(false);
    }
  }, []);

  const loadCustomTemplates = useCallback(async () => {
    if (!user) return;
    try {
        const t = await getUserTemplates(user.uid);
        setCustomTemplates(t);
    } catch (e) {
        console.error("Failed to load templates", e);
    }
  }, [user]);

  const loadUserTags = useCallback(async () => {
    if (!user || !db) return;
    try {
        const q = query(
            collection(db, 'journals'),
            where('uid', '==', user.uid),
            orderBy('createdAt', 'desc'),
            limit(50)
        );
        const snapshot = await getDocs(q);
        const tagSet = new Set<string>();
        snapshot.docs.forEach(doc => {
            const data = doc.data() as JournalDocData; 
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach((t: string) => tagSet.add(t));
            }
        });
        setAvailableTags(Array.from(tagSet).sort());
    } catch (e) {
        console.warn("Failed to load user tags", e);
    }
  }, [user]);

  const handleTemplateSelect = useCallback((tId: string) => {
    const defTemplate = DEFAULT_TEMPLATES.find(t => t.id === tId);
    if (defTemplate) {
        setNewEntry(defTemplate.text);
        setTags(prev => [...new Set([...prev, ...defTemplate.tags])]);
        setActiveTemplate(null);
        return;
    }

    const custTemplate = customTemplates.find(t => t.id === tId) as ExtendedJournalTemplate | undefined;
    
    if (custTemplate) {
        // Free Text Mode
        if (custTemplate.content) {
            setNewEntry(custTemplate.content);
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
            setActiveTemplate(null); 
        } 
        // Form Mode
        else if (custTemplate.prompts) {
            setActiveTemplate(custTemplate);
            setFormAnswers(new Array(custTemplate.prompts.length).fill(''));
            setNewEntry('');
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
        }
    } else {
        setActiveTemplate(null);
        setNewEntry('');
        setTags([]);
    }
  }, [customTemplates]); 

  // --- Effects ---

  useEffect(() => {
    if (!user) return;
    loadCustomTemplates();
    loadUserTags();
    if (!initialEntry) fetchLocalWeather(); 
  }, [user, initialEntry, loadCustomTemplates, loadUserTags, fetchLocalWeather]);

  useEffect(() => {
    if (initialEntry) {
      setNewEntry(initialEntry.content);
      setMood(initialEntry.moodScore);
      setTags(initialEntry.tags || []);
      if (initialEntry.weather) {
        setWeather(initialEntry.weather);
      }
      setActiveTemplate(null);
    } else {
      setNewEntry('');
      setMood(5);
      setTags([]);
      setActiveTemplate(null);
      setFormAnswers([]);
      setWeather(null);
      fetchLocalWeather(); 

      if (initialTemplateId) {
          handleTemplateSelect(initialTemplateId);
      }
    }
  }, [initialEntry, initialTemplateId, handleTemplateSelect, fetchLocalWeather]);

  // Tag Handling
  const handleAddTag = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTag(tagInput);
    } else if (e.key === 'Backspace' && tagInput === '' && tags.length > 0) {
        setTags(prev => prev.slice(0, -1));
    }
  };

  const addTag = (tagName: string) => {
    const cleanTag = tagName.trim().replace(/^#/, '');
    if (cleanTag && !tags.includes(cleanTag)) {
        setTags([...tags, cleanTag]);
    }
    setTagInput('');
    setShowSuggestions(false);
  };

  const removeTag = (tagToRemove: string) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  const filteredSuggestions = availableTags.filter(t => 
    t.toLowerCase().includes(tagInput.toLowerCase()) && !tags.includes(t)
  );

  // --- SAVE HANDLER (With Encryption) ---
  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db) return;

    const isFormValid = activeTemplate && formAnswers.some(a => a.trim() !== '');
    const isTextValid = !activeTemplate && newEntry.trim() !== '';

    if (!isFormValid && !isTextValid) return;

    setSaving(true);

    // 1. Prepare Content
    let plainContent = newEntry;
    if (activeTemplate) {
        plainContent = `**${activeTemplate.name}**\n\n`;
        activeTemplate.prompts.forEach((prompt, idx) => {
            plainContent += `**${prompt}**\n${formAnswers[idx] || '-(Skipped)-'}\n\n`;
        });
    }

    try {
      // 2. Encrypt Content
      let contentToSave = plainContent;
      let isEncrypted = false;

      try {
        contentToSave = await encrypt(plainContent);
        isEncrypted = true;
      } catch (err) {
        console.error("Encryption failed", err);
        alert("Security Error: Could not encrypt. Save aborted.");
        setSaving(false);
        return;
      }

      // 3. Save to Firestore
      if (initialEntry) {
        await updateDoc(doc(db, 'journals', initialEntry.id), { 
            content: contentToSave, 
            moodScore: mood,
            tags: tags,
            isEncrypted: isEncrypted
        });
      } else {
        await addDoc(collection(db, 'journals'), {
          uid: user.uid,
          content: contentToSave,
          moodScore: mood,
          sentiment: 'Pending', 
          weather, 
          tags: tags,
          createdAt: Timestamp.now(),
          isEncrypted: isEncrypted
        });
      }

      // Reset
      setNewEntry('');
      setFormAnswers([]);
      setActiveTemplate(null);
      setMood(5);
      setTags([]);
      onSaveComplete();
    } catch (error) {
      console.error("Error saving entry:", error);
      alert("Failed to save entry.");
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-visible relative">
        
        {/* HEADER */}
        <div className="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center gap-3">
             
             {/* LEFT: Weather Widget */}
             <div>
                 {weather ? (
                   <div className="flex items-center gap-2 text-xs text-gray-500 bg-white px-2 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                      <span>{weather.condition}</span>
                      <span className="font-bold">{weather.temp}¬∞C</span>
                      {!initialEntry && (
                          <button type="button" onClick={fetchLocalWeather} disabled={weatherLoading} className="ml-1 text-blue-400 hover:text-blue-600">
                              <ArrowPathIcon className={`h-3 w-3 ${weatherLoading ? 'animate-spin' : ''}`} />
                          </button>
                      )}
                   </div>
                ) : (
                    !initialEntry && (
                        <button 
                            type="button" 
                            onClick={fetchLocalWeather} 
                            disabled={weatherLoading}
                            className="flex items-center gap-1 text-xs text-gray-500 hover:text-blue-600 bg-white hover:bg-blue-50 px-2 py-1.5 rounded-lg border border-gray-200 transition-colors shadow-sm"
                        >
                            {weatherLoading ? (
                                <ArrowPathIcon className="h-3 w-3 animate-spin" />
                            ) : (
                                <MapPinIcon className="h-3 w-3" />
                            )}
                            <span>Add Weather</span>
                        </button>
                    )
                )}
             </div>

             {/* RIGHT: Template Controls */}
             <div className="flex items-center gap-2">
                 <div className="relative">
                     <select 
                        onChange={(e) => handleTemplateSelect(e.target.value)}
                        className="pl-3 pr-8 py-1.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white"
                        defaultValue=""
                        disabled={!!initialEntry} 
                    >
                        <option value="" disabled>Choose a Template...</option>
                        <option value="none">Free Write (Blank)</option>
                        <optgroup label="Standard">
                            {DEFAULT_TEMPLATES.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </optgroup>
                        {customTemplates.length > 0 && (
                            <optgroup label="My Templates">
                                {customTemplates.map(t => (
                                    <option key={t.id} value={t.id}>{t.name}</option>
                                ))}
                            </optgroup>
                        )}
                    </select>
                 </div>

                 <button 
                    onClick={() => navigate('/templates')}
                    className="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition"
                    title="Manage Templates"
                 >
                    <Cog6ToothIcon className="h-5 w-5" />
                 </button>
             </div>
        </div>
        
        <form onSubmit={handleSave} className="p-4 space-y-4">
          
          {/* EDITOR AREA */}
          {activeTemplate ? (
             <div className="space-y-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-blue-900">{activeTemplate.name}</h3>
                    <button 
                        type="button" 
                        onClick={() => setActiveTemplate(null)}
                        className="text-xs text-blue-500 hover:text-blue-700 underline"
                    >
                        Switch to Text Mode
                    </button>
                </div>
                
                {activeTemplate.prompts.map((prompt, idx) => (
                    <div key={idx}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{prompt}</label>
                        <textarea
                            rows={4} 
                            value={formAnswers[idx] || ''}
                            onChange={(e) => {
                                const newAns = [...formAnswers];
                                newAns[idx] = e.target.value;
                                setFormAnswers(newAns);
                            }}
                            className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                            placeholder="Type your answer..."
                        />
                    </div>
                ))}
             </div>
          ) : (
            <textarea
                value={newEntry}
                onChange={(e) => setNewEntry(e.target.value)}
                placeholder="How are you feeling today?"
                className="w-full h-[45vh] p-4 rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm resize-none text-gray-700 leading-relaxed font-mono"
            />
          )}

          {/* MOOD SLIDER */}
          <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
             <div className="flex items-center justify-between mb-2">
                <label className="text-sm font-medium text-gray-700">Mood Score</label>
                <span className={`text-sm font-bold px-2 py-0.5 rounded ${mood >= 7 ? 'text-green-700 bg-green-100' : mood <= 4 ? 'text-red-700 bg-red-100' : 'text-yellow-700 bg-yellow-100'}`}>
                    {mood}/10
                </span>
             </div>
             <input 
                 type="range" 
                 min="1" 
                 max="10" 
                 value={mood}
                 onChange={(e) => setMood(Number(e.target.value))}
                 className="w-full accent-blue-600 cursor-pointer"
             />
             <div className="flex justify-between text-xs text-gray-400 mt-1">
                 <span>Struggling</span>
                 <span>Neutral</span>
                 <span>Thriving</span>
             </div>
          </div>

          {/* FOOTER */}
          <div className="flex flex-col sm:flex-row items-center gap-4">
            
            {/* TAG INPUT */}
            <div className="relative group w-full sm:flex-1">
                <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500">
                    <TagIcon className="h-4 w-4 text-gray-400" />
                    
                    {tags.map(tag => (
                        <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                            {tag}
                            <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                                <XMarkIcon className="h-3 w-3" />
                            </button>
                        </span>
                    ))}

                    <input 
                        type="text"
                        value={tagInput}
                        onChange={(e) => {
                            setTagInput(e.target.value);
                            setShowSuggestions(true);
                        }}
                        onKeyDown={handleAddTag}
                        onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                        placeholder={tags.length === 0 ? "Add tags (e.g. Grateful)..." : ""}
                        className="flex-1 min-w-[120px] text-sm border-none focus:ring-0 p-0 text-gray-700 placeholder:text-gray-400"
                    />
                </div>

                {/* Autocomplete Suggestions */}
                {showSuggestions && tagInput && filteredSuggestions.length > 0 && (
                    <div className="absolute bottom-full left-0 mb-1 w-full max-w-sm bg-white rounded-lg shadow-lg border border-gray-200 max-h-40 overflow-y-auto z-50">
                        {filteredSuggestions.map(tag => (
                            <button
                                key={tag}
                                type="button"
                                className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors"
                                onClick={() => addTag(tag)}
                            >
                                {tag}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* Save Button */}
            <button
              type="submit"
              disabled={saving}
              className="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition-all active:scale-95 disabled:opacity-50 whitespace-nowrap"
            >
              {saving ? (
                <span>Saving...</span>
              ) : (
                <>
                  <PlusIcon className="h-5 w-5" />
                  <span>{initialEntry ? 'Update Entry' : 'Save Entry'}</span>
                </>
              )}
            </button>
          </div>
        </form>
      </div>
  );
}
--- END_FILE: src/components/journal/JournalEditor.tsx ---

--- START_FILE: src/components/journal/JournalHistory.tsx ---
/**
 * src/components/journal/JournalHistory.tsx
 * GITHUB COMMENT:
 * [JournalHistory.tsx]
 * FIX: Resolved strict type mismatches and unused variables.
 * PERFORMANCE: Maintained Virtuoso implementation.
 */
import { useState, useMemo } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useEncryption } from '../../contexts/EncryptionContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs, deleteDoc, doc, Timestamp, type Firestore } from 'firebase/firestore';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { groupItemsByDate } from '../../lib/grouping';
import type { JournalEntry } from './JournalEditor';
import JournalAnalysisWizard from './JournalAnalysisWizard';
import { Virtuoso } from 'react-virtuoso';
import { 
    TrashIcon, 
    PencilSquareIcon, 
    ShieldExclamationIcon, 
    ShareIcon, 
    CheckIcon, 
    SparklesIcon 
} from '@heroicons/react/24/outline';

type JournalEntryWithStatus = JournalEntry & { isError?: boolean };

// Flattened Item Type for Virtuoso
type HistoryItem = 
    | { type: 'header'; title: string }
    | { type: 'entry'; data: JournalEntryWithStatus };

interface JournalHistoryProps {
  onEdit: (entry: JournalEntry) => void;
}

export default function JournalHistory({ onEdit }: JournalHistoryProps) {
  const { user } = useAuth();
  const { decrypt } = useEncryption();
  const queryClient = useQueryClient();

  const [copiedId, setCopiedId] = useState<string | null>(null);
  const [isWizardOpen, setIsWizardOpen] = useState(false);

  // --- REACT QUERY FETCH ---
  const { data: allEntries = [], isLoading } = useQuery({
    queryKey: ['journals', user?.uid],
    queryFn: async () => {
        if (!user || !db) return [];
        const database: Firestore = db;
        const q = query(
            collection(database, 'journals'), 
            where('uid', '==', user.uid),
            orderBy('createdAt', 'desc')
        );
        const snapshot = await getDocs(q);
        
        // Decrypt in parallel
        return await Promise.all(snapshot.docs.map(async (docSnap) => {
            const data = docSnap.data();
            let content = data.content;
            let isError = false;

            if (data.isEncrypted) {
                try {
                    content = await decrypt(data.content);
                } catch (err) {
                    console.error(`Failed to decrypt entry ${docSnap.id}:`, err);
                    content = "üîí [Locked - Decryption Failed]";
                    isError = true;
                }
            }

            let createdDate = new Date();
            if (data.createdAt?.toDate) {
                createdDate = data.createdAt.toDate();
            } else if (data.createdAt instanceof Timestamp) {
                createdDate = data.createdAt.toDate();
            }

            return { 
                id: docSnap.id, 
                ...data, 
                content, 
                createdAt: createdDate,
                isError          
            } as unknown as JournalEntryWithStatus;
        }));
    },
    enabled: !!user,
  });

  // --- FLATTEN DATA FOR VIRTUALIZATION ---
  const flatData = useMemo(() => {
    // Cast to any to bypass strict type check for now, as grouping handles dates correctly internally
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const grouped = groupItemsByDate(allEntries as any[]);
    const result: HistoryItem[] = [];
    
    Object.entries(grouped).forEach(([header, entries]) => {
        result.push({ type: 'header', title: header });
        entries.forEach(entry => {
            result.push({ type: 'entry', data: entry as JournalEntryWithStatus });
        });
    });
    return result;
  }, [allEntries]);

  const handleDelete = async (id: string) => {
    if (!db) return;
    if (!confirm('Delete this entry?')) return;
    try {
      await deleteDoc(doc(db, 'journals', id));
      queryClient.invalidateQueries({ queryKey: ['journals'] });
    } catch (error) {
      console.error(error);
    }
  };

  const handleShare = async (entry: JournalEntryWithStatus) => {
    const dateStr = entry.createdAt instanceof Date ? entry.createdAt.toLocaleDateString() : 'Unknown Date';
    const textToShare = `${dateStr} - My Recovery Toolkit\n\n${entry.content}`;

    if (navigator.share) {
        try { await navigator.share({ title: 'Journal Entry', text: textToShare }); return; } catch (err) { console.log('Share dismissed', err); }
    }
    try {
        await navigator.clipboard.writeText(textToShare);
        setCopiedId(entry.id);
        setTimeout(() => setCopiedId(null), 2000);
    } catch (err) { console.error('Failed to copy', err); }
  };

  if (isLoading) return <div className="text-center py-10 text-gray-400">Loading History...</div>;
  if (flatData.length === 0) return <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300 shadow-sm"><p className="text-gray-500">No entries found.</p></div>;

  return (
    <div className="relative h-[calc(100vh-200px)]"> 
        <Virtuoso
            style={{ height: '100%' }}
            data={flatData}
            itemContent={(_index, item) => {
                if (item.type === 'header') {
                    return (
                        <div className="sticky top-0 z-10 bg-indigo-200/90 backdrop-blur-sm py-2 px-3 mb-2 mt-4 rounded-lg border-b border-indigo-300 shadow-sm">
                            <h3 className="text-xs font-bold text-indigo-900 uppercase tracking-wider">{item.title}</h3>
                        </div>
                    );
                }

                const entry = item.data;
                return (
                    <div className={`bg-white rounded-xl p-4 mb-3 shadow-sm border relative group ${entry.isError ? 'border-red-300 bg-red-50' : 'border-indigo-50'}`}>
                        <div className="flex justify-between items-start mb-2">
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-mono text-gray-400">
                                    {entry.createdAt instanceof Date ? entry.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                                </span>
                                {entry.moodScore && (
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${entry.moodScore >= 7 ? 'bg-green-100 text-green-700' : 'bg-indigo-50 text-indigo-700'}`}>
                                        Mood: {entry.moodScore}
                                    </span>
                                )}
                                {entry.isEncrypted && <ShieldExclamationIcon className={`h-3 w-3 ${entry.isError ? 'text-red-500' : 'text-emerald-500'}`} />}
                            </div>
                            
                            <div className="flex gap-1 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                <button onClick={() => handleShare(entry)} className="p-1.5 text-gray-400 hover:text-indigo-600 rounded-full hover:bg-indigo-50 transition-colors">
                                    {copiedId === entry.id ? <CheckIcon className="h-4 w-4 text-green-600" /> : <ShareIcon className="h-4 w-4" />}
                                </button>
                                <button onClick={() => onEdit(entry)} className="p-1.5 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition-colors"><PencilSquareIcon className="h-4 w-4" /></button>
                                <button onClick={() => handleDelete(entry.id)} className="p-1.5 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition-colors"><TrashIcon className="h-4 w-4" /></button>
                            </div>
                        </div>
                        <p className={`text-sm whitespace-pre-wrap leading-relaxed line-clamp-4 hover:line-clamp-none transition-all cursor-pointer ${entry.isError ? 'text-red-600 font-mono text-xs' : 'text-gray-800'}`}>
                            {entry.content}
                        </p>
                    </div>
                );
            }}
        />

        {/* FLOATING ACTION BUTTON */}
        <button
            onClick={() => setIsWizardOpen(true)}
            className="fixed bottom-24 right-4 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white p-4 rounded-full shadow-lg shadow-fuchsia-500/30 hover:scale-105 transition-all z-30 flex items-center gap-2 group"
        >
            <SparklesIcon className="h-6 w-6 group-hover:animate-pulse" />
            <span className="hidden group-hover:inline text-sm font-bold pr-1">Analyze</span>
        </button>

        <JournalAnalysisWizard 
            isOpen={isWizardOpen} 
            onClose={() => setIsWizardOpen(false)} 
            entries={allEntries} 
        />
    </div>
  );
}
--- END_FILE: src/components/journal/JournalHistory.tsx ---

--- START_FILE: src/components/journal/JournalInsights.tsx ---
import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';
import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell
} from 'recharts';
import { 
    FaceSmileIcon, 
    ChartBarIcon, 
    CloudIcon,
    FireIcon
} from '@heroicons/react/24/outline';

// --- TYPES ---
interface ChartDataPoint {
    date: string;
    mood: number;
}

interface SentimentDataPoint {
    name: string;
    value: number;
    [key: string]: unknown; 
}

interface WordFrequency {
    text: string;
    value: number;
}

const COLORS = ['#10B981', '#6366F1', '#F43F5E', '#F59E0B', '#8B5CF6'];

// Stop words to filter out of the cloud
const STOP_WORDS = new Set([
  'the', 'and', 'i', 'to', 'a', 'of', 'in', 'was', 'my', 'that', 'for', 'it', 'me', 'on', 
  'with', 'but', 'is', 'this', 'have', 'be', 'so', 'not', 'at', 'as', 'today', 'day', 
  'feeling', 'feel', 'am', 'just', 'had', 'very', 'really', 'will', 'up', 'out', 'from'
]);

export default function JournalInsights() {
  const { user } = useAuth();
  const [chartData, setChartData] = useState<ChartDataPoint[]>([]);
  const [sentimentData, setSentimentData] = useState<SentimentDataPoint[]>([]);
  const [wordCloudData, setWordCloudData] = useState<WordFrequency[]>([]);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({ total: 0, avgMood: 0, streak: 0 });

  useEffect(() => {
    async function loadData() {
        if (!user || !db) return;

        try {
            // Fetch last 60 days for robust data
            const q = query(
                collection(db, 'journals'), 
                where('uid', '==', user.uid),
                orderBy('createdAt', 'asc')
            );
            
            const snapshot = await getDocs(q);
            const rawData = snapshot.docs.map(d => d.data());

            // 1. CHART: Mood Trends (Last 14 entries)
            const trends: ChartDataPoint[] = rawData
                .filter(d => d.moodScore !== undefined)
                .map(d => ({
                    date: d.createdAt?.toDate 
                        ? d.createdAt.toDate().toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) 
                        : 'Unknown',
                    mood: d.moodScore
                }))
                .slice(-14);
            setChartData(trends);

            // 2. PIE: Sentiment Analysis
            const sentiments = rawData.reduce((acc: Record<string, number>, curr) => {
                const s = curr.sentiment || 'Neutral';
                acc[s] = (acc[s] || 0) + 1;
                return acc;
            }, {});
            const pieData = Object.keys(sentiments).map(key => ({
                name: key,
                value: sentiments[key]
            }));
            setSentimentData(pieData);

            // 3. WORD CLOUD: Text Analysis
            const textContent = rawData.map(d => d.content?.toLowerCase() || '').join(' ');
            const words = textContent.match(/\b\w+\b/g) || [];
            const frequency: Record<string, number> = {};
            
            words.forEach(word => {
                if (!STOP_WORDS.has(word) && word.length > 3) {
                    frequency[word] = (frequency[word] || 0) + 1;
                }
            });

            const topWords = Object.entries(frequency)
                .sort((a, b) => b[1] - a[1]) // Sort by count desc
                .slice(0, 20) // Top 20
                .map(([text, value]) => ({ text, value }));
            
            setWordCloudData(topWords);

            // 4. GENERAL STATS
            const totalMood = rawData.reduce((sum, curr) => sum + (curr.moodScore || 0), 0);
            
            // Calculate streak (consecutive days)
            // Simplified logic: Count entries in last X days
            
            setStats({
                total: rawData.length,
                avgMood: rawData.length > 0 ? Math.round((totalMood / rawData.length) * 10) / 10 : 0,
                streak: rawData.length // Placeholder logic
            });

        } catch (error) {
            console.error("Error loading insights:", error);
        } finally {
            setLoading(false);
        }
    }

    loadData();
  }, [user]);

  if (loading) return <div className="p-10 text-center text-gray-400 animate-pulse">Analyzing patterns...</div>;

  return (
    <div className="space-y-6 pb-20">
        
        {/* --- TOP STATS CARDS --- */}
        <div className="grid grid-cols-3 gap-3">
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-indigo-50 flex flex-col items-center justify-center">
                <div className="text-2xl font-black text-indigo-600">{stats.total}</div>
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Entries</div>
            </div>
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-purple-50 flex flex-col items-center justify-center">
                <div className="text-2xl font-black text-purple-600">{stats.avgMood}</div>
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Avg Mood</div>
            </div>
             <div className="bg-white p-4 rounded-2xl shadow-sm border border-orange-50 flex flex-col items-center justify-center">
                <FireIcon className="h-6 w-6 text-orange-500 mb-1" />
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Active</div>
            </div>
        </div>

        {/* --- MOOD TREND CHART --- */}
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-indigo-50">
            <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-6 text-sm uppercase tracking-wide">
                <ChartBarIcon className="h-4 w-4 text-indigo-500" />
                Mood Trajectory
            </h3>
            
            <div className="h-64 w-full min-w-0">
                <ResponsiveContainer width="100%" height="100%" debounce={200}>
                    <AreaChart data={chartData}>
                        <defs>
                            <linearGradient id="colorMood" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#6366F1" stopOpacity={0.3}/>
                                <stop offset="95%" stopColor="#6366F1" stopOpacity={0}/>
                            </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E0E7FF" />
                        <XAxis 
                            dataKey="date" 
                            tick={{fontSize: 10, fill: '#94A3B8'}} 
                            axisLine={false}
                            tickLine={false}
                            minTickGap={30}
                        />
                        <YAxis domain={[0, 10]} hide />
                        <Tooltip contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                        <Area type="monotone" dataKey="mood" stroke="#6366F1" strokeWidth={3} fillOpacity={1} fill="url(#colorMood)" />
                    </AreaChart>
                </ResponsiveContainer>
            </div>
        </div>

        {/* --- WORD CLOUD (Recurring Themes) --- */}
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-indigo-50">
            <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-6 text-sm uppercase tracking-wide">
                <CloudIcon className="h-4 w-4 text-blue-500" />
                Recurring Themes
            </h3>
            
            {wordCloudData.length === 0 ? (
                <div className="text-center py-8 text-gray-400 text-sm">Not enough data yet.</div>
            ) : (
                <div className="flex flex-wrap gap-2 justify-center items-center py-4">
                    {wordCloudData.map((word, i) => {
                        // Dynamic sizing based on frequency relative to max
                        const maxVal = wordCloudData[0].value;
                        const sizeClass = 
                            word.value > maxVal * 0.8 ? 'text-2xl font-black text-indigo-600' :
                            word.value > maxVal * 0.6 ? 'text-xl font-bold text-purple-600' :
                            word.value > maxVal * 0.4 ? 'text-lg font-semibold text-pink-500' :
                            'text-sm text-gray-500';

                        return (
                            <span key={i} className={`${sizeClass} transition-all hover:scale-110 cursor-default px-1`}>
                                {word.text}
                            </span>
                        );
                    })}
                </div>
            )}
        </div>

        {/* --- SENTIMENT PIE --- */}
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-indigo-50">
            <h3 className="flex items-center gap-2 font-bold text-gray-900 mb-6 text-sm uppercase tracking-wide">
                <FaceSmileIcon className="h-4 w-4 text-emerald-500" />
                Emotional Balance
            </h3>

            <div className="h-64 w-full relative min-w-0">
                <ResponsiveContainer width="100%" height="100%" debounce={200}>
                    <PieChart>
                        <Pie
                            data={sentimentData}
                            cx="50%"
                            cy="50%"
                            innerRadius={60}
                            outerRadius={80}
                            paddingAngle={5}
                            dataKey="value"
                        >
                            {sentimentData.map((_, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                        </Pie>
                        <Tooltip />
                    </PieChart>
                </ResponsiveContainer>
                
                {/* Center Label */}
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                     <div className="text-center">
                         <div className="text-xs text-gray-400 font-bold uppercase">Total</div>
                         <div className="text-xl font-black text-gray-800">{stats.total}</div>
                     </div>
                </div>
            </div>

            {/* Legend */}
            <div className="flex justify-center gap-4 mt-4 flex-wrap">
                {sentimentData.map((entry, index) => (
                    <div key={index} className="flex items-center gap-1.5">
                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                        <span className="text-xs font-medium text-gray-600">{entry.name}</span>
                    </div>
                ))}
            </div>
        </div>
    </div>
  );
}
--- END_FILE: src/components/journal/JournalInsights.tsx ---

--- START_FILE: src/components/journal/JournalTabs.tsx ---
import { PencilSquareIcon, ClockIcon, ChartPieIcon } from '@heroicons/react/24/outline';

interface JournalTabsProps {
  activeTab: 'write' | 'history' | 'insights';
  onChange: (tab: 'write' | 'history' | 'insights') => void;
}

export default function JournalTabs({ activeTab, onChange }: JournalTabsProps) {
  return (
    <div className="flex p-1 space-x-1 bg-blue-100/50 rounded-xl mb-6 overflow-x-auto">
      <button
        onClick={() => onChange('write')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'write'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <PencilSquareIcon className="w-4 h-4" />
        New Entry
      </button>
      <button
        onClick={() => onChange('history')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'history'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ClockIcon className="w-4 h-4" />
        History
      </button>
      <button
        onClick={() => onChange('insights')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'insights'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ChartPieIcon className="w-4 h-4" />
        Insights
      </button>
    </div>
  );
}
--- END_FILE: src/components/journal/JournalTabs.tsx ---

--- START_FILE: src/components/journal/TemplateEditor.tsx ---
import { useState, useEffect, useRef } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, addDoc, updateDoc, deleteDoc, doc, query, getDocs, Timestamp } from 'firebase/firestore';
import { 
    ArrowLeftIcon, 
    PlusIcon, 
    TrashIcon, 
    PencilSquareIcon,
    XMarkIcon,
    ListBulletIcon,
    HashtagIcon, 
    CheckCircleIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

// Local Type Definition
interface JournalTemplate {
    id: string;
    uid: string;
    name: string;
    content?: string; 
    prompts?: string[]; // Legacy support
    defaultTags: string[];
    createdAt: any;
}

export default function TemplateEditor() {
    const { user } = useAuth();
    const navigate = useNavigate();
    const [templates, setTemplates] = useState<JournalTemplate[]>([]);
    const [loading, setLoading] = useState(true);

    // Editor State
    const [isEditing, setIsEditing] = useState(false);
    const [editId, setEditId] = useState<string | null>(null);
    const [name, setName] = useState('');
    const [content, setContent] = useState('');
    const [tags, setTags] = useState<string[]>([]);
    const [tagInput, setTagInput] = useState('');
    const [saving, setSaving] = useState(false);

    const textareaRef = useRef<HTMLTextAreaElement>(null);

    useEffect(() => {
        if (!user) return;
        loadTemplates();
        console.log("Template Editor V2 Loaded"); // Debug check
    }, [user]);

    const loadTemplates = async () => {
        if (!user || !db) return;
        setLoading(true);
        try {
            const q = query(collection(db, 'users', user.uid, 'templates'));
            const snapshot = await getDocs(q);
            const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() } as JournalTemplate));
            setTemplates(data);
        } catch (error) {
            console.error("Failed to load templates", error);
        } finally {
            setLoading(false);
        }
    };

    // --- Toolbar Helpers ---
    const insertText = (before: string, after: string = '') => {
        const textarea = textareaRef.current;
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const previousText = textarea.value;
        const selection = previousText.substring(start, end);
        
        const newText = previousText.substring(0, start) + 
                        before + selection + after + 
                        previousText.substring(end);
        
        setContent(newText);
        
        // Reset focus and cursor
        setTimeout(() => {
            textarea.focus();
            const newCursorPos = start + before.length + selection.length + after.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }, 0);
    };

    // --- Tag Helpers ---
    const handleAddTag = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const clean = tagInput.trim().replace(/^#/, '');
            if (clean && !tags.includes(clean)) {
                setTags([...tags, clean]);
                setTagInput('');
            }
        }
    };

    const removeTag = (t: string) => setTags(tags.filter(tag => tag !== t));

    // --- CRUD Operations ---
    const handleEdit = (t: JournalTemplate) => {
        setEditId(t.id);
        setName(t.name);
        // Convert legacy templates to text if needed
        const textContent = t.content || (t.prompts ? t.prompts.map(p => `**${p}**\n\n`).join('') : '');
        setContent(textContent);
        setTags(t.defaultTags || []);
        setIsEditing(true);
    };

    const handleDelete = async (id: string) => {
        if (!confirm("Delete this template?")) return;
        if (!user || !db) return;
        try {
            await deleteDoc(doc(db, 'users', user.uid, 'templates', id));
            setTemplates(templates.filter(t => t.id !== id));
        } catch (e) {
            console.error("Error deleting", e);
        }
    };

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!user || !db) return;
        if (!name.trim()) return alert("Please name your template");

        setSaving(true);
        const templateData = {
            uid: user.uid,
            name,
            content, // Saving as Free Text
            defaultTags: tags,
            updatedAt: Timestamp.now()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, 'users', user.uid, 'templates', editId), templateData);
                setTemplates(prev => prev.map(t => t.id === editId ? { ...t, ...templateData } : t));
            } else {
                const docRef = await addDoc(collection(db, 'users', user.uid, 'templates'), {
                    ...templateData,
                    createdAt: Timestamp.now()
                });
                // Fix: Manually add createdAt to state to match type definition
                setTemplates([...templates, { 
                    id: docRef.id, 
                    ...templateData, 
                    createdAt: Timestamp.now() 
                } as JournalTemplate]);
            }
            setIsEditing(false);
            resetForm();
        } catch (error) {
            console.error("Error saving template", error);
        } finally {
            setSaving(false);
        }
    };

    const resetForm = () => {
        setEditId(null);
        setName('');
        setContent('');
        setTags([]);
    };

    return (
        <div className="max-w-4xl mx-auto p-4 space-y-6">
            
            {/* Header / Nav */}
            <div className="flex items-center gap-4">
                <button onClick={() => navigate('/journal')} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <ArrowLeftIcon className="h-6 w-6 text-gray-600" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">
                    {isEditing ? (editId ? 'Edit Template' : 'New Free-Text Template') : 'My Templates'}
                </h1>
            </div>

            {isEditing ? (
                // --- EDITOR VIEW (Free Text / Markdown) ---
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <form onSubmit={handleSave} className="space-y-6">
                        
                        {/* Name Input */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                            <input 
                                type="text" 
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="e.g. Daily Gratitude List"
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* Content Editor */}
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-sm font-medium text-gray-700">Template Structure</label>
                                <span className="text-xs text-gray-400">Markdown Supported</span>
                            </div>
                            
                            {/* Toolbar */}
                            <div className="flex items-center gap-2 mb-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => insertText('### ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Heading">
                                    <HashtagIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('**', '**')} className="px-2 py-1 text-sm font-bold hover:bg-white hover:shadow-sm rounded text-gray-600" title="Bold">
                                    B
                                </button>
                                <div className="w-px h-4 bg-gray-300 mx-1"></div>
                                <button type="button" onClick={() => insertText('- [ ] ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Checkbox">
                                    <CheckCircleIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('1. ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Ordered List">
                                    <ListBulletIcon className="h-4 w-4" />
                                </button>
                            </div>

                            <textarea 
                                ref={textareaRef}
                                rows={12}
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="Design your template here using Markdown...&#10;- [ ] Checklist item&#10;**Bold text**"
                                className="w-full font-mono text-sm rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 leading-relaxed"
                            />
                        </div>

                        {/* Default Tags */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Auto-Tags</label>
                            <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white">
                                {tags.map(tag => (
                                    <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                                        {tag}
                                        <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                                            <XMarkIcon className="h-3 w-3" />
                                        </button>
                                    </span>
                                ))}
                                <input 
                                    type="text"
                                    value={tagInput}
                                    onChange={(e) => setTagInput(e.target.value)}
                                    onKeyDown={handleAddTag}
                                    placeholder={tags.length === 0 ? "Add tags..." : ""}
                                    className="flex-1 min-w-[100px] text-sm border-none focus:ring-0 p-0 text-gray-700"
                                />
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                            <button 
                                type="button"
                                onClick={() => { setIsEditing(false); resetForm(); }}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit"
                                disabled={saving}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm transition-colors disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Template'}
                            </button>
                        </div>

                    </form>
                </div>
            ) : (
                // --- LIST VIEW ---
                <div className="space-y-4">
                    <button 
                        onClick={() => { resetForm(); setIsEditing(true); }}
                        className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium"
                    >
                        <PlusIcon className="h-5 w-5" />
                        Create New Template
                    </button>

                    {loading ? (
                        <div className="text-center py-8 text-gray-400">Loading templates...</div>
                    ) : templates.length === 0 ? (
                        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-xl">
                            You haven't created any custom templates yet.
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {templates.map(t => (
                                <div key={t.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow group">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-gray-900">{t.name}</h3>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => handleEdit(t)} className="p-1.5 text-gray-400 hover:text-blue-600 rounded">
                                                <PencilSquareIcon className="h-4 w-4" />
                                            </button>
                                            <button onClick={() => handleDelete(t.id)} className="p-1.5 text-gray-400 hover:text-red-600 rounded">
                                                <TrashIcon className="h-4 w-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 line-clamp-2 mb-3 h-8">
                                        {t.content || (t.prompts ? "Structured Form Template" : "Empty Template")}
                                    </p>
                                    <div className="flex gap-2">
                                        {t.defaultTags?.slice(0, 3).map(tag => (
                                            <span key={tag} className="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}
--- END_FILE: src/components/journal/TemplateEditor.tsx ---

--- START_FILE: src/components/profile/DataManagement.tsx ---
/**
 * GITHUB COMMENT:
 * [DataManagement.tsx]
 * UPDATED: Added a call-to-action button linking to the new User Guide.
 * MAINTAINED: All export, import, and sync logic.
 */
import React, { useState, useRef, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../contexts/AuthContext';
import { useEncryption } from '../../contexts/EncryptionContext';
import { db } from '../../lib/firebase';
import { doc, setDoc, serverTimestamp, getDoc, type Firestore } from 'firebase/firestore';
import { fetchAllUserData } from '../../lib/db';
import { prepareDataForExport, generateJSON, generatePDF } from '../../lib/exporter';
import { importLegacyJournals } from '../../lib/importer';
import { 
    ArrowDownTrayIcon, 
    ArrowUpTrayIcon, 
    DocumentTextIcon, 
    CodeBracketSquareIcon,
    ExclamationTriangleIcon,
    CheckCircleIcon,
    LockClosedIcon,
    CloudArrowUpIcon,
    BookOpenIcon
} from '@heroicons/react/24/outline';

export default function DataManagement() {
    const { user, driveAccessToken } = useAuth();
    const { isVaultUnlocked } = useEncryption();
    const navigate = useNavigate();
    
    const [exporting, setExporting] = useState(false);
    const [progress, setProgress] = useState(0);
    const [exportError, setExportError] = useState<string | null>(null);
    const [lastExportStr, setLastExportStr] = useState<string | null>(null);

    const fileInputRef = useRef<HTMLInputElement>(null);
    const [importing, setImporting] = useState(false);
    const [importStatus, setImportStatus] = useState<string | null>(null);

    const loadLastExportDate = useCallback(async () => {
        if (!user || !db) return;
        const database: Firestore = db;
        const snap = await getDoc(doc(database, 'users', user.uid));
        if (snap.exists() && snap.data().lastExportAt) {
            const date = snap.data().lastExportAt.toDate() as Date;
            setLastExportStr(date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        }
    }, [user]);

    useEffect(() => {
        loadLastExportDate();
    }, [loadLastExportDate]);

    const handleExport = async (format: 'json' | 'pdf') => {
        if (!user || !db) return;
        if (!isVaultUnlocked) {
            setExportError("Please unlock your vault (go to Journal) before exporting data.");
            return;
        }

        setExporting(true);
        setProgress(0);
        setExportError(null);

        try {
            const rawData = await fetchAllUserData(user.uid);
            setProgress(10);

            const cleanData = await prepareDataForExport(rawData, (p) => setProgress(10 + Math.floor(p * 0.8)));
            
            let blob: Blob;
            let filename: string;
            const dateStr = new Date().toISOString().split('T')[0];

            if (format === 'json') {
                blob = generateJSON(cleanData);
                filename = `mrt-backup-${dateStr}.json`;
            } else {
                blob = await generatePDF(cleanData);
                filename = `mrt-journal-${dateStr}.pdf`;
            }
            setProgress(100);

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            const database: Firestore = db;
            const userRef = doc(database, 'users', user.uid);
            await setDoc(userRef, { lastExportAt: serverTimestamp() }, { merge: true });
            loadLastExportDate();

        } catch (error) {
            console.error("Export failed", error);
            setExportError("Failed to generate export. Check console.");
        } finally {
            setTimeout(() => setExporting(false), 2000);
        }
    };

    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file || !user) return;
    
        if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
          setImportStatus('Error: Please select a valid JSON file.');
          return;
        }
    
        setImporting(true);
        setImportStatus('Reading file and mapping data...');
    
        try {
          const result = await importLegacyJournals(user.uid, file);
          setImportStatus(`Success! Imported ${result.success} entries. (${result.errors} skipped)`);
          if (fileInputRef.current) fileInputRef.current.value = '';
        } catch (error) {
          console.error("Import failed", error);
          setImportStatus('Error: Import failed. Check console for details.');
        } finally {
          setImporting(false);
        }
    };

    return (
        <div className="space-y-8">
            {/* NEW: USER GUIDE CTA */}
            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-2xl shadow-lg text-white">
                <div className="flex items-center gap-4 mb-4">
                    <div className="p-3 bg-white/20 rounded-xl">
                        <BookOpenIcon className="h-7 w-7" />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold">New to MRT?</h3>
                        <p className="text-blue-100 text-sm">Explore our visual guide to master your recovery tools.</p>
                    </div>
                </div>
                <button 
                    onClick={() => navigate('/guide')}
                    className="w-full py-3 bg-white text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition-colors active:scale-95 shadow-md"
                >
                    View User Guide
                </button>
            </div>

            {/* GOOGLE DRIVE SYNC STATUS */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <CloudArrowUpIcon className="h-5 w-5 text-blue-600" />
                        Cloud Auto-Sync
                    </h3>
                    {driveAccessToken ? (
                        <span className="px-2 py-1 bg-green-50 text-green-700 text-[10px] font-bold uppercase rounded border border-green-200">Active</span>
                    ) : (
                        <span className="px-2 py-1 bg-gray-50 text-gray-400 text-[10px] font-bold uppercase rounded border border-gray-200">Inactive</span>
                    )}
                </div>
                
                {driveAccessToken ? (
                    <div className="text-sm text-gray-600 space-y-2">
                        <p>Linked to <strong>Google Drive</strong>. Your data is backed up automatically every 7 days when the vault is unlocked.</p>
                        {lastExportStr && <p className="text-xs font-medium text-gray-400 italic">Last Cloud Sync: {lastExportStr}</p>}
                    </div>
                ) : (
                    <p className="text-sm text-gray-600">
                        Automatic backups are only available for users who signed in with Google. Email users must perform manual exports.
                    </p>
                )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 className="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
                    <ArrowDownTrayIcon className="h-5 w-5 text-blue-600" />
                    Data Sovereignty (Manual Export)
                </h3>
                <p className="text-sm text-gray-600 mb-6">
                    Download a copy of your data. You can save a raw JSON backup or a readable PDF.
                    <span className="block mt-2 text-orange-600 text-xs font-semibold bg-orange-50 p-2 rounded border border-orange-100">
                        <ExclamationTriangleIcon className="h-3 w-3 inline mr-1" />
                        Warning: Exported files are NOT encrypted. Store them securely.
                    </span>
                </p>

                {!isVaultUnlocked ? (
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-center">
                        <LockClosedIcon className="h-8 w-8 text-gray-400 mx-auto mb-2" />
                        <p className="text-sm text-gray-600 mb-3">Vault is locked. Please unlock to decrypt data.</p>
                        <button disabled className="bg-gray-300 text-white px-4 py-2 rounded-lg text-sm font-bold cursor-not-allowed">
                            Unlock Required
                        </button>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button 
                            onClick={() => handleExport('json')}
                            disabled={exporting}
                            className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-blue-50 hover:border-blue-200 transition-all group"
                        >
                            <CodeBracketSquareIcon className="h-8 w-8 text-gray-400 group-hover:text-blue-600 mb-2" />
                            <span className="font-bold text-gray-700 group-hover:text-blue-700">JSON Backup</span>
                            <span className="text-xs text-gray-400">Machine-readable format</span>
                        </button>

                        <button 
                            onClick={() => handleExport('pdf')}
                            disabled={exporting}
                            className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-red-50 hover:border-red-200 transition-all group"
                        >
                            <DocumentTextIcon className="h-8 w-8 text-gray-400 group-hover:text-red-600 mb-2" />
                            <span className="font-bold text-gray-700 group-hover:text-red-700">PDF Document</span>
                            <span className="text-xs text-gray-400">Readable format</span>
                        </button>
                    </div>
                )}

                {exporting && (
                    <div className="mt-4">
                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Processing Vault...</span>
                            <span>{progress}%</span>
                        </div>
                        <div className="w-full bg-gray-100 rounded-full h-2">
                            <div className="bg-blue-600 h-2 rounded-full transition-all duration-300" style={{ width: `${progress}%` }}></div>
                        </div>
                    </div>
                )}

                {exportError && (
                    <div className="mt-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg flex items-start gap-2">
                        <ExclamationTriangleIcon className="h-5 w-5 flex-shrink-0" />
                        {exportError}
                    </div>
                )}
            </div>

            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <ArrowUpTrayIcon className="h-5 w-5 text-gray-500" />
                    Import Legacy Data
                </h3>
                <p className="text-sm text-gray-600 mb-4">
                    Restore data from a JSON backup. This will add entries to your history.
                </p>

                <div className="flex flex-col gap-4">
                    <input 
                        type="file" 
                        accept=".json"
                        ref={fileInputRef}
                        onChange={handleFileChange}
                        className="hidden"
                    />
                    
                    <button 
                        type="button"
                        onClick={() => fileInputRef.current?.click()}
                        disabled={importing}
                        className="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-gray-500 hover:border-blue-500 hover:text-blue-500 transition-colors flex flex-col items-center justify-center gap-2"
                    >
                        {importing ? (
                            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                        ) : (
                            <ArrowUpTrayIcon className="h-8 w-8" />
                        )}
                        <span className="font-medium">{importing ? 'Importing...' : 'Click to Select JSON File'}</span>
                    </button>

                    {importStatus && (
                        <div className={`flex items-start gap-2 text-sm p-3 rounded-md ${importStatus.includes('Success') ? 'bg-green-50 text-green-800' : 'bg-yellow-50 text-yellow-800'}`}>
                            {importStatus.includes('Success') ? (
                                <CheckCircleIcon className="h-5 w-5 flex-shrink-0" />
                            ) : (
                                <ExclamationTriangleIcon className="h-5 w-5 flex-shrink-0" />
                            )}
                            {importStatus}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
--- END_FILE: src/components/profile/DataManagement.tsx ---

--- START_FILE: src/components/tasks/TaskFormModal.tsx ---
// src/components/tasks/TaskFormModal.tsx
import React, { useState, useEffect } from 'react';
import { 
  XMarkIcon, 
  CalendarIcon, 
  ArrowPathIcon 
} from '@heroicons/react/24/outline';
import type { RecurrenceConfig, RecurrenceType } from '../../lib/dateUtils';
import { Timestamp } from 'firebase/firestore';

// Define explicit union types locally to avoid 'any' casting
type CategoryType = 'Recovery' | 'Health' | 'Life' | 'Work';
type PriorityType = 'High' | 'Medium' | 'Low';

export interface TaskFormData {
  id?: string;
  title: string;
  category: CategoryType;
  priority: PriorityType;
  recurrence: RecurrenceConfig;
  dueDate: string; // YYYY-MM-DD format for input
}

// Interface for the raw task data coming in (looser than FormData)
interface IncomingTask {
    id: string;
    title: string;
    category: CategoryType;
    priority: PriorityType;
    dueDate: Timestamp | Date | null;
    recurrence?: RecurrenceConfig;
    frequency?: string; // Legacy support
}

interface TaskFormModalProps {
  isOpen: boolean;
  // FIX: Replaced 'any' with specific type
  initialTask: IncomingTask | null; 
  onClose: () => void;
  onSave: (data: TaskFormData) => Promise<void>;
}

export default function TaskFormModal({ isOpen, initialTask, onClose, onSave }: TaskFormModalProps) {
  const [title, setTitle] = useState('');
  const [category, setCategory] = useState<CategoryType>('Recovery');
  const [priority, setPriority] = useState<PriorityType>('Medium');
  const [dueDate, setDueDate] = useState('');
  const [loading, setLoading] = useState(false);

  // Recurrence State
  const [recurrenceType, setRecurrenceType] = useState<RecurrenceType>('once');
  const [relWeek, setRelWeek] = useState(1); // 1-5 (5=Last)
  const [relDay, setRelDay] = useState(5); // 0-6 (5=Fri)

  // Initialize form when opening
  useEffect(() => {
    if (isOpen) {
        if (initialTask) {
            setTitle(initialTask.title);
            setCategory(initialTask.category);
            setPriority(initialTask.priority);
            
            // Date Handling
            let dateStr = '';
            if (initialTask.dueDate) {
                 const d = initialTask.dueDate instanceof Date 
                    ? initialTask.dueDate 
                    : (initialTask.dueDate as Timestamp).toDate();
                 dateStr = d.toISOString().split('T')[0];
            }
            setDueDate(dateStr);

            // Recurrence Handling
            if (initialTask.recurrence) {
                setRecurrenceType(initialTask.recurrence.type);
                if (initialTask.recurrence.weekOfMonth) setRelWeek(initialTask.recurrence.weekOfMonth);
                if (initialTask.recurrence.dayOfWeek !== undefined) setRelDay(initialTask.recurrence.dayOfWeek);
            } else {
                // Fallback for old data
                setRecurrenceType(
                    (initialTask.frequency === 'once' || !initialTask.frequency) 
                    ? 'once' 
                    : initialTask.frequency as RecurrenceType
                );
            }

        } else {
            // Reset for new task
            setTitle('');
            setCategory('Recovery');
            setPriority('Medium');
            setDueDate(new Date().toISOString().split('T')[0]);
            setRecurrenceType('once');
            setRelWeek(1);
            setRelDay(5);
        }
    }
  }, [isOpen, initialTask]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim()) return;
    
    setLoading(true);
    try {
        const config: RecurrenceConfig = {
            type: recurrenceType
        };

        if (recurrenceType === 'monthly-relative') {
            config.weekOfMonth = relWeek;
            config.dayOfWeek = relDay;
        }

        await onSave({
            id: initialTask?.id,
            title,
            category,
            priority,
            dueDate,
            recurrence: config
        });
        onClose();
    } catch (error) {
        console.error("Failed to save task", error);
    } finally {
        setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-0 sm:p-4 animate-fadeIn">
        <div className="bg-white w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slideUp sm:animate-fadeIn overflow-y-auto max-h-[90vh]">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-900">
                    {initialTask ? 'Edit Quest' : 'New Quest'}
                </h2>
                <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full">
                    <XMarkIcon className="h-6 w-6 text-gray-400" />
                </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-5">
                
                {/* TITLE */}
                <div>
                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Quest Title</label>
                    <input
                        type="text"
                        placeholder="e.g., Call Sponsor, Gym, Meditate..."
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        className="w-full rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 p-3"
                        autoFocus={!initialTask}
                    />
                </div>

                {/* CATEGORY & PRIORITY */}
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Category</label>
                        <select 
                            value={category}
                            // FIX: Replaced 'any' with specific Union Type cast
                            onChange={(e) => setCategory(e.target.value as CategoryType)}
                            className="w-full rounded-xl border-gray-300 text-sm py-2.5"
                        >
                            <option value="Recovery">Recovery</option>
                            <option value="Health">Health</option>
                            <option value="Life">Life</option>
                            <option value="Work">Work</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Priority</label>
                        <select 
                            value={priority}
                            // FIX: Replaced 'any' with specific Union Type cast
                            onChange={(e) => setPriority(e.target.value as PriorityType)}
                            className="w-full rounded-xl border-gray-300 text-sm py-2.5"
                        >
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>

                {/* RECURRENCE SECTION */}
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                    <div className="flex items-center gap-2 text-gray-800 font-semibold text-sm">
                        <ArrowPathIcon className="h-4 w-4" />
                        Repetition Rules
                    </div>
                    
                    <select 
                        value={recurrenceType}
                        onChange={(e) => setRecurrenceType(e.target.value as RecurrenceType)}
                        className="w-full rounded-lg border-gray-300 text-sm"
                    >
                        <option value="once">One-time Quest</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-Weekly (Every 2 weeks)</option>
                        <option value="monthly">Monthly (Same date)</option>
                        <option value="monthly-relative">Monthly (Relative day)</option>
                    </select>

                    {/* Conditional: Monthly Relative Options */}
                    {recurrenceType === 'monthly-relative' && (
                        <div className="flex gap-2 animate-fadeIn">
                             <select 
                                value={relWeek} 
                                onChange={(e) => setRelWeek(Number(e.target.value))}
                                className="flex-1 rounded-lg border-gray-300 text-sm"
                             >
                                <option value={1}>1st</option>
                                <option value={2}>2nd</option>
                                <option value={3}>3rd</option>
                                <option value={4}>4th</option>
                                <option value={5}>Last</option>
                             </select>
                             <select 
                                value={relDay} 
                                onChange={(e) => setRelDay(Number(e.target.value))}
                                className="flex-1 rounded-lg border-gray-300 text-sm"
                             >
                                <option value={0}>Sunday</option>
                                <option value={1}>Monday</option>
                                <option value={2}>Tuesday</option>
                                <option value={3}>Wednesday</option>
                                <option value={4}>Thursday</option>
                                <option value={5}>Friday</option>
                                <option value={6}>Saturday</option>
                             </select>
                             <span className="self-center text-sm text-gray-500">of month</span>
                        </div>
                    )}
                </div>

                {/* DUE DATE */}
                <div>
                     <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Due Date</label>
                     <div className="relative">
                        <CalendarIcon className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                        <input 
                            type="date" 
                            value={dueDate}
                            onChange={(e) => setDueDate(e.target.value)}
                            className="w-full pl-10 rounded-xl border-gray-300 text-sm py-2.5" 
                        />
                     </div>
                </div>

                <button
                    type="submit"
                    disabled={!title.trim() || loading}
                    className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-colors shadow-md mt-4 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {loading ? 'Saving...' : initialTask ? 'Update Quest' : 'Accept Quest'}
                </button>
            </form>
        </div>
    </div>
  );
}
--- END_FILE: src/components/tasks/TaskFormModal.tsx ---

--- START_FILE: src/contexts/AuthContext.tsx ---
/**
 * GITHUB COMMENT:
 * [AuthContext.tsx]
 * UPDATED: Added 'isAdmin' flag derived from the Firestore UserProfile.
 */
import React, { createContext, useContext, useEffect, useState } from 'react';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  type User 
} from 'firebase/auth';
import { auth } from '../lib/firebase';
import { getOrCreateUserProfile } from '../lib/db';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  isAdmin: boolean;
  driveAccessToken: string | null;
  loginWithGoogle: () => Promise<void>;
  signupWithEmail: (email: string, pass: string) => Promise<void>;
  loginWithEmail: (email: string, pass: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

// eslint-disable-next-line react-refresh/only-export-components
export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [isAdmin, setIsAdmin] = useState(false);
  const [driveAccessToken, setDriveAccessToken] = useState<string | null>(null);

  useEffect(() => {
    if (!auth) {
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      try {
        if (currentUser) {
          const profile = await getOrCreateUserProfile(currentUser);
          setUser(currentUser);
          setIsAdmin(profile.role === 'admin' || currentUser.email === 'rpdouglas@gmail.com');
        } else {
          setUser(null);
          setIsAdmin(false);
          setDriveAccessToken(null);
        }
      } catch (error) {
        console.error("Error fetching user profile:", error);
        setUser(currentUser); 
      } finally {
        setLoading(false);
      }
    });

    return unsubscribe;
  }, []);

  const loginWithGoogle = async () => {
    if (!auth) throw new Error("Auth not initialized");
    const provider = new GoogleAuthProvider();
    provider.addScope('https://www.googleapis.com/auth/drive.file');
    provider.setCustomParameters({ prompt: 'select_account' });
    
    const result = await signInWithPopup(auth, provider);
    const credential = GoogleAuthProvider.credentialFromResult(result);
    if (credential?.accessToken) {
      setDriveAccessToken(credential.accessToken);
    }
  };

  const signupWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    const result = await createUserWithEmailAndPassword(auth, email, pass);
    await getOrCreateUserProfile(result.user);
  };

  const loginWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    await signInWithEmailAndPassword(auth, email, pass);
  };

  const logout = async () => {
    if (!auth) return;
    await signOut(auth);
  };

  const value = {
    user,
    loading,
    isAdmin,
    driveAccessToken,
    loginWithGoogle,
    signupWithEmail,
    loginWithEmail,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}
--- END_FILE: src/contexts/AuthContext.tsx ---

--- START_FILE: src/contexts/EncryptionContext.tsx ---
/**
 * GITHUB COMMENT:
 * [EncryptionContext.tsx]
 * CLEANUP: Removed redundant 'no-console' eslint-disable directives.
 * MAINTAINED: resetVault logic and zero-knowledge security protocols.
 */
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { useAuth } from './AuthContext';
import { db } from '../lib/firebase';
import { 
  doc, 
  getDoc, 
  setDoc, 
  deleteField, 
  collection, 
  query, 
  where, 
  limit, 
  getDocs 
} from 'firebase/firestore';
import { 
    generateSalt, 
    generateKey, 
    computePinHash,
    encrypt, 
    decrypt, 
    clearKey, 
    isVaultUnlocked as checkLibUnlocked 
} from '../lib/crypto';

interface EncryptionContextType {
  isVaultSet: boolean;
  isVaultUnlocked: boolean;
  vaultLoading: boolean;
  unlockVault: (pin: string) => Promise<boolean>;
  setupVault: (pin: string) => Promise<void>;
  resetVault: () => Promise<void>;
  encrypt: (text: string) => Promise<string>;
  decrypt: (encryptedText: string) => Promise<string>;
  lockVault: () => void;
}

const EncryptionContext = createContext<EncryptionContextType | undefined>(undefined);

// eslint-disable-next-line react-refresh/only-export-components
export function useEncryption() {
  const context = useContext(EncryptionContext);
  if (context === undefined) {
    throw new Error('useEncryption must be used within an EncryptionProvider');
  }
  return context;
}

export function EncryptionProvider({ children }: { children: React.ReactNode }) {
  const { user } = useAuth();
  
  const [isVaultSet, setIsVaultSet] = useState(false);
  const [isVaultUnlocked, setIsVaultUnlocked] = useState(false);
  const [vaultLoading, setVaultLoading] = useState(true);
  
  const [salt, setSalt] = useState<string | null>(null);
  const [verifier, setVerifier] = useState<string | null>(null);

  useEffect(() => {
    async function checkVaultStatus() {
      if (!user || !db) {
        setVaultLoading(false);
        return;
      }
      
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          const data = userDoc.data();
          if (data.encryptionSalt) {
            setIsVaultSet(true);
            setSalt(data.encryptionSalt);
            if (data.pinVerifier) {
                setVerifier(data.pinVerifier);
            }
          } else {
            setIsVaultSet(false);
          }
        } else {
          setIsVaultSet(false);
        }
      } catch (error) {
        console.error("Error checking vault status:", error);
      } finally {
        setVaultLoading(false);
      }
    }

    checkVaultStatus();
  }, [user]);

  const setupVault = async (pin: string) => {
    if (!user || !db) return;
    
    try {
      setVaultLoading(true);
      const newSalt = generateSalt();
      await generateKey(pin, newSalt);
      const newVerifier = await computePinHash(pin, newSalt);
      
      const userDocRef = doc(db, 'users', user.uid);
      await setDoc(userDocRef, { 
          encryptionSalt: newSalt,
          pinVerifier: newVerifier
      }, { merge: true });

      setSalt(newSalt);
      setVerifier(newVerifier);
      setIsVaultSet(true);
      setIsVaultUnlocked(true);
    } catch (error) {
      console.error("Vault setup failed:", error);
      throw error;
    } finally {
      setVaultLoading(false);
    }
  };

  const resetVault = async () => {
    if (!user || !db) return;
    try {
      setVaultLoading(true);
      const userDocRef = doc(db, 'users', user.uid);
      await setDoc(userDocRef, {
        encryptionSalt: deleteField(),
        pinVerifier: deleteField()
      }, { merge: true });
      
      clearKey();
      setIsVaultSet(false);
      setIsVaultUnlocked(false);
      setSalt(null);
      setVerifier(null);
    } catch (error) {
      console.error("Vault reset failed:", error);
      throw error;
    } finally {
      setVaultLoading(false);
    }
  };

  const unlockVault = async (pin: string): Promise<boolean> => {
    if (!salt || !user || !db) return false;
    
    try {
      if (verifier) {
          const checkHash = await computePinHash(pin, salt);
          if (checkHash !== verifier) return false;
          await generateKey(pin, salt);
          setIsVaultUnlocked(true);
          return true;
      }

      await generateKey(pin, salt);
      const q = query(collection(db, 'journals'), where('uid', '==', user.uid), limit(1));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
          const testDoc = snapshot.docs[0].data();
          if (testDoc.content && testDoc.isEncrypted) {
              try {
                  const result = await decrypt(testDoc.content);
                  if (result.includes("Locked Content")) throw new Error("Key mismatch");
                  const newVerifier = await computePinHash(pin, salt);
                  const userDocRef = doc(db, 'users', user.uid);
                  await setDoc(userDocRef, { pinVerifier: newVerifier }, { merge: true });
                  setVerifier(newVerifier);
              } catch (e) {
                  console.warn("Legacy Verification Failed", e);
                  return true; 
              }
          }
      } else {
          const newVerifier = await computePinHash(pin, salt);
          const userDocRef = doc(db, 'users', user.uid);
          await setDoc(userDocRef, { pinVerifier: newVerifier }, { merge: true });
          setVerifier(newVerifier);
      }

      setIsVaultUnlocked(true);
      return true;
    } catch (error) {
      console.error("Unlock failed", error);
      return false;
    }
  };

  const lockVault = useCallback(() => {
    clearKey();
    setIsVaultUnlocked(false);
  }, []);

  const handleEncrypt = useCallback(async (text: string) => {
    if (!checkLibUnlocked()) throw new Error("Vault is locked");
    return await encrypt(text);
  }, []);

  const handleDecrypt = useCallback(async (text: string) => {
    return await decrypt(text);
  }, []);

  const value = {
    isVaultSet,
    isVaultUnlocked,
    vaultLoading,
    unlockVault,
    setupVault,
    resetVault,
    encrypt: handleEncrypt,
    decrypt: handleDecrypt,
    lockVault
  };

  return (
    <EncryptionContext.Provider value={value}>
      {children}
    </EncryptionContext.Provider>
  );
}
--- END_FILE: src/contexts/EncryptionContext.tsx ---

--- START_FILE: src/contexts/LayoutContext.tsx ---
import { createContext, useContext, useState, type ReactNode } from 'react';

interface LayoutContextType {
  sidebarOpen: boolean;
  setSidebarOpen: (open: boolean) => void;
  isSOSOpen: boolean;
  setIsSOSOpen: (open: boolean) => void;
  toggleSidebar: () => void;
  toggleSOS: () => void;
}

const LayoutContext = createContext<LayoutContextType | undefined>(undefined);

// eslint-disable-next-line react-refresh/only-export-components
export function useLayout() {
  const context = useContext(LayoutContext);
  if (context === undefined) {
    throw new Error('useLayout must be used within a LayoutProvider');
  }
  return context;
}

export function LayoutProvider({ children }: { children: ReactNode }) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [isSOSOpen, setIsSOSOpen] = useState(false);

  const toggleSidebar = () => setSidebarOpen(prev => !prev);
  const toggleSOS = () => setIsSOSOpen(prev => !prev);

  const value = {
    sidebarOpen,
    setSidebarOpen,
    isSOSOpen,
    setIsSOSOpen,
    toggleSidebar,
    toggleSOS
  };

  return (
    <LayoutContext.Provider value={value}>
      {children}
    </LayoutContext.Provider>
  );
}
--- END_FILE: src/contexts/LayoutContext.tsx ---

--- START_FILE: src/data/workbooks.ts ---
// src/data/workbooks.ts

export interface Question {
  id: string;
  text: string;
  context?: string; // Optional context/quote from literature (The Insight)
  type?: 'input' | 'read_only'; // Defaults to 'input' if undefined
}

export interface WorkbookSection {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  type: 'linear' | 'steps' | 'general';
  sections: WorkbookSection[];
}

// Helper to generate generic questions for sections we don't fully populate in this snippet
//const generateQuestions = (count: number, prefix: string): Question[] => {
//  return Array.from({ length: count }).map((_, i) => ({
//    id: `${prefix}_q${i + 1}`,
//    text: `Question ${i + 1}: Reflection point regarding ${prefix.replace(/_/g, ' ')}.`,
//    type: 'input'
//  }));
//};

// --- 1. GENERAL RECOVERY WORKBOOK (25 Questions) ---
const generalQuestions: Question[] = [
  { id: 'gen_1', text: "What are the specific consequences of your addiction that led you to seek recovery?" },
  { id: 'gen_2', text: "Describe a time when you tried to control your using but failed." },
  { id: 'gen_3', text: "How has your addiction affected your relationships with family and friends?" },
  { id: 'gen_4', text: "What emotions trigger your desire to use?" },
  { id: 'gen_5', text: "List 5 things you are grateful for today." },
  { id: 'gen_6', text: "What does 'rock bottom' mean to you, and do you feel you hit it?" },
  { id: 'gen_7', text: "How does honesty play a role in your recovery?" },
  { id: 'gen_8', text: "What are your biggest fears about living sober?" },
  { id: 'gen_9', text: "Who are the people in your support network?" },
  { id: 'gen_10', text: "What hobbies or activities did you neglect during active addiction?" },
  { id: 'gen_11', text: "Describe your physical health during active addiction versus now." },
  { id: 'gen_12', text: "What lies did you tell yourself to justify your using?" },
  { id: 'gen_13', text: "How has your addiction impacted your career or education?" },
  { id: 'gen_14', text: "What specific boundaries do you need to set to protect your sobriety?" },
  { id: 'gen_15', text: "How do you handle stress without substances?" },
  { id: 'gen_16', text: "What does a 'spiritual awakening' mean to you?" },
  { id: 'gen_17', text: "List 3 short-term goals for your recovery." },
  { id: 'gen_18', text: "List 3 long-term goals for your life." },
  { id: 'gen_19', text: "How can you be of service to others?" },
  { id: 'gen_20', text: "What resentments are you holding onto, and how do they affect you?" },
  { id: 'gen_21', text: "Describe a situation where you successfully navigated a craving." },
  { id: 'gen_22', text: "What does 'taking it one day at a time' look like in practice?" },
  { id: 'gen_23', text: "How do you practice self-care?" },
  { id: 'gen_24', text: "What advice would you give to your past self?" },
  { id: 'gen_25', text: "Why is recovery worth it for you?" },
];

// --- 2. 12-STEP WORKBOOK (Unified Steps Approach) ---

// Helper to build the 16-slide structure for Steps 2-11 (Standardized Template)
const createStepStructure = (
  stepNum: number,
  introText: string,
  insight1: string,
  insight2: string,
  insight3: string
): Question[] => {
  const q: Question[] = [];
  
  // 1. Intro Slide
  q.push({
    id: `s${stepNum}_intro`,
    type: 'read_only',
    text: introText
  });

  // 2. Section 1 (5 Qs)
  for (let i = 1; i <= 5; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: How does the concept of this section apply to your life today?`,
      context: insight1
    });
  }

  // 3. Section 2 (5 Qs)
  for (let i = 6; i <= 10; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: What barriers do you face regarding this principle?`,
      context: insight2
    });
  }

  // 4. Section 3 (5 Qs)
  for (let i = 11; i <= 15; i++) {
    q.push({
      id: `s${stepNum}_q${i}`,
      type: 'input',
      text: `Step ${stepNum} Reflection Q${i}: How can you put this into practice immediately?`,
      context: insight3
    });
  }

  return q;
};

// -- STEP 1 (Fully Populated from User Doc) --
const step1Questions: Question[] = [
  // Intro
  {
    id: 's1_intro',
    type: 'read_only',
    text: `Step 1: "We admitted we were powerless over our addiction‚Äîthat our lives had become unmanageable."\n\nIntroduction:\nStep 1 is the foundation of recovery. It is about surrendering the illusion of control. It asks us to honestly admit that our best thinking has failed us and that our compulsive behaviors have consequences we can no longer manage alone.`
  },
  // Section 1: The Nature of Powerlessness
  { id: 's1_q1', type: 'input', text: "Can you describe a specific time when you sincerely tried to stop or control your behavior but failed?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q2', type: 'input', text: "How does the obsession manifest in your mind before you even take the first action/drink/drug?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q3', type: 'input', text: "In what ways have you tried to bargain with your addiction (e.g., \"I'll only do it on weekends\")?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q4', type: 'input', text: "Do you feel a physical or mental shift when you engage in your addictive behavior that makes it hard to stop?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  { id: 's1_q5', type: 'input', text: "What does the word \"defeat\" mean to you in the context of your recovery?", context: "Powerlessness isn't weakness; it is the realization that your willpower alone is insufficient against the disease of addiction. It is accepting that once you start, you lose the ability to stop." },
  
  // Section 2: Unmanageability in Daily Life
  { id: 's1_q6', type: 'input', text: "How has your addiction affected your financial stability or career/school performance?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q7', type: 'input', text: "Have you missed important events or obligations due to using or recovering from using?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q8', type: 'input', text: "In what ways has your home life or living environment become chaotic?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q9', type: 'input', text: "How do you manage your emotions when things don't go your way? Is it manageable?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },
  { id: 's1_q10', type: 'input', text: "Do you feel like you are driving the car of your life, or are you a passenger in a runaway vehicle?", context: "Unmanageability doesn't always look like a car crash. It is the internal chaos, the missed commitments, the financial stress, and the emotional volatility that addiction brings into our daily existence." },

  // Section 3: The Emotional Toll
  { id: 's1_q11', type: 'input', text: "How has isolation played a role in your addiction?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q12', type: 'input', text: "What relationships have been damaged or lost because of your behavior?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q13', type: 'input', text: "Do you struggle with self-worth or self-esteem? How does using affect that?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q14', type: 'input', text: "What lies do you tell yourself to justify the pain you are in?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
  { id: 's1_q15', type: 'input', text: "Are you ready to let go of the control you never really had?", context: "Addiction is isolating. It convinces us we are alone and that no one understands. Breaking through this denial involves looking at the emotional wreckage‚Äîthe guilt, shame, and fear‚Äîthat we have been carrying." },
];

// -- STEPS 2-11 (Generated Structure - Ready for Text Content) --
const step2Questions = createStepStructure(2, "Step 2: Came to believe that a Power greater than ourselves could restore us to sanity.", "Sanity vs Insanity in addiction.", "Defining a Higher Power.", "The process of coming to believe.");
const step3Questions = createStepStructure(3, "Step 3: Made a decision to turn our will and our lives over to the care of God as we understood Him.", "The decision vs the action.", "Letting go of self-will.", "Moving from fear to faith.");
const step4Questions = createStepStructure(4, "Step 4: Made a searching and fearless moral inventory of ourselves.", "The purpose of inventory.", "Resentments and fears.", "Assets and liabilities.");
const step5Questions = createStepStructure(5, "Step 5: Admitted to God, to ourselves, and to another human being the exact nature of our wrongs.", "The value of confession.", "Overcoming shame.", "Building trust.");
const step6Questions = createStepStructure(6, "Step 6: Were entirely ready to have God remove all these defects of character.", "The difference between Step 6 and 7.", "Becoming ready.", "Letting go of old survival mechanisms.");
const step7Questions = createStepStructure(7, "Step 7: Humbly asked Him to remove our shortcomings.", "Defining humility.", "The practice of asking.", "Changing our behavior.");
const step8Questions = createStepStructure(8, "Step 8: Made a list of all persons we had harmed, and became willing to make amends to them all.", "Identifying harm done.", "Willingness vs action.", "Forgiveness of self and others.");
const step9Questions = createStepStructure(9, "Step 9: Made direct amends to such people wherever possible, except when to do so would injure them or others.", "Direct amends vs apologies.", "Living amends.", "Cleaning up the wreckage.");
const step10Questions = createStepStructure(10, "Step 10: Continued to take personal inventory and when we were wrong promptly admitted it.", "Daily inventory practice.", "Spot-check inventory.", "Keeping the side of the street clean.");
const step11Questions = createStepStructure(11, "Step 11: Sought through prayer and meditation to improve our conscious contact with God...", "Prayer (talking) vs Meditation (listening).", "Seeking knowledge of His will.", "The power to carry that out.");

// -- STEP 12 (Fully Populated from User Doc) --
const step12Questions: Question[] = [
  // Intro
  {
    id: 's12_intro',
    type: 'read_only',
    text: `Step 12: "Having had a spiritual awakening as the result of these steps, we tried to carry this message to addicts, and to practice these principles in all our affairs."\n\nIntroduction:\nStep 12 is the culmination of the program. It is about service, gratitude, and consistency. It asks us to take what we have been given‚Äîfreedom‚Äîand share it with others, while living a life of integrity in all areas, not just recovery meetings.`
  },
  // Section 1: The Spiritual Awakening
  { id: 's12_q1', type: 'input', text: "How would you describe your spiritual awakening?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q2', type: 'input', text: "How are you different now compared to when you started Step 1?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q3', type: 'input', text: "What does \"emotional sobriety\" mean to you now?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q4', type: 'input', text: "Do you feel a sense of purpose that was missing before?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },
  { id: 's12_q5', type: 'input', text: "How do you define your spirituality today?", context: "An awakening can be a sudden \"white light\" experience or, more commonly, a slow educational variety. It is simply a personality change sufficient to bring about recovery." },

  // Section 2: Carrying the Message
  { id: 's12_q6', type: 'input', text: "How can you be of service to others in recovery?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q7', type: 'input', text: "What is the difference between \"attraction\" and \"promotion\"?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q8', type: 'input', text: "How do you handle it when someone you are trying to help doesn't want help?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q9', type: 'input', text: "Why is working with others essential for your own sobriety?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },
  { id: 's12_q10', type: 'input', text: "What is the \"message\" you are trying to carry?", context: "We help others not to be \"gurus,\" but to insure our own recovery. Sharing our experience, strength, and hope helps us remember where we came from." },

  // Section 3: Practicing Principles in All Affairs
  { id: 's12_q11', type: 'input', text: "How do you apply the steps in your workplace or school?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q12', type: 'input', text: "How do you practice these principles in your romantic relationships?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q13', type: 'input', text: "What does it mean to be a \"good citizen\" in the context of Step 12?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q14', type: 'input', text: "How do you handle success or failure using spiritual principles?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
  { id: 's12_q15', type: 'input', text: "Are you ready to continue this way of life, one day at a time?", context: "We are not just \"sober\" people; we are people of integrity. We bring patience to our families, honesty to our jobs, and kindness to strangers." },
];

const twelveStepSections: WorkbookSection[] = [
  { id: 'step_1', title: 'Step 1', description: 'Powerlessness & Unmanageability', questions: step1Questions },
  { id: 'step_2', title: 'Step 2', description: 'Came to believe', questions: step2Questions },
  { id: 'step_3', title: 'Step 3', description: 'Turning it over', questions: step3Questions },
  { id: 'step_4', title: 'Step 4', description: 'Moral inventory', questions: step4Questions },
  { id: 'step_5', title: 'Step 5', description: 'Admitting our wrongs', questions: step5Questions },
  { id: 'step_6', title: 'Step 6', description: 'Entirely ready', questions: step6Questions },
  { id: 'step_7', title: 'Step 7', description: 'Humbly asked Him', questions: step7Questions },
  { id: 'step_8', title: 'Step 8', description: 'List of harms', questions: step8Questions },
  { id: 'step_9', title: 'Step 9', description: 'Making amends', questions: step9Questions },
  { id: 'step_10', title: 'Step 10', description: 'Personal inventory', questions: step10Questions },
  { id: 'step_11', title: 'Step 11', description: 'Conscious contact', questions: step11Questions },
  { id: 'step_12', title: 'Step 12', description: 'Spiritual awakening', questions: step12Questions },
];

// --- 3. RECOVERY DHARMA WORKBOOK (The Four Noble Truths) ---

// 1. First Noble Truth
const dharmaTruth1: Question[] = [
  { 
    id: 'rd_t1_intro', 
    type: 'read_only', 
    text: `The First Noble Truth is not a pessimistic claim that "life is miserable." rather, it is a realistic assessment that dissatisfaction, stress, and pain are part of the human experience.\n\nIn the context of addiction, this truth is the acknowledgment of our struggle. It is the realization that our compulsive behaviors‚Äîwhether to substances, people, or processes‚Äîhave become a source of suffering rather than a solution to it.\n\nWe admit that despite our best efforts to control it, the cycle has become unmanageable and painful.` 
  },
  { 
    id: 'rd_t1_q1', 
    type: 'input',
    text: "In what specific ways has my main coping mechanism (my addiction) stopped working for me?", 
    context: "We acknowledge that the things we used to cope with our pain have turned on us. What once provided relief now creates more suffering." 
  },
  { 
    id: 'rd_t1_q2', 
    type: 'input',
    text: "Can I identify the difference between 'pain' (the inevitable events of life) and 'suffering' (my reaction and resistance to those events)?", 
    context: "Pain is inevitable; suffering is optional. We suffer when we cling to how we want things to be, rather than accepting how they are." 
  },
  { 
    id: 'rd_t1_q3', 
    type: 'input',
    text: "Where in my body do I feel the physical sensation of 'unsatisfactoriness' or restlessness when I am not using/acting out?", 
    context: "Mindfulness begins with the body. The First Truth asks us to turn toward the discomfort we have been running from, rather than away from it." 
  },
  { 
    id: 'rd_t1_q4', 
    type: 'input',
    text: "How has my refusal to accept the reality of my situation prolonged my cycle of addiction?", 
    context: "Denial is a form of protection, but eventually, it becomes a prison. Acceptance is the first step toward unlocking the door." 
  },
  { 
    id: 'rd_t1_q5', 
    type: 'input',
    text: "Looking back, can I see how my 'solution' eventually became the primary problem in my life?", 
    context: "We realize that we have been trying to fill a spiritual void with material things, substances, or validation, and it simply does not work." 
  }
];

// 2. Second Noble Truth
const dharmaTruth2: Question[] = [
  { 
    id: 'rd_t2_intro', 
    type: 'read_only', 
    text: `The Second Truth teaches us that the root cause of our suffering is craving (thirst) and clinging.\n\nIt isn't just the drugs, the alcohol, or the behavior that is the problem; it is the underlying drive to fix the way we feel instantly. It is the deep-seated belief that "this moment is not enough" and that we need something external to make us whole.\n\nWe suffer because we cling to pleasure and push away pain, creating a constant tug-of-war in our minds.` 
  },
  { 
    id: 'rd_t2_q1', 
    type: 'input',
    text: "What is the specific feeling or emotion I am usually trying to escape when the craving arises?", 
    context: "Craving often arises as a response to an underlying discomfort‚Äîloneliness, fear, boredom, or shame. We use addiction to numb these feelings." 
  },
  { 
    id: 'rd_t2_q2', 
    type: 'input',
    text: "Can I identify a time recently when I clung to a pleasant experience so tightly that I ruined it when it naturally ended?", 
    context: "Impermanence is a law of nature. Suffering arises when we demand that temporary pleasure lasts forever." 
  },
  { 
    id: 'rd_t2_q3', 
    type: 'input',
    text: "What \"stories\" does my mind tell me about what will happen if I don't give in to the craving?", 
    context: "The mind creates catastrophic narratives to justify acting on impulse. We learn to observe these thoughts without believing them." 
  },
  { 
    id: 'rd_t2_q4', 
    type: 'input',
    text: "How does my attachment to a specific identity (e.g., 'the victim,' 'the addict,' 'the tough one') keep me stuck in old patterns?", 
    context: "We often cling to our suffering because it is familiar. Letting go of who we think we are allows us to become who we can be." 
  },
  { 
    id: 'rd_t2_q5', 
    type: 'input',
    text: "In what ways do I demand that the world conform to my expectations, and how does that lead to anger or resentment?", 
    context: "Expectations are resentments waiting to happen. When we stop fighting reality, the craving to escape reality diminishes." 
  }
];

// 3. Third Noble Truth
const dharmaTruth3: Question[] = [
  { 
    id: 'rd_t3_intro', 
    type: 'read_only', 
    text: `The Third Truth is the good news: Recovery is possible.\n\nSuffering is not permanent, and because it has a cause (craving), it can end. This is the truth of Cessation. It doesn‚Äôt mean we will never feel pain again, but it means we don't have to be enslaved by our reactions to it.\n\nWe can find a freedom that isn't dependent on external circumstances. We can experience peace right now, even in the midst of difficulty, by letting go of the demand for things to be different.` 
  },
  { 
    id: 'rd_t3_q1', 
    type: 'input',
    text: "Can I recall a moment in my recovery (or life) where I felt a sense of peace without needing to change anything?", 
    context: "Freedom is available in any moment where we stop fighting. This is the glimpse of Nirvana‚Äîthe cooling of the flames of desire." 
  },
  { 
    id: 'rd_t3_q2', 
    type: 'input',
    text: "What would my life look like if I believed, truly, that I am already 'whole' and don't need to be 'fixed'?", 
    context: "Our true nature is wise and compassionate. Recovery is not about building a new you, but uncovering the you that was there all along." 
  },
  { 
    id: 'rd_t3_q3', 
    type: 'input',
    text: "If I let go of the need to control the outcome of my current situation, what specific burden would be lifted off my shoulders?", 
    context: "Surrender is not giving up; it is giving over. We let go of the illusion of control and find safety in the present moment." 
  },
  { 
    id: 'rd_t3_q4', 
    type: 'input',
    text: "How does the idea of 'impermanence' give me hope regarding my current struggles or cravings?", 
    context: "This too shall pass. Knowing that cravings are like weather‚Äîstorms that come and go‚Äîhelps us ride them out without drowning." 
  },
  { 
    id: 'rd_t3_q5', 
    type: 'input',
    text: "Who in my life (or in my Sangha/community) represents the possibility of freedom to me, and what qualities do they embody?", 
    context: "We take refuge in the Sangha. Seeing the recovery of others proves that the Third Noble Truth is a reality, not just a theory." 
  }
];

// 4. Fourth Noble Truth
const dharmaTruth4: Question[] = [
  { 
    id: 'rd_t4_intro', 
    type: 'read_only', 
    text: `The Fourth Truth is the Eightfold Path‚Äîthe practical "how-to" guide for recovery.\n\nIt is a set of practices that helps us live ethically, train our minds, and cultivate wisdom. It covers Wisdom (Right View, Intention), Ethics (Right Speech, Action, Livelihood), and Meditation (Right Effort, Mindfulness, Concentration).\n\nThis is not a linear set of steps but a wheel of practice where each part supports the others. It is the daily discipline of recovery.` 
  },
  { 
    id: 'rd_t4_q1', 
    type: 'input',
    text: "Right Intention: Am I approaching my recovery today with an intention of kindness toward myself, or am I being harsh and critical?", 
    context: "Renunciation is not about punishment; it is an act of love. We let go of harmful behaviors because we care about our own well-being." 
  },
  { 
    id: 'rd_t4_q2', 
    type: 'input',
    text: "Right Speech: How have I used my words (to others or myself) to cause harm recently, and how can I practice honesty without cruelty?", 
    context: "Truthfulness is the foundation of trust. We cannot recover while hiding behind lies, but our truth must be spoken with compassion." 
  },
  { 
    id: 'rd_t4_q3', 
    type: 'input',
    text: "Right Action: What is one small, ethical action I can take today that aligns with the person I want to become?", 
    context: "Recovery is lived in the small moments. Every time we choose not to harm, we are strengthening our path to freedom." 
  },
  { 
    id: 'rd_t4_q4', 
    type: 'input',
    text: "Right Mindfulness: specific situations trigger me to go on 'autopilot,' and how can I bring more awareness to those moments?", 
    context: "Mindfulness is the pause between the trigger and the reaction. In that pause lies our freedom to choose a different response." 
  },
  { 
    id: 'rd_t4_q5', 
    type: 'input',
    text: "Right Effort: Am I striving too hard (restlessness) or not hard enough (complacency)? How can I find the 'Middle Way' in my recovery today?", 
    context: "The Middle Way is the path of balance. We avoid the extremes of indulgence and severe asceticism. We practice with gentle persistence." 
  }
];

// -- The Eightfold Path --

const eightfoldPart1: Question[] = [
  // 1. Right View
  { 
    id: 'rd_path_right_view_intro', 
    type: 'read_only', 
    text: `1. Right View (Understanding)\n\nRight View is the beginning of the path. In recovery, it means understanding the law of Karma (Cause and Effect). It is the deep realization that our actions have consequences.\n\nIt is accepting that unskillful actions (addiction) lead to suffering, and skillful actions (recovery) lead to freedom. It is seeing things as they truly are‚Äîimpermanent and interconnected‚Äîrather than how our addiction wants us to see them.` 
  },
  {
    id: 'rd_path_q1',
    type: 'input',
    text: "Do I truly accept that I am the owner of my actions and their consequences, without blaming others or my circumstances?",
    context: "We stop looking for a scapegoat. When we realize that our choices shape our reality, we reclaim the power to change that reality."
  },
  {
    id: 'rd_path_q2',
    type: 'input',
    text: "Can I see the cycle of 'cause and effect' in my last relapse or emotional outburst? What specific belief led to that action?",
    context: "Ignorance is the root of suffering. When we see the link between our beliefs and our pain, we can begin to break the chain."
  },
  {
    id: 'rd_path_q3',
    type: 'input',
    text: "How does viewing my thoughts as 'impermanent weather' change the way I react to a strong craving?",
    context: "Right View teaches us that no feeling is final. We don't have to obey a command that will disappear in ten minutes."
  },
  // 2. Right Intention
  { 
    id: 'rd_path_right_intention_intro', 
    type: 'read_only', 
    text: `2. Right Intention (Wise Resolve)\n\nIf Right View is the map, Right Intention is the steering wheel. It involves three specific resolves: Renunciation (letting go of craving), Good Will (loving-kindness), and Harmlessness (compassion).\n\nIt is the commitment to move away from cruelty and toward kindness, for ourselves and others.` 
  },
  {
    id: 'rd_path_q4',
    type: 'input',
    text: "Am I viewing 'renunciation' (giving up my addiction) as a punishment, or as a liberating gift I am giving myself?",
    context: "Renunciation is not deprivation. It is the joyous letting go of a heavy burden we have been carrying for too long."
  },
  {
    id: 'rd_path_q5',
    type: 'input',
    text: "In what situation today can I replace a thought of judgment (ill will) with a thought of understanding (good will)?",
    context: "We cannot hate ourselves into recovery. Intention shifts our internal dialogue from a prosecutor to a gentle guide."
  },
  {
    id: 'rd_path_q6',
    type: 'input',
    text: "How can I practice 'harmlessness' toward my own body today, considering the damage I may have done in the past?",
    context: "Compassion starts at home. Treating our bodies with respect is a direct act of defiance against the self-destruction of addiction."
  }
];

const eightfoldPart2: Question[] = [
  // 3. Right Speech
  { 
    id: 'rd_path_right_speech_intro', 
    type: 'read_only', 
    text: `3. Right Speech\n\nWords have power. Right Speech means abstaining from lying, divisive speech (gossip/talking behind backs), harsh/abusive speech, and idle chatter (mindless talking to avoid feelings).\n\nIn recovery, this is synonymous with "getting honest." We stop hiding behind deceptions and learn to speak our truth with care.` 
  },
  {
    id: 'rd_path_q7',
    type: 'input',
    text: "Is there a specific lie or half-truth I am currently protecting? What fear creates the need for this lie?",
    context: "Secrets keep us sick. Rigorous honesty is the antidote to the isolation of addiction."
  },
  {
    id: 'rd_path_q8',
    type: 'input',
    text: "How do you speak to myself? Is my internal monologue harsh and abusive? How can I apply Right Speech internally?",
    context: "If we spoke to our friends the way we speak to ourselves, we would have no friends. Mindfulness catches the inner critic in the act."
  },
  {
    id: 'rd_path_q9',
    type: 'input',
    text: "Can I practice 'noble silence' today‚Äîlistening more than I speak‚Äîto avoid the trap of idle chatter or gossip?",
    context: "Silence allows us to hear the truth. Sometimes the most skillful thing to say is nothing at all."
  },
  // 4. Right Action
  { 
    id: 'rd_path_right_action_intro', 
    type: 'read_only', 
    text: `4. Right Action\n\nThis factor corresponds to the Five Precepts: refraining from killing/harming, stealing, sexual misconduct, lying, and intoxication. Right Action is about living in a way that does not cause regret.\n\nIt creates a foundation of safety and trust in our lives.` 
  },
  {
    id: 'rd_path_q10',
    type: 'input',
    text: "Looking at the precept of 'not taking what is not given' (stealing), are there subtle ways I take things (time, energy, credit) from others?",
    context: "Generosity is the practice of letting go. We counter the taker mentality of addiction by asking, 'What can I give?'"
  },
  {
    id: 'rd_path_q11',
    type: 'input',
    text: "Regarding sexual misconduct/harm: Am I using relationships or sex to numb out, seek validation, or manipulate, rather than to connect?",
    context: "Intimacy requires presence. We learn to connect with others authentically, rather than using them as objects to fix our loneliness."
  },
  {
    id: 'rd_path_q12',
    type: 'input',
    text: "What is one ethical boundary I need to set today to protect my sobriety (e.g., not going to a certain place, not seeing a certain person)?",
    context: "Right Action is proactive. We don't just resist temptation; we build a life where temptation has no foothold."
  },
  // 5. Right Livelihood
  { 
    id: 'rd_path_right_livelihood_intro', 
    type: 'read_only', 
    text: `5. Right Livelihood\n\nWe spend a vast amount of our lives working. Right Livelihood asks us to earn our living in a way that doesn't violate our ethical principles or cause harm to others.\n\nIn a broader sense, it asks if our daily "hustle" supports our recovery or hinders it.` 
  },
  {
    id: 'rd_path_q13',
    type: 'input',
    text: "Does my current job or way of making money require me to compromise my integrity or values?",
    context: "Peace of mind is more valuable than a paycheck. We cannot maintain spiritual balance if we spend 40 hours a week violating our conscience."
  },
  {
    id: 'rd_path_q14',
    type: 'input',
    text: "How can I bring the spirit of service into my daily work, regardless of what my job title is?",
    context: "Every task can be a practice. When we work with mindfulness and care, our labor becomes an offering rather than a burden."
  },
  {
    id: 'rd_path_q15',
    type: 'input',
    text: "Am I using work as a new addiction (workaholism) to avoid facing other areas of my life?",
    context: "Balance is key. Right Livelihood supports life; it does not consume it."
  }
];

const eightfoldPart3: Question[] = [
  // 6. Right Effort
  { 
    id: 'rd_path_right_effort_intro', 
    type: 'read_only', 
    text: `6. Right Effort\n\nRight Effort is not about "white-knuckling" it. It is the balanced energy we apply to the practice.\n\nIt consists of four great efforts: (1) Preventing unwholesome states (cravings) from arising, (2) Abandoning unwholesome states that have arisen, (3) Cultivating wholesome states (joy, gratitude), and (4) Maintaining those wholesome states.` 
  },
  {
    id: 'rd_path_q16',
    type: 'input',
    text: "Am I trying too hard (perfectionism) or not hard enough (complacency)? Where is the 'Middle Way' for me right now?",
    context: "We tune the strings of our instrument not too tight, not too loose. Consistency beats intensity."
  },
  {
    id: 'rd_path_q17',
    type: 'input',
    text: "When a negative state arises (anger/fear), do I feed it with more thought, or do I apply the effort to let it go?",
    context: "What we water grows. Right Effort is the choice to stop watering the weeds and start watering the flowers."
  },
  {
    id: 'rd_path_q18',
    type: 'input',
    text: "What is one positive quality (e.g., patience, generosity) I want to actively cultivate and strengthen this week?",
    context: "Recovery is not just removing the bad; it is actively building the good. We fill the void with light."
  },
  // 7. Right Mindfulness
  { 
    id: 'rd_path_right_mindfulness_intro', 
    type: 'read_only', 
    text: `7. Right Mindfulness\n\nMindfulness is the core of the practice. It is the ability to see clearly what is happening right now.\n\nIt is the "Four Foundations of Mindfulness": Awareness of the body, feelings (pleasant/unpleasant/neutral), mind states (emotions), and phenomena (reality). It prevents us from living on autopilot.` 
  },
  {
    id: 'rd_path_q19',
    type: 'input',
    text: "Can I detect the physical warning signs of a resentment or craving before it becomes a mental obsession?",
    context: "The body always knows first. Mindfulness allows us to catch the spark before it becomes a forest fire."
  },
  {
    id: 'rd_path_q20',
    type: 'input',
    text: "Am I able to observe an uncomfortable emotion (like anxiety) without judging it as 'bad' or trying to fix it immediately?",
    context: "This is the practice of 'being with.' We learn to surf the waves of emotion rather than drowning in them."
  },
  {
    id: 'rd_path_q21',
    type: 'input',
    text: "How often during the day do I actually 'arrive' in the present moment, rather than living in the past or future?",
    context: "Life only happens now. When we are present, we are safe, because in this exact second, we are okay."
  },
  // 8. Right Concentration
  { 
    id: 'rd_path_right_concentration_intro', 
    type: 'read_only', 
    text: `8. Right Concentration\n\nWhile Mindfulness is broad awareness, Concentration is focused awareness. It is the ability to rest the mind on a single object (like the breath or a mantra).\n\nThis steadiness brings a deep sense of calm and joy, giving us a sanctuary from the chaos of the addicted mind.` 
  },
  {
    id: 'rd_path_q22',
    type: 'input',
    text: "When I sit to meditate, can I treat my wandering mind with gentleness, simply returning to the breath without self-criticism?",
    context: "The 'return' is the practice. Every time we realize we drifted and come back, we are strengthening the muscle of concentration."
  },
  {
    id: 'rd_path_q23',
    type: 'input',
    text: "How does the ability to focus on one thing help me when I am overwhelmed by life's problems?",
    context: "A scattered mind is a stressed mind. Concentration gathers our energy so we can face difficulties with stability."
  },
  {
    id: 'rd_path_q24',
    type: 'input',
    text: "Do I use distractions (phone, TV, food) to prevent myself from ever being truly quiet? What specific fear makes me avoid the silence?",
    context: "In the silence, we meet ourselves. We learn that we don't need constant noise to be okay."
  }
];

const dharmaSections: WorkbookSection[] = [
  { id: 'rd_truth_1', title: 'First Noble Truth', description: 'There is suffering', questions: dharmaTruth1 },
  { id: 'rd_truth_2', title: 'Second Noble Truth', description: 'The cause of suffering', questions: dharmaTruth2 },
  { id: 'rd_truth_3', title: 'Third Noble Truth', description: 'The end of suffering', questions: dharmaTruth3 },
  { id: 'rd_truth_4', title: 'Fourth Noble Truth', description: 'The path', questions: dharmaTruth4 },
  { id: 'rd_path_1', title: 'Part I: Wisdom', description: 'Right View & Right Intention', questions: eightfoldPart1 },
  { id: 'rd_path_2', title: 'Part II: Ethics', description: 'Right Speech, Action, & Livelihood', questions: eightfoldPart2 },
  { id: 'rd_path_3', title: 'Part III: Discipline', description: 'Right Effort, Mindfulness, & Concentration', questions: eightfoldPart3 },
];

// --- MASTER REGISTRY ---
export const WORKBOOKS: Workbook[] = [
  {
    id: 'general_recovery',
    title: 'General Recovery Workbook',
    description: 'A comprehensive 25-question guide to explore the foundations of your recovery journey.',
    type: 'general',
    sections: [{ id: 'main', title: 'Core Questions', questions: generalQuestions }]
  },
  {
    id: '12_steps',
    title: '12-Step Workbook',
    description: 'A comprehensive 12-Step program. Each step includes an introduction and 3 guided sections.',
    type: 'steps',
    sections: twelveStepSections
  },
  {
    id: 'recovery_dharma',
    title: 'Recovery Dharma',
    description: 'Buddhist-inspired path to recovery focusing on the Four Noble Truths and Eightfold Path.',
    type: 'steps',
    sections: dharmaSections
  }
];

export function getWorkbook(id: string): Workbook | undefined {
  return WORKBOOKS.find(w => w.id === id);
}
--- END_FILE: src/data/workbooks.ts ---

--- START_FILE: src/hooks/useDeepPatternAnalysis.ts ---
/**
 * src/hooks/useDeepPatternAnalysis.ts
 * GITHUB COMMENT:
 * [useDeepPatternAnalysis.ts]
 * UPDATED: Increased analysis window from 30 to 90 days.
 */
import { useState, useCallback } from 'react';
import { db } from '../lib/firebase';
import { collection, query, where, orderBy, limit, getDocs, type Firestore } from 'firebase/firestore';
import { useAuth } from '../contexts/AuthContext';
import { useEncryption } from '../contexts/EncryptionContext';
import { processInChunks } from '../lib/utils';
import { generateDeepPatternAnalysis, type DeepPatternResult } from '../lib/gemini';

interface UseDeepPatternAnalysisReturn {
    analyze: () => Promise<void>;
    loading: boolean;
    progress: number;
    result: DeepPatternResult | null;
    error: string | null;
    reset: () => void;
}

export function useDeepPatternAnalysis(): UseDeepPatternAnalysisReturn {
    const { user } = useAuth();
    const { decrypt } = useEncryption();
    
    const [loading, setLoading] = useState(false);
    const [progress, setProgress] = useState(0);
    const [result, setResult] = useState<DeepPatternResult | null>(null);
    const [error, setError] = useState<string | null>(null);

    const analyze = useCallback(async () => {
        if (!user || !db) return;
        
        setLoading(true);
        setError(null);
        setProgress(5); // Started

        try {
            const database: Firestore = db;
            
            // 1. Fetch last 90 entries directly from Firestore (UPDATED from 30)
            const q = query(
                collection(database, 'journals'),
                where('uid', '==', user.uid),
                orderBy('createdAt', 'desc'),
                limit(90) // <--- CHANGED HERE
            );

            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                setError("Not enough journal entries to analyze.");
                setLoading(false);
                return;
            }

            setProgress(20); // Fetched

            // 2. Process & Decrypt in Chunks (Prevent UI Freezing)
            const rawDocs = snapshot.docs.map(d => d.data());
            
            const decryptedEntries = await processInChunks(
                rawDocs,
                5, // Small chunk size for decryption safety
                async (docData) => {
                    let content = docData.content || "";
                    if (docData.isEncrypted) {
                        try {
                            content = await decrypt(docData.content);
                        } catch (e) {
                            console.error("Decryption failed for an entry:", e);
                            content = "[Skipped: Decryption Error]";
                        }
                    }
                    const date = docData.createdAt?.toDate ? docData.createdAt.toDate() : new Date();
                    return `Date: ${date.toLocaleDateString()}\nMood: ${docData.moodScore}\nContent: ${content}`;
                },
                (percent) => {
                    // Map 0-100% of processing to 20-70% of total progress
                    setProgress(20 + Math.floor(percent * 0.5));
                }
            );

            const combinedText = decryptedEntries.join('\n\n---\n\n');
            
            setProgress(75); // Sending to AI

            // 3. AI Analysis
            const aiResult = await generateDeepPatternAnalysis(combinedText);
            
            setResult(aiResult);
            setProgress(100);

        } catch (err) {
            console.error("Deep Pattern Analysis Failed:", err);
            setError("Analysis failed. Please try again later.");
        } finally {
            setLoading(false);
        }
    }, [user, decrypt]);

    const reset = () => {
        setResult(null);
        setError(null);
        setProgress(0);
    };

    return {
        analyze,
        loading,
        progress,
        result,
        error,
        reset
    };
}
--- END_FILE: src/hooks/useDeepPatternAnalysis.ts ---

--- START_FILE: src/index.css ---
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    /* REMOVED: bg-blue-50 to allow individual pages to set their own atmosphere */
    @apply text-slate-800 antialiased;
  }
  
  /* Reset headings to be bold and dark blue by default */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold text-blue-900;
  }
}
--- END_FILE: src/index.css ---

--- START_FILE: src/lib/analytics.ts ---
/**
 * src/lib/analytics.ts
 * GITHUB COMMENT:
 * [analytics.ts]
 * NEW: Dedicated service for logging system metrics.
 * HANDLES: Asynchronous writes to 'ai_logs' collection for Gemini token usage tracking.
 */
import { db } from './firebase';
import { collection, addDoc, Timestamp } from 'firebase/firestore';

export interface TokenUsage {
    promptTokens: number;
    candidatesTokens: number;
    totalTokens: number;
}

export interface AILogEntry {
    uid: string;
    model: string;
    context: string; // e.g., 'journal_analysis', 'workbook_coach'
    timestamp: Timestamp;
    usage: TokenUsage;
}

/**
 * Logs AI usage metrics to Firestore.
 * This is a "fire-and-forget" operation to avoid blocking the UI.
 * * @param uid - User ID (or 'anonymous')
 * @param model - Model name (e.g. 'gemini-2.5-flash')
 * @param context - Feature context triggering the call
 * @param usage - Token counts from the API response
 */
export async function logAIUsage(
    uid: string, 
    model: string, 
    context: string, 
    usage?: { promptTokenCount?: number; candidatesTokenCount?: number; totalTokenCount?: number }
) {
    if (!db) return;

    try {
        const usageData: TokenUsage = {
            promptTokens: usage?.promptTokenCount || 0,
            candidatesTokens: usage?.candidatesTokenCount || 0,
            totalTokens: usage?.totalTokenCount || 0
        };

        const entry: AILogEntry = {
            uid,
            model,
            context,
            timestamp: Timestamp.now(),
            usage: usageData
        };

        // Fire and forget - do not await
        addDoc(collection(db, 'ai_logs'), entry).catch(err => {
            console.warn("Failed to log AI usage:", err);
        });

    } catch (error) {
        // Silently fail to not disrupt user experience
        console.warn("Analytics error:", error);
    }
}
--- END_FILE: src/lib/analytics.ts ---

--- START_FILE: src/lib/crypto.ts ---
// src/lib/crypto.ts

// --- Configuration ---
const PBKDF2_ITERATIONS = 100000;
const SALT_SIZE = 16;
const KEY_LENGTH = 256; // AES-256

// In-memory key storage (cleared on refresh)
let globalKey: CryptoKey | null = null;

/**
 * Generates a cryptographic key from a user PIN and Salt using PBKDF2.
 * @param pin - The user's 4-digit PIN
 * @param saltBase64 - The user's unique salt (stored in Firestore)
 */
export async function generateKey(pin: string, saltBase64: string): Promise<CryptoKey> {
  const enc = new TextEncoder();
  const keyMaterial = await window.crypto.subtle.importKey(
    "raw",
    enc.encode(pin),
    { name: "PBKDF2" },
    false,
    ["deriveKey"]
  );

  // Convert Salt from Base64 to Uint8Array
  const salt = Uint8Array.from(atob(saltBase64), c => c.charCodeAt(0));

  const key = await window.crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: PBKDF2_ITERATIONS,
      hash: "SHA-256",
    },
    keyMaterial,
    { name: "AES-GCM", length: KEY_LENGTH },
    false, // Key is non-extractable
    ["encrypt", "decrypt"]
  );

  globalKey = key;
  return key;
}

/**
 * Computes a secure hash of the PIN + Salt for identity verification.
 * This allows us to validate the PIN before attempting to derive the encryption key.
 * @param pin - The input PIN
 * @param saltBase64 - The user's salt
 */
export async function computePinHash(pin: string, saltBase64: string): Promise<string> {
  const enc = new TextEncoder();
  const data = enc.encode(pin + saltBase64);
  const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

/**
 * Encrypts a string using AES-GCM.
 * Returns format: "IV_HEX:CIPHERTEXT_HEX"
 */
export async function encrypt(text: string): Promise<string> {
  if (!globalKey) throw new Error("Vault is locked. Key not found.");

  const enc = new TextEncoder();
  const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 12 bytes for AES-GCM
  
  const encryptedContent = await window.crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv },
    globalKey,
    enc.encode(text)
  );

  const ivHex = Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join('');
  const contentHex = Array.from(new Uint8Array(encryptedContent)).map(b => b.toString(16).padStart(2, '0')).join('');

  return `${ivHex}:${contentHex}`;
}

/**
 * Decrypts a string using AES-GCM.
 * Robustly handles legacy plain text and bad keys.
 */
export async function decrypt(encryptedPackage: string): Promise<string> {
  // 1. Check if Vault is unlocked
  if (!globalKey) {
      console.warn("Attempted decrypt without key");
      throw new Error("Vault is locked");
  }

  // 2. Handle Legacy Plain Text / Empty Data
  if (!encryptedPackage) return "";
  if (!encryptedPackage.includes(':')) {
      // If there is no IV separator, this is likely old unencrypted data.
      // Return it as-is so the user doesn't lose access.
      return encryptedPackage; 
  }

  try {
      const [ivHex, dataHex] = encryptedPackage.split(':');
      
      // 3. Validation
      if (!ivHex || !dataHex) return "[Corrupted Data]";

      const iv = new Uint8Array(ivHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));
      const data = new Uint8Array(dataHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16)));

      // --- CRITICAL FIX START ---
      // 4. Ensure data is large enough for the auth tag (16 bytes)
      // Without this check, subtle.decrypt throws a DOMException on corrupted/empty data
      if (data.byteLength < 16) {
          console.warn("Skipping decryption: Data buffer too small (corrupted entry).");
          return "[Error: Data Corrupted]";
      }
      // --- CRITICAL FIX END ---

      const decryptedBuffer = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        globalKey,
        data
      );

      return new TextDecoder().decode(decryptedBuffer);

  } catch (error) {
      console.error("Decryption failed:", error);
      // Return a safe fallback so the UI renders instead of crashing
      return "[Locked Content - Verify PIN]"; 
  }
}

/**
 * Generates a random salt for new users.
 */
export function generateSalt(): string {
  const salt = window.crypto.getRandomValues(new Uint8Array(SALT_SIZE));
  return btoa(String.fromCharCode(...salt));
}

/**
 * Clears the key from memory (Lock Vault).
 */
export function clearKey() {
  globalKey = null;
}

/**
 * Check if vault is currently unlocked
 */
export function isVaultUnlocked(): boolean {
    return !!globalKey;
}   
--- END_FILE: src/lib/crypto.ts ---

--- START_FILE: src/lib/dateUtils.ts ---
// src/lib/dateUtils.ts

export type RecurrenceType = 'once' | 'daily' | 'weekly' | 'biweekly' | 'monthly' | 'monthly-relative';

export interface RecurrenceConfig {
  type: RecurrenceType;
  interval?: number; // e.g. every 2 days
  daysOfWeek?: number[]; // 0=Sun, 1=Mon, etc. (for weekly)
  dayOfMonth?: number; // 1-31 (for monthly)
  weekOfMonth?: number; // 1 (1st), 2 (2nd), ... 5 (Last) (for monthly-relative)
  dayOfWeek?: number; // 0-6 (for monthly-relative)
}

/**
 * Calculates the next due date based on a reference date (usually today or the completed date)
 * and the recurrence configuration.
 */
export function calculateNextDueDate(baseDate: Date, config: RecurrenceConfig): Date | null {
  if (config.type === 'once') return null;

  const nextDate = new Date(baseDate);
  nextDate.setHours(23, 59, 59, 999); // Normalize time

  switch (config.type) {
    case 'daily':
      nextDate.setDate(nextDate.getDate() + (config.interval || 1));
      break;

    case 'weekly':
      // Simple weekly: Add 7 days
      nextDate.setDate(nextDate.getDate() + 7);
      break;

    case 'biweekly':
      nextDate.setDate(nextDate.getDate() + 14);
      break;

    case 'monthly': { // FIX: Added block scope braces
      // Add 1 month, try to keep same day
      const currentDay = nextDate.getDate();
      nextDate.setMonth(nextDate.getMonth() + 1);
      
      // Handle edge case (e.g. Jan 31 -> Feb 28/29)
      if (nextDate.getDate() !== currentDay) {
          // If date changed, it means we overflowed (e.g. Feb 28 became Mar 2)
          // Set to 0 (last day of previous month)
          nextDate.setDate(0); 
      }
      break;
    }

    case 'monthly-relative':
      // e.g. "Last Thursday of the month"
      if (config.weekOfMonth !== undefined && config.dayOfWeek !== undefined) {
          nextDate.setMonth(nextDate.getMonth() + 1);
          nextDate.setDate(1); // Start at 1st of next month

          const targetDay = config.dayOfWeek; // 0-6
          const targetWeek = config.weekOfMonth; // 1-5 (5 = Last)

          if (targetWeek === 5) {
              // Logic for "Last X of month"
              nextDate.setMonth(nextDate.getMonth() + 1);
              nextDate.setDate(0); // Last day of target month
              
              const lastDayOfWeek = nextDate.getDay();
              const diff = lastDayOfWeek - targetDay;
              const subtractDays = diff >= 0 ? diff : diff + 7;
              nextDate.setDate(nextDate.getDate() - subtractDays);
          } else {
              // Logic for "Nth X of month"
              // FIX: Changed let to const
              const currentDow = nextDate.getDay();
              const daysToAdd = (targetDay - currentDow + 7) % 7;
              nextDate.setDate(nextDate.getDate() + daysToAdd);
              
              // Add weeks
              nextDate.setDate(nextDate.getDate() + (targetWeek - 1) * 7);
          }
      }
      break;
  }

  return nextDate;
}

/**
 * Returns a human-readable string for the recurrence rule.
 */
export function getRecurrenceLabel(config: RecurrenceConfig): string {
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const ordinals = ['','1st','2nd','3rd','4th','Last'];

    switch(config.type) {
        case 'once': return 'One-time';
        case 'daily': return 'Daily';
        case 'weekly': return 'Weekly';
        case 'biweekly': return 'Bi-Weekly';
        case 'monthly': return 'Monthly';
        case 'monthly-relative': 
            if(config.weekOfMonth && config.dayOfWeek !== undefined) {
                return `${ordinals[config.weekOfMonth]} ${days[config.dayOfWeek]} of Month`;
            }
            return 'Custom Monthly';
        default: return 'Recurring';
    }
}
--- END_FILE: src/lib/dateUtils.ts ---

--- START_FILE: src/lib/db.ts ---
/**
 * src/lib/db.ts
 * GITHUB COMMENT:
 * [db.ts]
 * UPDATED: Added Firestore Data Converter pattern for strict type safety.
 * FEATURE: Generic converter automatically handles Timestamp -> Date transformation.
 */
import { 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  getDocs, 
  deleteDoc, 
  addDoc,
  query, 
  where, 
  orderBy,
  Timestamp,
  type Firestore,
  type QueryDocumentSnapshot,
  type DocumentData,
  type WithFieldValue
} from "firebase/firestore";
import { db } from "./firebase";
import type { User } from "firebase/auth";

// --- GENERIC CONVERTER ---
// This helper ensures all data fetched follows the strict TS interfaces
// and automatically converts Firestore Timestamps to JS Dates.
export const createConverter = <T extends object>() => ({
  toFirestore(data: WithFieldValue<T>): DocumentData {
    return data;
  },
  fromFirestore(snapshot: QueryDocumentSnapshot): T {
    const data = snapshot.data();
    // Recursive helper could go here, but for now we handle top-level dates
    const converted = Object.fromEntries(
      Object.entries(data).map(([key, value]) => {
        if (value instanceof Timestamp) {
          return [key, value.toDate()];
        }
        return [key, value];
      })
    );
    return { id: snapshot.id, ...converted } as T;
  },
});

// --- INTERFACES ---

export interface UserProfile {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  sobrietyDate: Timestamp | null;
  createdAt: Timestamp;
  lastLogin?: Timestamp;
  lastExportAt?: Timestamp; 
  role?: 'admin' | 'user';   
}

export interface JournalTemplate {
  id: string;
  name: string;
  prompts: string[]; 
  defaultTags: string[]; 
}

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  moodScore: number;
  tags: string[];
  createdAt: Timestamp;
  isEncrypted?: boolean;
  weather?: {
    temp: number;
    condition: string;
    location?: string;
  } | null;
}

export interface Task {
  id?: string;
  uid: string;
  title: string;
  completed: boolean; 
  status?: 'pending' | 'completed';
  isRecurring: boolean;
  frequency: 'once' | 'daily' | 'weekly' | 'monthly';
  currentStreak: number;
  priority: 'High' | 'Medium' | 'Low';
  createdAt: Timestamp;
  dueDate?: Timestamp;
}

// --- PROFILE FUNCTIONS ---

export async function getProfile(uid: string): Promise<UserProfile | null> {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;
  
  const userRef = doc(database, "users", uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  }
  return null;
}

export async function getOrCreateUserProfile(user: User): Promise<UserProfile> {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const userRef = doc(database, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    await updateDoc(userRef, { lastLogin: Timestamp.now() });
    return userSnap.data() as UserProfile;
  } else {
    const newProfile: UserProfile = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL,
      sobrietyDate: null, 
      createdAt: Timestamp.now(),
      lastLogin: Timestamp.now(),
      role: 'user' // Default new users to 'user' role
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  }
}

export async function updateProfileData(uid: string, data: Partial<UserProfile>) {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const userRef = doc(database, "users", uid);
  await setDoc(userRef, { ...data }, { merge: true });
}

export async function updateSobrietyDate(uid: string, date: Date) {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;
  
  const userRef = doc(database, "users", uid);
  await updateDoc(userRef, {
    sobrietyDate: Timestamp.fromDate(date)
  });
}

// --- TEMPLATE FUNCTIONS ---

export async function getUserTemplates(uid: string): Promise<JournalTemplate[]> {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const templatesRef = collection(database, 'users', uid, 'templates');
  const snapshot = await getDocs(templatesRef);

  return snapshot.docs.map(docSnap => ({
    id: docSnap.id,
    ...docSnap.data()
  } as JournalTemplate));
}

export async function saveUserTemplate(uid: string, template: JournalTemplate) {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const docRef = template.id 
    ? doc(database, 'users', uid, 'templates', template.id)
    : doc(collection(database, 'users', uid, 'templates'));

  const dataToSave = {
    ...template,
    id: docRef.id 
  };

  await setDoc(docRef, dataToSave);
}

export async function deleteUserTemplate(uid: string, templateId: string) {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const docRef = doc(database, 'users', uid, 'templates', templateId);
  await deleteDoc(docRef);
}

// --- JOURNAL FUNCTIONS ---

export const addJournalEntry = async (uid: string, entry: Omit<JournalEntry, 'uid' | 'createdAt'>) => {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;
  
  await addDoc(collection(database, 'journals'), {
    uid,
    ...entry,
    createdAt: Timestamp.now(),
  });
};

export const getJournalHistory = async (uid: string) => {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  const q = query(
    collection(database, 'journals'),
    where('uid', '==', uid),
    orderBy('createdAt', 'desc')
  );
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() } as JournalEntry));
};

// --- DATA SOVEREIGNTY (EXPORT) ---

export interface FullUserData {
  profile: UserProfile | null;
  journals: JournalEntry[];
  tasks: Task[];
  templates: JournalTemplate[];
  workbookAnswers: Record<string, unknown>[];
}

export async function fetchAllUserData(uid: string): Promise<FullUserData> {
  if (!db) throw new Error("Database not initialized");
  const database: Firestore = db;

  // 1. Profile
  const profile = await getProfile(uid);

  // 2. Journals
  const journalsQ = query(collection(database, 'journals'), where('uid', '==', uid), orderBy('createdAt', 'desc'));
  const journalsSnap = await getDocs(journalsQ);
  const journals = journalsSnap.docs.map(d => ({ id: d.id, ...d.data() } as JournalEntry));

  // 3. Tasks
  const tasksQ = query(collection(database, 'tasks'), where('uid', '==', uid));
  const tasksSnap = await getDocs(tasksQ);
  const tasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() } as Task));

  // 4. Templates
  const templates = await getUserTemplates(uid);

  // 5. Workbook Answers
  const wbQ = query(collection(database, 'users', uid, 'workbook_answers'));
  const wbSnap = await getDocs(wbQ);
  const workbookAnswers = wbSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  return {
    profile,
    journals,
    tasks,
    templates,
    workbookAnswers
  };
}
--- END_FILE: src/lib/db.ts ---

--- START_FILE: src/lib/exporter.ts ---
// src/lib/exporter.ts
import { decrypt } from './crypto';
import type { FullUserData, JournalEntry, Task } from './db';
import { processInChunks } from './utils';
import type { jsPDF } from 'jspdf';
import type { UserOptions } from 'jspdf-autotable';

// Type definition for jspdf-autotable extension
interface jsPDFWithAutoTable extends jsPDF {
  lastAutoTable: {
    finalY: number;
  };
  autoTable: (options: UserOptions) => void;
}

/**
 * Decrypts sensitive fields in the user data using the shared chunk processor.
 */
export async function prepareDataForExport(
  data: FullUserData, 
  onProgress: (percent: number) => void
): Promise<FullUserData> {
  
  // Decrypt Journals
  const decryptedJournals = await processInChunks(
    data.journals,
    20, // Batch size
    async (entry) => {
      if (entry.isEncrypted && entry.content) {
        try {
          const plainText = await decrypt(entry.content);
          return { ...entry, content: plainText, isEncrypted: false };
        } catch (e) {
          console.error(`Failed to decrypt journal ${entry.id}`, e);
          return { ...entry, content: "[DECRYPTION FAILED]", isEncrypted: true };
        }
      }
      return entry;
    },
    (p) => onProgress(Math.floor(p * 0.8)) // Map to 0-80% range
  );

  // Decrypt Workbook Answers
  const decryptedWorkbooks = await processInChunks(
    data.workbookAnswers,
    20,
    async (ans) => {
      // Check if this answer record matches our encryption pattern
      const anyAns = ans as Record<string, unknown>;
      const newAns = { ...anyAns };
      
      // Handle specific schema structure from WorkbookSession
      if (newAns.answers && typeof newAns.answers === 'object') {
         const ansMap = newAns.answers as Record<string, unknown>;
         const decryptedMap: Record<string, unknown> = {};
         
         for (const [key, val] of Object.entries(ansMap)) {
             if (val && typeof val === 'object' && 'isEncrypted' in val && (val as {isEncrypted: boolean}).isEncrypted) {
                 try {
                     // Access 'text' property safely via unknown cast
                     const text = await decrypt((val as unknown as {text: string}).text);
                     decryptedMap[key] = text;
                 } catch {
                     decryptedMap[key] = "[LOCKED]";
                 }
             } else {
                 decryptedMap[key] = val;
             }
         }
         newAns.answers = decryptedMap;
      }
      return newAns;
    },
    (p) => onProgress(80 + Math.floor(p * 0.2)) // Map to 80-100% range
  );

  return {
    ...data,
    journals: decryptedJournals,
    workbookAnswers: decryptedWorkbooks
  };
}

/**
 * Generates a JSON file blob.
 */
export function generateJSON(data: FullUserData): Blob {
  const jsonStr = JSON.stringify(data, null, 2);
  return new Blob([jsonStr], { type: "application/json" });
}

/**
 * Generates a formatted PDF using jsPDF (Dynamic Import).
 */
export async function generatePDF(data: FullUserData): Promise<Blob> {
  // Dynamic Import to save bundle size
  const { jsPDF } = await import('jspdf');
  const { default: autoTable } = await import('jspdf-autotable');

  const doc = new jsPDF() as jsPDFWithAutoTable;
  const pageWidth = doc.internal.pageSize.width;

  // 1. Title Page
  doc.setFontSize(24);
  doc.setTextColor(40, 40, 40);
  doc.text("My Recovery Toolkit", pageWidth / 2, 40, { align: "center" });
  
  doc.setFontSize(14);
  doc.setTextColor(100, 100, 100);
  doc.text("Personal Data Export", pageWidth / 2, 50, { align: "center" });
  
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, 60, { align: "center" });
  
  if (data.profile?.email) {
    doc.text(`User: ${data.profile.email}`, pageWidth / 2, 65, { align: "center" });
  }

  doc.text("CONFIDENTIAL: This document contains unencrypted personal data.", pageWidth / 2, 80, { align: "center" });

  // 2. Journals Table
  doc.addPage();
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text("Journal Entries", 14, 20);

  const journalRows = data.journals.map((j: JournalEntry) => {
    const date = j.createdAt?.toDate ? j.createdAt.toDate().toLocaleDateString() : 'Unknown';
    const mood = j.moodScore ? `${j.moodScore}/10` : '-';
    // Clean content slightly for PDF
    const content = j.content.replace(/\*\*/g, '').substring(0, 500) + (j.content.length > 500 ? '...' : '');
    return [date, mood, content];
  });

  autoTable(doc, {
    startY: 25,
    head: [['Date', 'Mood', 'Entry']],
    body: journalRows,
    styles: { fontSize: 9, cellPadding: 3 },
    columnStyles: {
      0: { cellWidth: 25 },
      1: { cellWidth: 15 },
      2: { cellWidth: 'auto' }
    }
  });

  // 3. Tasks
  doc.addPage();
  doc.setFontSize(16);
  doc.text("Active Quests & Habits", 14, 20);

  const taskRows = data.tasks.map(t => {
    // Safely access 'category'
    const category = (t as Task & { category?: string }).category || 'General';

    return [
      t.title,
      category,
      t.priority,
      t.isRecurring ? t.frequency : 'One-time',
      t.status || 'Pending'
    ];
  });

  autoTable(doc, {
    startY: 25,
    head: [['Title', 'Category', 'Priority', 'Frequency', 'Status']],
    body: taskRows,
  });

  return doc.output('blob');
}
--- END_FILE: src/lib/exporter.ts ---

--- START_FILE: src/lib/firebase.ts ---
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

console.log("DEBUG: Current Auth Domain:", import.meta.env.VITE_FIREBASE_AUTH_DOMAIN); // <--- ADD THIS

// 1. Construct config directly from individual environment variables
// These will be injected by Vite during the build
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
};

// 2. Initialize (Safe Check)
// We check if apiKey exists to ensure we aren't crashing on empty config
const app = firebaseConfig.apiKey ? initializeApp(firebaseConfig) : undefined;

if (!app) {
  console.error("Firebase failed to initialize. Missing API Key.");
}

export const auth = app ? getAuth(app) : undefined;
export const db = app ? getFirestore(app) : undefined;
export const googleProvider = new GoogleAuthProvider();

export default app;
--- END_FILE: src/lib/firebase.ts ---

--- START_FILE: src/lib/gamification.ts ---
// src/lib/gamification.ts
import { Timestamp } from 'firebase/firestore';

// --- CONFIGURATION ---
const XP_VALUES = {
    JOURNAL_ENTRY: 25,
    JOURNAL_LONG_ENTRY: 10, // Bonus for depth
    TASK_LOW: 10,
    TASK_MEDIUM: 25,
    TASK_HIGH: 50,
    WORKBOOK_QUESTION: 15,
    VITALITY_LOG: 15,
    CLEAN_DAY_MILESTONE: 500 // XP per 30 days
};

// --- INTERFACES ---

export interface GamificationStats {
  streakDays: number;
  totalEntries: number;
  averageMood: number;
  journalStreak: number;
  consistencyRate: number; // entries per week
  totalWords: number;
}

export interface TaskStats {
    completionRate: number;
    habitFire: number; // Current streak of completed recurring tasks
}

export interface WorkbookStats {
    wisdomScore: number; // Total questions answered
    masterCompletion: number; // % of total questions
}

export interface VitalityStats {
    bioStreak: number;
    totalLogs: number;
}

export interface LevelData {
    level: number;
    title: string;
    currentXP: number;
    nextLevelXP: number;
    progressPercent: number;
}

export interface UserStats {
    totalXP: number;
    levelData: LevelData;
    archetype: string; // 'Scholar', 'Warrior', 'Monk', 'Philosopher', 'Balanced'
}

// Minimal interfaces for input data to avoid 'any'
interface ScorableJournal {
    tags?: string[];
    content?: string;
    moodScore?: number;
    createdAt: { toDate: () => Date } | Date | Timestamp; 
}

interface ScorableTask {
    status?: string;
    priority?: 'High' | 'Medium' | 'Low';
    completed?: boolean;
    currentStreak?: number;
}

// --- HELPER FUNCTIONS ---

// Helper to check if two dates are the same day
const isSameDay = (d1: Date, d2: Date) => {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
};

const getTitle = (level: number): string => {
    if (level >= 50) return "Elder / Sponsor";
    if (level >= 40) return "Guide";
    if (level >= 30) return "Architect";
    if (level >= 20) return "Warrior";
    if (level >= 10) return "Initiate";
    return "Seeker";
};

// Standard RPG Curve: Level = Floor(Constant * Sqrt(XP))
const calculateLevel = (xp: number): LevelData => {
    const CONSTANT = 0.07; // 0.07 makes Lvl 10 approx 20k XP
    // Level calculation (min level 1)
    const level = Math.max(1, Math.floor(CONSTANT * Math.sqrt(xp)) + 1);
    
    // XP required for current and next levels
    // Inverse formula: XP = (Level / CONSTANT)^2
    const currentLevelBaseXP = Math.pow((level - 1) / CONSTANT, 2);
    const nextLevelBaseXP = Math.pow(level / CONSTANT, 2);
    
    const neededForNext = nextLevelBaseXP - currentLevelBaseXP;
    const progressInLevel = xp - currentLevelBaseXP;

    // Safety check for divide by zero (shouldn't happen with level >= 1)
    const progressPercent = neededForNext > 0 
        ? Math.min(100, Math.round((progressInLevel / neededForNext) * 100))
        : 0;

    return {
        level,
        title: getTitle(level),
        currentXP: xp,
        nextLevelXP: Math.floor(nextLevelBaseXP),
        progressPercent
    };
};

// --- CORE CALCULATORS ---

/**
 * Calculates the holistic User Level and Archetype based on all recovery data.
 */
export const calculateUserLevel = (
    journals: ScorableJournal[], 
    tasks: ScorableTask[], 
    workbookAnswersCount: number,
    cleanDays: number
): UserStats => {
    let xp = 0;
    const xpBreakdown = { wisdom: 0, action: 0, vitality: 0, reflection: 0 };

    // 1. Calculate Journal XP
    journals.forEach(j => {
        let entryXP = XP_VALUES.JOURNAL_ENTRY;
        
        // Vitality Check (Different Bucket)
        if (j.tags && j.tags.includes('Vitality')) {
            // Vitality logs count towards vitality, not reflection
            xpBreakdown.vitality += XP_VALUES.VITALITY_LOG;
            xp += XP_VALUES.VITALITY_LOG;
            return; 
        }

        // Depth Bonus
        if (j.content && j.content.trim().split(/\s+/).length > 50) {
            entryXP += XP_VALUES.JOURNAL_LONG_ENTRY;
        }
        
        xpBreakdown.reflection += entryXP;
        xp += entryXP;
    });

    // 2. Calculate Task XP
    tasks.forEach(t => {
        if (t.status === 'completed' || t.completed) {
            let taskXP = 0;
            switch(t.priority) {
                case 'High': taskXP = XP_VALUES.TASK_HIGH; break;
                case 'Medium': taskXP = XP_VALUES.TASK_MEDIUM; break;
                default: taskXP = XP_VALUES.TASK_LOW;
            }
            xp += taskXP;
            xpBreakdown.action += taskXP;
        }
    });

    // 3. Calculate Workbook XP
    const wbXP = workbookAnswersCount * XP_VALUES.WORKBOOK_QUESTION;
    xp += wbXP;
    xpBreakdown.wisdom += wbXP;

    // 4. Clean Time Bonuses (Every 30 days)
    const milestones = Math.floor(cleanDays / 30);
    xp += (milestones * XP_VALUES.CLEAN_DAY_MILESTONE);

    // 5. Determine Archetype
    const maxVal = Math.max(xpBreakdown.wisdom, xpBreakdown.action, xpBreakdown.vitality, xpBreakdown.reflection);
    let archetype = "Balanced";
    
    // Simple logic: if one category clearly dominates
    if (maxVal > 0) {
        if (maxVal === xpBreakdown.wisdom) archetype = "Scholar";
        else if (maxVal === xpBreakdown.action) archetype = "Doer";
        else if (maxVal === xpBreakdown.vitality) archetype = "Monk";
        else if (maxVal === xpBreakdown.reflection) archetype = "Philosopher";
    }

    return {
        totalXP: Math.floor(xp),
        levelData: calculateLevel(xp),
        archetype
    };
};

export const calculateJournalStats = (journals: ScorableJournal[]): GamificationStats => {
    if (!journals || journals.length === 0) {
        return { 
            streakDays: 0, 
            totalEntries: 0, 
            averageMood: 0, 
            journalStreak: 0, 
            consistencyRate: 0, 
            totalWords: 0 
        };
    }

    // Sort descending (newest first)
    // Safely handle Firestore Timestamps vs Date objects
    const sorted = [...journals].sort((a, b) => {
        const dateA = a.createdAt instanceof Date ? a.createdAt : (a.createdAt as Timestamp).toDate();
        const dateB = b.createdAt instanceof Date ? b.createdAt : (b.createdAt as Timestamp).toDate();
        return dateB.getTime() - dateA.getTime();
    });
    
    const today = new Date();
    
    // 1. Total Entries
    const totalEntries = journals.length;

    // 2. Average Mood
    const moodSum = journals.reduce((acc, curr) => acc + (curr.moodScore || 0), 0);
    const averageMood = totalEntries > 0 ? parseFloat((moodSum / totalEntries).toFixed(1)) : 0;

    // 3. Journal Streak
    let currentStreak = 0;
    
    // Check if posted today
    const firstEntry = sorted[0];
    const lastPostDate = firstEntry.createdAt instanceof Date ? firstEntry.createdAt : (firstEntry.createdAt as Timestamp).toDate();
    
    const postedToday = isSameDay(lastPostDate, today);
    // If not posted today, check if posted yesterday to maintain streak
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const postedYesterday = isSameDay(lastPostDate, yesterday);

    if (postedToday || postedYesterday) {
        currentStreak = 1;
        // Iterate backwards to count consecutive days
        const uniqueDays = new Set<string>();
        journals.forEach(j => {
            const d = j.createdAt instanceof Date ? j.createdAt : (j.createdAt as Timestamp).toDate();
            uniqueDays.add(d.toDateString());
        });
        const sortedDates = Array.from(uniqueDays).map(d => new Date(d)).sort((a, b) => b.getTime() - a.getTime());
        
        for (let i = 0; i < sortedDates.length - 1; i++) {
            const current = sortedDates[i];
            const next = sortedDates[i+1];
            
            // Difference in days
            const diffTime = Math.abs(current.getTime() - next.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                currentStreak++;
            } else {
                break;
            }
        }
    }

    // 4. Consistency (Entries / Week)
    const oldestEntry = sorted[sorted.length - 1];
    const firstDate = oldestEntry.createdAt instanceof Date ? oldestEntry.createdAt : (oldestEntry.createdAt as Timestamp).toDate();
    const timeSpanDays = Math.max(1, (today.getTime() - firstDate.getTime()) / (1000 * 3600 * 24));
    const weeksActive = Math.ceil(timeSpanDays / 7);
    const consistencyRate = parseFloat((totalEntries / weeksActive).toFixed(1));

    // 5. Total Words
    const totalWords = journals.reduce((acc, curr) => {
        const words = curr.content ? curr.content.trim().split(/\s+/).length : 0;
        return acc + words;
    }, 0);

    return {
        streakDays: currentStreak,
        totalEntries,
        averageMood,
        journalStreak: currentStreak,
        consistencyRate,
        totalWords
    };
};

export const calculateTaskStats = (tasks: ScorableTask[]): TaskStats => {
    if (!tasks || tasks.length === 0) {
        return { completionRate: 0, habitFire: 0 };
    }

    const completed = tasks.filter(t => t.completed || t.status === 'completed').length;
    const completionRate = Math.round((completed / tasks.length) * 100);

    // Habit Fire: Longest current streak among active recurring tasks
    let maxStreak = 0;
    tasks.forEach(t => {
        if (t.currentStreak && t.currentStreak > maxStreak) {
            maxStreak = t.currentStreak;
        }
    });

    return { completionRate, habitFire: maxStreak };
};

export const calculateWorkbookStats = (answersSnapshotSize: number, totalQuestionsAvailable: number = 50): WorkbookStats => {
    return {
        wisdomScore: answersSnapshotSize,
        masterCompletion: Math.round((answersSnapshotSize / totalQuestionsAvailable) * 100)
    };
};

export const calculateVitalityStats = (journals: ScorableJournal[]): VitalityStats => {
    if (!journals) return { bioStreak: 0, totalLogs: 0 };

    // Filter for entries tagged 'Vitality'
    const vitalityLogs = journals.filter(j => j.tags && j.tags.includes('Vitality'));
    
    if (vitalityLogs.length === 0) return { bioStreak: 0, totalLogs: 0 };

    // 1. Total Logs
    const totalLogs = vitalityLogs.length;

    // 2. Bio Streak (Same logic as Journal Streak)
    const sorted = [...vitalityLogs].sort((a, b) => {
        const dateA = a.createdAt instanceof Date ? a.createdAt : (a.createdAt as Timestamp).toDate();
        const dateB = b.createdAt instanceof Date ? b.createdAt : (b.createdAt as Timestamp).toDate();
        return dateB.getTime() - dateA.getTime();
    });
    const today = new Date();
    
    let currentStreak = 0;
    const firstEntry = sorted[0];
    const lastPostDate = firstEntry.createdAt instanceof Date ? firstEntry.createdAt : (firstEntry.createdAt as Timestamp).toDate();
    
    const postedToday = isSameDay(lastPostDate, today);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const postedYesterday = isSameDay(lastPostDate, yesterday);

    if (postedToday || postedYesterday) {
        currentStreak = 1;
        const uniqueDays = new Set<string>();
        vitalityLogs.forEach(j => {
            const d = j.createdAt instanceof Date ? j.createdAt : (j.createdAt as Timestamp).toDate();
            uniqueDays.add(d.toDateString());
        });
        const sortedDates = Array.from(uniqueDays).map(d => new Date(d)).sort((a, b) => b.getTime() - a.getTime());
        
        for (let i = 0; i < sortedDates.length - 1; i++) {
            const current = sortedDates[i];
            const next = sortedDates[i+1];
            const diffTime = Math.abs(current.getTime() - next.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) currentStreak++;
            else break;
        }
    }

    return { bioStreak: currentStreak, totalLogs };
};
--- END_FILE: src/lib/gamification.ts ---

--- START_FILE: src/lib/gemini.ts ---
/**
 * src/lib/gemini.ts
 * GITHUB COMMENT:
 * [gemini.ts]
 * UPDATED: Added analyzeSystemHealth() for Admin Tools.
 * FEATURE: AI Agent acts as a Senior Dev to triage crash logs and suggest fixes.
 */
import { GoogleGenerativeAI } from '@google/generative-ai';
import { auth } from './firebase'; // To capture current user for logging
import { logAIUsage } from './analytics';

// Initialize Gemini
const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GEMINI_API_KEY || '');

// --- Configuration ---
const GENERATION_CONFIG = {
  temperature: 0.7,
  topP: 0.8,
  topK: 40,
  maxOutputTokens: 8192,
};

// --- Model Cascade Configuration ---
const MODEL_CASCADE = [
  'gemini-2.5-flash', 
  'gemini-2.5-pro', 
  'gemini-2.0-flash'
];

// --- Interfaces ---

export interface AIAnalysisResult {
    sentiment: 'Positive' | 'Neutral' | 'Negative';
    moodScore: number;
    summary: string;
    actionableSteps: string[];
    risks: string[];
}
// Alias for backward compatibility
export type AnalysisResult = AIAnalysisResult;

export interface ComparativeAnalysisResult {
    trajectory: 'Improving' | 'Stable' | 'Declining' | 'Fluctuating';
    key_themes: string[];
    comparison_summary: string;
    wins: string[];
    blind_spots: string[];
    actionable_advice: string[];
}

export interface WorkbookAnalysisResult {
    scope_context: string; 
    summary: string;
    pillars: {
        understanding: string;
        emotional_resonance: string;
        blind_spots: string;
    };
    suggested_actions: string[];
}

// Deep Pattern Recognition Interface
export interface DeepPatternResult {
    core_triggers: string[];
    emotional_velocity: string; 
    hidden_correlations: string[];
    relapse_risk_level: 'Low' | 'Moderate' | 'High' | 'Critical';
    long_term_advice: string[];
    pattern_summary: string;
}

// System Health Interface
export interface SystemHealthAnalysis {
    status: 'Critical' | 'Warning' | 'Stable';
    summary: string;
    top_issues: {
        error_signature: string;
        occurrence_count: number;
        suspected_root_cause: string;
        suggested_fix: string;
    }[];
    environment_patterns: string; // e.g. "Mostly iOS devices"
}

// --- Core Helper: Smart Cascade Generation ---
async function generateWithCascade(prompt: string, contextTag: string, specificModel?: string): Promise<string> {
    const modelsToTry = specificModel 
        ? [specificModel, ...MODEL_CASCADE.filter(m => m !== specificModel)]
        : MODEL_CASCADE;
    
    let lastError: Error | null = null;

    for (let i = 0; i < modelsToTry.length; i++) {
        const currentModelName = modelsToTry[i];
        
        try {
            if (import.meta.env.DEV) {
               
                console.log(`ü§ñ AI Attempt ${i + 1}/${modelsToTry.length}: Using ${currentModelName}`);
            }

            const model = genAI.getGenerativeModel({ 
                model: currentModelName, 
                generationConfig: GENERATION_CONFIG 
            });
            
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            if (!text) throw new Error(`Empty response from ${currentModelName}`);
            
            // --- LOGGING ---
            const uid = auth?.currentUser?.uid || 'anonymous';
            logAIUsage(uid, currentModelName, contextTag, response.usageMetadata);
            // ----------------
            
            return text;

        } catch (error) {
            console.warn(`‚ö†Ô∏è Attempt failed with ${currentModelName}:`, error);
            lastError = error as Error;
            await new Promise(resolve => setTimeout(resolve, 500 * (i + 1))); 
        }
    }

    throw new Error(`All AI models failed. Last error: ${lastError?.message}`);
}

function cleanJSON(text: string): string {
    return text.replace(/```json\n?|```/g, '').trim();
}

// ============================================================================
//  EXPOSED FUNCTIONS
// ============================================================================

export async function analyzeSystemHealth(errorLogs: string): Promise<SystemHealthAnalysis> {
    const prompt = `
    You are a Senior React & Firebase Engineer. I am providing you with a raw dump of client-side error logs.
    Your job is to triage these errors, group duplicates, and identify root causes.

    RAW ERROR LOGS:
    ${errorLogs}

    Return a JSON object with this EXACT structure:
    {
        "status": "Critical" | "Warning" | "Stable",
        "summary": "A 1-sentence executive summary of the system health.",
        "top_issues": [
            {
                "error_signature": "Short description (e.g. 'Undefined in JournalEditor')",
                "occurrence_count": 0 (Integer estimate based on logs provided),
                "suspected_root_cause": "Technical explanation",
                "suggested_fix": "Code-level recommendation"
            }
        ],
        "environment_patterns": "Note any patterns (e.g., 'Only failing on Mobile Safari' or 'Across all devices')."
    }
    IMPORTANT: Return ONLY valid JSON. No Markdown.
    `;

    // Use Pro model for better code analysis reasoning
    const text = await generateWithCascade(prompt, 'system_health_analysis', 'gemini-2.5-pro');
    return JSON.parse(cleanJSON(text)) as SystemHealthAnalysis;
}

export async function generateDeepPatternAnalysis(
    journalHistory: string
): Promise<DeepPatternResult> {
    const prompt = `
    Perform a "Deep Pattern Recognition" analysis on the following 90 days of journal entries.
    Use your advanced reasoning to identify subtle correlations, triggers, and emotional velocity that a human might miss.

    JOURNAL DATA:
    ${journalHistory}

    Return a JSON object with this EXACT structure:
    {
        "pattern_summary": "A comprehensive paragraph describing the user's psychological landscape over this period.",
        "core_triggers": ["Trigger 1", "Trigger 2", "Trigger 3"],
        "emotional_velocity": "A brief description of how quickly their mood shifts (e.g. 'Stable but low', 'Volatile spikes').",
        "hidden_correlations": ["Correlation 1 (e.g. 'Poor sleep correlates with high anxiety 2 days later')", "Correlation 2"],
        "relapse_risk_level": "Low" | "Moderate" | "High" | "Critical",
        "long_term_advice": ["Action 1", "Action 2", "Action 3"]
    }
    IMPORTANT: Provide EXACTLY 3 distinct, high-impact "long_term_advice" items. No more, no less.
    Return ONLY raw JSON.
    `;

    const text = await generateWithCascade(prompt, 'deep_pattern_analysis', 'gemini-2.5-pro');
    return JSON.parse(cleanJSON(text)) as DeepPatternResult;
}

export async function generateComparativeAnalysis(
    currentSet: string, 
    previousSet: string | null, 
    scope: 'weekly' | 'monthly' | 'all-time'
): Promise<ComparativeAnalysisResult> {
    
    let promptContext = "";

    if (scope === 'all-time') {
        promptContext = `
        Perform a holistic review of this entire journal history.
        Identify long-term patterns and the overall arc of recovery.
        
        JOURNAL DATA:
        ${currentSet}
        `;
    } else {
        promptContext = `
        Perform a Comparative Review between two time periods (${scope}).
        Compare the "Current Period" against the "Previous Period" to identify trajectory.

        CURRENT PERIOD:
        ${currentSet}

        PREVIOUS PERIOD:
        ${previousSet || "No data available for previous period."}
        `;
    }

    const systemPrompt = `
    You are a wise and empathetic Recovery Coach specialized in pattern recognition.
    Analyze the provided journal entries and return a JSON object with this EXACT structure:
    {
        "trajectory": "Improving" | "Stable" | "Declining" | "Fluctuating",
        "key_themes": ["Theme 1", "Theme 2", "Theme 3"],
        "comparison_summary": "A 2-3 sentence narrative comparing the periods (or summarizing the journey).",
        "wins": ["Specific win 1", "Specific win 2"],
        "blind_spots": ["Potential risk or overlooked area 1", "Area 2"],
        "actionable_advice": ["Step 1", "Step 2", "Step 3"]
    }
    IMPORTANT: Provide EXACTLY 3 distinct "actionable_advice" items. No more, no less.
    DO NOT use Markdown formatting. Return ONLY the raw JSON string.
    `;

    const text = await generateWithCascade(systemPrompt + promptContext, `comparative_analysis_${scope}`);
    return JSON.parse(cleanJSON(text)) as ComparativeAnalysisResult;
}

export async function generateJournalAnalysis(content: string): Promise<AIAnalysisResult> {
    const prompt = `
      You are a Recovery AI Assistant. Analyze the following journal entries for emotional tone, risks, and actionable steps.
      ENTRIES: ${content}
      Return a JSON object with this structure:
      {
        "sentiment": "Positive" | "Neutral" | "Negative",
        "moodScore": number (1-10 integer based on tone),
        "summary": "1 sentence summary of the user's state",
        "actionableSteps": ["Step 1", "Step 2", "Step 3"],
        "risks": ["Risk 1", "Risk 2"] (If none, return empty array)
      }
      IMPORTANT: "actionableSteps" must contain EXACTLY 3 items.
      Return ONLY raw JSON.
    `;
    
    const text = await generateWithCascade(prompt, 'journal_analysis');
    return JSON.parse(cleanJSON(text)) as AIAnalysisResult;
}

export async function analyzeFullWorkbook(
    workbookTitle: string, 
    qaPairs: { question: string; answer: string }[]
): Promise<WorkbookAnalysisResult> {
    
    const formattedContent = qaPairs.map(qa => `Q: ${qa.question}\nA: ${qa.answer}`).join('\n\n');

    const prompt = `
    Analyze the following responses from the user's "${workbookTitle}" workbook.
    Act as a compassionate but insightful Recovery Sponsor.
    
    USER RESPONSES:
    ${formattedContent}

    Generate a JSON object with this EXACT structure:
    {
        "scope_context": "A short label for this analysis (e.g., 'Step 4 Review')",
        "summary": "A paragraph summarizing their understanding of this step/topic.",
        "pillars": {
            "understanding": "Analysis of their cognitive grasp of the concept.",
            "emotional_resonance": "Current emotional state (e.g. Resentful, Accepting).",
            "blind_spots": "Potential risks or overlooked areas."
        },
        "suggested_actions": ["Action 1", "Action 2", "Action 3"]
    }
    IMPORTANT: "suggested_actions" must contain EXACTLY 3 items.
    Return ONLY raw JSON.
    `;

    const text = await generateWithCascade(prompt, 'workbook_analysis', 'gemini-2.5-pro');
    return JSON.parse(cleanJSON(text)) as WorkbookAnalysisResult;
}

// Alias for backward compatibility
export const analyzeWorkbookContent = analyzeFullWorkbook;

export async function getGeminiCoaching(
    context: string, 
    userAnswer: string
): Promise<string> {
    const prompt = `
    Context: The user is working on a recovery workbook. 
    Question Context: ${context}
    User's Answer: "${userAnswer}"
    Provide a brief, encouraging, and insightful comment (max 2 sentences). 
    `;
    
    return await generateWithCascade(prompt, 'workbook_coach');
}
--- END_FILE: src/lib/gemini.ts ---

--- START_FILE: src/lib/googleDrive.ts ---
/**
 * GITHUB COMMENT:
 * [googleDrive.ts]
 * NEW: Lightweight Google Drive REST API wrapper.
 * - Handles file search, creation, and multipart updates.
 * - Uses 'drive.file' scope for least-privilege security.
 */
const GOOGLE_DRIVE_API_BASE = 'https://www.googleapis.com/drive/v3';
const GOOGLE_DRIVE_UPLOAD_BASE = 'https://www.googleapis.com/upload/drive/v3';

interface DriveFile {
  id: string;
  name: string;
}

export async function findBackupFile(accessToken: string): Promise<string | null> {
  const query = encodeURIComponent("name = 'mrt_backup.json' and trashed = false");
  const response = await fetch(`${GOOGLE_DRIVE_API_BASE}/files?q=${query}`, {
    headers: { Authorization: `Bearer ${accessToken}` },
  });

  if (!response.ok) return null;
  const data = (await response.json()) as { files: DriveFile[] };
  return data.files.length > 0 ? data.files[0].id : null;
}

export async function uploadBackupToDrive(accessToken: string, jsonData: string, fileId?: string): Promise<boolean> {
  const metadata = {
    name: 'mrt_backup.json',
    mimeType: 'application/json',
  };

  const boundary = 'mrt_backup_boundary';
  const delimiter = `\r\n--${boundary}\r\n`;
  const closeDelimiter = `\r\n--${boundary}--`;

  const body = 
    `${delimiter}Content-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}` +
    `${delimiter}Content-Type: application/json\r\n\r\n${jsonData}${closeDelimiter}`;

  const url = fileId 
    ? `${GOOGLE_DRIVE_UPLOAD_BASE}/files/${fileId}?uploadType=multipart`
    : `${GOOGLE_DRIVE_UPLOAD_BASE}/files?uploadType=multipart`;

  const method = fileId ? 'PATCH' : 'POST';

  const response = await fetch(url, {
    method,
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': `multipart/related; boundary=${boundary}`,
    },
    body,
  });

  return response.ok;
}
--- END_FILE: src/lib/googleDrive.ts ---

--- START_FILE: src/lib/grouping.ts ---
import { format, isToday, isYesterday, isSameYear, parseISO } from 'date-fns';
import { Timestamp } from 'firebase/firestore';

// FIX: Removed '[key: string]: unknown' to allow specific interfaces like JournalEntry to be passed without error.
interface TimeStampedItem {
  createdAt: Timestamp | Date | string | number;
}

/**
 * Groups a list of items by human-readable date headings.
 * Returns an object where keys are headers (e.g. "Today", "Yesterday")
 * and values are arrays of items.
 */
export function groupItemsByDate<T extends TimeStampedItem>(items: T[]): Record<string, T[]> {
  const groups: Record<string, T[]> = {};

  items.forEach((item) => {
    let date: Date;

    // Normalize Date
    if (item.createdAt instanceof Timestamp) {
      date = item.createdAt.toDate();
    } else if (item.createdAt instanceof Date) {
      date = item.createdAt;
    } else if (typeof item.createdAt === 'string') {
      date = parseISO(item.createdAt);
    } else {
      date = new Date(item.createdAt);
    }

    let header: string;

    if (isToday(date)) {
      header = 'Today';
    } else if (isYesterday(date)) {
      header = 'Yesterday';
    } else if (isSameYear(date, new Date())) {
      header = format(date, 'MMMM d'); // e.g. "October 12"
    } else {
      header = format(date, 'MMMM d, yyyy'); // e.g. "October 12, 2024"
    }

    if (!groups[header]) {
      groups[header] = [];
    }
    groups[header].push(item);
  });

  return groups;
}
--- END_FILE: src/lib/grouping.ts ---

--- START_FILE: src/lib/importer.ts ---
/**
 * GITHUB COMMENT:
 * [importer.ts]
 * UPDATED: Strictly typed IncomingEntry to handle both legacy and full-backup formats.
 * Added support for isEncrypted: false flag to ensure re-imported data is prepared for the new vault key.
 */
import { collection, doc, writeBatch, Timestamp } from 'firebase/firestore';
import { db } from './firebase';

export interface NewJournalEntry {
  uid: string;
  content: string;
  moodScore: number;
  sentiment: string;
  weather: { temp: number; condition: string } | null;
  createdAt: Timestamp;
  tags: string[];
  isEncrypted: boolean;
}

interface WeatherObject {
  temp: number;
  condition: string;
}

interface IncomingEntry {
  text?: string;
  mood?: number;
  timestamp?: string;
  content?: string;
  moodScore?: number;
  sentiment?: string;
  createdAt?: string | { seconds: number; nanoseconds: number };
  weather?: string | WeatherObject | null;
  tags?: string[];
}

const parseWeather = (weatherData: string | WeatherObject | null | undefined): { temp: number; condition: string } | null => {
  if (!weatherData) return null;
  if (typeof weatherData === 'string') {
    const match = weatherData.match(/^(.*),\s*(-?\d+)¬∞C$/);
    if (match) return { condition: match[1].trim(), temp: parseInt(match[2], 10) };
    return { condition: weatherData, temp: 0 };
  }
  if (typeof weatherData === 'object' && 'temp' in weatherData) {
    return weatherData as { temp: number; condition: string };
  }
  return null;
};

const mapEntry = (uid: string, entry: IncomingEntry): NewJournalEntry => {
  const mood = entry.moodScore ?? entry.mood ?? 5;
  const clampedMood = Math.max(1, Math.min(10, mood));

  let dateVal = new Date();
  if (entry.createdAt) {
    if (typeof entry.createdAt === 'string') {
      dateVal = new Date(entry.createdAt);
    } else if (typeof entry.createdAt === 'object' && 'seconds' in entry.createdAt) {
      dateVal = new Date(entry.createdAt.seconds * 1000);
    }
  } else if (entry.timestamp) {
    dateVal = new Date(entry.timestamp);
  }

  return {
    uid,
    content: entry.content || entry.text || "",
    moodScore: clampedMood,
    sentiment: entry.sentiment || 'Neutral',
    weather: parseWeather(entry.weather),
    createdAt: Timestamp.fromDate(dateVal),
    tags: Array.isArray(entry.tags) ? entry.tags : [],
    isEncrypted: false
  };
};

export async function importLegacyJournals(uid: string, file: File): Promise<{ success: number; errors: number }> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        if (!db) {
          reject(new Error("Firestore database is not initialized"));
          return;
        }

        const text = e.target?.result as string;
        const json = JSON.parse(text) as Record<string, unknown> | IncomingEntry[];

        let rawEntries: IncomingEntry[] = [];
        if (Array.isArray(json)) {
          rawEntries = json as IncomingEntry[];
        } else if (json && typeof json === 'object' && 'journals' in json && Array.isArray(json.journals)) {
          rawEntries = json.journals as IncomingEntry[];
        } else if (json) {
          rawEntries = [json as IncomingEntry];
        }

        if (rawEntries.length === 0) {
          resolve({ success: 0, errors: 0 });
          return;
        }

        let batch = writeBatch(db);
        let operationCount = 0;
        let successCount = 0;
        let errorCount = 0;

        for (const raw of rawEntries) {
          try {
            if (!raw.content && !raw.text) continue;
            const mappedData = mapEntry(uid, raw);
            const newDocRef = doc(collection(db, 'journals'));
            batch.set(newDocRef, mappedData);
            operationCount++;
            successCount++;

            if (operationCount >= 450) {
              await batch.commit();
              batch = writeBatch(db);
              operationCount = 0;
            }
          } catch (err) {
            console.error("Skipping invalid entry:", err);
            errorCount++;
          }
        }

        if (operationCount > 0) {
          await batch.commit();
        }

        resolve({ success: successCount, errors: errorCount });
      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = (error) => reject(error);
    reader.readAsText(file);
  });
}
--- END_FILE: src/lib/importer.ts ---

--- START_FILE: src/lib/insights.ts ---
/**
 * src/lib/insights.ts
 * GITHUB COMMENT:
 * [insights.ts]
 * UPDATED: Added 'strengths' field to InsightPayload to support Weekly/Monthly wins.
 */
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import type { AnalysisResult, WorkbookAnalysisResult } from "./gemini";

const COLLECTION = 'insights';

// --- DEFINITIONS ---

export type InsightType = 'journal' | 'workbook';

// Combined type for what we save to Firestore
export type InsightPayload = 
  | ({ type: 'journal'; strengths?: string[] } & AnalysisResult)
  | ({ type: 'workbook' } & WorkbookAnalysisResult);

// The hydrated object returned to the UI
export type SavedInsight = InsightPayload & {
  id: string;
  uid: string;
  createdAt: Date;
};

/**
 * Saves a new AI Insight to Firestore.
 */
export async function saveInsight(uid: string, payload: InsightPayload) {
  if (!db) throw new Error("Database not initialized");

  await addDoc(collection(db, COLLECTION), {
    uid,
    createdAt: Timestamp.now(),
    ...payload
  });
}

/**
 * Fetches the history of AI Insights for a user.
 */
export async function getInsightHistory(uid: string): Promise<SavedInsight[]> {
  if (!db) throw new Error("Database not initialized");

  try {
    const q = query(
      collection(db, COLLECTION),
      where("uid", "==", uid),
      orderBy("createdAt", "desc")
    );

    const snapshot = await getDocs(q);
    
    return snapshot.docs.map(doc => {
      const data = doc.data();
      const type = data.type || 'journal';

      return {
        ...data, 
        id: doc.id,
        uid: data.uid,
        type,
        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(),
      } as SavedInsight;
    });

  } catch (e: unknown) {
    console.error("Error fetching insights:", e);
    const err = e as { message?: string };
    if (err.message && err.message.includes("index")) {
        console.warn("‚ö†Ô∏è MISSING INDEX: Open your browser console and click the Firebase link to create the index for 'insights'.");
    }
    return [];
  }
}
--- END_FILE: src/lib/insights.ts ---

--- START_FILE: src/lib/journal.ts ---
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp,
  deleteDoc,
  doc,
  updateDoc // <--- Added this
} from "firebase/firestore";
import { db } from "./firebase";
import type { WeatherData } from "./weather";

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  tags: string[];
  moodScore: number;
  weather?: WeatherData | null;
  createdAt: Date;
}

const COLLECTION = 'journals';

// 1. CREATE
export async function addJournalEntry(
  uid: string, 
  content: string, 
  moodScore: number, 
  tags: string[],
  weather: WeatherData | null
) {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, COLLECTION), {
    uid,
    content,
    tags,
    moodScore,
    weather: weather || null, 
    createdAt: Timestamp.now()
  });
}

// 2. READ
export async function getUserJournals(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt.toDate()
  })) as JournalEntry[];
}

// 3. UPDATE (New)
export async function updateJournalEntry(
  id: string,
  content: string, 
  moodScore: number, 
  tags: string[]
) {
  if (!db) throw new Error("Database not initialized");
  const docRef = doc(db, COLLECTION, id);
  await updateDoc(docRef, {
    content,
    moodScore,
    tags,
    // We do NOT update createdAt or weather, as those are historical facts
  });
}

// 4. DELETE
export async function deleteJournalEntry(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}
--- END_FILE: src/lib/journal.ts ---

--- START_FILE: src/lib/tasks.ts ---
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  doc, 
  updateDoc,
  deleteDoc, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { startOfDay, isBefore, addDays, addWeeks, addMonths, isSameDay } from "date-fns";

export type Frequency = 'once' | 'daily' | 'weekly' | 'monthly';
export type Priority = 'High' | 'Medium' | 'Low';

export interface Task {
  id?: string;
  uid: string;
  title: string;
  isRecurring: boolean;
  frequency: Frequency;
  priority: Priority; // ADDED
  currentStreak: number;
  lastCompletedAt: Date | null;
  dueDate: Date;
  createdAt: Date;
}

const COLLECTION = 'tasks';

// 1. CREATE
export async function addTask(
  uid: string, 
  title: string, 
  frequency: Frequency, 
  priority: Priority, // ADDED
  startDate: Date // ADDED for Approach 3
) {
  if (!db) throw new Error("Database not initialized");
  
  const isRecurring = frequency !== 'once';
  // Ensure date is start of day to avoid time zone drift
  const due = startOfDay(startDate);

  await addDoc(collection(db, COLLECTION), {
    uid,
    title,
    isRecurring,
    frequency,
    priority,
    currentStreak: 0,
    lastCompletedAt: null,
    dueDate: Timestamp.fromDate(due),
    createdAt: Timestamp.now()
  });
}

// 2. READ & LAZY EVALUATE STREAKS
export async function getUserTasks(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid)
  );

  const snapshot = await getDocs(q);
  const tasks: Task[] = [];
  const today = startOfDay(new Date());

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    // Safely convert Timestamps to Dates
    const task = { 
      id: docSnap.id, 
      ...data,
      dueDate: data.dueDate?.toDate(),
      lastCompletedAt: data.lastCompletedAt?.toDate(),
      createdAt: data.createdAt?.toDate()
    } as Task;

    // --- LAZY EVALUATION LOGIC (Preserved from your code) ---
    // If it's recurring, overdue, and NOT completed today:
    if (task.isRecurring && isBefore(task.dueDate, today)) {
        
        const completedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
        
        if (!completedToday) {
            let newStreak = task.currentStreak;
            
            // Punishment Logic
            if (newStreak > 0) {
                newStreak = 0; // Break positive streak
            } else {
                newStreak -= 1; // Deepen negative streak
            }

            // Reset due date to Today so they can get back on track (Smart Reset)
            const taskRef = doc(db, COLLECTION, task.id!);
            await updateDoc(taskRef, {
                currentStreak: newStreak,
                dueDate: Timestamp.fromDate(today)
            });

            task.currentStreak = newStreak;
            task.dueDate = today;
        }
    }

    tasks.push(task);
  }

  return tasks;
}

// 3. TOGGLE COMPLETION
export async function toggleTask(task: Task, isCompleted: boolean) {
  if (!db) throw new Error("Database not initialized");
  const taskRef = doc(db, COLLECTION, task.id!);
  const today = startOfDay(new Date());

  if (isCompleted) {
    // MARKING DONE
    let newStreak = task.currentStreak;
    if (newStreak < 0) {
        newStreak = 1; // Bounce back from negative
    } else {
        newStreak += 1;
    }

    // Calculate next due date (Smart Reset Approach)
    // We calculate from TODAY, ensuring users don't get stuck in the past
    let nextDue = task.dueDate;
    if (task.frequency === 'daily') nextDue = addDays(today, 1);
    else if (task.frequency === 'weekly') nextDue = addWeeks(today, 1);
    else if (task.frequency === 'monthly') nextDue = addMonths(today, 1);
    
    // If 'once', we don't change the due date, it just gets marked done.

    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: Timestamp.fromDate(new Date()),
        // Only update due date if recurring
        ...(task.isRecurring && { dueDate: Timestamp.fromDate(nextDue) })
    });

  } else {
    // UNCHECKING (Undo)
    const newStreak = task.currentStreak > 0 ? task.currentStreak - 1 : task.currentStreak;
    
    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: null,
        // If unchecking, we usually want to reset the due date to "Today" or the original due date.
        // For simplicity in recovery, if you uncheck it, it becomes due today.
        dueDate: Timestamp.fromDate(today)
    });
  }
}

// 4. DELETE
export async function deleteTask(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

// 5. GET COMPLETED TODAY
export async function getCompletedTasksForToday(uid: string) {
    if (!db) throw new Error("Database not initialized");
    const today = startOfDay(new Date());
    const allTasks = await getUserTasks(uid);
    
    return allTasks.filter(t => 
        t.lastCompletedAt && isSameDay(t.lastCompletedAt, today)
    );
}
--- END_FILE: src/lib/tasks.ts ---

--- START_FILE: src/lib/theme.ts ---
export const THEME = {
  dashboard: {
    page: 'bg-slate-200', // High contrast cool grey
    header: {
      from: 'from-sky-500',
      via: 'via-blue-600',
      to: 'to-indigo-600'
    }
  },
  journal: {
    page: 'bg-indigo-200', // Rich lavender
    header: {
      from: 'from-indigo-600',
      via: 'via-purple-600',
      to: 'to-violet-600'
    }
  },
  tasks: {
    page: 'bg-cyan-200', // Electric mint
    header: {
      from: 'from-cyan-500',
      via: 'via-teal-500',
      to: 'to-emerald-500'
    },
    ring: '#34d399' // Emerald-400
  },
  workbooks: {
    page: 'bg-emerald-200', // Deep herbal green
    header: {
      from: 'from-emerald-600',
      via: 'via-green-600',
      to: 'to-lime-600'
    },
    ring: '#a3e635' // Lime-400
  },
  insights: {
    page: 'bg-fuchsia-200', // Bold pink mist
    header: {
      from: 'from-fuchsia-600',
      via: 'via-pink-600',
      to: 'to-rose-500'
    }
  },
  vitality: {
    page: 'bg-orange-200', // Warm apricot
    header: {
      from: 'from-rose-500',
      via: 'via-orange-500',
      to: 'to-amber-500'
    },
    ring: '#fbbf24' // Amber-400
  },
  profile: {
    page: 'bg-zinc-300', // Deep metallic grey
    header: {
      from: 'from-slate-700',
      via: 'via-gray-800',
      to: 'to-zinc-900'
    }
  }
} as const;
--- END_FILE: src/lib/theme.ts ---

--- START_FILE: src/lib/utils.ts ---
// src/lib/utils.ts

/**
 * Processes an array of items in chunks to prevent blocking the main thread.
 * Useful for CPU-intensive tasks like decryption or formatting large datasets.
 * * @param items - The array of data to process.
 * @param chunkSize - How many items to process per tick (e.g., 10).
 * @param processor - The async function to run on each item.
 * @param onProgress - Optional callback for percentage updates (0-100).
 */
export async function processInChunks<T, R>(
  items: T[],
  chunkSize: number,
  processor: (item: T) => Promise<R>,
  onProgress?: (progress: number) => void
): Promise<R[]> {
  const results: R[] = [];
  let processed = 0;

  for (let i = 0; i < items.length; i += chunkSize) {
    const chunk = items.slice(i, i + chunkSize);
    
    // Process chunk in parallel
    const chunkResults = await Promise.all(chunk.map(processor));
    results.push(...chunkResults);
    
    processed += chunk.length;
    if (onProgress) {
      onProgress(Math.round((processed / items.length) * 100));
    }
    
    // Yield to main thread to allow UI updates
    await new Promise(resolve => setTimeout(resolve, 0));
  }

  return results;
}
--- END_FILE: src/lib/utils.ts ---

--- START_FILE: src/lib/versioning.ts ---
// src/lib/versioning.ts
import buildInfoRaw from '../build-info.json';

export interface BuildMeta {
    env: 'DEV' | 'UAT' | 'PRODUCTION';
    branch: string;
    globalHash: string;
    coreHash: string;
    buildTime: string;
}

export interface PageVersion {
    hash: string;
    lastModified: string;
}

export interface BuildManifest {
    meta: BuildMeta;
    pages: Record<string, PageVersion>;
}

// Type-cast the raw JSON to our interface
const buildInfo = buildInfoRaw as unknown as BuildManifest;

/**
 * Returns the global build metadata (Env, Git Hash, Time).
 */
export function useBuildInfo(): BuildMeta {
    return buildInfo.meta;
}

/**
 * Returns the version hash for a specific page.
 * Useful for debugging if a specific page code is stale.
 * @param pageName - The filename of the page (e.g., 'Dashboard', 'Login')
 */
export function usePageVersion(pageName: string): string {
    const page = buildInfo.pages[pageName];
    if (!page) return 'unknown';
    // Return a composite of Global-Page hash
    return `${buildInfo.meta.globalHash}-${page.hash}`;
}

/**
 * Returns a color code based on the environment.
 */
export function getEnvColor(env: string): string {
    switch (env) {
        case 'PRODUCTION': return 'bg-red-600'; // High alert
        case 'UAT': return 'bg-orange-500';
        default: return 'bg-blue-600'; // Dev
    }
}
--- END_FILE: src/lib/versioning.ts ---

--- START_FILE: src/lib/weather.ts ---
// Maps WMO Weather Codes to human readable text
function getWeatherCondition(code: number): string {
  if (code === 0) return 'Clear sky';
  if (code >= 1 && code <= 3) return 'Partly cloudy';
  if (code >= 45 && code <= 48) return 'Foggy';
  if (code >= 51 && code <= 55) return 'Drizzle';
  if (code >= 61 && code <= 65) return 'Rain';
  if (code >= 71 && code <= 77) return 'Snow';
  if (code >= 95 && code <= 99) return 'Thunderstorm';
  return 'Unknown';
}

export interface WeatherData {
  temp: number;
  condition: string;
  location: string; // We'll just store "Lat/Lon" or a generic name for now
}

export async function getCurrentWeather(): Promise<WeatherData | null> {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported");
    return null;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          
          // Using Open-Meteo (Free, No Key Required)
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius`
          );
          
          if (!response.ok) throw new Error("Weather API failed");
          
          const data = await response.json();
          const weather = data.current_weather;

          resolve({
            temp: weather.temperature,
            condition: getWeatherCondition(weather.weathercode),
            location: 'Local' // We could use a reverse geocoding API here later if needed
          });
        } catch (error) {
          console.error("Error fetching weather:", error);
          resolve(null);
        }
      },
      (error) => {
        console.warn("Location permission denied or failed", error);
        resolve(null);
      }
    );
  });
}
--- END_FILE: src/lib/weather.ts ---

--- START_FILE: src/lib/workbooks.ts ---
// src/lib/workbooks.ts

export interface Question {
  id: string;
  text: string;
  helperText?: string;
}

export interface Section {
  id: string;
  title: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  sections: Section[];
  estimatedTime?: string;
}

// DATA: You can expand this or move to Firestore later
const WORKBOOKS: Workbook[] = [
  {
    id: "step1",
    title: "Step 1: Honesty",
    description: "We admitted we were powerless over our addiction - that our lives had become unmanageable.",
    estimatedTime: "45 mins",
    sections: [
        {
            id: "s1_physical",
            title: "Physical Allergy",
            questions: [
                { id: "q1", text: "Describe the last time you tried to control your using. What happened?", helperText: "Focus on the physical sensation of craving." },
                { id: "q2", text: "Have you ever tried to stop and found you couldn't stay stopped?", helperText: "List specific dates or attempts." }
            ]
        },
        {
            id: "s1_unmanageability",
            title: "Unmanageability",
            questions: [
                { id: "q3", text: "How has your addiction affected your financial situation?", helperText: "Be specific about debts or lost opportunities." },
                { id: "q4", text: "How has your addiction affected your personal relationships?", helperText: "Think about trust, reliability, and presence." }
            ]
        }
    ]
  },
  {
      id: "cbt_foundations",
      title: "CBT: Thought Records",
      description: "Learn to catch, check, and change negative thought patterns.",
      estimatedTime: "20 mins",
      sections: [
          {
              id: "cbt_catch",
              title: "Catching the Thought",
              questions: [
                  { id: "q1", text: "What was the situation?", helperText: "Who, what, where, when." },
                  { id: "q2", text: "What was the automatic negative thought?", helperText: "I am worthless, This will never work, etc." }
              ]
          }
      ]
  }
];

export async function getWorkbookById(id: string): Promise<Workbook | undefined> {
  // Simulate network delay for realism
  await new Promise(resolve => setTimeout(resolve, 50));
  return WORKBOOKS.find(wb => wb.id === id);
}

export async function getAllWorkbooks(): Promise<Workbook[]> {
    await new Promise(resolve => setTimeout(resolve, 50));
    return WORKBOOKS;
}
--- END_FILE: src/lib/workbooks.ts ---

--- START_FILE: src/main.tsx ---
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import ErrorBoundary from './components/ErrorBoundary' // IMPORTED
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary>
        <App />
    </ErrorBoundary>
  </React.StrictMode>,
)
--- END_FILE: src/main.tsx ---

--- START_FILE: src/pages/AdminDashboard.tsx ---
/**
 * src/pages/AdminDashboard.tsx
 * GITHUB COMMENT:
 * [AdminDashboard.tsx]
 * REFACTOR: Decomposed into atomic components (AnalyticsCharts, DeduplicationTool, SchemaMigration).
 * UPDATE: Implemented Phase 1 maintenance tools.
 */
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { 
  collection, 
  query, 
  getDocs, 
  orderBy,
  limit,
} from 'firebase/firestore';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
  CommandLineIcon, 
  ShieldCheckIcon, 
  UserGroupIcon, 
  CpuChipIcon,
  ServerIcon,
  WrenchScrewdriverIcon
} from '@heroicons/react/24/outline';
import { Navigate } from 'react-router-dom';

// Sub-components
import UserDirectory from '../components/admin/UserDirectory';
import ErrorLogViewer from '../components/admin/ErrorLogViewer';
import AnalyticsCharts, { type AIUsageLog } from '../components/admin/AnalyticsCharts';
import DeduplicationTool from '../components/admin/DeduplicationTool';
import SchemaMigration from '../components/admin/SchemaMigration';

export default function AdminDashboard() {
  const { user, isAdmin } = useAuth();
  const [activeTab, setActiveTab] = useState<'analytics' | 'users' | 'health' | 'maintenance'>('analytics');
  
  // Analytics Data State
  const [logs, setLogs] = useState<AIUsageLog[]>([]);
  const [metricsLoading, setMetricsLoading] = useState(true);

  // --- 1. AUTH CHECK & INITIAL LOAD ---
  useEffect(() => {
      if (isAdmin && user && db) {
          loadAnalytics();
      }
  }, [isAdmin, user]);

  if (!isAdmin) {
    return <Navigate to="/dashboard" />;
  }

  // --- 2. DATA FETCHING (ANALYTICS) ---
  const loadAnalytics = async () => {
      if (!db) return;
      try {
          const q = query(
              collection(db, 'ai_logs'), 
              orderBy('timestamp', 'desc'), 
              limit(100)
          );
          const snap = await getDocs(q);
          // Cast with proper Timestamp handling (handled in component via .toDate check)
          const data = snap.docs.map(d => ({ id: d.id, ...d.data() } as AIUsageLog));
          setLogs(data);
      } catch (e) {
          console.error("Failed to load analytics", e);
      } finally {
          setMetricsLoading(false);
      }
  };

  return (
    <div className={`h-[100dvh] flex flex-col ${THEME.profile.page}`}>
      <VibrantHeader 
        title="Admin Tools"
        subtitle="Operational governance and system telemetry."
        icon={CommandLineIcon}
        fromColor="from-slate-800"
        viaColor="via-gray-900"
        toColor="to-black"
      />

      {/* --- TAB NAVIGATION --- */}
      <div className="px-4 -mt-10 relative z-30">
        <div className="bg-white p-1 rounded-xl shadow-lg border border-gray-200 flex flex-wrap max-w-2xl mx-auto">
            <button 
                onClick={() => setActiveTab('analytics')}
                className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-xs font-bold rounded-lg transition-all ${activeTab === 'analytics' ? 'bg-slate-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
            >
                <CpuChipIcon className="h-4 w-4" /> Analytics
            </button>
            <button 
                onClick={() => setActiveTab('users')}
                className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-xs font-bold rounded-lg transition-all ${activeTab === 'users' ? 'bg-slate-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
            >
                <UserGroupIcon className="h-4 w-4" /> Users
            </button>
            <button 
                onClick={() => setActiveTab('health')}
                className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-xs font-bold rounded-lg transition-all ${activeTab === 'health' ? 'bg-slate-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
            >
                <ServerIcon className="h-4 w-4" /> Health
            </button>
            <button 
                onClick={() => setActiveTab('maintenance')}
                className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-xs font-bold rounded-lg transition-all ${activeTab === 'maintenance' ? 'bg-slate-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
            >
                <WrenchScrewdriverIcon className="h-4 w-4" /> Tools
            </button>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto px-4 py-8 space-y-8 max-w-5xl mx-auto w-full animate-fadeIn">
        
        {/* --- TAB 1: ANALYTICS --- */}
        {activeTab === 'analytics' && (
            <section className="space-y-4">
                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <CpuChipIcon className="h-6 w-6 text-purple-600" /> Gemini API Metrics
                </h2>
                {metricsLoading ? (
                    <div className="p-10 text-center text-gray-400">Loading metrics...</div>
                ) : (
                    <AnalyticsCharts logs={logs} />
                )}
            </section>
        )}

        {/* --- TAB 2: USERS --- */}
        {activeTab === 'users' && <UserDirectory />}

        {/* --- TAB 3: HEALTH --- */}
        {activeTab === 'health' && <ErrorLogViewer />}

        {/* --- TAB 4: MAINTENANCE --- */}
        {activeTab === 'maintenance' && user && (
            <div className="space-y-6">
                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <WrenchScrewdriverIcon className="h-6 w-6 text-orange-600" /> Data Maintenance
                </h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Tool 1: Deduplication */}
                    <DeduplicationTool uid={user.uid} />

                    {/* Tool 2: Schema Migration */}
                    <SchemaMigration uid={user.uid} />

                    {/* Tool 3: Encryption Audit (Placeholder) */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 opacity-50">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-blue-50 rounded-lg text-blue-600">
                                <ShieldCheckIcon className="h-6 w-6" />
                            </div>
                            <h3 className="font-bold text-gray-900">Security Audit</h3>
                        </div>
                        <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                            Identifies unencrypted entries in the cloud that need re-saving to be secured by your new PIN.
                        </p>
                        <button disabled className="w-full py-3 bg-gray-100 text-gray-400 font-bold rounded-xl cursor-not-allowed">
                            Coming Soon
                        </button>
                    </div>

                    {/* Tool 4: Team Management (Placeholder) */}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 opacity-50">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-purple-50 rounded-lg text-purple-600">
                                <UserGroupIcon className="h-6 w-6" />
                            </div>
                            <h3 className="font-bold text-gray-900">Manage Admins</h3>
                        </div>
                        <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                            Grant developer access to other emails to help troubleshoot data issues.
                        </p>
                        <button disabled className="w-full py-3 bg-gray-100 text-gray-400 font-bold rounded-xl cursor-not-allowed">
                            Coming Soon
                        </button>
                    </div>
                </div>
            </div>
        )}

      </div>
    </div>
  );
}
--- END_FILE: src/pages/AdminDashboard.tsx ---

--- START_FILE: src/pages/Dashboard.tsx ---
/**
 * src/pages/Dashboard.tsx
 * GITHUB COMMENT:
 * [Dashboard.tsx]
 * FIX: Resolved impure function error by disabling strict purity check for Date.now().
 * REASON: We need the current time to calculate backup status; this is a valid use case.
 */
import { useMemo } from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { 
  collection, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  doc, 
  getDoc,
  Timestamp,
  type Firestore 
} from 'firebase/firestore';
import { useQuery } from '@tanstack/react-query';
import { 
  calculateJournalStats, 
  calculateTaskStats, 
  calculateWorkbookStats, 
  calculateVitalityStats, 
  calculateUserLevel
} from '../lib/gamification';
import VibrantHeader from '../components/VibrantHeader';
import { 
  HomeIcon, 
  FireIcon, 
  ChartBarIcon, 
  SparklesIcon, 
  HeartIcon, 
  ArrowDownTrayIcon,
  TrophyIcon
} from '@heroicons/react/24/outline';
import { THEME } from '../lib/theme';

const TOTAL_WORKBOOK_QUESTIONS = 45;

export default function Dashboard() {
  const { user } = useAuth();
  
  // --- QUERY 1: USER PROFILE ---
  const { data: userProfile, isLoading: profileLoading } = useQuery({
    queryKey: ['profile', user?.uid],
    queryFn: async () => {
        if (!user || !db) return null;
        const ref = doc(db, 'users', user.uid);
        const snap = await getDoc(ref);
        return snap.exists() ? snap.data() : null;
    },
    enabled: !!user,
  });

  // --- QUERY 2: JOURNALS ---
  const { data: journals = [], isLoading: journalLoading } = useQuery({
    queryKey: ['journals', user?.uid],
    queryFn: async () => {
        if (!user || !db) return [];
        const database: Firestore = db;
        const q = query(
            collection(database, 'journals'), 
            where('uid', '==', user.uid),
            orderBy('createdAt', 'desc')
        );
        const snap = await getDocs(q);
        // Cast dates for gamification calc
        return snap.docs.map(d => ({
            ...d.data(),
            createdAt: d.data().createdAt
        }));
    },
    enabled: !!user,
  });

  // --- QUERY 3: TASKS ---
  const { data: tasks = [], isLoading: taskLoading } = useQuery({
    queryKey: ['tasks', user?.uid],
    queryFn: async () => {
        if (!user || !db) return [];
        const database: Firestore = db;
        const q = query(collection(database, 'tasks'), where('uid', '==', user.uid));
        const snap = await getDocs(q);
        return snap.docs.map(d => d.data());
    },
    enabled: !!user,
  });

  // --- QUERY 4: WORKBOOKS ---
  const { data: workbookCount = 0, isLoading: workbookLoading } = useQuery({
    queryKey: ['workbooks', user?.uid],
    queryFn: async () => {
        if (!user || !db) return 0;
        const database: Firestore = db;
        const q = query(collection(database, 'users', user.uid, 'workbook_answers'));
        const snap = await getDocs(q);
        return snap.size;
    },
    enabled: !!user,
  });

  // --- CALCULATE STATS ---
  const stats = useMemo(() => {
    if (journalLoading || taskLoading || workbookLoading || profileLoading) return null;

    // Days Clean
    let daysClean = 0;
    if (userProfile?.sobrietyDate) {
        const start = userProfile.sobrietyDate.toDate ? userProfile.sobrietyDate.toDate() : new Date(userProfile.sobrietyDate);
        const diffTime = Math.abs(new Date().getTime() - start.getTime());
        daysClean = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // Gamification
    // Cast types to any for the calculator library to accept raw firestore data
    /* eslint-disable @typescript-eslint/no-explicit-any */
    const jStats = calculateJournalStats(journals as any);
    const tStats = calculateTaskStats(tasks as any);
    const wStats = calculateWorkbookStats(workbookCount, TOTAL_WORKBOOK_QUESTIONS);
    const vStats = calculateVitalityStats(journals as any);
    const level = calculateUserLevel(journals as any, tasks as any, workbookCount, daysClean);
    /* eslint-enable @typescript-eslint/no-explicit-any */

    const lastExport = userProfile?.lastExportAt as Timestamp | undefined;
    
    // eslint-disable-next-line react-hooks/purity
    const nowMs = Date.now(); 
    const showBackup = !lastExport || lastExport.toMillis() < nowMs - (7 * 24 * 60 * 60 * 1000);

    return {
        daysClean,
        journal: { streak: jStats.journalStreak, consistency: jStats.consistencyRate },
        task: { rate: tStats.completionRate, fire: tStats.habitFire },
        workbook: { wisdom: wStats.wisdomScore, completion: wStats.masterCompletion },
        vitality: { bioStreak: vStats.bioStreak, totalLogs: vStats.totalLogs },
        level,
        showBackup
    };
  }, [journals, tasks, workbookCount, userProfile, journalLoading, taskLoading, workbookLoading, profileLoading]);

  const loading = journalLoading || taskLoading || workbookLoading || profileLoading;

  if (loading || !stats) return <div className="p-8 text-center text-gray-500">Loading your recovery hub...</div>;

  return (
    <div className={`h-[100dvh] flex flex-col ${THEME.dashboard.page}`}>
      
      {/* 1. FIXED HEADER */}
      <div className="flex-shrink-0 z-10">
        <VibrantHeader 
            title="Dashboard" 
            subtitle={`Welcome back, ${user?.displayName?.split(' ')[0] || 'Friend'}`}
            icon={HomeIcon}
            fromColor={THEME.dashboard.header.from}
            viaColor={THEME.dashboard.header.via}
            toColor={THEME.dashboard.header.to}
        />
      </div>

      {/* 2. FLOATING XP BAR (The Rank Card) */}
      <div className="px-4 -mt-10 relative z-30 flex-shrink-0 animate-slideUp">
            <div className="bg-white rounded-3xl p-5 shadow-xl border border-white/50 backdrop-blur-sm relative overflow-hidden">
                <div className="absolute -top-10 -right-10 w-32 h-32 bg-indigo-100 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
                
                <div className="flex justify-between items-end mb-3 relative z-10">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <span className="text-[10px] font-black uppercase tracking-widest text-indigo-400 bg-indigo-50 px-2 py-0.5 rounded-full">Rank</span>
                            <span className="text-[10px] font-bold text-gray-400">Archetype: {stats.level.archetype}</span>
                        </div>
                        <h3 className="text-2xl font-black text-slate-800 leading-none">{stats.level.levelData.title}</h3>
                    </div>
                    <div className="text-right">
                        <div className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                            {stats.level.levelData.level}
                        </div>
                        <div className="text-[9px] font-bold text-gray-400 uppercase tracking-wide">Current Level</div>
                    </div>
                </div>
                
                <div className="relative h-4 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner">
                    <div 
                        className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]"
                        style={{ width: `${stats.level.levelData.progressPercent}%` }}
                    />
                    <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-slate-900/50 mix-blend-overlay">
                        {stats.level.levelData.currentXP} / {stats.level.levelData.nextLevelXP} XP
                    </div>
                </div>
            </div>
      </div>

      {/* 3. SCROLLABLE CONTENT (BENTO GRID) */}
      <div className="flex-1 overflow-y-auto px-4 pt-6 pb-24 space-y-6">
        
        {stats.showBackup && (
          <div className="bg-amber-50 border border-amber-200 rounded-2xl p-4 flex items-center justify-between shadow-sm animate-fadeIn">
            <div className="flex items-center gap-3">
              <div className="bg-amber-100 p-2 rounded-full text-amber-700">
                <ArrowDownTrayIcon className="h-5 w-5" />
              </div>
              <div className="text-xs text-amber-900">
                <strong>Backup Needed:</strong> It's been a week since your last save.
              </div>
            </div>
            <Link to="/profile" className="text-xs font-bold bg-amber-600 text-white px-3 py-1.5 rounded-lg hover:bg-amber-700">Go</Link>
          </div>
        )}

        {/* HERO CARD: Clean Time */}
        <div className="bg-gradient-to-br from-slate-800 to-slate-950 rounded-[2rem] p-8 text-center relative overflow-hidden shadow-xl border border-slate-700 group">
            <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
            <div className="absolute -top-20 -left-20 w-64 h-64 bg-blue-500/20 rounded-full blur-[80px]"></div>
            
            <div className="relative z-10">
                <div className="flex items-center justify-center gap-2 mb-2 opacity-60">
                    <TrophyIcon className="h-4 w-4 text-yellow-400" />
                    <span className="text-xs font-bold uppercase tracking-[0.2em] text-white">Freedom Count</span>
                </div>
                <div className="text-7xl font-black text-white tracking-tighter drop-shadow-2xl mb-1">
                    {stats.daysClean}
                </div>
                <div className="text-sm font-medium text-slate-400">Days of Sobriety</div>
            </div>
        </div>

        {/* 2x2 BENTO GRID */}
        <div className="grid grid-cols-2 gap-4">
            
            {/* 1. JOURNAL (Indigo/Violet) */}
            <Link to="/journal" className="relative overflow-hidden rounded-3xl p-5 bg-gradient-to-br from-indigo-500 to-violet-600 text-white shadow-lg shadow-indigo-200 transition-transform active:scale-95 hover:shadow-xl">
                <div className="absolute right-0 top-0 p-3 opacity-20 transform translate-x-2 -translate-y-2">
                    <ChartBarIcon className="h-16 w-16 rotate-12" />
                </div>
                <div className="relative z-10">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                            <ChartBarIcon className="h-5 w-5 text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-wider opacity-90">Journal</span>
                    </div>
                    <div className="text-3xl font-black mb-1">{stats.journal.streak}</div>
                    <div className="text-[10px] font-medium opacity-80 uppercase tracking-wide">Day Streak</div>
                    <div className="mt-4 pt-3 border-t border-white/20 flex items-center justify-between">
                        <span className="text-[10px] opacity-75">Consistency</span>
                        <span className="text-xs font-bold">{stats.journal.consistency}/wk</span>
                    </div>
                </div>
            </Link>

            {/* 2. HABITS (Cyan/Teal) */}
            <Link to="/tasks" className="relative overflow-hidden rounded-3xl p-5 bg-gradient-to-br from-cyan-500 to-teal-500 text-white shadow-lg shadow-cyan-200 transition-transform active:scale-95 hover:shadow-xl">
                <div className="absolute right-0 top-0 p-3 opacity-20 transform translate-x-2 -translate-y-2">
                    <FireIcon className="h-16 w-16 rotate-12" />
                </div>
                <div className="relative z-10">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                            <FireIcon className="h-5 w-5 text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-wider opacity-90">Quests</span>
                    </div>
                    <div className="text-3xl font-black mb-1">{stats.task.fire}</div>
                    <div className="text-[10px] font-medium opacity-80 uppercase tracking-wide">Quest Fire</div>
                    <div className="mt-4 pt-3 border-t border-white/20 flex items-center justify-between">
                        <span className="text-[10px] opacity-75">Rate</span>
                        <span className="text-xs font-bold">{stats.task.rate}%</span>
                    </div>
                </div>
            </Link>

            {/* 3. VITALITY (Orange/Rose) */}
            <Link to="/vitality" className="relative overflow-hidden rounded-3xl p-5 bg-gradient-to-br from-orange-400 to-rose-500 text-white shadow-lg shadow-orange-200 transition-transform active:scale-95 hover:shadow-xl">
                <div className="absolute right-0 top-0 p-3 opacity-20 transform translate-x-2 -translate-y-2">
                    <HeartIcon className="h-16 w-16 rotate-12" />
                </div>
                <div className="relative z-10">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                            <HeartIcon className="h-5 w-5 text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-wider opacity-90">Vitality</span>
                    </div>
                    <div className="text-3xl font-black mb-1">{stats.vitality.bioStreak}</div>
                    <div className="text-[10px] font-medium opacity-80 uppercase tracking-wide">Bio-Rhythm</div>
                    <div className="mt-4 pt-3 border-t border-white/20 flex items-center justify-between">
                        <span className="text-[10px] opacity-75">Total Logs</span>
                        <span className="text-xs font-bold">{stats.vitality.totalLogs}</span>
                    </div>
                </div>
            </Link>

            {/* 4. WISDOM (Emerald/Lime) */}
            <Link to="/workbooks" className="relative overflow-hidden rounded-3xl p-5 bg-gradient-to-br from-emerald-500 to-lime-600 text-white shadow-lg shadow-emerald-200 transition-transform active:scale-95 hover:shadow-xl">
                <div className="absolute right-0 top-0 p-3 opacity-20 transform translate-x-2 -translate-y-2">
                    <SparklesIcon className="h-16 w-16 rotate-12" />
                </div>
                <div className="relative z-10">
                    <div className="flex items-center gap-2 mb-4">
                        <div className="p-2 bg-white/20 backdrop-blur-sm rounded-xl">
                            <SparklesIcon className="h-5 w-5 text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-wider opacity-90">Wisdom</span>
                    </div>
                    <div className="text-3xl font-black mb-1">{stats.workbook.completion}%</div>
                    <div className="text-[10px] font-medium opacity-80 uppercase tracking-wide">Mastery</div>
                    <div className="mt-4 pt-3 border-t border-white/20 flex items-center justify-between">
                        <span className="text-[10px] opacity-75">Score</span>
                        <span className="text-xs font-bold">{stats.workbook.wisdom}</span>
                    </div>
                </div>
            </Link>

        </div>
      </div>
    </div>
  );
}
--- END_FILE: src/pages/Dashboard.tsx ---

--- START_FILE: src/pages/InsightsLog.tsx ---
/**
 * src/pages/InsightsLog.tsx
 * GITHUB COMMENT:
 * [InsightsLog.tsx]
 * FIX: Separated "Strengths" from "Suggested Actions".
 * FEATURE: Historical insights now have interactive "Add to Task" buttons.
 */
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getInsightHistory, type SavedInsight } from '../lib/insights';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { addTask } from '../lib/tasks';
import { addDays } from 'date-fns';
import { 
    LightBulbIcon, 
    SparklesIcon, 
    AcademicCapIcon, 
    BookOpenIcon, 
    ShieldExclamationIcon, 
    CheckCircleIcon, 
    TrophyIcon, 
    CalendarDaysIcon,
    PlusCircleIcon
} from '@heroicons/react/24/outline';

// Local interface
interface InsightWithActions {
    suggested_actions?: string[];
    actionableSteps?: string[];
    actionable_advice?: string[];
    strengths?: string[];
    risks?: string[];
    pillars?: {
        growth?: string;
        blind_spots?: string;
        understanding?: string;
        emotional_resonance?: string;
    };
}

// Helper to normalize actions
const getActions = (data: unknown): string[] => {
    const insight = data as InsightWithActions;
    if (insight.suggested_actions && Array.isArray(insight.suggested_actions)) return insight.suggested_actions;
    if (insight.actionableSteps && Array.isArray(insight.actionableSteps)) return insight.actionableSteps;
    if (insight.actionable_advice && Array.isArray(insight.actionable_advice)) return insight.actionable_advice;
    return [];
};

// Helper to normalize strengths/wins
const getStrengths = (data: unknown): string[] => {
    const insight = data as InsightWithActions;
    if (insight.strengths && Array.isArray(insight.strengths)) return insight.strengths;
    // Fallback to legacy pillar string if array is missing
    if (insight.pillars?.growth) return [insight.pillars.growth]; 
    return [];
};

// Helper to normalize risks
const getRisks = (data: unknown): string[] => {
    const insight = data as InsightWithActions;
    if (insight.risks && Array.isArray(insight.risks)) return insight.risks;
    // Fallback to legacy pillar string
    if (insight.pillars?.blind_spots) return [insight.pillars.blind_spots];
    return [];
};

export default function InsightsLog() {
    const { user } = useAuth();
    const [insights, setInsights] = useState<SavedInsight[]>([]);
    const [loading, setLoading] = useState(true);
    const [filter, setFilter] = useState<'all' | 'journal' | 'workbook'>('all');
    const [addedActions, setAddedActions] = useState<Set<string>>(new Set());

    const loadData = useCallback(async () => {
        if (!user) return;
        try {
            const data = await getInsightHistory(user.uid);
            setInsights(data);
        } catch (error) {
            console.error("Failed to load insights log", error);
        } finally {
            setLoading(false);
        }
    }, [user]);

    useEffect(() => {
        loadData();
    }, [loadData]);

    const handleAddToTasks = async (action: string) => {
        if (!user) return;
        try {
            const dueDate = addDays(new Date(), 7);
            await addTask(user.uid, action, 'once', 'Medium', dueDate);
            setAddedActions(prev => new Set(prev).add(action));
        } catch (e) {
            console.error("Failed to add task", e);
        }
    };

    const filteredInsights = insights.filter(item => filter === 'all' || item.type === filter);

    if (loading) return <div className="p-8 text-center text-gray-500">Loading wisdom archive...</div>;

    return (
        <div className={`pb-24 relative min-h-screen ${THEME.insights.page}`}>
            <VibrantHeader 
                title="Insights" 
                subtitle="A timeline of your AI coaching sessions and breakthroughs." 
                icon={LightBulbIcon} 
                fromColor={THEME.insights.header.from} 
                viaColor={THEME.insights.header.via} 
                toColor={THEME.insights.header.to} 
            />

            <div className="px-4 -mt-10 relative z-30">
                <div className="bg-white p-1.5 rounded-xl shadow-lg border border-fuchsia-200 flex max-w-md mx-auto">
                    {(['all', 'journal', 'workbook'] as const).map((tab) => (
                    <button
                        key={tab}
                        onClick={() => setFilter(tab)}
                        className={`flex-1 py-2.5 text-xs font-bold rounded-lg transition-all capitalize tracking-wide ${
                        filter === tab 
                            ? 'bg-gradient-to-br from-fuchsia-600 to-rose-600 text-white shadow-md transform scale-105' 
                            : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'
                        }`}
                    >
                        {tab}
                    </button>
                    ))}
                </div>
            </div>

            <div className="max-w-4xl mx-auto space-y-6 px-4 mt-6">
                {filteredInsights.length === 0 ? (
                    <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300 shadow-sm">
                        <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <SparklesIcon className="h-8 w-8 text-gray-400" />
                        </div>
                        <h3 className="text-lg font-bold text-gray-900">No Insights Yet</h3>
                        <p className="text-gray-500 text-sm mt-1">
                            Generate analysis from your Journal or Workbooks to populate this log.
                        </p>
                    </div>
                ) : (
                    filteredInsights.map((insight) => {
                        const actions = getActions(insight).slice(0, 3);
                        const strengths = getStrengths(insight);
                        const risks = getRisks(insight);

                        return (
                            <div key={insight.id} className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
                                
                                <div className="bg-gray-50/50 px-5 py-3 border-b border-gray-100 flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        {insight.type === 'journal' ? (
                                            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200">
                                                <BookOpenIcon className="h-3.5 w-3.5" /> Journal
                                            </span>
                                        ) : (
                                            <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200">
                                                <AcademicCapIcon className="h-3.5 w-3.5" /> Workbook
                                            </span>
                                        )}
                                        <span className="text-xs text-gray-400 flex items-center gap-1 font-medium">
                                            <CalendarDaysIcon className="h-3.5 w-3.5" />
                                            {insight.createdAt.toLocaleDateString()}
                                        </span>
                                    </div>
                                </div>

                                <div className="p-5">
                                    {insight.type === 'journal' && (
                                        <div className="space-y-5">
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-2">Daily Reflection</h3>
                                                <p className="text-gray-600 text-sm leading-relaxed">{insight.summary}</p>
                                            </div>
                                            <div className="flex flex-wrap gap-3 text-xs">
                                                <div className="bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 text-blue-700">
                                                    Mood: <span className="font-bold">{insight.moodScore}/10</span>
                                                </div>
                                                <div className="bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 text-indigo-700">
                                                    Sentiment: <span className="font-bold">{insight.sentiment}</span>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                    <div className="text-orange-800 font-bold text-xs uppercase mb-1.5 flex items-center gap-1">
                                                        <ShieldExclamationIcon className="h-4 w-4" /> Risk Analysis
                                                    </div>
                                                    <ul className="text-xs text-orange-900 leading-relaxed list-disc pl-4 space-y-1">
                                                        {risks.length > 0 ? risks.map((risk, idx) => <li key={idx}>{risk}</li>) : <li>None detected.</li>}
                                                    </ul>
                                                </div>
                                                
                                                <div className="bg-green-50 p-3 rounded-xl border border-green-100">
                                                    <div className="text-green-800 font-bold text-xs uppercase mb-1.5 flex items-center gap-1">
                                                        <TrophyIcon className="h-4 w-4" /> Strengths & Wins
                                                    </div>
                                                    <ul className="text-xs text-green-900 leading-relaxed list-disc pl-4 space-y-1">
                                                        {strengths.length > 0 ? strengths.map((s, idx) => <li key={idx}>{s}</li>) : <li>Keep moving forward.</li>}
                                                    </ul>
                                                </div>
                                            </div>

                                            {/* SEPARATED ACTION PLAN CARD */}
                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                                <div className="text-gray-500 font-bold text-xs uppercase mb-2 flex items-center gap-1">
                                                    <CheckCircleIcon className="h-4 w-4" /> Action Plan (Choose to Add)
                                                </div>
                                                <ul className="space-y-2">
                                                    {actions.map((step, idx) => (
                                                        <li key={idx} className="flex items-center justify-between gap-2 text-xs text-gray-700">
                                                            <div className="flex gap-2">
                                                                <span className="text-green-500 font-bold">‚Ä¢</span>
                                                                <span>{step}</span>
                                                            </div>
                                                            <button
                                                                onClick={() => !addedActions.has(step) && handleAddToTasks(step)}
                                                                disabled={addedActions.has(step)}
                                                                className={`p-1 rounded-full transition-all flex-shrink-0 ${addedActions.has(step) ? 'text-green-600 bg-green-200' : 'text-gray-400 hover:text-green-600 hover:bg-green-100'}`}
                                                                title="Add to Quests"
                                                            >
                                                                {addedActions.has(step) ? <CheckCircleIcon className="h-4 w-4" /> : <PlusCircleIcon className="h-4 w-4" />}
                                                            </button>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                    )}
                                    {insight.type === 'workbook' && (
                                        <div className="space-y-5">
                                            {/* ... Workbook logic remains similar (omitted for brevity unless requested) ... */}
                                            {/* Re-using same logic for workbook actions */}
                                            <div>
                                                <h3 className="text-lg font-bold text-purple-900 mb-1 flex items-center gap-2">{insight.scope_context}</h3>
                                                <p className="text-gray-600 text-sm leading-relaxed mt-2">{insight.summary}</p>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                <div className="bg-blue-50 p-3 rounded-xl border border-blue-100"><div className="text-blue-800 font-bold text-xs uppercase mb-1">Understanding</div><p className="text-xs text-blue-900 leading-relaxed">{insight.pillars.understanding}</p></div>
                                                <div className="bg-green-50 p-3 rounded-xl border border-green-100"><div className="text-green-800 font-bold text-xs uppercase mb-1">Growth</div><p className="text-xs text-green-900 leading-relaxed">{insight.pillars.emotional_resonance}</p></div>
                                                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100"><div className="text-orange-800 font-bold text-xs uppercase mb-1">Blind Spots</div><p className="text-xs text-orange-900 leading-relaxed">{insight.pillars.blind_spots}</p></div>
                                            </div>
                                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                                <div className="text-gray-500 font-bold text-xs uppercase mb-2 flex items-center gap-1"><CheckCircleIcon className="h-4 w-4" /> Action Plan</div>
                                                <ul className="space-y-2">
                                                    {actions.map((action, idx) => (
                                                        <li key={idx} className="text-xs text-gray-700 flex items-center justify-between gap-2">
                                                            <div className="flex gap-2"><span className="text-purple-400 font-bold mt-0.5">‚Ä¢</span>{action}</div>
                                                            <button onClick={() => !addedActions.has(action) && handleAddToTasks(action)} disabled={addedActions.has(action)} className={`p-1 rounded-full transition-all flex-shrink-0 ${addedActions.has(action) ? 'text-green-500 bg-green-100' : 'text-gray-400 hover:text-purple-600 hover:bg-purple-100'}`}>
                                                                {addedActions.has(action) ? <CheckCircleIcon className="h-4 w-4" /> : <PlusCircleIcon className="h-4 w-4" />}
                                                            </button>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
}
--- END_FILE: src/pages/InsightsLog.tsx ---

--- START_FILE: src/pages/Journal.tsx ---
import { useState } from 'react';
import { useSearchParams } from 'react-router-dom';
import JournalEditor, { type JournalEntry } from '../components/journal/JournalEditor';
import JournalHistory from '../components/journal/JournalHistory';
import JournalInsights from '../components/journal/JournalInsights';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
  PencilSquareIcon, 
  ClockIcon, 
  ChartBarIcon, 
  BookOpenIcon 
} from '@heroicons/react/24/outline';

export default function Journal() {
  const [searchParams, setSearchParams] = useSearchParams();
  
  // State
  const activeTab = searchParams.get('tab') || 'write';
  const initialTemplateId = searchParams.get('template');
  const [editingEntry, setEditingEntry] = useState<JournalEntry | null>(null);

  // Handlers
  const handleTabChange = (tab: string) => {
    setSearchParams(prev => {
        prev.set('tab', tab);
        // Clear template param if leaving write tab so it doesn't persist unwantedly
        if (tab !== 'write') prev.delete('template');
        return prev;
    });
  };

  const handleEdit = (entry: JournalEntry) => {
    setEditingEntry(entry);
    handleTabChange('write');
  };

  const handleEntrySaved = () => {
    setEditingEntry(null);
    setSearchParams(prev => {
        prev.delete('template');
        prev.set('tab', 'history');
        return prev;
    });
  };

  return (
    <div className={`h-[100dvh] flex flex-col ${THEME.journal.page}`}>
      
      {/* 1. FIXED HEADER */}
      <div className="flex-shrink-0 z-10">
        <VibrantHeader 
            title="Journal"
            subtitle="Capture your thoughts."
            icon={BookOpenIcon}
            fromColor={THEME.journal.header.from}
            viaColor={THEME.journal.header.via}
            toColor={THEME.journal.header.to}
        />
      </div>

      {/* 2. FLOATING TABS (Overlaps Header) */}
      <div className="px-4 -mt-10 relative z-30 flex-shrink-0">
        <div className="bg-white p-1.5 rounded-xl shadow-lg border border-indigo-200 flex">
           <button 
             onClick={() => handleTabChange('write')} 
             className={`flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-xs font-bold rounded-lg transition-all uppercase tracking-wide ${
               activeTab === 'write' 
                 ? 'bg-gradient-to-br from-indigo-600 to-violet-600 text-white shadow-md transform scale-105' 
                 : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-50'
             }`}
           >
             <PencilSquareIcon className="h-4 w-4" />
             Write
           </button>
           <button 
             onClick={() => handleTabChange('history')} 
             className={`flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-xs font-bold rounded-lg transition-all uppercase tracking-wide ${
               activeTab === 'history' 
                 ? 'bg-gradient-to-br from-indigo-600 to-violet-600 text-white shadow-md transform scale-105' 
                 : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-50'
             }`}
           >
             <ClockIcon className="h-4 w-4" />
             History
           </button>
           <button 
             onClick={() => handleTabChange('insights')} 
             className={`flex-1 flex items-center justify-center gap-2 px-4 py-2.5 text-xs font-bold rounded-lg transition-all uppercase tracking-wide ${
               activeTab === 'insights' 
                 ? 'bg-gradient-to-br from-indigo-600 to-violet-600 text-white shadow-md transform scale-105' 
                 : 'text-gray-500 hover:text-indigo-600 hover:bg-gray-50'
             }`}
           >
             <ChartBarIcon className="h-4 w-4" />
             Insights
           </button>
        </div>
      </div>

      {/* 3. SCROLLABLE CONTENT */}
      {/* pt-6 ensures content doesn't butt up against the floating tabs immediately */}
      <div className="flex-1 overflow-y-auto px-4 pt-6 pb-20">
        
        {activeTab === 'write' && (
            <div className="animate-fadeIn h-full flex flex-col">
                <JournalEditor 
                    initialEntry={editingEntry} 
                    initialTemplateId={initialTemplateId} 
                    onSaveComplete={handleEntrySaved} 
                />
            </div>
        )}
        
        {activeTab === 'history' && (
            <div className="animate-fadeIn">
                <JournalHistory onEdit={handleEdit} />
            </div>
        )}
        
        {activeTab === 'insights' && (
            <div className="animate-fadeIn">
                <JournalInsights />
            </div>
        )}

      </div>
    </div>
  );
}
--- END_FILE: src/pages/Journal.tsx ---

--- START_FILE: src/pages/Login.tsx ---
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { ShieldCheckIcon, EnvelopeIcon, LockClosedIcon } from '@heroicons/react/24/outline';

export default function Login() {
  const { loginWithGoogle, loginWithEmail, signupWithEmail, user, loading } = useAuth();
  const navigate = useNavigate();
  
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPass, setConfirmPass] = useState('');
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // --- Auto-Redirect when User is Detected ---
  useEffect(() => {
    if (user && !loading) {
      navigate('/'); 
    }
  }, [user, loading, navigate]);

  // Handle Google Login
  const handleGoogleLogin = async () => {
    try {
      setError('');
      setIsSubmitting(true);
      await loginWithGoogle();
    } catch (error) {
      console.error(error);
      setError('Failed to sign in with Google.');
      setIsSubmitting(false);
    }
  };

  // Handle Email Submit
  const handleEmailSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsSubmitting(true);

    // Basic Validation
    if (!email || !password) {
        setError("Please fill in all fields.");
        setIsSubmitting(false);
        return;
    }
    
    if (!isLogin && password !== confirmPass) {
        setError("Passwords do not match.");
        setIsSubmitting(false);
        return;
    }

    if (password.length < 6) {
        setError("Password should be at least 6 characters.");
        setIsSubmitting(false);
        return;
    }

    try {
      if (isLogin) {
        await loginWithEmail(email, password);
      } else {
        await signupWithEmail(email, password);
      }
      navigate('/'); 
    } catch (err: unknown) { // <--- FIXED: Changed to 'unknown' to satisfy TS1196
      console.error(err);
      setIsSubmitting(false); 
      
      // Safe cast to access properties
      const error = err as { code?: string }; 
      
      // Firebase error mapping
      if (error.code === 'auth/email-already-in-use') {
        setError('That email is already in use.');
      } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
        setError('Invalid email or password.');
      } else {
        setError('Failed to authenticate. Please try again.');
      }
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
             <ShieldCheckIcon className="h-10 w-10 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">
            My Recovery Toolkit
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            {isLogin ? 'Sign in to your account' : 'Create a new account'}
          </p>
        </div>

        {/* Error Message */}
        {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm text-center">
                {error}
            </div>
        )}

        {/* Email Form */}
        <form className="mt-8 space-y-4" onSubmit={handleEmailSubmit}>
            <div className="space-y-4">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <EnvelopeIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="email"
                        required
                        placeholder="Email address"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <LockClosedIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="password"
                        required
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                {!isLogin && (
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <LockClosedIcon className="h-5 w-5 text-gray-400" />
                        </div>
                        <input
                            type="password"
                            required
                            placeholder="Confirm Password"
                            value={confirmPass}
                            onChange={(e) => setConfirmPass(e.target.value)}
                            className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                        />
                    </div>
                )}
            </div>

            <button
                type="submit"
                disabled={isSubmitting || loading}
                className="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
            >
                {isSubmitting ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}
            </button>
        </form>

        <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
        </div>

        {/* Google Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={isSubmitting || loading}
          className="w-full flex items-center justify-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
        >
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="h-5 w-5 mr-2" />
          Sign in with Google
        </button>

        {/* Toggle Mode */}
        <div className="text-center mt-4">
            <p className="text-sm text-gray-600">
                {isLogin ? "Don't have an account? " : "Already have an account? "}
                <button 
                    onClick={() => {
                        setIsLogin(!isLogin);
                        setError('');
                        setEmail('');
                        setPassword('');
                        setConfirmPass('');
                    }}
                    className="font-medium text-blue-600 hover:text-blue-500"
                >
                    {isLogin ? 'Sign up' : 'Sign in'}
                </button>
            </p>
        </div>

      </div>
    </div>
  );
}
--- END_FILE: src/pages/Login.tsx ---

--- START_FILE: src/pages/Profile.tsx ---
/**
 * GITHUB COMMENT:
 * [Profile.tsx]
 * FIXED: TypeScript Error TS2322. Converted native Date object to Firestore Timestamp 
 * before updating profile to match the UserProfile interface.
 */
import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getProfile, updateProfileData } from '../lib/db';
import { Timestamp } from 'firebase/firestore'; // Added import
import VibrantHeader from '../components/VibrantHeader'; 
import DataManagement from '../components/profile/DataManagement';
import { 
  UserCircleIcon, 
  ArrowLeftOnRectangleIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';
import { THEME } from '../lib/theme';

export default function Profile() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  
  const appVersion = import.meta.env.VITE_APP_VERSION || 'Dev-Local';
  
  const [displayName, setDisplayName] = useState('');
  const [sobrietyDate, setSobrietyDate] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

  useEffect(() => {
    async function loadProfile() {
      if (user) {
        const data = await getProfile(user.uid);
        if (data) {
          setDisplayName(data.displayName || user.displayName || '');
          if (data.sobrietyDate) {
            setSobrietyDate(data.sobrietyDate.toDate().toISOString().split('T')[0]);
          }
        }
        setLoading(false);
      }
    }
    loadProfile();
  }, [user]);

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    setSaving(true);
    setMessage(null);

    try {
      // Convert the string input to a Firestore Timestamp
      let sobrietyTimestamp: Timestamp | null = null;
      if (sobrietyDate) {
          const [y, m, d] = sobrietyDate.split('-').map(Number);
          const dateObj = new Date(y, m - 1, d);
          sobrietyTimestamp = Timestamp.fromDate(dateObj); // FIXED: Convert to Timestamp
      }
      
      await updateProfileData(user.uid, {
        displayName,
        sobrietyDate: sobrietyTimestamp // Now matches strict interface
      });

      setMessage({ type: 'success', text: 'Profile updated successfully' });
    } catch (error) {
      console.error(error);
      setMessage({ type: 'error', text: 'Failed to update profile' });
    } finally {
      setSaving(false);
    }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading profile...</div>;

  return (
    <div className={`pb-24 min-h-screen ${THEME.profile.page}`}>
      
      <VibrantHeader 
        title="My Profile"
        subtitle={user?.email || ''}
        icon={UserCircleIcon}
        fromColor={THEME.profile.header.from}
        viaColor={THEME.profile.header.via}
        toColor={THEME.profile.header.to}
      />

      <div className="max-w-2xl mx-auto space-y-8 px-4 -mt-10 relative z-30">
        
        <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
            <h3 className="text-lg font-bold text-gray-900 border-b border-gray-100 pb-2">Settings</h3>
            <div>
            <label className="block text-sm font-medium text-gray-700">Display Name</label>
            <input
                type="text"
                value={displayName}
                onChange={(e) => setDisplayName(e.target.value)}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
            />
            </div>

            <div>
            <label className="block text-sm font-medium text-gray-700">Sobriety Date</label>
            <input
                type="date"
                value={sobrietyDate}
                onChange={(e) => setSobrietyDate(e.target.value)}
                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
            />
            <p className="mt-1 text-xs text-gray-500">Used to calculate your recovery stats on the dashboard.</p>
            </div>

            {message && (
            <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                {message.text}
            </div>
            )}

            <div className="flex justify-end gap-3">
            <button
                type="submit"
                disabled={saving}
                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 transition-colors"
            >
                {saving ? 'Saving...' : 'Save Changes'}
            </button>
            </div>
        </form>

        <DataManagement />

        <div className="border-t border-gray-200 pt-6">
            <button
            onClick={handleLogout}
            className="w-full flex justify-center items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors"
            >
            <ArrowLeftOnRectangleIcon className="h-5 w-5" />
            Log Out
            </button>
        </div>

        <div className="text-center text-xs text-gray-400 font-mono">
            App Version: v{appVersion}
        </div>
      </div>
    </div>
  );
}
--- END_FILE: src/pages/Profile.tsx ---

--- START_FILE: src/pages/Tasks.tsx ---
import { useState, useEffect, useCallback, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { 
  collection, 
  query, 
  where, 
  orderBy, 
  onSnapshot, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  serverTimestamp, 
  Timestamp 
} from 'firebase/firestore';
import { 
  PlusIcon, 
  BookOpenIcon, 
  TrashIcon, 
  TrophyIcon, 
  EllipsisHorizontalIcon, 
  PencilSquareIcon,
  ArrowPathIcon,
  FireIcon
} from '@heroicons/react/24/outline';
import { CheckCircleIcon as CheckCircleSolidIcon } from '@heroicons/react/24/solid';
import { calculateNextDueDate, getRecurrenceLabel, type RecurrenceConfig } from '../lib/dateUtils';
import TaskFormModal, { type TaskFormData } from '../components/tasks/TaskFormModal';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';

type TaskCategory = 'Recovery' | 'Health' | 'Life' | 'Work';
type TaskPriority = 'High' | 'Medium' | 'Low';
type TabOption = 'today' | 'upcoming' | 'history';

export interface Task {
  id: string;
  uid: string;
  title: string;
  category: TaskCategory;
  priority: TaskPriority;
  status: 'pending' | 'completed';
  frequency?: string; 
  recurrence?: RecurrenceConfig;
  dueDate: Timestamp | Date | null;
  createdAt: Timestamp;
  completedAt?: Timestamp | null;
  stats?: {
    xp: number;
    attribute: 'Wisdom' | 'Vitality' | 'Willpower';
  };
}

const CATEGORY_THEME: Record<TaskCategory, { bg: string; text: string; border: string; ring: string }> = {
    Recovery: { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', ring: 'ring-cyan-500' },
    Health:   { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', ring: 'ring-emerald-500' },
    Life:     { bg: 'bg-violet-50', text: 'text-violet-700', border: 'border-violet-200', ring: 'ring-violet-500' },
    Work:     { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', ring: 'ring-amber-500' },
};

export default function Tasks() {
  const { user } = useAuth();
  const navigate = useNavigate();

  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<TabOption>('today');
  const [expandedTaskId, setExpandedTaskId] = useState<string | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Task | null>(null);

  useEffect(() => {
    if (!user || !db) return;

    const q = query(
      collection(db, 'tasks'),
      where('uid', '==', user.uid),
      orderBy('createdAt', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const taskData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      } as Task));
      setTasks(taskData);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const { filteredTasks, progress } = useMemo(() => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    
    const getTaskDate = (t: Task) => {
        if (!t.dueDate) return null;
        return t.dueDate instanceof Date ? t.dueDate : (t.dueDate as Timestamp).toDate();
    };

    const todayTasks: Task[] = [];
    const upcomingTasks: Task[] = [];
    const historyTasks: Task[] = [];

    let completedToday = 0;
    let totalToday = 0;

    tasks.forEach(t => {
        const d = getTaskDate(t);
        const isCompleted = t.status === 'completed';

        if (isCompleted && (!d || d < now)) {
            historyTasks.push(t);
            return;
        }

        if (d && d > now && !isCompleted) {
            upcomingTasks.push(t);
            return;
        }

        todayTasks.push(t);
        totalToday++;
        if (isCompleted) completedToday++;
    });

    todayTasks.sort((a, b) => {
        if (a.status === b.status) {
             const pMap = { High: 3, Medium: 2, Low: 1 };
             return pMap[b.priority] - pMap[a.priority];
        }
        return a.status === 'completed' ? 1 : -1;
    });

    return {
        filteredTasks: activeTab === 'today' ? todayTasks : activeTab === 'upcoming' ? upcomingTasks : historyTasks,
        progress: totalToday === 0 ? 0 : (completedToday / totalToday) * 100
    };
  }, [tasks, activeTab]);

  const handleToggleComplete = useCallback(async (task: Task) => {
    if (!db || !user) return;
    
    if (task.status === 'completed') {
         await updateDoc(doc(db, 'tasks', task.id), {
            status: 'pending',
            completedAt: null
        });
        return;
    }

    try {
        await updateDoc(doc(db, 'tasks', task.id), {
            status: 'completed',
            completedAt: serverTimestamp()
        });

        if (task.recurrence && task.recurrence.type !== 'once') {
            const currentDueDate = task.dueDate instanceof Date 
                ? task.dueDate 
                : (task.dueDate as Timestamp).toDate();
            
            const nextDate = calculateNextDueDate(currentDueDate, task.recurrence);
            
            if (nextDate) {
                await addDoc(collection(db, 'tasks'), {
                    ...task, 
                    id: undefined, 
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    dueDate: nextDate,
                    completedAt: null
                });
            }
        }

        if (navigator.vibrate) navigator.vibrate(50);
    } catch (e) {
        console.error("Error completing task", e);
    }
  }, [user]);

  const handleDelete = useCallback(async (id: string) => {
    if (!db) return;
    if (confirm("Delete this quest?")) {
        try {
            await deleteDoc(doc(db, 'tasks', id));
        } catch (e) {
            console.error(e);
        }
    }
  }, []);

  const handleEdit = useCallback((task: Task) => {
      setEditingTask(task);
      setIsModalOpen(true);
      setExpandedTaskId(null);
  }, []);

  const handleJournalReflect = useCallback((task: Task) => {
    navigate('/journal', { 
        state: { 
            initialContent: `**Reflecting on Quest: ${task.title}**\n\nHow did completing this make me feel?\n` 
        } 
    }); 
  }, [navigate]);

  const handleSaveTask = useCallback(async (data: TaskFormData) => {
    if (!user || !db) return;

    let dueDateObj: Date | null = null;
    if (data.dueDate) {
        dueDateObj = new Date(data.dueDate);
        dueDateObj.setHours(23, 59, 59);
    }

    const payload = {
        uid: user.uid,
        title: data.title,
        category: data.category,
        priority: data.priority,
        dueDate: dueDateObj || serverTimestamp(),
        recurrence: data.recurrence,
        stats: {
             xp: data.priority === 'High' ? 50 : 20,
             attribute: data.category === 'Recovery' ? 'Wisdom' : data.category === 'Health' ? 'Vitality' : 'Willpower'
        }
    };

    try {
        if (data.id) {
            await updateDoc(doc(db, 'tasks', data.id), payload);
        } else {
            await addDoc(collection(db, 'tasks'), {
                ...payload,
                status: 'pending',
                createdAt: serverTimestamp()
            });
        }
    } catch (error) {
        console.error("Error saving task", error);
    }
  }, [user]);

  const getPriorityBadge = (p: string) => {
      switch(p) {
          case 'High': return (
            <span className="flex items-center gap-1 text-[10px] font-bold text-red-700 bg-red-50 border border-red-100 px-2 py-0.5 rounded-full">
                <FireIcon className="h-3 w-3" /> HIGH
            </span>
          );
          case 'Medium': return null; 
          default: return <span className="text-[10px] text-gray-400 font-medium">Low Priority</span>;
      }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your quests...</div>;

  return (
    <div className={`h-[100dvh] flex flex-col ${THEME.tasks.page}`}>
        
        {/* HEADER: The Spark */}
        <VibrantHeader 
            title="Today's Quests"
            subtitle={new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}
            icon={FireIcon}
            fromColor={THEME.tasks.header.from}
            viaColor={THEME.tasks.header.via}
            toColor={THEME.tasks.header.to}
            percentage={progress}
            percentageColor={THEME.tasks.ring}
        />

        <div className="px-4 -mt-10 relative z-30">
            <div className="bg-white p-1.5 rounded-xl shadow-lg border border-cyan-200 flex">
                {['today', 'upcoming', 'history'].map((tab) => (
                    <button
                        key={tab}
                        onClick={() => setActiveTab(tab as TabOption)}
                        className={`flex-1 py-2.5 text-xs font-bold rounded-lg transition-all capitalize tracking-wide ${
                            activeTab === tab 
                            ? 'bg-gradient-to-br from-cyan-600 to-teal-600 text-white shadow-md transform scale-105' 
                            : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'
                        }`}
                    >
                        {tab}
                    </button>
                ))}
            </div>
        </div>

        <div className="flex-1 overflow-y-auto px-4 pb-20 space-y-4">
            {filteredTasks.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-16 text-center animate-fadeIn">
                    <div className="bg-white p-4 rounded-full shadow-sm mb-4">
                        <TrophyIcon className="h-10 w-10 text-yellow-400" />
                    </div>
                    <p className="text-gray-900 font-medium">All caught up for {activeTab}!</p>
                    <p className="text-sm text-gray-500 mt-1">Take a moment to breathe and reflect.</p>
                </div>
            ) : (
                filteredTasks.map(task => {
                    const theme = CATEGORY_THEME[task.category] || CATEGORY_THEME.Recovery;
                    
                    return (
                        <div 
                            key={task.id} 
                            className={`relative bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 hover:shadow-md ${
                                task.status === 'completed' ? 'opacity-60 grayscale-[0.5]' : ''
                            }`}
                            onClick={() => setExpandedTaskId(expandedTaskId === task.id ? null : task.id)}
                        >
                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${theme.bg.replace('bg-', 'bg-gradient-to-b from-')}-400 to-${theme.bg.split('-')[1]}-600`} />
                            
                            <div className="p-4 pl-5 flex items-start gap-4">
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleToggleComplete(task); }}
                                    className="mt-0.5 flex-shrink-0 group"
                                >
                                    {task.status === 'completed' ? (
                                        <CheckCircleSolidIcon className="h-7 w-7 text-green-500 drop-shadow-sm transition-transform group-hover:scale-110" />
                                    ) : (
                                        <div className={`h-7 w-7 rounded-full border-2 border-gray-300 group-hover:${theme.border.replace('border-', 'border-')} group-hover:bg-gray-50 transition-colors`} />
                                    )}
                                </button>

                                <div className="flex-1 min-w-0 pt-0.5">
                                    <div className="flex flex-wrap items-center gap-2 mb-1.5">
                                        {getPriorityBadge(task.priority)}
                                        <span className={`flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded-full border ${theme.bg} ${theme.text} ${theme.border}`}>
                                            {task.category || 'General'}
                                        </span>
                                        {task.recurrence && task.recurrence.type !== 'once' && (
                                            <span className="flex items-center gap-1 text-[10px] text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full border border-purple-100 font-medium">
                                                <ArrowPathIcon className="h-3 w-3" />
                                                {getRecurrenceLabel(task.recurrence)}
                                            </span>
                                        )}
                                    </div>

                                    <div className={`text-sm font-medium leading-relaxed transition-all duration-300 ${
                                        task.status === 'completed' ? 'text-gray-400 line-through decoration-gray-300' : 'text-gray-800'
                                    } ${
                                        expandedTaskId === task.id ? 'whitespace-pre-wrap' : 'line-clamp-2'
                                    }`}>
                                        {task.title}
                                    </div>

                                    <div className="flex items-center gap-3 text-xs font-medium text-gray-400 mt-2.5">
                                        {/* Removed redundant CalendarIcon usage here if it caused issues, or kept if essential. 
                                            I removed the DATE PILL entirely in this logic to match the "Removed CalendarIcon" directive.
                                            If you want the date back, we must import CalendarIcon. 
                                            Currently, I removed the import, so I must remove the usage. */}
                                        {task.stats && (
                                            <span className="text-blue-600 flex items-center gap-1">
                                                <TrophyIcon className="h-3 w-3" />
                                                +{task.stats.xp} XP
                                            </span>
                                        )}
                                    </div>
                                </div>

                                <div className="flex-shrink-0 mt-1">
                                    <EllipsisHorizontalIcon className={`h-6 w-6 text-gray-300 transition-transform ${expandedTaskId === task.id ? 'rotate-90 text-blue-600' : ''}`} />
                                </div>
                            </div>

                            {expandedTaskId === task.id && (
                                <div className="bg-gray-50/80 backdrop-blur-sm border-t border-gray-100 p-2 flex justify-end gap-2 animate-fadeIn">
                                    {task.status === 'completed' && (
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); handleJournalReflect(task); }}
                                            className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-blue-600 shadow-sm hover:bg-blue-50 active:scale-95 transition-all"
                                        >
                                            <BookOpenIcon className="h-4 w-4" />
                                            Reflect
                                        </button>
                                    )}
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleEdit(task); }}
                                        className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-700 shadow-sm hover:bg-gray-100 active:scale-95 transition-all"
                                    >
                                        <PencilSquareIcon className="h-4 w-4" />
                                        Edit
                                    </button>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleDelete(task.id); }}
                                        className="flex items-center gap-1.5 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-red-600 shadow-sm hover:bg-red-50 active:scale-95 transition-all"
                                    >
                                        <TrashIcon className="h-4 w-4" />
                                        Delete
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                })
            )}
        </div>

        <button
            onClick={() => { setEditingTask(null); setIsModalOpen(true); }}
            className="fixed bottom-24 right-4 bg-gradient-to-r from-cyan-600 to-teal-600 text-white p-4 rounded-full shadow-lg shadow-cyan-500/30 hover:scale-105 transition-all active:scale-95 z-30"
        >
            <PlusIcon className="h-7 w-7" />
        </button>

        <TaskFormModal 
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            initialTask={editingTask}
            onSave={handleSaveTask}
        />
    </div>
  );
}
--- END_FILE: src/pages/Tasks.tsx ---

--- START_FILE: src/pages/TemplateEditor.tsx ---
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTemplates,
  saveUserTemplate, 
  deleteUserTemplate, 
  type JournalTemplate 
} from '../lib/db';
import { 
  PlusIcon, 
  TrashIcon, 
  PencilSquareIcon,
  XMarkIcon,
  ArrowLeftIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function TemplateEditor() {
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [templates, setTemplates] = useState<JournalTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Editor State
  const [isEditing, setIsEditing] = useState(false);
  const [currentId, setCurrentId] = useState('');
  const [name, setName] = useState('');
  const [prompts, setPrompts] = useState<string[]>(['']);
  const [tags, setTags] = useState(''); // Comma separated string for input

  useEffect(() => {
    loadTemplates();
  }, [user]);

  async function loadTemplates() {
    if (!user) return;
    const data = await getUserTemplates(user.uid);
    setTemplates(data);
    setLoading(false);
  }

  const handleEdit = (t: JournalTemplate) => {
    setCurrentId(t.id);
    setName(t.name);
    setPrompts(t.prompts.length > 0 ? t.prompts : ['']);
    setTags(t.defaultTags.join(', '));
    setIsEditing(true);
  };

  const handleCreate = () => {
    setCurrentId('');
    setName('');
    setPrompts(['']);
    setTags('');
    setIsEditing(true);
  };

  const handleDelete = async (id: string) => {
    if (!user || !window.confirm("Are you sure you want to delete this template?")) return;
    await deleteUserTemplate(user.uid, id);
    await loadTemplates();
  };

  const handlePromptChange = (idx: number, val: string) => {
    const newPrompts = [...prompts];
    newPrompts[idx] = val;
    setPrompts(newPrompts);
  };

  const addPromptLine = () => {
    setPrompts([...prompts, '']);
  };

  const removePromptLine = (idx: number) => {
    const newPrompts = prompts.filter((_, i) => i !== idx);
    setPrompts(newPrompts);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    // Clean data
    const cleanPrompts = prompts.filter(p => p.trim() !== '');
    const cleanTags = tags.split(',').map(t => t.trim()).filter(t => t !== '').map(t => t.startsWith('#') ? t : `#${t}`);

    if (!name || cleanPrompts.length === 0) {
        alert("Please provide a name and at least one prompt.");
        return;
    }

    const templateData: JournalTemplate = {
        id: currentId, // empty string means new doc
        name,
        prompts: cleanPrompts,
        defaultTags: cleanTags
    };

    await saveUserTemplate(user.uid, templateData);
    setIsEditing(false);
    await loadTemplates();
  };

  if (loading) return <div className="p-8">Loading templates...</div>;

  // --- EDITOR VIEW ---
  if (isEditing) {
    return (
        <div className="max-w-2xl mx-auto space-y-6">
            <div className="flex items-center gap-4">
                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-900">
                    <ArrowLeftIcon className="h-5 w-5" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">{currentId ? 'Edit Template' : 'New Template'}</h1>
            </div>

            <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                    <input 
                        type="text" 
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Step 10 Inventory"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Prompts (Questions)</label>
                    <div className="space-y-3">
                        {prompts.map((p, idx) => (
                            <div key={idx} className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={p}
                                    onChange={(e) => handlePromptChange(idx, e.target.value)}
                                    className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder={`Question ${idx + 1}`}
                                />
                                <button 
                                    type="button" 
                                    onClick={() => removePromptLine(idx)}
                                    className="text-red-400 hover:text-red-600 p-2"
                                    title="Remove prompt"
                                >
                                    <XMarkIcon className="h-5 w-5" />
                                </button>
                            </div>
                        ))}
                    </div>
                    <button 
                        type="button"
                        onClick={addPromptLine}
                        className="mt-3 text-sm text-blue-600 font-medium hover:text-blue-700 flex items-center gap-1"
                    >
                        <PlusIcon className="h-4 w-4" />
                        Add Question
                    </button>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Default Tags</label>
                    <input 
                        type="text" 
                        value={tags}
                        onChange={(e) => setTags(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="#step10, #inventory (comma separated)"
                    />
                </div>

                <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button 
                        type="button" 
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                        Save Template
                    </button>
                </div>
            </form>
        </div>
    );
  }

  // --- LIST VIEW ---
  return (
    <div className="max-w-3xl mx-auto space-y-6">
       <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={() => navigate('/journal')} className="text-gray-500 hover:text-gray-900 lg:hidden">
               <ArrowLeftIcon className="h-5 w-5" />
            </button>
            <h1 className="text-2xl font-bold text-gray-900">Manage Templates</h1>
          </div>
          <button 
             onClick={handleCreate}
             className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
          >
             <PlusIcon className="h-5 w-5" />
             Create New
          </button>
       </div>

       <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          {templates.length === 0 ? (
             <div className="p-8 text-center text-gray-500">
                You haven't created any custom templates yet.
             </div>
          ) : (
             <ul className="divide-y divide-gray-100">
                {templates.map((t) => (
                   <li key={t.id} className="p-4 sm:p-6 flex items-center justify-between hover:bg-gray-50 transition">
                      <div>
                         <h3 className="font-semibold text-gray-900">{t.name}</h3>
                         <p className="text-sm text-gray-500 mt-1">{t.prompts.length} questions ‚Ä¢ {t.defaultTags.join(', ')}</p>
                      </div>
                      <div className="flex items-center gap-2">
                         <button 
                            onClick={() => handleEdit(t)}
                            className="p-2 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition"
                            title="Edit"
                         >
                            <PencilSquareIcon className="h-5 w-5" />
                         </button>
                         <button 
                            onClick={() => handleDelete(t.id)}
                            className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition"
                            title="Delete"
                         >
                            <TrashIcon className="h-5 w-5" />
                         </button>
                      </div>
                   </li>
                ))}
             </ul>
          )}
       </div>
    </div>
  );
}
--- END_FILE: src/pages/TemplateEditor.tsx ---

--- START_FILE: src/pages/UserGuide.tsx ---
/**
 * GITHUB COMMENT:
 * [UserGuide.tsx]
 * NEW: Implemented a native, interactive web-based user manual.
 * UI: Aligned with the "Vibrant Momentum" design tokens and theme.
 * ASSETS: Created 12 structural placeholders for Pixel 9 Pro XL screenshots.
 */
import { useNavigate } from 'react-router-dom';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
  BookOpenIcon, 
  ChevronLeftIcon, 
  ShieldCheckIcon, 
  SparklesIcon, 
  FireIcon, 
  HeartIcon,
  ExclamationTriangleIcon,
  CloudArrowUpIcon,
  LockClosedIcon,
  AcademicCapIcon,
  LightBulbIcon
} from '@heroicons/react/24/outline';

interface PlaceholderProps {
  id: number;
  label: string;
}

const ScreenshotPlaceholder = ({ id, label }: PlaceholderProps) => (
  <div className="my-8 border-4 border-dashed border-slate-300 rounded-[2.5rem] bg-slate-50 flex flex-col items-center justify-center p-8 text-center aspect-[9/19.5] max-w-[280px] mx-auto shadow-inner group hover:bg-slate-100 transition-colors">
    <div className="bg-blue-600 text-white font-black rounded-full w-12 h-12 flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform">
      {id}
    </div>
    <p className="text-slate-500 font-mono text-[10px] uppercase tracking-[0.2em] leading-loose">
      Pixel 9 Pro XL<br/>
      <span className="text-slate-900 font-bold text-xs">{label}</span>
    </p>
  </div>
);

export default function UserGuide() {
  const navigate = useNavigate();

  return (
    <div className={`min-h-screen pb-20 ${THEME.profile.page}`}>
      <VibrantHeader 
        title="User Guide"
        subtitle="Mastering your recovery companion."
        icon={BookOpenIcon}
        fromColor="from-slate-700"
        viaColor="via-slate-800"
        toColor="to-slate-900"
      />

      {/* Navigation Override */}
      <div className="absolute top-4 left-16 z-50">
        <button 
          onClick={() => navigate('/profile')}
          className="flex items-center gap-1.5 px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white rounded-lg backdrop-blur-md border border-white/10 text-xs font-bold transition-all active:scale-95"
        >
          <ChevronLeftIcon className="h-4 w-4" /> 
          BACK
        </button>
      </div>

      <div className="max-w-3xl mx-auto px-6 -mt-8 relative z-30 space-y-12">
        
        {/* INTRODUCTION */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200 animate-fadeIn">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <ShieldCheckIcon className="h-7 w-7 text-blue-600" />
            The Horizon
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            The Dashboard is your command center. It tracks your <strong>Clean Time</strong> and provides a 4-pillar overview of your mental, physical, and spiritual momentum.
          </p>
          <ScreenshotPlaceholder id={1} label="Dashboard View" />
        </section>

        {/* VAULT SECURITY */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <LockClosedIcon className="h-7 w-7 text-indigo-600" />
            Recovery Vault
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            MRT uses <strong>AES-GCM encryption</strong>. Your data is locked behind a 4-digit PIN. We utilize a zero-knowledge model: we never store your PIN, and we cannot reset it.
          </p>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <ScreenshotPlaceholder id={2} label="Vault Lock Screen" />
            <ScreenshotPlaceholder id={3} label="Vault Setup UI" />
          </div>
          <div className="mt-6 bg-amber-50 rounded-2xl p-4 border border-amber-100 flex items-start gap-3">
            <ExclamationTriangleIcon className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
            <p className="text-xs text-amber-800 font-medium leading-relaxed">
              If the PIN is lost, cloud data is unrecoverable. Ensure you utilize the <strong>Google Drive Auto-Backup</strong> or manual exports regularly.
            </p>
          </div>
        </section>

        {/* JOURNALING */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <SparklesIcon className="h-7 w-7 text-violet-600" />
            The Deep Dive
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            Journaling is the core of MRT. Use <strong>Smart Templates</strong> to prompt your reflection, and consult the <strong>Analysis Wizard</strong> to track emotional patterns over time.
          </p>
          <ScreenshotPlaceholder id={4} label="Journal Editor" />
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-8">
            <ScreenshotPlaceholder id={5} label="Journal History" />
            <ScreenshotPlaceholder id={6} label="AI Analysis" />
          </div>
        </section>

        {/* QUESTS & VITALITY */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <FireIcon className="h-7 w-7 text-cyan-600" />
            The Spark & The Pulse
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            Manage daily habits with <strong>Quests</strong>. If you miss a recurring habit, the system performs a <strong>Smart Reset</strong> to help you start fresh tomorrow without guilt.
          </p>
          <ScreenshotPlaceholder id={7} label="Quest Stream" />
          
          <div className="h-px bg-slate-100 my-10" />

          <h3 className="text-xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <HeartIcon className="h-7 w-7 text-rose-600" />
            Vitality Tracking
          </h3>
          <p className="text-slate-600 leading-relaxed mb-6">
            Regulate your nervous system with the built-in <strong>4-7-8 Breathing Tool</strong>. Logs are automatically saved as tagged journal entries for long-term health insights.
          </p>
          <ScreenshotPlaceholder id={8} label="Breathwork Tool" />
        </section>

        {/* WORKBOOKS */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <AcademicCapIcon className="h-7 w-7 text-emerald-600" />
            The Library
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            Structured 12-Step and Dharma modules help you do the "heavy lifting" of recovery. Progress is tracked through a <strong>Wisdom Score</strong>.
          </p>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <ScreenshotPlaceholder id={9} label="Workbook Index" />
            <ScreenshotPlaceholder id={10} label="Wisdom Log" />
          </div>
        </section>

        {/* EMERGENCY & ARCHIVE */}
        <section className="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
          <h2 className="text-2xl font-bold text-slate-900 mb-4 flex items-center gap-3">
            <LightBulbIcon className="h-7 w-7 text-blue-600" />
            Safety & Sovereignty
          </h2>
          <p className="text-slate-600 leading-relaxed mb-6">
            The pulsing <strong>SOS Modal</strong> provides immediate access to support lines. The Profile page ensures <strong>Data Sovereignty</strong>, allowing you to export or sync your data anytime.
          </p>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <ScreenshotPlaceholder id={11} label="SOS Modal" />
            <ScreenshotPlaceholder id={12} label="Profile & Sync" />
          </div>
        </section>

        {/* BACKUP REMINDER */}
        <div className="bg-blue-600 rounded-[2.5rem] p-8 text-center text-white shadow-xl">
          <CloudArrowUpIcon className="h-12 w-12 mx-auto mb-4 opacity-80" />
          <h2 className="text-xl font-bold mb-2">Cloud Auto-Sync</h2>
          <p className="text-blue-100 text-sm leading-relaxed mb-6">
            Sign in with Google to enable automatic backups to your private Drive. MRT stores a readable backup every 7 days to ensure you never lose your progress.
          </p>
          <button 
            onClick={() => navigate('/profile')}
            className="bg-white text-blue-600 px-8 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-blue-50 transition-colors active:scale-95"
          >
            Check Sync Status
          </button>
        </div>

      </div>
    </div>
  );
}
--- END_FILE: src/pages/UserGuide.tsx ---

--- START_FILE: src/pages/Vitality.tsx ---
import React, { useState, useEffect, useMemo } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, addDoc, query, where, orderBy, onSnapshot, Timestamp } from 'firebase/firestore';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
    HeartIcon, 
    FireIcon, 
    BeakerIcon, 
    BoltIcon,    
    CheckCircleIcon,
    PlayIcon,
    PauseIcon,
    ArrowPathIcon,
    SparklesIcon 
} from '@heroicons/react/24/outline';

interface VitalityLog {
    id: string;
    tags: string[];
    createdAt: Timestamp;
}

type VitalityTab = 'move' | 'fuel' | 'breath';

export default function Vitality() {
    const { user } = useAuth();
    const [activeTab, setActiveTab] = useState<VitalityTab>('move');
    const [saving, setSaving] = useState(false);
    
    // --- DATA STATE ---
    const [todaysLogs, setTodaysLogs] = useState<VitalityLog[]>([]);
    
    // --- FORM STATES ---
    const [moveActivity, setMoveActivity] = useState('');
    const [moveDuration, setMoveDuration] = useState('');
    const [moveIntensity, setMoveIntensity] = useState('Moderate');
    const [moveNote, setMoveNote] = useState('');

    const [mealType, setMealType] = useState('Lunch');
    const [hungerType, setHungerType] = useState('Physical'); 
    const [waterCount, setWaterCount] = useState(0); 
    const [nutriNote, setNutriNote] = useState('');

    const [breathActive, setBreathActive] = useState(false);
    const [breathPhase, setBreathPhase] = useState('Idle'); 
    const [breathTime, setBreathTime] = useState(0); 
    const [breathNote, setBreathNote] = useState('');

    useEffect(() => {
        if (!user || !db) return;

        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);

        const q = query(
            collection(db, 'journals'),
            where('uid', '==', user.uid),
            where('tags', 'array-contains', 'Vitality'),
            where('createdAt', '>=', Timestamp.fromDate(startOfToday)),
            orderBy('createdAt', 'desc')
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const logs = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            } as VitalityLog));
            setTodaysLogs(logs);
        });

        return () => unsubscribe();
    }, [user]);

    const bioBalance = useMemo(() => {
        const hasMove = todaysLogs.some(l => l.tags.includes('Movement'));
        const hasFood = todaysLogs.some(l => l.tags.includes('Nutrition'));
        const hasMind = todaysLogs.some(l => l.tags.includes('Mindfulness') || l.tags.includes('Meditation'));
        
        let score = 0;
        if (hasMove) score += 33.3;
        if (hasFood) score += 33.3;
        if (hasMind) score += 33.3;
        return Math.min(100, score);
    }, [todaysLogs]);

    // --- ACTIONS ---
    const saveVitalityEntry = async (category: string, title: string, contentDetails: string, note: string, tags: string[]) => {
        if (!user || !db) return;
        setSaving(true);

        const fullContent = `**${title}**\n${contentDetails}\n\n**Somatic Check-in:**\n${note || "No specific notes recorded."}`;

        try {
            await addDoc(collection(db, 'journals'), {
                uid: user.uid,
                content: fullContent,
                moodScore: 5, 
                tags: ['Vitality', category, ...tags],
                sentiment: 'Pending',
                createdAt: Timestamp.now()
            });
            if (navigator.vibrate) navigator.vibrate(50);
        } catch (e) {
            console.error(e);
            alert("Failed to save entry.");
        } finally {
            setSaving(false);
        }
    };

    const handleLogMovement = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!moveActivity) return;
        
        const details = `*Activity:* ${moveActivity}\n*Duration:* ${moveDuration} mins\n*Intensity:* ${moveIntensity}`;
        await saveVitalityEntry('Movement', 'Movement Log üèÉ', details, moveNote, [moveActivity]);
        
        setMoveActivity('');
        setMoveDuration('');
        setMoveNote('');
    };

    const handleLogNutrition = async (e: React.FormEvent) => {
        e.preventDefault();
        const details = `*Meal:* ${mealType}\n*Hunger Type:* ${hungerType}\n*Hydration at log:* ${waterCount} glasses`;
        await saveVitalityEntry('Nutrition', 'Fuel Log üçé', details, nutriNote, [mealType]);
        setNutriNote('');
    };

    const handleLogBreath = async () => {
        const mins = Math.floor(breathTime / 60);
        const secs = breathTime % 60;
        const details = `*Session Duration:* ${mins}m ${secs}s\n*Technique:* 4-7-8 Relaxing Breath`;
        await saveVitalityEntry('Mindfulness', 'Breathwork Session üå¨Ô∏è', details, breathNote, ['Meditation']);
        setBreathTime(0);
        setBreathNote('');
        setBreathActive(false);
    };

    // Breath Timer
    useEffect(() => {
        let interval: ReturnType<typeof setInterval> | undefined;
        if (breathActive) {
            interval = setInterval(() => {
                setBreathTime(prev => {
                    const next = prev + 1;
                    const cycle = next % 19; 
                    if (cycle < 4) setBreathPhase('Inhale (4s)');
                    else if (cycle < 11) setBreathPhase('Hold (7s)');
                    else setBreathPhase('Exhale (8s)');
                    return next;
                });
            }, 1000);
        } else {
            setBreathPhase('Idle');
        }
        return () => clearInterval(interval);
    }, [breathActive]);

    const toggleBreath = () => setBreathActive(!breathActive);

    return (
        <div className={`h-[100dvh] flex flex-col ${THEME.vitality.page}`}>
            
            <div className="flex-shrink-0 z-10">
                <VibrantHeader 
                    title="Vitality & Health"
                    subtitle={new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}
                    icon={HeartIcon}
                    fromColor={THEME.vitality.header.from}
                    viaColor={THEME.vitality.header.via}
                    toColor={THEME.vitality.header.to}
                    percentage={bioBalance}
                    percentageColor={THEME.vitality.ring}
                />
            </div>

            {/* TAB NAVIGATION */}
            <div className="px-4 py-4 z-20">
                <div className="flex p-1 bg-white/80 backdrop-blur-sm rounded-xl border border-orange-200 shadow-sm">
                    <button onClick={() => setActiveTab('move')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'move' ? 'bg-orange-100 text-orange-700 shadow-sm' : 'text-gray-500'}`}>
                        Movement
                    </button>
                    <button onClick={() => setActiveTab('fuel')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'fuel' ? 'bg-emerald-100 text-emerald-700 shadow-sm' : 'text-gray-500'}`}>
                        Fuel
                    </button>
                    <button onClick={() => setActiveTab('breath')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${activeTab === 'breath' ? 'bg-sky-100 text-sky-700 shadow-sm' : 'text-gray-500'}`}>
                        Breath
                    </button>
                </div>
            </div>

            {/* SCROLLABLE CONTENT AREA */}
            <div className="flex-1 overflow-y-auto px-4 pb-20">
                
                {/* 1. MOVEMENT CARD */}
                {activeTab === 'move' && (
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative animate-fadeIn">
                        <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-orange-400 to-red-500"></div>
                        <div className="p-6">
                            <div className="flex items-center gap-2 mb-6">
                                <div className="p-2 bg-orange-50 rounded-lg text-orange-600">
                                    <FireIcon className="h-6 w-6" />
                                </div>
                                <h3 className="text-lg font-bold text-gray-900">Log Activity</h3>
                            </div>
                            <form onSubmit={handleLogMovement} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Activity</label>
                                        <input type="text" placeholder="e.g. Walk" value={moveActivity} onChange={(e) => setMoveActivity(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50" required />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Mins</label>
                                        <input type="number" placeholder="30" value={moveDuration} onChange={(e) => setMoveDuration(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50" required />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Intensity</label>
                                    <div className="flex gap-2">
                                        {['Low', 'Moderate', 'High'].map(lvl => (
                                            <button key={lvl} type="button" onClick={() => setMoveIntensity(lvl)} className={`flex-1 py-2 text-xs font-semibold rounded-lg border transition-all ${moveIntensity === lvl ? 'bg-orange-100 border-orange-200 text-orange-700' : 'bg-white border-gray-200 text-gray-500'}`}>{lvl}</button>
                                        ))}
                                    </div>
                                </div>
                                <textarea rows={2} placeholder="Body check-in..." value={moveNote} onChange={(e) => setMoveNote(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50 resize-none" />
                                <button type="submit" disabled={saving} className="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95 flex justify-center items-center gap-2">
                                    {saving ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <CheckCircleIcon className="h-5 w-5" />} Log
                                </button>
                            </form>
                        </div>
                    </div>
                )}

                {/* 2. NUTRITION CARD */}
                {activeTab === 'fuel' && (
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative animate-fadeIn">
                        <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-emerald-400 to-green-600"></div>
                        <div className="p-6">
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-2">
                                    <div className="p-2 bg-emerald-50 rounded-lg text-emerald-600"><BeakerIcon className="h-6 w-6" /></div>
                                    <h3 className="text-lg font-bold text-gray-900">Nutrition</h3>
                                </div>
                                <div className="flex items-center gap-2 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">
                                    <button onClick={() => setWaterCount(Math.max(0, waterCount - 1))} className="text-blue-400 font-bold">-</button>
                                    <span className="text-sm font-bold text-blue-700 w-4 text-center">{waterCount}</span>
                                    <button onClick={() => setWaterCount(waterCount + 1)} className="text-blue-400 font-bold">+</button>
                                    <span className="text-[10px] text-blue-400 uppercase font-bold">H2O</span>
                                </div>
                            </div>
                            <form onSubmit={handleLogNutrition} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Meal</label>
                                        <select value={mealType} onChange={(e) => setMealType(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50"><option>Breakfast</option><option>Lunch</option><option>Dinner</option><option>Snack</option></select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Hunger</label>
                                        <select value={hungerType} onChange={(e) => setHungerType(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50"><option>Physical</option><option>Emotional</option><option>Boredom</option><option>Habit</option></select>
                                    </div>
                                </div>
                                <textarea rows={2} placeholder="Mindful eating check..." value={nutriNote} onChange={(e) => setNutriNote(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50 resize-none" />
                                <button type="submit" disabled={saving} className="w-full py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95 flex justify-center items-center gap-2">
                                    {saving ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <CheckCircleIcon className="h-5 w-5" />} Log Fuel
                                </button>
                            </form>
                        </div>
                    </div>
                )}

                {/* 3. BREATHWORK CARD */}
                {activeTab === 'breath' && (
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative animate-fadeIn">
                        <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-sky-400 to-blue-600"></div>
                        <div className="p-6">
                            <div className="flex items-center gap-2 mb-6">
                                <div className="p-2 bg-sky-50 rounded-lg text-sky-600"><BoltIcon className="h-6 w-6" /></div>
                                <h3 className="text-lg font-bold text-gray-900">Breathe</h3>
                            </div>
                            
                            <div className="flex flex-col items-center gap-6">
                                <div className="relative flex items-center justify-center w-48 h-48 flex-shrink-0">
                                     <div className={`absolute inset-0 bg-sky-100 rounded-full transition-all duration-[4000ms] ease-in-out ${breathPhase.includes('Inhale') ? 'scale-100 opacity-100' : breathPhase.includes('Hold') ? 'scale-100 opacity-80' : 'scale-50 opacity-50'}`}></div>
                                     <div className="relative z-10 text-center">
                                         <div className="text-3xl font-bold text-sky-900 tabular-nums">
                                             {Math.floor(breathTime / 60)}:{(breathTime % 60).toString().padStart(2, '0')}
                                         </div>
                                         <div className="text-xs font-bold text-sky-600 uppercase tracking-widest mt-1">{breathPhase}</div>
                                     </div>
                                </div>

                                <div className="w-full space-y-4">
                                    <div className="flex gap-4">
                                        <button onClick={toggleBreath} className={`flex-1 py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-md active:scale-95 ${breathActive ? 'bg-amber-100 text-amber-800' : 'bg-sky-600 text-white'}`}>
                                            {breathActive ? <><PauseIcon className="h-6 w-6" /> Pause</> : <><PlayIcon className="h-6 w-6" /> Start</>}
                                        </button>
                                        <button onClick={() => { setBreathActive(false); setBreathTime(0); setBreathPhase('Idle'); }} className="px-5 rounded-xl border-2 border-gray-200 text-gray-400 hover:bg-gray-50"><ArrowPathIcon className="h-6 w-6" /></button>
                                    </div>
                                    <textarea rows={2} placeholder="Reflection..." value={breathNote} onChange={(e) => setBreathNote(e.target.value)} className="w-full text-sm rounded-xl border-gray-200 bg-gray-50" />
                                    <button onClick={handleLogBreath} disabled={breathTime < 5 || saving} className="w-full py-3 bg-sky-50 text-sky-700 hover:bg-sky-100 font-bold rounded-xl transition-colors flex justify-center items-center gap-2 disabled:opacity-50">
                                        {saving ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />} Complete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

            </div>
        </div>
    );
}
--- END_FILE: src/pages/Vitality.tsx ---

--- START_FILE: src/pages/Welcome.tsx ---
// src/pages/Welcome.tsx
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { ShieldCheckIcon, ArrowRightIcon } from '@heroicons/react/24/outline';

interface Persona {
  id: string;
  name: string;
  title: string;
  stage: string;
  image: string;
  color: string;
}

const PERSONAS: Persona[] = [
  {
    id: 'david',
    name: 'David',
    title: 'The Fresh Start',
    stage: 'Day 1',
    image: '/personas/david.jpg', // Assumes images are placed in public/personas/
    color: 'bg-blue-600'
  },
  {
    id: 'ned',
    name: 'Ned',
    title: 'The Pink Cloud',
    stage: '90 Days',
    image: '/personas/ned.jpg',
    color: 'bg-green-500'
  },
  {
    id: 'lisa',
    name: 'Lisa',
    title: 'Service Superstar',
    stage: '7 Years',
    image: '/personas/lisa.jpg',
    color: 'bg-purple-600'
  },
  {
    id: 'walt',
    name: 'Walt',
    title: 'The Zen Master',
    stage: '35+ Years',
    image: '/personas/walt.jpg',
    color: 'bg-amber-600'
  }
];

export default function Welcome() {
  const { user, loading } = useAuth();
  const navigate = useNavigate();

  // Smart Redirect: If user is already logged in, skip the splash page
  useEffect(() => {
    if (!loading && user) {
      navigate('/dashboard');
    }
  }, [user, loading, navigate]);

  if (loading) return null; // Avoid flicker

  return (
    <div className="min-h-[100dvh] flex flex-col bg-slate-50">
      
      {/* HEADER SECTION */}
      <div className="bg-white px-6 pt-12 pb-8 rounded-b-[2.5rem] shadow-sm border-b border-slate-100 z-10">
        <div className="max-w-md mx-auto text-center space-y-4">
          <div className="mx-auto w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200">
            <ShieldCheckIcon className="h-9 w-9 text-white" />
          </div>
          <h1 className="text-3xl font-black text-slate-900 tracking-tight">
            My Recovery Toolkit
          </h1>
          <p className="text-slate-500 text-sm leading-relaxed font-medium">
            Your digital companion for the journey home.<br />
            From Day 1 to Year 35, we meet you where you are.
          </p>
        </div>
      </div>

      {/* PATHFINDER GRID (Bento Layout) */}
      <div className="flex-1 overflow-y-auto px-4 py-8">
        <div className="max-w-md mx-auto grid grid-cols-2 gap-4">
          {PERSONAS.map((persona) => (
            <div 
              key={persona.id}
              className="group relative aspect-[4/5] rounded-2xl overflow-hidden shadow-md border border-slate-200 bg-white"
            >
              {/* Image Placeholder / Fallback */}
              <div className={`absolute inset-0 ${persona.color} opacity-10 group-hover:opacity-20 transition-opacity`} />
              <img 
                src={persona.image} 
                alt={persona.name}
                className="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-90"
                onError={(e) => {
                  // Fallback if image missing during dev
                  (e.target as HTMLImageElement).style.display = 'none'; 
                }}
              />
              
              {/* Text Overlay */}
              <div className="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent p-4 flex flex-col justify-end text-white">
                <div className={`w-fit px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide mb-1 ${persona.color}`}>
                  {persona.stage}
                </div>
                <h3 className="font-bold text-lg leading-none">{persona.name}</h3>
                <p className="text-xs text-slate-300 font-medium truncate">{persona.title}</p>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* FOOTER CTA */}
      <div className="bg-white p-4 border-t border-slate-100 safe-area-bottom">
        <div className="max-w-md mx-auto flex flex-col gap-3">
          <button
            onClick={() => navigate('/login')}
            className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-xl shadow-slate-200 hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-2"
          >
            <span>Begin Your Journey</span>
            <ArrowRightIcon className="h-5 w-5" />
          </button>
          
          <p className="text-center text-xs text-slate-400 font-medium">
            Secure ‚Ä¢ Private ‚Ä¢ Encrypted
          </p>
        </div>
      </div>

    </div>
  );
}
--- END_FILE: src/pages/Welcome.tsx ---

--- START_FILE: src/pages/WorkbookDetail.tsx ---
import { useState, useEffect, Fragment, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, query, where, getDocs } from 'firebase/firestore';
import { getWorkbook, type WorkbookSection } from '../data/workbooks';
import { analyzeWorkbookContent, type WorkbookAnalysisResult } from '../lib/gemini';
import { addTask } from '../lib/tasks';
import { saveInsight } from '../lib/insights';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
    ArrowLeftIcon, 
    PlayCircleIcon, 
    CheckCircleIcon, 
    SparklesIcon,
    ArrowPathIcon,
    PlusCircleIcon,
    LightBulbIcon,
    ShieldExclamationIcon,
    AcademicCapIcon,
    BookmarkIcon,
    BookOpenIcon
} from '@heroicons/react/24/outline';
import { Dialog, Transition, RadioGroup } from '@headlessui/react';

// Define a proper interface for workbook answer data to avoid 'any'
interface WorkbookAnswer {
  workbookId: string;
  sectionId: string;
  questionId: string;
  answer: string;
  uid: string;
}

export default function WorkbookDetail() {
  const { workbookId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const workbook = getWorkbook(workbookId || '');

  // Data State
  const [completedCounts, setCompletedCounts] = useState<Record<string, number>>({});
  const [loading, setLoading] = useState(true);

  // Analysis State
  const [showWizard, setShowWizard] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisScope, setAnalysisScope] = useState<'section' | 'workbook' | 'global'>('section');
  const [selectedSectionId, setSelectedSectionId] = useState<string>(workbook?.sections[0]?.id || '');
  const [insight, setInsight] = useState<WorkbookAnalysisResult | null>(null);
  const [addedActions, setAddedActions] = useState<Set<string>>(new Set());
  const [savingInsight, setSavingInsight] = useState(false);

  // loadProgress wrapped in useCallback to stabilize the dependency for useEffect
  const loadProgress = useCallback(async () => {
    if (!user || !workbook || !db) return;
    
    try {
        const q = query(
            collection(db, 'users', user.uid, 'workbook_answers'),
            where('workbookId', '==', workbook.id)
        );
        
        const snapshot = await getDocs(q);
        const counts: Record<string, number> = {};

        snapshot.docs.forEach(docSnap => {
            const data = docSnap.data();
            if (data.sectionId) {
                counts[data.sectionId] = (counts[data.sectionId] || 0) + 1;
            }
        });

        setCompletedCounts(counts);
    } catch (error) {
        console.error("Error loading progress:", error);
    } finally {
        setLoading(false);
    }
  }, [user, workbook]);

  useEffect(() => {
    loadProgress();
  }, [loadProgress]);

  // --- AI ANALYSIS LOGIC ---

  const handleAnalyze = async () => {
    if (!user || !workbook || !db) return;

    setAnalyzing(true);
    setInsight(null);
    setAddedActions(new Set());
    setSavingInsight(false);

    try {
        let docsToAnalyze: WorkbookAnswer[] = [];
        let contextTitle = "";

        if (analysisScope === 'section') {
            const q = query(
                collection(db, 'users', user.uid, 'workbook_answers'),
                where('workbookId', '==', workbook.id),
                where('sectionId', '==', selectedSectionId)
            );
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            const sec = workbook.sections.find(s => s.id === selectedSectionId);
            contextTitle = sec ? sec.title : "Section Review";

        } else if (analysisScope === 'workbook') {
            const q = query(
                collection(db, 'users', user.uid, 'workbook_answers'),
                where('workbookId', '==', workbook.id)
            );
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            contextTitle = workbook.title;
        } else {
            // Global (Careful with large datasets in production)
            const q = collection(db, 'users', user.uid, 'workbook_answers');
            const snap = await getDocs(q);
            docsToAnalyze = snap.docs.map(d => d.data() as WorkbookAnswer);
            contextTitle = "Global Recovery Review";
        }

        if (docsToAnalyze.length === 0) {
            alert("No entries found for this selection. Try completing some questions first.");
            setAnalyzing(false);
            return;
        }

        const textContent = docsToAnalyze.map(d => `Question: ${d.questionId}\nAnswer: ${d.answer}`).join('\n\n');
        
        // FIX 1: Pass contextTitle to the AI function so it's used
        const result = await analyzeWorkbookContent(contextTitle, [{ question: "Combined Context", answer: textContent }]);
        
        if (result) {
            setInsight(result);
            setShowWizard(false);
            setShowResult(true);
        } else {
            alert("Analysis failed. Please try again.");
        }

    } catch (error) {
        console.error(error);
        alert("An error occurred during analysis.");
    } finally {
        setAnalyzing(false);
    }
  };

  const handleSaveLog = async () => {
    if (!user || !insight) return;
    setSavingInsight(true);
    try {
        // FIX 2: Explicitly add 'type: workbook' to match InsightPayload
        await saveInsight(user.uid, { type: 'workbook', ...insight });
        setSavingInsight(false); 
        // Optional: Add toast here
    } catch (error) {
        console.error("Failed to save log", error);
        setSavingInsight(false);
    }
  };

  const handleAddToHabits = async (action: string) => {
    if (!user) return;
    try {
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 3);
        await addTask(user.uid, action, 'once', 'High', dueDate);
        setAddedActions(prev => new Set(prev).add(action));
    } catch (e) {
        console.error(e);
    }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading workbook...</div>;
  if (!workbook) return <div className="p-8 text-center text-gray-500">Workbook not found.</div>;

  // Calculate mastery for header
  const totalWorkbookQuestions = workbook.sections.reduce((acc, sec) => acc + sec.questions.filter(q => q.type !== 'read_only').length, 0);
  const totalAnswered = Object.values(completedCounts).reduce((a, b) => a + b, 0);
  const mastery = totalWorkbookQuestions > 0 ? Math.round((totalAnswered / totalWorkbookQuestions) * 100) : 0;

  return (
    <div className={`h-[100dvh] flex flex-col ${THEME.workbooks.page}`}>
      
      {/* 1. FIXED HEADER */}
      <div className="flex-shrink-0 z-10">
        <VibrantHeader 
            title={workbook.title}
            subtitle="Guided Recovery Journey"
            icon={BookOpenIcon}
            fromColor={THEME.workbooks.header.from}
            viaColor={THEME.workbooks.header.via}
            toColor={THEME.workbooks.header.to}
            percentage={mastery}
            percentageColor={THEME.workbooks.ring}
        />
        
        {/* Back Button (Floating on top of header) */}
        <button 
            onClick={() => navigate('/workbooks')}
            className="absolute top-4 left-16 z-20 text-white/80 hover:text-white flex items-center gap-1 text-sm font-medium"
        >
            <ArrowLeftIcon className="h-4 w-4" /> Back
        </button>
      </div>

      {/* 2. SCROLLABLE CONTENT */}
      <div className="flex-1 overflow-y-auto px-4 py-6 space-y-4 pb-24">
          <div className="bg-white/60 backdrop-blur-sm p-4 rounded-xl border border-emerald-100 text-sm text-emerald-900 mb-6">
              {workbook.description}
          </div>

          {workbook.sections.map((section: WorkbookSection) => {
              const answeredCount = completedCounts[section.id] || 0;
              const totalQuestions = section.questions.filter(q => q.type !== 'read_only').length;
              const isComplete = totalQuestions > 0 && answeredCount >= totalQuestions;
              const progressPercent = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

              return (
                  <div key={section.id} className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:border-emerald-300 transition-all group">
                      <div className="flex items-center justify-between">
                          <div className="flex-1">
                             <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                                  {section.title}
                                  {isComplete && <CheckCircleIcon className="h-5 w-5 text-green-500" />}
                             </h3>
                              <p className="text-sm text-gray-500 line-clamp-1">{section.description}</p>
                              
                             <div className="mt-3 w-full max-w-xs bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                  <div className={`h-full transition-all ${isComplete ? 'bg-emerald-500' : 'bg-blue-600'}`} style={{ width: `${progressPercent}%` }} />
                              </div>
                              <p className="text-xs text-gray-400 mt-1">{answeredCount} / {totalQuestions} completed</p>
                          </div>

                          <button 
                             onClick={() => navigate(`/workbooks/${workbook.id}/session/${section.id}`)}
                             className={`p-3 rounded-full transition-all ${isComplete ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}
                          >
                              {isComplete ? <ArrowPathIcon className="h-6 w-6" /> : <PlayCircleIcon className="h-6 w-6" />}
                          </button>
                      </div>
                  </div>
              );
          })}
      </div>

      {/* FAB: Consult Compass */}
      <button
        onClick={() => setShowWizard(true)}
        className="fixed bottom-6 right-4 bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-4 rounded-full shadow-lg shadow-emerald-500/30 hover:scale-105 transition-all z-30 flex items-center gap-2 group"
      >
        <SparklesIcon className="h-6 w-6 group-hover:animate-pulse" />
        <span className="hidden group-hover:inline text-sm font-bold pr-1">Consult Compass</span>
      </button>

      {/* --- WIZARD MODAL (Scope Selection) --- */}
      <Transition appear show={showWizard} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowWizard(false)}>
          <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          <div className="fixed inset-0 flex items-center justify-center p-4">
            <Dialog.Panel className="w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all">
               <Dialog.Title className="text-lg font-bold text-gray-900 flex items-center gap-2 mb-4">
                  <SparklesIcon className="h-6 w-6 text-purple-600" />
                  Ask the Recovery Compass
              </Dialog.Title>

              <div className="space-y-4">
                   <RadioGroup value={analysisScope} onChange={setAnalysisScope} className="space-y-3">
                      <RadioGroup.Option value="section" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Specific Section</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>

                      {analysisScope === 'section' && (
                          <div className="ml-4 pl-4 border-l-2 border-gray-100">
                              <select value={selectedSectionId} onChange={(e) => setSelectedSectionId(e.target.value)} className="w-full text-sm border-gray-300 rounded-lg">
                                   {workbook.sections.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                              </select>
                          </div>
                      )}

                      <RadioGroup.Option value="workbook" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Full Workbook</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>

                      <RadioGroup.Option value="global" className={({ checked }) => `relative flex cursor-pointer rounded-lg px-5 py-4 shadow-md focus:outline-none ${checked ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'}`}>
                          {({ checked }) => (
                              <div className="flex w-full items-center justify-between">
                                   <div className="text-sm">
                                      <RadioGroup.Label as="p" className={`font-medium ${checked ? 'text-white' : 'text-gray-900'}`}>Global Review</RadioGroup.Label>
                                  </div>
                                   {checked && <CheckCircleIcon className="h-6 w-6 text-white" />}
                              </div>
                          )}
                      </RadioGroup.Option>
                  </RadioGroup>

                  <div className="mt-6 flex justify-end gap-3">
                      <button onClick={() => setShowWizard(false)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">Cancel</button>
                      <button onClick={handleAnalyze} disabled={analyzing} className="px-6 py-2 bg-purple-600 text-white rounded-lg text-sm font-bold hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2">
                          {analyzing ? <ArrowPathIcon className="h-4 w-4 animate-spin" /> : <SparklesIcon className="h-4 w-4" />}
                          Analyze Now
                      </button>
                  </div>
              </div>
          </Dialog.Panel>
          </div>
        </Dialog>
      </Transition>

      {/* --- RESULT MODAL --- */}
      <Transition appear show={showResult} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowResult(false)}>
          <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
          <div className="fixed inset-0 overflow-y-auto">
            
             <div className="flex min-h-full items-center justify-center p-4">
              <Dialog.Panel className="w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white p-6 shadow-xl transition-all">
                  {insight && (
                      <div className="space-y-6">
                          <div className="flex justify-between items-start border-b border-gray-100 pb-4">
                              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                                  <SparklesIcon className="h-6 w-6 text-purple-600" />
                                  {insight.scope_context}
                              </h2>
                          </div>

                          <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                              <h5 className="text-xs font-bold text-gray-500 uppercase mb-2">Summary</h5>
                              <p className="text-sm text-gray-700 leading-relaxed">{insight.summary}</p>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                               <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                  <div className="flex items-center gap-2 mb-2 text-blue-800 font-bold text-xs uppercase tracking-wide">
                                       <AcademicCapIcon className="h-4 w-4" /> Understanding
                                  </div>
                                  <p className="text-sm text-blue-900 leading-relaxed">{insight.pillars.understanding}</p>
                              </div>
                              <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                  <div className="flex items-center gap-2 mb-2 text-orange-800 font-bold text-xs uppercase tracking-wide">
                                       <ShieldExclamationIcon className="h-4 w-4" /> Blind Spots
                                  </div>
                                   <p className="text-sm text-orange-900 leading-relaxed">{insight.pillars.blind_spots}</p>
                              </div>
                              <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                  <div className="flex items-center gap-2 mb-2 text-green-800 font-bold text-xs uppercase tracking-wide">
                                      <LightBulbIcon className="h-4 w-4" /> Growth
                                  </div>
                                   <p className="text-sm text-green-900 leading-relaxed">{insight.pillars.emotional_resonance}</p>
                              </div>
                          </div>

                          <div className="bg-purple-50 p-5 rounded-xl border border-purple-100">
                              <h3 className="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                  <CheckCircleIcon className="h-5 w-5" /> Suggested Action Steps
                              </h3>
                              <ul className="space-y-2">
                                  {insight.suggested_actions.map((action, idx) => {
                                       const isAdded = addedActions.has(action);
                                       return (
                                          <li key={idx} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-purple-100">
                                              <span className="text-sm text-gray-700 font-medium">{action}</span>
                                              <button 
                                                  onClick={() => !isAdded && handleAddToHabits(action)}
                                                  disabled={isAdded}
                                                  className={`p-1.5 rounded-full transition-all ${isAdded ? 'text-green-500 bg-green-50' : 'text-purple-400 hover:text-purple-600 hover:bg-purple-50'}`}
                                              >
                                                  {isAdded ? <CheckCircleIcon className="h-6 w-6" /> : <PlusCircleIcon className="h-6 w-6" />}
                                              </button>
                                           </li>
                                      );
                                  })}
                              </ul>
                          </div>

                          <div className="mt-6 flex justify-between pt-4 border-t border-gray-100">
                                {/* LEFT: SAVE LOG */}
                                <button 
                                    type="button" 
                                    disabled={savingInsight}
                                    onClick={handleSaveLog}
                                    className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors disabled:opacity-50"
                                >
                                    <BookmarkIcon className="h-4 w-4" />
                                    {savingInsight ? "Saving..." : "Save to Wisdom Log"}
                                </button>

                                {/* RIGHT: CLOSE */}
                                <button type="button" className="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors" onClick={() => setShowResult(false)}>
                                    Close
                                </button>
                          </div>
                      </div>
                  )}
              </Dialog.Panel>
            </div>
          </div>
        </Dialog>
      </Transition>

    </div>
  );
}
--- END_FILE: src/pages/WorkbookDetail.tsx ---

--- START_FILE: src/pages/WorkbookSession.tsx ---
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useEncryption } from '../contexts/EncryptionContext'; 
import { db } from '../lib/firebase';
import { doc, getDoc, setDoc, updateDoc, arrayUnion, Timestamp } from 'firebase/firestore';
import { 
  ChevronLeftIcon, 
  CheckCircleIcon, 
  ArrowRightIcon,
  SparklesIcon,
  BookOpenIcon // Added for Intro Slide
} from '@heroicons/react/24/outline';
import { getWorkbook, type Workbook, type WorkbookSection } from '../data/workbooks';
import { getGeminiCoaching } from '../lib/gemini';

// Type definition for stored answers
type AnswerValue = string | { text: string; isEncrypted: boolean; updatedAt?: Timestamp };

export default function WorkbookSession() {
  const { workbookId, sectionId } = useParams();
  const { user } = useAuth();
  const { encrypt, decrypt } = useEncryption(); 
  const navigate = useNavigate();

  // Content State
  const [workbook, setWorkbook] = useState<Workbook | null>(null);
  const [section, setSection] = useState<WorkbookSection | null>(null);
  const [loading, setLoading] = useState(true);

  // User Progress State
  const [answers, setAnswers] = useState<Record<string, string>>({});
  
  // UI State
  const [activeQuestionIndex, setActiveQuestionIndex] = useState(0);
  const [saving, setSaving] = useState(false);
  const [aiCoachLoading, setAiCoachLoading] = useState(false);
  const [aiFeedback, setAiFeedback] = useState<string | null>(null);

  // 1. Load Workbook Content & User Progress
  useEffect(() => {
    async function loadData() {
      if (!user || !workbookId || !sectionId || !db) return;

      try {
        // A. Load Static Workbook JSON
        const wb = getWorkbook(workbookId || '');
        
        if (!wb) {
          console.warn(`Workbook not found: ${workbookId}`);
          navigate('/workbooks');
          return;
        }
        setWorkbook(wb);

        const sec = wb.sections.find(s => s.id === sectionId);
        if (!sec) {
           console.warn(`Section not found: ${sectionId}`);
           navigate(`/workbooks/${workbookId}`);
           return;
        }
        setSection(sec);

        // B. Load User Progress from Firestore
        const progressRef = doc(db, 'users', user.uid, 'workbook_progress', workbookId);
        const snap = await getDoc(progressRef);

        if (snap.exists()) {
          const data = snap.data();
          
          // DECRYPTION LOGIC
          const rawAnswers = data.answers || {};
          const decryptedAnswers: Record<string, string> = {};

          for (const [qId, val] of Object.entries(rawAnswers)) {
             const answerVal = val as AnswerValue;
             
             if (typeof answerVal === 'object' && answerVal !== null && 'isEncrypted' in answerVal && answerVal.isEncrypted) {
                 try {
                     decryptedAnswers[qId] = await decrypt(answerVal.text);
                 } catch (e) {
                     console.error(`Failed to decrypt answer for ${qId}`, e);
                     decryptedAnswers[qId] = "üîí [Error Decrypting Data]";
                 }
             } else if (typeof answerVal === 'object' && answerVal !== null && 'text' in answerVal) {
                 decryptedAnswers[qId] = answerVal.text;
             } else if (typeof answerVal === 'string') {
                 decryptedAnswers[qId] = answerVal;
             }
          }
          setAnswers(decryptedAnswers);
        }

      } catch (error) {
        console.error("Error loading session:", error);
      } finally {
        setLoading(false);
      }
    }
    loadData();
  }, [user, workbookId, sectionId, navigate, decrypt]);

  // 2. Handle Answer Input
  const handleAnswerChange = (text: string) => {
    if (!section) return;
    const qId = section.questions[activeQuestionIndex].id;
    setAnswers(prev => ({
      ...prev,
      [qId]: text
    }));
  };

  // 3. Save Answer (with Encryption)
  const saveAnswer = async (qId: string, text: string) => {
    if (!user || !workbookId || !db) return;
    
    try {
        const progressRef = doc(db, 'users', user.uid, 'workbook_progress', workbookId);
        
        // ENCRYPTION LOGIC
        let payloadValue: AnswerValue;
        try {
            const encryptedText = await encrypt(text);
            payloadValue = {
                text: encryptedText,
                isEncrypted: true,
                updatedAt: Timestamp.now()
            };
        } catch (e) {
            console.error("Encryption failed", e);
            alert("Security Error: Could not encrypt answer. Save aborted.");
            return;
        }

        await setDoc(progressRef, {
            answers: {
                [qId]: payloadValue 
            },
            lastActive: Timestamp.now(),
            lastSectionId: sectionId
        }, { merge: true });

    } catch (e) {
        console.error("Failed to save answer:", e);
    }
  };

  // 4. Navigation & Completion
  const handleNext = async () => {
    if (!section || !workbookId || !user || !db) return;
    
    const currentQ = section.questions[activeQuestionIndex];
    
    // Only save if it's NOT a read-only slide
    if (currentQ.type !== 'read_only') {
        const currentAns = answers[currentQ.id];
        setSaving(true);
        if (currentAns) {
            await saveAnswer(currentQ.id, currentAns);
        }
    }

    if (activeQuestionIndex < section.questions.length - 1) {
        setActiveQuestionIndex(prev => prev + 1);
        setAiFeedback(null); 
    } else {
        await updateDoc(doc(db, 'users', user.uid, 'workbook_progress', workbookId), {
            completedSections: arrayUnion(sectionId)
        });
        navigate(`/workbooks/${workbookId}`);
    }
    setSaving(false);
  };

  const handlePrevious = () => {
    if (activeQuestionIndex > 0) {
        setActiveQuestionIndex(prev => prev - 1);
        setAiFeedback(null);
    }
  };

  const handleGetCoaching = async () => {
      if (!section) return;
      const q = section.questions[activeQuestionIndex];
      const ans = answers[q.id];
      if (!ans || ans.length < 10) return alert("Please write a bit more before asking for coaching.");

      setAiCoachLoading(true);
      try {
          const qContext = q.context || q.text; 
          const feedback = await getGeminiCoaching(qContext, ans);
          setAiFeedback(feedback);
      } catch (error) {
          console.error(error);
          alert("Coach is currently unavailable.");
      } finally {
          setAiCoachLoading(false);
      }
  };


  if (loading || !section) return <div className="p-8 text-center text-gray-500">Loading Session...</div>;

  const currentQuestion = section.questions[activeQuestionIndex];
  const progressPercent = ((activeQuestionIndex) / section.questions.length) * 100;
  
  // Check if this is an Intro Slide
  const isIntroSlide = currentQuestion.type === 'read_only';

  return (
    <div className="max-w-3xl mx-auto px-4 pb-20">
        
        {/* NAV HEADER */}
        <div className="flex items-center gap-4 py-6">
            <button onClick={() => navigate(`/workbooks/${workbookId}`)} className="p-2 hover:bg-gray-100 rounded-full text-gray-500">
                <ChevronLeftIcon className="h-6 w-6" />
            </button>
            <div className="flex-1">
                <h1 className="text-sm font-bold text-gray-500 uppercase tracking-wider">{workbook?.title}</h1>
                <h2 className="text-xl font-bold text-gray-900">{section.title}</h2>
            </div>
        </div>

        {/* PROGRESS BAR */}
        <div className="w-full bg-gray-100 h-2 rounded-full mb-8">
            <div 
                className="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-out" 
                style={{ width: `${progressPercent}%` }}
            />
        </div>

        {/* QUESTION CARD */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[60vh] flex flex-col transition-all">
            
            {isIntroSlide ? (
                // --- INTRO SLIDE LAYOUT ---
                <div className="flex-1 flex flex-col items-center justify-center p-10 text-center animate-fadeIn">
                    <div className="bg-blue-50 p-6 rounded-full mb-6">
                        <BookOpenIcon className="h-16 w-16 text-blue-600" />
                    </div>
                    
                    <div className="max-w-xl space-y-6">
                        <h3 className="text-3xl font-black text-gray-900 leading-tight">
                            {section.title}
                        </h3>
                        <div className="w-16 h-1 bg-blue-500 mx-auto rounded-full" />
                        <div className="text-gray-600 text-lg leading-relaxed whitespace-pre-wrap">
                            {currentQuestion.text}
                        </div>
                    </div>
                </div>
            ) : (
                // --- STANDARD QUESTION LAYOUT ---
                <>
                    <div className="p-6 md:p-8 bg-gray-50 border-b border-gray-100">
                        <span className="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold mb-4">
                            Question {activeQuestionIndex} of {section.questions.length - 1} {/* Offset for intro */}
                        </span>
                        <h3 className="text-xl md:text-2xl font-bold text-gray-900 leading-relaxed">
                            {currentQuestion.text}
                        </h3>
                        {currentQuestion.context && (
                            <div className="mt-4 p-3 bg-blue-50/50 rounded-lg border border-blue-100 text-sm text-blue-800 italic flex gap-3">
                                <SparklesIcon className="h-5 w-5 shrink-0" />
                                <span>{currentQuestion.context}</span>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 p-6 md:p-8 flex flex-col">
                        <textarea
                            className="flex-1 w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-lg text-gray-700 leading-relaxed bg-white"
                            placeholder="Type your answer here..."
                            value={answers[currentQuestion.id] || ''}
                            onChange={(e) => handleAnswerChange(e.target.value)}
                        />
                        
                        {/* AI COACHING AREA */}
                        {aiFeedback && (
                            <div className="mt-6 bg-purple-50 p-4 rounded-xl border border-purple-100 animate-fadeIn">
                                <div className="flex items-center gap-2 mb-2 text-purple-800 font-bold">
                                    <SparklesIcon className="h-5 w-5" />
                                    <span>Coach's Insight</span>
                                </div>
                                <div className="prose prose-sm text-purple-900 max-w-none whitespace-pre-wrap leading-relaxed">
                                    {aiFeedback}
                                </div>
                            </div>
                        )}
                    </div>
                </>
            )}

            {/* FOOTER CONTROLS */}
            <div className="p-4 border-t border-gray-100 bg-gray-50 flex items-center justify-between">
                <button
                    onClick={handlePrevious}
                    disabled={activeQuestionIndex === 0}
                    className="px-6 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-200 disabled:opacity-30 disabled:hover:bg-transparent transition-colors"
                >
                    Back
                </button>

                <div className="flex gap-2">
                    {!isIntroSlide && (
                        <button
                            onClick={handleGetCoaching}
                            disabled={aiCoachLoading || !answers[currentQuestion.id]}
                            className="hidden sm:flex items-center gap-2 px-4 py-3 rounded-xl text-purple-700 bg-purple-100 hover:bg-purple-200 font-medium transition-colors disabled:opacity-50"
                            title="Get AI feedback on your answer"
                        >
                            {aiCoachLoading ? <SparklesIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />}
                            <span>AI Coach</span>
                        </button>
                    )}

                    <button
                        onClick={handleNext}
                        disabled={saving}
                        className="flex items-center gap-2 px-8 py-3 rounded-xl bg-gray-900 text-white font-bold hover:bg-black transition-all shadow-lg hover:shadow-xl active:scale-95"
                    >
                        {saving ? (
                            <span>Saving...</span>
                        ) : activeQuestionIndex === section.questions.length - 1 ? (
                            <>
                                <span>Complete</span>
                                <CheckCircleIcon className="h-5 w-5" />
                            </>
                        ) : isIntroSlide ? (
                            <>
                                <span>Begin Section</span>
                                <ArrowRightIcon className="h-5 w-5" />
                            </>
                        ) : (
                            <>
                                <span>Next</span>
                                <ArrowRightIcon className="h-5 w-5" />
                            </>
                        )}
                    </button>
                </div>
            </div>

        </div>
    </div>
  );
}
--- END_FILE: src/pages/WorkbookSession.tsx ---

--- START_FILE: src/pages/Workbooks.tsx ---
import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import { WORKBOOKS } from '../data/workbooks';
import VibrantHeader from '../components/VibrantHeader';
import { THEME } from '../lib/theme';
import { 
    BookOpenIcon, 
    StarIcon, 
    HeartIcon, 
    AcademicCapIcon,
    SparklesIcon,
    FireIcon,
    ChevronRightIcon
} from '@heroicons/react/24/outline';

export default function Workbooks() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
      activeCount: 0,
      wisdomScore: 0,
      mastery: 0
  });

  useEffect(() => {
    async function loadStats() {
        if (!user || !db) return;
        
        try {
            const colRef = collection(db, 'users', user.uid, 'workbook_answers');
            const snapshot = await getDocs(colRef);
            
            const wisdomScore = snapshot.size;

            const uniqueWorkbooks = new Set<string>();
            snapshot.docs.forEach(doc => {
                const [wbId] = doc.id.split('_');
                if (wbId) uniqueWorkbooks.add(wbId);
            });
            const activeCount = uniqueWorkbooks.size;

            const TOTAL_ESTIMATED_QUESTIONS = 45; 
            const mastery = Math.min(100, Math.round((wisdomScore / TOTAL_ESTIMATED_QUESTIONS) * 100));

            setStats({ activeCount, wisdomScore, mastery });
        } catch (error) {
            console.error("Failed to load workbook stats", error);
        } finally {
            setLoading(false);
        }
    }
    loadStats();
  }, [user]);

  const getTheme = (type: string) => {
    switch (type) {
      case 'general': return { color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-l-yellow-500', icon: StarIcon };
      case 'steps': return { color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-l-blue-600', icon: BookOpenIcon };
      default: return { color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-l-purple-500', icon: HeartIcon };
    }
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your library...</div>;

  return (
    <div className={`pb-24 relative min-h-screen ${THEME.workbooks.page}`}>
      
      {/* HEADER */}
      <VibrantHeader 
        title="Recovery Library"
        subtitle="Structured guides to process your journey."
        icon={AcademicCapIcon}
        fromColor={THEME.workbooks.header.from}
        viaColor={THEME.workbooks.header.via}
        toColor={THEME.workbooks.header.to}
        percentage={stats.mastery}
        percentageColor={THEME.workbooks.ring}
      />

      <div className="max-w-4xl mx-auto px-4 -mt-10 relative z-30 space-y-6">
        
        <div className="grid grid-cols-3 gap-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Active</span>
                <span className="text-2xl font-bold text-gray-900">{stats.activeCount}</span>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Wisdom Score</span>
                <div className="flex items-center gap-1 text-2xl font-bold text-cyan-600">
                    <SparklesIcon className="h-6 w-6" />
                    {stats.wisdomScore}
                </div>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Mastery</span>
                <div className="flex items-center gap-1 text-2xl font-bold text-indigo-600">
                    <FireIcon className="h-6 w-6" />
                    {stats.mastery}%
                </div>
            </div>
        </div>

        <div className="space-y-4">
          {WORKBOOKS.map((workbook) => {
              const theme = getTheme(workbook.type);
              
              return (
                  <Link 
                      key={workbook.id} 
                      to={`/workbooks/${workbook.id}`}
                      className={`block relative group bg-white rounded-xl p-5 shadow-sm border border-gray-200 transition-all hover:shadow-md ${theme.border} border-l-[6px]`}
                  >
                      <div className="flex items-start gap-4">
                          <div className={`flex-shrink-0 h-10 w-10 rounded-lg flex items-center justify-center ${theme.bg} ${theme.color}`}>
                              <theme.icon className="h-6 w-6" />
                          </div>
                          <div className="flex-1 min-w-0">
                              <div className="flex items-center justify-between mb-1">
                                  <h3 className="text-lg font-bold text-gray-900 group-hover:text-blue-700 transition-colors">
                                      {workbook.title}
                                  </h3>
                                  <ChevronRightIcon className="h-5 w-5 text-gray-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
                              </div>
                              <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                                  {workbook.description}
                              </p>
                              <div className="flex items-center gap-3">
                                  <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${theme.bg} ${theme.color} border-transparent`}>
                                      {workbook.sections.length} Sections
                                  </span>
                                  {workbook.type === 'steps' && (
                                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                          12-Step Compatible
                                      </span>
                                  )}
                              </div>
                          </div>
                      </div>
                  </Link>
              );
          })}
        </div>
      </div>
    </div>
  );
}
--- END_FILE: src/pages/Workbooks.tsx ---

--- START_FILE: src/test/setup.ts ---
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// Runs a cleanup after each test case (e.g. clearing jsdom)
afterEach(() => {
  cleanup();
});
--- END_FILE: src/test/setup.ts ---

--- START_FILE: src/vite-env.d.ts ---
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_FIREBASE_API_KEY: string;
  readonly VITE_FIREBASE_AUTH_DOMAIN: string;
  readonly VITE_FIREBASE_PROJECT_ID: string;
  readonly VITE_FIREBASE_STORAGE_BUCKET: string;
  readonly VITE_FIREBASE_MESSAGING_SENDER_ID: string;
  readonly VITE_FIREBASE_APP_ID: string;
  readonly VITE_APP_VERSION: string; // NEW
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
--- END_FILE: src/vite-env.d.ts ---

--- START_FILE: tailwind.config.js ---
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Unified Blue Theme (from Master Tech Doc)
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8', // Primary Brand Color
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    },
  },
  plugins: [],
}
--- END_FILE: tailwind.config.js ---

--- START_FILE: tsconfig.app.json ---
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}

--- END_FILE: tsconfig.app.json ---

--- START_FILE: tsconfig.json ---
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ],
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"],
    // ... existing options
  }
}

--- END_FILE: tsconfig.json ---

--- START_FILE: tsconfig.node.json ---
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

--- END_FILE: tsconfig.node.json ---
