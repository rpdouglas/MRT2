PROJECT EXPORT - 2025-12-20T06:16:13.404Z


================================================================================
FILE: package.json
================================================================================
{
  "name": "mrt2",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@headlessui/react": "^2.2.9",
    "@heroicons/react": "^2.2.0",
    "date-fns": "^4.1.0",
    "firebase": "^12.6.0",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-confetti": "^6.4.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "clsx": "^2.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "3.4",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0"
  }
}


================================================================================
FILE: vite.config.ts
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

icons: [
          {
            // Note: The generator usually names them like this
            src: 'pwa-192x192.png', 
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable' // 'maskable' ensures it fills the circle on Android
          }
        ]

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


================================================================================
FILE: check_models.js
================================================================================
import fs from 'fs';
import path from 'path';

async function check() {
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    if (!fs.existsSync(envPath)) {
      console.error("‚ùå Error: Could not find .env file.");
      process.exit(1);
    }

    const envContent = fs.readFileSync(envPath, 'utf8');
    const match = envContent.match(/VITE_GEMINI_API_KEY=(.*)/);
    
    if (!match || !match[1]) {
      console.error("‚ùå Error: VITE_GEMINI_API_KEY not found in .env");
      process.exit(1);
    }

    // SANITIZATION: Remove spaces AND quotes (" or ') from the key
    const rawKey = match[1].trim();
    const apiKey = rawKey.replace(/^["']|["']$/g, ''); 

    console.log(`üîë Testing Key: ${apiKey.substring(0, 6)}... (Length: ${apiKey.length})`);

    // Query Google
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API Error ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    const contentModels = data.models.filter(m => 
      m.supportedGenerationMethods.includes("generateContent")
    );

    console.log("\n‚úÖ SUCCESS! HERE ARE YOUR AVAILABLE MODELS:");
    console.table(contentModels.map(m => ({
      name: m.name.replace('models/', ''), // Use THIS string in your code
      version: m.version,
      displayName: m.displayName
    })));

  } catch (error) {
    console.error("‚ùå Failed:", error.message);
  }
}

check();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}

================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Recovery Toolkit</title>
    <meta name="description" content="Your digital companion for recovery.">
    <meta name="theme-color" content="#2A9D8F">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: postcss.config.js
================================================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: src/App.css
================================================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE: src/App.tsx
================================================================================
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import Journal from './pages/Journal';
import Tasks from './pages/Tasks';
import Profile from './pages/Profile';
import Workbooks from './pages/Workbooks'; 
import WorkbookDetail from './pages/WorkbookDetail'; 
import WorkbookSession from './pages/WorkbookSession'; 
import Vitality from './pages/Vitality'; // NEW IMPORT
import TemplateEditor from './components/journal/TemplateEditor'; 
import AppShell from './components/AppShell';

function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  
  if (loading) return <div>Loading...</div>;
  
  if (!user) {
    return <Navigate to="/login" />;
  }

  return <AppShell>{children}</AppShell>;
}

export default function App() {
  return (
    <AuthProvider>
      <Router>
        <Routes>
          <Route path="/login" element={<Login />} />
          
          <Route
            path="/dashboard"
            element={
              <PrivateRoute>
                <Dashboard />
              </PrivateRoute>
            }
          />
          <Route
            path="/journal"
            element={
              <PrivateRoute>
                <Journal />
              </PrivateRoute>
            }
          />
          <Route
            path="/tasks"
            element={
              <PrivateRoute>
                <Tasks />
              </PrivateRoute>
            }
          />
          
          {/* --- WORKBOOK ROUTES --- */}
          <Route
            path="/workbooks"
            element={
              <PrivateRoute>
                <Workbooks />
              </PrivateRoute>
            }
          />
          <Route
            path="/workbooks/:workbookId"
            element={
              <PrivateRoute>
                <WorkbookDetail />
              </PrivateRoute>
            }
          />
          <Route
            path="/workbooks/:workbookId/session/:sectionId"
            element={
              <PrivateRoute>
                <WorkbookSession />
              </PrivateRoute>
            }
          />
          
          {/* --- VITALITY ROUTE (NEW) --- */}
          <Route
            path="/vitality"
            element={
              <PrivateRoute>
                <Vitality />
              </PrivateRoute>
            }
          />

          {/* --- TEMPLATES ROUTE --- */}
          <Route
            path="/templates"
            element={
              <PrivateRoute>
                <TemplateEditor />
              </PrivateRoute>
            }
          />
          
          {/* ----------------------- */}
          <Route
            path="/profile"
            element={
              <PrivateRoute>
                <Profile />
              </PrivateRoute>
            }
          />
          
          <Route path="/" element={<Navigate to="/dashboard" />} />
          <Route path="*" element={<Navigate to="/dashboard" />} />
        </Routes>
      </Router>
    </AuthProvider>
  );
}

================================================================================
FILE: src/components/AppShell.tsx
================================================================================
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  Bars3Icon, 
  XMarkIcon, 
  HomeIcon, 
  BookOpenIcon, 
  UserCircleIcon,
  ArrowLeftOnRectangleIcon,
  ClipboardDocumentListIcon,
  AcademicCapIcon,
  HeartIcon // NEW IMPORT
} from '@heroicons/react/24/outline';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function AppShell({ children }: { children: React.ReactNode }) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const location = useLocation();
  const navigate = useNavigate();
  const { user, logout } = useAuth();

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { name: 'Journal', href: '/journal', icon: BookOpenIcon },
    { name: 'Vitality', href: '/vitality', icon: HeartIcon }, // NEW LINK
    { name: 'Tasks', href: '/tasks', icon: ClipboardDocumentListIcon },
    { name: 'Workbooks', href: '/workbooks', icon: AcademicCapIcon },
    { name: 'Profile', href: '/profile', icon: UserCircleIcon },
  ];

  const handleLogout = async () => {
    try {
      setSidebarOpen(false); // Ensure menu closes on logout too
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <Transition.Root show={sidebarOpen} as={Fragment}>
        <Dialog as="div" className="relative z-50 lg:hidden" onClose={setSidebarOpen}>
          <div className="fixed inset-0 bg-gray-900/80" />
          <div className="fixed inset-0 flex">
            <Dialog.Panel className="relative mr-16 flex w-full max-w-xs flex-1 transform flex-col bg-blue-600 transition-all">
               <div className="flex h-16 shrink-0 items-center justify-between px-6">
                  {/* Mobile Drawer Header */}
                  <div className="flex items-center gap-2">
                    <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
                    <span className="text-white font-bold text-2xl">My Recovery Toolkit</span>
                    <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
                  </div>
                  <button onClick={() => setSidebarOpen(false)} className="-m-2.5 p-2.5 text-blue-200 hover:text-white">
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
               </div>
               <nav className="flex flex-1 flex-col px-6 pb-4">
                 <ul role="list" className="flex flex-1 flex-col gap-y-7">
                   <li>
                     <ul role="list" className="-mx-2 space-y-1">
                       {navigation.map((item) => (
                         <li key={item.name}>
                           <Link
                             to={item.href}
                             onClick={() => setSidebarOpen(false)} // <--- CLOSE SIDEBAR ON CLICK
                             className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                               location.pathname === item.href
                                 ? 'bg-blue-700 text-white'
                                 : 'text-blue-200 hover:text-white hover:bg-blue-700'
                             }`}
                           >
                             <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                             {item.name}
                           </Link>
                         </li>
                       ))}
                     </ul>
                   </li>
                   
                   <li className="mt-auto">
                     <div className="flex flex-col gap-2">
                        {user && (
                            <div className="flex items-center gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-white bg-blue-700/50">
                                {user.photoURL ? (
                                    <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                                ) : (
                                    <UserCircleIcon className="h-8 w-8 text-blue-200" />
                                )}
                                <span className="sr-only">Your profile</span>
                                <span aria-hidden="true">{user.displayName || user.email}</span>
                            </div>
                        )}
                        <button
                          onClick={handleLogout}
                          className="group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                        >
                          <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                          Log out
                        </button>
                     </div>
                   </li>
                 </ul>
               </nav>
            </Dialog.Panel>
          </div>
        </Dialog>
      </Transition.Root>

      {/* Desktop sidebar */}
      <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col">
        <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-blue-600 px-6 pb-4">
          <div className="flex h-16 shrink-0 items-center justify-center gap-2">
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
            <span className="text-white font-bold text-2xl">My Recovery Toolkit</span>
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
          </div>
          <nav className="flex flex-1 flex-col">
            <ul role="list" className="flex flex-1 flex-col gap-y-7">
              <li>
                <ul role="list" className="-mx-2 space-y-1">
                  {navigation.map((item) => (
                    <li key={item.name}>
                      <Link
                        to={item.href}
                        className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                          location.pathname === item.href
                            ? 'bg-blue-700 text-white'
                            : 'text-blue-200 hover:text-white hover:bg-blue-700'
                        }`}
                      >
                        <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                        {item.name}
                      </Link>
                    </li>
                  ))}
                </ul>
              </li>

              <li className="mt-auto">
                 <div className="flex flex-col gap-2 border-t border-blue-500 pt-4">
                    {user && (
                        <div className="flex items-center gap-x-3 rounded-md px-2 py-2 text-sm font-semibold leading-6 text-white">
                            {user.photoURL ? (
                                <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                            ) : (
                                <UserCircleIcon className="h-8 w-8 text-blue-200" />
                            )}
                            <span className="sr-only">Your profile</span>
                            <span className="truncate" aria-hidden="true">{user.displayName || user.email}</span>
                        </div>
                    )}
                    <button
                      onClick={handleLogout}
                      className="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                    >
                      <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                      Log out
                    </button>
                 </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <div className="lg:pl-72">
        {/* MOBILE TOP BAR (UPDATED) */}
        <div className="sticky top-0 z-40 flex h-16 shrink-0 items-center justify-center border-b border-blue-700 bg-blue-600 px-4 shadow-sm lg:hidden">
          
          {/* Hamburger Button - Positioned Absolutely to left */}
          <button 
            type="button" 
            className="-m-2.5 p-2.5 text-blue-200 hover:text-white absolute left-4 z-50" 
            onClick={() => setSidebarOpen(true)}
          >
            <span className="sr-only">Open sidebar</span>
            <Bars3Icon className="h-6 w-6" aria-hidden="true" />
          </button>

          {/* Centered Title with Flanking Logos */}
          <div className="flex items-center gap-2">
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
            <div className="text-xl font-bold leading-6 text-white">My Recovery Toolkit</div>
            <img src="/favicon-32x32.png" alt="" className="h-8 w-8" />
          </div>

        </div>

        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/CreateTaskModal.tsx
================================================================================
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  XMarkIcon, 
  PlusIcon,
  CalendarDaysIcon,
  ArrowPathIcon,
  FlagIcon
} from '@heroicons/react/24/outline';
import { addTask, type Frequency, type Priority } from '../lib/tasks';
import { useAuth } from '../contexts/AuthContext';

interface CreateTaskModalProps {
  isOpen: boolean;
  onClose: () => void;
  onTaskAdded: () => void;
}

export default function CreateTaskModal({ isOpen, onClose, onTaskAdded }: CreateTaskModalProps) {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);

  // Form State
  const [title, setTitle] = useState('');
  const [priority, setPriority] = useState<Priority>('Medium');
  const [isRecurring, setIsRecurring] = useState(false);
  const [frequency, setFrequency] = useState<Frequency>('daily');
  const [dueDateStr, setDueDateStr] = useState(new Date().toISOString().split('T')[0]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !title.trim()) return;

    setLoading(true);
    try {
      // Convert input string to Date (noon to avoid TZ issues)
      const [y, m, d] = dueDateStr.split('-').map(Number);
      const dateObj = new Date(y, m - 1, d, 12, 0, 0);

      await addTask(
          user.uid, 
          title, 
          isRecurring ? frequency : 'once', 
          priority, 
          dateObj
      );
      
      // Reset & Close
      setTitle('');
      setIsRecurring(false);
      setPriority('Medium');
      setDueDateStr(new Date().toISOString().split('T')[0]);
      onTaskAdded();
      onClose();
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Transition.Root show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" />
        </Transition.Child>

        <div className="fixed inset-0 z-10 overflow-y-auto">
          <div className="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
              enterTo="opacity-100 translate-y-0 sm:scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 translate-y-0 sm:scale-100"
              leaveTo="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            >
              <Dialog.Panel className="relative transform overflow-hidden rounded-xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                
                {/* Close Button */}
                <div className="absolute right-0 top-0 hidden pr-4 pt-4 sm:block">
                  <button
                    type="button"
                    className="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none"
                    onClick={onClose}
                  >
                    <span className="sr-only">Close</span>
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
                </div>

                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <PlusIcon className="h-6 w-6 text-blue-600" aria-hidden="true" />
                  </div>
                  <div className="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                    <Dialog.Title as="h3" className="text-base font-semibold leading-6 text-gray-900">
                      Create New Quest
                    </Dialog.Title>
                    <div className="mt-2">
                      <p className="text-sm text-gray-500">
                        Add a new habit or task to your recovery ledger.
                      </p>
                    </div>

                    {/* FORM */}
                    <form onSubmit={handleSubmit} className="mt-6 space-y-5">
                        
                        {/* Title */}
                        <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">Task Name</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                placeholder="e.g. Call Sponsor, Gym, Meditate"
                                autoFocus
                            />
                        </div>

                        {/* Date & Priority Row */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <CalendarDaysIcon className="h-3 w-3" /> Due Date
                                </label>
                                <input 
                                    type="date"
                                    value={dueDateStr}
                                    onChange={(e) => setDueDateStr(e.target.value)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                />
                            </div>
                            <div>
                                {/* FIXED: Removed 'block' class, keeping 'flex' */}
                                <label className="flex items-center gap-1 text-xs font-medium text-gray-700 mb-1">
                                    <FlagIcon className="h-3 w-3" /> Priority
                                </label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value as Priority)}
                                    className="w-full rounded-lg border-gray-300 text-sm"
                                >
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>

                        {/* Recurring Toggle */}
                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    id="recurring"
                                    checked={isRecurring}
                                    onChange={(e) => setIsRecurring(e.target.checked)}
                                    className="rounded text-blue-600 focus:ring-blue-500"
                                />
                                <label htmlFor="recurring" className="text-sm text-gray-700 font-medium flex items-center gap-2">
                                    <ArrowPathIcon className="h-4 w-4 text-gray-400" />
                                    Make this a Recurring Habit?
                                </label>
                            </div>
                            
                            {isRecurring && (
                                <div className="mt-3 pl-6 animate-fadeIn">
                                    <label className="block text-xs font-medium text-gray-500 mb-1">Frequency</label>
                                    <div className="flex gap-2">
                                        {(['daily', 'weekly', 'monthly'] as Frequency[]).map((freq) => (
                                            <button
                                                key={freq}
                                                type="button"
                                                onClick={() => setFrequency(freq)}
                                                className={`px-3 py-1.5 text-xs font-medium rounded-md capitalize border transition-colors ${
                                                    frequency === freq 
                                                    ? 'bg-blue-100 text-blue-700 border-blue-200' 
                                                    : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                                                }`}
                                            >
                                                {freq}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Submit Button */}
                        <div className="mt-5 sm:mt-6">
                            <button
                                type="submit"
                                disabled={!title.trim() || loading}
                                className="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-50"
                            >
                                {loading ? 'Creating...' : 'Create Task'}
                            </button>
                        </div>
                    </form>

                  </div>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition.Root>
  );
}

================================================================================
FILE: src/components/RecoveryHero.tsx
================================================================================
import { Link } from 'react-router-dom';
import { 
    FireIcon, 
    ClipboardDocumentCheckIcon,
    ChartBarIcon, 
    SparklesIcon,
    BoltIcon,
    AcademicCapIcon,
    BookOpenIcon,
    ShieldCheckIcon
} from '@heroicons/react/24/outline';

interface RecoveryHeroProps {
    userName: string;
    daysClean: number;
    journalStats: {
        streak: number;
        consistency: number;
    };
    taskStats: {
        fire: number;
        rate: number;
    };
    workbookStats: {
        wisdom: number;
        completion: number;
    };
}

export default function RecoveryHero({ 
    userName, 
    daysClean, 
    journalStats, 
    taskStats, 
    workbookStats 
}: RecoveryHeroProps) {
  return (
      <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
         {/* Background Decoration */}
         <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl"></div>
         
         <div className="relative z-10">
             {/* Header Row: Greeting & Clean Time Badge */}
             <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                 <div>
                     <h1 className="text-3xl font-bold">Welcome back, {userName}</h1>
                     <p className="text-blue-100 opacity-90">One day at a time. You are doing great.</p>
                 </div>

                 {/* CLEAN TIME BADGE OF HONOR */}
                 <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-xl px-4 py-2 flex items-center gap-3 shadow-lg">
                     <ShieldCheckIcon className="h-8 w-8 text-cyan-300" />
                     <div className="text-right">
                         <div className="text-2xl font-bold leading-none">{daysClean}</div>
                         <div className="text-[10px] uppercase tracking-wider text-blue-100 font-semibold">Days Clean</div>
                     </div>
                 </div>
             </div>

             {/* THE MATRIX GRID (Linked Tiles) */}
             <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
                 
                 {/* COLUMN 1: JOURNAL (Link) */}
                 <Link to="/journal" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <BookOpenIcon className="h-4 w-4" /> Journal
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <FireIcon className="h-5 w-5 text-orange-400" />
                                 <span className="text-sm font-medium">Streak</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.streak} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <ChartBarIcon className="h-5 w-5 text-purple-400" />
                                 <span className="text-sm font-medium">Consistency</span>
                             </div>
                             <span className="text-xl font-bold">{journalStats.consistency}/wk</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 2: TASKS (Link) */}
                 <Link to="/tasks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <ClipboardDocumentCheckIcon className="h-4 w-4" /> Habits
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <BoltIcon className="h-5 w-5 text-yellow-400" />
                                 <span className="text-sm font-medium">Fire</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.fire} Days</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 rounded-full border-2 border-green-400 flex items-center justify-center">
                                    <div className="h-2 w-2 bg-green-400 rounded-full" />
                                 </div>
                                 <span className="text-sm font-medium">Completion</span>
                             </div>
                             <span className="text-xl font-bold">{taskStats.rate}%</span>
                         </div>
                     </div>
                 </Link>

                 {/* COLUMN 3: WORKBOOKS (Link) */}
                 <Link to="/workbooks" className="group bg-blue-900/30 rounded-xl p-4 border border-blue-400/30 backdrop-blur-sm hover:bg-blue-900/50 hover:border-blue-400/50 transition-all cursor-pointer">
                     <div className="flex items-center gap-2 mb-3 text-blue-200 text-sm font-semibold uppercase tracking-wider group-hover:text-white transition-colors">
                         <AcademicCapIcon className="h-4 w-4" /> Wisdom
                     </div>
                     <div className="space-y-3">
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <SparklesIcon className="h-5 w-5 text-cyan-400" />
                                 <span className="text-sm font-medium">Score</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.wisdom} Ans</span>
                         </div>
                         <div className="flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                 <div className="h-5 w-5 relative">
                                     <svg className="w-full h-full transform -rotate-90">
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" strokeOpacity="0.3" strokeWidth="3" />
                                         <circle cx="10" cy="10" r="8" fill="none" stroke="#67e8f9" strokeWidth="3" strokeDasharray={`${workbookStats.completion * 0.5} 100`} />
                                     </svg>
                                 </div>
                                 <span className="text-sm font-medium">Mastery</span>
                             </div>
                             <span className="text-xl font-bold">{workbookStats.completion}%</span>
                         </div>
                     </div>
                 </Link>

             </div>
         </div>
      </div>
  );
}

================================================================================
FILE: src/components/SobrietyCounter.tsx
================================================================================
import { useMemo } from 'react';
import { TrophyIcon } from '@heroicons/react/24/solid';

interface SobrietyCounterProps {
  sobrietyDate: Date;
}

// ensure 'export default' is present here
export default function SobrietyCounter({ sobrietyDate }: SobrietyCounterProps) {
  const time = useMemo(() => {
    const now = new Date();
    const start = new Date(sobrietyDate);
    
    // Calculate the difference
    const diffTime = Math.abs(now.getTime() - start.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = (totalDays % 365) % 30;

    return { years, months, days, totalDays };
  }, [sobrietyDate]);

  return (
    <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-xl p-6 text-white relative overflow-hidden">
      {/* Background Decoration */}
      <TrophyIcon className="absolute -right-4 -bottom-4 h-48 w-48 text-blue-500 opacity-20 transform rotate-12" />

      <div className="relative z-10">
        <h2 className="text-blue-100 text-sm font-semibold uppercase tracking-wider mb-4">
          Clean & Sober Time
        </h2>
        
        <div className="flex items-end space-x-6">
          {/* Years */}
          {time.years > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.years}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Years</span>
            </div>
          )}

          {/* Months */}
          {time.months > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.months}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Months</span>
            </div>
          )}

          {/* Days */}
          <div className="text-center">
            <span className="block text-4xl sm:text-5xl font-bold">{time.days}</span>
            <span className="text-xs sm:text-sm text-blue-200 uppercase">Days</span>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-blue-500/50 flex justify-between items-center text-sm text-blue-200">
          <span>Total Days: {time.totalDays}</span>
          <span>Started: {sobrietyDate.toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalEditor.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, addDoc, Timestamp, doc, updateDoc, query, where, orderBy, limit, getDocs } from 'firebase/firestore';
import { 
    PlusIcon, 
    Cog6ToothIcon,
    MapPinIcon,
    ArrowPathIcon,
    TagIcon,
    XMarkIcon
} from '@heroicons/react/24/outline';
import { getUserTemplates, type JournalTemplate } from '../../lib/db';
import { getCurrentWeather } from '../../lib/weather';
import { useNavigate } from 'react-router-dom';

// --- Types ---
export interface JournalEntry {
  id: string;
  content: string;
  moodScore: number;
  sentiment?: string;
  createdAt: any;
  tags?: string[];
  weather?: { temp: number; condition: string } | null;
}

interface JournalEditorProps {
  initialEntry: JournalEntry | null;
  onSaveComplete: () => void;
}

const DEFAULT_TEMPLATES = [
  { id: 'morning_checkin', name: 'Morning Check-in', text: "Morning Check-in ‚òÄÔ∏è\n\nHow am I feeling today?\n\n\nWhat is my main focus for today?\n\n\nOne thing I am grateful for:\n", tags: ['Morning'] },
  { id: 'nightly_review', name: 'Nightly Review', text: "Nightly Review üåô\n\nWhat went well today?\n\n\nWhat challenged me?\n\n\nDid I stay sober today?\n", tags: ['Nightly'] },
  { id: 'urge_log', name: 'Urge Log (SOS)', text: "Urge Log üö®\n\nTrigger:\n\n\nIntensity (1-10):\n\n\nCoping Strategy Used:\n", tags: ['Urge', 'SOS'] },
  { id: 'meeting_reflection', name: 'Meeting Reflection', text: "Meeting Reflection ü™ë\n\nMeeting Topic:\n\n\nOne thing I heard that resonated:\n\n\nHow can I apply this?\n", tags: ['Meeting'] },
];

export default function JournalEditor({ initialEntry, onSaveComplete }: JournalEditorProps) {
  const { user } = useAuth();
  const navigate = useNavigate();

  // State
  const [newEntry, setNewEntry] = useState('');
  const [mood, setMood] = useState(5);
  const [weather, setWeather] = useState<{ temp: number; condition: string } | null>(null);
  const [saving, setSaving] = useState(false);
  const [weatherLoading, setWeatherLoading] = useState(false);
  
  // Tag State
  const [tags, setTags] = useState<string[]>([]);
  const [tagInput, setTagInput] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  
  // Template State
  const [customTemplates, setCustomTemplates] = useState<JournalTemplate[]>([]);
  const [activeTemplate, setActiveTemplate] = useState<JournalTemplate | null>(null);
  const [formAnswers, setFormAnswers] = useState<string[]>([]);

  // Load Initial Data (Editing Mode)
  useEffect(() => {
    if (initialEntry) {
      setNewEntry(initialEntry.content);
      setMood(initialEntry.moodScore);
      setTags(initialEntry.tags || []);
      // Load saved weather if it exists
      if (initialEntry.weather) {
        setWeather(initialEntry.weather);
      }
      setActiveTemplate(null);
    } else {
      // Reset if switching from edit back to new
      setNewEntry('');
      setMood(5);
      setTags([]);
      setActiveTemplate(null);
      setFormAnswers([]);
      setWeather(null);
      // Try auto-fetch, but don't block if it fails
      fetchLocalWeather(); 
    }
  }, [initialEntry]);

  // Load Resources
  useEffect(() => {
    if (!user) return;
    loadCustomTemplates();
    loadUserTags();
    if (!initialEntry) fetchLocalWeather(); 
  }, [user]);

  const loadCustomTemplates = async () => {
    if (!user) return;
    const t = await getUserTemplates(user.uid);
    setCustomTemplates(t);
  };

  const loadUserTags = async () => {
    if (!user || !db) return;
    try {
        // Fetch last 50 entries to gather recent tags
        const q = query(
            collection(db, 'journals'),
            where('uid', '==', user.uid),
            orderBy('createdAt', 'desc'),
            limit(50)
        );
        const snapshot = await getDocs(q);
        const tagSet = new Set<string>();
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.tags && Array.isArray(data.tags)) {
                data.tags.forEach((t: string) => tagSet.add(t));
            }
        });
        setAvailableTags(Array.from(tagSet).sort());
    } catch (e) {
        console.warn("Failed to load user tags", e);
    }
  };

  const fetchLocalWeather = async () => {
    setWeatherLoading(true);
    try {
      const data = await getCurrentWeather();
      if (data) {
        setWeather({
          temp: Math.round(data.temp),
          condition: data.condition
        });
      }
    } catch (e) {
      console.warn("Failed to auto-load weather", e);
    } finally {
      setWeatherLoading(false);
    }
  };

  const handleTemplateSelect = (tId: string) => {
    const defTemplate = DEFAULT_TEMPLATES.find(t => t.id === tId);
    if (defTemplate) {
        setNewEntry(defTemplate.text);
        setTags(prev => [...new Set([...prev, ...defTemplate.tags])]);
        setActiveTemplate(null);
        return;
    }

    // Extended Type Check: Use 'any' to safely access properties that might not be in the imported type yet
    const custTemplate = customTemplates.find(t => t.id === tId) as any;
    
    if (custTemplate) {
        // CASE 1: Free Text Template (Markdown)
        if (custTemplate.content) {
            setNewEntry(custTemplate.content);
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
            setActiveTemplate(null); // Treat as free text, not form wizard
        } 
        // CASE 2: Legacy Form Template
        else if (custTemplate.prompts) {
            setActiveTemplate(custTemplate);
            setFormAnswers(new Array(custTemplate.prompts.length).fill(''));
            setNewEntry('');
            setTags(prev => [...new Set([...prev, ...(custTemplate.defaultTags || [])])]);
        }
    } else {
        setActiveTemplate(null);
        setNewEntry('');
        setTags([]);
    }
  };

  // Tag Handling Functions
  const handleAddTag = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTag(tagInput);
    } else if (e.key === 'Backspace' && tagInput === '' && tags.length > 0) {
        // Remove last tag if input is empty
        setTags(prev => prev.slice(0, -1));
    }
  };

  const addTag = (tagName: string) => {
    const cleanTag = tagName.trim().replace(/^#/, ''); // Remove # if user typed it
    if (cleanTag && !tags.includes(cleanTag)) {
        setTags([...tags, cleanTag]);
    }
    setTagInput('');
    setShowSuggestions(false);
  };

  const removeTag = (tagToRemove: string) => {
    setTags(tags.filter(t => t !== tagToRemove));
  };

  const filteredSuggestions = availableTags.filter(t => 
    t.toLowerCase().includes(tagInput.toLowerCase()) && !tags.includes(t)
  );

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db) return;

    const isFormValid = activeTemplate && formAnswers.some(a => a.trim() !== '');
    const isTextValid = !activeTemplate && newEntry.trim() !== '';

    if (!isFormValid && !isTextValid) return;

    setSaving(true);

    let finalContent = newEntry;

    if (activeTemplate) {
        finalContent = `**${activeTemplate.name}**\n\n`;
        activeTemplate.prompts.forEach((prompt, idx) => {
            finalContent += `**${prompt}**\n${formAnswers[idx] || '-(Skipped)-'}\n\n`;
        });
    }

    try {
      if (initialEntry) {
        await updateDoc(doc(db, 'journals', initialEntry.id), { 
            content: finalContent, 
            moodScore: mood,
            tags: tags 
        });
      } else {
        await addDoc(collection(db, 'journals'), {
          uid: user.uid,
          content: finalContent,
          moodScore: mood,
          sentiment: 'Pending', 
          weather, 
          tags: tags,
          createdAt: Timestamp.now()
        });
      }

      setNewEntry('');
      setFormAnswers([]);
      setActiveTemplate(null);
      setMood(5);
      setTags([]);
      onSaveComplete();
    } catch (error) {
      console.error("Error saving entry:", error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-visible relative">
        
        {/* HEADER: Weather (Left) | Templates (Right) */}
        <div className="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center gap-3">
             
             {/* LEFT: Weather Widget */}
             <div>
                {weather ? (
                   <div className="flex items-center gap-2 text-xs text-gray-500 bg-white px-2 py-1.5 rounded-lg border border-gray-200 shadow-sm">
                      <span>{weather.condition}</span>
                      <span className="font-bold">{weather.temp}¬∞C</span>
                      {!initialEntry && (
                          <button type="button" onClick={fetchLocalWeather} disabled={weatherLoading} className="ml-1 text-blue-400 hover:text-blue-600">
                              <ArrowPathIcon className={`h-3 w-3 ${weatherLoading ? 'animate-spin' : ''}`} />
                          </button>
                      )}
                   </div>
                ) : (
                    !initialEntry && (
                        <button 
                            type="button" 
                            onClick={fetchLocalWeather} 
                            disabled={weatherLoading}
                            className="flex items-center gap-1 text-xs text-gray-500 hover:text-blue-600 bg-white hover:bg-blue-50 px-2 py-1.5 rounded-lg border border-gray-200 transition-colors shadow-sm"
                        >
                            {weatherLoading ? (
                                <ArrowPathIcon className="h-3 w-3 animate-spin" />
                            ) : (
                                <MapPinIcon className="h-3 w-3" />
                            )}
                            <span>Add Weather</span>
                        </button>
                    )
                )}
             </div>

             {/* RIGHT: Template Controls */}
             <div className="flex items-center gap-2">
                 <div className="relative">
                    <select 
                        onChange={(e) => handleTemplateSelect(e.target.value)}
                        className="pl-3 pr-8 py-1.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white"
                        defaultValue=""
                        disabled={!!initialEntry} 
                    >
                        <option value="" disabled>Choose a Template...</option>
                        <option value="none">Free Write (Blank)</option>
                        <optgroup label="Standard">
                            {DEFAULT_TEMPLATES.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </optgroup>
                        {customTemplates.length > 0 && (
                            <optgroup label="My Templates">
                                {customTemplates.map(t => (
                                    <option key={t.id} value={t.id}>{t.name}</option>
                                ))}
                            </optgroup>
                        )}
                    </select>
                 </div>

                 <button 
                    onClick={() => navigate('/templates')}
                    className="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition"
                    title="Manage Templates"
                 >
                    <Cog6ToothIcon className="h-5 w-5" />
                 </button>
             </div>
        </div>
        
        <form onSubmit={handleSave} className="p-4 space-y-4">
          
          {activeTemplate ? (
             <div className="space-y-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-blue-900">{activeTemplate.name}</h3>
                    <button 
                        type="button" 
                        onClick={() => setActiveTemplate(null)}
                        className="text-xs text-blue-500 hover:text-blue-700 underline"
                    >
                        Switch to Text Mode
                    </button>
                </div>
                
                {activeTemplate.prompts.map((prompt, idx) => (
                    <div key={idx}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{prompt}</label>
                        <textarea
                            rows={4} 
                            value={formAnswers[idx] || ''}
                            onChange={(e) => {
                                const newAns = [...formAnswers];
                                newAns[idx] = e.target.value;
                                setFormAnswers(newAns);
                            }}
                            className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                            placeholder="Type your answer..."
                        />
                    </div>
                ))}
             </div>
          ) : (
            <textarea
                value={newEntry}
                onChange={(e) => setNewEntry(e.target.value)}
                placeholder="How are you feeling today?"
                className="w-full h-[45vh] p-4 rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm resize-none text-gray-700 leading-relaxed font-mono"
            />
          )}

          {/* --- TAG INPUT BAR --- */}
          <div className="relative group">
              <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500">
                  <TagIcon className="h-4 w-4 text-gray-400" />
                  
                  {/* Selected Tags Chips */}
                  {tags.map(tag => (
                      <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                          {tag}
                          <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                              <XMarkIcon className="h-3 w-3" />
                          </button>
                      </span>
                  ))}

                  {/* Input Field */}
                  <input 
                      type="text"
                      value={tagInput}
                      onChange={(e) => {
                          setTagInput(e.target.value);
                          setShowSuggestions(true);
                      }}
                      onKeyDown={handleAddTag}
                      onBlur={() => setTimeout(() => setShowSuggestions(false), 200)} // Delay so click registers
                      placeholder={tags.length === 0 ? "Add tags (e.g. Grateful, Morning)..." : ""}
                      className="flex-1 min-w-[120px] text-sm border-none focus:ring-0 p-0 text-gray-700 placeholder:text-gray-400"
                  />
              </div>

              {/* Autocomplete Suggestions */}
              {showSuggestions && tagInput && filteredSuggestions.length > 0 && (
                  <div className="absolute bottom-full left-0 mb-1 w-full max-w-sm bg-white rounded-lg shadow-lg border border-gray-200 max-h-40 overflow-y-auto z-10">
                      {filteredSuggestions.map(tag => (
                          <button
                            key={tag}
                            type="button"
                            className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors"
                            onClick={() => addTag(tag)}
                          >
                              {tag}
                          </button>
                      ))}
                  </div>
              )}
          </div>

          {/* FOOTER: Mood (Left) | Save Button (Right) */}
          <div className="flex flex-wrap items-center justify-between gap-4">
            
            {/* Mood Slider */}
            <div className="flex items-center gap-3 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
               <span className="text-sm font-medium text-gray-500">Mood:</span>
               <input 
                 type="range" 
                 min="1" 
                 max="10" 
                 value={mood}
                 onChange={(e) => setMood(Number(e.target.value))}
                 className="w-24 accent-blue-600 cursor-pointer"
               />
               <span className={`text-sm font-bold w-6 text-center ${mood >= 7 ? 'text-green-600' : mood <= 4 ? 'text-red-500' : 'text-yellow-600'}`}>
                 {mood}
               </span>
            </div>

            {/* Save Button */}
            <button
              type="submit"
              disabled={saving}
              className="ml-auto flex items-center gap-2 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition-all active:scale-95 disabled:opacity-50"
            >
              {saving ? (
                <span>Saving...</span>
              ) : (
                <>
                  <PlusIcon className="h-5 w-5" />
                  <span>{initialEntry ? 'Update Entry' : 'Save Entry'}</span>
                </>
              )}
            </button>
          </div>
        </form>
      </div>
  );
}

================================================================================
FILE: src/components/journal/JournalHistory.tsx
================================================================================
import { useState, useEffect, Fragment } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs, deleteDoc, doc } from 'firebase/firestore';
import { 
    TrashIcon,
    PencilSquareIcon,
    ArrowPathIcon,
    SparklesIcon,
    FunnelIcon,
    MagnifyingGlassIcon,
    XMarkIcon,
    ShareIcon,
    ShieldExclamationIcon,
    TrophyIcon,
    WrenchScrewdriverIcon,
    LightBulbIcon
} from '@heroicons/react/24/outline';
import { Dialog, Transition } from '@headlessui/react';
import { analyzeJournalEntries, type AnalysisResult } from '../../lib/gemini';
import type { JournalEntry } from './JournalEditor';

interface JournalHistoryProps {
  onEdit: (entry: JournalEntry) => void;
}

export default function JournalHistory({ onEdit }: JournalHistoryProps) {
  const { user } = useAuth();

  // Data State
  const [entries, setEntries] = useState<JournalEntry[]>([]);
  const [filteredEntries, setFilteredEntries] = useState<JournalEntry[]>([]);
  const [loading, setLoading] = useState(true);

  // Filters State
  const [searchQuery, setSearchQuery] = useState('');
  const [filterTag, setFilterTag] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);

  // AI State
  const [analyzing, setAnalyzing] = useState(false);
  const [insight, setInsight] = useState<AnalysisResult | null>(null);
  const [showInsightModal, setShowInsightModal] = useState(false);

  useEffect(() => {
    if (!user) return;
    loadEntries();
  }, [user]);

  // Load ALL entries initially (or limit to last 100 for performance)
  const loadEntries = async () => {
    if (!user || !db) return;
    try {
      const q = query(
        collection(db, 'journals'), 
        where('uid', '==', user.uid),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as JournalEntry));
      setEntries(data);
      setFilteredEntries(data); // Init filtered list
      
      // Extract unique tags
      const tags = new Set<string>();
      data.forEach(e => e.tags?.forEach(t => tags.add(t)));
      setAvailableTags(Array.from(tags));

    } catch (error) {
      console.error("Error loading entries:", error);
    } finally {
      setLoading(false);
    }
  };

  // Client-Side Filtering
  useEffect(() => {
    let result = entries;

    // 1. Keyword Search
    if (searchQuery) {
        const lowerQ = searchQuery.toLowerCase();
        result = result.filter(e => e.content.toLowerCase().includes(lowerQ));
    }

    // 2. Tag Filter
    if (filterTag) {
        result = result.filter(e => e.tags?.includes(filterTag));
    }

    // 3. Date Range
    if (dateFrom) {
        const from = new Date(dateFrom);
        result = result.filter(e => e.createdAt?.toDate() >= from);
    }
    if (dateTo) {
        // Set 'To' date to end of day
        const to = new Date(dateTo);
        to.setHours(23, 59, 59, 999);
        result = result.filter(e => e.createdAt?.toDate() <= to);
    }

    setFilteredEntries(result);
  }, [entries, searchQuery, filterTag, dateFrom, dateTo]);

  const handleDelete = async (id: string) => {
    if (!db) return;
    if (!confirm('Are you sure you want to delete this entry?')) return;
    try {
      await deleteDoc(doc(db, 'journals', id));
      await loadEntries(); // Reload to refresh list
    } catch (error) {
      console.error(error);
    }
  };

  // Share Handler
  const handleShare = async (entry: JournalEntry) => {
    const dateStr = entry.createdAt?.toDate ? entry.createdAt.toDate().toLocaleDateString() : 'Unknown Date';
    const textToShare = `Journal Entry - ${dateStr}\n\n${entry.content}`;

    if (navigator.share) {
        try {
            await navigator.share({
                title: `Journal Entry ${dateStr}`,
                text: textToShare,
            });
        } catch (err) {
            console.error('Error sharing:', err);
        }
    } else {
        try {
            await navigator.clipboard.writeText(textToShare);
            alert('Journal entry copied to clipboard!'); 
        } catch (err) {
            console.error('Failed to copy:', err);
        }
    }
  };

  const handleAiAnalysis = async () => {
    if (filteredEntries.length === 0) return;
    setAnalyzing(true);
    setShowInsightModal(true);
    
    // Analyze filtered results (up to 10 to avoid token limits)
    const textsToAnalyze = filteredEntries.slice(0, 10).map(e => e.content);
    
    const result = await analyzeJournalEntries(textsToAnalyze);
    setInsight(result);
    setAnalyzing(false);
  };

  const clearFilters = () => {
      setSearchQuery('');
      setFilterTag('');
      setDateFrom('');
      setDateTo('');
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Loading history...</div>;

  return (
    <div className="space-y-6">
      
      {/* --- HEADER & FILTERS --- */}
      <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-4">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
             <div className="relative flex-1 w-full sm:w-auto">
                <MagnifyingGlassIcon className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                <input 
                    type="text"
                    placeholder="Search keywords..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-9 pr-3 py-2 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
             </div>
             
             <div className="flex items-center gap-2 w-full sm:w-auto">
                 <button 
                    onClick={() => setShowFilters(!showFilters)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${showFilters ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'}`}
                 >
                    <FunnelIcon className="h-4 w-4" />
                    Filters
                 </button>
                 
                 <button 
                    onClick={handleAiAnalysis}
                    disabled={analyzing || filteredEntries.length === 0}
                    className="flex-1 sm:flex-none flex items-center justify-center gap-2 text-purple-600 bg-purple-50 px-4 py-2 rounded-lg hover:bg-purple-100 transition-colors disabled:opacity-50"
                 >
                    {analyzing ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />}
                    <span className="font-medium text-sm">Analyze Selection</span>
                 </button>
             </div>
          </div>

          {showFilters && (
              <div className="pt-4 border-t border-gray-100 grid grid-cols-1 sm:grid-cols-3 gap-4 animate-fadeIn">
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">Filter by Tag</label>
                      <select 
                        value={filterTag} 
                        onChange={(e) => setFilterTag(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      >
                          <option value="">All Tags</option>
                          {availableTags.map(t => <option key={t} value={t}>{t}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">From Date</label>
                      <input 
                        type="date" 
                        value={dateFrom} 
                        onChange={(e) => setDateFrom(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      />
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">To Date</label>
                      <input 
                        type="date" 
                        value={dateTo} 
                        onChange={(e) => setDateTo(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      />
                  </div>
                  <div className="sm:col-span-3 flex justify-end">
                      <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                          <XMarkIcon className="h-3 w-3" /> Clear Filters
                      </button>
                  </div>
              </div>
          )}
      </div>

      {/* --- RESULTS INFO --- */}
      <div className="flex justify-between items-center px-2">
          <p className="text-sm text-gray-500">
             Showing {filteredEntries.length} entries 
             {(searchQuery || filterTag || dateFrom) && <span className="text-gray-400"> (Filtered)</span>}
          </p>
      </div>

      {/* --- ENTRIES LIST --- */}
      {filteredEntries.length === 0 ? (
          <div className="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300">
            <p className="text-gray-500">No entries match your filters.</p>
          </div>
      ) : (
          filteredEntries.map(entry => (
            <div key={entry.id} className="bg-white rounded-xl shadow-sm border border-gray-200 hover:border-blue-300 transition-all group overflow-hidden">
              
              {/* --- HEADER ROW (Stacked Meta) --- */}
              <div className="bg-blue-50/50 p-3 border-b border-gray-100 flex flex-nowrap justify-between items-center gap-2">
                
                {/* Left: Stacked Meta (Date / Time+Weather / Tags) */}
                <div className="flex flex-col items-start min-w-0">
                    {/* Line 1: Date */}
                    <span className="text-sm font-bold text-gray-800 truncate">
                        {entry.createdAt?.toDate ? entry.createdAt.toDate().toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }) : 'Unknown Date'}
                    </span>
                    
                    {/* Line 2: Time + Weather */}
                    <div className="flex items-center gap-2 text-xs text-gray-500 mb-1">
                        <span>
                            {entry.createdAt?.toDate ? entry.createdAt.toDate().toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' }) : ''}
                        </span>
                        
                        {entry.weather && (
                            <>
                                <span className="text-gray-300">‚Ä¢</span>
                                <span className="bg-white/80 px-1.5 py-0.5 rounded-md border border-gray-200 whitespace-nowrap">
                                    {entry.weather.condition}, {entry.weather.temp}¬∞C
                                </span>
                            </>
                        )}
                    </div>

                    {/* Line 3: Tags (Limited to 3) */}
                    {entry.tags && entry.tags.length > 0 && (
                        <div className="flex flex-wrap gap-1">
                             {entry.tags.slice(0, 3).map((tag, i) => (
                                  <span key={i} className="text-[10px] bg-white text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">
                                      {tag}
                                  </span>
                             ))}
                             {entry.tags.length > 3 && (
                                 <span className="text-[10px] text-gray-400 pl-1">+{entry.tags.length - 3}</span>
                             )}
                        </div>
                    )}
                </div>

                {/* Right: Mood & Actions */}
                <div className="flex items-center gap-2 flex-shrink-0 self-center">
                    
                    {/* MOOD INDICATOR (Compact Pill) */}
                    <div className="flex items-center gap-1.5 bg-white/60 px-1.5 py-0.5 rounded-lg border border-blue-100/50 shadow-sm whitespace-nowrap">
                        <span className="text-[10px] font-bold text-gray-500 uppercase tracking-wider hidden sm:inline">Mood</span>
                        <div className={`h-2 w-2 rounded-full ${entry.moodScore >= 7 ? 'bg-green-500' : entry.moodScore <= 4 ? 'bg-red-500' : 'bg-yellow-500'}`} />
                        <span className="text-xs font-bold text-gray-700">{entry.moodScore}</span>
                    </div>

                    {/* Actions */}
                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                       <button onClick={() => onEdit(entry)} className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-white rounded-full transition-colors" title="Edit">
                          <PencilSquareIcon className="h-4 w-4" />
                       </button>
                       <button onClick={() => handleShare(entry)} className="p-1.5 text-gray-400 hover:text-green-600 hover:bg-white rounded-full transition-colors" title="Share">
                          <ShareIcon className="h-4 w-4" />
                       </button>
                       <button onClick={() => handleDelete(entry.id)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-white rounded-full transition-colors" title="Delete">
                          <TrashIcon className="h-4 w-4" />
                       </button>
                    </div>
                </div>

              </div>

              {/* BODY CONTENT */}
              <div className="p-5">
                  <div className="prose prose-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
                    {entry.content}
                  </div>

                  {/* Sentiment (Only if exists) */}
                  {entry.sentiment && entry.sentiment !== 'Pending' && (
                    <div className="mt-4 flex justify-end">
                        <span className={`text-xs px-2 py-1 rounded-full border ${
                            entry.sentiment === 'Positive' ? 'bg-green-50 text-green-700 border-green-100' : 
                            entry.sentiment === 'Negative' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-gray-50 text-gray-600 border-gray-100'
                        }`}>
                            {entry.sentiment} Analysis
                        </span>
                    </div>
                  )}
              </div>

            </div>
          ))
      )}

      {/* --- AI MODAL (RECOVERY COMPASS) --- */}
      <Transition appear show={showInsightModal} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowInsightModal(false)}>
          <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-200" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
          </Transition.Child>

          <div className="fixed inset-0 overflow-y-auto">
            <div className="flex min-h-full items-center justify-center p-4 text-center">
              <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-200" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
                <Dialog.Panel className="w-full max-w-2xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                  <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900 flex items-center gap-2 border-b border-gray-100 pb-4 mb-4">
                    <SparklesIcon className="h-6 w-6 text-purple-500" />
                    Recovery Compass Analysis
                  </Dialog.Title>
                  
                  {analyzing ? (
                    <div className="py-12 flex flex-col items-center justify-center">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mb-4"></div>
                        <p className="text-gray-500 font-medium">Consulting your AI Sponsor...</p>
                    </div>
                  ) : (
                    insight && (
                        <div className="space-y-6">
                            
                            {/* 1. TOP SUMMARY ROW */}
                            <div className="bg-purple-50 rounded-xl p-4 border border-purple-100 flex gap-4">
                                <div className="flex-shrink-0 p-2 bg-purple-100 rounded-lg h-fit">
                                    <LightBulbIcon className="h-6 w-6 text-purple-600" />
                                </div>
                                <div>
                                    <h4 className="font-bold text-purple-900 text-sm uppercase tracking-wide mb-1">The Insight</h4>
                                    <p className="text-purple-800 text-sm leading-relaxed">{insight.summary}</p>
                                    <div className="flex gap-3 mt-3">
                                        <span className="text-xs font-semibold bg-white/50 px-2 py-1 rounded text-purple-700 border border-purple-200">
                                            Mood: {insight.mood}
                                        </span>
                                        <span className="text-xs font-semibold bg-white/50 px-2 py-1 rounded text-purple-700 border border-purple-200">
                                            Sentiment: {insight.sentiment}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* 2. RISK ANALYSIS (The Shield) */}
                                <div className="bg-orange-50 rounded-xl p-4 border border-orange-100">
                                    <div className="flex items-center gap-2 mb-2 text-orange-800 font-bold text-sm uppercase tracking-wide">
                                        <ShieldExclamationIcon className="h-5 w-5" />
                                        Risk Detection
                                    </div>
                                    <p className="text-sm text-orange-900 leading-relaxed">
                                        {insight.risk_analysis}
                                    </p>
                                </div>

                                {/* 3. POSITIVE REINFORCEMENT (The Spark) */}
                                <div className="bg-green-50 rounded-xl p-4 border border-green-100">
                                    <div className="flex items-center gap-2 mb-2 text-green-800 font-bold text-sm uppercase tracking-wide">
                                        <TrophyIcon className="h-5 w-5" />
                                        Strengths & Wins
                                    </div>
                                    <p className="text-sm text-green-900 leading-relaxed">
                                        {insight.positive_reinforcement}
                                    </p>
                                </div>
                            </div>

                            {/* 4. TOOL SUGGESTIONS (The Toolkit) */}
                            <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                <div className="flex items-center gap-2 mb-3 text-blue-800 font-bold text-sm uppercase tracking-wide">
                                    <WrenchScrewdriverIcon className="h-5 w-5" />
                                    Suggested Toolkit
                                </div>
                                <ul className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    {insight.tool_suggestions.map((tool, i) => (
                                        <li key={i} className="bg-white p-3 rounded-lg text-sm text-blue-900 shadow-sm border border-blue-100 flex items-start gap-2">
                                            <span className="text-blue-400 font-bold">‚Ä¢</span>
                                            {tool}
                                        </li>
                                    ))}
                                </ul>
                            </div>

                        </div>
                    )
                  )}

                  <div className="mt-6 flex justify-end">
                    <button type="button" className="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors" onClick={() => setShowInsightModal(false)}>
                      Close Analysis
                    </button>
                  </div>
                </Dialog.Panel>
              </Transition.Child>
            </div>
          </div>
        </Dialog>
      </Transition>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalInsights.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';
import type { JournalEntry } from './JournalEditor';
import {
  LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
} from 'recharts';

// --- HELPERS ---
const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const COLORS = ['#4ade80', '#f87171', '#94a3b8']; // Green, Red, Gray

const STOP_WORDS = new Set([
  'the', 'and', 'a', 'to', 'of', 'in', 'i', 'is', 'that', 'it', 'for', 'my', 'was', 'on', 'with', 'as', 'at', 'be', 'have', 'this', 'me', 'so', 'but', 'not', 'are', 'am', 'will', 'just', 'all', 'today', 'day', 'had', 'very'
]);

export default function JournalInsights() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  
  // Chart Data State
  const [moodData, setMoodData] = useState<any[]>([]);
  const [dayData, setDayData] = useState<any[]>([]);
  const [sentimentData, setSentimentData] = useState<any[]>([]);
  const [wordCloud, setWordCloud] = useState<{ text: string, count: number }[]>([]);

  useEffect(() => {
    if (user) loadData();
  }, [user]);

  const loadData = async () => {
    if (!user || !db) return;
    try {
      // 1. Fetch Entries (Last 50 for performance)
      const q = query(collection(db, 'journals'), where('uid', '==', user.uid), orderBy('createdAt', 'desc'));
      const snapshot = await getDocs(q);
      const entries = snapshot.docs.map(doc => ({ ...doc.data() } as JournalEntry));

      processMoodGraph(entries);
      processTriggerDays(entries);
      processSentiment(entries);
      processWordCloud(entries);

    } catch (error) {
      console.error("Error loading insights:", error);
    } finally {
      setLoading(false);
    }
  };

  // --- PROCESSORS ---

  const processMoodGraph = (entries: JournalEntry[]) => {
    // Reverse to show oldest -> newest left to right
    const data = [...entries].reverse().map(e => ({
      date: e.createdAt?.toDate ? e.createdAt.toDate().toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' }) : '',
      mood: e.moodScore
    }));
    setMoodData(data);
  };

  const processTriggerDays = (entries: JournalEntry[]) => {
    const daySums = new Array(7).fill(0);
    const dayCounts = new Array(7).fill(0);

    entries.forEach(e => {
      if (e.createdAt?.toDate) {
        const dayIdx = e.createdAt.toDate().getDay();
        daySums[dayIdx] += e.moodScore;
        dayCounts[dayIdx] += 1;
      }
    });

    const data = DAYS.map((day, idx) => ({
      name: day,
      avgMood: dayCounts[idx] ? parseFloat((daySums[idx] / dayCounts[idx]).toFixed(1)) : 0
    }));
    setDayData(data);
  };

  const processSentiment = (entries: JournalEntry[]) => {
    let pos = 0, neg = 0, neu = 0;
    entries.forEach(e => {
      // Use explicit sentiment if available, else guess by mood
      if (e.sentiment === 'Positive') pos++;
      else if (e.sentiment === 'Negative') neg++;
      else if (e.sentiment === 'Neutral') neu++;
      else {
        // Fallback logic
        if (e.moodScore >= 7) pos++;
        else if (e.moodScore <= 4) neg++;
        else neu++;
      }
    });

    setSentimentData([
      { name: 'Positive', value: pos },
      { name: 'Negative', value: neg },
      { name: 'Neutral', value: neu }
    ].filter(d => d.value > 0));
  };

  const processWordCloud = (entries: JournalEntry[]) => {
    const wordCounts: Record<string, number> = {};
    
    entries.forEach(e => {
      // Simple tokenization: lowercase, remove punctuation
      const words = e.content.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
      words.forEach(w => {
        if (w.length > 2 && !STOP_WORDS.has(w)) {
          wordCounts[w] = (wordCounts[w] || 0) + 1;
        }
      });
    });

    const sorted = Object.entries(wordCounts)
      .map(([text, count]) => ({ text, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 30); // Top 30

    setWordCloud(sorted);
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Crunching the numbers...</div>;
  if (moodData.length === 0) return <div className="text-center py-10 text-gray-400">No entries found to analyze.</div>;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
      
      {/* 1. MOOD GRAPH */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2">
         <h3 className="font-bold text-gray-900 mb-4">Mood History</h3>
         <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
               <LineChart data={moodData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="date" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[1, 10]} hide />
                  <Tooltip 
                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="mood" 
                    stroke="#2563eb" 
                    strokeWidth={3}
                    dot={{ r: 4, fill: '#2563eb', strokeWidth: 0 }}
                    activeDot={{ r: 6 }} 
                  />
               </LineChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 2. TRIGGER DAYS (BAR) */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
         <h3 className="font-bold text-gray-900 mb-4">Average Mood by Day</h3>
         <div className="h-56 w-full">
            <ResponsiveContainer width="100%" height="100%">
               <BarChart data={dayData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="name" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[0, 10]} hide />
                  <Tooltip cursor={{fill: 'transparent'}} />
                  <Bar dataKey="avgMood" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={20} />
               </BarChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 3. SENTIMENT (PIE) */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center">
         <h3 className="font-bold text-gray-900 mb-4 self-start">Emotional Weather</h3>
         <div className="h-56 w-full flex justify-center">
            <ResponsiveContainer width="100%" height="100%">
               <PieChart>
                  <Pie
                    data={sentimentData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={80}
                    paddingAngle={5}
                    dataKey="value"
                  >
                    {/* FIXED: Renamed 'entry' to '_' to silence unused var warning */}
                    {sentimentData.map((_, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
               </PieChart>
            </ResponsiveContainer>
         </div>
         <div className="flex gap-4 text-xs mt-2">
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#4ade80]"></div>Positive</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#f87171]"></div>Negative</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#94a3b8]"></div>Neutral</div>
         </div>
      </div>

      {/* 4. WORD CLOUD */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2">
         <h3 className="font-bold text-gray-900 mb-4">Recurring Themes (Top Words)</h3>
         <div className="flex flex-wrap gap-2 justify-center p-4 min-h-[150px] content-center">
            {/* FIXED: Removed unused 'i' index from map arguments */}
            {wordCloud.map((w) => {
               // Calculate font size relative to frequency
               const max = wordCloud[0]?.count || 1;
               const size = Math.max(0.8, (w.count / max) * 2.5); // 0.8rem to 2.5rem
               const opacity = Math.max(0.5, w.count / max);
               
               return (
                  <span 
                    key={w.text} 
                    style={{ fontSize: `${size}rem`, opacity }}
                    className="text-blue-600 font-medium hover:scale-110 transition-transform cursor-default"
                    title={`${w.count} occurrences`}
                  >
                    {w.text}
                  </span>
               );
            })}
         </div>
      </div>

    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalTabs.tsx
================================================================================
import { PencilSquareIcon, ClockIcon, ChartPieIcon } from '@heroicons/react/24/outline';

interface JournalTabsProps {
  activeTab: 'write' | 'history' | 'insights';
  onChange: (tab: 'write' | 'history' | 'insights') => void;
}

export default function JournalTabs({ activeTab, onChange }: JournalTabsProps) {
  return (
    <div className="flex p-1 space-x-1 bg-blue-100/50 rounded-xl mb-6 overflow-x-auto">
      <button
        onClick={() => onChange('write')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'write'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <PencilSquareIcon className="w-4 h-4" />
        New Entry
      </button>
      <button
        onClick={() => onChange('history')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'history'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ClockIcon className="w-4 h-4" />
        History
      </button>
      <button
        onClick={() => onChange('insights')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'insights'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ChartPieIcon className="w-4 h-4" />
        Insights
      </button>
    </div>
  );
}

================================================================================
FILE: src/components/journal/TemplateEditor.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, addDoc, updateDoc, deleteDoc, doc, query, getDocs, Timestamp } from 'firebase/firestore';
import { 
    ArrowLeftIcon, 
    PlusIcon, 
    TrashIcon, 
    PencilSquareIcon,
    XMarkIcon,
    ListBulletIcon,
    HashtagIcon, 
    CheckCircleIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

// Local Type Definition
interface JournalTemplate {
    id: string;
    uid: string;
    name: string;
    content?: string; 
    prompts?: string[]; // Legacy support
    defaultTags: string[];
    createdAt: any;
}

export default function TemplateEditor() {
    const { user } = useAuth();
    const navigate = useNavigate();
    const [templates, setTemplates] = useState<JournalTemplate[]>([]);
    const [loading, setLoading] = useState(true);

    // Editor State
    const [isEditing, setIsEditing] = useState(false);
    const [editId, setEditId] = useState<string | null>(null);
    const [name, setName] = useState('');
    const [content, setContent] = useState('');
    const [tags, setTags] = useState<string[]>([]);
    const [tagInput, setTagInput] = useState('');
    const [saving, setSaving] = useState(false);

    const textareaRef = useRef<HTMLTextAreaElement>(null);

    useEffect(() => {
        if (!user) return;
        loadTemplates();
        console.log("Template Editor V2 Loaded"); // Debug check
    }, [user]);

    const loadTemplates = async () => {
        if (!user || !db) return;
        setLoading(true);
        try {
            const q = query(collection(db, 'users', user.uid, 'templates'));
            const snapshot = await getDocs(q);
            const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() } as JournalTemplate));
            setTemplates(data);
        } catch (error) {
            console.error("Failed to load templates", error);
        } finally {
            setLoading(false);
        }
    };

    // --- Toolbar Helpers ---
    const insertText = (before: string, after: string = '') => {
        const textarea = textareaRef.current;
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const previousText = textarea.value;
        const selection = previousText.substring(start, end);
        
        const newText = previousText.substring(0, start) + 
                        before + selection + after + 
                        previousText.substring(end);
        
        setContent(newText);
        
        // Reset focus and cursor
        setTimeout(() => {
            textarea.focus();
            const newCursorPos = start + before.length + selection.length + after.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }, 0);
    };

    // --- Tag Helpers ---
    const handleAddTag = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const clean = tagInput.trim().replace(/^#/, '');
            if (clean && !tags.includes(clean)) {
                setTags([...tags, clean]);
                setTagInput('');
            }
        }
    };

    const removeTag = (t: string) => setTags(tags.filter(tag => tag !== t));

    // --- CRUD Operations ---
    const handleEdit = (t: JournalTemplate) => {
        setEditId(t.id);
        setName(t.name);
        // Convert legacy templates to text if needed
        const textContent = t.content || (t.prompts ? t.prompts.map(p => `**${p}**\n\n`).join('') : '');
        setContent(textContent);
        setTags(t.defaultTags || []);
        setIsEditing(true);
    };

    const handleDelete = async (id: string) => {
        if (!confirm("Delete this template?")) return;
        if (!user || !db) return;
        try {
            await deleteDoc(doc(db, 'users', user.uid, 'templates', id));
            setTemplates(templates.filter(t => t.id !== id));
        } catch (e) {
            console.error("Error deleting", e);
        }
    };

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!user || !db) return;
        if (!name.trim()) return alert("Please name your template");

        setSaving(true);
        const templateData = {
            uid: user.uid,
            name,
            content, // Saving as Free Text
            defaultTags: tags,
            updatedAt: Timestamp.now()
        };

        try {
            if (editId) {
                await updateDoc(doc(db, 'users', user.uid, 'templates', editId), templateData);
                setTemplates(prev => prev.map(t => t.id === editId ? { ...t, ...templateData } : t));
            } else {
                const docRef = await addDoc(collection(db, 'users', user.uid, 'templates'), {
                    ...templateData,
                    createdAt: Timestamp.now()
                });
                // Fix: Manually add createdAt to state to match type definition
                setTemplates([...templates, { 
                    id: docRef.id, 
                    ...templateData, 
                    createdAt: Timestamp.now() 
                } as JournalTemplate]);
            }
            setIsEditing(false);
            resetForm();
        } catch (error) {
            console.error("Error saving template", error);
        } finally {
            setSaving(false);
        }
    };

    const resetForm = () => {
        setEditId(null);
        setName('');
        setContent('');
        setTags([]);
    };

    return (
        <div className="max-w-4xl mx-auto p-4 space-y-6">
            
            {/* Header / Nav */}
            <div className="flex items-center gap-4">
                <button onClick={() => navigate('/journal')} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <ArrowLeftIcon className="h-6 w-6 text-gray-600" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">
                    {isEditing ? (editId ? 'Edit Template' : 'New Free-Text Template') : 'My Templates'}
                </h1>
            </div>

            {isEditing ? (
                // --- EDITOR VIEW (Free Text / Markdown) ---
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <form onSubmit={handleSave} className="space-y-6">
                        
                        {/* Name Input */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                            <input 
                                type="text" 
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="e.g. Daily Gratitude List"
                                className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>

                        {/* Content Editor */}
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-sm font-medium text-gray-700">Template Structure</label>
                                <span className="text-xs text-gray-400">Markdown Supported</span>
                            </div>
                            
                            {/* Toolbar */}
                            <div className="flex items-center gap-2 mb-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                                <button type="button" onClick={() => insertText('### ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Heading">
                                    <HashtagIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('**', '**')} className="px-2 py-1 text-sm font-bold hover:bg-white hover:shadow-sm rounded text-gray-600" title="Bold">
                                    B
                                </button>
                                <div className="w-px h-4 bg-gray-300 mx-1"></div>
                                <button type="button" onClick={() => insertText('- [ ] ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Checkbox">
                                    <CheckCircleIcon className="h-4 w-4" />
                                </button>
                                <button type="button" onClick={() => insertText('1. ')} className="p-1.5 hover:bg-white hover:shadow-sm rounded text-gray-600" title="Ordered List">
                                    <ListBulletIcon className="h-4 w-4" />
                                </button>
                            </div>

                            <textarea 
                                ref={textareaRef}
                                rows={12}
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="Design your template here using Markdown...&#10;- [ ] Checklist item&#10;**Bold text**"
                                className="w-full font-mono text-sm rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 leading-relaxed"
                            />
                        </div>

                        {/* Default Tags */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Auto-Tags</label>
                            <div className="flex flex-wrap items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white">
                                {tags.map(tag => (
                                    <span key={tag} className="flex items-center gap-1 bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full border border-blue-100">
                                        {tag}
                                        <button type="button" onClick={() => removeTag(tag)} className="hover:text-blue-900">
                                            <XMarkIcon className="h-3 w-3" />
                                        </button>
                                    </span>
                                ))}
                                <input 
                                    type="text"
                                    value={tagInput}
                                    onChange={(e) => setTagInput(e.target.value)}
                                    onKeyDown={handleAddTag}
                                    placeholder={tags.length === 0 ? "Add tags..." : ""}
                                    className="flex-1 min-w-[100px] text-sm border-none focus:ring-0 p-0 text-gray-700"
                                />
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                            <button 
                                type="button"
                                onClick={() => { setIsEditing(false); resetForm(); }}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit"
                                disabled={saving}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm transition-colors disabled:opacity-50"
                            >
                                {saving ? 'Saving...' : 'Save Template'}
                            </button>
                        </div>

                    </form>
                </div>
            ) : (
                // --- LIST VIEW ---
                <div className="space-y-4">
                    <button 
                        onClick={() => { resetForm(); setIsEditing(true); }}
                        className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium"
                    >
                        <PlusIcon className="h-5 w-5" />
                        Create New Template
                    </button>

                    {loading ? (
                        <div className="text-center py-8 text-gray-400">Loading templates...</div>
                    ) : templates.length === 0 ? (
                        <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-xl">
                            You haven't created any custom templates yet.
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {templates.map(t => (
                                <div key={t.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow group">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-gray-900">{t.name}</h3>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => handleEdit(t)} className="p-1.5 text-gray-400 hover:text-blue-600 rounded">
                                                <PencilSquareIcon className="h-4 w-4" />
                                            </button>
                                            <button onClick={() => handleDelete(t.id)} className="p-1.5 text-gray-400 hover:text-red-600 rounded">
                                                <TrashIcon className="h-4 w-4" />
                                            </button>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 line-clamp-2 mb-3 h-8">
                                        {t.content || (t.prompts ? "Structured Form Template" : "Empty Template")}
                                    </p>
                                    <div className="flex gap-2">
                                        {t.defaultTags?.slice(0, 3).map(tag => (
                                            <span key={tag} className="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full border border-gray-200">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}

================================================================================
FILE: src/contexts/AuthContext.tsx
================================================================================
import { createContext, useContext, useEffect, useState } from 'react';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  type User // FIX 1: Type-only import
} from 'firebase/auth';
import { auth } from '../lib/firebase';
import { getOrCreateUserProfile } from '../lib/db';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  loginWithGoogle: () => Promise<void>;
  signupWithEmail: (email: string, pass: string) => Promise<void>;
  loginWithEmail: (email: string, pass: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // FIX 2: Guard clause - if auth failed to initialize, stop here
    if (!auth) {
      console.error("Firebase Auth not initialized");
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      try {
        if (currentUser) {
          await getOrCreateUserProfile(currentUser);
          setUser(currentUser);
        } else {
          setUser(null);
        }
      } catch (error) {
        console.error("Error fetching user profile:", error);
        setUser(currentUser); 
      } finally {
        setLoading(false);
      }
    });

    return unsubscribe;
  }, []);

  const loginWithGoogle = async () => {
    if (!auth) throw new Error("Auth not initialized");
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, provider);
  };

  const signupWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    const result = await createUserWithEmailAndPassword(auth, email, pass);
    await getOrCreateUserProfile(result.user);
  };

  const loginWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    await signInWithEmailAndPassword(auth, email, pass);
  };

  const logout = async () => {
    if (!auth) return;
    await signOut(auth);
  };

  const value = {
    user,
    loading,
    loginWithGoogle,
    signupWithEmail,
    loginWithEmail,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

================================================================================
FILE: src/data/workbooks.ts
================================================================================
export interface Question {
  id: string;
  text: string;
  context?: string; // Optional context/quote from literature
}

export interface WorkbookSection {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  type: 'linear' | 'steps' | 'general';
  sections: WorkbookSection[];
}

// Helper to generate generic questions for sections we don't fully populate in this snippet
const generateQuestions = (count: number, prefix: string): Question[] => {
  return Array.from({ length: count }).map((_, i) => ({
    id: `${prefix}_q${i + 1}`,
    text: `Question ${i + 1}: Reflection point regarding ${prefix.replace(/_/g, ' ')}.`,
  }));
};

// --- 1. GENERAL RECOVERY WORKBOOK (25 Questions) ---
const generalQuestions: Question[] = [
  { id: 'gen_1', text: "What are the specific consequences of your addiction that led you to seek recovery?" },
  { id: 'gen_2', text: "Describe a time when you tried to control your using but failed." },
  { id: 'gen_3', text: "How has your addiction affected your relationships with family and friends?" },
  { id: 'gen_4', text: "What emotions trigger your desire to use?" },
  { id: 'gen_5', text: "List 5 things you are grateful for today." },
  { id: 'gen_6', text: "What does 'rock bottom' mean to you, and do you feel you hit it?" },
  { id: 'gen_7', text: "How does honesty play a role in your recovery?" },
  { id: 'gen_8', text: "What are your biggest fears about living sober?" },
  { id: 'gen_9', text: "Who are the people in your support network?" },
  { id: 'gen_10', text: "What hobbies or activities did you neglect during active addiction?" },
  { id: 'gen_11', text: "Describe your physical health during active addiction versus now." },
  { id: 'gen_12', text: "What lies did you tell yourself to justify your using?" },
  { id: 'gen_13', text: "How has your addiction impacted your career or education?" },
  { id: 'gen_14', text: "What specific boundaries do you need to set to protect your sobriety?" },
  { id: 'gen_15', text: "How do you handle stress without substances?" },
  { id: 'gen_16', text: "What does a 'spiritual awakening' mean to you?" },
  { id: 'gen_17', text: "List 3 short-term goals for your recovery." },
  { id: 'gen_18', text: "List 3 long-term goals for your life." },
  { id: 'gen_19', text: "How can you be of service to others?" },
  { id: 'gen_20', text: "What resentments are you holding onto, and how do they affect you?" },
  { id: 'gen_21', text: "Describe a situation where you successfully navigated a craving." },
  { id: 'gen_22', text: "What does 'taking it one day at a time' look like in practice?" },
  { id: 'gen_23', text: "How do you practice self-care?" },
  { id: 'gen_24', text: "What advice would you give to your past self?" },
  { id: 'gen_25', text: "Why is recovery worth it for you?" },
];

// --- 2. 12-STEP WORKBOOK (12 Steps, ~15 Qs each) ---
const step1Questions: Question[] = [
  { id: 's1_q1', text: "Do you accept that you have a disease of addiction?", context: "We admitted we were powerless over our addiction..." },
  { id: 's1_q2', text: "How has the disease of addiction manifested in your life?" },
  { id: 's1_q3', text: "Have you ever tried to stop on your own and found you couldn't?" },
  { id: 's1_q4', text: "What specific incidents indicate you have lost control over your usage?" },
  { id: 's1_q5', text: "How has your thinking been distorted by addiction (denial, rationalization)?" },
  { id: 's1_q6', text: "In what ways have you been powerless over your behavior?" },
  { id: 's1_q7', text: "Have you lost self-respect due to your addiction?" },
  { id: 's1_q8', text: "How has your addiction affected you physically?" },
  { id: 's1_q9', text: "How has your addiction affected you mentally?" },
  { id: 's1_q10', text: "How has your addiction affected you spiritually?" },
  { id: 's1_q11', text: "How has your addiction affected you emotionally?" },
  { id: 's1_q12', text: "What is unmanageability to you?" },
  { id: 's1_q13', text: "What are some examples of unmanageability in your life?" },
  { id: 's1_q14', text: "Are you ready to admit you are an addict?" },
  { id: 's1_q15', text: "What reservations do you still have about staying clean?" },
];

const twelveStepSections: WorkbookSection[] = [
  { id: 'step_1', title: 'Step 1', description: 'Powerlessness & Unmanageability', questions: step1Questions },
  { id: 'step_2', title: 'Step 2', description: 'Came to believe', questions: generateQuestions(15, 'step_2') },
  { id: 'step_3', title: 'Step 3', description: 'Turning it over', questions: generateQuestions(15, 'step_3') },
  { id: 'step_4', title: 'Step 4', description: 'Searching and fearless moral inventory', questions: generateQuestions(15, 'step_4') },
  { id: 'step_5', title: 'Step 5', description: 'Admitted to God, ourselves, and another', questions: generateQuestions(15, 'step_5') },
  { id: 'step_6', title: 'Step 6', description: 'Entirely ready', questions: generateQuestions(15, 'step_6') },
  { id: 'step_7', title: 'Step 7', description: 'Humbly asked Him', questions: generateQuestions(15, 'step_7') },
  { id: 'step_8', title: 'Step 8', description: 'List of persons we had harmed', questions: generateQuestions(15, 'step_8') },
  { id: 'step_9', title: 'Step 9', description: 'Direct amends', questions: generateQuestions(15, 'step_9') },
  { id: 'step_10', title: 'Step 10', description: 'Continued to take personal inventory', questions: generateQuestions(15, 'step_10') },
  { id: 'step_11', title: 'Step 11', description: 'Sought through prayer and meditation', questions: generateQuestions(15, 'step_11') },
  { id: 'step_12', title: 'Step 12', description: 'Spiritual awakening', questions: generateQuestions(15, 'step_12') },
];

// --- 3. RECOVERY DHARMA WORKBOOK ---
const dharmaSections: WorkbookSection[] = [
  { id: 'rd_truth_1', title: 'First Noble Truth', description: 'There is suffering', questions: generateQuestions(10, 'dharma_1') },
  { id: 'rd_truth_2', title: 'Second Noble Truth', description: 'The cause of suffering', questions: generateQuestions(10, 'dharma_2') },
  { id: 'rd_truth_3', title: 'Third Noble Truth', description: 'The end of suffering', questions: generateQuestions(10, 'dharma_3') },
  { id: 'rd_truth_4', title: 'Fourth Noble Truth', description: 'The path', questions: generateQuestions(10, 'dharma_4') },
];

// --- MASTER REGISTRY ---
export const WORKBOOKS: Workbook[] = [
  {
    id: 'general_recovery',
    title: 'General Recovery Workbook',
    description: 'A comprehensive 25-question guide to explore the foundations of your recovery journey.',
    type: 'general',
    sections: [{ id: 'main', title: 'Core Questions', questions: generalQuestions }]
  },
  {
    id: '12_steps',
    title: '12-Step Workbook',
    description: 'A rigorous journey through the 12 Steps. 15 questions per step to prepare for sponsor work.',
    type: 'steps',
    sections: twelveStepSections
  },
  {
    id: 'recovery_dharma',
    title: 'Recovery Dharma',
    description: 'Buddhist-inspired path to recovery focusing on the Four Noble Truths and Eightfold Path.',
    type: 'steps',
    sections: dharmaSections
  }
];

export function getWorkbook(id: string): Workbook | undefined {
  return WORKBOOKS.find(w => w.id === id);
}

================================================================================
FILE: src/index.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    /* The "Unified Blue" Theme from your Master Doc */
    @apply bg-blue-50 text-slate-800 antialiased;
  }
  
  /* Reset headings to be bold and dark blue by default */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold text-blue-900;
  }
}

================================================================================
FILE: src/lib/db.ts
================================================================================
import { 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  getDocs, 
  deleteDoc, 
  addDoc,
  query,
  where,
  orderBy,
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { type User } from "firebase/auth";

// --- INTERFACES ---

export interface UserProfile {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  sobrietyDate: Timestamp | null;
  createdAt: Timestamp;
  lastLogin?: Timestamp;
}

export interface JournalTemplate {
  id: string;
  name: string;
  prompts: string[]; 
  defaultTags: string[]; 
}

// [ADDED] Required for Journal features
export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  moodScore: number;
  tags: string[];
  createdAt: Timestamp;
  weather?: {
    temp_c: number;
    condition: string;
    icon: string;
  };
}

// [ADDED] Required for Task features (Approach 3)
export interface Task {
  id?: string;
  uid: string;
  text: string;
  completed: boolean;
  isRecurring: boolean;
  frequency: 'Daily' | 'Weekly' | 'Monthly' | null;
  currentStreak: number;
  priority: 'High' | 'Medium' | 'Low';
  createdAt: Timestamp;
  dueDate?: Timestamp; // The new field for "Smart Reset"
}

// --- PROFILE FUNCTIONS ---

// 1. Fetch a simple profile (Read-Only)
export async function getProfile(uid: string): Promise<UserProfile | null> {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  }
  return null;
}

// 2. Create or Get User Profile
export async function getOrCreateUserProfile(user: User): Promise<UserProfile> {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    // Optional: Update lastLogin here if you want to track activity
    await updateDoc(userRef, { lastLogin: Timestamp.now() });
    return userSnap.data() as UserProfile;
  } else {
    // Initialize new profile
    const newProfile: UserProfile = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL,
      sobrietyDate: null, 
      createdAt: Timestamp.now(),
      lastLogin: Timestamp.now()
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  }
}

// 3. Generic Profile Update
export async function updateProfileData(uid: string, data: Partial<UserProfile> | { sobrietyDate: Date | null }) {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", uid);
  // Spread data to safely handle the partial update
  await setDoc(userRef, { ...data }, { merge: true });
}

// 4. Update Sobriety Date (Legacy helper)
export async function updateSobrietyDate(uid: string, date: Date) {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  await updateDoc(userRef, {
    sobrietyDate: Timestamp.fromDate(date)
  });
}

// --- TEMPLATE FUNCTIONS (Preserved) ---

export async function getUserTemplates(uid: string): Promise<JournalTemplate[]> {
  if (!db) throw new Error("Database not initialized");

  const templatesRef = collection(db, 'users', uid, 'templates');
  const snapshot = await getDocs(templatesRef);

  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as JournalTemplate));
}

export async function saveUserTemplate(uid: string, template: JournalTemplate) {
  if (!db) throw new Error("Database not initialized");

  const docRef = template.id 
    ? doc(db, 'users', uid, 'templates', template.id)
    : doc(collection(db, 'users', uid, 'templates'));

  const dataToSave = {
    ...template,
    id: docRef.id 
  };

  await setDoc(docRef, dataToSave);
}

export async function deleteUserTemplate(uid: string, templateId: string) {
  if (!db) throw new Error("Database not initialized");

  const docRef = doc(db, 'users', uid, 'templates', templateId);
  await deleteDoc(docRef);
}

// --- [ADDED] JOURNAL FUNCTIONS ---

export const addJournalEntry = async (uid: string, entry: Omit<JournalEntry, 'uid' | 'createdAt'>) => {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, 'journals'), {
    uid,
    ...entry,
    createdAt: Timestamp.now(),
  });
};

export const getJournalHistory = async (uid: string) => {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, 'journals'),
    where('uid', '==', uid),
    orderBy('createdAt', 'desc')
  );
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as JournalEntry));
};

================================================================================
FILE: src/lib/firebase.ts
================================================================================
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

// 1. Construct config directly from individual environment variables
// These will be injected by Vite during the build
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
};

// 2. Initialize (Safe Check)
// We check if apiKey exists to ensure we aren't crashing on empty config
const app = firebaseConfig.apiKey ? initializeApp(firebaseConfig) : undefined;

if (!app) {
  console.error("Firebase failed to initialize. Missing API Key.");
}

export const auth = app ? getAuth(app) : undefined;
export const db = app ? getFirestore(app) : undefined;
export const googleProvider = new GoogleAuthProvider();

export default app;

================================================================================
FILE: src/lib/gamification.ts
================================================================================
export interface GamificationStats {
  streakDays: number;
  totalEntries: number;
  averageMood: number;
  journalStreak: number;
  consistencyRate: number; // entries per week
  totalWords: number;
}

export interface TaskStats {
    completionRate: number;
    habitFire: number; // Current streak of completed recurring tasks
}

export interface WorkbookStats {
    wisdomScore: number; // Total questions answered
    masterCompletion: number; // % of total questions
}

// Helper to check if two dates are the same day
const isSameDay = (d1: Date, d2: Date) => {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
};

export const calculateJournalStats = (journals: any[]): GamificationStats => {
    if (!journals || journals.length === 0) {
        return { 
            streakDays: 0, 
            totalEntries: 0, 
            averageMood: 0, 
            journalStreak: 0, 
            consistencyRate: 0,
            totalWords: 0
        };
    }

    // Sort descending (newest first)
    const sorted = [...journals].sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
    const today = new Date();
    
    // 1. Total Entries
    const totalEntries = journals.length;

    // 2. Average Mood
    const moodSum = journals.reduce((acc, curr) => acc + (curr.moodScore || 0), 0);
    const averageMood = totalEntries > 0 ? parseFloat((moodSum / totalEntries).toFixed(1)) : 0;

    // 3. Journal Streak
    let currentStreak = 0;
    
    // Check if posted today
    const lastPostDate = sorted[0].createdAt.toDate();
    const postedToday = isSameDay(lastPostDate, today);
    
    // If not posted today, check if posted yesterday to maintain streak
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const postedYesterday = isSameDay(lastPostDate, yesterday);

    if (postedToday || postedYesterday) {
        currentStreak = 1;
        // Iterate backwards to count consecutive days
        // We compress entries to unique days first
        const uniqueDays = new Set<string>();
        journals.forEach(j => {
            uniqueDays.add(j.createdAt.toDate().toDateString());
        });
        
        const sortedDates = Array.from(uniqueDays).map(d => new Date(d)).sort((a, b) => b.getTime() - a.getTime());
        
        for (let i = 0; i < sortedDates.length - 1; i++) {
            const current = sortedDates[i];
            const next = sortedDates[i+1];
            
            // Difference in days
            const diffTime = Math.abs(current.getTime() - next.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            if (diffDays === 1) {
                currentStreak++;
            } else {
                break;
            }
        }
    }

    // 4. Consistency (Entries / Week)
    // Calc distinct weeks present
    const firstDate = sorted[sorted.length - 1].createdAt.toDate();
    const timeSpanDays = (today.getTime() - firstDate.getTime()) / (1000 * 3600 * 24);
    const weeksActive = Math.max(1, Math.ceil(timeSpanDays / 7));
    const consistencyRate = parseFloat((totalEntries / weeksActive).toFixed(1));

    // 5. Total Words
    const totalWords = journals.reduce((acc, curr) => {
        const words = curr.content ? curr.content.trim().split(/\s+/).length : 0;
        return acc + words;
    }, 0);

    return {
        streakDays: currentStreak,
        totalEntries,
        averageMood,
        journalStreak: currentStreak,
        consistencyRate,
        totalWords
    };
};

export const calculateTaskStats = (tasks: any[]): TaskStats => {
    if (!tasks || tasks.length === 0) {
        return { completionRate: 0, habitFire: 0 };
    }

    const completed = tasks.filter(t => t.completed).length;
    const completionRate = Math.round((completed / tasks.length) * 100);

    // Habit Fire: Longest current streak among active recurring tasks
    let maxStreak = 0;
    tasks.forEach(t => {
        if (t.currentStreak && t.currentStreak > maxStreak) {
            maxStreak = t.currentStreak;
        }
    });

    return { completionRate, habitFire: maxStreak };
};

export const calculateWorkbookStats = (answersSnapshotSize: number, totalQuestionsAvailable: number = 50): WorkbookStats => {
    // Note: totalQuestionsAvailable is defaulted to 50 for now, 
    // ideally passed from the Workbook definitions if available.
    
    return {
        wisdomScore: answersSnapshotSize,
        masterCompletion: Math.round((answersSnapshotSize / totalQuestionsAvailable) * 100)
    };
};

================================================================================
FILE: src/lib/gemini.ts
================================================================================
import { 
  GoogleGenerativeAI, 
  HarmCategory, 
  HarmBlockThreshold,
  type GenerationConfig,
  type SafetySetting
} from "@google/generative-ai";

// --- Configuration ---
// Ensure your VITE_GEMINI_API_KEY is set in .env
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;
if (!API_KEY) {
  console.error("Missing VITE_GEMINI_API_KEY in environment variables");
}

const genAI = new GoogleGenerativeAI(API_KEY);

// Master Build Guide v2.6 specifies Gemini 2.5 Flash
const MODEL_NAME = "gemini-2.5-flash"; 

const generationConfig: GenerationConfig = {
  temperature: 0.7, // Balanced for creative but structured analysis
  topP: 0.95,
  topK: 40,
  maxOutputTokens: 8192,
  responseMimeType: "application/json", // Enforce JSON mode
};

// Safety Settings: Adjusted for Recovery Context
const safetySettings: SafetySetting[] = [
  {
    category: HarmCategory.HARM_CATEGORY_HARASSMENT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
  {
    category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,
  },
];

// --- 1. JOURNAL ANALYSIS (Recovery Compass) ---

export interface AnalysisResult {
  sentiment: 'Positive' | 'Neutral' | 'Negative';
  mood: string;
  summary: string;
  risk_analysis: string;
  positive_reinforcement: string;
  tool_suggestions: string[];
}

/**
 * Analyzes journal entries using the "Recovery Compass" framework.
 */
export async function analyzeJournalEntries(journalEntries: string[]): Promise<AnalysisResult> {
  try {
    const model = genAI.getGenerativeModel({ 
      model: MODEL_NAME,
      generationConfig,
      safetySettings
    });

    const prompt = `
      You are an expert recovery sponsor and therapist proxy for a user in addiction recovery. 
      Analyze the following journal entries and provide a structured "Recovery Compass" analysis.
      
      Entries:
      ${JSON.stringify(journalEntries)}

      Return a JSON object with this EXACT structure (no Markdown):
      {
        "sentiment": "Positive" | "Neutral" | "Negative",
        "mood": "Two word description of the emotional tone (e.g. Anxious Hope)",
        "summary": "A brief, 2-3 sentence synthesis of the user's current headspace.",
        "risk_analysis": "Identify potential relapse triggers, cognitive distortions, or HALT (Hungry, Angry, Lonely, Tired) signs. Be gentle but direct.",
        "positive_reinforcement": "Highlight specific examples of resilience, gratitude, or good recovery work found in the text.",
        "tool_suggestions": ["Tool 1", "Tool 2", "Tool 3"]
      }

      The tool_suggestions must be practical, recovery-focused actions.
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    // Clean up potential markdown code blocks
    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();

    return JSON.parse(cleanText) as AnalysisResult;

  } catch (error) {
    console.error("Gemini Journal Analysis Failed:", error);
    // Fallback if API fails
    return {
      sentiment: 'Neutral',
      mood: 'System Offline',
      summary: "Unable to generate analysis. Keep writing!",
      risk_analysis: 'None detected.',
      positive_reinforcement: 'Your commitment to journaling is a strength.',
      tool_suggestions: ['Check internet connection', 'Try again later']
    };
  }
}

// --- 2. WORKBOOK ANALYSIS (Restored Original Structure) ---

export interface WorkbookInsight {
  feedback: string;
  encouragement: string;
}

export async function analyzeFullWorkbook(workbookTitle: string, fullContent: string | Record<string, string>): Promise<WorkbookInsight> {
  try {
    const model = genAI.getGenerativeModel({ 
        model: MODEL_NAME,
        generationConfig,
        safetySettings
    });

    // Handle both string and Record input types for flexibility
    const contentString = typeof fullContent === 'string' 
        ? fullContent 
        : Object.entries(fullContent).map(([k, v]) => `Q: ${k}\nA: ${v}`).join('\n');

    const prompt = `
      You are a compassionate Recovery Sponsor reviewing a sponsee's entire workbook.
      
      Workbook: "${workbookTitle}"
      
      User's Answers:
      ${contentString}

      Please analyze their work holistically. Look for patterns across different sections, emotional trajectory, and depth of honesty.
      
      Return a JSON object with this structure (no Markdown):
      {
        "feedback": "A deep, insightful paragraph (4-6 sentences) connecting the dots between their answers. Mention specific patterns you notice across the workbook.",
        "encouragement": "A strong, motivating closing statement."
      }
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();

    return JSON.parse(cleanText) as WorkbookInsight;

  } catch (error) {
    console.error("Gemini Workbook Error:", error);
    return {
      feedback: "You have done a significant amount of work here. The consistency in your answers shows a real desire for change.",
      encouragement: "Keep trusting the process!"
    };
  }
}

// --- 3. LEGACY SUPPORT ---

// Deprecated single-section analyzer (kept for type safety if referenced elsewhere)
export async function analyzeWorkbook(sectionTitle: string, qaPairs: { question: string, answer: string }[]): Promise<WorkbookInsight> {
  return analyzeFullWorkbook(sectionTitle, JSON.stringify(qaPairs));
}

================================================================================
FILE: src/lib/importer.ts
================================================================================
import { collection, doc, writeBatch, Timestamp } from 'firebase/firestore';
import { db } from './firebase';

// 1. Define the target format (Your current app schema)
export interface NewJournalEntry {
  uid: string;
  content: string;
  moodScore: number;
  sentiment: string;
  weather: { temp: number; condition: string } | null;
  createdAt: Timestamp;
  tags: string[];
}

// 2. Define the exact Legacy format based on your uploaded JSON
interface LegacyEntry {
  id: string;
  text: string;
  mood: number;
  weather?: string;
  tags?: string[];
  timestamp: string;
}

// 3. Helper to parse weather string "Partly Cloudy, -6¬∞C" -> { condition, temp }
const parseLegacyWeather = (weatherStr?: string): { temp: number; condition: string } | null => {
  if (!weatherStr || typeof weatherStr !== 'string') return null;

  // Regex to capture "Condition" and "Temp" (e.g. "Partly Cloudy, -6¬∞C")
  // Matches: Group 1 (Condition), Group 2 (Number)
  const match = weatherStr.match(/^(.*),\s*(-?\d+)¬∞C$/);

  if (match) {
    return {
      condition: match[1].trim(),
      temp: parseInt(match[2], 10)
    };
  }

  // Fallback if format is different but not empty
  if (weatherStr.trim().length > 0) {
    return { condition: weatherStr, temp: 0 };
  }

  return null;
};

// 4. The Mapper Function
// Converts "LegacyEntry" -> "NewJournalEntry"
const mapLegacyEntry = (uid: string, entry: LegacyEntry): NewJournalEntry => {
  // Handle mood: Legacy app seems to use 0 for unset. New app uses 1-10.
  // We map 0 to 5 (Neutral), and clamp others between 1-10.
  let mood = entry.mood || 5;
  if (mood === 0) mood = 5;
  mood = Math.max(1, Math.min(10, mood));

  return {
    uid,
    content: entry.text || "", // Map 'text' to 'content'
    moodScore: mood,
    sentiment: 'Neutral', // Legacy data doesn't have sentiment, default to Neutral
    weather: parseLegacyWeather(entry.weather),
    createdAt: Timestamp.fromDate(new Date(entry.timestamp)), // Parse ISO string
    tags: Array.isArray(entry.tags) ? entry.tags : [] // Carry over tags
  };
};

// 5. Main Import Function
export async function importLegacyJournals(uid: string, file: File): Promise<{ success: number; errors: number }> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        // FIX: Guard clause to ensure db is initialized
        if (!db) {
            reject(new Error("Firestore database is not initialized"));
            return;
        }

        const text = e.target?.result as string;
        const json = JSON.parse(text);

        // Ensure it's an array
        const rawEntries = Array.isArray(json) ? json : [json];
        
        if (rawEntries.length === 0) {
          resolve({ success: 0, errors: 0 });
          return;
        }

        // Process in batches of 500 (Firestore limit)
        let batch = writeBatch(db);
        let operationCount = 0;
        let successCount = 0;
        let errorCount = 0;

        for (const raw of rawEntries) {
          try {
            // Validate essential fields before mapping
            if (!raw.timestamp) {
              console.warn("Skipping entry without timestamp:", raw.id);
              errorCount++;
              continue;
            }

            const mappedData = mapLegacyEntry(uid, raw as LegacyEntry);
            
            // Generate a new ID for the document (ignoring legacy ID to avoid collision/format issues)
            const newDocRef = doc(collection(db, 'journals'));
            batch.set(newDocRef, mappedData);
            
            operationCount++;
            successCount++;

            // If we hit 450 (safety buffer below 500), commit and restart batch
            if (operationCount >= 450) {
              await batch.commit();
              batch = writeBatch(db); // New batch
              operationCount = 0;
            }
          } catch (err) {
            console.warn("Skipping invalid entry:", raw.id, err);
            errorCount++;
          }
        }

        // Commit any remaining ops
        if (operationCount > 0) {
          await batch.commit();
        }

        resolve({ success: successCount, errors: errorCount });

      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = (error) => reject(error);
    reader.readAsText(file);
  });
}

================================================================================
FILE: src/lib/insights.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import type { AnalysisResult } from "./gemini";

const COLLECTION = 'insights';

/**
 * Saves a new AI Insight to Firestore.
 * Updated to support the new "Recovery Compass" data structure.
 * @param uid - The User ID
 * @param result - The structured result from Gemini
 */
export async function saveInsight(uid: string, result: AnalysisResult) {
  if (!db) throw new Error("Database not initialized");

  await addDoc(collection(db, COLLECTION), {
    uid,
    createdAt: Timestamp.now(),
    
    // --- New Recovery Compass Fields ---
    sentiment: result.sentiment,
    mood: result.mood,
    summary: result.summary,                 // Replaces old 'analysis'
    risk_analysis: result.risk_analysis,
    positive_reinforcement: result.positive_reinforcement,
    tool_suggestions: result.tool_suggestions, // Replaces old 'actionableSteps'
    
    // Note: We no longer save 'analysis' or 'actionableSteps' because 
    // they don't exist on the new result object.
  });
}

/**
 * Fetches the history of AI Insights for a user, sorted by newest first.
 * Used by the Dashboard to show the "Latest Insight".
 */
export async function getInsightHistory(uid: string) {
  if (!db) throw new Error("Database not initialized");

  try {
    const q = query(
      collection(db, COLLECTION),
      where("uid", "==", uid),
      orderBy("createdAt", "desc")
    );

    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      // Safely convert Firestore Timestamp to JS Date
      createdAt: doc.data().createdAt?.toDate() || new Date() 
    }));

  } catch (e: any) {
    console.error("Error fetching insights:", e);
    // If we hit a Missing Index error (common with new collections),
    // warn the user to check the console.
    if (e.message && e.message.includes("index")) {
        console.warn("‚ö†Ô∏è MISSING INDEX: Open your browser console and click the Firebase link to create the index for 'insights'.");
    }
    return [];
  }
}

================================================================================
FILE: src/lib/journal.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp,
  deleteDoc,
  doc,
  updateDoc // <--- Added this
} from "firebase/firestore";
import { db } from "./firebase";
import type { WeatherData } from "./weather";

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  tags: string[];
  moodScore: number;
  weather?: WeatherData | null;
  createdAt: Date;
}

const COLLECTION = 'journals';

// 1. CREATE
export async function addJournalEntry(
  uid: string, 
  content: string, 
  moodScore: number, 
  tags: string[],
  weather: WeatherData | null
) {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, COLLECTION), {
    uid,
    content,
    tags,
    moodScore,
    weather: weather || null, 
    createdAt: Timestamp.now()
  });
}

// 2. READ
export async function getUserJournals(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt.toDate()
  })) as JournalEntry[];
}

// 3. UPDATE (New)
export async function updateJournalEntry(
  id: string,
  content: string, 
  moodScore: number, 
  tags: string[]
) {
  if (!db) throw new Error("Database not initialized");
  const docRef = doc(db, COLLECTION, id);
  await updateDoc(docRef, {
    content,
    moodScore,
    tags,
    // We do NOT update createdAt or weather, as those are historical facts
  });
}

// 4. DELETE
export async function deleteJournalEntry(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

================================================================================
FILE: src/lib/tasks.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  doc, 
  updateDoc,
  deleteDoc, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { startOfDay, isBefore, addDays, addWeeks, addMonths, isSameDay } from "date-fns";

export type Frequency = 'once' | 'daily' | 'weekly' | 'monthly';
export type Priority = 'High' | 'Medium' | 'Low';

export interface Task {
  id?: string;
  uid: string;
  title: string;
  isRecurring: boolean;
  frequency: Frequency;
  priority: Priority; // ADDED
  currentStreak: number;
  lastCompletedAt: Date | null;
  dueDate: Date;
  createdAt: Date;
}

const COLLECTION = 'tasks';

// 1. CREATE
export async function addTask(
  uid: string, 
  title: string, 
  frequency: Frequency, 
  priority: Priority, // ADDED
  startDate: Date // ADDED for Approach 3
) {
  if (!db) throw new Error("Database not initialized");
  
  const isRecurring = frequency !== 'once';
  // Ensure date is start of day to avoid time zone drift
  const due = startOfDay(startDate);

  await addDoc(collection(db, COLLECTION), {
    uid,
    title,
    isRecurring,
    frequency,
    priority,
    currentStreak: 0,
    lastCompletedAt: null,
    dueDate: Timestamp.fromDate(due),
    createdAt: Timestamp.now()
  });
}

// 2. READ & LAZY EVALUATE STREAKS
export async function getUserTasks(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid)
  );

  const snapshot = await getDocs(q);
  const tasks: Task[] = [];
  const today = startOfDay(new Date());

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    // Safely convert Timestamps to Dates
    const task = { 
      id: docSnap.id, 
      ...data,
      dueDate: data.dueDate?.toDate(),
      lastCompletedAt: data.lastCompletedAt?.toDate(),
      createdAt: data.createdAt?.toDate()
    } as Task;

    // --- LAZY EVALUATION LOGIC (Preserved from your code) ---
    // If it's recurring, overdue, and NOT completed today:
    if (task.isRecurring && isBefore(task.dueDate, today)) {
        
        const completedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
        
        if (!completedToday) {
            let newStreak = task.currentStreak;
            
            // Punishment Logic
            if (newStreak > 0) {
                newStreak = 0; // Break positive streak
            } else {
                newStreak -= 1; // Deepen negative streak
            }

            // Reset due date to Today so they can get back on track (Smart Reset)
            const taskRef = doc(db, COLLECTION, task.id!);
            await updateDoc(taskRef, {
                currentStreak: newStreak,
                dueDate: Timestamp.fromDate(today)
            });

            task.currentStreak = newStreak;
            task.dueDate = today;
        }
    }

    tasks.push(task);
  }

  return tasks;
}

// 3. TOGGLE COMPLETION
export async function toggleTask(task: Task, isCompleted: boolean) {
  if (!db) throw new Error("Database not initialized");
  const taskRef = doc(db, COLLECTION, task.id!);
  const today = startOfDay(new Date());

  if (isCompleted) {
    // MARKING DONE
    let newStreak = task.currentStreak;
    if (newStreak < 0) {
        newStreak = 1; // Bounce back from negative
    } else {
        newStreak += 1;
    }

    // Calculate next due date (Smart Reset Approach)
    // We calculate from TODAY, ensuring users don't get stuck in the past
    let nextDue = task.dueDate;
    if (task.frequency === 'daily') nextDue = addDays(today, 1);
    else if (task.frequency === 'weekly') nextDue = addWeeks(today, 1);
    else if (task.frequency === 'monthly') nextDue = addMonths(today, 1);
    
    // If 'once', we don't change the due date, it just gets marked done.

    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: Timestamp.fromDate(new Date()),
        // Only update due date if recurring
        ...(task.isRecurring && { dueDate: Timestamp.fromDate(nextDue) })
    });

  } else {
    // UNCHECKING (Undo)
    const newStreak = task.currentStreak > 0 ? task.currentStreak - 1 : task.currentStreak;
    
    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: null,
        // If unchecking, we usually want to reset the due date to "Today" or the original due date.
        // For simplicity in recovery, if you uncheck it, it becomes due today.
        dueDate: Timestamp.fromDate(today)
    });
  }
}

// 4. DELETE
export async function deleteTask(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

// 5. GET COMPLETED TODAY
export async function getCompletedTasksForToday(uid: string) {
    if (!db) throw new Error("Database not initialized");
    const today = startOfDay(new Date());
    const allTasks = await getUserTasks(uid);
    
    return allTasks.filter(t => 
        t.lastCompletedAt && isSameDay(t.lastCompletedAt, today)
    );
}

================================================================================
FILE: src/lib/weather.ts
================================================================================
// Maps WMO Weather Codes to human readable text
function getWeatherCondition(code: number): string {
  if (code === 0) return 'Clear sky';
  if (code >= 1 && code <= 3) return 'Partly cloudy';
  if (code >= 45 && code <= 48) return 'Foggy';
  if (code >= 51 && code <= 55) return 'Drizzle';
  if (code >= 61 && code <= 65) return 'Rain';
  if (code >= 71 && code <= 77) return 'Snow';
  if (code >= 95 && code <= 99) return 'Thunderstorm';
  return 'Unknown';
}

export interface WeatherData {
  temp: number;
  condition: string;
  location: string; // We'll just store "Lat/Lon" or a generic name for now
}

export async function getCurrentWeather(): Promise<WeatherData | null> {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported");
    return null;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          
          // Using Open-Meteo (Free, No Key Required)
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius`
          );
          
          if (!response.ok) throw new Error("Weather API failed");
          
          const data = await response.json();
          const weather = data.current_weather;

          resolve({
            temp: weather.temperature,
            condition: getWeatherCondition(weather.weathercode),
            location: 'Local' // We could use a reverse geocoding API here later if needed
          });
        } catch (error) {
          console.error("Error fetching weather:", error);
          resolve(null);
        }
      },
      (error) => {
        console.warn("Location permission denied or failed", error);
        resolve(null);
      }
    );
  });
}

================================================================================
FILE: src/lib/workbooks.ts
================================================================================
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from './firebase';

// Data structure for Firestore:
// users/{uid}/workbook_answers/{workbookId}_{sectionId}
// Document contains: { [questionId]: "Answer text", lastUpdated: timestamp }

export interface WorkbookProgress {
  [questionId: string]: string;
}

export async function saveAnswer(uid: string, workbookId: string, sectionId: string, questionId: string, answer: string) {
  if (!db) throw new Error("Firestore database is not initialized");

  const docId = `${workbookId}_${sectionId}`;
  const docRef = doc(db, 'users', uid, 'workbook_answers', docId);

  // Use setDoc with merge: true to create if not exists or update if exists
  await setDoc(docRef, {
    [questionId]: answer,
    lastUpdated: new Date()
  }, { merge: true });
}

export async function getSectionAnswers(uid: string, workbookId: string, sectionId: string): Promise<WorkbookProgress> {
  if (!db) throw new Error("Firestore database is not initialized");

  const docId = `${workbookId}_${sectionId}`;
  const docRef = doc(db, 'users', uid, 'workbook_answers', docId);
  const snapshot = await getDoc(docRef);

  if (snapshot.exists()) {
    return snapshot.data() as WorkbookProgress;
  }
  return {};
}

// Helper to check completion status for a section
export async function getSectionCompletion(uid: string, workbookId: string, sectionId: string, totalQuestions: number): Promise<number> {
  const answers = await getSectionAnswers(uid, workbookId, sectionId);
  
  // LOGIC UPDATE: Only count answers that are non-empty strings
  const answeredCount = Object.entries(answers).filter(([key, value]) => {
    // Ignore metadata keys like 'lastUpdated'
    if (key === 'lastUpdated') return false;
    // Ensure value is a string and has content (not just whitespace)
    return typeof value === 'string' && value.trim().length > 0;
  }).length;
  
  if (totalQuestions === 0) return 0;
  
  return Math.round((answeredCount / totalQuestions) * 100);
}

// --- NEW FUNCTION: Fetch ALL answers for a specific workbook ---
export async function getAllWorkbookAnswers(uid: string, workbookId: string, sections: { id: string, title: string }[]): Promise<string> {
  if (!db) throw new Error("Firestore database is not initialized");

  // Fetch all section documents in parallel
  const promises = sections.map(async (section) => {
    const answers = await getSectionAnswers(uid, workbookId, section.id);
    
    // Convert the object { q1: "text", q2: "text" } into a readable string
    const answerText = Object.entries(answers)
      .filter(([key, value]) => key !== 'lastUpdated' && typeof value === 'string' && value.trim().length > 0)
      .map(([_, value]) => `- ${value}`)
      .join('\n');

    if (!answerText) return null; // Skip empty sections

    return `SECTION: ${section.title}\n${answerText}`;
  });

  const results = await Promise.all(promises);
  return results.filter(r => r !== null).join('\n\n');
}

================================================================================
FILE: src/main.tsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css' // <--- THIS IS THE CRITICAL MISSING LINE

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

================================================================================
FILE: src/pages/Dashboard.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, query, where, orderBy, getDocs, doc, getDoc } from 'firebase/firestore';
import { Link } from 'react-router-dom';
import { 
    ClipboardDocumentCheckIcon,
    SparklesIcon,
    ArrowRightIcon,
} from '@heroicons/react/24/outline';
import { calculateJournalStats, calculateTaskStats, calculateWorkbookStats } from '../lib/gamification';
import RecoveryHero from '../components/RecoveryHero';

// Estimated Total Questions across all workbooks for gamification calc
const TOTAL_WORKBOOK_QUESTIONS = 45; 

export default function Dashboard() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  
  // Data State
  const [daysClean, setDaysClean] = useState<number>(0);
  const [journalStats, setJournalStats] = useState({ streak: 0, consistency: 0 });
  const [taskStats, setTaskStats] = useState({ rate: 0, fire: 0 });
  const [workbookStats, setWorkbookStats] = useState({ wisdom: 0, completion: 0 });
  
  const [recentTasks, setRecentTasks] = useState<any[]>([]);
  const [latestInsight, setLatestInsight] = useState<any>(null);

  useEffect(() => {
    if (!user) return;

    const loadDashboardData = async () => {
        if (!db) return;

        try {
            // 0. Fetch User Profile for Sobriety Date
            const userDocRef = doc(db, 'users', user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                if (userData.sobrietyDate) {
                    const start = userData.sobrietyDate.toDate ? userData.sobrietyDate.toDate() : new Date(userData.sobrietyDate);
                    const now = new Date();
                    const diffTime = Math.abs(now.getTime() - start.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    setDaysClean(diffDays);
                }
            }

            // 1. Fetch Journals for Stats
            const journalQ = query(
                collection(db, 'journals'), 
                where('uid', '==', user.uid),
                orderBy('createdAt', 'desc')
            );
            const journalSnap = await getDocs(journalQ);
            const journals = journalSnap.docs.map(d => ({...d.data(), createdAt: d.data().createdAt}));
            const jStats = calculateJournalStats(journals);
            setJournalStats({ 
                streak: jStats.journalStreak, 
                consistency: jStats.consistencyRate
            });

            // 2. Fetch Tasks
            const taskQ = query(collection(db, 'tasks'), where('uid', '==', user.uid));
            const taskSnap = await getDocs(taskQ);
            const tasks = taskSnap.docs.map(d => d.data());
            const tStats = calculateTaskStats(tasks);
            setTaskStats({ rate: tStats.completionRate, fire: tStats.habitFire });

            // Get top 3 pending tasks
            const pendingTasks = taskSnap.docs
                .map(d => ({ id: d.id, ...d.data() } as any))
                .filter(t => !t.completed)
                .sort((_a, b) => (b.priority === 'High' ? 1 : -1)) 
                .slice(0, 3);
            setRecentTasks(pendingTasks);

            // 3. Fetch Workbook Answers
            const wbQ = query(collection(db, 'users', user.uid, 'workbook_answers'));
            const wbSnap = await getDocs(wbQ);
            const wStats = calculateWorkbookStats(wbSnap.size, TOTAL_WORKBOOK_QUESTIONS);
            setWorkbookStats({ wisdom: wStats.wisdomScore, completion: wStats.masterCompletion });

            // 4. Fetch Latest Insight
            if (journals.length > 0) {
                const last = journals[0] as any;
                if (last.sentiment) {
                    setLatestInsight({
                        date: last.createdAt.toDate(),
                        sentiment: last.sentiment,
                        snippet: last.content.substring(0, 80) + "..."
                    });
                }
            }

        } catch (error) {
            console.error("Dashboard load error:", error);
        } finally {
            setLoading(false);
        }
    };

    loadDashboardData();
  }, [user]);

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your recovery hub...</div>;

  return (
    <div className="max-w-5xl mx-auto space-y-6">
      
      {/* 1. RECOVERY HERO COMPONENT */}
      <RecoveryHero 
         userName={user?.displayName?.split(' ')[0] || 'Friend'}
         daysClean={daysClean}
         journalStats={journalStats}
         taskStats={taskStats}
         workbookStats={workbookStats}
      />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          
          {/* 2. PRIORITIES WIDGET */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
              <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2">
                      <ClipboardDocumentCheckIcon className="h-5 w-5 text-blue-600" />
                      Priority Focus
                  </h3>
                  <Link to="/tasks" className="text-sm text-blue-600 hover:underline">View All</Link>
              </div>
              
              {recentTasks.length === 0 ? (
                  <div className="text-center py-8 text-gray-400 bg-gray-50 rounded-lg">
                      <p>All clear! No pending tasks.</p>
                      <Link to="/tasks" className="text-sm text-blue-600 font-medium mt-2 inline-block">Add a Habit +</Link>
                  </div>
              ) : (
                  <div className="space-y-3">
                      {recentTasks.map(task => (
                          <div key={task.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                              <div className={`h-3 w-3 rounded-full ${task.priority === 'High' ? 'bg-red-500' : 'bg-blue-400'}`} />
                              <span className="flex-1 font-medium text-gray-700 truncate">{task.title}</span>
                              <Link to="/tasks" className="text-gray-400 hover:text-blue-600">
                                  <ArrowRightIcon className="h-4 w-4" />
                              </Link>
                          </div>
                      ))}
                  </div>
              )}
          </div>

          {/* 3. LATEST INSIGHT */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
              <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2">
                      <SparklesIcon className="h-5 w-5 text-purple-600" />
                      Latest Insight
                  </h3>
                  <Link to="/journal" className="text-sm text-purple-600 hover:underline">View Journal</Link>
              </div>

              {latestInsight ? (
                  <div className="bg-purple-50 rounded-xl p-4 border border-purple-100">
                      <div className="flex items-center justify-between mb-2">
                           <span className="text-xs font-bold text-purple-700 uppercase tracking-wider">{latestInsight.sentiment} Sentiment</span>
                           <span className="text-xs text-purple-400">{latestInsight.date.toLocaleDateString()}</span>
                      </div>
                      <p className="text-sm text-gray-700 italic mb-3">"{latestInsight.snippet}"</p>
                      <Link to="/journal" className="w-full block text-center bg-white text-purple-600 text-sm font-bold py-2 rounded-lg border border-purple-200 hover:bg-purple-50 transition-colors">
                          Analyze Deeply
                      </Link>
                  </div>
              ) : (
                  <div className="text-center py-8 text-gray-400 bg-gray-50 rounded-lg">
                      <p>No recent analysis found.</p>
                      <Link to="/journal" className="text-sm text-purple-600 font-medium mt-2 inline-block">Write Entry +</Link>
                  </div>
              )}
          </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Journal.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getUserJournals } from '../lib/journal';
import { calculateJournalStats } from '../lib/gamification';
import { 
    FireIcon, 
    ChartBarIcon, 
    PencilSquareIcon 
} from '@heroicons/react/24/outline';
import JournalTabs from '../components/journal/JournalTabs';
import JournalEditor, { type JournalEntry } from '../components/journal/JournalEditor';
import JournalHistory from '../components/journal/JournalHistory';
import JournalInsights from '../components/journal/JournalInsights';

const MANTRAS = [
  "One day at a time.",
  "Progress, not perfection.",
  "This too shall pass.",
  "Serenity, Courage, Wisdom.",
  "Keep coming back.",
  "Easy does it.",
  "First things first.",
  "Let go and let God.",
  "To thine own self be true.",
  "Just for today.",
  "Feelings are not facts.",
  "Nothing changes if nothing changes."
];

export default function Journal() {
  const { user } = useAuth();
  
  // Navigation State
  const [activeTab, setActiveTab] = useState<'write' | 'history' | 'insights'>('write');
  const [editingEntry, setEditingEntry] = useState<JournalEntry | null>(null);

  // Header Data State
  const [greeting, setGreeting] = useState('Welcome');
  const [streak, setStreak] = useState(0);
  const [consistency, setConsistency] = useState(0);
  const [totalWords, setTotalWords] = useState(0);
  const [mantra, setMantra] = useState('');

  // Initial Load Logic (Greeting, Mantra, Streak)
  useEffect(() => {
    // 1. Set Greeting based on time
    const hour = new Date().getHours();
    if (hour < 12) setGreeting('Good Morning');
    else if (hour < 18) setGreeting('Good Afternoon');
    else setGreeting('Good Evening');

    // 2. Pick Random Mantra
    setMantra(MANTRAS[Math.floor(Math.random() * MANTRAS.length)]);

    // 3. Calculate Stats
    const loadStats = async () => {
        if (!user) return;
        try {
            const journals = await getUserJournals(user.uid);
            const stats = calculateJournalStats(journals);
            setStreak(stats.journalStreak);
            setConsistency(stats.consistencyRate);
            setTotalWords(stats.totalWords);
        } catch (error) {
            console.error("Failed to load journal stats", error);
        }
    };
    loadStats();
  }, [user]);

  // Called when user clicks "Edit" in History tab
  const handleEditRequest = (entry: JournalEntry) => {
    setEditingEntry(entry);
    setActiveTab('write');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Called when Editor successfully saves
  const handleSaveComplete = () => {
    setEditingEntry(null);
    setActiveTab('history'); // Auto-switch to history to see the result
  };

  return (
    <div className="max-w-5xl mx-auto -mt-6">
      
      {/* --- SMART HEADER --- */}
      <div className="mb-8 p-6 bg-gradient-to-r from-white to-blue-50/30 rounded-2xl border border-blue-50 shadow-sm animate-fadeIn">
         <div className="flex flex-col md:flex-row items-center justify-between gap-4">
             <div className="text-center md:text-left">
                <h1 className="text-2xl font-bold text-gray-900 tracking-tight">
                    {greeting}, <span className="text-blue-700">{user?.displayName ? user.displayName.split(' ')[0] : 'Friend'}</span>
                </h1>
                <p className="text-gray-500 font-medium mt-1 italic text-sm">
                    "{mantra}"
                </p>
             </div>
             
             {/* GAMIFICATION BADGES ROW (Reduced size for mobile fit) */}
             <div className="flex flex-wrap items-center justify-center md:justify-end gap-2">
                 
                 {/* 1. Streak Badge */}
                 <div className="flex items-center gap-1.5 bg-white px-2 py-1 rounded-full shadow-sm border border-blue-100 transition-transform hover:scale-105 cursor-default" title="Your current daily journaling streak">
                    <FireIcon className={`h-3.5 w-3.5 ${streak > 0 ? 'text-orange-500' : 'text-gray-300'}`} />
                    <span className="text-xs font-bold text-gray-700">{streak} Day Streak</span>
                 </div>

                 {/* 2. Consistency Badge */}
                 <div className="flex items-center gap-1.5 bg-white px-2 py-1 rounded-full shadow-sm border border-blue-100 transition-transform hover:scale-105 cursor-default" title="Average entries per week">
                    <ChartBarIcon className="h-3.5 w-3.5 text-blue-500" />
                    <span className="text-xs font-bold text-gray-700">{consistency} / wk</span>
                 </div>

                 {/* 3. Word Count Badge */}
                 <div className="flex items-center gap-1.5 bg-white px-2 py-1 rounded-full shadow-sm border border-blue-100 transition-transform hover:scale-105 cursor-default" title="Total words journaled">
                    <PencilSquareIcon className="h-3.5 w-3.5 text-purple-500" />
                    <span className="text-xs font-bold text-gray-700">{totalWords.toLocaleString()} Words</span>
                 </div>

             </div>
         </div>
      </div>

      <JournalTabs activeTab={activeTab} onChange={setActiveTab} />

      <div className="transition-opacity duration-200">
        {activeTab === 'write' ? (
          <JournalEditor 
            initialEntry={editingEntry} 
            onSaveComplete={handleSaveComplete} 
          />
        ) : activeTab === 'history' ? (
          <JournalHistory 
            onEdit={handleEditRequest} 
          />
        ) : (
          <JournalInsights />
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Login.tsx
================================================================================
import { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { ShieldCheckIcon, EnvelopeIcon, LockClosedIcon } from '@heroicons/react/24/outline';

export default function Login() {
  const { loginWithGoogle, loginWithEmail, signupWithEmail } = useAuth();
  const navigate = useNavigate();
  
  const [isLogin, setIsLogin] = useState(true); // Toggle state
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPass, setConfirmPass] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // Handle Google Login
  const handleGoogleLogin = async () => {
    try {
      setError('');
      setLoading(true);
      await loginWithGoogle();
      navigate('/dashboard');
    } catch (error) {
      console.error(error);
      setError('Failed to sign in with Google.');
    } finally {
      setLoading(false);
    }
  };

  // Handle Email Submit
  const handleEmailSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    // Basic Validation
    if (!email || !password) {
        setError("Please fill in all fields.");
        setLoading(false);
        return;
    }
    
    if (!isLogin && password !== confirmPass) {
        setError("Passwords do not match.");
        setLoading(false);
        return;
    }

    if (password.length < 6) {
        setError("Password should be at least 6 characters.");
        setLoading(false);
        return;
    }

    try {
      if (isLogin) {
        await loginWithEmail(email, password);
      } else {
        await signupWithEmail(email, password);
      }
      navigate('/dashboard');
    } catch (err: any) {
      console.error(err);
      // Firebase error mapping
      if (err.code === 'auth/email-already-in-use') {
        setError('That email is already in use.');
      } else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
        setError('Invalid email or password.');
      } else {
        setError('Failed to authenticate. Please try again.');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
             <ShieldCheckIcon className="h-10 w-10 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">
            My Recovery Toolkit
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            {isLogin ? 'Sign in to your account' : 'Create a new account'}
          </p>
        </div>

        {/* Error Message */}
        {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm text-center">
                {error}
            </div>
        )}

        {/* Email Form */}
        <form className="mt-8 space-y-4" onSubmit={handleEmailSubmit}>
            <div className="space-y-4">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <EnvelopeIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="email"
                        required
                        placeholder="Email address"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <LockClosedIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="password"
                        required
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                {!isLogin && (
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <LockClosedIcon className="h-5 w-5 text-gray-400" />
                        </div>
                        <input
                            type="password"
                            required
                            placeholder="Confirm Password"
                            value={confirmPass}
                            onChange={(e) => setConfirmPass(e.target.value)}
                            className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                        />
                    </div>
                )}
            </div>

            <button
                type="submit"
                disabled={loading}
                className="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
            >
                {loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}
            </button>
        </form>

        <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
        </div>

        {/* Google Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading}
          className="w-full flex items-center justify-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
        >
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="h-5 w-5 mr-2" />
          Sign in with Google
        </button>

        {/* Toggle Mode */}
        <div className="text-center mt-4">
            <p className="text-sm text-gray-600">
                {isLogin ? "Don't have an account? " : "Already have an account? "}
                <button 
                    onClick={() => {
                        setIsLogin(!isLogin);
                        setError('');
                        setEmail('');
                        setPassword('');
                        setConfirmPass('');
                    }}
                    className="font-medium text-blue-600 hover:text-blue-500"
                >
                    {isLogin ? 'Sign up' : 'Sign in'}
                </button>
            </p>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Profile.tsx
================================================================================
import { useState, useRef, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { getProfile, updateProfileData } from '../lib/db';
import { importLegacyJournals } from '../lib/importer';
import { 
  UserCircleIcon, 
  ArrowLeftOnRectangleIcon, 
  ArrowUpTrayIcon, 
  CheckCircleIcon,
  ExclamationCircleIcon 
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function Profile() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  
  // --- VERSIONING ---
  const appVersion = import.meta.env.VITE_APP_VERSION || 'Dev-Local';
  
  const [displayName, setDisplayName] = useState('');
  const [sobrietyDate, setSobrietyDate] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

  // Import State
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [importing, setImporting] = useState(false);
  const [importStatus, setImportStatus] = useState<string | null>(null);

  useEffect(() => {
    async function loadProfile() {
      if (user) {
        const data = await getProfile(user.uid);
        if (data) {
          setDisplayName(data.displayName || user.displayName || '');
          // Format date for input field (YYYY-MM-DD)
          if (data.sobrietyDate) {
            setSobrietyDate(data.sobrietyDate.toDate().toISOString().split('T')[0]);
          }
        }
        setLoading(false);
      }
    }
    loadProfile();
  }, [user]);

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    setSaving(true);
    setMessage(null);

    try {
      // Create date object correctly
      let dateObj: Date | null = null;
      if (sobrietyDate) {
         const [y, m, d] = sobrietyDate.split('-').map(Number);
         // Note: Month is 0-indexed in JS Date
         dateObj = new Date(y, m - 1, d);
      }
      
      // Update in Firestore
      await updateProfileData(user.uid, {
        displayName,
        sobrietyDate: dateObj
      });

      setMessage({ type: 'success', text: 'Profile updated successfully' });
    } catch (error) {
      console.error(error);
      setMessage({ type: 'error', text: 'Failed to update profile' });
    } finally {
      setSaving(false);
    }
  };

  // --- IMPORT HANDLER ---
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;

    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
      setImportStatus('Error: Please select a valid JSON file.');
      return;
    }

    setImporting(true);
    setImportStatus('Reading file and mapping data...');

    try {
      const result = await importLegacyJournals(user.uid, file);
      setImportStatus(`Success! Imported ${result.success} entries. (${result.errors} skipped)`);
      // Clear input
      if (fileInputRef.current) fileInputRef.current.value = '';
    } catch (error) {
      console.error("Import failed", error);
      setImportStatus('Error: Import failed. Check console for details.');
    } finally {
      setImporting(false);
    }
  };

  if (loading) return <div>Loading profile...</div>;

  return (
    <div className="max-w-2xl mx-auto space-y-8 pb-10">
      <div className="flex items-center gap-4 border-b border-gray-200 pb-6">
        <div className="h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
           {user?.photoURL ? (
             <img src={user.photoURL} alt="Profile" className="h-16 w-16 rounded-full" />
           ) : (
             <UserCircleIcon className="h-10 w-10" />
           )}
        </div>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">{user?.displayName || 'User Profile'}</h1>
          <p className="text-gray-500">{user?.email}</p>
        </div>
      </div>

      {/* --- PROFILE FORM --- */}
      <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
        <div>
          <label className="block text-sm font-medium text-gray-700">Display Name</label>
          <input
            type="text"
            value={displayName}
            onChange={(e) => setDisplayName(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">Sobriety Date</label>
          <input
            type="date"
            value={sobrietyDate}
            onChange={(e) => setSobrietyDate(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
          <p className="mt-1 text-xs text-gray-500">Used to calculate your recovery stats on the dashboard.</p>
        </div>

        {message && (
          <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
            {message.text}
          </div>
        )}

        <div className="flex justify-end gap-3">
           <button
             type="submit"
             disabled={saving}
             className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
           >
             {saving ? 'Saving...' : 'Save Changes'}
           </button>
        </div>
      </form>

      {/* --- IMPORT SECTION --- */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <ArrowUpTrayIcon className="h-5 w-5 text-gray-500" />
            Import Legacy Data
        </h3>
        <p className="text-sm text-gray-600 mb-4">
            If you have a JSON backup of your journals from the old app, you can import them here. 
            This will add them to your history.
        </p>

        <div className="flex flex-col gap-4">
            <input 
                type="file" 
                accept=".json"
                ref={fileInputRef}
                onChange={handleFileChange}
                className="hidden"
            />
            
            <button 
                type="button"
                onClick={() => fileInputRef.current?.click()}
                disabled={importing}
                className="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-gray-500 hover:border-blue-500 hover:text-blue-500 transition-colors flex flex-col items-center justify-center gap-2"
            >
                {importing ? (
                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                ) : (
                    <ArrowUpTrayIcon className="h-8 w-8" />
                )}
                <span className="font-medium">{importing ? 'Importing...' : 'Click to Select JSON File'}</span>
            </button>

            {importStatus && (
                <div className={`flex items-start gap-2 text-sm p-3 rounded-md ${importStatus.includes('Success') ? 'bg-green-50 text-green-800' : 'bg-yellow-50 text-yellow-800'}`}>
                    {importStatus.includes('Success') ? (
                        <CheckCircleIcon className="h-5 w-5 flex-shrink-0" />
                    ) : (
                        <ExclamationCircleIcon className="h-5 w-5 flex-shrink-0" />
                    )}
                    {importStatus}
                </div>
            )}
        </div>
      </div>

      <div className="border-t border-gray-200 pt-6">
        <button
          onClick={handleLogout}
          className="w-full flex justify-center items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors"
        >
          <ArrowLeftOnRectangleIcon className="h-5 w-5" />
          Log Out
        </button>
      </div>

      {/* --- VERSION INFO --- */}
      <div className="text-center text-xs text-gray-400 font-mono">
          App Version: v{appVersion}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Tasks.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTasks, 
  toggleTask, 
  deleteTask, 
  type Task
} from '../lib/tasks';
import { 
  PlusIcon, 
  TrashIcon, 
  ArrowPathIcon, 
  CheckCircleIcon,
  FireIcon,
  CalendarDaysIcon,
  ClipboardDocumentListIcon,
 // ExclamationCircleIcon
} from '@heroicons/react/24/outline';
import Confetti from 'react-confetti';
import { isSameDay, startOfDay, isBefore } from 'date-fns';
import CreateTaskModal from '../components/CreateTaskModal';

export default function Tasks() {
  const { user } = useAuth();
  const [tasks, setTasks] = useState<Task[]>([]);
  const [loading, setLoading] = useState(true);
  const [showConfetti, setShowConfetti] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);

  // --- STATS CALCULATION ---
  const totalTasks = tasks.filter(t => !t.lastCompletedAt || !isSameDay(t.lastCompletedAt, new Date())).length;
  const dueToday = tasks.filter(t => isSameDay(t.dueDate, new Date()) && (!t.lastCompletedAt || !isSameDay(t.lastCompletedAt, new Date()))).length;
  const totalFire = tasks.reduce((acc, t) => acc + (t.currentStreak > 0 ? t.currentStreak : 0), 0);

  // Fetch Tasks
  const refreshTasks = async () => {
    if (!user) return;
    try {
      const data = await getUserTasks(user.uid);
      
      const today = startOfDay(new Date());
      
      const sorted = data.sort((a, b) => {
        const aCompleted = a.lastCompletedAt && isSameDay(a.lastCompletedAt, today);
        const bCompleted = b.lastCompletedAt && isSameDay(b.lastCompletedAt, today);
        
        if (aCompleted !== bCompleted) return aCompleted ? 1 : -1;
        return a.dueDate.getTime() - b.dueDate.getTime();
      });

      setTasks(sorted);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    refreshTasks();
  }, [user]);

  const handleToggle = async (task: Task) => {
    const today = startOfDay(new Date());
    const isCompletedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
    
    if (!isCompletedToday) {
        setShowConfetti(true);
        setTimeout(() => setShowConfetti(false), 3000);
    }

    await toggleTask(task, !isCompletedToday);
    refreshTasks();
  };

  const handleDelete = async (id: string) => {
    if(confirm('Delete this task?')) {
        await deleteTask(id);
        refreshTasks();
    }
  };

  const getUrgencyStyles = (task: Task) => {
      const today = startOfDay(new Date());
      const target = startOfDay(task.dueDate);
      const isDone = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);

      if (isDone) return 'border-l-gray-300 bg-gray-50 opacity-60';
      if (isBefore(target, today)) return 'border-l-red-500 bg-white shadow-sm ring-1 ring-red-100'; // Overdue
      if (isSameDay(target, today)) return 'border-l-orange-500 bg-white shadow-sm ring-1 ring-orange-100'; // Today
      
      // Future / Standard Priority Colors
      switch (task.priority) {
          case 'High': return 'border-l-blue-600 bg-white shadow-sm';
          case 'Medium': return 'border-l-blue-400 bg-white shadow-sm';
          case 'Low': return 'border-l-blue-200 bg-white shadow-sm';
          default: return 'border-l-gray-200 bg-white shadow-sm';
      }
  };

  const getDateLabel = (date: Date) => {
    const today = startOfDay(new Date());
    const target = startOfDay(date);
    
    if (isBefore(target, today)) return { text: 'Overdue', color: 'text-red-600 font-bold' };
    if (isSameDay(target, today)) return { text: 'Today', color: 'text-orange-600 font-bold' };
    return { text: date.toLocaleDateString(), color: 'text-gray-500' };
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading your ledger...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-8 pb-20">
      {showConfetti && <Confetti numberOfPieces={200} recycle={false} />}

      {/* --- HEADER & MINI HERO --- */}
      <div className="flex flex-col md:flex-row md:items-end justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <ClipboardDocumentListIcon className="h-8 w-8 text-blue-600" />
                Habits & Tasks
            </h1>
            <p className="text-sm text-gray-500 mt-1">Manage your daily habits and tasks.</p>
          </div>
          
          <button
            onClick={() => setIsModalOpen(true)}
            className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-xl font-semibold hover:bg-blue-700 transition-shadow shadow-sm hover:shadow-md"
          >
            <PlusIcon className="h-5 w-5" />
            <span>New Quest</span>
          </button>
      </div>

      {/* MINI STATS GRID */}
      <div className="grid grid-cols-3 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Active</span>
              <span className="text-2xl font-bold text-gray-900">{totalTasks}</span>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Due Today</span>
              <span className={`text-2xl font-bold ${dueToday > 0 ? 'text-orange-500' : 'text-gray-900'}`}>{dueToday}</span>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
              <span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Total Fire</span>
              <div className="flex items-center gap-1 text-2xl font-bold text-orange-600">
                  <FireIcon className="h-6 w-6" />
                  {totalFire}
              </div>
          </div>
      </div>

      {/* --- TASK LIST (Quest Cards) --- */}
      <div className="space-y-3">
        {tasks.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                <ClipboardDocumentListIcon className="h-12 w-12 text-gray-300 mx-auto mb-3" />
                <h3 className="text-lg font-medium text-gray-900">Your Ledger is Empty</h3>
                <p className="text-gray-500">Start a new quest to build your streak.</p>
            </div>
        ) : (
            tasks.map(task => {
                const dateLabel = getDateLabel(task.dueDate);
                const isDoneToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, new Date());
                const urgencyClass = getUrgencyStyles(task);

                return (
                    <div 
                        key={task.id} 
                        className={`relative group rounded-xl p-4 border-l-[6px] transition-all duration-200 ${urgencyClass}`}
                    >
                        <div className="flex items-start gap-4">
                            
                            {/* Check Button */}
                            <button
                                onClick={() => handleToggle(task)}
                                className={`mt-0.5 h-6 w-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                    isDoneToday 
                                    ? 'bg-green-500 border-green-500 text-white scale-110' 
                                    : 'border-gray-300 hover:border-blue-500 text-transparent hover:text-blue-500'
                                }`}
                            >
                                <CheckCircleIcon className="h-4 w-4" />
                            </button>

                            {/* Main Content */}
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center justify-between mb-1">
                                    <span className={`text-base font-semibold ${isDoneToday ? 'text-gray-500 line-through' : 'text-gray-900'}`}>
                                        {task.title}
                                    </span>
                                    
                                    {/* Action Menu (Delete) */}
                                    <button 
                                        onClick={() => task.id && handleDelete(task.id)} 
                                        className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <TrashIcon className="h-4 w-4" />
                                    </button>
                                </div>
                                
                                {/* Metadata Row */}
                                <div className="flex flex-wrap items-center gap-4 text-xs">
                                    <div className={`flex items-center gap-1.5 ${dateLabel.color}`}>
                                        <CalendarDaysIcon className="h-3.5 w-3.5" />
                                        {dateLabel.text}
                                    </div>

                                    {task.isRecurring && (
                                        <div className="flex items-center gap-1 text-blue-600 bg-blue-50 px-2 py-0.5 rounded-md border border-blue-100">
                                            <ArrowPathIcon className="h-3 w-3" />
                                            <span className="capitalize">{task.frequency}</span>
                                        </div>
                                    )}

                                    {/* Priority Badge (only if not done) */}
                                    {!isDoneToday && (
                                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold border ${
                                            task.priority === 'High' ? 'text-red-700 bg-red-50 border-red-100' :
                                            task.priority === 'Medium' ? 'text-yellow-700 bg-yellow-50 border-yellow-100' :
                                            'text-green-700 bg-green-50 border-green-100'
                                        }`}>
                                            {task.priority}
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* Streak Micro-Badge (Right Aligned) */}
                            {(task.currentStreak > 0 || task.currentStreak < 0) && (
                                <div className={`flex flex-col items-center justify-center h-10 w-10 rounded-lg border ${
                                    task.currentStreak > 0 
                                    ? 'bg-orange-50 border-orange-100 text-orange-600' 
                                    : 'bg-red-50 border-red-100 text-red-600'
                                }`}>
                                    <FireIcon className="h-4 w-4 mb-0.5" />
                                    <span className="text-[10px] font-bold leading-none">{Math.abs(task.currentStreak)}</span>
                                </div>
                            )}

                        </div>
                    </div>
                );
            })
        )}
      </div>

      <CreateTaskModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        onTaskAdded={refreshTasks} 
      />
    </div>
  );
}

================================================================================
FILE: src/pages/TemplateEditor.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTemplates,
  saveUserTemplate, 
  deleteUserTemplate, 
  type JournalTemplate 
} from '../lib/db';
import { 
  PlusIcon, 
  TrashIcon, 
  PencilSquareIcon,
  XMarkIcon,
  ArrowLeftIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function TemplateEditor() {
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [templates, setTemplates] = useState<JournalTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Editor State
  const [isEditing, setIsEditing] = useState(false);
  const [currentId, setCurrentId] = useState('');
  const [name, setName] = useState('');
  const [prompts, setPrompts] = useState<string[]>(['']);
  const [tags, setTags] = useState(''); // Comma separated string for input

  useEffect(() => {
    loadTemplates();
  }, [user]);

  async function loadTemplates() {
    if (!user) return;
    const data = await getUserTemplates(user.uid);
    setTemplates(data);
    setLoading(false);
  }

  const handleEdit = (t: JournalTemplate) => {
    setCurrentId(t.id);
    setName(t.name);
    setPrompts(t.prompts.length > 0 ? t.prompts : ['']);
    setTags(t.defaultTags.join(', '));
    setIsEditing(true);
  };

  const handleCreate = () => {
    setCurrentId('');
    setName('');
    setPrompts(['']);
    setTags('');
    setIsEditing(true);
  };

  const handleDelete = async (id: string) => {
    if (!user || !window.confirm("Are you sure you want to delete this template?")) return;
    await deleteUserTemplate(user.uid, id);
    await loadTemplates();
  };

  const handlePromptChange = (idx: number, val: string) => {
    const newPrompts = [...prompts];
    newPrompts[idx] = val;
    setPrompts(newPrompts);
  };

  const addPromptLine = () => {
    setPrompts([...prompts, '']);
  };

  const removePromptLine = (idx: number) => {
    const newPrompts = prompts.filter((_, i) => i !== idx);
    setPrompts(newPrompts);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    // Clean data
    const cleanPrompts = prompts.filter(p => p.trim() !== '');
    const cleanTags = tags.split(',').map(t => t.trim()).filter(t => t !== '').map(t => t.startsWith('#') ? t : `#${t}`);

    if (!name || cleanPrompts.length === 0) {
        alert("Please provide a name and at least one prompt.");
        return;
    }

    const templateData: JournalTemplate = {
        id: currentId, // empty string means new doc
        name,
        prompts: cleanPrompts,
        defaultTags: cleanTags
    };

    await saveUserTemplate(user.uid, templateData);
    setIsEditing(false);
    await loadTemplates();
  };

  if (loading) return <div className="p-8">Loading templates...</div>;

  // --- EDITOR VIEW ---
  if (isEditing) {
    return (
        <div className="max-w-2xl mx-auto space-y-6">
            <div className="flex items-center gap-4">
                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-900">
                    <ArrowLeftIcon className="h-5 w-5" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">{currentId ? 'Edit Template' : 'New Template'}</h1>
            </div>

            <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                    <input 
                        type="text" 
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Step 10 Inventory"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Prompts (Questions)</label>
                    <div className="space-y-3">
                        {prompts.map((p, idx) => (
                            <div key={idx} className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={p}
                                    onChange={(e) => handlePromptChange(idx, e.target.value)}
                                    className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder={`Question ${idx + 1}`}
                                />
                                <button 
                                    type="button" 
                                    onClick={() => removePromptLine(idx)}
                                    className="text-red-400 hover:text-red-600 p-2"
                                    title="Remove prompt"
                                >
                                    <XMarkIcon className="h-5 w-5" />
                                </button>
                            </div>
                        ))}
                    </div>
                    <button 
                        type="button"
                        onClick={addPromptLine}
                        className="mt-3 text-sm text-blue-600 font-medium hover:text-blue-700 flex items-center gap-1"
                    >
                        <PlusIcon className="h-4 w-4" />
                        Add Question
                    </button>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Default Tags</label>
                    <input 
                        type="text" 
                        value={tags}
                        onChange={(e) => setTags(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="#step10, #inventory (comma separated)"
                    />
                </div>

                <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button 
                        type="button" 
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                        Save Template
                    </button>
                </div>
            </form>
        </div>
    );
  }

  // --- LIST VIEW ---
  return (
    <div className="max-w-3xl mx-auto space-y-6">
       <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={() => navigate('/journal')} className="text-gray-500 hover:text-gray-900 lg:hidden">
               <ArrowLeftIcon className="h-5 w-5" />
            </button>
            <h1 className="text-2xl font-bold text-gray-900">Manage Templates</h1>
          </div>
          <button 
             onClick={handleCreate}
             className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
          >
             <PlusIcon className="h-5 w-5" />
             Create New
          </button>
       </div>

       <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          {templates.length === 0 ? (
             <div className="p-8 text-center text-gray-500">
                You haven't created any custom templates yet.
             </div>
          ) : (
             <ul className="divide-y divide-gray-100">
                {templates.map((t) => (
                   <li key={t.id} className="p-4 sm:p-6 flex items-center justify-between hover:bg-gray-50 transition">
                      <div>
                         <h3 className="font-semibold text-gray-900">{t.name}</h3>
                         <p className="text-sm text-gray-500 mt-1">{t.prompts.length} questions ‚Ä¢ {t.defaultTags.join(', ')}</p>
                      </div>
                      <div className="flex items-center gap-2">
                         <button 
                            onClick={() => handleEdit(t)}
                            className="p-2 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition"
                            title="Edit"
                         >
                            <PencilSquareIcon className="h-5 w-5" />
                         </button>
                         <button 
                            onClick={() => handleDelete(t.id)}
                            className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition"
                            title="Delete"
                         >
                            <TrashIcon className="h-5 w-5" />
                         </button>
                      </div>
                   </li>
                ))}
             </ul>
          )}
       </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Vitality.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../lib/firebase';
import { collection, addDoc, Timestamp } from 'firebase/firestore';
import { 
    HeartIcon, 
    FireIcon, 
    BeakerIcon, // For Nutrition/Water
    BoltIcon,   // For Energy
    //ClockIcon,
    CheckCircleIcon,
    PlayIcon,
    PauseIcon,
    ArrowPathIcon
} from '@heroicons/react/24/outline';

export default function Vitality() {
    const { user } = useAuth();
    const [saving, setSaving] = useState(false);
    
    // --- MOVEMENT STATE ---
    const [moveActivity, setMoveActivity] = useState('');
    const [moveDuration, setMoveDuration] = useState('');
    const [moveIntensity, setMoveIntensity] = useState('Moderate');
    const [moveNote, setMoveNote] = useState('');

    // --- NUTRITION STATE ---
    const [mealType, setMealType] = useState('Lunch');
    const [hungerType, setHungerType] = useState('Physical'); // vs Emotional
    const [waterCount, setWaterCount] = useState(0); // Just a daily counter visual
    const [nutriNote, setNutriNote] = useState('');

    // --- BREATHWORK STATE ---
    const [breathActive, setBreathActive] = useState(false);
    const [breathPhase, setBreathPhase] = useState('Idle'); // Inhale, Hold, Exhale
    const [breathTime, setBreathTime] = useState(0); // Seconds elapsed
    const [breathNote, setBreathNote] = useState('');

    // --- ACTIONS ---

    const saveVitalityEntry = async (category: string, title: string, contentDetails: string, note: string, tags: string[]) => {
        if (!user || !db) return;
        setSaving(true);

        const fullContent = `**${title}**\n${contentDetails}\n\n**Somatic Check-in:**\n${note || "No specific notes recorded."}`;

        try {
            await addDoc(collection(db, 'journals'), {
                uid: user.uid,
                content: fullContent,
                moodScore: 5, // Default neutral, or we could add a slider
                tags: ['Vitality', category, ...tags],
                sentiment: 'Pending',
                createdAt: Timestamp.now()
            });
            alert(`${category} Log Saved to Journal!`);
            // Reset specific fields handled by callers
        } catch (e) {
            console.error(e);
            alert("Failed to save entry.");
        } finally {
            setSaving(false);
        }
    };

    const handleLogMovement = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!moveActivity) return;
        
        const details = `*Activity:* ${moveActivity}\n*Duration:* ${moveDuration} mins\n*Intensity:* ${moveIntensity}`;
        await saveVitalityEntry('Movement', 'Movement Log üèÉ', details, moveNote, [moveActivity]);
        
        setMoveActivity('');
        setMoveDuration('');
        setMoveNote('');
    };

    const handleLogNutrition = async (e: React.FormEvent) => {
        e.preventDefault();
        
        const details = `*Meal:* ${mealType}\n*Hunger Type:* ${hungerType}`;
        await saveVitalityEntry('Nutrition', 'Fuel Log üçé', details, nutriNote, [mealType]);
        
        setNutriNote('');
    };

    // --- BREATHWORK TIMER LOGIC ---
    useEffect(() => {
        let interval: any;
        if (breathActive) {
            interval = setInterval(() => {
                setBreathTime(prev => {
                    const next = prev + 1;
                    // Simple 4-7-8 Cycle (19s total) for visual phase
                    const cycle = next % 19; 
                    if (cycle < 4) setBreathPhase('Inhale (4s)');
                    else if (cycle < 11) setBreathPhase('Hold (7s)');
                    else setBreathPhase('Exhale (8s)');
                    return next;
                });
            }, 1000);
        } else {
            setBreathPhase('Idle');
        }
        return () => clearInterval(interval);
    }, [breathActive]);

    const toggleBreath = () => setBreathActive(!breathActive);
    
    const handleLogBreath = async () => {
        const mins = Math.floor(breathTime / 60);
        const secs = breathTime % 60;
        const details = `*Session Duration:* ${mins}m ${secs}s\n*Technique:* 4-7-8 Relaxing Breath`;
        
        await saveVitalityEntry('Mindfulness', 'Breathwork Session üå¨Ô∏è', details, breathNote, ['Meditation']);
        
        setBreathTime(0);
        setBreathNote('');
        setBreathActive(false);
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6 pb-20">
            <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <HeartIcon className="h-8 w-8 text-rose-500" />
                Vitality & Somatic Health
            </h1>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* 1. MOVEMENT CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center gap-2 mb-4 text-orange-600 font-bold uppercase tracking-wide text-sm">
                        <FireIcon className="h-5 w-5" /> Movement
                    </div>
                    <form onSubmit={handleLogMovement} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Activity</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. Gym, Walk" 
                                    value={moveActivity}
                                    onChange={(e) => setMoveActivity(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Duration (min)</label>
                                <input 
                                    type="number" 
                                    placeholder="30" 
                                    value={moveDuration}
                                    onChange={(e) => setMoveDuration(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                    required
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Intensity</label>
                            <select 
                                value={moveIntensity}
                                onChange={(e) => setMoveIntensity(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            >
                                <option>Low (Restorative)</option>
                                <option>Moderate (Steady)</option>
                                <option>High (Intense)</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Somatic Check-In</label>
                            <textarea 
                                rows={2}
                                placeholder="How did this feel in your body? Did it shift your mood?"
                                value={moveNote}
                                onChange={(e) => setMoveNote(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            />
                        </div>

                        <button 
                            type="submit" 
                            disabled={saving}
                            className="w-full py-2 bg-orange-50 text-orange-600 hover:bg-orange-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2"
                        >
                            <CheckCircleIcon className="h-5 w-5" />
                            Log Movement
                        </button>
                    </form>
                </div>

                {/* 2. NUTRITION CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center gap-2 mb-4 text-green-600 font-bold uppercase tracking-wide text-sm">
                        <BeakerIcon className="h-5 w-5" /> Fuel & Hydration
                    </div>
                    
                    {/* Water Widget */}
                    <div className="flex items-center justify-between bg-blue-50 p-3 rounded-lg mb-4 border border-blue-100">
                        <span className="text-sm font-medium text-blue-800">Hydration</span>
                        <div className="flex items-center gap-2">
                             <button onClick={() => setWaterCount(Math.max(0, waterCount - 1))} className="p-1 hover:bg-blue-100 rounded">-</button>
                             <span className="text-xl font-bold text-blue-600">{waterCount}</span>
                             <button onClick={() => setWaterCount(waterCount + 1)} className="p-1 hover:bg-blue-100 rounded">+</button>
                             <span className="text-xs text-blue-400">glasses</span>
                        </div>
                    </div>

                    <form onSubmit={handleLogNutrition} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Meal</label>
                                <select 
                                    value={mealType}
                                    onChange={(e) => setMealType(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                >
                                    <option>Breakfast</option>
                                    <option>Lunch</option>
                                    <option>Dinner</option>
                                    <option>Snack</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Hunger Source</label>
                                <select 
                                    value={hungerType}
                                    onChange={(e) => setHungerType(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                >
                                    <option>Physical (Need Fuel)</option>
                                    <option>Emotional (Comfort)</option>
                                    <option>Boredom</option>
                                    <option>Clock (Habit)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">Mindful Eating Note</label>
                            <textarea 
                                rows={2}
                                placeholder="Did you eat mindfully? How satisfied are you?"
                                value={nutriNote}
                                onChange={(e) => setNutriNote(e.target.value)}
                                className="w-full text-sm rounded-lg border-gray-300"
                            />
                        </div>

                        <button 
                            type="submit" 
                            disabled={saving}
                            className="w-full py-2 bg-green-50 text-green-600 hover:bg-green-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2"
                        >
                            <CheckCircleIcon className="h-5 w-5" />
                            Log Fuel
                        </button>
                    </form>
                </div>

                {/* 3. BREATHWORK CARD */}
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 md:col-span-2">
                    <div className="flex items-center gap-2 mb-4 text-sky-600 font-bold uppercase tracking-wide text-sm">
                        <BoltIcon className="h-5 w-5" /> Breath & Regulation
                    </div>
                    
                    <div className="flex flex-col md:flex-row items-center gap-8">
                        {/* Visualizer */}
                        <div className="relative flex items-center justify-center w-40 h-40">
                             <div className={`absolute inset-0 bg-sky-100 rounded-full transition-all duration-[4000ms] ease-in-out ${breathPhase.includes('Inhale') ? 'scale-100 opacity-100' : breathPhase.includes('Hold') ? 'scale-100 opacity-80' : 'scale-50 opacity-50'}`}></div>
                             <div className="relative z-10 text-center">
                                 <div className="text-2xl font-bold text-sky-800">
                                     {Math.floor(breathTime / 60)}:{(breathTime % 60).toString().padStart(2, '0')}
                                 </div>
                                 <div className="text-xs font-medium text-sky-600 uppercase tracking-wider mt-1">{breathPhase}</div>
                             </div>
                        </div>

                        {/* Controls & Note */}
                        <div className="flex-1 w-full space-y-4">
                            <div className="flex gap-4">
                                <button 
                                    onClick={toggleBreath}
                                    className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-colors ${breathActive ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-sky-600 text-white hover:bg-sky-700'}`}
                                >
                                    {breathActive ? <><PauseIcon className="h-5 w-5" /> Pause</> : <><PlayIcon className="h-5 w-5" /> Start Breathing</>}
                                </button>
                                <button 
                                    onClick={() => { setBreathActive(false); setBreathTime(0); setBreathPhase('Idle'); }}
                                    className="px-4 rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50"
                                >
                                    <ArrowPathIcon className="h-5 w-5" />
                                </button>
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">Post-Session Reflection</label>
                                <textarea 
                                    rows={2}
                                    placeholder="What is the quality of your mind right now?"
                                    value={breathNote}
                                    onChange={(e) => setBreathNote(e.target.value)}
                                    className="w-full text-sm rounded-lg border-gray-300"
                                />
                            </div>

                            <button 
                                onClick={handleLogBreath}
                                disabled={breathTime < 5 || saving}
                                className="w-full py-2 bg-sky-50 text-sky-600 hover:bg-sky-100 font-semibold rounded-lg transition-colors flex justify-center items-center gap-2 disabled:opacity-50"
                            >
                                <CheckCircleIcon className="h-5 w-5" />
                                Log Session to Journal
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
}

// ---

================================================================================
FILE: src/pages/WorkbookDetail.tsx
================================================================================
import { useEffect, useState, Fragment } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { getWorkbook } from '../data/workbooks';
import { getSectionCompletion, getAllWorkbookAnswers } from '../lib/workbooks'; // Updated Import
import { analyzeFullWorkbook, type WorkbookInsight } from '../lib/gemini'; // Updated Import
import { useAuth } from '../contexts/AuthContext';
import { Dialog, Transition } from '@headlessui/react';
import { 
  ChevronRightIcon, 
  CheckCircleIcon, 
  ArrowLeftIcon,
  SparklesIcon
} from '@heroicons/react/24/outline';

export default function WorkbookDetail() {
  const { workbookId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const workbook = getWorkbook(workbookId || '');
  
  const [progressMap, setProgressMap] = useState<{[sectionId: string]: number}>({});
  
  // AI State
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [aiResult, setAiResult] = useState<WorkbookInsight | null>(null);
  const [showAiModal, setShowAiModal] = useState(false);

  useEffect(() => {
    async function loadProgress() {
      if (!user || !workbook) return;
      
      const newMap: {[key: string]: number} = {};
      
      for (const section of workbook.sections) {
        const pct = await getSectionCompletion(user.uid, workbook.id, section.id, section.questions.length);
        newMap[section.id] = pct;
      }
      
      setProgressMap(newMap);
    }

    loadProgress();
  }, [user, workbook]);

  // --- HANDLER: Holistic Analysis ---
  const handleAiAnalysis = async () => {
    if (!user || !workbook) return;

    setIsAnalyzing(true);
    setShowAiModal(true);
    setAiResult(null); // Reset previous result

    try {
      // 1. Fetch ALL answers from ALL sections
      const fullContent = await getAllWorkbookAnswers(
        user.uid, 
        workbook.id, 
        workbook.sections.map(s => ({ id: s.id, title: s.title }))
      );

      if (!fullContent) {
        setAiResult({
          feedback: "It looks like you haven't started this workbook yet. Complete a few questions first!",
          encouragement: "Every journey begins with a single step."
        });
        setIsAnalyzing(false);
        return;
      }

      // 2. Send to Gemini
      const result = await analyzeFullWorkbook(workbook.title, fullContent);
      setAiResult(result);
      
    } catch (error) {
      console.error("Analysis failed", error);
      setAiResult({
        feedback: "We couldn't generate an analysis at this moment. Please check your connection and try again.",
        encouragement: "Keep going."
      });
    } finally {
      setIsAnalyzing(false);
    }
  };

  if (!workbook) return <div>Workbook not found</div>;

  return (
    <div className="max-w-3xl mx-auto space-y-6">
      
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={() => navigate('/workbooks')} className="text-gray-500 hover:text-gray-900">
             <ArrowLeftIcon className="h-5 w-5" />
          </button>
          <h1 className="text-2xl font-bold text-gray-900">{workbook.title}</h1>
        </div>
        
        {/* SPARKLE BUTTON (Moved Here) */}
        <button 
          onClick={handleAiAnalysis}
          className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all active:scale-95"
        >
          <SparklesIcon className="h-5 w-5" />
          <span>Analyze Progress</span>
        </button>
      </div>

      <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
        <ul className="divide-y divide-gray-100">
          {workbook.sections.map((section) => {
            const progress = progressMap[section.id] || 0;
            const isComplete = progress === 100;

            return (
              <li key={section.id}>
                <Link 
                  to={`/workbooks/${workbook.id}/session/${section.id}`}
                  className="block hover:bg-gray-50 transition p-4 sm:p-6"
                >
                  <div className="flex items-center justify-between">
                    <div className="flex-1 pr-4">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-semibold text-gray-900">{section.title}</h3>
                        {isComplete && <CheckCircleIcon className="h-5 w-5 text-green-500" />}
                      </div>
                      <p className="text-sm text-gray-500">{section.description}</p>
                      
                      {/* Progress Bar */}
                      <div className="mt-2 w-full max-w-[200px] bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div 
                          className={`h-full ${isComplete ? 'bg-green-500' : 'bg-blue-500'}`} 
                          style={{ width: `${progress}%` }} 
                        />
                      </div>
                      <span className="text-xs text-gray-400 mt-1 block">{progress}% Complete</span>
                    </div>
                    
                    <ChevronRightIcon className="h-5 w-5 text-gray-400" />
                  </div>
                </Link>
              </li>
            );
          })}
        </ul>
      </div>

      {/* --- AI INSIGHT MODAL --- */}
      <Transition appear show={showAiModal} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowAiModal(false)}>
          <Transition.Child
            as={Fragment}
            enter="ease-out duration-300"
            enterFrom="opacity-0"
            enterTo="opacity-100"
            leave="ease-in duration-200"
            leaveFrom="opacity-100"
            leaveTo="opacity-0"
          >
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          </Transition.Child>

          <div className="fixed inset-0 overflow-y-auto">
            <div className="flex min-h-full items-center justify-center p-4 text-center">
              <Transition.Child
                as={Fragment}
                enter="ease-out duration-300"
                enterFrom="opacity-0 scale-95"
                enterTo="opacity-100 scale-100"
                leave="ease-in duration-200"
                leaveFrom="opacity-100 scale-100"
                leaveTo="opacity-0 scale-95"
              >
                <Dialog.Panel className="w-full max-w-lg transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                  
                  <div className="flex items-center gap-2 mb-4">
                    <SparklesIcon className="h-6 w-6 text-purple-500" />
                    <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900">
                      Holistic Workbook Analysis
                    </Dialog.Title>
                  </div>

                  {isAnalyzing ? (
                    <div className="py-12 text-center">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-500 mx-auto mb-4"></div>
                        <p className="text-gray-500 font-medium">Reviewing your entire journey...</p>
                        <p className="text-xs text-gray-400 mt-2">Connecting dots between sections</p>
                    </div>
                  ) : (
                    aiResult && (
                        <div className="space-y-6">
                            <div className="bg-purple-50 p-5 rounded-xl text-gray-800 leading-relaxed border border-purple-100 text-base">
                                {aiResult.feedback}
                            </div>
                            
                            <div className="text-center">
                                <span className="block text-xs uppercase tracking-widest text-gray-400 mb-1">Encouragement</span>
                                <span className="font-bold text-purple-700 text-lg">"{aiResult.encouragement}"</span>
                            </div>
                        </div>
                    )
                  )}

                  <div className="mt-8">
                    <button
                      type="button"
                      className="inline-flex justify-center rounded-lg border border-transparent bg-purple-100 px-4 py-3 text-sm font-semibold text-purple-900 hover:bg-purple-200 focus:outline-none w-full transition-colors"
                      onClick={() => setShowAiModal(false)}
                    >
                      Close Analysis
                    </button>
                  </div>
                </Dialog.Panel>
              </Transition.Child>
            </div>
          </div>
        </Dialog>
      </Transition>

    </div>
  );
}

================================================================================
FILE: src/pages/WorkbookSession.tsx
================================================================================
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { getWorkbook } from '../data/workbooks';
import { getSectionAnswers, saveAnswer, type WorkbookProgress } from '../lib/workbooks';
import { useAuth } from '../contexts/AuthContext';
import { 
  ArrowLeftIcon, 
  ArrowRightIcon, 
  DocumentArrowDownIcon,
  InformationCircleIcon,
  XMarkIcon
} from '@heroicons/react/24/outline';

export default function WorkbookSession() {
  const { workbookId, sectionId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  
  const workbook = getWorkbook(workbookId || '');
  const section = workbook?.sections.find(s => s.id === sectionId);
  
  // State
  const [answers, setAnswers] = useState<WorkbookProgress>({});
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // Print Mode State
  const [isPrintMode, setIsPrintMode] = useState(false);

  useEffect(() => {
    async function init() {
      if (!user || !workbook || !section) return;
      
      const saved = await getSectionAnswers(user.uid, workbook.id, section.id);
      setAnswers(saved);
      
      // Find first unanswered question to jump to
      const firstEmptyIndex = section.questions.findIndex(q => !saved[q.id]);
      if (firstEmptyIndex !== -1) setCurrentIndex(firstEmptyIndex);
      
      setLoading(false);
    }
    init();
  }, [user, workbook, section]);

  // Handlers
  const currentQuestion = section?.questions[currentIndex];
  const currentAnswer = currentQuestion ? (answers[currentQuestion.id] || '') : '';

  const handleTextChange = (val: string) => {
    if (!currentQuestion) return;
    setAnswers(prev => ({ ...prev, [currentQuestion.id]: val }));
  };

  const saveCurrent = async () => {
    if (!user || !workbook || !section || !currentQuestion) return;
    setSaving(true);
    await saveAnswer(user.uid, workbook.id, section.id, currentQuestion.id, currentAnswer);
    setSaving(false);
  };

  const handleNext = async () => {
    await saveCurrent();
    if (section && currentIndex < section.questions.length - 1) {
      setCurrentIndex(prev => prev + 1);
    } else {
      // Finished section
      navigate(`/workbooks/${workbookId}`);
    }
  };

  const handlePrev = async () => {
    await saveCurrent();
    if (currentIndex > 0) {
      setCurrentIndex(prev => prev - 1);
    }
  };

  const handlePrint = () => {
    setIsPrintMode(true);
    setTimeout(() => {
      window.print();
    }, 500);
  };

  if (!workbook || !section || loading) return <div className="p-8">Loading session...</div>;

  // --- PRINT MODE VIEW ---
  if (isPrintMode) {
    return (
      <div className="bg-white min-h-screen text-black p-8 max-w-4xl mx-auto print:p-0">
        <div className="flex justify-between items-center mb-8 print:hidden">
          <h2 className="text-xl font-bold text-gray-500">Preview Mode</h2>
          <div className="flex gap-2">
            <button 
                onClick={() => window.print()} 
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
                Print PDF
            </button>
            <button 
                onClick={() => setIsPrintMode(false)} 
                className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
            >
                Close
            </button>
          </div>
        </div>

        <div className="print:block">
            <h1 className="text-3xl font-bold mb-2">{workbook.title}</h1>
            <h2 className="text-xl text-gray-600 mb-8 border-b pb-4">{section.title}: {section.description}</h2>

            <div className="space-y-8">
                {section.questions.map((q, idx) => (
                    <div key={q.id} className="break-inside-avoid">
                        <p className="font-bold text-lg mb-2">
                            {idx + 1}. {q.text}
                        </p>
                        <div className="bg-gray-50 p-4 rounded border border-gray-100 text-gray-800 whitespace-pre-wrap">
                            {answers[q.id] || "No answer provided."}
                        </div>
                    </div>
                ))}
            </div>
            
            <div className="mt-12 pt-4 border-t text-sm text-gray-400 text-center">
                Generated by My Recovery Toolkit ‚Ä¢ {new Date().toLocaleDateString()}
            </div>
        </div>
      </div>
    );
  }

  // --- WIZARD MODE VIEW ---
  if (!currentQuestion) return <div>Error</div>;

  return (
    <div className="max-w-2xl mx-auto h-[calc(100vh-80px)] flex flex-col relative">
      
      {/* 1. Top Bar */}
      <div className="flex items-center justify-between mb-4">
         <div className="flex items-center gap-2">
            <button onClick={() => navigate(`/workbooks/${workbookId}`)} className="text-gray-400 hover:text-gray-900">
                <XMarkIcon className="h-6 w-6" />
            </button>
            <div className="text-xs font-bold uppercase tracking-widest text-gray-400">
                Question {currentIndex + 1} of {section.questions.length}
            </div>
         </div>
         
         <div className="flex items-center gap-3">
            {/* Export Only - Sparkle Button Removed */}
            <button onClick={handlePrint} className="text-blue-600 hover:text-blue-700 flex items-center gap-1 text-sm font-medium">
                <DocumentArrowDownIcon className="h-4 w-4" />
                <span className="hidden sm:inline">Export</span>
            </button>
         </div>
      </div>

      {/* 2. Progress Line */}
      <div className="w-full bg-gray-100 h-1 rounded-full mb-8">
        <div 
            className="bg-blue-600 h-1 rounded-full transition-all duration-300"
            style={{ width: `${((currentIndex + 1) / section.questions.length) * 100}%` }}
        />
      </div>

      {/* 3. The Question Area */}
      <div className="flex-1 overflow-y-auto pb-20">
         <div className="prose prose-lg max-w-none mb-6">
            <h2 className="text-2xl font-bold text-gray-900 leading-tight">
                {currentQuestion.text}
            </h2>
            {currentQuestion.context && (
                <div className="flex gap-3 bg-blue-50 p-4 rounded-lg mt-4 text-blue-800 text-sm">
                    <InformationCircleIcon className="h-5 w-5 flex-shrink-0" />
                    <p className="italic">"{currentQuestion.context}"</p>
                </div>
            )}
         </div>

         <textarea
            className="w-full min-h-[300px] p-4 text-lg border-0 bg-transparent focus:ring-0 placeholder-gray-300 resize-none"
            placeholder="Type your answer here..."
            value={currentAnswer}
            onChange={(e) => handleTextChange(e.target.value)}
            autoFocus
         />
      </div>

      {/* 4. Bottom Navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 lg:static lg:bg-transparent lg:border-0">
          <div className="max-w-2xl mx-auto flex items-center justify-between gap-4">
             <button 
                onClick={handlePrev}
                disabled={currentIndex === 0}
                className={`flex items-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors ${
                    currentIndex === 0 
                    ? 'text-gray-300 cursor-not-allowed' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
             >
                <ArrowLeftIcon className="h-5 w-5" />
                Prev
             </button>

             <div className="text-xs text-gray-400 italic">
                {saving ? 'Saving...' : 'Auto-saved'}
             </div>

             <button 
                onClick={handleNext}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-transform active:scale-95 flex items-center gap-2"
             >
                {currentIndex === section.questions.length - 1 ? 'Finish' : 'Next'}
                <ArrowRightIcon className="h-5 w-5" />
             </button>
          </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Workbooks.tsx
================================================================================
    import { Link } from 'react-router-dom';
import { WORKBOOKS } from '../data/workbooks';
import { BookOpenIcon, StarIcon, HeartIcon } from '@heroicons/react/24/outline';

export default function Workbooks() {
  
  const getIcon = (type: string) => {
    switch (type) {
      case 'general': return <StarIcon className="h-6 w-6 text-yellow-500" />;
      case 'steps': return <BookOpenIcon className="h-6 w-6 text-blue-500" />;
      default: return <HeartIcon className="h-6 w-6 text-purple-500" />;
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="border-b border-gray-200 pb-5">
        <h3 className="text-2xl font-bold leading-6 text-gray-900">Recovery Workbooks</h3>
        <p className="mt-2 max-w-4xl text-sm text-gray-500">
          Structured guides to help you process your journey. Select a workbook to begin.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {WORKBOOKS.map((workbook) => (
          <div key={workbook.id} className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col hover:shadow-md transition-shadow">
            <div className="flex items-center gap-4 mb-4">
              <div className="p-3 bg-gray-50 rounded-lg">
                {getIcon(workbook.type)}
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-900">{workbook.title}</h4>
                <span className="text-xs font-medium bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                  {workbook.sections.length} Sections
                </span>
              </div>
            </div>
            
            <p className="text-gray-600 text-sm flex-grow mb-6">
              {workbook.description}
            </p>

            <Link 
              to={`/workbooks/${workbook.id}`}
              className="w-full bg-blue-600 text-white text-center py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
            >
              Start Workbook
            </Link>
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: src/vite-env.d.ts
================================================================================
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_FIREBASE_API_KEY: string;
  readonly VITE_FIREBASE_AUTH_DOMAIN: string;
  readonly VITE_FIREBASE_PROJECT_ID: string;
  readonly VITE_FIREBASE_STORAGE_BUCKET: string;
  readonly VITE_FIREBASE_MESSAGING_SENDER_ID: string;
  readonly VITE_FIREBASE_APP_ID: string;
  readonly VITE_APP_VERSION: string; // NEW
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}

================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Unified Blue Theme (from Master Tech Doc)
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8', // Primary Brand Color
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}


================================================================================
FILE: tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}


================================================================================
FILE: tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

