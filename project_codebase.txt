PROJECT EXPORT - 2025-12-19T17:52:29.722Z


================================================================================
FILE: package.json
================================================================================
{
  "name": "mrt2",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@headlessui/react": "^2.2.9",
    "@heroicons/react": "^2.2.0",
    "date-fns": "^4.1.0",
    "firebase": "^12.6.0",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "recharts": "^3.6.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "clsx": "^2.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwind-merge": "^3.4.0",
    "tailwindcss": "3.4",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4",
    "vite-plugin-pwa": "^1.2.0"
  }
}


================================================================================
FILE: vite.config.ts
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

icons: [
          {
            // Note: The generator usually names them like this
            src: 'pwa-192x192.png', 
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable' // 'maskable' ensures it fills the circle on Android
          }
        ]

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


================================================================================
FILE: check_models.js
================================================================================
import fs from 'fs';
import path from 'path';

async function check() {
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    if (!fs.existsSync(envPath)) {
      console.error("‚ùå Error: Could not find .env file.");
      process.exit(1);
    }

    const envContent = fs.readFileSync(envPath, 'utf8');
    const match = envContent.match(/VITE_GEMINI_API_KEY=(.*)/);
    
    if (!match || !match[1]) {
      console.error("‚ùå Error: VITE_GEMINI_API_KEY not found in .env");
      process.exit(1);
    }

    // SANITIZATION: Remove spaces AND quotes (" or ') from the key
    const rawKey = match[1].trim();
    const apiKey = rawKey.replace(/^["']|["']$/g, ''); 

    console.log(`üîë Testing Key: ${apiKey.substring(0, 6)}... (Length: ${apiKey.length})`);

    // Query Google
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
    );

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API Error ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    const contentModels = data.models.filter(m => 
      m.supportedGenerationMethods.includes("generateContent")
    );

    console.log("\n‚úÖ SUCCESS! HERE ARE YOUR AVAILABLE MODELS:");
    console.table(contentModels.map(m => ({
      name: m.name.replace('models/', ''), // Use THIS string in your code
      version: m.version,
      displayName: m.displayName
    })));

  } catch (error) {
    console.error("‚ùå Failed:", error.message);
  }
}

check();

================================================================================
FILE: eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


================================================================================
FILE: firebase.json
================================================================================
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}

================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="en">
 <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>My Recovery Toolkit</title>
    <meta name="description" content="Your digital companion for recovery.">
    <meta name="theme-color" content="#2A9D8F">

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

================================================================================
FILE: postcss.config.js
================================================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
FILE: src/App.css
================================================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE: src/App.tsx
================================================================================
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import Journal from './pages/Journal';
import Tasks from './pages/Tasks';
import Profile from './pages/Profile';
import Workbooks from './pages/Workbooks'; 
import WorkbookDetail from './pages/WorkbookDetail'; 
import WorkbookSession from './pages/WorkbookSession'; 
import TemplateEditor from './pages/TemplateEditor'; // NEW IMPORT
import AppShell from './components/AppShell';

function PrivateRoute({ children }: { children: React.ReactNode }) {
  const { user, loading } = useAuth();
  
  if (loading) return <div>Loading...</div>;
  
  if (!user) {
    return <Navigate to="/login" />;
  }

  // Your existing logic: AppShell wraps the protected content here
  return <AppShell>{children}</AppShell>;
}

export default function App() {
  return (
    <AuthProvider>
      <Router>
        <Routes>
          <Route path="/login" element={<Login />} />
          
          <Route
            path="/dashboard"
            element={
              <PrivateRoute>
                <Dashboard />
              </PrivateRoute>
            }
          />
          <Route
            path="/journal"
            element={
              <PrivateRoute>
                <Journal />
              </PrivateRoute>
            }
          />
          <Route
            path="/tasks"
            element={
              <PrivateRoute>
                <Tasks />
              </PrivateRoute>
            }
          />
          
          {/* --- WORKBOOK ROUTES --- */}
          <Route
            path="/workbooks"
            element={
              <PrivateRoute>
                <Workbooks />
              </PrivateRoute>
            }
          />
          <Route
            path="/workbooks/:workbookId"
            element={
              <PrivateRoute>
                <WorkbookDetail />
              </PrivateRoute>
            }
          />
          <Route
            path="/workbooks/:workbookId/session/:sectionId"
            element={
              <PrivateRoute>
                <WorkbookSession />
              </PrivateRoute>
            }
          />
          
          {/* --- NEW: TEMPLATES ROUTE --- */}
          <Route
            path="/templates"
            element={
              <PrivateRoute>
                <TemplateEditor />
              </PrivateRoute>
            }
          />
          
          {/* ----------------------- */}
          <Route
            path="/profile"
            element={
              <PrivateRoute>
                <Profile />
              </PrivateRoute>
            }
          />
          <Route path="/" element={<Navigate to="/dashboard" />} />
        </Routes>
      </Router>
    </AuthProvider>
  );
}

================================================================================
FILE: src/components/AppShell.tsx
================================================================================
import { Fragment, useState } from 'react';
import { Dialog, Transition } from '@headlessui/react';
import { 
  Bars3Icon, 
  XMarkIcon, 
  HomeIcon, 
  BookOpenIcon, 
  UserCircleIcon,
  ArrowLeftOnRectangleIcon,
  ClipboardDocumentListIcon,
  AcademicCapIcon
} from '@heroicons/react/24/outline';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function AppShell({ children }: { children: React.ReactNode }) {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const location = useLocation();
  const navigate = useNavigate();
  const { user, logout } = useAuth();

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { name: 'Journal', href: '/journal', icon: BookOpenIcon },
    { name: 'Tasks', href: '/tasks', icon: ClipboardDocumentListIcon },
    { name: 'Workbooks', href: '/workbooks', icon: AcademicCapIcon },
    { name: 'Profile', href: '/profile', icon: UserCircleIcon },
  ];

  const handleLogout = async () => {
    try {
      setSidebarOpen(false); // Ensure menu closes on logout too
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <Transition.Root show={sidebarOpen} as={Fragment}>
        <Dialog as="div" className="relative z-50 lg:hidden" onClose={setSidebarOpen}>
          <div className="fixed inset-0 bg-gray-900/80" />
          <div className="fixed inset-0 flex">
            <Dialog.Panel className="relative mr-16 flex w-full max-w-xs flex-1 transform flex-col bg-blue-600 transition-all">
               <div className="flex h-16 shrink-0 items-center justify-between px-6">
                  <span className="text-white font-bold text-xl">My Recovery Toolkit</span>
                  <button onClick={() => setSidebarOpen(false)} className="-m-2.5 p-2.5 text-blue-200 hover:text-white">
                    <XMarkIcon className="h-6 w-6" aria-hidden="true" />
                  </button>
               </div>
               <nav className="flex flex-1 flex-col px-6 pb-4">
                 <ul role="list" className="flex flex-1 flex-col gap-y-7">
                   <li>
                     <ul role="list" className="-mx-2 space-y-1">
                       {navigation.map((item) => (
                         <li key={item.name}>
                           <Link
                             to={item.href}
                             onClick={() => setSidebarOpen(false)} // <--- CLOSE SIDEBAR ON CLICK
                             className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                               location.pathname === item.href
                                 ? 'bg-blue-700 text-white'
                                 : 'text-blue-200 hover:text-white hover:bg-blue-700'
                             }`}
                           >
                             <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                             {item.name}
                           </Link>
                         </li>
                       ))}
                     </ul>
                   </li>
                   
                   <li className="mt-auto">
                     <div className="flex flex-col gap-2">
                        {user && (
                            <div className="flex items-center gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-white bg-blue-700/50">
                                {user.photoURL ? (
                                    <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                                ) : (
                                    <UserCircleIcon className="h-8 w-8 text-blue-200" />
                                )}
                                <span className="sr-only">Your profile</span>
                                <span aria-hidden="true">{user.displayName || user.email}</span>
                            </div>
                        )}
                        <button
                          onClick={handleLogout}
                          className="group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                        >
                          <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                          Log out
                        </button>
                     </div>
                   </li>
                 </ul>
               </nav>
            </Dialog.Panel>
          </div>
        </Dialog>
      </Transition.Root>

      {/* Desktop sidebar */}
      <div className="hidden lg:fixed lg:inset-y-0 lg:z-50 lg:flex lg:w-72 lg:flex-col">
        <div className="flex grow flex-col gap-y-5 overflow-y-auto bg-blue-600 px-6 pb-4">
          <div className="flex h-16 shrink-0 items-center">
            <span className="text-white font-bold text-xl">My Recovery Toolkit</span>
          </div>
          <nav className="flex flex-1 flex-col">
            <ul role="list" className="flex flex-1 flex-col gap-y-7">
              <li>
                <ul role="list" className="-mx-2 space-y-1">
                  {navigation.map((item) => (
                    <li key={item.name}>
                      <Link
                        to={item.href}
                        className={`group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 ${
                          location.pathname === item.href
                            ? 'bg-blue-700 text-white'
                            : 'text-blue-200 hover:text-white hover:bg-blue-700'
                        }`}
                      >
                        <item.icon className="h-6 w-6 shrink-0" aria-hidden="true" />
                        {item.name}
                      </Link>
                    </li>
                  ))}
                </ul>
              </li>

              <li className="mt-auto">
                 <div className="flex flex-col gap-2 border-t border-blue-500 pt-4">
                    {user && (
                        <div className="flex items-center gap-x-3 rounded-md px-2 py-2 text-sm font-semibold leading-6 text-white">
                            {user.photoURL ? (
                                <img src={user.photoURL} alt="" className="h-8 w-8 rounded-full bg-blue-700" />
                            ) : (
                                <UserCircleIcon className="h-8 w-8 text-blue-200" />
                            )}
                            <span className="sr-only">Your profile</span>
                            <span className="truncate" aria-hidden="true">{user.displayName || user.email}</span>
                        </div>
                    )}
                    <button
                      onClick={handleLogout}
                      className="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-blue-200 hover:bg-blue-700 hover:text-white w-full"
                    >
                      <ArrowLeftOnRectangleIcon className="h-6 w-6 shrink-0" aria-hidden="true" />
                      Log out
                    </button>
                 </div>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <div className="lg:pl-72">
        {/* MOBILE TOP BAR */}
        <div className="sticky top-0 z-40 flex h-16 shrink-0 items-center gap-x-4 border-b border-blue-700 bg-blue-600 px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8 lg:hidden">
          <button type="button" className="-m-2.5 p-2.5 text-blue-200 hover:text-white lg:hidden" onClick={() => setSidebarOpen(true)}>
            <span className="sr-only">Open sidebar</span>
            <Bars3Icon className="h-6 w-6" aria-hidden="true" />
          </button>
          <div className="flex-1 text-sm font-bold leading-6 text-white">My Recovery Toolkit</div>
        </div>

        <main className="py-10">
          <div className="px-4 sm:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/RecoveryHero.tsx
================================================================================
import { 
  TrophyIcon, 
  FireIcon, 
  PencilSquareIcon, 
  ScaleIcon,
  CalendarDaysIcon,
  FaceSmileIcon
} from '@heroicons/react/24/outline';
import { differenceInYears, differenceInMonths, differenceInDays, addYears, addMonths } from 'date-fns';
import type { GamificationStats } from '../lib/gamification';

interface RecoveryHeroProps {
  sobrietyDate: Date | null;
  journalStats: GamificationStats | null;
  taskStreak: number;
}

export default function RecoveryHero({ sobrietyDate, journalStats, taskStreak }: RecoveryHeroProps) {
  
  // --- SOBRIETY CALCULATION LOGIC ---
  const calculateDuration = () => {
    if (!sobrietyDate) return { years: 0, months: 0, days: 0, totalDays: 0 };
    
    const now = new Date();
    
    // 1. Calculate Breakdown (Y/M/D)
    const years = differenceInYears(now, sobrietyDate);
    const dateAfterYears = addYears(sobrietyDate, years);
    
    const months = differenceInMonths(now, dateAfterYears);
    const dateAfterMonths = addMonths(dateAfterYears, months);
    
    const days = differenceInDays(now, dateAfterMonths);

    // 2. Calculate Total Days
    const totalDays = differenceInDays(now, sobrietyDate);
    
    return { years, months, days, totalDays };
  };

  const duration = calculateDuration();

  return (
    <div className="bg-gradient-to-r from-teal-500 to-blue-600 rounded-2xl shadow-lg p-4 text-white overflow-hidden relative">
      {/* Background decoration */}
      <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
      <div className="absolute bottom-0 left-0 -mb-4 -ml-4 w-32 h-32 bg-white opacity-10 rounded-full blur-xl"></div>

      {/* LAYOUT: Flex Row (Side-by-Side) */}
      <div className="relative z-10 flex flex-row items-stretch gap-3 sm:gap-6 h-full">
        
        {/* --- SECTION 1: TIME (Left Side - Centered & Larger) --- */}
        <div className="flex-1 flex flex-col justify-center items-center text-center min-w-0">
          <div className="flex items-center gap-2 mb-2 opacity-80">
            <TrophyIcon className="h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0" />
            <span className="text-xs sm:text-sm font-bold uppercase tracking-wider truncate">Recovery Time</span>
          </div>
          
          {sobrietyDate ? (
            <div className="flex flex-col justify-center items-center h-full">
               {/* Big Total Number - Flexbox added for vertical centering */}
               <div className="flex items-center justify-center text-6xl sm:text-7xl md:text-8xl font-extrabold tracking-tight leading-none mb-3">
                 <span>{duration.totalDays}</span>
                 <span className="text-xl sm:text-3xl font-medium ml-3 sm:ml-4 opacity-80">Days</span>
               </div>
               
               {/* Breakdown Subtext */}
               <div className="flex flex-wrap items-center justify-center gap-1 text-lg sm:text-2xl font-medium text-blue-50 opacity-90">
                  <div className="inline-flex items-center gap-2 bg-black/10 px-4 py-2 rounded-lg truncate max-w-full">
                     <CalendarDaysIcon className="h-5 w-5 sm:h-6 sm:w-6 flex-shrink-0" />
                     <span className="truncate">
                        {duration.years}y, {duration.months}m, {duration.days}d
                     </span>
                  </div>
               </div>
            </div>
          ) : (
            <div className="bg-white/10 rounded-lg p-3 text-blue-100 text-sm">
              Set sobriety date in Profile.
            </div>
          )}
        </div>

        {/* --- VERTICAL DIVIDER --- */}
        <div className="w-px bg-gradient-to-b from-transparent via-white/30 to-transparent flex-shrink-0"></div>

        {/* --- SECTION 2: STATS GRID (Right Side - 2x2) --- */}
        <div className="flex-shrink-0 w-[45%] sm:w-auto flex flex-col justify-center">
           
           <div className="grid grid-cols-2 gap-2 sm:gap-3">
                
                {/* 1. Journal Streak */}
                <div className="bg-white/10 rounded-lg p-2 sm:p-3 backdrop-blur-sm flex flex-col sm:flex-row items-center sm:gap-3 border border-white/5 text-center sm:text-left">
                    <div className="hidden sm:block p-1.5 bg-purple-500/30 rounded-md text-white">
                        <PencilSquareIcon className="h-4 w-4" />
                    </div>
                    {/* Mobile Icon */}
                    <PencilSquareIcon className="h-4 w-4 sm:hidden mb-1 text-purple-200" />
                    
                    <div>
                        <span className="block text-lg sm:text-xl font-bold leading-none">{journalStats?.journalStreak || 0}</span>
                        <span className="text-[9px] sm:text-[10px] uppercase tracking-wide text-blue-200 block mt-0.5">Journal</span>
                    </div>
                </div>

                {/* 2. Consistency */}
                <div className="bg-white/10 rounded-lg p-2 sm:p-3 backdrop-blur-sm flex flex-col sm:flex-row items-center sm:gap-3 border border-white/5 text-center sm:text-left">
                    <div className="hidden sm:block p-1.5 bg-green-500/30 rounded-md text-white">
                        <ScaleIcon className="h-4 w-4" />
                    </div>
                    <ScaleIcon className="h-4 w-4 sm:hidden mb-1 text-green-200" />
                    
                    <div>
                        <span className="block text-lg sm:text-xl font-bold leading-none">{journalStats?.consistencyRate || 0}</span>
                        <span className="text-[9px] sm:text-[10px] uppercase tracking-wide text-blue-200 block mt-0.5">Avg/Wk</span>
                    </div>
                </div>

                {/* 3. Habit Fire */}
                <div className="bg-white/10 rounded-lg p-2 sm:p-3 backdrop-blur-sm flex flex-col sm:flex-row items-center sm:gap-3 border border-white/5 text-center sm:text-left">
                    <div className="hidden sm:block p-1.5 bg-orange-500/30 rounded-md text-white">
                        <FireIcon className="h-4 w-4" />
                    </div>
                    <FireIcon className="h-4 w-4 sm:hidden mb-1 text-orange-200" />
                    
                    <div>
                        <span className="block text-lg sm:text-xl font-bold leading-none">{taskStreak}</span>
                        <span className="text-[9px] sm:text-[10px] uppercase tracking-wide text-blue-200 block mt-0.5">Streak</span>
                    </div>
                </div>

                {/* 4. Average Mood (Pink) */}
                <div className="bg-white/10 rounded-lg p-2 sm:p-3 backdrop-blur-sm flex flex-col sm:flex-row items-center sm:gap-3 border border-white/5 text-center sm:text-left">
                    <div className="hidden sm:block p-1.5 bg-pink-500/30 rounded-md text-white">
                        <FaceSmileIcon className="h-4 w-4" />
                    </div>
                    <FaceSmileIcon className="h-4 w-4 sm:hidden mb-1 text-pink-200" />
                    
                    <div>
                        <span className="block text-lg sm:text-xl font-bold leading-none">{journalStats?.averageMood || 0}</span>
                        <span className="text-[9px] sm:text-[10px] uppercase tracking-wide text-blue-200 block mt-0.5">Avg Mood</span>
                    </div>
                </div>

            </div>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/components/SobrietyCounter.tsx
================================================================================
import { useMemo } from 'react';
import { TrophyIcon } from '@heroicons/react/24/solid';

interface SobrietyCounterProps {
  sobrietyDate: Date;
}

// ensure 'export default' is present here
export default function SobrietyCounter({ sobrietyDate }: SobrietyCounterProps) {
  const time = useMemo(() => {
    const now = new Date();
    const start = new Date(sobrietyDate);
    
    // Calculate the difference
    const diffTime = Math.abs(now.getTime() - start.getTime());
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = (totalDays % 365) % 30;

    return { years, months, days, totalDays };
  }, [sobrietyDate]);

  return (
    <div className="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-xl p-6 text-white relative overflow-hidden">
      {/* Background Decoration */}
      <TrophyIcon className="absolute -right-4 -bottom-4 h-48 w-48 text-blue-500 opacity-20 transform rotate-12" />

      <div className="relative z-10">
        <h2 className="text-blue-100 text-sm font-semibold uppercase tracking-wider mb-4">
          Clean & Sober Time
        </h2>
        
        <div className="flex items-end space-x-6">
          {/* Years */}
          {time.years > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.years}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Years</span>
            </div>
          )}

          {/* Months */}
          {time.months > 0 && (
            <div className="text-center">
              <span className="block text-4xl sm:text-5xl font-bold">{time.months}</span>
              <span className="text-xs sm:text-sm text-blue-200 uppercase">Months</span>
            </div>
          )}

          {/* Days */}
          <div className="text-center">
            <span className="block text-4xl sm:text-5xl font-bold">{time.days}</span>
            <span className="text-xs sm:text-sm text-blue-200 uppercase">Days</span>
          </div>
        </div>

        <div className="mt-6 pt-4 border-t border-blue-500/50 flex justify-between items-center text-sm text-blue-200">
          <span>Total Days: {time.totalDays}</span>
          <span>Started: {sobrietyDate.toLocaleDateString()}</span>
        </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalEditor.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, addDoc, Timestamp, doc, updateDoc } from 'firebase/firestore';
import { 
    PlusIcon, 
    Cog6ToothIcon
} from '@heroicons/react/24/outline';
import { getUserTemplates, type JournalTemplate } from '../../lib/db';
import { useNavigate } from 'react-router-dom';

// --- Types (Local definition to avoid circular deps) ---
export interface JournalEntry {
  id: string;
  content: string;
  moodScore: number;
  sentiment?: string;
  createdAt: any;
  tags?: string[];
  weather?: { temp: number; condition: string } | null;
}

interface JournalEditorProps {
  initialEntry: JournalEntry | null;
  onSaveComplete: () => void;
}

const DEFAULT_TEMPLATES = [
  { id: 'morning_checkin', name: 'Morning Check-in', text: "Morning Check-in ‚òÄÔ∏è\n\nHow am I feeling today?\n\n\nWhat is my main focus for today?\n\n\nOne thing I am grateful for:\n", tags: ['#morning'] },
  { id: 'nightly_review', name: 'Nightly Review', text: "Nightly Review üåô\n\nWhat went well today?\n\n\nWhat challenged me?\n\n\nDid I stay sober today?\n", tags: ['#nightly'] },
  { id: 'urge_log', name: 'Urge Log (SOS)', text: "Urge Log üö®\n\nTrigger:\n\n\nIntensity (1-10):\n\n\nCoping Strategy Used:\n", tags: ['#urge', '#sos'] },
  { id: 'meeting_reflection', name: 'Meeting Reflection', text: "Meeting Reflection ü™ë\n\nMeeting Topic:\n\n\nOne thing I heard that resonated:\n\n\nHow can I apply this?\n", tags: ['#meeting'] },
];

export default function JournalEditor({ initialEntry, onSaveComplete }: JournalEditorProps) {
  const { user } = useAuth();
  const navigate = useNavigate();

  // State
  const [newEntry, setNewEntry] = useState('');
  const [mood, setMood] = useState(5);
  const [weather, setWeather] = useState<{ temp: number; condition: string } | null>(null);
  const [saving, setSaving] = useState(false);
  
  // Template State
  const [customTemplates, setCustomTemplates] = useState<JournalTemplate[]>([]);
  const [activeTemplate, setActiveTemplate] = useState<JournalTemplate | null>(null);
  const [formAnswers, setFormAnswers] = useState<string[]>([]);

  // Load Initial Data (Editing Mode)
  useEffect(() => {
    if (initialEntry) {
      setNewEntry(initialEntry.content);
      setMood(initialEntry.moodScore);
      setActiveTemplate(null); // Edit mode defaults to text
    } else {
      // Reset if switching from edit back to new
      setNewEntry('');
      setMood(5);
      setActiveTemplate(null);
      setFormAnswers([]);
    }
  }, [initialEntry]);

  // Load Resources
  useEffect(() => {
    if (!user) return;
    loadCustomTemplates();
    fetchWeather();
  }, [user]);

  const loadCustomTemplates = async () => {
    if (!user) return;
    const t = await getUserTemplates(user.uid);
    setCustomTemplates(t);
  };

  const fetchWeather = async () => {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code`);
          const data = await res.json();
          
          const code = data.current.weather_code;
          let condition = "Clear";
          if (code > 0 && code < 50) condition = "Cloudy";
          if (code >= 50 && code < 70) condition = "Rainy";
          if (code >= 70) condition = "Snowy";

          setWeather({
             temp: Math.round(data.current.temperature_2m),
             condition
          });
        } catch (e) {
          console.warn("Weather fetch failed", e);
        }
      });
    }
  };

  const handleTemplateSelect = (tId: string) => {
    const defTemplate = DEFAULT_TEMPLATES.find(t => t.id === tId);
    if (defTemplate) {
        setNewEntry(defTemplate.text);
        setActiveTemplate(null);
        return;
    }

    const custTemplate = customTemplates.find(t => t.id === tId);
    if (custTemplate) {
        setActiveTemplate(custTemplate);
        setFormAnswers(new Array(custTemplate.prompts.length).fill(''));
        setNewEntry('');
    } else {
        setActiveTemplate(null);
        setNewEntry('');
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !db) return;

    const isFormValid = activeTemplate && formAnswers.some(a => a.trim() !== '');
    const isTextValid = !activeTemplate && newEntry.trim() !== '';

    if (!isFormValid && !isTextValid) return;

    setSaving(true);

    let finalContent = newEntry;
    let finalTags: string[] = [];

    if (activeTemplate) {
        finalContent = `**${activeTemplate.name}**\n\n`;
        activeTemplate.prompts.forEach((prompt, idx) => {
            finalContent += `**${prompt}**\n${formAnswers[idx] || '-(Skipped)-'}\n\n`;
        });
        finalTags = [...activeTemplate.defaultTags];
    } else {
        const textTags = newEntry.match(/#[a-z0-9]+/gi) || [];
        finalTags = textTags as string[];
        
        const matchedDef = DEFAULT_TEMPLATES.find(t => newEntry.startsWith(t.text.split('\n')[0]));
        if (matchedDef) {
            finalTags = [...new Set([...finalTags, ...matchedDef.tags])];
        }
    }

    try {
      if (initialEntry) {
        // UPDATE existing
        await updateDoc(doc(db, 'journals', initialEntry.id), { 
            content: finalContent, 
            moodScore: mood,
            tags: finalTags
        });
      } else {
        // CREATE new
        await addDoc(collection(db, 'journals'), {
          uid: user.uid,
          content: finalContent,
          moodScore: mood,
          sentiment: 'Pending', 
          weather,
          tags: finalTags,
          createdAt: Timestamp.now()
        });
      }

      // Reset form
      setNewEntry('');
      setFormAnswers([]);
      setActiveTemplate(null);
      setMood(5);
      
      // Notify parent
      onSaveComplete();
    } catch (error) {
      console.error("Error saving entry:", error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        {/* Compact Header: Just Controls */}
        <div className="p-3 bg-gray-50 border-b border-gray-100 flex justify-end items-center gap-3">
             <div className="relative">
                <select 
                    onChange={(e) => handleTemplateSelect(e.target.value)}
                    className="pl-3 pr-8 py-1.5 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white"
                    defaultValue=""
                    disabled={!!initialEntry} 
                >
                    <option value="" disabled>Choose a Template...</option>
                    <option value="none">Free Write (Blank)</option>
                    <optgroup label="Standard">
                        {DEFAULT_TEMPLATES.map(t => (
                            <option key={t.id} value={t.id}>{t.name}</option>
                        ))}
                    </optgroup>
                    {customTemplates.length > 0 && (
                        <optgroup label="My Templates">
                            {customTemplates.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </optgroup>
                    )}
                </select>
             </div>

             <button 
                onClick={() => navigate('/templates')}
                className="p-1.5 text-gray-400 hover:text-blue-600 rounded-md hover:bg-blue-50 transition"
                title="Manage Templates"
             >
                <Cog6ToothIcon className="h-5 w-5" />
             </button>
        </div>
        
        <form onSubmit={handleSave} className="p-4 space-y-4">
          
          {activeTemplate ? (
             <div className="space-y-4 bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-blue-900">{activeTemplate.name}</h3>
                    <button 
                        type="button" 
                        onClick={() => setActiveTemplate(null)}
                        className="text-xs text-blue-500 hover:text-blue-700 underline"
                    >
                        Switch to Text Mode
                    </button>
                </div>
                
                {activeTemplate.prompts.map((prompt, idx) => (
                    <div key={idx}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{prompt}</label>
                        <textarea
                            rows={4} 
                            value={formAnswers[idx] || ''}
                            onChange={(e) => {
                                const newAns = [...formAnswers];
                                newAns[idx] = e.target.value;
                                setFormAnswers(newAns);
                            }}
                            className="w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                            placeholder="Type your answer..."
                        />
                    </div>
                ))}
             </div>
          ) : (
            <textarea
                value={newEntry}
                onChange={(e) => setNewEntry(e.target.value)}
                placeholder="How are you feeling today? (Type # to add tags)"
                // UPDATED: Reduced to 45vh to prevent scroll
                className="w-full h-[45vh] p-4 rounded-xl border-gray-300 focus:ring-blue-500 focus:border-blue-500 shadow-sm resize-none text-gray-700 leading-relaxed"
            />
          )}

          <div className="flex flex-wrap items-center justify-between gap-4">
            
            <div className="flex items-center gap-3 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
               <span className="text-sm font-medium text-gray-500">Mood:</span>
               <input 
                 type="range" 
                 min="1" 
                 max="10" 
                 value={mood}
                 onChange={(e) => setMood(Number(e.target.value))}
                 className="w-24 accent-blue-600 cursor-pointer"
               />
               <span className={`text-sm font-bold w-6 text-center ${mood >= 7 ? 'text-green-600' : mood <= 4 ? 'text-red-500' : 'text-yellow-600'}`}>
                 {mood}
               </span>
            </div>

            {weather && !initialEntry && (
               <div className="hidden sm:flex items-center gap-2 text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100">
                  <span>{weather.condition}</span>
                  <span>‚Ä¢</span>
                  <span>{weather.temp}¬∞C</span>
               </div>
            )}

            <button
              type="submit"
              disabled={saving}
              className="ml-auto flex items-center gap-2 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition-all active:scale-95 disabled:opacity-50"
            >
              {saving ? (
                <span>Saving...</span>
              ) : (
                <>
                  <PlusIcon className="h-5 w-5" />
                  <span>{initialEntry ? 'Update Entry' : 'Save Entry'}</span>
                </>
              )}
            </button>
          </div>
        </form>
      </div>
  );
}

================================================================================
FILE: src/components/journal/JournalHistory.tsx
================================================================================
import { useState, useEffect, Fragment } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs, deleteDoc, doc } from 'firebase/firestore';
import { 
    TrashIcon,
    PencilSquareIcon,
    ArrowPathIcon,
    SparklesIcon,
    FunnelIcon,
    MagnifyingGlassIcon,
    XMarkIcon
} from '@heroicons/react/24/outline';
import { Dialog, Transition } from '@headlessui/react';
import { analyzeJournalEntries, type AnalysisResult } from '../../lib/gemini';
import type { JournalEntry } from './JournalEditor'; // Shared interface

interface JournalHistoryProps {
  onEdit: (entry: JournalEntry) => void;
}

export default function JournalHistory({ onEdit }: JournalHistoryProps) {
  const { user } = useAuth();

  // Data State
  const [entries, setEntries] = useState<JournalEntry[]>([]);
  const [filteredEntries, setFilteredEntries] = useState<JournalEntry[]>([]);
  const [loading, setLoading] = useState(true);

  // Filters State
  const [searchQuery, setSearchQuery] = useState('');
  const [filterTag, setFilterTag] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
  const [availableTags, setAvailableTags] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);

  // AI State
  const [analyzing, setAnalyzing] = useState(false);
  const [insight, setInsight] = useState<AnalysisResult | null>(null);
  const [showInsightModal, setShowInsightModal] = useState(false);

  useEffect(() => {
    if (!user) return;
    loadEntries();
  }, [user]);

  // Load ALL entries initially (or limit to last 100 for performance)
  const loadEntries = async () => {
    if (!user || !db) return;
    try {
      const q = query(
        collection(db, 'journals'), 
        where('uid', '==', user.uid),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as JournalEntry));
      setEntries(data);
      setFilteredEntries(data); // Init filtered list
      
      // Extract unique tags
      const tags = new Set<string>();
      data.forEach(e => e.tags?.forEach(t => tags.add(t)));
      setAvailableTags(Array.from(tags));

    } catch (error) {
      console.error("Error loading entries:", error);
    } finally {
      setLoading(false);
    }
  };

  // Client-Side Filtering
  useEffect(() => {
    let result = entries;

    // 1. Keyword Search
    if (searchQuery) {
        const lowerQ = searchQuery.toLowerCase();
        result = result.filter(e => e.content.toLowerCase().includes(lowerQ));
    }

    // 2. Tag Filter
    if (filterTag) {
        result = result.filter(e => e.tags?.includes(filterTag));
    }

    // 3. Date Range
    if (dateFrom) {
        const from = new Date(dateFrom);
        result = result.filter(e => e.createdAt?.toDate() >= from);
    }
    if (dateTo) {
        // Set 'To' date to end of day
        const to = new Date(dateTo);
        to.setHours(23, 59, 59, 999);
        result = result.filter(e => e.createdAt?.toDate() <= to);
    }

    setFilteredEntries(result);
  }, [entries, searchQuery, filterTag, dateFrom, dateTo]);

  const handleDelete = async (id: string) => {
    if (!db) return;
    if (!confirm('Are you sure you want to delete this entry?')) return;
    try {
      await deleteDoc(doc(db, 'journals', id));
      await loadEntries(); // Reload to refresh list
    } catch (error) {
      console.error(error);
    }
  };

  const handleAiAnalysis = async () => {
    if (filteredEntries.length === 0) return;
    setAnalyzing(true);
    setShowInsightModal(true);
    
    // Analyze filtered results (up to 10 to avoid token limits)
    const textsToAnalyze = filteredEntries.slice(0, 10).map(e => e.content);
    
    const result = await analyzeJournalEntries(textsToAnalyze);
    setInsight(result);
    setAnalyzing(false);
  };

  const clearFilters = () => {
      setSearchQuery('');
      setFilterTag('');
      setDateFrom('');
      setDateTo('');
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Loading history...</div>;

  return (
    <div className="space-y-6">
      
      {/* --- HEADER & FILTERS --- */}
      <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-4">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
             <div className="relative flex-1 w-full sm:w-auto">
                <MagnifyingGlassIcon className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                <input 
                    type="text"
                    placeholder="Search keywords..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-9 pr-3 py-2 text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
             </div>
             
             <div className="flex items-center gap-2 w-full sm:w-auto">
                 <button 
                    onClick={() => setShowFilters(!showFilters)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${showFilters ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'}`}
                 >
                    <FunnelIcon className="h-4 w-4" />
                    Filters
                 </button>
                 
                 <button 
                    onClick={handleAiAnalysis}
                    disabled={analyzing || filteredEntries.length === 0}
                    className="flex-1 sm:flex-none flex items-center justify-center gap-2 text-purple-600 bg-purple-50 px-4 py-2 rounded-lg hover:bg-purple-100 transition-colors disabled:opacity-50"
                 >
                    {analyzing ? <ArrowPathIcon className="h-5 w-5 animate-spin" /> : <SparklesIcon className="h-5 w-5" />}
                    <span className="font-medium text-sm">Analyze Selection</span>
                 </button>
             </div>
          </div>

          {showFilters && (
              <div className="pt-4 border-t border-gray-100 grid grid-cols-1 sm:grid-cols-3 gap-4 animate-fadeIn">
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">Filter by Tag</label>
                      <select 
                        value={filterTag} 
                        onChange={(e) => setFilterTag(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      >
                          <option value="">All Tags</option>
                          {availableTags.map(t => <option key={t} value={t}>{t}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">From Date</label>
                      <input 
                        type="date" 
                        value={dateFrom} 
                        onChange={(e) => setDateFrom(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      />
                  </div>
                  <div>
                      <label className="block text-xs font-medium text-gray-500 mb-1">To Date</label>
                      <input 
                        type="date" 
                        value={dateTo} 
                        onChange={(e) => setDateTo(e.target.value)}
                        className="w-full text-sm border-gray-300 rounded-md"
                      />
                  </div>
                  <div className="sm:col-span-3 flex justify-end">
                      <button onClick={clearFilters} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
                          <XMarkIcon className="h-3 w-3" /> Clear Filters
                      </button>
                  </div>
              </div>
          )}
      </div>

      {/* --- RESULTS INFO --- */}
      <div className="flex justify-between items-center px-2">
          <p className="text-sm text-gray-500">
             Showing {filteredEntries.length} entries 
             {(searchQuery || filterTag || dateFrom) && <span className="text-gray-400"> (Filtered)</span>}
          </p>
      </div>

      {/* --- ENTRIES LIST --- */}
      {filteredEntries.length === 0 ? (
          <div className="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-300">
            <p className="text-gray-500">No entries match your filters.</p>
          </div>
      ) : (
          filteredEntries.map(entry => (
            <div key={entry.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:border-blue-200 transition-colors group">
              <div className="flex justify-between items-start mb-3">
                <div className="flex items-center gap-2">
                   <span className="text-sm font-medium text-gray-400">
                     {entry.createdAt?.toDate ? entry.createdAt.toDate().toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Just now'}
                   </span>
                   {entry.weather && (
                      <span className="text-xs text-gray-300 hidden sm:inline">‚Ä¢ {entry.weather.temp}¬∞C</span>
                   )}
                </div>
                
                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                   <button onClick={() => onEdit(entry)} className="p-1 text-gray-400 hover:text-blue-600" title="Edit">
                      <PencilSquareIcon className="h-4 w-4" />
                   </button>
                   <button onClick={() => handleDelete(entry.id)} className="p-1 text-gray-400 hover:text-red-500" title="Delete">
                      <TrashIcon className="h-4 w-4" />
                   </button>
                </div>
              </div>

              {/* Tag Badges */}
              {entry.tags && entry.tags.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-3">
                      {entry.tags.map((tag, i) => (
                          <span key={i} className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-medium">
                              {tag}
                          </span>
                      ))}
                  </div>
              )}
              
              <div className="prose prose-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
                {entry.content}
              </div>

              <div className="mt-4 pt-4 border-t border-gray-50 flex items-center justify-between">
                 <div className="flex items-center gap-2">
                    <span className="text-xs text-gray-400 uppercase tracking-wider font-semibold">Mood</span>
                    <div className={`h-2 w-2 rounded-full ${entry.moodScore >= 7 ? 'bg-green-500' : entry.moodScore <= 4 ? 'bg-red-500' : 'bg-yellow-500'}`} />
                 </div>
                 
                 {entry.sentiment && (
                    <span className={`text-xs px-2 py-1 rounded-full ${
                        entry.sentiment === 'Positive' ? 'bg-green-100 text-green-700' : 
                        entry.sentiment === 'Negative' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'
                    }`}>
                        {entry.sentiment}
                    </span>
                 )}
              </div>
            </div>
          ))
      )}

      {/* --- AI MODAL --- */}
      <Transition appear show={showInsightModal} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowInsightModal(false)}>
          <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0" enterTo="opacity-100" leave="ease-in duration-200" leaveFrom="opacity-100" leaveTo="opacity-0">
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          </Transition.Child>

          <div className="fixed inset-0 overflow-y-auto">
            <div className="flex min-h-full items-center justify-center p-4 text-center">
              <Transition.Child as={Fragment} enter="ease-out duration-300" enterFrom="opacity-0 scale-95" enterTo="opacity-100 scale-100" leave="ease-in duration-200" leaveFrom="opacity-100 scale-100" leaveTo="opacity-0 scale-95">
                <Dialog.Panel className="w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                  <Dialog.Title as="h3" className="text-lg font-bold leading-6 text-gray-900 flex items-center gap-2">
                    <SparklesIcon className="h-6 w-6 text-purple-500" />
                    Filtered Insights
                  </Dialog.Title>
                  
                  {analyzing ? (
                    <div className="mt-4 py-8 flex flex-col items-center justify-center">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                        <p className="mt-2 text-sm text-gray-500">Analyzing your {filteredEntries.length} selected entries...</p>
                    </div>
                  ) : (
                    insight && (
                        <div className="mt-4 space-y-4">
                            <div className="bg-purple-50 p-4 rounded-lg text-sm text-gray-700 leading-relaxed">
                                {insight.analysis}
                            </div>
                            
                            <div className="flex justify-between items-center text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                <span>Mood: <span className="text-purple-700">{insight.mood}</span></span>
                                <span>Sentiment: <span className="text-purple-700">{insight.sentiment}</span></span>
                            </div>

                            <div>
                                <h4 className="text-sm font-bold text-gray-900 mb-2">Suggested Actions:</h4>
                                <ul className="space-y-2">
                                    {insight.actionableSteps.map((step, i) => (
                                        <li key={i} className="flex items-start gap-2 text-sm text-gray-600">
                                            <span className="text-purple-500 mt-1">‚Ä¢</span>
                                            {step}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    )
                  )}

                  <div className="mt-6">
                    <button type="button" className="inline-flex justify-center rounded-md border border-transparent bg-purple-100 px-4 py-2 text-sm font-medium text-purple-900 hover:bg-purple-200 focus:outline-none w-full" onClick={() => setShowInsightModal(false)}>
                      Close
                    </button>
                  </div>
                </Dialog.Panel>
              </Transition.Child>
            </div>
          </div>
        </Dialog>
      </Transition>
    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalInsights.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { db } from '../../lib/firebase';
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';
import type { JournalEntry } from './JournalEditor';
import {
  LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
} from 'recharts';

// --- HELPERS ---
const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const COLORS = ['#4ade80', '#f87171', '#94a3b8']; // Green, Red, Gray

const STOP_WORDS = new Set([
  'the', 'and', 'a', 'to', 'of', 'in', 'i', 'is', 'that', 'it', 'for', 'my', 'was', 'on', 'with', 'as', 'at', 'be', 'have', 'this', 'me', 'so', 'but', 'not', 'are', 'am', 'will', 'just', 'all', 'today', 'day', 'had', 'very'
]);

export default function JournalInsights() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  
  // Chart Data State
  const [moodData, setMoodData] = useState<any[]>([]);
  const [dayData, setDayData] = useState<any[]>([]);
  const [sentimentData, setSentimentData] = useState<any[]>([]);
  const [wordCloud, setWordCloud] = useState<{ text: string, count: number }[]>([]);

  useEffect(() => {
    if (user) loadData();
  }, [user]);

  const loadData = async () => {
    if (!user || !db) return;
    try {
      // 1. Fetch Entries (Last 50 for performance)
      const q = query(collection(db, 'journals'), where('uid', '==', user.uid), orderBy('createdAt', 'desc'));
      const snapshot = await getDocs(q);
      const entries = snapshot.docs.map(doc => ({ ...doc.data() } as JournalEntry));

      processMoodGraph(entries);
      processTriggerDays(entries);
      processSentiment(entries);
      processWordCloud(entries);

    } catch (error) {
      console.error("Error loading insights:", error);
    } finally {
      setLoading(false);
    }
  };

  // --- PROCESSORS ---

  const processMoodGraph = (entries: JournalEntry[]) => {
    // Reverse to show oldest -> newest left to right
    const data = [...entries].reverse().map(e => ({
      date: e.createdAt?.toDate ? e.createdAt.toDate().toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' }) : '',
      mood: e.moodScore
    }));
    setMoodData(data);
  };

  const processTriggerDays = (entries: JournalEntry[]) => {
    const daySums = new Array(7).fill(0);
    const dayCounts = new Array(7).fill(0);

    entries.forEach(e => {
      if (e.createdAt?.toDate) {
        const dayIdx = e.createdAt.toDate().getDay();
        daySums[dayIdx] += e.moodScore;
        dayCounts[dayIdx] += 1;
      }
    });

    const data = DAYS.map((day, idx) => ({
      name: day,
      avgMood: dayCounts[idx] ? parseFloat((daySums[idx] / dayCounts[idx]).toFixed(1)) : 0
    }));
    setDayData(data);
  };

  const processSentiment = (entries: JournalEntry[]) => {
    let pos = 0, neg = 0, neu = 0;
    entries.forEach(e => {
      // Use explicit sentiment if available, else guess by mood
      if (e.sentiment === 'Positive') pos++;
      else if (e.sentiment === 'Negative') neg++;
      else if (e.sentiment === 'Neutral') neu++;
      else {
        // Fallback logic
        if (e.moodScore >= 7) pos++;
        else if (e.moodScore <= 4) neg++;
        else neu++;
      }
    });

    setSentimentData([
      { name: 'Positive', value: pos },
      { name: 'Negative', value: neg },
      { name: 'Neutral', value: neu }
    ].filter(d => d.value > 0));
  };

  const processWordCloud = (entries: JournalEntry[]) => {
    const wordCounts: Record<string, number> = {};
    
    entries.forEach(e => {
      // Simple tokenization: lowercase, remove punctuation
      const words = e.content.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
      words.forEach(w => {
        if (w.length > 2 && !STOP_WORDS.has(w)) {
          wordCounts[w] = (wordCounts[w] || 0) + 1;
        }
      });
    });

    const sorted = Object.entries(wordCounts)
      .map(([text, count]) => ({ text, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 30); // Top 30

    setWordCloud(sorted);
  };

  if (loading) return <div className="text-center py-10 text-gray-400">Crunching the numbers...</div>;
  if (moodData.length === 0) return <div className="text-center py-10 text-gray-400">No entries found to analyze.</div>;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
      
      {/* 1. MOOD GRAPH */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2">
         <h3 className="font-bold text-gray-900 mb-4">Mood History</h3>
         <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
               <LineChart data={moodData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="date" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[1, 10]} hide />
                  <Tooltip 
                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="mood" 
                    stroke="#2563eb" 
                    strokeWidth={3}
                    dot={{ r: 4, fill: '#2563eb', strokeWidth: 0 }}
                    activeDot={{ r: 6 }} 
                  />
               </LineChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 2. TRIGGER DAYS (BAR) */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
         <h3 className="font-bold text-gray-900 mb-4">Average Mood by Day</h3>
         <div className="h-56 w-full">
            <ResponsiveContainer width="100%" height="100%">
               <BarChart data={dayData}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                  <XAxis dataKey="name" tick={{fontSize: 12}} stroke="#9ca3af" />
                  <YAxis domain={[0, 10]} hide />
                  <Tooltip cursor={{fill: 'transparent'}} />
                  <Bar dataKey="avgMood" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={20} />
               </BarChart>
            </ResponsiveContainer>
         </div>
      </div>

      {/* 3. SENTIMENT (PIE) */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center">
         <h3 className="font-bold text-gray-900 mb-4 self-start">Emotional Weather</h3>
         <div className="h-56 w-full flex justify-center">
            <ResponsiveContainer width="100%" height="100%">
               <PieChart>
                  <Pie
                    data={sentimentData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={80}
                    paddingAngle={5}
                    dataKey="value"
                  >
                    {/* FIXED: Renamed 'entry' to '_' to silence unused var warning */}
                    {sentimentData.map((_, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
               </PieChart>
            </ResponsiveContainer>
         </div>
         <div className="flex gap-4 text-xs mt-2">
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#4ade80]"></div>Positive</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#f87171]"></div>Negative</div>
            <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-[#94a3b8]"></div>Neutral</div>
         </div>
      </div>

      {/* 4. WORD CLOUD */}
      <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm md:col-span-2">
         <h3 className="font-bold text-gray-900 mb-4">Recurring Themes (Top Words)</h3>
         <div className="flex flex-wrap gap-2 justify-center p-4 min-h-[150px] content-center">
            {/* FIXED: Removed unused 'i' index from map arguments */}
            {wordCloud.map((w) => {
               // Calculate font size relative to frequency
               const max = wordCloud[0]?.count || 1;
               const size = Math.max(0.8, (w.count / max) * 2.5); // 0.8rem to 2.5rem
               const opacity = Math.max(0.5, w.count / max);
               
               return (
                  <span 
                    key={w.text} 
                    style={{ fontSize: `${size}rem`, opacity }}
                    className="text-blue-600 font-medium hover:scale-110 transition-transform cursor-default"
                    title={`${w.count} occurrences`}
                  >
                    {w.text}
                  </span>
               );
            })}
         </div>
      </div>

    </div>
  );
}

================================================================================
FILE: src/components/journal/JournalTabs.tsx
================================================================================
import { PencilSquareIcon, ClockIcon, ChartPieIcon } from '@heroicons/react/24/outline';

interface JournalTabsProps {
  activeTab: 'write' | 'history' | 'insights';
  onChange: (tab: 'write' | 'history' | 'insights') => void;
}

export default function JournalTabs({ activeTab, onChange }: JournalTabsProps) {
  return (
    <div className="flex p-1 space-x-1 bg-blue-100/50 rounded-xl mb-6 overflow-x-auto">
      <button
        onClick={() => onChange('write')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'write'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <PencilSquareIcon className="w-4 h-4" />
        New Entry
      </button>
      <button
        onClick={() => onChange('history')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'history'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ClockIcon className="w-4 h-4" />
        History
      </button>
      <button
        onClick={() => onChange('insights')}
        className={`flex-1 min-w-[100px] flex items-center justify-center gap-2 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ${
          activeTab === 'insights'
            ? 'bg-white text-blue-700 shadow-sm'
            : 'text-blue-600 hover:bg-white/50'
        }`}
      >
        <ChartPieIcon className="w-4 h-4" />
        Insights
      </button>
    </div>
  );
}

================================================================================
FILE: src/contexts/AuthContext.tsx
================================================================================
import { createContext, useContext, useEffect, useState } from 'react';
import { 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  type User // FIX 1: Type-only import
} from 'firebase/auth';
import { auth } from '../lib/firebase';
import { getOrCreateUserProfile } from '../lib/db';

interface AuthContextType {
  user: User | null;
  loading: boolean;
  loginWithGoogle: () => Promise<void>;
  signupWithEmail: (email: string, pass: string) => Promise<void>;
  loginWithEmail: (email: string, pass: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
}

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // FIX 2: Guard clause - if auth failed to initialize, stop here
    if (!auth) {
      console.error("Firebase Auth not initialized");
      setLoading(false);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      try {
        if (currentUser) {
          await getOrCreateUserProfile(currentUser);
          setUser(currentUser);
        } else {
          setUser(null);
        }
      } catch (error) {
        console.error("Error fetching user profile:", error);
        setUser(currentUser); 
      } finally {
        setLoading(false);
      }
    });

    return unsubscribe;
  }, []);

  const loginWithGoogle = async () => {
    if (!auth) throw new Error("Auth not initialized");
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await signInWithPopup(auth, provider);
  };

  const signupWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    const result = await createUserWithEmailAndPassword(auth, email, pass);
    await getOrCreateUserProfile(result.user);
  };

  const loginWithEmail = async (email: string, pass: string) => {
    if (!auth) throw new Error("Auth not initialized");
    await signInWithEmailAndPassword(auth, email, pass);
  };

  const logout = async () => {
    if (!auth) return;
    await signOut(auth);
  };

  const value = {
    user,
    loading,
    loginWithGoogle,
    signupWithEmail,
    loginWithEmail,
    logout
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

================================================================================
FILE: src/data/workbooks.ts
================================================================================
export interface Question {
  id: string;
  text: string;
  context?: string; // Optional context/quote from literature
}

export interface WorkbookSection {
  id: string;
  title: string;
  description?: string;
  questions: Question[];
}

export interface Workbook {
  id: string;
  title: string;
  description: string;
  type: 'linear' | 'steps' | 'general';
  sections: WorkbookSection[];
}

// Helper to generate generic questions for sections we don't fully populate in this snippet
const generateQuestions = (count: number, prefix: string): Question[] => {
  return Array.from({ length: count }).map((_, i) => ({
    id: `${prefix}_q${i + 1}`,
    text: `Question ${i + 1}: Reflection point regarding ${prefix.replace(/_/g, ' ')}.`,
  }));
};

// --- 1. GENERAL RECOVERY WORKBOOK (25 Questions) ---
const generalQuestions: Question[] = [
  { id: 'gen_1', text: "What are the specific consequences of your addiction that led you to seek recovery?" },
  { id: 'gen_2', text: "Describe a time when you tried to control your using but failed." },
  { id: 'gen_3', text: "How has your addiction affected your relationships with family and friends?" },
  { id: 'gen_4', text: "What emotions trigger your desire to use?" },
  { id: 'gen_5', text: "List 5 things you are grateful for today." },
  { id: 'gen_6', text: "What does 'rock bottom' mean to you, and do you feel you hit it?" },
  { id: 'gen_7', text: "How does honesty play a role in your recovery?" },
  { id: 'gen_8', text: "What are your biggest fears about living sober?" },
  { id: 'gen_9', text: "Who are the people in your support network?" },
  { id: 'gen_10', text: "What hobbies or activities did you neglect during active addiction?" },
  { id: 'gen_11', text: "Describe your physical health during active addiction versus now." },
  { id: 'gen_12', text: "What lies did you tell yourself to justify your using?" },
  { id: 'gen_13', text: "How has your addiction impacted your career or education?" },
  { id: 'gen_14', text: "What specific boundaries do you need to set to protect your sobriety?" },
  { id: 'gen_15', text: "How do you handle stress without substances?" },
  { id: 'gen_16', text: "What does a 'spiritual awakening' mean to you?" },
  { id: 'gen_17', text: "List 3 short-term goals for your recovery." },
  { id: 'gen_18', text: "List 3 long-term goals for your life." },
  { id: 'gen_19', text: "How can you be of service to others?" },
  { id: 'gen_20', text: "What resentments are you holding onto, and how do they affect you?" },
  { id: 'gen_21', text: "Describe a situation where you successfully navigated a craving." },
  { id: 'gen_22', text: "What does 'taking it one day at a time' look like in practice?" },
  { id: 'gen_23', text: "How do you practice self-care?" },
  { id: 'gen_24', text: "What advice would you give to your past self?" },
  { id: 'gen_25', text: "Why is recovery worth it for you?" },
];

// --- 2. 12-STEP WORKBOOK (12 Steps, ~15 Qs each) ---
const step1Questions: Question[] = [
  { id: 's1_q1', text: "Do you accept that you have a disease of addiction?", context: "We admitted we were powerless over our addiction..." },
  { id: 's1_q2', text: "How has the disease of addiction manifested in your life?" },
  { id: 's1_q3', text: "Have you ever tried to stop on your own and found you couldn't?" },
  { id: 's1_q4', text: "What specific incidents indicate you have lost control over your usage?" },
  { id: 's1_q5', text: "How has your thinking been distorted by addiction (denial, rationalization)?" },
  { id: 's1_q6', text: "In what ways have you been powerless over your behavior?" },
  { id: 's1_q7', text: "Have you lost self-respect due to your addiction?" },
  { id: 's1_q8', text: "How has your addiction affected you physically?" },
  { id: 's1_q9', text: "How has your addiction affected you mentally?" },
  { id: 's1_q10', text: "How has your addiction affected you spiritually?" },
  { id: 's1_q11', text: "How has your addiction affected you emotionally?" },
  { id: 's1_q12', text: "What is unmanageability to you?" },
  { id: 's1_q13', text: "What are some examples of unmanageability in your life?" },
  { id: 's1_q14', text: "Are you ready to admit you are an addict?" },
  { id: 's1_q15', text: "What reservations do you still have about staying clean?" },
];

const twelveStepSections: WorkbookSection[] = [
  { id: 'step_1', title: 'Step 1', description: 'Powerlessness & Unmanageability', questions: step1Questions },
  { id: 'step_2', title: 'Step 2', description: 'Came to believe', questions: generateQuestions(15, 'step_2') },
  { id: 'step_3', title: 'Step 3', description: 'Turning it over', questions: generateQuestions(15, 'step_3') },
  { id: 'step_4', title: 'Step 4', description: 'Searching and fearless moral inventory', questions: generateQuestions(15, 'step_4') },
  { id: 'step_5', title: 'Step 5', description: 'Admitted to God, ourselves, and another', questions: generateQuestions(15, 'step_5') },
  { id: 'step_6', title: 'Step 6', description: 'Entirely ready', questions: generateQuestions(15, 'step_6') },
  { id: 'step_7', title: 'Step 7', description: 'Humbly asked Him', questions: generateQuestions(15, 'step_7') },
  { id: 'step_8', title: 'Step 8', description: 'List of persons we had harmed', questions: generateQuestions(15, 'step_8') },
  { id: 'step_9', title: 'Step 9', description: 'Direct amends', questions: generateQuestions(15, 'step_9') },
  { id: 'step_10', title: 'Step 10', description: 'Continued to take personal inventory', questions: generateQuestions(15, 'step_10') },
  { id: 'step_11', title: 'Step 11', description: 'Sought through prayer and meditation', questions: generateQuestions(15, 'step_11') },
  { id: 'step_12', title: 'Step 12', description: 'Spiritual awakening', questions: generateQuestions(15, 'step_12') },
];

// --- 3. RECOVERY DHARMA WORKBOOK ---
const dharmaSections: WorkbookSection[] = [
  { id: 'rd_truth_1', title: 'First Noble Truth', description: 'There is suffering', questions: generateQuestions(10, 'dharma_1') },
  { id: 'rd_truth_2', title: 'Second Noble Truth', description: 'The cause of suffering', questions: generateQuestions(10, 'dharma_2') },
  { id: 'rd_truth_3', title: 'Third Noble Truth', description: 'The end of suffering', questions: generateQuestions(10, 'dharma_3') },
  { id: 'rd_truth_4', title: 'Fourth Noble Truth', description: 'The path', questions: generateQuestions(10, 'dharma_4') },
];

// --- MASTER REGISTRY ---
export const WORKBOOKS: Workbook[] = [
  {
    id: 'general_recovery',
    title: 'General Recovery Workbook',
    description: 'A comprehensive 25-question guide to explore the foundations of your recovery journey.',
    type: 'general',
    sections: [{ id: 'main', title: 'Core Questions', questions: generalQuestions }]
  },
  {
    id: '12_steps',
    title: '12-Step Workbook',
    description: 'A rigorous journey through the 12 Steps. 15 questions per step to prepare for sponsor work.',
    type: 'steps',
    sections: twelveStepSections
  },
  {
    id: 'recovery_dharma',
    title: 'Recovery Dharma',
    description: 'Buddhist-inspired path to recovery focusing on the Four Noble Truths and Eightfold Path.',
    type: 'steps',
    sections: dharmaSections
  }
];

export function getWorkbook(id: string): Workbook | undefined {
  return WORKBOOKS.find(w => w.id === id);
}

================================================================================
FILE: src/index.css
================================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    /* The "Unified Blue" Theme from your Master Doc */
    @apply bg-blue-50 text-slate-800 antialiased;
  }
  
  /* Reset headings to be bold and dark blue by default */
  h1, h2, h3, h4, h5, h6 {
    @apply font-bold text-blue-900;
  }
}

================================================================================
FILE: src/lib/db.ts
================================================================================
import { 
  doc, 
  getDoc, 
  setDoc, 
  updateDoc, 
  collection, 
  getDocs, 
  deleteDoc, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { type User } from "firebase/auth";

export interface UserProfile {
  uid: string;
  email: string | null;
  displayName: string | null;
  photoURL: string | null;
  sobrietyDate: Timestamp | null;
  createdAt: Timestamp;
}

// --- NEW: Template Interface ---
export interface JournalTemplate {
  id: string;
  name: string;
  prompts: string[]; // List of questions (e.g., "What was the trigger?")
  defaultTags: string[]; // List of tags (e.g., "#step10")
}

// 1. Fetch a simple profile (Read-Only)
export async function getProfile(uid: string): Promise<UserProfile | null> {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  }
  return null;
}

// 2. Create or Get User Profile
export async function getOrCreateUserProfile(user: User): Promise<UserProfile> {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    return userSnap.data() as UserProfile;
  } else {
    // Initialize new profile
    const newProfile: UserProfile = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      photoURL: user.photoURL,
      sobrietyDate: null, 
      createdAt: Timestamp.now(),
    };
    await setDoc(userRef, newProfile);
    return newProfile;
  }
}

// 3. Generic Profile Update
export async function updateProfileData(uid: string, data: Partial<UserProfile> | { sobrietyDate: Date | null }) {
  if (!db) throw new Error("Database not initialized");

  const userRef = doc(db, "users", uid);
  const { ...updateFields } = data;
  await setDoc(userRef, { ...updateFields }, { merge: true });
}

// 4. Update Sobriety Date (Legacy helper)
export async function updateSobrietyDate(uid: string, date: Date) {
  if (!db) throw new Error("Database not initialized");
  
  const userRef = doc(db, "users", uid);
  await updateDoc(userRef, {
    sobrietyDate: Timestamp.fromDate(date)
  });
}

// --- NEW: Template CRUD Operations ---

// Get all templates for a user
export async function getUserTemplates(uid: string): Promise<JournalTemplate[]> {
  if (!db) throw new Error("Database not initialized");

  const templatesRef = collection(db, 'users', uid, 'templates');
  const snapshot = await getDocs(templatesRef);

  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  } as JournalTemplate));
}

// Save (Create or Update) a template
export async function saveUserTemplate(uid: string, template: JournalTemplate) {
  if (!db) throw new Error("Database not initialized");

  // Use the provided ID or generate a new one if empty
  const docRef = template.id 
    ? doc(db, 'users', uid, 'templates', template.id)
    : doc(collection(db, 'users', uid, 'templates'));

  // Ensure we save the ID inside the doc too (optional but helpful)
  const dataToSave = {
    ...template,
    id: docRef.id // Ensure ID matches doc ref
  };

  await setDoc(docRef, dataToSave);
}

// Delete a template
export async function deleteUserTemplate(uid: string, templateId: string) {
  if (!db) throw new Error("Database not initialized");

  const docRef = doc(db, 'users', uid, 'templates', templateId);
  await deleteDoc(docRef);
}

================================================================================
FILE: src/lib/firebase.ts
================================================================================
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

// 1. Construct config directly from individual environment variables
// These will be injected by Vite during the build
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
};

// 2. Initialize (Safe Check)
// We check if apiKey exists to ensure we aren't crashing on empty config
const app = firebaseConfig.apiKey ? initializeApp(firebaseConfig) : undefined;

if (!app) {
  console.error("Firebase failed to initialize. Missing API Key.");
}

export const auth = app ? getAuth(app) : undefined;
export const db = app ? getFirestore(app) : undefined;
export const googleProvider = new GoogleAuthProvider();

export default app;

================================================================================
FILE: src/lib/gamification.ts
================================================================================
import { differenceInCalendarDays, startOfDay, isSameDay, subDays } from 'date-fns';
import type { JournalEntry } from './journal';

export interface GamificationStats {
  journalStreak: number;
  totalEntries: number;
  totalWords: number;
  consistencyRate: number; // Avg entries per week
  averageMood: number; // Lifetime average
}

export function calculateJournalStats(entries: JournalEntry[]): GamificationStats {
  if (entries.length === 0) {
    return { 
      journalStreak: 0, 
      totalEntries: 0, 
      totalWords: 0, 
      consistencyRate: 0,
      averageMood: 0 
    };
  }

  // 1. Sort entries by date descending (Newest first)
  const sorted = [...entries].sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
  
  // 2. Calculate Streak
  let streak = 0;
  const today = startOfDay(new Date());
  
  // Check if we wrote today to start the count, or if the streak ended yesterday
  const lastEntryDate = startOfDay(sorted[0].createdAt);
  
  // If the last entry was neither today nor yesterday, streak is 0.
  if (!isSameDay(lastEntryDate, today) && !isSameDay(lastEntryDate, subDays(today, 1))) {
      streak = 0;
  } else {
      // Start counting backwards
      // We create a unique set of dates strings to handle multiple entries in one day
      const uniqueDates = Array.from(new Set(sorted.map(e => startOfDay(e.createdAt).toISOString())));
      
      // Re-sort unique dates descending
      uniqueDates.sort((a, b) => new Date(b).getTime() - new Date(a).getTime());

      // Loop through unique dates to find consecutive days
      streak = 1;
      for (let i = 0; i < uniqueDates.length - 1; i++) {
        const current = new Date(uniqueDates[i]);
        const prev = new Date(uniqueDates[i+1]);
        
        const diff = differenceInCalendarDays(current, prev);
        
        if (diff === 1) {
            streak++;
        } else {
            break; // Streak broken
        }
      }
  }

  // 3. Word Count
  const totalWords = entries.reduce((acc, curr) => acc + (curr.content.trim().split(/\s+/).length || 0), 0);

  // 4. Consistency (Entries / Weeks active)
  const firstEntry = sorted[sorted.length - 1].createdAt;
  const daysActive = differenceInCalendarDays(today, firstEntry) || 1; // Avoid divide by zero
  const weeksActive = Math.max(daysActive / 7, 1);
  const consistencyRate = parseFloat((entries.length / weeksActive).toFixed(1));

  // 5. Average Mood (Lifetime)
  const totalMood = entries.reduce((acc, curr) => acc + (curr.moodScore || 0), 0);
  const averageMood = parseFloat((totalMood / entries.length).toFixed(1));

  return {
    journalStreak: streak,
    totalEntries: entries.length,
    totalWords,
    consistencyRate,
    averageMood
  };
}

================================================================================
FILE: src/lib/gemini.ts
================================================================================
import { GoogleGenerativeAI } from "@google/generative-ai";

// Initialize Gemini
// Ensure your VITE_GEMINI_API_KEY is set in .env
const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GEMINI_API_KEY);

// --- 1. JOURNAL ANALYSIS ---

export interface AnalysisResult {
  analysis: string;
  mood: string;
  sentiment: string;
  actionableSteps: string[];
}

export async function analyzeJournalEntries(journalEntries: string[]): Promise<AnalysisResult> {
  try {
    // UPDATED: Using 'gemini-2.5-flash' which is the stable release as of Dec 2025
    //
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    const prompt = `
      You are a compassionate, wise, and experienced Recovery Coach and Sponsor. 
      Analyze the following journal entries from a user in recovery from addiction.
      
      Entries:
      ${JSON.stringify(journalEntries)}

      Return a JSON object with the following structure (do NOT use Markdown formatting, just raw JSON):
      {
        "analysis": "A 2-3 sentence summary of their emotional state and progress.",
        "mood": "One word summary (e.g., Hopeful, Struggling, Determined)",
        "sentiment": "Positive, Neutral, or Negative", 
        "actionableSteps": ["Step 1", "Step 2", "Step 3"]
      }

      The actionable steps should be practical, recovery-focused suggestions (e.g., "Call your sponsor", "Go to a meeting", "Practice self-care").
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    // Clean up potential markdown code blocks if the model adds them
    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();

    return JSON.parse(cleanText) as AnalysisResult;

  } catch (error) {
    console.error("Gemini API Error:", error);
    // Fallback if API fails or key is missing
    return {
      analysis: "Great job keeping up with your journaling. Keep coming back!",
      mood: "Stable",
      sentiment: "Positive",
      actionableSteps: ["Attend a meeting", "Call a friend", "Meditate for 5 mins"]
    };
  }
}

// --- 2. WORKBOOK ANALYSIS ---

export interface WorkbookInsight {
  feedback: string;
  encouragement: string;
}

export async function analyzeFullWorkbook(workbookTitle: string, fullContent: string): Promise<WorkbookInsight> {
  try {
    // UPDATED: Using 'gemini-2.5-flash'
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    const prompt = `
      You are a compassionate Recovery Sponsor reviewing a sponsee's entire workbook.
      
      Workbook: "${workbookTitle}"
      
      User's Answers (grouped by section):
      ${fullContent}

      Please analyze their work holistically. Look for patterns across different sections, emotional trajectory, and depth of honesty.
      
      Return a JSON object with this structure (no Markdown):
      {
        "feedback": "A deep, insightful paragraph (4-6 sentences) connecting the dots between their answers. Mention specific patterns you notice across the workbook.",
        "encouragement": "A strong, motivating closing statement."
      }
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();
    
    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();

    return JSON.parse(cleanText) as WorkbookInsight;

  } catch (error) {
    console.error("Gemini Workbook Error:", error);
    return {
      feedback: "You have done a significant amount of work here. The consistency in your answers shows a real desire for change.",
      encouragement: "Keep trusting the process!"
    };
  }
}

// Deprecated single-section analyzer (kept for type safety if referenced elsewhere)
export async function analyzeWorkbook(sectionTitle: string, qaPairs: { question: string, answer: string }[]): Promise<WorkbookInsight> {
  return analyzeFullWorkbook(sectionTitle, JSON.stringify(qaPairs));
}

================================================================================
FILE: src/lib/importer.ts
================================================================================
import { collection, doc, writeBatch, Timestamp } from 'firebase/firestore';
import { db } from './firebase';

// 1. Define the target format (Your current app schema)
export interface NewJournalEntry {
  uid: string;
  content: string;
  moodScore: number;
  sentiment: string;
  weather: { temp: number; condition: string } | null;
  createdAt: Timestamp;
  tags: string[];
}

// 2. Define the exact Legacy format based on your uploaded JSON
interface LegacyEntry {
  id: string;
  text: string;
  mood: number;
  weather?: string;
  tags?: string[];
  timestamp: string;
}

// 3. Helper to parse weather string "Partly Cloudy, -6¬∞C" -> { condition, temp }
const parseLegacyWeather = (weatherStr?: string): { temp: number; condition: string } | null => {
  if (!weatherStr || typeof weatherStr !== 'string') return null;

  // Regex to capture "Condition" and "Temp" (e.g. "Partly Cloudy, -6¬∞C")
  // Matches: Group 1 (Condition), Group 2 (Number)
  const match = weatherStr.match(/^(.*),\s*(-?\d+)¬∞C$/);

  if (match) {
    return {
      condition: match[1].trim(),
      temp: parseInt(match[2], 10)
    };
  }

  // Fallback if format is different but not empty
  if (weatherStr.trim().length > 0) {
    return { condition: weatherStr, temp: 0 };
  }

  return null;
};

// 4. The Mapper Function
// Converts "LegacyEntry" -> "NewJournalEntry"
const mapLegacyEntry = (uid: string, entry: LegacyEntry): NewJournalEntry => {
  // Handle mood: Legacy app seems to use 0 for unset. New app uses 1-10.
  // We map 0 to 5 (Neutral), and clamp others between 1-10.
  let mood = entry.mood || 5;
  if (mood === 0) mood = 5;
  mood = Math.max(1, Math.min(10, mood));

  return {
    uid,
    content: entry.text || "", // Map 'text' to 'content'
    moodScore: mood,
    sentiment: 'Neutral', // Legacy data doesn't have sentiment, default to Neutral
    weather: parseLegacyWeather(entry.weather),
    createdAt: Timestamp.fromDate(new Date(entry.timestamp)), // Parse ISO string
    tags: Array.isArray(entry.tags) ? entry.tags : [] // Carry over tags
  };
};

// 5. Main Import Function
export async function importLegacyJournals(uid: string, file: File): Promise<{ success: number; errors: number }> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = async (e) => {
      try {
        // FIX: Guard clause to ensure db is initialized
        if (!db) {
            reject(new Error("Firestore database is not initialized"));
            return;
        }

        const text = e.target?.result as string;
        const json = JSON.parse(text);

        // Ensure it's an array
        const rawEntries = Array.isArray(json) ? json : [json];
        
        if (rawEntries.length === 0) {
          resolve({ success: 0, errors: 0 });
          return;
        }

        // Process in batches of 500 (Firestore limit)
        let batch = writeBatch(db);
        let operationCount = 0;
        let successCount = 0;
        let errorCount = 0;

        for (const raw of rawEntries) {
          try {
            // Validate essential fields before mapping
            if (!raw.timestamp) {
              console.warn("Skipping entry without timestamp:", raw.id);
              errorCount++;
              continue;
            }

            const mappedData = mapLegacyEntry(uid, raw as LegacyEntry);
            
            // Generate a new ID for the document (ignoring legacy ID to avoid collision/format issues)
            const newDocRef = doc(collection(db, 'journals'));
            batch.set(newDocRef, mappedData);
            
            operationCount++;
            successCount++;

            // If we hit 450 (safety buffer below 500), commit and restart batch
            if (operationCount >= 450) {
              await batch.commit();
              batch = writeBatch(db); // New batch
              operationCount = 0;
            }
          } catch (err) {
            console.warn("Skipping invalid entry:", raw.id, err);
            errorCount++;
          }
        }

        // Commit any remaining ops
        if (operationCount > 0) {
          await batch.commit();
        }

        resolve({ success: successCount, errors: errorCount });

      } catch (error) {
        reject(error);
      }
    };

    reader.onerror = (error) => reject(error);
    reader.readAsText(file);
  });
}

================================================================================
FILE: src/lib/insights.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import type { AnalysisResult } from "./gemini";

const COLLECTION = 'insights';

/**
 * Saves a new AI Insight to Firestore.
 * @param uid - The User ID (e.g., "user_123")
 * @param result - The structured result from Gemini (analysis, sentiment, actions)
 */
export async function saveInsight(uid: string, result: AnalysisResult) {
  if (!db) throw new Error("Database not initialized");

  await addDoc(collection(db, COLLECTION), {
    uid,
    analysis: result.analysis,
    sentiment: result.sentiment,
    actionableSteps: result.actionableSteps,
    createdAt: Timestamp.now()
  });
}

/**
 * Fetches the history of AI Insights for a user, sorted by newest first.
 * Used by the Dashboard to show the "Latest Insight".
 */
export async function getInsightHistory(uid: string) {
  if (!db) throw new Error("Database not initialized");

  try {
    const q = query(
      collection(db, COLLECTION),
      where("uid", "==", uid),
      orderBy("createdAt", "desc")
    );

    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      // Safely convert Firestore Timestamp to JS Date
      createdAt: doc.data().createdAt?.toDate() || new Date() 
    }));

  } catch (e: any) {
    console.error("Error fetching insights:", e);
    // If we hit a Missing Index error (common with new collections),
    // warn the user to check the console.
    if (e.message && e.message.includes("index")) {
        console.warn("‚ö†Ô∏è MISSING INDEX: Open your browser console and click the Firebase link to create the index for 'insights'.");
    }
    return [];
  }
}

================================================================================
FILE: src/lib/journal.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  orderBy, 
  getDocs, 
  Timestamp,
  deleteDoc,
  doc,
  updateDoc // <--- Added this
} from "firebase/firestore";
import { db } from "./firebase";
import type { WeatherData } from "./weather";

export interface JournalEntry {
  id?: string;
  uid: string;
  content: string;
  tags: string[];
  moodScore: number;
  weather?: WeatherData | null;
  createdAt: Date;
}

const COLLECTION = 'journals';

// 1. CREATE
export async function addJournalEntry(
  uid: string, 
  content: string, 
  moodScore: number, 
  tags: string[],
  weather: WeatherData | null
) {
  if (!db) throw new Error("Database not initialized");
  
  await addDoc(collection(db, COLLECTION), {
    uid,
    content,
    tags,
    moodScore,
    weather: weather || null, 
    createdAt: Timestamp.now()
  });
}

// 2. READ
export async function getUserJournals(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid),
    orderBy("createdAt", "desc")
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data(),
    createdAt: doc.data().createdAt.toDate()
  })) as JournalEntry[];
}

// 3. UPDATE (New)
export async function updateJournalEntry(
  id: string,
  content: string, 
  moodScore: number, 
  tags: string[]
) {
  if (!db) throw new Error("Database not initialized");
  const docRef = doc(db, COLLECTION, id);
  await updateDoc(docRef, {
    content,
    moodScore,
    tags,
    // We do NOT update createdAt or weather, as those are historical facts
  });
}

// 4. DELETE
export async function deleteJournalEntry(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

================================================================================
FILE: src/lib/tasks.ts
================================================================================
import { 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs, 
  doc, 
  updateDoc,
  deleteDoc, 
  Timestamp 
} from "firebase/firestore";
import { db } from "./firebase";
import { startOfDay, isBefore, addDays, addWeeks, addMonths, isSameDay } from "date-fns";

export type Frequency = 'once' | 'daily' | 'weekly' | 'monthly';

export interface Task {
  id?: string;
  uid: string;
  title: string;
  isRecurring: boolean;
  frequency: Frequency; 
  currentStreak: number;
  lastCompletedAt: Date | null;
  dueDate: Date;
  createdAt: Date;
}

const COLLECTION = 'tasks';

// 1. CREATE
export async function addTask(uid: string, title: string, frequency: Frequency) {
  if (!db) throw new Error("Database not initialized");
  
  const today = startOfDay(new Date());
  const isRecurring = frequency !== 'once';

  await addDoc(collection(db, COLLECTION), {
    uid,
    title,
    isRecurring,
    frequency,
    currentStreak: 0,
    lastCompletedAt: null,
    dueDate: Timestamp.fromDate(today),
    createdAt: Timestamp.now()
  });
}

// 2. READ & LAZY EVALUATE STREAKS
export async function getUserTasks(uid: string) {
  if (!db) throw new Error("Database not initialized");

  const q = query(
    collection(db, COLLECTION),
    where("uid", "==", uid)
  );

  const snapshot = await getDocs(q);
  const tasks: Task[] = [];
  const today = startOfDay(new Date());

  for (const docSnap of snapshot.docs) {
    const data = docSnap.data();
    const task = { 
      id: docSnap.id, 
      ...data,
      dueDate: data.dueDate?.toDate(),
      lastCompletedAt: data.lastCompletedAt?.toDate(),
      createdAt: data.createdAt?.toDate()
    } as Task;

    // --- LAZY EVALUATION LOGIC ---
    // If it's recurring, overdue, and NOT completed today:
    if (task.isRecurring && isBefore(task.dueDate, today)) {
        
        const completedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
        
        if (!completedToday) {
            let newStreak = task.currentStreak;
            
            // Punishment Logic
            if (newStreak > 0) {
                newStreak = 0; // Break positive streak
            } else {
                newStreak -= 1; // Deepen negative streak
            }

            // Reset due date to Today so they can get back on track
            const taskRef = doc(db, COLLECTION, task.id!);
            await updateDoc(taskRef, {
                currentStreak: newStreak,
                dueDate: Timestamp.fromDate(today)
            });

            task.currentStreak = newStreak;
            task.dueDate = today;
        }
    }

    tasks.push(task);
  }

  return tasks;
}

// 3. TOGGLE COMPLETION
export async function toggleTask(task: Task, isCompleted: boolean) {
  if (!db) throw new Error("Database not initialized");
  const taskRef = doc(db, COLLECTION, task.id!);
  const today = startOfDay(new Date());

  if (isCompleted) {
    // MARKING DONE
    let newStreak = task.currentStreak;
    if (newStreak < 0) {
        newStreak = 1; // Bounce back from negative
    } else {
        newStreak += 1;
    }

    // Calculate next due date based on Frequency
    let nextDue = task.dueDate;
    if (task.frequency === 'daily') nextDue = addDays(today, 1);
    else if (task.frequency === 'weekly') nextDue = addWeeks(today, 1);
    else if (task.frequency === 'monthly') nextDue = addMonths(today, 1);
    // If 'once', date doesn't strictly matter as it won't recur, but we keep it valid.

    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: Timestamp.fromDate(new Date()),
        dueDate: Timestamp.fromDate(nextDue)
    });

  } else {
    // UNCHECKING
    const newStreak = task.currentStreak > 0 ? task.currentStreak - 1 : task.currentStreak;
    
    await updateDoc(taskRef, {
        currentStreak: newStreak,
        lastCompletedAt: null,
        dueDate: Timestamp.fromDate(today)
    });
  }
}

// 4. DELETE
export async function deleteTask(id: string) {
  if (!db) throw new Error("Database not initialized");
  await deleteDoc(doc(db, COLLECTION, id));
}

// 5. GET COMPLETED TODAY
export async function getCompletedTasksForToday(uid: string) {
    if (!db) throw new Error("Database not initialized");
    const today = startOfDay(new Date());
    const allTasks = await getUserTasks(uid);
    
    return allTasks.filter(t => 
        t.lastCompletedAt && isSameDay(t.lastCompletedAt, today)
    );
}

================================================================================
FILE: src/lib/weather.ts
================================================================================
// Maps WMO Weather Codes to human readable text
function getWeatherCondition(code: number): string {
  if (code === 0) return 'Clear sky';
  if (code >= 1 && code <= 3) return 'Partly cloudy';
  if (code >= 45 && code <= 48) return 'Foggy';
  if (code >= 51 && code <= 55) return 'Drizzle';
  if (code >= 61 && code <= 65) return 'Rain';
  if (code >= 71 && code <= 77) return 'Snow';
  if (code >= 95 && code <= 99) return 'Thunderstorm';
  return 'Unknown';
}

export interface WeatherData {
  temp: number;
  condition: string;
  location: string; // We'll just store "Lat/Lon" or a generic name for now
}

export async function getCurrentWeather(): Promise<WeatherData | null> {
  if (!navigator.geolocation) {
    console.warn("Geolocation not supported");
    return null;
  }

  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const { latitude, longitude } = position.coords;
          
          // Using Open-Meteo (Free, No Key Required)
          const response = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=celsius`
          );
          
          if (!response.ok) throw new Error("Weather API failed");
          
          const data = await response.json();
          const weather = data.current_weather;

          resolve({
            temp: weather.temperature,
            condition: getWeatherCondition(weather.weathercode),
            location: 'Local' // We could use a reverse geocoding API here later if needed
          });
        } catch (error) {
          console.error("Error fetching weather:", error);
          resolve(null);
        }
      },
      (error) => {
        console.warn("Location permission denied or failed", error);
        resolve(null);
      }
    );
  });
}

================================================================================
FILE: src/lib/workbooks.ts
================================================================================
import { doc, getDoc, setDoc } from 'firebase/firestore';
import { db } from './firebase';

// Data structure for Firestore:
// users/{uid}/workbook_answers/{workbookId}_{sectionId}
// Document contains: { [questionId]: "Answer text", lastUpdated: timestamp }

export interface WorkbookProgress {
  [questionId: string]: string;
}

export async function saveAnswer(uid: string, workbookId: string, sectionId: string, questionId: string, answer: string) {
  if (!db) throw new Error("Firestore database is not initialized");

  const docId = `${workbookId}_${sectionId}`;
  const docRef = doc(db, 'users', uid, 'workbook_answers', docId);

  // Use setDoc with merge: true to create if not exists or update if exists
  await setDoc(docRef, {
    [questionId]: answer,
    lastUpdated: new Date()
  }, { merge: true });
}

export async function getSectionAnswers(uid: string, workbookId: string, sectionId: string): Promise<WorkbookProgress> {
  if (!db) throw new Error("Firestore database is not initialized");

  const docId = `${workbookId}_${sectionId}`;
  const docRef = doc(db, 'users', uid, 'workbook_answers', docId);
  const snapshot = await getDoc(docRef);

  if (snapshot.exists()) {
    return snapshot.data() as WorkbookProgress;
  }
  return {};
}

// Helper to check completion status for a section
export async function getSectionCompletion(uid: string, workbookId: string, sectionId: string, totalQuestions: number): Promise<number> {
  const answers = await getSectionAnswers(uid, workbookId, sectionId);
  
  // LOGIC UPDATE: Only count answers that are non-empty strings
  const answeredCount = Object.entries(answers).filter(([key, value]) => {
    // Ignore metadata keys like 'lastUpdated'
    if (key === 'lastUpdated') return false;
    // Ensure value is a string and has content (not just whitespace)
    return typeof value === 'string' && value.trim().length > 0;
  }).length;
  
  if (totalQuestions === 0) return 0;
  
  return Math.round((answeredCount / totalQuestions) * 100);
}

// --- NEW FUNCTION: Fetch ALL answers for a specific workbook ---
export async function getAllWorkbookAnswers(uid: string, workbookId: string, sections: { id: string, title: string }[]): Promise<string> {
  if (!db) throw new Error("Firestore database is not initialized");

  // Fetch all section documents in parallel
  const promises = sections.map(async (section) => {
    const answers = await getSectionAnswers(uid, workbookId, section.id);
    
    // Convert the object { q1: "text", q2: "text" } into a readable string
    const answerText = Object.entries(answers)
      .filter(([key, value]) => key !== 'lastUpdated' && typeof value === 'string' && value.trim().length > 0)
      .map(([_, value]) => `- ${value}`)
      .join('\n');

    if (!answerText) return null; // Skip empty sections

    return `SECTION: ${section.title}\n${answerText}`;
  });

  const results = await Promise.all(promises);
  return results.filter(r => r !== null).join('\n\n');
}

================================================================================
FILE: src/main.tsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'
import './index.css' // <--- THIS IS THE CRITICAL MISSING LINE

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

================================================================================
FILE: src/pages/Dashboard.tsx
================================================================================
import { useEffect, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../lib/firebase';
import { getUserJournals} from '../lib/journal';
import { getInsightHistory } from '../lib/insights';
import { getUserTasks, toggleTask, type Task } from '../lib/tasks';
import { calculateJournalStats, type GamificationStats } from '../lib/gamification';
import RecoveryHero from '../components/RecoveryHero';
import { Link } from 'react-router-dom';
import { 
  SparklesIcon,
  CheckCircleIcon
} from '@heroicons/react/24/outline';
import { isSameDay, startOfDay } from 'date-fns';

export default function Dashboard() {
  const { user } = useAuth();
  
  // State
  const [sobrietyDate, setSobrietyDate] = useState<Date | null>(null);
  const [latestInsight, setLatestInsight] = useState<any | null>(null);
  
  // Task State (Only top 5)
  const [priorityTasks, setPriorityTasks] = useState<Task[]>([]);
  
  // Gamification State
  const [stats, setStats] = useState<GamificationStats | null>(null);
  const [taskStreak, setTaskStreak] = useState(0);

  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadDashboardData() {
      if (!user || !db) return;

      try {
        // 1. Fetch User Profile
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().sobrietyDate) {
          setSobrietyDate(userDoc.data().sobrietyDate.toDate());
        }

        // 2. Fetch Journals & Calc Gamification
        const journals = await getUserJournals(user.uid);
        const journalStats = calculateJournalStats(journals);
        setStats(journalStats);

        // 3. Fetch Latest Insight
        try {
            const insights = await getInsightHistory(user.uid);
            if (insights.length > 0) setLatestInsight(insights[0]);
        } catch (e) {
            console.warn("Insight history fetch failed", e);
        }

        // 4. Fetch Tasks & Prioritize
        const fetchedTasks = await getUserTasks(user.uid);
        
        // Calculate total positive task streak
        const totalStreak = fetchedTasks.reduce((acc, t) => acc + (t.currentStreak > 0 ? t.currentStreak : 0), 0);
        setTaskStreak(totalStreak);

        // Filter: Not Completed OR Completed Today
        const today = startOfDay(new Date());
        const visibleTasks = fetchedTasks.filter(t => {
            if (!t.lastCompletedAt) return true; // Not done yet
            return isSameDay(t.lastCompletedAt, today); // Done today
        });

        // Sort: Overdue/Today first (Ascending Due Date)
        visibleTasks.sort((a, b) => a.dueDate.getTime() - b.dueDate.getTime());
        
        // Top 5
        setPriorityTasks(visibleTasks.slice(0, 5));

      } catch (error) {
        console.error("Error loading dashboard:", error);
      } finally {
        setLoading(false);
      }
    }

    loadDashboardData();
  }, [user]);

  // --- HANDLERS ---
  const handleToggleTask = async (task: Task) => {
    if (!user) return;

    const today = startOfDay(new Date());
    const isCompletedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
    const newState = !isCompletedToday;

    // Optimistic UI Update
    const updatedTasks = priorityTasks.map(t => {
        if (t.id === task.id) {
            return { 
                ...t, 
                lastCompletedAt: newState ? new Date() : null 
            }; 
        }
        return t;
    });
    setPriorityTasks(updatedTasks);

    await toggleTask(task, newState);
  };

  if (loading) {
    return <div className="p-8 text-center text-gray-500">Loading Dashboard...</div>;
  }

  return (
    <div className="space-y-6 max-w-5xl mx-auto">
      
      {/* 1. RECOVERY HERO (Unified Component) */}
      <RecoveryHero 
        sobrietyDate={sobrietyDate} 
        journalStats={stats}
        taskStreak={taskStreak}
      />

      {/* 2. MAIN GRID */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        {/* --- PRIORITIES WIDGET --- */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <CheckCircleIcon className="h-5 w-5 text-blue-500" />
                    Priorities
                </h3>
                <Link to="/tasks" className="text-sm text-blue-600 hover:underline">Manage All &rarr;</Link>
            </div>

            <div className="space-y-3">
                {priorityTasks.length === 0 && (
                    <p className="text-center text-gray-400 text-sm py-4">All caught up! Great job.</p>
                )}
                
                {priorityTasks.map(task => {
                    const today = startOfDay(new Date());
                    const isCompleted = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);

                    return (
                        <div key={task.id} className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-transparent hover:border-gray-100 cursor-pointer" onClick={() => handleToggleTask(task)}>
                            <div className="flex items-center gap-3">
                                <div className={`h-5 w-5 rounded-full border-2 flex items-center justify-center transition-all ${
                                        isCompleted 
                                            ? 'bg-green-500 border-green-500 text-white' 
                                            : 'border-gray-300'
                                    }`}
                                >
                                    {isCompleted && <CheckCircleIcon className="h-3 w-3" />}
                                </div>
                                
                                <span className={`block text-sm font-medium ${isCompleted ? 'text-gray-400 line-through' : 'text-gray-900'}`}>
                                    {task.title}
                                </span>
                            </div>
                            
                            {!isCompleted && task.isRecurring && (
                                <span className="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-full font-bold">
                                    Due
                                </span>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>

        {/* --- LATEST INSIGHT CARD (Moved up to replace Mood History) --- */}
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col justify-between">
          <div>
            <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <SparklesIcon className="h-5 w-5 text-purple-500" />
                Latest Insight
            </h3>
            
            {latestInsight ? (
                <div className="space-y-3">
                <p className="text-gray-600 italic">"{latestInsight.analysis}"</p>
                
                <div className="pt-2">
                    <p className="text-xs font-bold text-gray-400 uppercase mb-2">Suggested Action</p>
                    <div className="flex items-center gap-2 text-sm text-gray-800 bg-purple-50 p-2 rounded">
                    <div className="w-2 h-2 bg-purple-500 rounded-full" />
                    {latestInsight.actionableSteps?.[0] || "Keep coming back!"}
                    </div>
                </div>
                </div>
            ) : (
                <div className="text-center py-8 text-gray-400 text-sm">
                Use the "Sparkle Button" in your Journal to generate your first AI Insight.
                </div>
            )}
          </div>
          
          <div className="text-right mt-4 pt-4 border-t border-gray-50">
             <Link to="/journal" className="text-sm text-blue-600 hover:underline">View all insights &rarr;</Link>
          </div>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Journal.tsx
================================================================================
import { useState } from 'react';
import JournalTabs from '../components/journal/JournalTabs';
import JournalEditor, { type JournalEntry } from '../components/journal/JournalEditor';
import JournalHistory from '../components/journal/JournalHistory';
import JournalInsights from '../components/journal/JournalInsights'; // NEW Import

export default function Journal() {
  const [activeTab, setActiveTab] = useState<'write' | 'history' | 'insights'>('write');
  const [editingEntry, setEditingEntry] = useState<JournalEntry | null>(null);

  // Called when user clicks "Edit" in History tab
  const handleEditRequest = (entry: JournalEntry) => {
    setEditingEntry(entry);
    setActiveTab('write');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // Called when Editor successfully saves
  const handleSaveComplete = () => {
    setEditingEntry(null);
    setActiveTab('history'); // Auto-switch to history to see the result
  };

  return (
    <div className="max-w-5xl mx-auto">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Recovery Journal</h1>
        <p className="text-gray-500">Track your journey, moods, and daily reflections.</p>
      </div>

      <JournalTabs activeTab={activeTab} onChange={setActiveTab} />

      <div className="transition-opacity duration-200">
        {activeTab === 'write' ? (
          <JournalEditor 
            initialEntry={editingEntry} 
            onSaveComplete={handleSaveComplete} 
          />
        ) : activeTab === 'history' ? (
          <JournalHistory 
            onEdit={handleEditRequest} 
          />
        ) : (
          <JournalInsights />
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Login.tsx
================================================================================
import { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { ShieldCheckIcon, EnvelopeIcon, LockClosedIcon } from '@heroicons/react/24/outline';

export default function Login() {
  const { loginWithGoogle, loginWithEmail, signupWithEmail } = useAuth();
  const navigate = useNavigate();
  
  const [isLogin, setIsLogin] = useState(true); // Toggle state
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPass, setConfirmPass] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // Handle Google Login
  const handleGoogleLogin = async () => {
    try {
      setError('');
      setLoading(true);
      await loginWithGoogle();
      navigate('/dashboard');
    } catch (error) {
      console.error(error);
      setError('Failed to sign in with Google.');
    } finally {
      setLoading(false);
    }
  };

  // Handle Email Submit
  const handleEmailSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    // Basic Validation
    if (!email || !password) {
        setError("Please fill in all fields.");
        setLoading(false);
        return;
    }
    
    if (!isLogin && password !== confirmPass) {
        setError("Passwords do not match.");
        setLoading(false);
        return;
    }

    if (password.length < 6) {
        setError("Password should be at least 6 characters.");
        setLoading(false);
        return;
    }

    try {
      if (isLogin) {
        await loginWithEmail(email, password);
      } else {
        await signupWithEmail(email, password);
      }
      navigate('/dashboard');
    } catch (err: any) {
      console.error(err);
      // Firebase error mapping
      if (err.code === 'auth/email-already-in-use') {
        setError('That email is already in use.');
      } else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
        setError('Invalid email or password.');
      } else {
        setError('Failed to authenticate. Please try again.');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
        
        {/* Header */}
        <div className="text-center">
          <div className="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
             <ShieldCheckIcon className="h-10 w-10 text-blue-600" />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">
            My Recovery Toolkit
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            {isLogin ? 'Sign in to your account' : 'Create a new account'}
          </p>
        </div>

        {/* Error Message */}
        {error && (
            <div className="bg-red-50 text-red-600 p-3 rounded-md text-sm text-center">
                {error}
            </div>
        )}

        {/* Email Form */}
        <form className="mt-8 space-y-4" onSubmit={handleEmailSubmit}>
            <div className="space-y-4">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <EnvelopeIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="email"
                        required
                        placeholder="Email address"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <LockClosedIcon className="h-5 w-5 text-gray-400" />
                    </div>
                    <input
                        type="password"
                        required
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                    />
                </div>

                {!isLogin && (
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <LockClosedIcon className="h-5 w-5 text-gray-400" />
                        </div>
                        <input
                            type="password"
                            required
                            placeholder="Confirm Password"
                            value={confirmPass}
                            onChange={(e) => setConfirmPass(e.target.value)}
                            className="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                        />
                    </div>
                )}
            </div>

            <button
                type="submit"
                disabled={loading}
                className="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
            >
                {loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Sign Up')}
            </button>
        </form>

        <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
            </div>
            <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
        </div>

        {/* Google Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading}
          className="w-full flex items-center justify-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
        >
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" className="h-5 w-5 mr-2" />
          Sign in with Google
        </button>

        {/* Toggle Mode */}
        <div className="text-center mt-4">
            <p className="text-sm text-gray-600">
                {isLogin ? "Don't have an account? " : "Already have an account? "}
                <button 
                    onClick={() => {
                        setIsLogin(!isLogin);
                        setError('');
                        setEmail('');
                        setPassword('');
                        setConfirmPass('');
                    }}
                    className="font-medium text-blue-600 hover:text-blue-500"
                >
                    {isLogin ? 'Sign up' : 'Sign in'}
                </button>
            </p>
        </div>

      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Profile.tsx
================================================================================
import { useState, useRef, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
// REMOVED 'type UserProfile' from the import below
import { getProfile, updateProfileData } from '../lib/db';
import { importLegacyJournals } from '../lib/importer';
import { 
  UserCircleIcon, 
  ArrowLeftOnRectangleIcon, 
  ArrowUpTrayIcon, 
  CheckCircleIcon,
  ExclamationCircleIcon 
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function Profile() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  
  const [displayName, setDisplayName] = useState('');
  const [sobrietyDate, setSobrietyDate] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

  // Import State
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [importing, setImporting] = useState(false);
  const [importStatus, setImportStatus] = useState<string | null>(null);

  useEffect(() => {
    async function loadProfile() {
      if (user) {
        const data = await getProfile(user.uid);
        if (data) {
          setDisplayName(data.displayName || user.displayName || '');
          // Format date for input field (YYYY-MM-DD)
          if (data.sobrietyDate) {
            setSobrietyDate(data.sobrietyDate.toDate().toISOString().split('T')[0]);
          }
        }
        setLoading(false);
      }
    }
    loadProfile();
  }, [user]);

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      console.error('Failed to log out', error);
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    setSaving(true);
    setMessage(null);

    try {
      // Create date object correctly
      let dateObj: Date | null = null;
      if (sobrietyDate) {
         const [y, m, d] = sobrietyDate.split('-').map(Number);
         dateObj = new Date(y, m - 1, d);
      }
      
      // Update in Firestore
      await updateProfileData(user.uid, {
        displayName,
        sobrietyDate: dateObj
      });

      setMessage({ type: 'success', text: 'Profile updated successfully' });
    } catch (error) {
      console.error(error);
      setMessage({ type: 'error', text: 'Failed to update profile' });
    } finally {
      setSaving(false);
    }
  };

  // --- IMPORT HANDLER ---
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;

    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
      setImportStatus('Error: Please select a valid JSON file.');
      return;
    }

    setImporting(true);
    setImportStatus('Reading file and mapping data...');

    try {
      const result = await importLegacyJournals(user.uid, file);
      setImportStatus(`Success! Imported ${result.success} entries. (${result.errors} skipped)`);
      // Clear input
      if (fileInputRef.current) fileInputRef.current.value = '';
    } catch (error) {
      console.error("Import failed", error);
      setImportStatus('Error: Import failed. Check console for details.');
    } finally {
      setImporting(false);
    }
  };

  if (loading) return <div>Loading profile...</div>;

  return (
    <div className="max-w-2xl mx-auto space-y-8">
      <div className="flex items-center gap-4 border-b border-gray-200 pb-6">
        <div className="h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
           {user?.photoURL ? (
             <img src={user.photoURL} alt="Profile" className="h-16 w-16 rounded-full" />
           ) : (
             <UserCircleIcon className="h-10 w-10" />
           )}
        </div>
        <div>
          <h1 className="text-2xl font-bold text-gray-900">{user?.displayName || 'User Profile'}</h1>
          <p className="text-gray-500">{user?.email}</p>
        </div>
      </div>

      <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
        <div>
          <label className="block text-sm font-medium text-gray-700">Display Name</label>
          <input
            type="text"
            value={displayName}
            onChange={(e) => setDisplayName(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700">Sobriety Date</label>
          <input
            type="date"
            value={sobrietyDate}
            onChange={(e) => setSobrietyDate(e.target.value)}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
          />
          <p className="mt-1 text-xs text-gray-500">Used to calculate your recovery stats.</p>
        </div>

        {message && (
          <div className={`p-4 rounded-md ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
            {message.text}
          </div>
        )}

        <div className="flex justify-end gap-3">
           <button
             type="submit"
             disabled={saving}
             className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
           >
             {saving ? 'Saving...' : 'Save Changes'}
           </button>
        </div>
      </form>

      {/* --- IMPORT SECTION --- */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <ArrowUpTrayIcon className="h-5 w-5 text-gray-500" />
            Import Legacy Data
        </h3>
        <p className="text-sm text-gray-600 mb-4">
            If you have a JSON backup of your journals from the old app, you can import them here. 
            This will add them to your history.
        </p>

        <div className="flex flex-col gap-4">
            <input 
                type="file" 
                accept=".json"
                ref={fileInputRef}
                onChange={handleFileChange}
                className="hidden"
            />
            
            <button 
                type="button"
                onClick={() => fileInputRef.current?.click()}
                disabled={importing}
                className="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-gray-500 hover:border-blue-500 hover:text-blue-500 transition-colors flex flex-col items-center justify-center gap-2"
            >
                {importing ? (
                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                ) : (
                    <ArrowUpTrayIcon className="h-8 w-8" />
                )}
                <span className="font-medium">{importing ? 'Importing...' : 'Click to Select JSON File'}</span>
            </button>

            {importStatus && (
                <div className={`flex items-start gap-2 text-sm p-3 rounded-md ${importStatus.includes('Success') ? 'bg-green-50 text-green-800' : 'bg-yellow-50 text-yellow-800'}`}>
                    {importStatus.includes('Success') ? (
                        <CheckCircleIcon className="h-5 w-5 flex-shrink-0" />
                    ) : (
                        <ExclamationCircleIcon className="h-5 w-5 flex-shrink-0" />
                    )}
                    {importStatus}
                </div>
            )}
        </div>
      </div>

      <div className="border-t border-gray-200 pt-6">
        <button
          onClick={handleLogout}
          className="w-full flex justify-center items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-lg font-semibold hover:bg-red-100 transition-colors"
        >
          <ArrowLeftOnRectangleIcon className="h-5 w-5" />
          Log Out
        </button>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Tasks.tsx
================================================================================
import { useEffect, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTasks, 
  addTask, 
  toggleTask, 
  deleteTask, 
  type Task, 
  type Frequency 
} from '../lib/tasks';
import { 
  CheckCircleIcon, 
  PlusIcon, 
  FireIcon, 
  NoSymbolIcon, 
  TrashIcon,
  CalendarDaysIcon,
  ClockIcon
} from '@heroicons/react/24/outline';
import { isSameDay, startOfDay } from 'date-fns';

export default function Tasks() {
  const { user } = useAuth();
  
  // State
  const [tasks, setTasks] = useState<Task[]>([]);
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [newFrequency, setNewFrequency] = useState<Frequency>('once');
  const [loading, setLoading] = useState(true);

  // Load Data
  useEffect(() => {
    async function loadTasks() {
      if (!user) return;
      try {
        const fetchedTasks = await getUserTasks(user.uid);
        setTasks(fetchedTasks);
      } catch (error) {
        console.error("Error loading tasks:", error);
      } finally {
        setLoading(false);
      }
    }
    loadTasks();
  }, [user]);

  // Handlers
  const handleCreateTask = async (e: React.FormEvent) => {
    e.preventDefault(); 
    if (!user || !newTaskTitle.trim()) return;
    
    try {
        await addTask(user.uid, newTaskTitle, newFrequency);
        setNewTaskTitle('');
        setNewFrequency('once');
        const updated = await getUserTasks(user.uid);
        setTasks(updated);
    } catch (err) {
        console.error("Failed to create task", err);
    }
  };

  const handleToggleTask = async (task: Task) => {
    if (!user) return;

    const today = startOfDay(new Date());
    const isCompletedToday = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);
    const newState = !isCompletedToday;

    // Optimistic UI Update
    const updatedTasks = tasks.map(t => {
        if (t.id === task.id) {
            return { 
                ...t, 
                lastCompletedAt: newState ? new Date() : null 
            }; 
        }
        return t;
    });
    setTasks(updatedTasks);

    await toggleTask(task, newState);
    const confirmedTasks = await getUserTasks(user.uid);
    setTasks(confirmedTasks);
  };

  const handleDeleteTask = async (id: string) => {
    if(!window.confirm("Delete this task?")) return;
    await deleteTask(id);
    setTasks(tasks.filter(t => t.id !== id));
  };

  if (loading) return <div className="p-8 text-center text-gray-500">Loading Tasks...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
       <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 border-b border-gray-200 pb-4">
        <div>
           <h1 className="text-2xl font-bold text-gray-900">Task Workspace</h1>
           <p className="text-gray-500">Manage your daily habits and to-do lists.</p>
        </div>
      </div>

      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            {/* Input Form */}
            <form onSubmit={handleCreateTask} className="flex flex-col sm:flex-row gap-2 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <input 
                    type="text" 
                    placeholder="Add a new habit or task..." 
                    className="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                    value={newTaskTitle}
                    onChange={(e) => setNewTaskTitle(e.target.value)}
                />
                
                <div className="flex gap-2">
                    <select
                        value={newFrequency}
                        onChange={(e) => setNewFrequency(e.target.value as Frequency)}
                        className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white text-sm p-2 border"
                    >
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>

                    <button 
                        type="submit"
                        disabled={!newTaskTitle.trim()}
                        className="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center w-10 sm:w-auto"
                    >
                        <PlusIcon className="h-5 w-5" />
                    </button>
                </div>
            </form>

            {/* Full List */}
            <div className="space-y-3">
                {tasks.length === 0 && (
                    <p className="text-center text-gray-400 text-sm py-8">No tasks found. Start by adding one above!</p>
                )}
                
                {tasks.map(task => {
                    const today = startOfDay(new Date());
                    const isCompleted = task.lastCompletedAt && isSameDay(task.lastCompletedAt, today);

                    return (
                        <div key={task.id} className="flex items-center justify-between group p-3 hover:bg-gray-50 rounded-lg transition-colors border border-transparent hover:border-gray-100">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => handleToggleTask(task)}
                                    className={`h-6 w-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                        isCompleted 
                                            ? 'bg-green-500 border-green-500 text-white' 
                                            : 'border-gray-300 hover:border-blue-500'
                                    }`}
                                >
                                    {isCompleted && <CheckCircleIcon className="h-4 w-4" />}
                                </button>
                                
                                <div>
                                    <span className={`block font-medium ${isCompleted ? 'text-gray-400 line-through' : 'text-gray-900'}`}>
                                        {task.title}
                                    </span>
                                    {task.isRecurring && (
                                        <span className="text-xs text-gray-400 flex items-center gap-1">
                                            {task.frequency === 'daily' && <ClockIcon className="h-3 w-3" />}
                                            {task.frequency === 'weekly' && <CalendarDaysIcon className="h-3 w-3" />}
                                            {task.frequency === 'monthly' && <CalendarDaysIcon className="h-3 w-3" />}
                                            <span className="capitalize">{task.frequency}</span>
                                        </span>
                                    )}
                                </div>
                            </div>

                            <div className="flex items-center gap-4">
                                {/* Streak Badge */}
                                {task.isRecurring && (
                                    <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold ${
                                        task.currentStreak > 0 ? 'bg-orange-100 text-orange-700' : 
                                        task.currentStreak < 0 ? 'bg-gray-100 text-gray-500' : 'bg-gray-100 text-gray-400'
                                    }`}>
                                        {task.currentStreak > 0 ? (
                                            <FireIcon className="h-3 w-3" />
                                        ) : (
                                            <NoSymbolIcon className="h-3 w-3" />
                                        )}
                                        {Math.abs(task.currentStreak)} Streak
                                    </div>
                                )}

                                <button 
                                    onClick={() => handleDeleteTask(task.id!)}
                                    className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <TrashIcon className="h-5 w-5" />
                                </button>
                            </div>
                        </div>
                    );
                })}
            </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/TemplateEditor.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { 
  getUserTemplates,
  saveUserTemplate, 
  deleteUserTemplate, 
  type JournalTemplate 
} from '../lib/db';
import { 
  PlusIcon, 
  TrashIcon, 
  PencilSquareIcon,
  XMarkIcon,
  ArrowLeftIcon
} from '@heroicons/react/24/outline';
import { useNavigate } from 'react-router-dom';

export default function TemplateEditor() {
  const { user } = useAuth();
  const navigate = useNavigate();
  
  const [templates, setTemplates] = useState<JournalTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Editor State
  const [isEditing, setIsEditing] = useState(false);
  const [currentId, setCurrentId] = useState('');
  const [name, setName] = useState('');
  const [prompts, setPrompts] = useState<string[]>(['']);
  const [tags, setTags] = useState(''); // Comma separated string for input

  useEffect(() => {
    loadTemplates();
  }, [user]);

  async function loadTemplates() {
    if (!user) return;
    const data = await getUserTemplates(user.uid);
    setTemplates(data);
    setLoading(false);
  }

  const handleEdit = (t: JournalTemplate) => {
    setCurrentId(t.id);
    setName(t.name);
    setPrompts(t.prompts.length > 0 ? t.prompts : ['']);
    setTags(t.defaultTags.join(', '));
    setIsEditing(true);
  };

  const handleCreate = () => {
    setCurrentId('');
    setName('');
    setPrompts(['']);
    setTags('');
    setIsEditing(true);
  };

  const handleDelete = async (id: string) => {
    if (!user || !window.confirm("Are you sure you want to delete this template?")) return;
    await deleteUserTemplate(user.uid, id);
    await loadTemplates();
  };

  const handlePromptChange = (idx: number, val: string) => {
    const newPrompts = [...prompts];
    newPrompts[idx] = val;
    setPrompts(newPrompts);
  };

  const addPromptLine = () => {
    setPrompts([...prompts, '']);
  };

  const removePromptLine = (idx: number) => {
    const newPrompts = prompts.filter((_, i) => i !== idx);
    setPrompts(newPrompts);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user) return;

    // Clean data
    const cleanPrompts = prompts.filter(p => p.trim() !== '');
    const cleanTags = tags.split(',').map(t => t.trim()).filter(t => t !== '').map(t => t.startsWith('#') ? t : `#${t}`);

    if (!name || cleanPrompts.length === 0) {
        alert("Please provide a name and at least one prompt.");
        return;
    }

    const templateData: JournalTemplate = {
        id: currentId, // empty string means new doc
        name,
        prompts: cleanPrompts,
        defaultTags: cleanTags
    };

    await saveUserTemplate(user.uid, templateData);
    setIsEditing(false);
    await loadTemplates();
  };

  if (loading) return <div className="p-8">Loading templates...</div>;

  // --- EDITOR VIEW ---
  if (isEditing) {
    return (
        <div className="max-w-2xl mx-auto space-y-6">
            <div className="flex items-center gap-4">
                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-900">
                    <ArrowLeftIcon className="h-5 w-5" />
                </button>
                <h1 className="text-2xl font-bold text-gray-900">{currentId ? 'Edit Template' : 'New Template'}</h1>
            </div>

            <form onSubmit={handleSave} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Template Name</label>
                    <input 
                        type="text" 
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Step 10 Inventory"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Prompts (Questions)</label>
                    <div className="space-y-3">
                        {prompts.map((p, idx) => (
                            <div key={idx} className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={p}
                                    onChange={(e) => handlePromptChange(idx, e.target.value)}
                                    className="flex-1 p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder={`Question ${idx + 1}`}
                                />
                                <button 
                                    type="button" 
                                    onClick={() => removePromptLine(idx)}
                                    className="text-red-400 hover:text-red-600 p-2"
                                    title="Remove prompt"
                                >
                                    <XMarkIcon className="h-5 w-5" />
                                </button>
                            </div>
                        ))}
                    </div>
                    <button 
                        type="button"
                        onClick={addPromptLine}
                        className="mt-3 text-sm text-blue-600 font-medium hover:text-blue-700 flex items-center gap-1"
                    >
                        <PlusIcon className="h-4 w-4" />
                        Add Question
                    </button>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Default Tags</label>
                    <input 
                        type="text" 
                        value={tags}
                        onChange={(e) => setTags(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="#step10, #inventory (comma separated)"
                    />
                </div>

                <div className="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button 
                        type="button" 
                        onClick={() => setIsEditing(false)}
                        className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                        Save Template
                    </button>
                </div>
            </form>
        </div>
    );
  }

  // --- LIST VIEW ---
  return (
    <div className="max-w-3xl mx-auto space-y-6">
       <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={() => navigate('/journal')} className="text-gray-500 hover:text-gray-900 lg:hidden">
               <ArrowLeftIcon className="h-5 w-5" />
            </button>
            <h1 className="text-2xl font-bold text-gray-900">Manage Templates</h1>
          </div>
          <button 
             onClick={handleCreate}
             className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
          >
             <PlusIcon className="h-5 w-5" />
             Create New
          </button>
       </div>

       <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
          {templates.length === 0 ? (
             <div className="p-8 text-center text-gray-500">
                You haven't created any custom templates yet.
             </div>
          ) : (
             <ul className="divide-y divide-gray-100">
                {templates.map((t) => (
                   <li key={t.id} className="p-4 sm:p-6 flex items-center justify-between hover:bg-gray-50 transition">
                      <div>
                         <h3 className="font-semibold text-gray-900">{t.name}</h3>
                         <p className="text-sm text-gray-500 mt-1">{t.prompts.length} questions ‚Ä¢ {t.defaultTags.join(', ')}</p>
                      </div>
                      <div className="flex items-center gap-2">
                         <button 
                            onClick={() => handleEdit(t)}
                            className="p-2 text-gray-400 hover:text-blue-600 rounded-full hover:bg-blue-50 transition"
                            title="Edit"
                         >
                            <PencilSquareIcon className="h-5 w-5" />
                         </button>
                         <button 
                            onClick={() => handleDelete(t.id)}
                            className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-50 transition"
                            title="Delete"
                         >
                            <TrashIcon className="h-5 w-5" />
                         </button>
                      </div>
                   </li>
                ))}
             </ul>
          )}
       </div>
    </div>
  );
}

================================================================================
FILE: src/pages/WorkbookDetail.tsx
================================================================================
import { useEffect, useState, Fragment } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { getWorkbook } from '../data/workbooks';
import { getSectionCompletion, getAllWorkbookAnswers } from '../lib/workbooks'; // Updated Import
import { analyzeFullWorkbook, type WorkbookInsight } from '../lib/gemini'; // Updated Import
import { useAuth } from '../contexts/AuthContext';
import { Dialog, Transition } from '@headlessui/react';
import { 
  ChevronRightIcon, 
  CheckCircleIcon, 
  ArrowLeftIcon,
  SparklesIcon
} from '@heroicons/react/24/outline';

export default function WorkbookDetail() {
  const { workbookId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const workbook = getWorkbook(workbookId || '');
  
  const [progressMap, setProgressMap] = useState<{[sectionId: string]: number}>({});
  
  // AI State
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [aiResult, setAiResult] = useState<WorkbookInsight | null>(null);
  const [showAiModal, setShowAiModal] = useState(false);

  useEffect(() => {
    async function loadProgress() {
      if (!user || !workbook) return;
      
      const newMap: {[key: string]: number} = {};
      
      for (const section of workbook.sections) {
        const pct = await getSectionCompletion(user.uid, workbook.id, section.id, section.questions.length);
        newMap[section.id] = pct;
      }
      
      setProgressMap(newMap);
    }

    loadProgress();
  }, [user, workbook]);

  // --- HANDLER: Holistic Analysis ---
  const handleAiAnalysis = async () => {
    if (!user || !workbook) return;

    setIsAnalyzing(true);
    setShowAiModal(true);
    setAiResult(null); // Reset previous result

    try {
      // 1. Fetch ALL answers from ALL sections
      const fullContent = await getAllWorkbookAnswers(
        user.uid, 
        workbook.id, 
        workbook.sections.map(s => ({ id: s.id, title: s.title }))
      );

      if (!fullContent) {
        setAiResult({
          feedback: "It looks like you haven't started this workbook yet. Complete a few questions first!",
          encouragement: "Every journey begins with a single step."
        });
        setIsAnalyzing(false);
        return;
      }

      // 2. Send to Gemini
      const result = await analyzeFullWorkbook(workbook.title, fullContent);
      setAiResult(result);
      
    } catch (error) {
      console.error("Analysis failed", error);
      setAiResult({
        feedback: "We couldn't generate an analysis at this moment. Please check your connection and try again.",
        encouragement: "Keep going."
      });
    } finally {
      setIsAnalyzing(false);
    }
  };

  if (!workbook) return <div>Workbook not found</div>;

  return (
    <div className="max-w-3xl mx-auto space-y-6">
      
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={() => navigate('/workbooks')} className="text-gray-500 hover:text-gray-900">
             <ArrowLeftIcon className="h-5 w-5" />
          </button>
          <h1 className="text-2xl font-bold text-gray-900">{workbook.title}</h1>
        </div>
        
        {/* SPARKLE BUTTON (Moved Here) */}
        <button 
          onClick={handleAiAnalysis}
          className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all active:scale-95"
        >
          <SparklesIcon className="h-5 w-5" />
          <span>Analyze Progress</span>
        </button>
      </div>

      <div className="bg-white shadow-sm border border-gray-200 rounded-xl overflow-hidden">
        <ul className="divide-y divide-gray-100">
          {workbook.sections.map((section) => {
            const progress = progressMap[section.id] || 0;
            const isComplete = progress === 100;

            return (
              <li key={section.id}>
                <Link 
                  to={`/workbooks/${workbook.id}/session/${section.id}`}
                  className="block hover:bg-gray-50 transition p-4 sm:p-6"
                >
                  <div className="flex items-center justify-between">
                    <div className="flex-1 pr-4">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="font-semibold text-gray-900">{section.title}</h3>
                        {isComplete && <CheckCircleIcon className="h-5 w-5 text-green-500" />}
                      </div>
                      <p className="text-sm text-gray-500">{section.description}</p>
                      
                      {/* Progress Bar */}
                      <div className="mt-2 w-full max-w-[200px] bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div 
                          className={`h-full ${isComplete ? 'bg-green-500' : 'bg-blue-500'}`} 
                          style={{ width: `${progress}%` }} 
                        />
                      </div>
                      <span className="text-xs text-gray-400 mt-1 block">{progress}% Complete</span>
                    </div>
                    
                    <ChevronRightIcon className="h-5 w-5 text-gray-400" />
                  </div>
                </Link>
              </li>
            );
          })}
        </ul>
      </div>

      {/* --- AI INSIGHT MODAL --- */}
      <Transition appear show={showAiModal} as={Fragment}>
        <Dialog as="div" className="relative z-50" onClose={() => setShowAiModal(false)}>
          <Transition.Child
            as={Fragment}
            enter="ease-out duration-300"
            enterFrom="opacity-0"
            enterTo="opacity-100"
            leave="ease-in duration-200"
            leaveFrom="opacity-100"
            leaveTo="opacity-0"
          >
            <div className="fixed inset-0 bg-black/30 backdrop-blur-sm" />
          </Transition.Child>

          <div className="fixed inset-0 overflow-y-auto">
            <div className="flex min-h-full items-center justify-center p-4 text-center">
              <Transition.Child
                as={Fragment}
                enter="ease-out duration-300"
                enterFrom="opacity-0 scale-95"
                enterTo="opacity-100 scale-100"
                leave="ease-in duration-200"
                leaveFrom="opacity-100 scale-100"
                leaveTo="opacity-0 scale-95"
              >
                <Dialog.Panel className="w-full max-w-lg transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all">
                  
                  <div className="flex items-center gap-2 mb-4">
                    <SparklesIcon className="h-6 w-6 text-purple-500" />
                    <Dialog.Title as="h3" className="text-xl font-bold leading-6 text-gray-900">
                      Holistic Workbook Analysis
                    </Dialog.Title>
                  </div>

                  {isAnalyzing ? (
                    <div className="py-12 text-center">
                        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-500 mx-auto mb-4"></div>
                        <p className="text-gray-500 font-medium">Reviewing your entire journey...</p>
                        <p className="text-xs text-gray-400 mt-2">Connecting dots between sections</p>
                    </div>
                  ) : (
                    aiResult && (
                        <div className="space-y-6">
                            <div className="bg-purple-50 p-5 rounded-xl text-gray-800 leading-relaxed border border-purple-100 text-base">
                                {aiResult.feedback}
                            </div>
                            
                            <div className="text-center">
                                <span className="block text-xs uppercase tracking-widest text-gray-400 mb-1">Encouragement</span>
                                <span className="font-bold text-purple-700 text-lg">"{aiResult.encouragement}"</span>
                            </div>
                        </div>
                    )
                  )}

                  <div className="mt-8">
                    <button
                      type="button"
                      className="inline-flex justify-center rounded-lg border border-transparent bg-purple-100 px-4 py-3 text-sm font-semibold text-purple-900 hover:bg-purple-200 focus:outline-none w-full transition-colors"
                      onClick={() => setShowAiModal(false)}
                    >
                      Close Analysis
                    </button>
                  </div>
                </Dialog.Panel>
              </Transition.Child>
            </div>
          </div>
        </Dialog>
      </Transition>

    </div>
  );
}

================================================================================
FILE: src/pages/WorkbookSession.tsx
================================================================================
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { getWorkbook } from '../data/workbooks';
import { getSectionAnswers, saveAnswer, type WorkbookProgress } from '../lib/workbooks';
import { useAuth } from '../contexts/AuthContext';
import { 
  ArrowLeftIcon, 
  ArrowRightIcon, 
  DocumentArrowDownIcon,
  InformationCircleIcon,
  XMarkIcon
} from '@heroicons/react/24/outline';

export default function WorkbookSession() {
  const { workbookId, sectionId } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  
  const workbook = getWorkbook(workbookId || '');
  const section = workbook?.sections.find(s => s.id === sectionId);
  
  // State
  const [answers, setAnswers] = useState<WorkbookProgress>({});
  const [currentIndex, setCurrentIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // Print Mode State
  const [isPrintMode, setIsPrintMode] = useState(false);

  useEffect(() => {
    async function init() {
      if (!user || !workbook || !section) return;
      
      const saved = await getSectionAnswers(user.uid, workbook.id, section.id);
      setAnswers(saved);
      
      // Find first unanswered question to jump to
      const firstEmptyIndex = section.questions.findIndex(q => !saved[q.id]);
      if (firstEmptyIndex !== -1) setCurrentIndex(firstEmptyIndex);
      
      setLoading(false);
    }
    init();
  }, [user, workbook, section]);

  // Handlers
  const currentQuestion = section?.questions[currentIndex];
  const currentAnswer = currentQuestion ? (answers[currentQuestion.id] || '') : '';

  const handleTextChange = (val: string) => {
    if (!currentQuestion) return;
    setAnswers(prev => ({ ...prev, [currentQuestion.id]: val }));
  };

  const saveCurrent = async () => {
    if (!user || !workbook || !section || !currentQuestion) return;
    setSaving(true);
    await saveAnswer(user.uid, workbook.id, section.id, currentQuestion.id, currentAnswer);
    setSaving(false);
  };

  const handleNext = async () => {
    await saveCurrent();
    if (section && currentIndex < section.questions.length - 1) {
      setCurrentIndex(prev => prev + 1);
    } else {
      // Finished section
      navigate(`/workbooks/${workbookId}`);
    }
  };

  const handlePrev = async () => {
    await saveCurrent();
    if (currentIndex > 0) {
      setCurrentIndex(prev => prev - 1);
    }
  };

  const handlePrint = () => {
    setIsPrintMode(true);
    setTimeout(() => {
      window.print();
    }, 500);
  };

  if (!workbook || !section || loading) return <div className="p-8">Loading session...</div>;

  // --- PRINT MODE VIEW ---
  if (isPrintMode) {
    return (
      <div className="bg-white min-h-screen text-black p-8 max-w-4xl mx-auto print:p-0">
        <div className="flex justify-between items-center mb-8 print:hidden">
          <h2 className="text-xl font-bold text-gray-500">Preview Mode</h2>
          <div className="flex gap-2">
            <button 
                onClick={() => window.print()} 
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
                Print PDF
            </button>
            <button 
                onClick={() => setIsPrintMode(false)} 
                className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
            >
                Close
            </button>
          </div>
        </div>

        <div className="print:block">
            <h1 className="text-3xl font-bold mb-2">{workbook.title}</h1>
            <h2 className="text-xl text-gray-600 mb-8 border-b pb-4">{section.title}: {section.description}</h2>

            <div className="space-y-8">
                {section.questions.map((q, idx) => (
                    <div key={q.id} className="break-inside-avoid">
                        <p className="font-bold text-lg mb-2">
                            {idx + 1}. {q.text}
                        </p>
                        <div className="bg-gray-50 p-4 rounded border border-gray-100 text-gray-800 whitespace-pre-wrap">
                            {answers[q.id] || "No answer provided."}
                        </div>
                    </div>
                ))}
            </div>
            
            <div className="mt-12 pt-4 border-t text-sm text-gray-400 text-center">
                Generated by My Recovery Toolkit ‚Ä¢ {new Date().toLocaleDateString()}
            </div>
        </div>
      </div>
    );
  }

  // --- WIZARD MODE VIEW ---
  if (!currentQuestion) return <div>Error</div>;

  return (
    <div className="max-w-2xl mx-auto h-[calc(100vh-80px)] flex flex-col relative">
      
      {/* 1. Top Bar */}
      <div className="flex items-center justify-between mb-4">
         <div className="flex items-center gap-2">
            <button onClick={() => navigate(`/workbooks/${workbookId}`)} className="text-gray-400 hover:text-gray-900">
                <XMarkIcon className="h-6 w-6" />
            </button>
            <div className="text-xs font-bold uppercase tracking-widest text-gray-400">
                Question {currentIndex + 1} of {section.questions.length}
            </div>
         </div>
         
         <div className="flex items-center gap-3">
            {/* Export Only - Sparkle Button Removed */}
            <button onClick={handlePrint} className="text-blue-600 hover:text-blue-700 flex items-center gap-1 text-sm font-medium">
                <DocumentArrowDownIcon className="h-4 w-4" />
                <span className="hidden sm:inline">Export</span>
            </button>
         </div>
      </div>

      {/* 2. Progress Line */}
      <div className="w-full bg-gray-100 h-1 rounded-full mb-8">
        <div 
            className="bg-blue-600 h-1 rounded-full transition-all duration-300"
            style={{ width: `${((currentIndex + 1) / section.questions.length) * 100}%` }}
        />
      </div>

      {/* 3. The Question Area */}
      <div className="flex-1 overflow-y-auto pb-20">
         <div className="prose prose-lg max-w-none mb-6">
            <h2 className="text-2xl font-bold text-gray-900 leading-tight">
                {currentQuestion.text}
            </h2>
            {currentQuestion.context && (
                <div className="flex gap-3 bg-blue-50 p-4 rounded-lg mt-4 text-blue-800 text-sm">
                    <InformationCircleIcon className="h-5 w-5 flex-shrink-0" />
                    <p className="italic">"{currentQuestion.context}"</p>
                </div>
            )}
         </div>

         <textarea
            className="w-full min-h-[300px] p-4 text-lg border-0 bg-transparent focus:ring-0 placeholder-gray-300 resize-none"
            placeholder="Type your answer here..."
            value={currentAnswer}
            onChange={(e) => handleTextChange(e.target.value)}
            autoFocus
         />
      </div>

      {/* 4. Bottom Navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 lg:static lg:bg-transparent lg:border-0">
          <div className="max-w-2xl mx-auto flex items-center justify-between gap-4">
             <button 
                onClick={handlePrev}
                disabled={currentIndex === 0}
                className={`flex items-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors ${
                    currentIndex === 0 
                    ? 'text-gray-300 cursor-not-allowed' 
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
             >
                <ArrowLeftIcon className="h-5 w-5" />
                Prev
             </button>

             <div className="text-xs text-gray-400 italic">
                {saving ? 'Saving...' : 'Auto-saved'}
             </div>

             <button 
                onClick={handleNext}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-transform active:scale-95 flex items-center gap-2"
             >
                {currentIndex === section.questions.length - 1 ? 'Finish' : 'Next'}
                <ArrowRightIcon className="h-5 w-5" />
             </button>
          </div>
      </div>
    </div>
  );
}

================================================================================
FILE: src/pages/Workbooks.tsx
================================================================================
    import { Link } from 'react-router-dom';
import { WORKBOOKS } from '../data/workbooks';
import { BookOpenIcon, StarIcon, HeartIcon } from '@heroicons/react/24/outline';

export default function Workbooks() {
  
  const getIcon = (type: string) => {
    switch (type) {
      case 'general': return <StarIcon className="h-6 w-6 text-yellow-500" />;
      case 'steps': return <BookOpenIcon className="h-6 w-6 text-blue-500" />;
      default: return <HeartIcon className="h-6 w-6 text-purple-500" />;
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="border-b border-gray-200 pb-5">
        <h3 className="text-2xl font-bold leading-6 text-gray-900">Recovery Workbooks</h3>
        <p className="mt-2 max-w-4xl text-sm text-gray-500">
          Structured guides to help you process your journey. Select a workbook to begin.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {WORKBOOKS.map((workbook) => (
          <div key={workbook.id} className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col hover:shadow-md transition-shadow">
            <div className="flex items-center gap-4 mb-4">
              <div className="p-3 bg-gray-50 rounded-lg">
                {getIcon(workbook.type)}
              </div>
              <div>
                <h4 className="text-lg font-bold text-gray-900">{workbook.title}</h4>
                <span className="text-xs font-medium bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                  {workbook.sections.length} Sections
                </span>
              </div>
            </div>
            
            <p className="text-gray-600 text-sm flex-grow mb-6">
              {workbook.description}
            </p>

            <Link 
              to={`/workbooks/${workbook.id}`}
              className="w-full bg-blue-600 text-white text-center py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
            >
              Start Workbook
            </Link>
          </div>
        ))}
      </div>
    </div>
  );
}

================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        // Unified Blue Theme (from Master Tech Doc)
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8', // Primary Brand Color
          800: '#1e40af',
          900: '#1e3a8a',
        }
      }
    },
  },
  plugins: [],
}

================================================================================
FILE: tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}


================================================================================
FILE: tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}


================================================================================
FILE: tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

